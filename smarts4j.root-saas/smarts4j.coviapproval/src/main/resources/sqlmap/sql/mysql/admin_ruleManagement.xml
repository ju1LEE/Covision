<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="admin.ruleManagement">
    <select id="selectMasterManagementList" parameterType="cmap" resultType="cmap">
        SELECT A.RuleID, A.EntCode, D.MultiDisplayName AS EntName, RuleName, RuleType,
		 	   (CASE WHEN RuleType = 0 THEN ''
		 	   		 WHEN RuleType = 3 THEN C.MultiDisplayName
		 			 WHEN RuleType = 4 OR RuleType = 5 THEN E.MultiDisplayName
		 			 WHEN RuleType = 6 THEN F.JobFunctionName
		        ELSE GROUP_CONCAT(B.MappingName ORDER BY B.MappingID ASC SEPARATOR '|') 
		      	 END
		       ) AS MappingNames,
		       A.MappingCode, D.DomainID AS DN_ID
		  FROM covi_approval4j.jwf_rulemaster A
		  LEFT JOIN covi_approval4j.jwf_rulemastermapping B ON A.RuleID = B.RuleID
		  LEFT JOIN covi_smart4j.sys_object_user C ON A.MappingCode = C.UserCode
		  LEFT JOIN covi_smart4j.sys_object_domain D ON A.EntCode = D.DomainCode
		  LEFT JOIN covi_smart4j.sys_object_group E ON A.MappingCode = E.GroupCode
 		  LEFT JOIN covi_approval4j.jwf_jobfunction F ON A.MappingCode = F.JobFunctionCode		    
 		  
 		<trim prefix="WHERE" prefixOverrides="AND |OR ">	
 		        A.EntCode = #{entCode}	  
			<if test="sel_Type != null and sel_Type != '' and sel_Type.length() gt 0">
				AND A.ruletype = #{sel_Type}
			</if> 		        		
			<if test="sel_Type== '' and sel_Search != null and sel_Search != '' and sel_Search.length() gt 0">
				AND A.ruleName LIKE CONCAT('%',REGEXP_REPLACE(#{search},'(%|\'|\")','\\\\\\1'),'%')	
			</if>					
		</trim>			  
		
		 GROUP BY A.RuleID
		 <trim prefix="ORDER BY">
		  	<if test="sortColumn != null and sortDirection != null">
	    		<choose>
					<when test='sortColumn.equalsIgnoreCase("EntCode")'>EntCode</when>
					<when test='sortColumn.equalsIgnoreCase("RuleName")'>RuleName</when>
					<when test='sortColumn.equalsIgnoreCase("RuleType")'>RuleType</when>
					<otherwise>EntCode</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		 </trim>
	     <if test="pageSize != null and pageOffset != null">
	   		LIMIT #{pageSize} OFFSET #{pageOffset}
	   	 </if>			
	</select>
	
 	<select id="selectMasterManagementCnt" resultType="java.lang.Long">
		SELECT COUNT(*) AS cnt
		  FROM covi_approval4j.jwf_rulemaster
 		<trim prefix="WHERE" prefixOverrides="AND |OR ">	
 		        EntCode = #{entCode}	  
			<if test="sel_Type != null and sel_Type != '' and sel_Type.length() gt 0">
				AND ruletype = #{sel_Type}
			</if> 		        		
			<if test="sel_Type== '' and sel_Search != null and sel_Search != '' and sel_Search.length() gt 0">
				AND ruleName LIKE CONCAT('%',REGEXP_REPLACE(#{search},'(%|\'|\")','\\\\\\1'),'%')	
			</if>					
		</trim>			 	 
	</select>
	
	<insert id="insertMasterManagement" parameterType="cmap">	
		INSERT 
		  INTO covi_approval4j.jwf_rulemaster (EntCode, RuleName, RuleType, MappingCode)
	    VALUES (#{entCode}, #{ruleName}, #{ruleType}, #{mappingCode})
	</insert>
	
	<update id="updateMasterManagement" parameterType="cmap">			
		UPDATE covi_approval4j.jwf_rulemaster
		   SET RuleName = #{ruleName},
		   	   RuleType = #{ruleType},
		   	   MappingCode = #{mappingCode}
		 WHERE RuleID = #{ruleId}
	</update>
	
	<delete id="deleteMasterManagement" parameterType="cmap">
        DELETE 
          FROM covi_approval4j.jwf_rulemaster 
         WHERE RuleID = #{ruleId}
	</delete>
	
<!--     <select id="selectMasterRuleCode" parameterType="cmap" resultType="cmap"> -->
<!--         SELECT RuleCode -->
<!--           FROM covi_approval4j.jwf_rulemaster  -->
<!--          WHERE RuleCode = #{ruleCode} -->
<!-- 	</select>	 -->
	
<!--     <select id="selectUpdateMasterRuleCode" parameterType="cmap" resultType="cmap"> -->
<!--         SELECT RuleCode -->
<!--           FROM covi_approval4j.jwf_rulemaster  -->
<!--          WHERE RuleCode = #{ruleCode} -->
<!--          AND RuleId != #{ruleId} -->
<!-- 	</select>	 -->
	
    <select id="selectMappingList" parameterType="cmap" resultType="cmap">
        SELECT MappingID, MappingCode, MappingName 
          FROM covi_approval4j.jwf_rulemastermapping 
         WHERE RuleId = #{ruleId}
	</select>
	
 
	<insert id="insertMapping" parameterType="cmap">	
		INSERT 
		  INTO covi_approval4j.jwf_rulemastermapping (RuleID, MappingCode, MappingName)
	    VALUES (#{ruleId}, #{mappingCode}, #{mappingName})
	</insert>
	
	<delete id="deleteMapping" parameterType="cmap">
        DELETE
          FROM covi_approval4j.jwf_rulemastermapping 
         WHERE 1 = 1
	     <if test="ruleId != null and ruleId != ''">
		   AND RuleID = #{ruleId}
		 </if>
	     <if test="paramArr != null and paramArr != ''">
	       AND MappingID IN
	         <foreach collection="paramArr" item="mappingId" open="(" close=")" separator=",">
	            #{mappingId}
	         </foreach>
		 </if>		        
	</delete>
	
    <select id="selectRankList" parameterType="cmap" resultType="cmap">
        SELECT G.GroupID AS JobPositionID, G.GroupCode AS JobPositionCode, G.DisplayName AS JobPositionName FROM covi_smart4j.sys_object_group G
		 INNER JOIN covi_smart4j.sys_object_domain D ON G.CompanyCode = D.DomainCode
		 WHERE G.GroupType = 'JobPosition'
		 AND D.DomainID = #{dnId}
		 ORDER BY JobPositionID ASC;
	</select>
	
    <select id="selectRuleTreeList" parameterType="cmap" resultType="cmap">
		SELECT ItemID as id, ItemID AS no, ItemName AS nodeName, UpperItemID AS pid, UpperItemID AS pno, UpperItemCode AS pcode, '#' AS url, ItemCode as code,
			   DocKind, ItemDesc, ItemType AS type, MaxAmount, SortNum
		  FROM covi_approval4j.jwf_ruleitem A
		 WHERE EntCode = #{entCode}
		 ORDER BY sortnum,ItemID
	</select>
	
	<insert id="insertRuleTree" parameterType="cmap">	
		INSERT 
		INTO covi_approval4j.jwf_ruleitem (
			EntCode, ItemName, UpperItemID, DocKind, ItemDesc, ItemType, ItemCode,
			AccountCode, AccountName, StandardBriefID, StandardBriefName, GroupCode, GroupName, MaxAmount,
			UpperItemCode,SortNum
		)
	    VALUES (
	    	#{entCode}, #{itemName}, IF(#{upperItemId} = '', NULL, #{upperItemId}), #{docKind}, #{itemDesc}, #{itemType}, #{itemCode}, 
	    	#{AccountCode}, #{AccountName}, #{StandardBriefID}, #{StandardBriefName}, #{GroupCode}, #{GroupName}, IF(#{MaxAmount} = '', 0, #{MaxAmount}),
	    	#{upperItemCode},#{sortnum}
	    )
	</insert>
	
	<update id="updateRuleTree" parameterType="cmap">			
		UPDATE covi_approval4j.jwf_ruleitem
		   SET ItemName = #{itemName},
		   	   DocKind = #{docKind},
		   	   ItemDesc = #{itemDesc},
		   	   ItemType = #{itemType},
			   AccountCode = #{AccountCode},
			   AccountName = #{AccountName},
			   StandardBriefID = #{StandardBriefID},
			   StandardBriefName = #{StandardBriefName},
			   GroupCode = #{GroupCode},
			   GroupName = #{GroupName},
			   SortNum = #{sortnum},
			   MaxAmount = IF(#{MaxAmount} = '', 0, #{MaxAmount})
		 WHERE ItemID = #{itemId}
	</update>
	
	<delete id="deleteRuleTree" parameterType="cmap">
        DELETE 
          FROM covi_approval4j.jwf_ruleitem
         WHERE ItemID IN (SELECT * 
         					FROM (SELECT ItemID
								    FROM covi_approval4j.jwf_ruleitem
								   WHERE FIND_IN_SET(ItemID, (SELECT (CASE WHEN Level IS NULL THEN #{itemId} 
								   										   ELSE CONCAT(#{itemId},',',GROUP_CONCAT(Level SEPARATOR ',')) 
								   										    END)
								   							   FROM (SELECT @Ids := (SELECT GROUP_CONCAT(ItemID SEPARATOR ',')
																			           FROM covi_approval4j.jwf_ruleitem
																			          WHERE FIND_IN_SET(UpperItemID, @Ids)
									      											 ) Level
																	   FROM covi_approval4j.jwf_ruleitem
																	   JOIN (SELECT @Ids := #{itemId}) temp1
																	  WHERE FIND_IN_SET(UpperItemID, @Ids)
									   								 ) temp2
															  )
													  )
								 ) temp3
         				 )
	</delete>
	
    <select id="selectRuleGridList" parameterType="cmap" resultType="cmap">
		SELECT ApvID, B.ItemName, B.ItemID, ApvName, 
			   C.RuleName, C.RuleID, ApvType, ApvDesc, 
			   Sort
		  FROM covi_approval4j.jwf_ruleapv A
		  LEFT JOIN covi_approval4j.jwf_ruleitem B
		    ON A.ItemID = B.ItemID
		  LEFT JOIN covi_approval4j.jwf_rulemaster C
		    ON A.ruleId = C.ruleId
		 WHERE A.ItemID = #{itemId}
		 <trim prefix="ORDER BY">
		  	<if test="sortColumn != null and sortDirection != null">
	    		<choose>
					<when test='sortColumn.equalsIgnoreCase("ApvID")'>ApvID</when>
					<when test='sortColumn.equalsIgnoreCase("RuleID")'>RuleID</when>
					<when test='sortColumn.equalsIgnoreCase("ApvType")'>ApvType</when>
					<when test='sortColumn.equalsIgnoreCase("ApvDesc")'>ApvDesc</when>
					<otherwise>Sort</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		 </trim>
	     <if test="pageSize != null and pageOffset != null">
	   		LIMIT #{pageSize} OFFSET #{pageOffset}
	   	 </if>		 
	</select>
	
 	<select id="selectRuleGridCnt" resultType="java.lang.Long">
		SELECT COUNT(*) AS cnt
		  FROM covi_approval4j.jwf_ruleapv
		 WHERE ItemID = #{itemId}
	</select>
	
	<select id="selectRuleManagement" parameterType="cmap" resultType="cmap">
		SELECT 	ApvName, ItemID, ItemCode, RuleID, ApvType, Sort, ApvDesc, ApvClass, ApvClassAtt01
		FROM 	covi_approval4j.jwf_ruleapv
		WHERE 	ApvID = #{apvId}
	</select>
	
	<insert id="insertRuleManagement" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleapv (ApvName, ItemID, ItemCode, RuleID, ApvType, Sort, ApvDesc, ApvClass, ApvClassAtt01)
	    VALUES (#{apvName}, #{itemId}, #{itemCode}, #{ruleId}, #{apvType}, #{sort}, #{apvDesc}, #{apvClass}, #{apvClassAtt01})
	</insert>
	
	<update id="updateRuleManagement" parameterType="cmap">			
		UPDATE 	covi_approval4j.jwf_ruleapv
		SET 	ApvName = #{apvName},
				RuleID = #{ruleId},
				ApvType = #{apvType},
				Sort = #{sort},
				ApvDesc = #{apvDesc},
				ApvClass = #{apvClass},
				ApvClassAtt01 = #{apvClassAtt01}
		WHERE 	ApvID = #{apvId}
	</update>
		
	<delete id="deleteRuleManagement" parameterType="cmap">
        DELETE 
          FROM covi_approval4j.jwf_ruleapv
         WHERE 1 = 1
	     <if test="itemId != null and itemId != ''">
		   AND ItemID IN (SELECT * 
         					FROM (SELECT ItemID
								    FROM covi_approval4j.jwf_ruleitem
								   WHERE FIND_IN_SET(ItemID, (SELECT (CASE WHEN Level IS NULL THEN #{itemId} 
								   										   ELSE CONCAT(#{itemId},',',GROUP_CONCAT(Level SEPARATOR ',')) 
								   										    END)
								   							   FROM (SELECT @Ids := (SELECT GROUP_CONCAT(ItemID SEPARATOR ',')
																			           FROM covi_approval4j.jwf_ruleitem
																			          WHERE FIND_IN_SET(UpperItemID, @Ids)
									      											 ) Level
																	   FROM covi_approval4j.jwf_ruleitem
																	   JOIN (SELECT @Ids := #{itemId}) temp1
																	  WHERE FIND_IN_SET(UpperItemID, @Ids)
									   								 ) temp2
															  )
													  )
								 ) temp3
         				  )
		 </if>
	     <if test="paramArr != null and paramArr != ''">
	         AND ApvID IN
	         <foreach collection="paramArr" item="apvId" open="(" close=")" separator=",">
	            #{apvId}
	         </foreach>
		 </if>
	</delete>
		
 	<select id="selectRuleForSelBox" resultType="cmap">
		SELECT 	RuleID
				,RuleName
		FROM 	covi_approval4j.jwf_rulemaster
		WHERE 	EntCode = #{EntCode}
			AND RuleId IS NOT null
	</select>
	
 	<select id="selectRuleForForm" resultType="cmap">
		SELECT ItemID,ItemCode, EntCode, ItemName, ItemDesc, MaxAmount,
			   CONCAT(B.DisplayName,' > ',covi_approval4j.Fn_GetRuleItemFullPath2(ItemCode, EntCode)) AS path 
		  FROM covi_approval4j.jwf_ruleitem A
		  INNER JOIN covi_smart4j.sys_object_domain B
		    ON A.EntCode = B.DomainCode
		 WHERE 1 = 1
 		 AND UpperItemCode IS NOT NULL AND UpperItemCode &lt;&gt; '0'
	    <if test="entCode != null and entCode != ''">
	   		AND EntCode = #{entCode}
	   	</if>
	    <if test="entCodeList != null and entCodeList != ''">
		    AND EntCode IN 
				<foreach collection="entCodeList" item="item" index="index" separator="," open="(" close=")">
				    #{item}
				</foreach>
		</if>
	    <if test="itemType != null and itemType != ''">
	   		AND ItemType = #{itemType}
	   	</if>
	   	ORDER BY A.SortNum, A.ItemID
	</select>
	
    <select id="selectApvRuleList" parameterType="cmap" resultType="cmap">
		SELECT A.ItemID,A.ItemCode, A.ItemDesc, A.MaxAmount,
			   covi_approval4j.Fn_GetRuleItemFullPath(A.ItemCode) AS PATH,
			   GROUP_CONCAT(CONCAT(B.ApvType,'|',B.RuleID,'|',B.ApvName,'|',B.Sort,'|',IFNULL(ApvClass, ''),'|',IFNULL(ApvClassAtt01, '')) ORDER BY B.Sort ASC SEPARATOR ',') AS ApvNames,
			   NULLIF(GROUP_CONCAT(B.draftNm SEPARATOR ''),'') AS draftNm,
			   CNT
		  FROM covi_approval4j.jwf_ruleitem A
		  LEFT JOIN (SELECT ItemID, ItemCode, ApvType, RuleID, ApvName, Sort, ApvClass, ApvClassAtt01,
		 					(CASE WHEN ApvType = 'initiator' AND Sort = 0 THEN ApvName 
		 						  ELSE '' 
		 						   END
		 					) AS draftNm
		 			   FROM covi_approval4j.jwf_ruleapv
		 			) B
		   ON A.ItemID = B.ItemID
		 JOIN (SELECT MAX(CNT) AS CNT 
		 		 FROM (SELECT ItemCode, COUNT(ItemCode) AS CNT
						 FROM covi_approval4j.jwf_ruleapv
						WHERE ItemCode IN
					    <foreach collection="paramArr" item="ItemCode" open="(" close=")" separator=",">
				        	#{ItemCode}
				        </foreach>
						  AND !(ApvType = 'initiator' AND Sort = 0)
						  AND ApvType <![CDATA[<>]]> 'ccinfo'
						  AND ApvType <![CDATA[<>]]> 'ccinfo-before'
					    GROUP BY ItemCode
					  ) T
			   ) C   
		 WHERE A.ItemCode IN
		 <foreach collection="paramArr" item="ItemCode" open="(" close=")" separator=",">
		 	#{ItemCode}
		 </foreach>		
		 <if test="entCode != null and entCode != ''">
		 	AND A.EntCode = #{entCode}
		 </if> 
		 GROUP BY A.ItemCode
		 ORDER BY A.SortNum,A.ItemID
	</select>
	
    <select id="selectApvRuleListForForm" parameterType="cmap" resultType="cmap">
		SELECT 		A.ApvID, A.ApvName, A.ItemID, A.RuleID, A.ApvType, A.Sort, C.RuleType, A.ApvClass, A.ApvClassAtt01
					,IFNULL(C.MappingCode,'') AS MappingCode
		FROM 		covi_approval4j.jwf_ruleapv A
		LEFT JOIN 	covi_approval4j.jwf_ruleitem B  ON A.ItemID = B.ItemID
		LEFT JOIN 	covi_approval4j.jwf_rulemaster C ON A.RuleID = C.RuleID
		WHERE 		A.ItemCode = #{itemCode}
				AND A.ApvType != 'initiator'
				<if test="entCode != null and entCode != ''">
			   		AND B.EntCode = #{entCode}
			   	</if>
		ORDER BY 	A.Sort
	</select>
	
    <select id="selectRuleTypeZero" parameterType="cmap" resultType="cmap">
        SELECT *
		  FROM (SELECT #{apvType} AS ApvType, ManagerCode AS ObjectCode, 'person' AS ObjectType,
					   DisplayName AS grName, GroupCode AS grCode
				  FROM covi_smart4j.sys_object_group
				 WHERE GroupCode = #{grCode}
			   ) A
		  LEFT JOIN (SELECT A.DisplayName AS UR_Name
		  					, A.UserCode AS UR_Code
		  					, A.ExternalMailAddress
		  					, BG.JobTitleCode
							, BG.JobTitleName
							, BG.JobLevelCode
							, BG.JobLevelName
							, BG.JobPositionCode
							, BG.JobPositionName
					   FROM covi_smart4j.sys_object_user A
					   LEFT JOIN covi_smart4j.sys_object_user_basegroup BG ON A.UserCode = BG.UserCode AND BG.JobType = 'Origin'
					) B
			ON A.ObjectCode = B.UR_Code
		 WHERE A.ObjectCode IS NOT NULL
		 AND UR_Code IS NOT NULL
	</select>
	
    <select id="selectRuleTypeOne" parameterType="cmap" resultType="cmap">
        SELECT *
		  FROM (SELECT #{apvType} AS ApvType, ManagerCode AS ObjectCode, 'person' AS ObjectType, 
			   DisplayName AS grName, GroupCode AS grCode
		  FROM covi_smart4j.sys_object_group
		  WHERE GroupCode = (SELECT MappingCode 
			  				FROM covi_approval4j.jwf_rulemastermapping
			  				JOIN covi_smart4j.sys_object_group ON GroupCode = #{grCode}
			 			   WHERE RuleID = #{ruleId} 
			 			   AND GroupPath LIKE CONCAT('%;',MappingCode,';%')
			 			   LIMIT 1
						  )
			   ) A
		  LEFT JOIN (SELECT A.DisplayName AS UR_Name
		  					, A.UserCode AS UR_Code
		  					, A.ExternalMailAddress
		  					, BG.JobTitleCode
							, BG.JobTitleName
							, BG.JobLevelCode
							, BG.JobLevelName
							, BG.JobPositionCode
							, BG.JobPositionName
					   FROM covi_smart4j.sys_object_user A
					   LEFT JOIN covi_smart4j.sys_object_user_basegroup BG ON A.UserCode = BG.UserCode AND BG.JobType = 'Origin'
					) B
			ON A.ObjectCode = B.UR_Code
		 WHERE A.ObjectCode IS NOT NULL;
	</select>
	
    <select id="selectRuleTypeTwo" parameterType="cmap" resultType="cmap">
        SELECT *
		  FROM (SELECT #{apvType} AS ApvType, 
		        	   covi_approval4j.Fn_GetRuleMappingPosition(#{ruleId},#{grCode}) AS ObjectCode, 
		        	   'person' AS ObjectType,
		        	   (SELECT DisplayName FROM covi_smart4j.sys_object_group WHERE GroupCode = #{grCode}) AS grName, 
		        	   #{grCode} AS grCode
		          FROM DUAL
		       ) A     
		  LEFT JOIN (SELECT A.DisplayName AS UR_Name
		  					, A.UserCode AS UR_Code
		  					, A.ExternalMailAddress
		  					, BG.JobTitleCode
							, BG.JobTitleName 
		  					, BG.JobLevelCode
							, BG.JobLevelName 
		  					, BG.JobPositionCode
							, BG.JobPositionName
					   FROM covi_smart4j.sys_object_user A
					   LEFT JOIN covi_smart4j.sys_object_user_basegroup BG ON A.UserCode = BG.UserCode AND BG.JobType = 'Origin'
					) B
			ON A.ObjectCode = B.UR_Code
		 WHERE A.ObjectCode IS NOT NULL
	</select>
	
    <select id="selectRuleTypeThree" parameterType="cmap" resultType="cmap">
        <!-- SELECT *,
			   (CASE WHEN (#{ruleType} = 3 || #{ruleType} = 4) THEN B.tempGrCode
		  			 ELSE C.tempGrCode
		  			  END
		  	   ) AS grCode,
			   (CASE WHEN (#{ruleType} = 3 || #{ruleType} = 4) THEN B.tempGrName
		  			 ELSE C.tempGrName
		  			  END
		  	   ) AS grName  		  	   
		  FROM (SELECT #{apvType} AS ApvType, #{mappingCode} AS ObjectCode,
		  			   (CASE WHEN #{ruleType} = 3 THEN 'person'
		  			         WHEN #{ruleType} = 4 THEN 'ou'
		  			         ELSE 'role'
		  			          END
		  			   ) AS ObjectType
		          FROM DUAL
		       ) A
		  LEFT JOIN (SELECT A.DisplayName AS UR_Name
		  					, A.UserCode AS UR_Code
		  					, A.ExternalMailAddress
		  					, BG.JobTitleCode
							, BG.JobTitleName 
		  					, BG.JobLevelCode
							, BG.JobLevelName 
		  					, BG.JobPositionCode
							, BG.JobPositionName
		  					, BG.DeptCode AS tempGrCode
							, BG.DeptName AS tempGrName  			
					   FROM covi_smart4j.sys_object_user A
					   LEFT JOIN covi_smart4j.sys_object_user_basegroup BG ON A.UserCode = BG.UserCode AND BG.JobType = 'Origin'
					) B
			ON A.ObjectCode = B.UR_Code
		  LEFT JOIN (SELECT JobFunctionCode as tempGrCode, JobFunctionName AS tempGrName
		  			   FROM covi_approval4j.jwf_jobfunction
		  			) C
		    ON A.ObjectCode = C.tempGrCode
		 WHERE A.ObjectCode IS NOT NULL -->
		 SELECT 
			#{apvType} AS ApvType
			, #{mappingCode} AS ObjectCode
			, 'person' AS ObjectType
			, A.DisplayName AS UR_Name
			, A.UserCode AS UR_Code
			, A.ExternalMailAddress
			, BG.JobTitleCode
			, BG.JobTitleName 
			, BG.JobLevelCode
			, BG.JobLevelName 
			, BG.JobPositionCode
			, BG.JobPositionName
			, BG.DeptCode AS tempGrCode
			, BG.DeptName AS tempGrName 
			, BG.DeptCode AS grCode
			, BG.DeptName AS grName 			
	   FROM covi_smart4j.sys_object_user A
	   LEFT JOIN covi_smart4j.sys_object_user_basegroup BG ON A.UserCode = BG.UserCode AND BG.JobType = 'Origin'
	   WHERE A.UserCode = #{mappingCode}
	</select>
	
    <select id="selectRuleTypeFour" parameterType="cmap" resultType="cmap">
        SELECT 
			#{apvType} AS ApvType
			, #{mappingCode} AS ObjectCode
			, 'ou' AS ObjectType
			, GroupCode AS grCode
			, DisplayName AS grName 			
	   FROM covi_smart4j.sys_object_group A
	   WHERE A.GroupCode = #{mappingCode}
    </select>
	    
    <select id="selectRuleTypeFive" parameterType="cmap" resultType="cmap">
        SELECT *
		  FROM (SELECT #{apvType} AS ApvType, ManagerCode AS ObjectCode, 'person' AS ObjectType, 
					   DisplayName AS grName, GroupCode AS grCode
				  FROM covi_smart4j.sys_object_group
				 WHERE GroupCode = #{mappingCode}
			   ) A
		  LEFT JOIN (SELECT A.DisplayName AS UR_Name
		  					, A.UserCode AS UR_Code
		  					, A.ExternalMailAddress
		  					, BG.JobTitleCode
							, BG.JobTitleName 
		  					, BG.JobLevelCode
							, BG.JobLevelName 
		  					, BG.JobPositionCode
							, BG.JobPositionName
					   FROM covi_smart4j.sys_object_user A
					   LEFT JOIN covi_smart4j.sys_object_user_basegroup BG ON A.UserCode = BG.UserCode AND BG.JobType = 'Origin'
					) B
			ON A.ObjectCode = B.UR_Code
		 WHERE A.ObjectCode IS NOT NULL
	</select>
    
    <select id="selectRuleTypeSix" parameterType="cmap" resultType="cmap">
        SELECT 
			#{apvType} AS ApvType
			, #{mappingCode} AS ObjectCode
			, 'role' AS ObjectType
			, JobFunctionCode AS grCode
			, JobFunctionName AS grName
	   FROM covi_approval4j.jwf_jobfunction
	   WHERE JobFunctionCode = #{mappingCode}
    </select> 
    
    <select id="selectItemMoreInfo" parameterType="cmap" resultType="cmap">
    	SELECT
    		ItemID,
    		ItemName,
    		ItemDesc,
    		ItemType,
	   		covi_approval4j.Fn_GetRuleItemFullPath(ItemID) AS PATH,
    		AccountCode,
    		AccountName,
    		StandardBriefID,
    		StandardBriefName,
    		GroupCode,
    		GroupName,
    		MaxAmount
    	FROM covi_approval4j.jwf_ruleitem
    	WHERE ItemID = #{itemId}    		
    </select>
    
   
       <!-- 사용안한X-->
	<insert id="insertRulManagement" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem (ItemCode, EntCode, ItemName, UpperItemCode, ItemType)
	    VALUES (#{ItemCode}, #{EntCode}, #{ItemName}, #{UpperItemCode}, #{ItemType})
	</insert>    
	
 	
	
	  <!-- 사용안한X-->
    <!-- 전결규정 등록된 아이템코드 조회-->
	<select id="selectRuleItemCnt" parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT count(*)
 		  FROM covi_approval4j.jwf_ruleitem
 		 WHERE itemcode = #{itemcode}
	</select>	
	

	
	  <!-- 사용안한X-->
    <!-- 회사 코드 조회-->
	<select id="selectEntCodeCnt" parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT count(*)
 		  FROM covi_smart4j.sys_object_domain
 		 WHERE DomainCode = #{entcode}
	</select>	
	
	
	
	<!-- 전결규정 EXCEL 업로드 TEMP -->
	<insert id="insertRulTemp" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_rule_temp (code01,code02,code03,code04,code05,name01,name02,name03,name04,name05,charge,approval01,approval02,approval03,approval04,approval05,approval06,approval07,approval08,approval09,approval10,fullcode,entcode)
	    VALUES (#{code01},#{code02},#{code03},#{code04},#{code05},#{name01},#{name02},#{name03},#{name04},#{name05},#{charge},#{approval01},#{approval02},#{approval03},#{approval04},#{approval05},#{approval06},#{approval07},#{approval08},#{approval09},#{approval10},#{fullcode},#{entcode})
	</insert> 	
	
	<!-- item 1 level 추가 -->
	<insert id="insertRulItem01" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum)
		SELECT ENTCODE, name01, concat(code01,'00000000') AS ITEMCODE,'','APPROVAL' ,#{vernum} 
		FROM covi_approval4j.jwf_rule_temp  
		group by code01,name01
		ORDER BY   code01,name01      
	</insert>  
		
	<!-- item 2 level 추가 -->
	<insert id="insertRulItem02" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum)
		SELECT A.ENTCODE, A.name02, CONCAT(A.code01,A.code02,'000000') AS ITEMCODE,concat(A.code01,'00000000'),'APPROVAL',#{vernum}   
		FROM covi_approval4j.jwf_rule_temp  A
		 INNER JOIN covi_approval4j.jwf_ruleitem B ON B.ItemCode = concat(A.code01,'00000000')
		WHERE B.EntCode=#{entcode} 
		group by code01,name01,code02,name02,ItemID
		ORDER BY   code01,code02     
	</insert>  
	
	<!-- item 3 level 추가 -->
	<insert id="insertRulItem03" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum)
		SELECT A.ENTCODE, A.name03, CONCAT(A.code01,A.code02,A.code03,'0000') AS ITEMCODE,concat(A.code01,A.code02,'000000'),'APPROVAL',#{vernum}   
		FROM covi_approval4j.jwf_rule_temp  A
		 INNER JOIN covi_approval4j.jwf_ruleitem B ON B.ItemCode = concat(A.code01,A.code02,'000000')
		WHERE B.EntCode=#{entcode}  AND A.name03 !=''
		group by code01,code02,code03,name03,ItemID
		ORDER BY   code01,code02,code03    
	</insert>  
	
	<!-- item 4 level 추가 -->
	<insert id="insertRulItem04" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum)
		SELECT A.ENTCODE, A.name04, CONCAT(A.code01,A.code02,A.code03,A.code04,'00') AS ITEMCODE,concat(A.code01,A.code02,A.code03,'0000'),'APPROVAL',#{vernum}   
		FROM covi_approval4j.jwf_rule_temp  A
		 INNER JOIN covi_approval4j.jwf_ruleitem B ON B.ItemCode = concat(A.code01,A.code02,A.code03,'0000')
		WHERE B.EntCode=#{entcode}  AND A.name04 !=''
		group by code01,code02,code03,code04,name04,ItemID
		ORDER BY code01,code02,code03,code04   
	</insert> 	
	
	<!-- item 5 level 추가 -->
	<insert id="insertRulItem05" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum)
		SELECT A.ENTCODE, A.name05, CONCAT(A.code01,A.code02,A.code03,A.code04,A.code05) AS ITEMCODE,concat(A.code01,A.code02,A.code03,A.code04,'00'),'APPROVAL',#{vernum}   
		FROM covi_approval4j.jwf_rule_temp  A
		 INNER JOIN covi_approval4j.jwf_ruleitem B ON B.ItemCode = concat(A.code01,A.code02,A.code03,A.code04,'00')
		WHERE B.EntCode=#{entcode}  AND A.name05 !=''
		group by code01,code02,code03,code04,code05,name05,ItemID
		ORDER BY code01,code02,code03,code04,code05
	</insert> 
	
	<!-- item 1 level History 추가 -->
	<insert id="insertRulItem01History" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem_history (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum,insertdate,insertuser)
		SELECT ENTCODE, name01, concat(code01,'00000000') AS ITEMCODE,'','APPROVAL' ,#{vernum},SYSDATE(),#{insertuser} 
		FROM covi_approval4j.jwf_rule_temp  
		group by code01,name01
		ORDER BY   code01,name01      
	</insert>  
		
	<!-- item 2 level History 추가 -->
	<insert id="insertRulItem02History" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem_history (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum,insertdate,insertuser)
		SELECT A.ENTCODE, A.name02, CONCAT(A.code01,A.code02,'000000') AS ITEMCODE,concat(A.code01,'00000000'),'APPROVAL',#{vernum},SYSDATE(),#{insertuser}      
		FROM covi_approval4j.jwf_rule_temp  A
		 INNER JOIN covi_approval4j.jwf_ruleitem B ON B.ItemCode = concat(A.code01,'00000000')
		WHERE B.EntCode=#{entcode} 
		group by code01,name01,code02,name02,ItemID
		ORDER BY   code01,code02     
	</insert>  
	
	<!-- item 3 level History 추가 -->
	<insert id="insertRulItem03History" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem_history (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum,insertdate,insertuser)
		SELECT A.ENTCODE, A.name03, CONCAT(A.code01,A.code02,A.code03,'0000') AS ITEMCODE,concat(A.code01,A.code02,'000000'),'APPROVAL',#{vernum},SYSDATE(),#{insertuser}      
		FROM covi_approval4j.jwf_rule_temp  A
		 INNER JOIN covi_approval4j.jwf_ruleitem B ON B.ItemCode = concat(A.code01,A.code02,'000000')
		WHERE B.EntCode=#{entcode}  AND A.name03 !=''
		group by code01,code02,code03,name03,ItemID
		ORDER BY   code01,code02,code03    
	</insert>  
	
	<!-- item 4 level History 추가 -->
	<insert id="insertRulItem04History" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem_history (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum,insertdate,insertuser)
		SELECT A.ENTCODE, A.name04, CONCAT(A.code01,A.code02,A.code03,A.code04,'00') AS ITEMCODE,concat(A.code01,A.code02,A.code03,'0000'),'APPROVAL',#{vernum},SYSDATE(),#{insertuser}       
		FROM covi_approval4j.jwf_rule_temp  A
		 INNER JOIN covi_approval4j.jwf_ruleitem B ON B.ItemCode = concat(A.code01,A.code02,A.code03,'0000')
		WHERE B.EntCode=#{entcode}  AND A.name04 !=''
		group by code01,code02,code03,code04,name04,ItemID
		ORDER BY code01,code02,code03,code04   
	</insert> 	
	
	<!-- item 5 level History 추가 -->
	<insert id="insertRulItem05History" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleitem_history (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum,insertdate,insertuser)
		SELECT A.ENTCODE, A.name05, CONCAT(A.code01,A.code02,A.code03,A.code04,A.code05) AS ITEMCODE,concat(A.code01,A.code02,A.code03,A.code04,'00'),'APPROVAL',#{vernum},SYSDATE(),#{insertuser}     
		FROM covi_approval4j.jwf_rule_temp  A
		 INNER JOIN covi_approval4j.jwf_ruleitem B ON B.ItemCode = concat(A.code01,A.code02,A.code03,A.code04,'00')
		WHERE B.EntCode=#{entcode}  AND A.name05 !=''
		group by code01,code02,code03,code04,code05,name05,ItemID
		ORDER BY code01,code02,code03,code04,code05
	</insert> 	
	
	<insert id="insertRulMaster" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_rulemaster (EntCode, RuleName, RuleType,MappingCode)
		VALUES (#{entcode},#{rulename},#{ruletype},'')
		
		  <selectKey keyProperty="RuleID" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
	     </selectKey>
	</insert> 
	
	<insert id="insertRulMasterHistory" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_rulemaster_history (EntCode, RuleName, RuleType,MappingCode,VerNum,insertdate,InsertUser)
		VALUES (#{entcode},#{rulename},#{ruletype},'', #{vernum},SYSDATE(), #{insertuser})		
	</insert> 	
	
    <!-- 전결규정 마스터 코드 조회-->
	<select id="selectRuleIdCnt" parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT  count(*)
 		  FROM covi_approval4j.jwf_rulemaster
 		 WHERE RuleName = #{rulename}
	</select>	
	
    <!-- 전결규정 마스터 코드 조회-->
	<select id="selectRuleId" parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT  RuleID FROM covi_approval4j.jwf_rulemaster
 		 WHERE RuleName = #{rulename}
 		 ORDER BY RuleID desc
 		 limit 1
	</select>	
	
	  <!-- 결재선정보 insert-->
	<insert id="insertRulApvItem" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleapv (ApvName, ItemCode, RuleId, ApvType, Sort,VerNum)
	    VALUES (#{ApvName}, #{ItemCode}, #{RuleId}, #{ApvType}, #{Sort}, #{vernum})
	</insert> 
	
	  <!-- 결재선정보 history insert-->
	<insert id="insertRulApvItemHistory" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_ruleapv_history (ApvName, ItemCode, RuleId, ApvType, Sort,VerNum,insertdate,insertuser)
	    VALUES (#{ApvName}, #{ItemCode}, #{RuleId}, #{ApvType}, #{Sort}, #{vernum},SYSDATE(), #{insertuser})
	</insert> 	
	
    <select id="selectRulManageExcel" parameterType="cmap" resultType="cmap">
		SELECT   
		 code01,code02,code03,code04,code05,name01,name02,name03,name04,name05,charge,approval01,approval02,approval03,approval04,approval05,approval06,approval07,approval08,approval09,approval10	
		FROM covi_approval4j.jwf_rule_temp
		WHERE NAME02 != "" AND NAME03 != ""
		 AND EntCode = #{EntCode}
		ORDER BY CODE01 asc  
		
    </select>	
    
 	<delete id="deleteRulTemp" parameterType="cmap">
        DELETE FROM covi_approval4j.jwf_rule_temp 
	</delete>   
    
 
	<insert id="insertRulExcelTemp" parameterType="cmap">	
		 INSERT INTO covi_approval4j.jwf_rule_temp (
		   code01,code02,code03,code04,code05,name01,name02,name03,name04,name05,charge,approval01,approval02,approval03,approval04,approval05,approval06,approval07,approval08,approval09,approval10,fullcode,entcode		   
		 ) 
		 SELECT SUBSTRING(A.itemcode,1,2) AS 'CODE1'
		        ,SUBSTRING(A.itemcode,3,2) AS 'CODE2'
				  ,IFNULL(SUBSTRING(A.itemcode,5,2),'') AS 'CODE3'
				  ,IFNULL(SUBSTRING(A.itemcode,7,2),'') AS 'CODE4'
				  ,IFNULL(SUBSTRING(A.itemcode,9,2),'') AS 'CODE5'
				  ,IFNULL(B.ItemName,'') AS 'NAME01'
				  ,IFNULL(C.ItemName,'') AS 'NAME02'
				  ,IFNULL(D.ItemName,'') AS 'NAME03'
				  ,IFNULL(E.ItemName,'') AS 'NAME04'
				  ,IFNULL(F.ItemName,'') AS 'NAME05'
				  ,IFNULL(RA.ApvName,'') AS 'Charge'
				  ,IFNULL(R1.ApvName,'') AS 'Approval01'
				  ,IFNULL(R2.ApvName,'') AS 'Approval02'
				  ,IFNULL(R3.ApvName,'') AS 'Approval03'
				  ,IFNULL(R4.ApvName,'') AS 'Approval04'
				  ,IFNULL(R5.ApvName,'') AS 'Approval05'
				  ,IFNULL(R6.ApvName,'') AS 'Approval06'
				  ,IFNULL(R7.ApvName,'') AS 'Approval07'
				  ,IFNULL(R8.ApvName,'') AS 'Approval08'
				  ,IFNULL(R9.ApvName,'') AS 'Approval09'
				  ,IFNULL(R10.ApvName,'') AS 'Approval10'				  				  				  				  				  				  				  				  				   
				  ,IFNULL(A.itemcode,'') AS 'fullcode'
				  ,IFNULL('ORGROOT','') AS 'entcode'
		 FROM covi_approval4j.jwf_ruleitem A
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleitem B ON CONCAT(SUBSTRING(A.itemcode,1,2),'00000000')=B.itemcode  
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleitem C ON CONCAT(SUBSTRING(A.itemcode,1,4),'000000')=C.itemcode  AND SUBSTRING(A.itemcode,3,2) != '00'
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleitem D ON CONCAT(SUBSTRING(A.itemcode,1,6),'0000')=D.itemcode  AND SUBSTRING(A.itemcode,5,2) != '00'
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleitem E ON CONCAT(SUBSTRING(A.itemcode,1,8),'00')=E.itemcode  AND SUBSTRING(A.itemcode,7,2) != '00'
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleitem F ON CONCAT(SUBSTRING(A.itemcode,1,10),'')=F.itemcode   AND SUBSTRING(A.itemcode,9,2) != '00'
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv RA ON A.itemcode= RA.itemcode AND RA.ApvType ='initiator'
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R1 ON A.itemcode= R1.itemcode AND R1.Sort=1
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R2 ON A.itemcode= R2.itemcode AND R2.Sort=2
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R3 ON A.itemcode= R3.itemcode AND R3.Sort=3
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R4 ON A.itemcode= R4.itemcode AND R4.Sort=4
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R5 ON A.itemcode= R5.itemcode AND R5.Sort=5
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R6 ON A.itemcode= R6.itemcode AND R6.Sort=6
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R7 ON A.itemcode= R7.itemcode AND R7.Sort=7
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R8 ON A.itemcode= R8.itemcode AND R8.Sort=8
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R9 ON A.itemcode= R9.itemcode AND R9.Sort=9
		  LEFT OUTER JOIN covi_approval4j.jwf_ruleapv R10 ON A.itemcode= R10.itemcode AND R10.Sort=10
		 WHERE A.itemcode !='' 
		  AND A.EntCode = #{EntCode}
		 ORDER BY A.itemcode asc;
	</insert> 	
	
    <!-- 최신 버전 번호 -->
	<select id="selectRuleVerNum" parameterType="java.lang.String" resultType="java.lang.Integer">
			SELECT IFNULL(VerNum,0)+1 AS VerNum
			FROM (
				SELECT  distinct IFNULL(VerNum,0) AS VerNum   FROM covi_approval4j.jwf_rulemain_history 
				UNION 
				SELECT 0 AS VerNum
			) T
			ORDER BY VerNum desc
			LIMIT 1
	</select>
	
    <!-- 사용 버전 번호 -->
	<select id="selectRuleVerNumUse" parameterType="java.lang.String" resultType="java.lang.Integer">
			SELECT IFNULL(VerNum,0)+1 AS VerNum
			FROM (
				SELECT  distinct IFNULL(VerNum,0) AS VerNum   FROM covi_approval4j.jwf_rulemain_history where IsUse='Y'
				UNION 
				SELECT 0 AS VerNum
			) T
			ORDER BY VerNum desc
			LIMIT 1
	</select>	
	
	
	<delete id="deleteRulMaster" parameterType="java.lang.Integer">
        DELETE FROM covi_approval4j.jwf_rulemaster WHERE VerNum = #{vernum}
	</delete>	
	
	<delete id="deleteRulApvItem" parameterType="java.lang.Integer">
        DELETE FROM covi_approval4j.jwf_ruleapv 
	</delete>	
	
	<delete id="deleteRulItem" parameterType="java.lang.Integer">
        DELETE FROM covi_approval4j.jwf_ruleitem 
	</delete>	
	
	<delete id="deleteRulItemCur" parameterType="java.lang.Integer">
        DELETE FROM covi_approval4j.jwf_ruleitem WHERE VerNum = #{curVerNum}
	</delete>	
	
	<delete id="deleteRulApvItemCur" parameterType="java.lang.Integer">
        DELETE FROM covi_approval4j.jwf_ruleapv WHERE VerNum = #{curVerNum}
	</delete>		
	
	  <!-- 결재선 history 메인정보 insert-->
	<insert id="insertRulMainHistory" parameterType="cmap">	
		INSERT INTO covi_approval4j.jwf_rulemain_history (VerNum, EntCode,insertdate, InsertUser,description,IsUse )
	    VALUES (#{vernumtop}, #{entcode},SYSDATE(), #{insertuser},'','Y')
	</insert> 	
	
     <!-- 버전관리 목록 조회  -->
    <select id="selectRulHistoryList" parameterType="cmap" resultType="cmap">	 
		SELECT 
		     VerNum, EntCode, InsertDate,InsertUser,Description,IFNULL(IsUse,'N') AS IsUse,Updatedate,UpdateUser
		FROM covi_approval4j.jwf_rulemain_history 
		<trim prefix="WHERE" prefixOverrides="AND |OR ">		  		
			<if test="serach_vernum != null and serach_vernum != '' and serach_vernum.length() gt 0">
				AND VerNum = #{search}  	
			</if>	
		   <if test="startdate != null and startdate != '' and startdate.length() gt 0">
				 AND InsertDate <![CDATA[>=]]> #{startdate}  	
			</if>

			<if test="enddate != null and enddate != '' and enddate.length() gt 0">
				 AND InsertDate  <![CDATA[<=]]>  #{enddate}  
			</if>										
		</trim>	
		 <trim prefix="ORDER BY">
		  	<choose>
				<when test='sortColumn.equalsIgnoreCase("IsUse")'>IsUse</when>
				<when test='sortColumn.equalsIgnoreCase("EntCode")'>EntCode</when>
				<when test='sortColumn.equalsIgnoreCase("InsertUser")'>InsertUser</when>
				<when test='sortColumn.equalsIgnoreCase("InsertDate")'>InsertDate</when>
				<when test='sortColumn.equalsIgnoreCase("UpdateUser")'>UpdateUser</when>
				<when test='sortColumn.equalsIgnoreCase("Updatedate")'>Updatedate</when>
				<when test='sortColumn.equalsIgnoreCase("Description")'>Description</when>
				<otherwise>VerNum</otherwise>
			</choose>
			<choose>
				<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
				<otherwise> DESC</otherwise>
			</choose>
		 </trim>	

    </select>	
    
    <select id="selectRulHistorycnt" resultType="java.lang.Long">
		SELECT COUNT(*) FROM
			  (SELECT 
		     VerNum, EntCode, InsertDate,InsertUser,Description
		FROM covi_approval4j.jwf_rulemain_history
		<trim prefix="WHERE" prefixOverrides="AND |OR ">		  		
			<if test="serach_vernum != null and serach_vernum != '' and serach_vernum.length() gt 0">
				AND VerNum = #{search}
			</if>	
		   <if test="startdate != null and startdate != '' and startdate.length() gt 0">
				 AND InsertDate <![CDATA[>=]]> #{startdate}  	
			</if>

			<if test="enddate != null and enddate != '' and enddate.length() gt 0">
				 AND InsertDate  <![CDATA[<=]]>  #{enddate}  
			</if>											
		</trim>				
		) A		
	</select>  

     <!-- 버전관리 상세페이지  -->
    <select id="selectRuleHistoryData" parameterType="cmap" resultType="cmap">	 
		SELECT 
		     VerNum, EntCode, InsertDate,InsertUser,Description,IFNULL(IsUse,'N') AS IsUse,Updatedate,UpdateUser
		FROM covi_approval4j.jwf_rulemain_history  
		WHERE vernum = #{vernum} 
    </select>	
    
 	<update id="updateRuleHistoryData" parameterType="cmap">
		<![CDATA[
			UPDATE covi_approval4j.jwf_rulemain_history
			SET			
				Description = #{Description}
				,IsUse = #{IsUse}
				,UpdateUser = #{UpdateUser}
				,Updatedate = SYSDATE()
			WHERE
				VerNum = #{VerNum}				
		]]>
	</update>
	
 	<update id="updateRuleHistoryDataInit" parameterType="cmap">
		<![CDATA[
			UPDATE covi_approval4j.jwf_rulemain_history
			SET	IsUse ='N'
		]]>
	</update>
	
	<!-- 선택버전으로 전결분류 insert -->
	<insert id="insertRulItemVer" parameterType="java.lang.Integer">
		INSERT INTO covi_approval4j.jwf_ruleitem (EntCode,ItemName,ItemCode,UpperItemCode,ItemType,VerNum)
		SELECT ENTCODE, ItemName, itemcode, upperitemcode, ItemType, VerNum
		FROM covi_approval4j.jwf_ruleitem_history
		WHERE VerNum=#{VerNum}
		ORDER BY itemid ASC
	</insert>

	<!-- 선택버전으로 결재선정보 insert-->
	<insert id="insertRulApvItemVer" parameterType="java.lang.Integer">
		INSERT INTO covi_approval4j.jwf_ruleapv (ApvName, ItemCode, RuleId, ApvType, Sort,VerNum)
		SELECT ApvName, ItemCode, RuleId, ApvType, Sort,VerNum
		FROM covi_approval4j.jwf_ruleapv_history
		WHERE VerNum=#{VerNum}
		ORDER BY apvid ASC
	</insert>
	
	<select id="getRuleCount" parameterType="cmap" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM covi_approval4j.jwf_ruleitem 
		WHERE ItemCode = #{itemCode}
		AND EntCode = #{entCode}
	</select>
	
	<update id="updateRuleApvItemID" parameterType="cmap">			
		UPDATE covi_approval4j.jwf_ruleapv A
		INNER JOIN covi_approval4j.jwf_ruleitem B ON A.ItemCode = B.ItemCode
		SET A.ItemID = B.ItemID
		WHERE 1 = 1
	</update>
	
	<update id="updateRuleItemUpperItemID" parameterType="cmap">			
		UPDATE covi_approval4j.jwf_ruleitem A
		INNER JOIN covi_approval4j.jwf_ruleitem B ON A.UpperItemCode = B.ItemCode
		SET A.UpperItemID = B.ItemID 
		WHERE 1 = 1
	</update>
</mapper>

