<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="framework.authority">
 	<sql id="searchGroup">
 		AND a.SubjectType != 'UR'
	 	AND ((g.GroupType !='Dept' AND g.GroupCode IN 
			<foreach collection="subjectCodeArr" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
			)
			OR (g.GroupType ='Dept' AND a.IsSubInclude = 'Y' AND INSTR(#{deptPath},g.GroupPath) = 1) 
			OR (g.GroupType ='Dept' AND a.IsSubInclude = 'N' AND #{deptPath}  = g.GroupPath)
		 )
 	</sql>
 	
    <!-- 비사용 -->
 	<select id="selectAssignedBaseGroup" parameterType="cmap" resultType="cmap">
		<![CDATA[
			SELECT CompanyCode AS "CompanyCode"
			     , DeptCode AS "DeptCode"
			     , RegionCode  AS "RegionCode"
			     , JobPositionCode  AS "JobPositionCode"
			     , JobTitleCode  AS "JobTitleCode"
			     , JobLevelCode  AS "JobLevelCode"
			FROM SYS_OBJECT_USER_BASEGROUP
			WHERE UserCode = #{userCode}
			AND CompanyCode = (SELECT DomainCode FROM sys_object_domain WHERE DomainID = #{domainID})
	    ]]>
	</select>
    
    <select id="selectGroupPath" parameterType="cmap" resultType="String">
		<![CDATA[
			SELECT GroupPath AS "GroupPath"
			FROM sys_object_group
			WHERE GroupCode = #{deptCode}
	    ]]>
	</select>
    
 	<select id="selectAllowedURL" parameterType="cmap" resultType="cmap">
	<![CDATA[
		SELECT AccessUrlID AS "AccessUrlID"
			, URL AS "URL"
		FROM SYS_ACCESS_URL
		WHERE IsUse = 'Y'
    ]]>
	</select>
 	
 	<select id="selectAssignedGroup" parameterType="cmap" resultType="cmap">
		<![CDATA[
			SELECT DISTINCT GM.GroupCode AS "GroupCode"
			FROM sys_object_group_member GM
			INNER JOIN sys_object_group G ON GM.GroupCode = G.GroupCode
			WHERE UserCode = #{userCode}
			AND G.CompanyCode IN (#{domainCode}, 'ORGROOT')
			AND G.GroupType NOT IN ('Dept', 'JobLevel', 'JobPosition', 'JobTitle')
	    ]]>
	</select>
	
	<select id="selectAuthorizedACL_User" parameterType="cmap" resultType="cmap">
   		SELECT AclID AS "AclID"
			, ObjectID AS "ObjectID"
			, ObjectType AS "ObjectType"
			, AclList AS "AclList"
		FROM sys_object_acl 
		<if test="objectType == 'PT'">
			INNER JOIN portal pt on pt.BizSection = 'Portal' AND pt.IsUse = 'Y' and pt.PortalID = ObjectID
		</if>	
		WHERE ObjectType = #{objectType}
		AND SubjectType = 'UR'
		AND SubjectCode = #{userCode}
	</select>
	<select id="selectAuthorizedACL_Group" parameterType="cmap" resultType="cmap">
	    SELECT AclID AS "AclID"
			, ObjectID AS "ObjectID"
			, ObjectType AS "ObjectType"
			, AclList AS "AclList"
			, (
				CASE WHEN SubjectType = 'CM' THEN '9'
				WHEN SubjectType = 'DEPT' THEN '2' 
				ELSE '3' END 
			) AS "AclPriority"
		FROM sys_object_acl a 
		INNER JOIN sys_object_group g ON a.SubjectCode = g.GroupCode 
		INNER JOIN sys_object_group_type gt ON gt.GroupType = g.GroupType
		<if test="objectType == 'PT'">
			INNER JOIN portal pt on pt.BizSection = 'Portal' AND pt.IsUse = 'Y' and pt.PortalID = ObjectID
		</if>	
		WHERE a.ObjectType = #{objectType}
		<include refid="searchGroup" />
		ORDER BY "AclPriority" DESC, Priority DESC, GroupPath ASC, AclID DESC
	</select>
 	
	<select id="selectAuthorizedACL_Lic" parameterType="cmap" resultType="cmap">
   		SELECT  b.InitPortal ObjectID
				, 'PT' ObjectType
				, '_____V_' AclList
		  FROM sys_object_user a
		LEFT JOIN sys_license b  ON a.LicSeq = b.LicSeq
		INNER JOIN portal pt on  pt.PortalType='Business' and  pt.IsUse = 'Y' and pt.PortalID = b.InitPortal
		WHERE userCode = #{userCode}
	</select>
	
	<select id="selectAuthorizedACL_Folder_User" parameterType="cmap" resultType="cmap">
		SELECT AclID AS "AclID"
			, ObjectID AS "ObjectID"
			, A.ObjectType AS "ObjectType"
			, AclList AS "AclList"
			, F.ObjectType AS "BizSection"
		FROM sys_object_acl a 
		INNER JOIN sys_object_folder F ON A.ObjectID = F.FolderID
		WHERE a.ObjectType = 'FD'
		AND a.SubjectType = 'UR'
		AND a.SubjectCode = #{userCode}
		<if test="serviceType != null and serviceType != '' ">
		    AND F.ObjectType = #{serviceType}
		</if>
	</select>
	<select id="selectAuthorizedACL_Folder_Group" parameterType="cmap" resultType="cmap">
		SELECT AclID AS "AclID"
			, ObjectID AS "ObjectID"
			, A.ObjectType AS "ObjectType"
			, AclList AS "AclList"
			, (
				CASE WHEN SubjectType = 'CM' THEN '9'
				WHEN SubjectType = 'DEPT' THEN '2' 
				ELSE '3' END 
			) AS "AclPriority"
			, F.ObjectType AS "BizSection"
		FROM sys_object_acl a 
		INNER JOIN sys_object_group g ON a.SubjectCode = g.GroupCode 
		INNER JOIN sys_object_group_type gt ON gt.GroupType = g.GroupType
		INNER JOIN sys_object_folder F ON A.ObjectID = F.FolderID
		WHERE a.ObjectType = 'FD'
		<include refid="searchGroup" />
		<if test="serviceType != null and serviceType != '' ">
		    AND F.ObjectType = #{serviceType}
		</if>
		ORDER BY "AclPriority" DESC, Priority DESC, GroupPath ASC, AclID DESC
	</select>
	
 	<select id="selectAuthorizedMenu" parameterType="cmap" resultType="cmap">
		<![CDATA[
			SELECT  a.MenuID AS "MenuID"
			      , a.DomainID AS "DomainID"
			      , a.IsAdmin AS "IsAdmin"
			      , a.MenuType AS "MenuType"
			      , a.BizSection AS "BizSection"
			      , a.ParentObjectID AS "ParentObjectID"
			      , a.ParentObjectType AS "ParentObjectType"
			      , a.ServiceDevice AS "ServiceDevice"
			      , a.MultiDisplayName AS "MultiDisplayName"
			      , a.IconClass AS "IconClass"
			      , a.MemberOf AS "MemberOf"
			      ,	a.MenuPath AS "MenuPath"
			      , a.LinkMenuID AS "LinkMenuID"
			      , a.SecurityLevel AS "SecurityLevel"
			      , a.SortKey AS "SortKey"
			      , a.SiteMapPosition AS "SiteMapPosition"
			      , a.SortPath AS "SortPath"
			      , a.HasFolder AS "HasFolder"
			      , a.IsInherited AS "IsInherited"
			      , a.IsUse AS "IsUse"
			      , a.IsDisplay AS "IsDisplay"
			      , CASE WHEN a.OriginMenuID IS NOT NULL AND a.OriginMenuID>0 THEN b.URL ELSE a.URL END AS "URL"
			      , CASE WHEN a.OriginMenuID IS NOT NULL AND a.OriginMenuID>0 THEN b.MobileURL ELSE a.MobileURL END AS "MobileURL"
			      , a.Target AS "Target"
			      , a.MobileTarget AS "MobileTarget"
			      , a.Reserved1 AS "Reserved1"
			      , a.Reserved2 AS "Reserved2"
			      , a.Reserved3 AS "Reserved3"
			      , a.Reserved4 AS "Reserved4"
			      , CASE WHEN a.OriginMenuID IS NOT NULL AND a.OriginMenuID>0 THEN b.Reserved5 ELSE a.Reserved5 END AS "Reserved5"
				  , case when a.domainid =0 then  a.menuid else a.OriginMenuID  end as "OriginMenuID"
			FROM SYS_OBJECT_MENU a
			LEFT JOIN SYS_OBJECT_MENU b ON a.OriginMenuID = b.MenuID AND b.DomainID = 0
			WHERE a.MenuID IN ]]>
			<foreach collection="menuIDArr" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
			<if test="bizSectionArr != null and bizSectionArr.length > 0">     	
		     	AND 		a.BizSection IN  
				<foreach collection="bizSectionArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>	
			AND a.IsUse = 'Y' AND a.IsDisplay = 'Y'
			AND a.DomainID IN (0, #{domainID})
			ORDER BY a.DomainID ASC, a.SortKey ASC
	</select>
	
 	<insert id="insertACL" parameterType="cmap">
		<![CDATA[
			INSERT INTO SYS_OBJECT_ACL 
				(      ObjectID
                     , ObjectType
                     , SubjectCode
                     , SubjectType
                     , AclList
                     , Security
                     , Create_
                     , Delete_
                     , Modify_
                     , Execute
                     , View_
                     , Read
                     , Description
                     , RegisterCode
                     , RegistDate
                     , InheritedObjectID
                     , IsSubInclude
				) VALUES  (       
					   #{objectID}
	                 , #{objectType}
	                 , #{subjectCode}
	                 , #{subjectType}
	                 , #{aclList}
	                 , #{security}
	                 , #{create}
	                 , #{delete}
	                 , #{modify}
	                 , #{execute}
	                 , #{view}
	                 , #{read}
	                 , #{description}
	                 , #{registerCode}
	                 , SYSDATE
	                 , #{inheritedObjectID}
	                 , #{isSubInclude}
				)
		]]>
	</insert>
 	
 	<insert id="insertInheritedACL" parameterType="cmap">
		INSERT INTO SYS_OBJECT_ACL (ObjectID, ObjectType, SubjectCode, SubjectType, AclList, Security, Create_, Delete_, Modify_, Execute, View_, Read, Description, RegisterCode, RegistDate, InheritedObjectID, IsSubInclude)
		SELECT	  #{objectID}
				, ObjectType
				, A.SubjectCode
				, A.SubjectType
				, AclList
				, Security
				, Create_
				, Delete_
				, Modify_
				, Execute
				, View_
				, Read
				, Description
				, #{registerCode}
				, SYSDATE
				, CASE  WHEN ObjectType = 'FD' THEN (SELECT MemberOf FROM SYS_OBJECT_FOLDER WHERE FolderID = #{objectID})
						WHEN ObjectType = 'MN' THEN (SELECT MemberOf FROM SYS_OBJECT_MENU WHERE MenuID = #{objectID})
				  ELSE  0 END
				, IsSubInclude
		FROM SYS_OBJECT_ACL A
		LEFT OUTER JOIN (
			SELECT SubjectCode, SubjectType
			FROM SYS_OBJECT_ACL
			WHERE ObjectID = #{objectID}
			AND InheritedObjectID = 0
		) B ON A.SubjectCode = B.SubjectCode AND A.SubjectType = B.SubjectType
		WHERE A.ObjectID = #{inheritedObjectID}
		AND A.ObjectType = #{objectType}
		AND B.SubjectCode IS NULL
	</insert>
 	
 	<insert id="insertACLVO" parameterType="egovframework.coviframework.vo.ObjectAcl">
            INSERT INTO SYS_OBJECT_ACL(  ObjectID
		                                            , ObjectType
		                                            , SubjectCode
		                                            , SubjectType
		                                            , AclList
		                                            , Security
		                                            , Create_
		                                            , Delete_
		                                            , Modify_
		                                            , Execute
		                                            , View_
		                                            , Read
		                                            , Description
		                                            , RegisterCode
		                                            , RegistDate
                                    			  )
                            			  VALUES (	#{objectID}
                            			    	    , #{objectType}
                            			    	    , #{subjectCode}
                            			    	    , #{subjectType}
                            			    	    , #{aclList}
                            			    	    , #{security}
                            			    	    , #{create}
                            			    	    , #{delete}
                            			    	    , #{modify}
                            			    	    , #{execute}
                            			    	    , #{view}
                            			    	    , #{read}
                            			    	    , #{description}
                            			    	    , #{registerCode}
                            			    	    , SYSDATE
                            			    	  ) 
    </insert>
 	
 	<insert id="insertACLList" parameterType="clist">
         INSERT ALL
         <foreach collection="list" item="aclData" index="index" separator=" ">
	         INTO SYS_OBJECT_ACL(    
	         	ObjectID
	            , ObjectType
	            , SubjectCode
	            , SubjectType
	            , AclList
	            , Security
	            , Create_
	            , Delete_
	            , Modify_
	            , Execute
	            , View_
	            , Read
	            , Description
	            , RegisterCode
	            , RegistDate
	        )
			VALUES
			(
				#{aclData.objectID}
				, #{aclData.objectType}
				, #{aclData.subjectCode}
				, #{aclData.subjectType}
				, #{aclData.aclList}
				, #{aclData.security}
				, #{aclData.create}
				, #{aclData.delete}
				, #{aclData.modify}
				, #{aclData.execute}
				, #{aclData.view}
				, #{aclData.read}
				, #{aclData.description}
				, #{aclData.registerCode}
				, SYSDATE
	        )
        </foreach>
        SELECT * FROM DUAL
    </insert>
 	
 	<delete id="deleteACL" parameterType="cmap">
		<![CDATA[
	        DELETE FROM SYS_OBJECT_ACL
			WHERE ObjectID = #{objectID} 
			  AND ObjectType = #{objectType} 
		]]>
	</delete>
 	
 	<delete id="deleteACLList" parameterType="cmap">
		<![CDATA[
		    DELETE FROM SYS_OBJECT_ACL
			WHERE ObjectType = #{objectType}  
			  AND ObjectID IN
		]]>
		<foreach item="item" index="index" collection="objectIDs" open="(" close=")" separator=",">
	         		#{item}
	  	</foreach>
	</delete>
	
	<delete id="deleteInheritedACL" parameterType="cmap">
		DELETE FROM SYS_OBJECT_ACL
		WHERE 1=1
		<if test='inheritedObjectID != null and inheritedObjectID != ""'>
			<if test='objectType != null and objectType != "" and objectType == "FD"'>							  		   	
			AND ObjectID IN (SELECT DISTINCT FolderID 
							   FROM (SELECT FolderID, ';' || FolderPath AS FolderPath
								       FROM SYS_OBJECT_FOLDER WHERE IsInherited = 'Y') A 
								      WHERE FolderPath LIKE '%;'|| #{inheritedObjectID} ||';%') 
			AND NVL(InheritedObjectID, 0) != 0
			</if>
			
			<if test='objectType != null and objectType != "" and objectType == "MN"'>							  		   	
			AND ObjectID IN (SELECT DISTINCT MenuID 
							   FROM (SELECT MenuID, ';' || MenuPath AS MenuPath 
								       FROM SYS_OBJECT_MENU WHERE IsInherited = 'Y') A 
								   	  WHERE MenuPath LIKE '%;'|| #{inheritedObjectID} ||';%')
			AND NVL(InheritedObjectID, 0) != 0
			</if>
		</if>
		<if test='objectID != null and objectID != ""'>
			AND ObjectID = #{objectID}
			AND InheritedObjectID IS NOT NULL
			AND InheritedObjectID != 0
		</if>
		AND ObjectType = #{objectType}
	</delete>
 	
	<select id="selectACL" parameterType="cmap" resultType="cmap">
		SELECT	  AclID AS "AclID"
				, ObjectID AS "ObjectID"
				, ObjectType AS "ObjectType"
				, SubjectCode AS "SubjectCode"
				, SubjectType AS "SubjectType"
				, AclList AS "AclList"
				, SubjectName AS "SubjectName"
				, MultiSubjectName AS "MultiSubjectName"
				, CompanyCode AS "CompanyCode"
				, GroupType AS "GroupType"
				, SortKey AS "SortKey"
				, InheritedObjectID AS "InheritedObjectID"
				, IsSubInclude AS "IsSubInclude"
		FROM (
			SELECT	  A.AclID
					, A.ObjectID
					, A.ObjectType
					, A.SubjectCode
					, A.SubjectType
					, A.AclList
					, Fn_BaseGetDictionary_S(#{lang}, U.MultiDisplayName) AS SubjectName
					, U.MultiDisplayName AS MultiSubjectName
					, UB.CompanyCode
					, 'UR' AS GroupType
					, (SELECT SortKey FROM SYS_OBJECT_GROUP_TYPE WHERE GroupType = 'UR') AS SortKey
					<choose>
						<when test='inheritedObjectID != null and inheritedObjectID != ""'>
						, NVL(#{inheritedObjectID}, 0) AS InheritedObjectID
						</when>
						<otherwise>
						, NVL(A.InheritedObjectID, 0) AS InheritedObjectID	
						</otherwise>
					</choose>
					,IsSubInclude
			FROM SYS_OBJECT_ACL A
			INNER JOIN SYS_OBJECT_USER U ON A.SubjectCode = U.UserCode
			INNER JOIN SYS_OBJECT_USER_BASEGROUP UB ON UB.UserCode = U.UserCode AND UB.JobType = 'Origin'
			WHERE A.ObjectType = #{objectType}
			  AND A.ObjectID = #{objectID}
			  AND A.SubjectType = 'UR'
			
			UNION
			
			SELECT	  A.AclID
					, A.ObjectID
					, A.ObjectType
					, A.SubjectCode
					, A.SubjectType
					, A.AclList
					, Fn_BaseGetDictionary_S(#{lang}, G.MultiDisplayName) AS SubjectName
					, G.MultiDisplayName AS MultiSubjectName
					, G.CompanyCode
					, G.GroupType
					, GT.SortKey
					<choose>
						<when test='inheritedObjectID != null and inheritedObjectID != ""'>
						, NVL(#{inheritedObjectID}, 0) AS InheritedObjectID
						</when>
						<otherwise>
						, NVL(A.InheritedObjectID, 0) AS InheritedObjectID	
						</otherwise>
					</choose>				
					,IsSubInclude
			FROM SYS_OBJECT_ACL A
			INNER JOIN SYS_OBJECT_GROUP G ON A.SubjectCode = G.GroupCode
			INNER JOIN SYS_OBJECT_GROUP_TYPE GT ON GT.GroupType = G.GroupType
			WHERE A.ObjectType = #{objectType}
			  AND A.ObjectID = #{objectID}
			  AND A.SubjectType != 'UR'
		) A
		ORDER BY InheritedObjectID DESC, SortKey, SubjectName
	</select>
	
	<select id="selectCompanyACL" parameterType="cmap" resultType="cmap">	
		  SELECT
				 '0' AS "AclID"
				,'0' AS "ObjectID"
				,#{objectType} AS "ObjectType"
				,SOG.GroupCode AS "SubjectCode"
				,'CM' AS "SubjectType"
				,'SCDMEVR' AS "AclList"
				,'S' AS "Security"
				,'C' AS "Create"
				,'D' AS "Delete"
				,'M' AS "Modify"
				,'E' AS "Execute"
				,'V' AS "View"
				,'R' AS "Read"
				,SOG.DisplayName AS "SubjectName"
				,SOG.MultiDisplayName AS "MultiSubjectName"
				,SOG.CompanyCode AS "CompanyCode"
				,SOG.GroupType AS "GroupType"
				,0 AS "SortKey"
				,0 AS "InheritedObjectID"
				,'Y' AS "IsSubInclude"
			   FROM SYS_OBJECT_GROUP SOG
			  WHERE SOG.GroupCode = #{companyCode}
	</select>
	
	<select id="selectInheritedACL" parameterType="cmap" resultType="cmap">
		<if test='objectType != null and objectType != "" and objectType == "FD"'>
			SELECT *
			FROM (SELECT  FolderID AS "ObjectID"
						, FolderID AS "FolderID"
						, MemberOf AS "MemberOf"
						, ';' || FolderPath AS "FolderPath"
				  FROM SYS_OBJECT_FOLDER
				  WHERE IsInherited = 'Y'
				 ) A
			WHERE "FolderPath" LIKE '%;'|| #{inheritedObjectID} ||';%'
		</if>
		
		<if test='objectType != null and objectType != "" and objectType == "MN"'>
			SELECT *
			FROM (SELECT  MenuID AS "ObjectID"
						, MenuID AS "FolderID"
						, MemberOf AS "MemberOf"
						, ';' || MenuPath AS "MenuPath"
				  FROM SYS_OBJECT_MENU
				  WHERE IsInherited = 'Y'
				 ) A
			WHERE "MenuPath" LIKE '%;'|| #{inheritedObjectID} ||';%'
		</if>
	</select>
	

	<select id="selectSyncDomain" parameterType="cmap" resultType="cmap">
		<if test="URAction != null and URAction.length > 0">
			SELECT DISTINCT DomainID AS "DomainID" FROM SYS_OBJECT_USER_BASEGROUP BG
			INNER JOIN SYS_OBJECT_DOMAIN DN ON BG.CompanyCode = DN.DomainCode
			WHERE UserCode IN 
			<foreach collection="URAction" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="URAction != null and URAction.length > 0 and GRAction != null and GRAction.length > 0">
			UNION
		</if>
		<if test="GRAction != null and GRAction.length > 0">
			SELECT DISTINCT DomainID AS "DomainID" FROM SYS_OBJECT_GROUP GR
			INNER JOIN SYS_OBJECT_DOMAIN DN ON GR.CompanyCode = DN.DomainCode
			WHERE GroupCode IN 
			<foreach collection="GRAction" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
	</select>
</mapper>
