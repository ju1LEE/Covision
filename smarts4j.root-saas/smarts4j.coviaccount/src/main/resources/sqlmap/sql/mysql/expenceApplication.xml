<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="expenceApplication">
    
    <select id="getCardReceipt" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.getCardReceipt
 	    	법인카드 사용내역
 	    */
		SELECT 		
			CR.ReceiptID
			, CR.ItemNo
			, 'CorpCard' as ProofCode
			, CR.CardNo
			, DATE_FORMAT( CR.UseDate, '%Y%m%d') AS ProofDate
			, DATE_FORMAT( CR.UseDate, '%Y.%m.%d') AS ProofDateStr
			, TIME_FORMAT( CR.ApproveTime, '%H%i%s') AS ProofTime
			, TIME_FORMAT( CR.ApproveTime, '%H:%i:%s') AS ProofTimeStr
			, CR.ReceiptID CardUID
			, CR.ApproveNo CardApproveNo
			, CR.AmountWon AS TotalAmount
			, CR.RepAmount AS RepAmount
			, CR.TaxAmount AS TaxAmount
			, CR.ServiceAmount AS ServiceAmount
			, CR.StoreName
			, CR.StoreNo
			, CR.StoreCondition
			, CR.StoreAddress1 || CR.StoreAddress2 AS StoreAddress
			, CR.StoreTel
			, AL.ExpenceApplicationListID
			, IF(AL.ExpenceApplicationListID IS NULL, 'N', 'Y') IsDuplicate
			, CC.VendorNo
			, (CASE WHEN SC.AccountCode IS NOT NULL AND SC.AccountCode != '' THEN SC.AccountCode ELSE CR.AccountCode END) AS AccountCode
			, (SELECT AccountName FROM covi_account4j_si.act_account AA WHERE AA.CompanyCode = CC.COMPANYCODE AND AA.AccountCode
				= CASE WHEN SC.AccountCode IS NOT NULL AND SC.AccountCode != '' THEN SC.AccountCode ELSE CR.AccountCode END) AS AccountName
			, (CASE WHEN SC.StandardBriefID IS NOT NULL AND SC.StandardBriefID != '' THEN SC.StandardBriefID ELSE CR.StandardBriefID END) AS StandardBriefID
			, (SELECT StandardBriefName FROM covi_account4j_si.act_standard_brief ASB WHERE ASB.StandardBriefID
				= CASE WHEN SC.StandardBriefID IS NOT NULL AND SC.StandardBriefID != '' THEN SC.StandardBriefID ELSE CR.StandardBriefID END) AS StandardBriefName
			, (SELECT TaxCode FROM covi_account4j_si.act_account AA WHERE AA.AccountCode = SC.AccountCode) AS TaxCode
			, (SELECT TaxType FROM covi_account4j_si.act_account AA WHERE AA.AccountCode = SC.AccountCode) AS TaxType
			, CR.CostCenterCode
			, (SELECT CostCenterName FROM covi_account4j_si.act_cost_center ACC WHERE ACC.CostCenterCode = CR.CostCenterCode) AS CostCenterName
			, CR.UsageText
			, CR.Amount
			, CR.StoreCategory
		FROM covi_account4j_si.act_card_receipt CR
		LEFT OUTER JOIN (
							SELECT MAX(AL.ExpenceApplicationListID) ExpenceApplicationListID
							, AL.CardUID
							FROM covi_account4j_si.act_expence_application_list AL
							INNER JOIN covi_account4j_si.act_expence_application AA
								ON AL.ExpenceApplicationID = AA.ExpenceApplicationID
							WHERE AA.ApplicationStatus NOT IN ('R', 'C', 'DELETE')
							GROUP BY  CardUID
							) AL
			ON CR.ReceiptID = AL.CardUID
		INNER JOIN covi_account4j_si.act_corp_card CC ON CR.CardNo = CC.CardNo
		LEFT JOIN covi_account4j_si.act_store_category SC
		ON	CR.StoreCategory = SC.CategoryCode
		AND CC.COMPANYCODE = SC.COMPANYCODE
		WHERE 
			<choose>
				<when test="receiptIDList != null">
					<foreach collection="receiptIDList" item="item" index="index" separator="," open="CR.ReceiptID IN (" close=")">
						#{item}
					</foreach>
				</when>
				<otherwise>
					1=2
				</otherwise>
			</choose>
	</select>
	
    <select id="getTaxCodeList" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.getTaxCodeList
 	    	세금코드 목록
 	    */
	    SELECT BC.CodeGroup
		, BC.Code
		, BC.CodeName
		, PTM.ProofCode
		, PTM.DeductionType
		, CONCAT(PTM.ProofCode,PTM.DeductionType,BC.Code) AS MapCode
		, BC.IsUse
		FROM covi_account4j_si.act_base_code BC
		INNER JOIN covi_account4j_si.act_proof_tax_mapp PTM
		ON BC.CodeGroup = 'TaxCode'
		AND BC.Code = PTM.Code
		AND BC.CodeGroup = PTM.CodeGroup
		WHERE 1=1
		AND	PTM.CompanyCode = (
				CASE WHEN EXISTS (SELECT Code FROM covi_account4j_si.act_proof_tax_mapp WHERE CompanyCode = #{companyCode})
				THEN #{companyCode}
				ELSE 'ALL'
				END
			)
	  	<if test="searchProofCode != null and searchProofCode != ''">
		 	AND PTM.ProofCode = #{searchProofCode}
		</if>
	  	<if test="searchDeductionType != null and searchDeductionType != ''">
		 	AND PTM.DeductionType = #{searchDeductionType}
		</if>
		
	</select>
    
	<select id="selectExpenceApplicationListDuplCk" parameterType="cmap" resultType="cmap">
       SELECT  Count(*) TotalCnt
			 , COUNT(AEAL.CardUID) CCCnt
			 , COUNT(AEAL.TaxUID) TBCnt
			 , COUNT(AEAL.CashUID) CBCnt
			 , COUNT(AEAL.ReceiptID) MRCnt
			 , GROUP_CONCAT(AEAL.CardUID) CCList
			 , GROUP_CONCAT(AEAL.TaxUID) TBList
			 , GROUP_CONCAT(AEAL.CashUID) CBlist
			 , GROUP_CONCAT(AEAL.ReceiptID) MRList
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		WHERE AEA.ApplicationStatus NOT IN ('R', 'C', 'DELETE')
	  	<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID != #{ExpenceApplicationID}
		</if>
		AND 
		(
			1=2
			
			<choose>
				<when test="CCList != null">
					OR (AEAL.ProofCode = 'CorpCard' AND 
					<foreach collection="CCList" item="item" index="index" separator="," open="AEAL.CardUID IN (" close=")">
						#{item}
					</foreach>
					)
				</when>
			</choose>
			<choose>
				<when test="TBList != null">
					OR (AEAL.ProofCode = 'TaxBill' AND 
					<foreach collection="TBList" item="item" index="index" separator="," open="AEAL.TaxUID IN (" close=")">
						#{item}
					</foreach>
					)
				</when>
			</choose>
			<choose>
				<when test="CBList != null">
					OR (AEAL.ProofCode = 'CashBill' AND 
					<foreach collection="CBList" item="item" index="index" separator="," open="AEAL.CashUID IN (" close=")">
						#{item}
					</foreach>
					)
				</when>
			</choose>
			<choose>
				<when test="MRList != null">
					OR (AEAL.ProofCode = 'Receipt' AND 
					<foreach collection="MRList" item="item" index="index" separator="," open="AEAL.ReceiptID IN (" close=")">
						#{item}
					</foreach>
					)
				</when>
			</choose>
		)
    </select>
 
    
    
    
    <insert id="insertExpApp" parameterType="cmap">
 	    /*
 	    	expenceApplication.insertExpApp
 	    	통합비용신청
 	    */
		INSERT INTO covi_account4j_si.act_expence_application
		(
			CompanyCode
			, ApplicationTitle
			, ApplicationType
			, ApplicationStatus
			, RequestType
			, UR_Code
			, RegisterID
			, RegistDate
			, ModifierID
			, ModifyDate
			, ChargeJob
			, PayDateType
			, RuleItemInfo
			, Sub_UR_Code
			, Sub_UR_Info
			, Note
		)
		VALUES
		(
			 #{CompanyCode}
			, #{ApplicationTitle}
			, #{ApplicationType}
			, #{ApplicationStatus}
			, #{RequestType}
 	    	, IF(#{ApplicationStatus}='S',#{SessionUser}, '' )
			, #{SessionUser}
			, now()
			, #{SessionUser}
			, now()
			, #{ChargeJob}
			, #{PayDateType}
			, #{RuleItemInfo}
			, #{Sub_UR_Code}
			, #{Sub_UR_Info}
			, #{Note}
		)
		
		<selectKey keyProperty="ExpenceApplicationID" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>
    
    
    <update id="updateExpApp" parameterType="cmap">
 	    /*
 	    	expenceApplication.updateExpApp
 	    	통합비용신청
 	    */
 	    
 	    UPDATE covi_account4j_si.act_expence_application
 	    SET ApplicationTitle = #{ApplicationTitle}
 	    	, ApplicationStatus = #{ApplicationStatus}
 	    	, RequestType = #{RequestType}
 	    	, UR_Code = IF(#{ApplicationStatus}='S',#{SessionUser}, '' )
			, ModifierID = #{SessionUser}
			, ModifyDate = now()
			, ChargeJob = #{ChargeJob}
			, PayDateType = #{PayDateType}
			, RuleItemInfo = #{RuleItemInfo}
			, Sub_UR_Code = #{Sub_UR_Code}
			, Sub_UR_Info = #{Sub_UR_Info}
			, Note = CASE
					 	WHEN ApplicationStatus = 'T' THEN #{Note}
					 	ELSE Note
					 END
		WHERE ExpenceApplicationID = #{ExpenceApplicationID}
	</update>
	
	
	
	<update id="updateApvStatus" parameterType="cmap"> 	    
 	    UPDATE covi_account4j_si.act_expence_application
 	    SET ApplicationStatus = #{ApplicationStatus}
 	    	<if test="ProcessID != 'CHARGE'">
			, ProcessID = #{ProcessID}
			</if>
			<if test="ApplicationStatus == 'D'.toString()">
			, ApplicationDate = now()
			</if>
			, UR_Code = #{UR_Code}
			, Comment = #{Comment}
		WHERE ExpenceApplicationID = #{ExpenceApplicationID}
	</update>
	
    <select id="selectUpdateActivityList" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.selectUpdateActivityList
 	    	Active Update 목록
 	    */
		SELECT AEA.ExpenceApplicationID
		, AEAL.ExpenceApplicationListID
		, AEAL.ProofCode
		, CASE 
			WHEN AEAL.ProofCode = 'TaxBill'
				THEN AEAL.TaxUID
			WHEN AEAL.ProofCode = 'CorpCard'
				THEN AEAL.CardUID
			WHEN AEAL.ProofCode = 'Receipt'
				THEN AEAL.ReceiptID
		END ReceiptID
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		AND AEAL.ProofCode IN ('TaxBill', 'CorpCard', 'Receipt')
		WHERE AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		
	</select>
	
    
    <update id="updateTaxBillActive" parameterType="cmap">
 	    /*
 	    	expenceApplication.updateTaxBillActive
 	    	전자세금계산서 상태변경
 	    */
 	    
 	    UPDATE covi_account4j_si.act_taxinvoice
 	    SET ApproveStatus = #{Active}
		WHERE TaxInvoiceID = #{ReceiptID}
	</update>
	
    <update id="updateCardActive" parameterType="cmap">
 	    /*
 	    	expenceApplication.updateCardActive
 	    	카드 영수증 상태변경
 	    */
 	    
 	    UPDATE covi_account4j_si.act_card_receipt
 	    SET Active = #{Active}
		WHERE ReceiptID = #{ReceiptID}
	</update>
	    
    <update id="updateMobileActive" parameterType="cmap">
 	    /*
 	    	expenceApplication.updateMobileActive
 	    	모바일 영수증 상태변경
 	    */
 	    
 	    UPDATE covi_account4j_si.act_receipt
 	    SET Active = #{Active}
		WHERE ReceiptID = #{ReceiptID}
	</update>
	    
    <update id="updateApplicationStatus" parameterType="cmap">
 	    /*
 	    	expenceApplication.updateApplicationStatus
 	    	비용신청 상태 변경 및 결재 데이터 삭제
 	    */
 	    
 	    UPDATE covi_account4j_si.act_expence_application
 	    SET 
 	    	ApplicationStatus = 'T'
 	    	, ProcessID = NULL
 	    	, UR_Code = ''
			, ModifierID = #{SessionUser}
			, ModifyDate = now()
		WHERE ExpenceApplicationID = #{ExpenceApplicationID}
	</update>
	    
    <update id="updateBizTripStatus" parameterType="cmap">
 	    /*
 	    	expenceApplication.updateBizTripStatus
 	    	출장정산 상태 변경 및 결재 데이터 삭제
 	    */
		UPDATE covi_account4j_si.act_biztrip_application
		SET 
			ApplicationStatus = 'T'
			, ProcessID = NULL
			, UserID = NULL
			, ModifierID = #{SessionUser}
			, ModifyDate = NOW(3)
		WHERE ExpenceApplicationID = #{ExpenceApplicationID}
	</update>
	
    <update id="updateCapitalStatus" parameterType="cmap">
 	    UPDATE covi_account4j_si.act_expence_application_list
 	    SET 
 	    	CapitalStatus = #{CapitalStatus}
 	    <if test="expAppListIDs != null">
 	    	<foreach collection="expAppListIDs" item="item" index="index" separator="," open="WHERE ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
 	    </if>
 	    <if test="expAppListIDs == null or expAppListIDs == ''">
		WHERE ExpenceApplicationID = #{ExpenceApplicationID}
		</if>
    </update>
    
    <update id="updateBusinessDataForApv" parameterType="cmap">
    	UPDATE covi_approval4j.jwf_processdescription
    	SET
    			BusinessData3 = #{AmountSum}
    		,	BusinessData4 = #{UsageComment}
    	WHERE	BusinessData2 = CAST(#{ExpenceApplicationID} AS VARCHAR(10)) 
    </update>	
    
    <insert id="saveExpAppList" parameterType="cmap">
 	    /*
 	    	expenceApplication.saveExpAppList
 	    	통합비용신청 항목 목록
 	    */
		INSERT INTO covi_account4j_si.act_expence_application_list
		(
			
			ExpenceApplicationID
			, ProofDate
			, ProofCode
			, CardUID
			, CashUID
			, TaxUID
			, ReceiptID
			, PostingDate
			, TaxType
			, TaxCode
			, PayAdjustMethod
			, PayMethod
			, PayType
			, PayTarget
			, IsWithholdingTax
			, IncomeTax
			, LocalTax
			, PayDate
			, VendorNo
			, VendorName
			, TotalAmount
			, PersonalCardNo
		 	, RepAmount
		 	, TaxAmount
			
			, RegisterID
			, RegistDate
			
			, ExpenceApplicationListID
			
			, BankCode
			, BankAccountNo
			, BankAccountName
			
			, ReservedStr1
			, ReservedStr2
			, ReservedStr3
			, ReservedStr4
			, ReservedStr5
			, ReservedInt1
			, ReservedInt2
			
			, RealPayDate
			, RealPayAmount
			
			, AlterPayeeNo
			, AlterPayeeName
			, CreditAccount
			, DebitAccount
			
			, ProviderName
			, ProviderNo
			, Providee
			, BillType
			, EmpInsurance
			, AccidInsurance
			
			, Currency
			, ExchangeRate
			, LocalAmount
			
			, WorkingDay
			, ActualDay
		)
		VALUES
		(
			 #{ExpenceApplicationID}
			, #{ProofDate}
			, #{ProofCode}
			, #{CardUID}
			, #{CashUID}
			, #{TaxUID}
			, IF(#{ProofCode} ='Receipt', #{ReceiptID}, NULL)
			, #{PostingDate}
			, #{TaxType}
			, #{TaxCode}
			, #{PayAdjustMethod}
			, #{PayMethod}
			, #{PayType}
			, #{PayTarget}
			, #{IsWithholdingTax}
			, #{IncomeTax}
			, #{LocalTax}
			, #{PayDate}
			, #{VendorNo}
			, #{VendorName}
			, #{TotalAmount}
			, #{PersonalCardNo}
			, IF(CAST(#{RepAmount} AS VARCHAR(10)) = '', NULL, #{RepAmount})
			, IF(CAST(#{TaxAmount} AS VARCHAR(10)) = '', NULL, #{TaxAmount})
			
			, #{SessionUser}
			, now()
			
			, IF(CAST(#{ExpenceApplicationListID} AS VARCHAR(10)) = '', NULL, #{ExpenceApplicationListID})
			
			, #{AccountBank}
			, #{AccountInfo}
			, #{AccountHolder}
			
			, #{ReservedStr1}
			, #{ReservedStr2}
			, #{ReservedStr3}
			, #{ReservedStr4}
			, #{ReservedStr5}
			, IF(CAST(#{ReservedInt1} AS VARCHAR(10)) = '', NULL, #{ReservedInt1})
			, IF(CAST(#{ReservedInt2} AS VARCHAR(10)) = '', NULL, #{ReservedInt2})
			
			, #{RealPayDate}
			, #{RealPayAmount}
			
			, #{AlterPayeeNo}
			, #{AlterPayeeName}
			, #{CreditAccount}
			, #{DebitAccount}
			
			, #{ProviderName}
			, #{ProviderNo}
			, #{Providee}
			, #{BillType}
			, IF(CAST(#{EmpInsurance} AS VARCHAR(10)) = '', NULL, #{EmpInsurance})
			, IF(CAST(#{AccidInsurance} AS VARCHAR(10)) = '', NULL, #{AccidInsurance})
			
			, IF(CAST(#{Currency} AS VARCHAR(10)) = '', NULL, #{Currency})
			, IF(CAST(#{ExchangeRate} AS VARCHAR(10)) = '', NULL, #{ExchangeRate})
			, IF(CAST(#{LocalAmount} AS VARCHAR(10)) = '', NULL, #{LocalAmount})
			
			, IF(CAST(#{WorkingDay} AS VARCHAR(10)) = '', NULL, #{WorkingDay})
			, IF(CAST(#{ActualDay} AS VARCHAR(10)) = '', NULL, #{ActualDay}) 
		)
		ON DUPLICATE KEY UPDATE
			ProofDate = #{ProofDate}
			, ProofCode = #{ProofCode}
			, CardUID = #{CardUID}
			, CashUID = #{CashUID}
			, TaxUID = #{TaxUID}
			, ReceiptID = IF(#{ProofCode} ='Receipt', #{ReceiptID}, NULL)
			, PostingDate = #{PostingDate}
			, TaxType = #{TaxType}
			, TaxCode = #{TaxCode}
			, PayAdjustMethod = #{PayAdjustMethod}
			, PayMethod = #{PayMethod}
			, PayType = #{PayType}
			, PayTarget = #{PayTarget}
			, IsWithholdingTax = #{IsWithholdingTax}
			, IncomeTax = #{IncomeTax}
			, LocalTax = #{LocalTax}
			, PayDate = #{PayDate}
			, VendorNo = #{VendorNo}
			, VendorName = #{VendorName}
			, TotalAmount = #{TotalAmount}
			, PersonalCardNo = #{PersonalCardNo}
			, RepAmount = IF(CAST(#{RepAmount} AS VARCHAR(10)) = '', NULL, #{RepAmount})
			, TaxAmount = IF(CAST(#{TaxAmount} AS VARCHAR(10)) = '', NULL, #{TaxAmount})
			, ModifierID = #{SessionUser}
			, ModifyDate = NOW(3)
			, BankCode = #{AccountBank}
			, BankAccountNo = #{AccountInfo}
			, BankAccountName = #{AccountHolder}
			, ReservedStr1 = #{ReservedStr1}
			, ReservedStr2 = #{ReservedStr2}
			, ReservedStr3 = #{ReservedStr3}
			, ReservedStr4 = #{ReservedStr4}
			, ReservedStr5 = #{ReservedStr5}
			, ReservedInt1 = IF(CAST(#{ReservedInt1} AS VARCHAR(10)) = '', NULL, #{ReservedInt1})
			, ReservedInt2 = IF(CAST(#{ReservedInt2} AS VARCHAR(10)) = '', NULL, #{ReservedInt2})
			, RealPayDate = #{RealPayDate}
			, RealPayAmount = #{RealPayAmount}
			, AlterPayeeNo = #{AlterPayeeNo}
			, AlterPayeeName = #{AlterPayeeName}
			, CreditAccount = #{CreditAccount}
			, DebitAccount = #{DebitAccount}
			, ProviderName = #{ProviderName}
			, ProviderNo  = #{ProviderNo}
			, Providee = #{Providee}
			, BillType = #{BillType}
			, EmpInsurance = IF(CAST(#{EmpInsurance} AS VARCHAR(10)) = '', NULL, #{EmpInsurance})
			, AccidInsurance = IF(CAST(#{AccidInsurance} AS VARCHAR(10)) = '', NULL, #{AccidInsurance})
			, Currency = IF(CAST(#{Currency} AS VARCHAR(10)) = '', NULL, #{Currency})
			, ExchangeRate = IF(CAST(#{ExchangeRate} AS VARCHAR(10)) = '', NULL, #{ExchangeRate})
			, LocalAmount = IF(CAST(#{LocalAmount} AS VARCHAR(10)) = '', NULL, #{LocalAmount})
			, WorkingDay = IF(CAST(#{WorkingDay} AS VARCHAR(10)) = '', NULL, #{WorkingDay})
			, ActualDay = IF(CAST(#{ActualDay} AS VARCHAR(10)) = '', NULL, #{ActualDay}) 
		<selectKey keyProperty="InsertedExpenceApplicationListID" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>
    
    <insert id="updateCRInfo" parameterType="cmap">
 	    /*
 	    	expenceApplication.updateCRInfo
 	    	카드 부가세/공급가액 수정
 	    */
		INSERT INTO covi_account4j_si.act_card_receipt
		(
			TaxAmount
			, RepAmount
			<if test="ServiceAmount != null and ServiceAmount != ''">
			, ServiceAmount    
			</if>
			, ReceiptID
		)
		VALUES
		(
			 #{TaxAmount}
			, #{RepAmount}
			<if test="ServiceAmount != null and ServiceAmount != ''">
			, #{ServiceAmount}    
			</if>
			, #{CardUID}
		)
		ON DUPLICATE KEY UPDATE
			TaxAmount = #{TaxAmount}
			, RepAmount = #{RepAmount}
			<if test="ServiceAmount != null and ServiceAmount != ''">
			, ServiceAmount = #{ServiceAmount}    
			</if>
	</insert>
    
	<delete id="deleteExpAppList" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteExpAppList
 	    	증빙목록 삭제
 	    */
	    DELETE FROM covi_account4j_si.act_expence_application_list
	    WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </delete>
    
	<!-- 임시함 JWF_PrivateDomainData 삭제 -->
	<delete id="deletePrivateDomainData" parameterType="cmap">
		DELETE FROM COVI_APPROVAL4J.JWF_PrivateDomainData
		WHERE OWNERID = #{OwnerID}
	</delete>
	
	
	
	
    <insert id="insertCorpCardIFData" parameterType="cmap">
 	    /*
 	    	expenceApplication.insertCorpCardIFData
 	    	인터페이스 데이터 삽입
 	    */
		
		INSERT INTO covi_account4j_si.act_card_receipt (
			ReceiptID
			, ApproveStatus
			, DataIndex
			, SendDate
			, ItemNo
			, CardNo
			, InfoIndex
			, InfoType
			, CardCompIndex
			, CardRegType
			, CardType
			, BizPlaceNo
			, Dept
			, CardUserCode
			, UseDate
			, ApproveDate
			, ApproveTime
			, ApproveNo
			, WithdrawDate
			, CountryIndex
			, AmountSign
			, AmountWon
			, ForeignCurrency
			, AmountForeign
			, StoreRegNo
			, StoreName
			, StoreNo
			, StoreRepresentative
			, StoreCondition
			, StoreCategory
			, StoreZipCode
			, StoreAddress1
			, StoreAddress2
			, StoreTel
			, RepAmount
			, TaxAmount
			, ServiceAmount
			, Active
			, IntDate
			, CollNo
			, TaxType
			, TaxTypeDate
			, MerchCessDate
			, Class
			, TossUserCode
			, TossSenderUserCode
			, TossDate
			, TossComment
			, IsPersonalUse
		)VALUES (
			#{ReceiptID}
			, #{ApproveStatus}
			, #{DataIndex}
			, #{SendDate}
			, #{ItemNo}
			, #{CardNo}
			, #{InfoIndex}
			, #{InfoType}
			, #{CardCompIndex}
			, #{CardRegType}
			, #{CardType}
			, #{BizPlaceNo}
			, #{Dept}
			, #{CardUserCode}
			, #{UseDate}
			, #{ApproveDate}
			, #{ApproveTime}
			, #{ApproveNo}
			, #{WithdrawDate}
			, #{CountryIndex}
			, #{AmountSign}
			, #{AmountWon}
			, #{ForeignCurrency}
			, #{AmountForeign}
			, #{StoreRegNo}
			, #{StoreName}
			, #{StoreNo}
			, #{StoreRepresentative}
			, #{StoreCondition}
			, #{StoreCategory}
			, #{StoreZipCode}
			, #{StoreAddress1}
			, #{StoreAddress2}
			, #{StoreTel}
			, #{RepAmount}
			, #{TaxAmount}
			, #{ServiceAmount}
			, #{Active}
			, #{IntDate}
			, #{CollNo}
			, #{TaxType}
			, #{TaxTypeDate}
			, #{MerchCessDate}
			, #{Class}
			, #{TossUserCode}
			, #{TossSenderUserCode}
			, #{TossDate}
			, #{TossComment}
			, #{IsPersonalUse}
		)
	</insert>
	
    <insert id="insertTaxBillIFData" parameterType="cmap">
 	    /*
 	    	expenceApplication.insertTaxBillIFData
 	    	통합비용신청 세부비용
 	    */
		INSERT INTO covi_account4j_si.act_taxinvoice (
				CompanyCode
			,	DataIndex
			,	WriteDate
			,	IssueDT
			,	InvoiceType
			,	TaxType
			,	TaxTotal
			,	SupplyCostTotal
			,	TotalAmount
			,	PurposeType
			,	SerialNum
			,	Cash
			,	ChkBill
			,	Credit
			,	Note
			,	Remark1
			,	Remark2
			,	Remark3
			,	NTSConfirmNum
			,	ModifyCode
			,	OrgNTSConfirmNum
			,	InvoicerCorpNum
			,	InvoicerMgtKey
			,	InvoicerTaxRegID
			,	InvoicerCorpName
			,	InvoicerCEOName
			,	InvoicerAddr
			,	InvoicerBizType
			,	InvoicerBizClass
			,	InvoicerContactName
			,	InvoicerDeptName
			,	InvoicerTel
			,	InvoicerEmail
			,	InvoiceeCorpNum
			,	InvoiceeType
			,	InvoiceeMgtKey
			,	InvoiceeTaxRegID
			,	InvoiceeCorpName
			,	InvoiceeCEOName
			,	InvoiceeAddr
			,	InvoiceeBizType
			,	InvoiceeBizClass
			,	InvoiceeContactName1
			,	InvoiceeDeptName1
			,	InvoiceeTel1
			,	InvoiceeEmail1
			,	InvoiceeContactName2
			,	InvoiceDeptName2
			,	InvoiceTel2
			,	InvoiceEmail2
			,	TrusteeCorpNum
			,	TrusteeMgtKey
			,	TrusteeTaxRegID
			,	TrusteeCorpName
			,	TrusteeCEOName
			,	TrusteeAddr
			,	TrusteeBizType
			,	TrusteeBizClass
			,	TrusteeContactName
			,	TrusteeDeptName
			,	TrusteeTel
			,	TrusteeEmail
			,	TossUserCode
			,	TossSenderUserCode
			,	TossDate
			,	TossComment
			,	RegistDate
			,	IntDate
			,	IsOffset
			,	CONVERSATION_ID
			,	SUPBUY_TYPE
			,	DIRECTION
		) VALUES (
				#{CompanyCode}
			,	#{DataIndex}
			,	#{WriteDate}
			,	#{IssueDT}
			,	#{InvoiceType}
			,	#{TaxType}
			,	#{TaxTotal}
			,	#{SupplyCostTotal}
			,	#{TotalAmount}
			,	#{PurposeType}
			,	#{SerialNum}
			,	#{Cash}
			,	#{ChkBill}
			,	#{Credit}
			,	#{Note}
			,	#{Remark1}
			,	#{Remark2}
			,	#{Remark3}
			,	#{NTSConfirmNum}
			,	#{ModifyCode}
			,	#{OrgNTSConfirmNum}
			,	#{InvoicerCorpNum}
			,	#{InvoicerMgtKey}
			,	#{InvoicerTaxRegID}
			,	#{InvoicerCorpName}
			,	#{InvoicerCEOName}
			,	#{InvoicerAddr}
			,	#{InvoicerBizType}
			,	#{InvoicerBizClass}
			,	#{InvoicerContactName}
			,	#{InvoicerDeptName}
			,	#{InvoicerTel}
			,	#{InvoicerEmail}
			,	#{InvoiceeCorpNum}
			,	#{InvoiceeType}
			,	#{InvoiceeMgtKey}
			,	#{InvoiceeTaxRegID}
			,	#{InvoiceeCorpName}
			,	#{InvoiceeCEOName}
			,	#{InvoiceeAddr}
			,	#{InvoiceeBizType}
			,	#{InvoiceeBizClass}
			,	#{InvoiceeContactName1}
			,	#{InvoiceeDeptName1}
			,	#{InvoiceeTel1}
			,	#{InvoiceeEmail1}
			,	#{InvoiceeContactName2}
			,	#{InvoiceDeptName2}
			,	#{InvoiceTel2}
			,	#{InvoiceEmail2}
			,	#{TrusteeCorpNum}
			,	#{TrusteeMgtKey}
			,	#{TrusteeTaxRegID}
			,	#{TrusteeCorpName}
			,	#{TrusteeCEOName}
			,	#{TrusteeAddr}
			,	#{TrusteeBizType}
			,	#{TrusteeBizClass}
			,	#{TrusteeContactName}
			,	#{TrusteeDeptName}
			,	#{TrusteeTel}
			,	#{TrusteeEmail}
			,	#{TossUserCode}
			,	#{TossSenderUserCode}
			,	#{TossDate}
			,	#{TossComment}
			,	now()
			,	now()
			,	#{IsOffset}
			,	#{CONVERSATION_ID}
			,	#{SUPBUY_TYPE}
			,	#{DIRECTION}
		) 
		<selectKey keyProperty="TaxInvoiceID" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>
	
    <insert id="insertTaxBillItemIFData" parameterType="cmap">
 	    /*
 	    	expenceApplication.insertTaxBillItemIFData
 	    	통합비용신청 세부비용 item
 	    */
 	    INSERT INTO covi_account4j_si.act_taxinvoice_item
 	    (
		TaxInvoiceID
		, PurchaseDT
		, ItemName
		, Spec
		, Qty
		, UnitCost
		, SupplyCost
		, Tax
		, Remark
		, RegistDate
 	    )
 	    VALUES
 	    (
		#{TaxInvoiceID}
		, #{PurchaseDT}
		, #{ItemName}
		, #{Spec}
		, #{Qty}
		, #{UnitCost}
		, #{SupplyCost}
		, #{Tax}
		, #{Remark}
		, NOW()
 	    )
	</insert>
	
    
    
    
	<delete id="deleteIFCorpCardReceiptFromExpAppList" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteCorpCardReceiptFromExpAppList
 	    	증빙 삭제시 법인카드 사용내역 삭제
 	    	사용내역을 DB에서 조회 한게 아니라 증빙을 생성시 입력하는 구조일시 사용
 	    */
 	    DELETE FROM covi_account4j_si.act_card_receipt
		WHERE ReceiptID = #{CardUID}
    </delete>
	<delete id="deleteIFTaxBillFromExpAppList" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteTaxBillFromExpAppList
 	    	증빙 삭제시 세금계산서 삭제
 	    	세금계산서를 DB에서 조회 한게 아니라 증빙을 생성시 입력하는 구조일시 사용
 	    */
 	    DELETE FROM covi_account4j_si.act_taxinvoice
		WHERE TaxInvoiceID = #{TaxUID}
    </delete>
	
	
	<select id="deleteExpAppCntList" resultType="java.lang.Long">
 	    /*
 	    	expenceApplication.deleteExpAppCntList
 	    	증빙전표 삭제용 리스트 카운트 체크
 	    */
		SELECT COUNT(*) 
		FROM covi_account4j_si.act_expence_application EA
		INNER JOIN covi_account4j_si.act_expence_application_list EAL
		ON EA.ExpenceApplicationID = EAL.ExpenceApplicationID
		WHERE EA.ExpenceApplicationID = #{ExpenceApplicationID}
    </select>
    
	<delete id="deleteExpApp" parameterType="cmap">
 	    /*
 	    	expenceApplication."deleteExpApp"
 	    	증빙 전표 삭제
 	    */
	    DELETE FROM covi_account4j_si.act_expence_application
	    WHERE ExpenceApplicationID = #{ExpenceApplicationID}
    </delete>
    
    
    <insert id="insertExpAppListDiv" parameterType="cmap">
 	    /*
 	    	expenceApplication.insertExpAppListDiv
 	    	통합비용신청 세부비용
 	    */
		INSERT INTO covi_account4j_si.act_expence_application_div
		(
			ExpenceApplicationListID
			, AccountCode
			, AccountName
			, CostCenterCode
			, CostCenterName
			, IOCode
			, IOName
			, Amount
			, UsageComment
			, StandardBriefID
			, StandardBriefName			
			, RegisterID
			, RegistDate
			, ReservedStr1
			, ReservedStr2
			, ReservedStr3
			, ReservedStr4
			, ReservedStr5
			, ReservedInt1
			, ReservedInt2
		)
		VALUES
		(
			#{ExpenceApplicationListID}
			, #{AccountCode}
			, #{AccountName}
			, #{CostCenterCode}
			, #{CostCenterName}
			, #{IOCode}
			, #{IOName}
			, #{Amount}
			, #{UsageComment}
			, #{StandardBriefID}
			, #{StandardBriefName}			
			, #{SessionUser}
			, now()
			, #{ReservedStr1_Div}
			, #{ReservedStr2_Div}
			, #{ReservedStr3_Div}
			, #{ReservedStr4_Div}
			, #{ReservedStr5_Div}
			, IF(CAST(#{ReservedInt1_Div} AS VARCHAR(10)) = '', NULL, #{ReservedInt1_Div}) 
			, IF(CAST(#{ReservedInt2_Div} AS VARCHAR(10)) = '', NULL, #{ReservedInt2_Div})
		)
	</insert>
	<delete id="deleteExpAppDiv" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteExpAppDiv
 	    	세부증빙 삭제
 	    */
	    DELETE FROM covi_account4j_si.act_expence_application_div
	    WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </delete>
    
    <insert id="insertExpAppFile" parameterType="cmap">
 	    /*
 	    	expenceApplication.insertExpAppFile
 	    	통합비용신청
 	    */
		INSERT INTO covi_account4j_si.act_expence_application_file
		(
			FileID
			, ExpenceApplicationListID
			, RegisterID
			, RegistDate

		)
		VALUES
		(
			#{FileID}
			, #{ExpenceApplicationListID}

			, #{SessionUser}
			, now()
		)
		
	</insert>
	
    
	
    <select id="selectExpAppListForDelete" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.selectExpAppListForDelete
 	    	app삭제를 위해 하위 list 조회
 	    */
	    SELECT ExpenceApplicationListID 
	    , ExpenceApplicationID
	    , ProofCode
	    , CardUID
	    , CashUID
	    , TaxUID
	    FROM covi_account4j_si.act_expence_application_list
	    WHERE ExpenceApplicationID = #{ExpenceApplicationID}
    </select>
    <select id="selectExpAppFileForDelete" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.selectExpAppFileForDelete
 	    	파일매핑 삭제를 위한 조회
 	    */
	    SELECT FileID FROM covi_account4j_si.act_expence_application_file
	    WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </select>
	<delete id="deleteFileDbByID" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteFileDbByID
 	    	파일db삭제
 	    */
		<![CDATA[
			DELETE FROM covi_smart4j.sys_file
			WHERE FileID = #{FileID}
		]]>
	</delete>
	<delete id="deleteExpAppFile" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteExpAppFile
 	    	파일매핑 삭제
 	    */
	    DELETE FROM covi_account4j_si.act_expence_application_file
	    WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </delete>
	<delete id="deleteExpAppFileOne" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteExpAppFileOne
 	    	파일매핑 1건 삭제
 	    */
	    DELETE FROM covi_account4j_si.act_expence_application_file
	    WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
	    AND FileID = #{FileID}
    </delete>
    
    
    <insert id="insertExpAppDoc" parameterType="cmap">
 	    /*
 	    	expenceApplication.insertExpAppDoc
 	    	통합비용신청
 	    */
		INSERT INTO covi_account4j_si.act_expence_application_ref
		(
			ProcessID
			, ExpenceApplicationListID
			, bstored
			, BusinessData1
			, BusinessData2
			, RegisterID
			, RegistDate

		)
		VALUES
		(
			#{ProcessID}
			, #{ExpenceApplicationListID}
			, #{bstored}
			, #{BusinessData1}
			, #{BusinessData2}
			, #{SessionUser}
			, now()
		)
	</insert>
	
	<delete id="deleteExpAppDoc" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteExpAppDoc
 	    	문서 매핑 삭제
 	    */
	    DELETE FROM covi_account4j_si.act_expence_application_ref
	    WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </delete>
    
	<select id="getCashBillInfo" parameterType="cmap" resultType="cmap">
	    /*
		    expenceApplication.getCashBillInfo
	    */
	    
	    SELECT CashBillID
				, CashBillID CashUID
				, NTSConfirmNum AS CashNTSConfirmNum
				, TradeDT
				, DATE_FORMAT( TradeDT, '%Y%m%d') AS ProofDate
				, DATE_FORMAT( TradeDT, '%Y.%m.%d') AS ProofDateStr
				, TradeType
				, SupplyCost
				, Tax
				, ServiceFree
				, TotalAmount
				, FranchiseCorpNum
				, FranchiseCorpName
				, CashBillID
				, VD.VendorNo
				, IFNULL(VD.VendorName, CB.FranchiseCorpName) AS VendorName
		FROM covi_account4j_si.act_cashbill CB
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON CB.FranchiseCorpNum = VD.VendorNo
		WHERE 
			<choose>
				<when test="cashBillIDList != null">
					<foreach collection="cashBillIDList" item="item" index="index" separator="," open="CashBillID IN (" close=")">
						#{item}
					</foreach>
				</when>
				<otherwise>
					1=2
				</otherwise>
			</choose>

    </select>
    
    <select id="getApplicationListCopy" parameterType="cmap" resultType="cmap">
    	/*
    		expenceApplication.getApplicationListCopy
    		전표복사용 데이터 가져오기
    	*/
    	SELECT AEAL.*, AEAD.*
    	FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		WHERE AEAL.ExpenceApplicationListID = #{ListID}
    </select>
    
	<select id="getTaxBillInfo" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.getTaxBillInfo
 	    	세금계산서 정보
 	    */
		SELECT	ATI.TaxInvoiceID
	    	,	ATI.TaxInvoiceID TaxUID
	    	,	ATI.NTSConfirmNum TaxNTSConfirmNum
	    	,	ATI.CONVERSATION_ID
			,	ATI.WriteDate
			,	ATI.InvoicerCorpNum
			,	ATI.InvoicerCorpName
			,	ATI.InvoicerCEOName
			,	ATI.InvoicerAddr
			,	ATI.InvoicerBizType
			,	ATI.InvoicerBizClass
			,	ATI.InvoiceeCorpNum
			,	ATI.InvoiceeCorpName
			,	ATI.InvoiceeCEOName
			,	ATI.InvoiceeAddr
			,	ATI.InvoiceeBizType
			,	ATI.InvoiceeBizClass
			,	ATI.TotalAmount
			,	ATI.TaxTotal Tax
			,	ATI.SupplyCostTotal SupplyCost
			,	ATI.Remark1 Remark
			,	ATI.PurposeType
			,	DATE_FORMAT(ATI.WriteDate,'%Y.%m.%d')	AS FormatWriteDate
			,	FORMAT(ATI.TotalAmount,0)				AS FormatTotalAmount
			,	FORMAT(ATI.TaxTotal,0)					AS FormatTaxTotal
			,	FORMAT(ATI.SupplyCostTotal,0)			AS FormatSupplyCostTotal
			,	VD.VendorID
			,	IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
			,	IFNULL(VD.VendorNo, ATI.InvoicerCorpNum) AS VendorNo
			,	IFNULL(VD.BusinessNumber, ATI.InvoicerCorpNum) AS BusinessNumber
			,	VD.PaymentMethod AS PayMethod
			,	VD.PaymentCondition AS PayType
			, ( SELECT GROUP_CONCAT(VDB.BankCode SEPARATOR ',') FROM covi_account4j_si.act_vendor_bank VDB WHERE VD.VendorID = VDB.VendorID ) AS BankCode
			, ( SELECT GROUP_CONCAT(VDB.BankAccountNo SEPARATOR ',') FROM covi_account4j_si.act_vendor_bank VDB WHERE VD.VendorID = VDB.VendorID ) AS BankAccountNo
			, ( SELECT GROUP_CONCAT(VDB.BankAccountNo SEPARATOR ',') FROM covi_account4j_si.act_vendor_bank VDB WHERE VD.VendorID = VDB.VendorID ) AS BankAccountInfo
			, ( SELECT GROUP_CONCAT(VDB.BankAccountName SEPARATOR ',') FROM covi_account4j_si.act_vendor_bank VDB WHERE VD.VendorID = VDB.VendorID ) AS BankAccountName
		    , ( SELECT ATII.ItemName FROM covi_account4j_si.act_taxinvoice_item ATII WHERE ATI.TaxInvoiceID = ATII.TaxInvoiceID LIMIT 1) AS ItemName
		    , ( SELECT COUNT(*) FROM covi_account4j_si.act_vendor SBV WHERE SBV.BusinessNumber = ATI.InvoicerCorpNum) AS BusinessNumberCnt
		FROM	covi_account4j_si.act_taxinvoice ATI
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD ON REPLACE(ATI.InvoicerCorpNum, '-', '') = REPLACE(VD.BusinessNumber, '-', '')
		WHERE	1=1
		AND		ATI.TaxInvoiceID =  #{taxBillID}
		LIMIT 1
	</select>

	<select id="getVdCheck" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.getVdCheck
 	    	업체 존재유무 체크
 	    */
		SELECT	
			
			VD.VendorID
			, VD.VendorName
			, VD.VendorNo
			, VD.CEOName
			, VD.Address
			, VD.Industry
			, VD.Sector
			, ( SELECT GROUP_CONCAT(VDB.BankCode SEPARATOR ',') FROM covi_account4j_si.act_vendor_bank VDB WHERE VD.VendorID = VDB.VendorID ) AS BankCode
			, ( SELECT GROUP_CONCAT(VDB.BankName SEPARATOR ',') FROM covi_account4j_si.act_vendor_bank VDB WHERE VD.VendorID = VDB.VendorID ) AS BankName
			, ( SELECT GROUP_CONCAT(VDB.BankAccountNo SEPARATOR ',') FROM covi_account4j_si.act_vendor_bank VDB WHERE VD.VendorID = VDB.VendorID ) AS BankAccountNo
			, ( SELECT GROUP_CONCAT(VDB.BankAccountNo SEPARATOR ',') FROM covi_account4j_si.act_vendor_bank VDB WHERE VD.VendorID = VDB.VendorID ) AS BankAccountInfo
			, ( SELECT GROUP_CONCAT(VDB.BankAccountName SEPARATOR ',') FROM covi_account4j_si.act_vendor_bank VDB WHERE VD.VendorID = VDB.VendorID ) AS BankAccountName
			, VD.PaymentCondition as PayType
			, VD.PaymentMethod as PayMethod
		FROM covi_account4j_si.act_vendor VD
		WHERE	1=1
		AND		REPLACE(VD.BusinessNumber, '-', '') = #{VendorNo}
	</select>
	
	
	
	<select id="selectExpenceApplicationApp" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationApp
		*/
		SELECT A.ExpenceApplicationID 
				, A.CompanyCode
				, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, #{CompanyCode}) CompanyName
				, A.ApplicationTitle
				, A.ApplicationType
				, covi_account4j_si.Fn_GetBaseCodeName('ExpAppType', A.ApplicationType, #{CompanyCode}) ApplicationTypeName
				, A.ApplicationStatus
				, covi_account4j_si.Fn_GetBaseCodeName('ExpenceApplicationStatus', A.ApplicationStatus, #{CompanyCode}) ApplicationStatusName
				, A.ApplicationDate
				, A.RequestType
				, A.RequestTypeName
				, A.ProcessID
				, A.RegisterID
				, A.RegisterName
				, A.RegistDate
				, A.ChargeJob
				, A.TotalAmountSum
				, A.TotalAmountSumNum
				, A.AmountSum
				, A.AmountSumNum
				, A.DocNo
				, A.unDocNo
		FROM
		(
			SELECT  A.ExpenceApplicationID 
					, A.CompanyCode
					, A.ApplicationTitle
					, A.ApplicationType
					, A.ApplicationStatus
					, A.ApplicationDate
					, A.RequestType
					, A.RequestTypeName
					, A.ProcessID
					, A.RegisterID
					, A.RegisterName
					, A.RegistDate
					, A.ChargeJob
					, FORMAT(SUM(A.TotalAmount),2)				AS TotalAmountSum
					, SUM(A.TotalAmount)		AS TotalAmountSumNum
					, FORMAT(SUM(A.Amount),2)				AS AmountSum
					, SUM(A.Amount)		AS AmountSumNum
					, A.DocNo
					, A.unDocNo
			FROM
			(
				SELECT AEA.ExpenceApplicationID 
					, AEA.CompanyCode
					, AEA.ApplicationTitle
					, AEA.ApplicationType
					, AEA.ApplicationStatus
					, AEA.RegisterID
					, USR.DisplayName RegisterName
					, AEA.ProcessID
					
					, DATE_FORMAT( IFNULL(AEA.ApplicationDate, AEA.RegistDate), '%Y.%m.%d') AS ApplicationDate
					, AEA.RequestType
					, AEF.FormName AS RequestTypeName
					, AEA.RegistDate
					, AEA.ChargeJob
					
					, AEAL.ExpenceApplicationListID
					, AEAL.ExpenceApplicationListID cdRownum
					, DATE_FORMAT( AEAL.ProofDate, '%Y.%m.%d') AS ProofDate
					, DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d') AS PostingDate
					, AEAL.ProofCode
					
					, AEAL.CardUID
					, AEAL.CashUID
					, AEAL.TaxUID
					, AEAL.TaxType
					, AEAL.TaxCode
					, AEAL.PayAdjustMethod
					, AEAL.PayMethod
					, AEAL.IsWithholdingTax
					, AEAL.IncomeTax
					, AEAL.LocalTax
					, AEAL.PayDate
					, AEAL.VendorNo
					, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
					, AEAL.TotalAmount					
					, (
						SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
							ELSE SUM(AEAD.Amount) 
						END
						FROM covi_account4j_si.act_expence_application_div AEAD
						WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					  ) AS Amount					
					, (SELECT L.DocNo FROM covi_account4j_si.act_expence_application_list L WHERE L.ExpenceApplicationID = AEA.ExpenceApplicationID LIMIT 1) AS DocNo
					, (SELECT L.unDocNo FROM covi_account4j_si.act_expence_application_list L WHERE L.ExpenceApplicationID = AEA.ExpenceApplicationID LIMIT 1) AS unDocNo
				FROM covi_account4j_si.act_expence_application AEA
				INNER JOIN covi_account4j_si.act_expence_application_list AEAL
				ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
				LEFT OUTER JOIN covi_account4j_si.act_vendor VD
				ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
				LEFT OUTER JOIN covi_smart4j.sys_object_user USR
				ON AEA.RegisterID = USR.UserCode
				LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
				ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
				LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
				ON AEAL.CardUID = CR.ReceiptID
				LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
				ON AEAL.TaxUID = ATI.TaxInvoiceID
				LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
				ON AEAL.CashUID = ACB.CashBillID
				WHERE 1=1
				AND AEA.ApplicationStatus != 'DELETE'
			
			  	<if test="DocNo != null and DocNo != ''">
			  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%') 
				</if>
				
			  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
				 	AND AEA.ApplicationStatus = #{ApplicationStatus}
				</if>
			  	
			  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
				 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
				</if>
			  	
			  	<if test="ChargeJob != null and ChargeJob != ''">
				 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%') 
				</if>
				
				<if test="RequestType != null and RequestType != ''">
				 	AND AEA.RequestType = #{RequestType}
				</if>
			  	
			  	<if test="ProofCode != null and ProofCode != ''">
				 	AND AEAL.ProofCode = #{ProofCode}
				</if>
			  	
			  	<if test="CompanyCode != null and CompanyCode != ''">
				 	AND AEA.CompanyCode = #{CompanyCode}
				</if>
				
			  	<if test="ProofDateSt != null and ProofDateSt != ''">
					<![CDATA[
					 	AND AEAL.ProofDate >= #{ProofDateSt}
					]]>
				</if>
			  	<if test="ProofDateEd != null and ProofDateEd != ''">
					<![CDATA[
					 	AND AEAL.ProofDate <= #{ProofDateEd}
					]]>
				</if>
			  	
			  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
					<![CDATA[
					 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
					]]>
				</if>
			  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
					<![CDATA[
					 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
					]]>
				</if>
			  	
			  	
			  	<if test="RegisterNm != null and RegisterNm != ''">
				 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
				</if>
			  	
			  	<if test="VendorName != null and VendorName != ''">
				 	AND (
				 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%')) 
				 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
				 	)
				</if>
			  	
				<choose>
					<when test="SessionUser != null and SessionUser != ''">
				 		AND AEA.RegisterID = #{SessionUser}
					</when>
					<otherwise>
					    AND AEA.ApplicationStatus NOT IN ('T')
					</otherwise>
				</choose>
				) A
				GROUP BY  A.ExpenceApplicationID 
			)A
			WHERE 1=1
		  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
		  	    <![CDATA[
			 	AND A.TotalAmountSumNum >= #{SearchAmtSt}
				]]>
			</if>
		  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
		  		<![CDATA[
			 	AND A.TotalAmountSumNum <= #{SearchAmtEd}
				]]>
			</if>
			<trim prefix="ORDER BY"  prefixOverrides =",">
				<if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
						, A.RegistDate DESC
						, A.ApplicationTitle
						, A.ExpenceApplicationID 
			    </if>
			  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
		 			<choose>
						<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
						<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
						<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
						<when test='sortColumn.equalsIgnoreCase("ApplicationStatusName")'>ApplicationStatusName</when>
						<when test='sortColumn.equalsIgnoreCase("RequestTypeName")'>RequestTypeName</when>
						<when test='sortColumn.equalsIgnoreCase("TotalAmountSum")'>TotalAmountSum</when>
						<when test='sortColumn.equalsIgnoreCase("AmountSum")'>AmountSum</when>
						<otherwise>ApplicationDate</otherwise>
					</choose>
					<choose>
						<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
						<otherwise> DESC</otherwise>
					</choose>
				</if>
			</trim>			
			<if test="pageSize != null and pageOffset != null">
				LIMIT #{pageSize} OFFSET #{pageOffset}
			</if>
	</select>
	
	<select id="selectExpenceApplicationAppExcel" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationAppExcel
		*/
		SELECT A.ExpenceApplicationID 
				, A.CompanyCode
				, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, null) CompanyName
				, A.ApplicationTitle
				, A.ApplicationType
				, covi_account4j_si.Fn_GetBaseCodeName('ExpAppType', A.ApplicationType, null) ApplicationTypeName
				, A.ApplicationStatus
				, covi_account4j_si.Fn_GetBaseCodeName('ExpenceApplicationStatus', A.ApplicationStatus, null) ApplicationStatusName
				, A.ApplicationDate
				, A.RequestType
				, A.RequestTypeName
				, A.ProcessID
				, A.RegisterID
				, A.RegisterName
				, A.RegistDate
				, A.ChargeJob
				, A.TotalAmountSum
				, A.TotalAmountSumNum
				, A.AmountSum
				, A.AmountSumNum
				, A.DocNo
				, A.unDocNo
		FROM
		(
			SELECT  A.ExpenceApplicationID 
					, A.CompanyCode
					, A.ApplicationTitle
					, A.ApplicationType
					, A.ApplicationStatus
					, A.ApplicationDate
					, A.RequestType
					, A.RequestTypeName
					, A.ProcessID
					, A.RegisterID
					, A.RegisterName
					, A.RegistDate
					, A.ChargeJob
					, FORMAT(SUM(A.TotalAmount), 2)				AS TotalAmountSum
					, SUM(A.TotalAmount)		AS TotalAmountSumNum
					, FORMAT(SUM(A.Amount), 2)				AS AmountSum
					, SUM(A.Amount)		AS AmountSumNum
					, A.DocNo
					, A.unDocNo
			FROM
			(
				SELECT AEA.ExpenceApplicationID 
					, AEA.CompanyCode
					, AEA.ApplicationTitle
					, AEA.ApplicationType
					, AEA.ApplicationStatus
					, AEA.RegisterID
					, USR.DisplayName RegisterName
					, AEA.ProcessID
					
					, DATE_FORMAT( IFNULL(AEA.ApplicationDate, AEA.RegistDate), '%Y.%m.%d') AS ApplicationDate
					, AEA.RequestType
					, AEF.FormName AS RequestTypeName
					, AEA.RegistDate
					, AEA.ChargeJob
					
					, AEAL.ExpenceApplicationListID
					, AEAL.ExpenceApplicationListID cdRownum
					, DATE_FORMAT( AEAL.ProofDate, '%Y.%m.%d') AS ProofDate
					, DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d') AS PostingDate
					, AEAL.ProofCode
					
					, AEAL.CardUID
					, AEAL.CashUID
					, AEAL.TaxUID
					, AEAL.TaxType
					, AEAL.TaxCode
					, AEAL.PayAdjustMethod
					, AEAL.PayMethod
					, AEAL.IsWithholdingTax
					, AEAL.IncomeTax
					, AEAL.LocalTax
					, AEAL.PayDate
					, AEAL.VendorNo
					, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
					, AEAL.TotalAmount						
					, (
						SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
							ELSE SUM(AEAD.Amount) 
						END
						FROM covi_account4j_si.act_expence_application_div AEAD
						WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					  ) AS Amount				
					, (SELECT L.DocNo FROM covi_account4j_si.act_expence_application_list L WHERE L.ExpenceApplicationID = AEA.ExpenceApplicationID LIMIT 1) AS DocNo
					, (SELECT L.unDocNo FROM covi_account4j_si.act_expence_application_list L WHERE L.ExpenceApplicationID = AEA.ExpenceApplicationID LIMIT 1) AS unDocNo
				FROM covi_account4j_si.act_expence_application AEA
				INNER JOIN covi_account4j_si.act_expence_application_list AEAL
				ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
				LEFT OUTER JOIN covi_account4j_si.act_vendor VD
				ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
				LEFT OUTER JOIN covi_smart4j.sys_object_user USR
				ON AEA.RegisterID = USR.UserCode
				LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
				ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
				LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
				ON AEAL.CardUID = CR.ReceiptID
				LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
				ON AEAL.TaxUID = ATI.TaxInvoiceID
				LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
				ON AEAL.CashUID = ACB.CashBillID
				WHERE 1=1
				AND AEA.ApplicationStatus != 'DELETE'
			
			  	<if test="DocNo != null and DocNo != ''">
			  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%')
				</if>
				
			  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
				 	AND AEA.ApplicationStatus = #{ApplicationStatus}
				</if>
			  	
			  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
				 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
				</if>
			  	
			  	<if test="ChargeJob != null and ChargeJob != ''">
				 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
				</if>
				
				<if test="RequestType != null and RequestType != ''">
				 	AND AEA.RequestType = #{RequestType}
				</if>
			  	
			  	<if test="ProofCode != null and ProofCode != ''">
				 	AND AEAL.ProofCode = #{ProofCode}
				</if>
			  	
			  	<if test="CompanyCode != null and CompanyCode != ''">
				 	AND AEA.CompanyCode = #{CompanyCode}
				</if>
				
			  	<if test="ProofDateSt != null and ProofDateSt != ''">
					<![CDATA[
					 	AND AEAL.ProofDate >= #{ProofDateSt}
					]]>
				</if>
			  	<if test="ProofDateEd != null and ProofDateEd != ''">
					<![CDATA[
					 	AND AEAL.ProofDate <= #{ProofDateEd}
					]]>
				</if>
			  	
			  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
					<![CDATA[
					 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
					]]>
				</if>
			  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
					<![CDATA[
					 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
					]]>
				</if>
			  	
			  	
			  	<if test="RegisterNm != null and RegisterNm != ''">
				 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
				</if>
			  	
			  	<if test="VendorName != null and VendorName != ''">
				 	AND (
				 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
				 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
				 	)
				</if>
				<choose>
					<when test="SessionUser != null and SessionUser != ''">
				 		AND AEA.RegisterID = #{SessionUser}
					</when>
					<otherwise>
					    AND AEA.ApplicationStatus NOT IN ('T')
					</otherwise>
				</choose>
				) A 
				GROUP BY  A.ExpenceApplicationID 
			) A
			WHERE 1=1
		  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
		  	    <![CDATA[
			 	AND A.TotalAmountSumNum >= #{SearchAmtSt}
				]]>
			</if>
		  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
		  		<![CDATA[
			 	AND A.TotalAmountSumNum <= #{SearchAmtEd}
				]]>
			</if>
			<trim prefix="ORDER BY"  prefixOverrides =",">
				<if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
						, A.RegistDate DESC
						, A.ApplicationTitle
						, A.ExpenceApplicationID 
			    </if>
			  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
		 			<choose>
						<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
						<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
						<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
						<when test='sortColumn.equalsIgnoreCase("ApplicationStatusName")'>ApplicationStatusName</when>
						<when test='sortColumn.equalsIgnoreCase("RequestTypeName")'>RequestTypeName</when>
						<when test='sortColumn.equalsIgnoreCase("TotalAmountSum")'>TotalAmountSum</when>
						<when test='sortColumn.equalsIgnoreCase("AmountSum")'>AmountSum</when>
						<otherwise>ApplicationDate</otherwise>
					</choose>
					<choose>
						<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
						<otherwise> DESC</otherwise>
					</choose>
				</if>
			</trim>	
	</select>
	<select id="selectExpenceApplicationAppCnt" resultType="java.lang.Long">
		/*
			expenceApplication.selectExpenceApplicationDetailAppCnt
		*/
		SELECT COUNT(*)
		FROM
		(
			SELECT  A.ExpenceApplicationID 
					, SUM(A.TotalAmount)	AS TotalAmountSumNum
					, SUM(A.Amount)			AS AmountSumNum
			FROM
			(
				SELECT AEA.ExpenceApplicationID 
					, AEA.CompanyCode
					, AEA.ApplicationTitle
					, AEA.ApplicationType
					, AEA.ApplicationStatus
					, AEA.RegisterID
					, USR.DisplayName RegisterName
					, AEA.ProcessID
					
					, DATE_FORMAT( IFNULL(AEA.ApplicationDate, AEA.RegistDate), '%Y.%m.%d') AS ApplicationDate
					, AEA.RequestType
					, AEF.FormName AS RequestTypeName
					, AEA.RegistDate
					, AEA.ChargeJob
					
					, AEAL.ExpenceApplicationListID
					, AEAL.ExpenceApplicationListID cdRownum
					, DATE_FORMAT( AEAL.ProofDate, '%Y.%m.%d') AS ProofDate
					, DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d') AS PostingDate
					, AEAL.ProofCode
					
					, AEAL.CardUID
					, AEAL.CashUID
					, AEAL.TaxUID
					, AEAL.TaxType
					, AEAL.TaxCode
					, AEAL.PayAdjustMethod
					, AEAL.PayMethod
					, AEAL.IsWithholdingTax
					, AEAL.IncomeTax
					, AEAL.LocalTax
					, AEAL.PayDate
					, AEAL.VendorNo
					, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
					, AEAL.TotalAmount						
					, (
						SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
							ELSE SUM(AEAD.Amount) 
						END
						FROM covi_account4j_si.act_expence_application_div AEAD
						WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					  ) AS Amount					
				FROM covi_account4j_si.act_expence_application AEA
				INNER JOIN covi_account4j_si.act_expence_application_list AEAL
				ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
				LEFT OUTER JOIN covi_account4j_si.act_vendor VD
				ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
				LEFT OUTER JOIN covi_smart4j.sys_object_user USR
				ON AEA.RegisterID = USR.UserCode
				LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
				ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
				LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
				ON AEAL.CardUID = CR.ReceiptID
				LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
				ON AEAL.TaxUID = ATI.TaxInvoiceID
				LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
				ON AEAL.CashUID = ACB.CashBillID
				WHERE 1=1
				AND AEA.ApplicationStatus != 'DELETE'
			
			  	<if test="DocNo != null and DocNo != ''">
			  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%')
				</if>
				
			  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
				 	AND AEA.ApplicationStatus = #{ApplicationStatus}
				</if>
			  	
			  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
				 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%')) 
				</if>
			  	
			  	<if test="ChargeJob != null and ChargeJob != ''">
				 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
				</if>
				
				<if test="RequestType != null and RequestType != ''">
				 	AND AEA.RequestType = #{RequestType}
				</if>
			  	
			  	<if test="ProofCode != null and ProofCode != ''">
				 	AND AEAL.ProofCode = #{ProofCode}
				</if>
				
			  	<if test="CompanyCode != null and CompanyCode != ''">
				 	AND AEA.CompanyCode = #{CompanyCode}
				</if>
				
			  	<if test="ProofDateSt != null and ProofDateSt != ''">
					<![CDATA[
					 	AND AEAL.ProofDate >= #{ProofDateSt}
					]]>
				</if>
			  	<if test="ProofDateEd != null and ProofDateEd != ''">
					<![CDATA[
					 	AND AEAL.ProofDate <= #{ProofDateEd}
					]]>
				</if>
			  	
			  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
					<![CDATA[
					 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
					]]>
				</if>
			  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
					<![CDATA[
					 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
					]]>
				</if>
			  	
			  	
			  	<if test="RegisterNm != null and RegisterNm != ''">
				 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%')) 
				</if>
			  	
			  	<if test="VendorName != null and VendorName != ''">
				 	AND (
				 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
				 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
				 	)
				</if>
			  	
				<choose>
					<when test="SessionUser != null and SessionUser != ''">
				 		AND AEA.RegisterID = #{SessionUser}
					</when>
					<otherwise>
					    AND AEA.ApplicationStatus NOT IN ('T')
					</otherwise>
				</choose>
				) A 
				GROUP BY  A.ExpenceApplicationID
			)A
			WHERE 1=1
		  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
		  	    <![CDATA[
			 	AND A.TotalAmountSumNum >= #{SearchAmtSt}
				]]>
			</if>
		  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
		  		<![CDATA[
			 	AND A.TotalAmountSumNum <= #{SearchAmtEd}
				]]>
			</if>
	</select>
	
	
	<select id="selectAuditUseYN" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectAuditUseYN
		*/
	    
		SELECT MAX(IF(AA.RuleCode = 'amount' AND AA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%'), AA.IsUse, null)) AmountUse 
			, MAX(IF(AA.RuleCode = 'weekend' AND AA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%'), AA.IsUse, null)) WeekendUse
			, MAX(IF(AA.RuleCode = 'holiday' AND AA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%'), AA.IsUse, null)) HolidayUse 
			, MAX(IF(AA.RuleCode = 'vacation' AND AA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%'), AA.IsUse, null)) VacationUse 
			, MAX(IF(AA.RuleCode = 'midnight' AND AA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%'), AA.IsUse, null)) MidnightUse 
			, MAX(IF(AA.RuleCode = 'limit' AND AA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%'), AA.IsUse, null)) LimitSectorUse 
			, MAX(IF(AA.RuleCode = 'outside' AND AA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%'), AA.IsUse, null)) OutsideUse 
		FROM covi_account4j_si.act_audit AA
	</select>
	
	<select id="selectExpenceApplicationList" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationList
		*/
		
		SELECT ExpenceApplicationID
			, A.CompanyCode
			, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, #{CompanyCode}) CompanyName
			, A.ApplicationTitle
			, A.ApplicationType
			, covi_account4j_si.Fn_GetBaseCodeName('ExpAppType', A.ApplicationType, #{CompanyCode}) ApplicationTypeName
			, A.ApplicationStatus
			, covi_account4j_si.Fn_GetBaseCodeName('ExpenceApplicationStatus', A.ApplicationStatus, #{CompanyCode}) ApplicationStatusName
			, A.RegisterID
			, A.RegisterName
			, A.ApplicationDate
			, A.RequestType
			, A.RequestTypeName
			, A.RegistDate
			, A.ChargeJob
			, A.ProcessID
			, A.ExpenceApplicationListID
			, A.ExpenceApplicationListID cdRownum
			, A.ProofDate
			, A.PostingDate
			, ProofCode
			, covi_account4j_si.Fn_GetBaseCodeName('ProofCode', A.ProofCode, #{CompanyCode}) ProofCodeName
			, CardUID
			, CashUID
			, TaxUID
			, ReceiptID
			, TaxType
			, TaxCode
			, PayAdjustMethod
			, PayMethod
			, IsWithholdingTax
			, IncomeTax
			, LocalTax
			, PayDate
			, VendorNo
			, VendorName
			, CardReceiptID
			, CardApproveNo
			, TaxInvoiceID
			, TaxNTSConfirmNum
			, CashNTSConfirmNum
			, FileCnt
			, AppCnt
			, TotalAmount
			, TotalAmountNum
			, TaxAmount
			, TaxAmountNum
			, RepAmount
			, RepAmountNum
			, AmountSum
			, AmountSumNum
			, DocNo
			, DocPostingDate
			, DocPayDate
			, ReceiptFileID
			, ProofTime
			, ProofHour
			, UsageComment
	  	<if test="AmountUse == 'Y'.toString()">
			, AAA.ApplicationColor AS AmountSumColor
		</if>
	  	<if test="WeekendUse == 'Y'.toString()">
			, AAW.ApplicationColor AS WeekendColor
		</if>
	  	<if test="HolidayUse == 'Y'.toString()">
			, AAH.ApplicationColor AS HolidayColor
		</if>
	  	<if test="VacationUse == 'Y'.toString()">
			, AAV.ApplicationColor AS VacationColor
		</if>
	  	<if test="MidnightUse == 'Y'.toString()">
			, AAM.ApplicationColor AS MidnightColor
		</if>
	  	<!-- <if test="LimitSectorUse == 'Y'.toString()">
			, AAL.ApplicationColor AS LimitSectorColor
		</if>
	  	<if test="OutsideUse == 'Y'.toString()">
			, AAO.ApplicationColor AS OutsideColor
		</if> -->
		FROM
		(
			SELECT AEA.ExpenceApplicationID 
				, AEA.CompanyCode
				, AEA.ApplicationTitle
				, AEA.ApplicationType
				, AEA.ApplicationStatus
				, AEA.RegisterID
				, USR.DisplayName RegisterName
				, DATE_FORMAT( IFNULL(AEA.ApplicationDate, AEA.RegistDate), '%Y.%m.%d') AS ApplicationDate
				, AEA.RequestType
				, AEF.FormName AS RequestTypeName
				, AEA.RegistDate
				, AEA.ChargeJob
				, AEA.ProcessID
				, AEAL.ExpenceApplicationListID
				, AEAL.ExpenceApplicationListID cdRownum
				, DATE_FORMAT( AEAL.ProofDate, '%Y.%m.%d') AS ProofDate
				, DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d') AS PostingDate
				, AEAL.ProofCode
				, AEAL.CardUID
				, AEAL.CashUID
				, AEAL.TaxUID
				, AEAL.ReceiptID
				, AEAL.TaxType
				, AEAL.TaxCode
				, AEAL.PayAdjustMethod
				, AEAL.PayMethod
				, AEAL.IsWithholdingTax
				, AEAL.IncomeTax
				, AEAL.LocalTax
				, DATE_FORMAT( AEAL.PayDate, '%Y.%m.%d') AS PayDate
				, AEAL.VendorNo
				, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
				, CR.ReceiptID CardReceiptID
				, CR.ApproveNo CardApproveNo
				, ATI.TaxInvoiceID
				, ATI.NTSConfirmNum TaxNTSConfirmNum
				, ACB.NTSConfirmNum CashNTSConfirmNum
				
				, (SELECT COUNT(*) FROM covi_account4j_si. act_expence_application_file AEAF
					WHERE AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
					) FileCnt
				, (SELECT COUNT(*) 
					FROM covi_account4j_si. act_expence_application_list AEALD
					WHERE AEAL.ExpenceApplicationID = AEALD.ExpenceApplicationID
					) AppCnt
			
				, FORMAT(AEAL.TotalAmount,2)				AS TotalAmount
				, AEAL.TotalAmount TotalAmountNum
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.TaxAmount, 2)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.TaxTotal, 2)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.Tax, 2)
					ELSE ''
					END TaxAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.TaxAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.TaxTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.Tax
					ELSE ''
					END TaxAmountNum
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.RepAmount, 2)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.SupplyCostTotal, 2)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.SupplyCost, 2)
					ELSE ''
					END RepAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.RepAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.SupplyCostTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.SupplyCost
					ELSE ''
					END RepAmountNum
				, (
					SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN FORMAT(SUM(AEAD.Amount) + AEAL.TaxAmount,2) 
							ELSE FORMAT(SUM(AEAD.Amount),2) 
						END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSum
				, (
					SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
							ELSE SUM(AEAD.Amount) 
						END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSumNum
				
				, AEAL.DocNo
				, CASE WHEN AEAL.DocNo IS NULL 
						THEN 
							DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d')
						ELSE 
							DATE_FORMAT( AEAL.DocPostingDate, '%Y.%m.%d')
					END DocPostingDate
				, CASE WHEN AEAL.DocNo IS NULL 
						THEN 
							DATE_FORMAT( AEAL.PayDate, '%Y.%m.%d')
						ELSE 
							DATE_FORMAT( AEAL.DocPayDate, '%Y.%m.%d')
					END DocPayDate
				, AR.ReceiptFileID
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CONCAT(LEFT(CR.ApproveTime, 2), ':', SUBSTRING(CR.ApproveTime, 3, 2), ':', RIGHT(CR.ApproveTime, 2)) 
					WHEN AEAL.ProofCode = 'Receipt' THEN CONCAT(AR.UseTime, ':00') 
					ELSE NULL 
				  END AS ProofTime
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN LEFT(CR.ApproveTime, 2) 
					WHEN AEAL.ProofCode = 'Receipt' THEN LEFT(AR.UseTime, 2) 
					ELSE NULL 
				  END AS ProofHour
				, (SELECT GROUP_CONCAT(AEAD.UsageComment) FROM covi_account4j_si.act_expence_application_div AEAD WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) AS UsageComment
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user USR
			ON AEA.RegisterID = USR.UserCode
			LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
			ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
			ON AEAL.CardUID = CR.ReceiptID
			LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
			ON AEAL.TaxUID = ATI.TaxInvoiceID
			LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
			ON AEAL.CashUID = ACB.CashBillID
			LEFT OUTER JOIN covi_account4j_si.act_receipt AR
			ON AEAL.ReceiptID = AR.ReceiptID
			WHERE 1=1
			AND AEA.ApplicationStatus != 'DELETE'
			
		  	<if test="DocNo != null and DocNo != ''">
		  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%') 
			</if>
			
		  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
			 	AND AEA.ApplicationStatus = #{ApplicationStatus}
			</if>
		  	
		  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
			 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%')) 
			</if>
			  	
		  	<if test="ChargeJob != null and ChargeJob != ''">
			 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
			</if>
				
			<if test="RequestType != null and RequestType != ''">
			 	AND AEA.RequestType = #{RequestType}
			</if>
		  	
		  	<if test="ProofCode != null and ProofCode != ''">
			 	AND AEAL.ProofCode = #{ProofCode}
			</if>
		  	
		  	<if test="CompanyCode != null and CompanyCode != ''">
				AND AEA.CompanyCode = #{CompanyCode}
			</if>
			
		  	<if test="ProofDateSt != null and ProofDateSt != ''">
				<![CDATA[
				 	AND AEAL.ProofDate >= #{ProofDateSt}
				]]>
			</if>
		  	<if test="ProofDateEd != null and ProofDateEd != ''">
				<![CDATA[
				 	AND AEAL.ProofDate <= #{ProofDateEd}
				]]>
			</if>
		  	
		  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
				<![CDATA[
				 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
				]]>
			</if>
		  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
				<![CDATA[
				 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
				]]>
			</if>
		  	
		  	
		  	<if test="RegisterNm != null and RegisterNm != ''">
			 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%')) 
			</if>
		  	
		  	<if test="VendorName != null and VendorName != ''">
			 	AND (
			 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
			 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
			 	)
			</if>
			
		  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
		  	    <![CDATA[
			 	AND AEAL.TotalAmount > #{SearchAmtSt}
				]]>
			</if>
		  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
		  		<![CDATA[
			 	AND AEAL.TotalAmount < #{SearchAmtEd}
				]]>
			</if>
		  	<if test="StandardBriefID != null and StandardBriefID != ''">
		  		AND #{StandardBriefID} IN (
		  			SELECT StandardBriefID 
		  			FROM covi_account4j_si.act_expence_application_div AEAD
		  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		  		)
			</if>
			<if test="PayDate != null and PayDate != ''">
			    AND AEAL.PayDate = #{PayDate}
			</if>
			<choose>
				<when test="SessionUser != null and SessionUser != ''">
			 		AND AEA.RegisterID = #{SessionUser}
				</when>
				<otherwise>
				    AND AEA.ApplicationStatus NOT IN ('T')
				</otherwise>
			</choose>
		) A
	  	<if test="AmountUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_account4j_si.act_audit AAA
				ON AAA.RuleCode = 'amount'
				AND AAA.IsUse = 'Y'
				AND AAA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%') 
				AND A.AmountSumNum > (AAA.StdValue * 10000)
				AND A.ApplicationType != 'CO'
		</if>
	  	<if test="WeekendUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_account4j_si.act_audit AAW
				ON AAW.RuleCode = 'weekend'
				AND AAW.IsUse = 'Y'
				AND AAW.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
				AND DAYOFWEEK(A.ProofDate) IN (1, 7)
				AND A.ApplicationType != 'CO'
		</if>
	  	<if test="HolidayUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_smart4j.sys_calendar SC
				ON SC.SolarDate = DATE_FORMAT(A.ProofDate, '%Y-%m-%d')
				AND SC.Anniversary IS NOT NULL
			LEFT OUTER JOIN covi_account4j_si.act_audit AAH
				ON AAH.RuleCode = 'holiday'
				AND AAH.IsUse = 'Y'
				AND AAH.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
				AND SC.SolarDate IS NOT NULL
				AND A.ApplicationType != 'CO'
		</if><if test="VacationUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_smart4j.vm_vacationinfo VI
				ON (DATE_FORMAT(A.ProofDate, '%Y.%m.%d') BETWEEN VI.Sdate AND VI.Edate)
				AND VI.GUBUN NOT IN ('VACATION_CANCEL', 'VACATION_PUBLIC_CANCEL') 
				AND VI.UR_Code = A.RegisterID
				AND SDate NOT IN (
					SELECT SDate 
					FROM covi_smart4j.vm_vacationinfo VVI
					WHERE VVI.GUBUN IN ('VACATION_CANCEL', 'VACATION_PUBLIC_CANCEL')
					AND VI.VacFlag = VVI.VacFlag
					AND VI.VacDay = VVI.VacDay * -1
					AND VVI.UR_Code = A.RegisterID
				)
			LEFT OUTER JOIN covi_account4j_si.act_audit AAV
				ON AAV.RuleCode = 'vacation'
				AND AAV.IsUse = 'Y'
				AND AAV.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
				AND VI.Sdate IS NOT NULL
				AND A.ApplicationType != 'CO'
		</if>
	  	<if test="MidnightUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_account4j_si.act_audit AAM
				ON AAM.RuleCode = 'midnight'
				AND AAM.IsUse = 'Y'
				AND AAM.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
				<![CDATA[
				AND (A.ProofHour >= AAM.StdStartTime OR A.ProofHour <= AAM.StdEndTime)
				]]> 
				AND A.ApplicationType != 'CO'
		</if>
		GROUP BY A.ExpenceApplicationListID
		<trim prefix="ORDER BY"  prefixOverrides =",">
		    <if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				, A.RegistDate DESC  
				, A.ApplicationTitle
				, A.ProofCode
				, A.ExpenceApplicationListID
		    </if>
		  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
			 	<choose>
					<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationStatusName")'>ApplicationStatusName</when>
					<when test='sortColumn.equalsIgnoreCase("RequestTypeName")'>RequestTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("PayDate")'>PayDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofDate")'>ProofDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofTime")'>ProofTime</when>
					<when test='sortColumn.equalsIgnoreCase("ProofCodeName")'>ProofCodeName</when>
					<when test='sortColumn.equalsIgnoreCase("VendorName")'>VendorName</when>
					<when test='sortColumn.equalsIgnoreCase("UsageComment")'>UsageComment</when>
					<when test='sortColumn.equalsIgnoreCase("TaxAmount")'>TaxAmount</when>
					<when test='sortColumn.equalsIgnoreCase("RepAmount")'>RepAmount</when>
					<when test='sortColumn.equalsIgnoreCase("TotalAmount")'>TotalAmount</when>
					<when test='sortColumn.equalsIgnoreCase("AmountSum")'>AmountSum</when>
					<when test='sortColumn.equalsIgnoreCase("DocNo")'>DocNo</when>
					<otherwise>ApplicationDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	
	<select id="selectExpenceApplicationListExcel" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationListExcel
		*/
		
		SELECT ExpenceApplicationID
			, A.CompanyCode
			, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, #{CompanyCode}) CompanyName
			, A.ApplicationTitle
			, A.ApplicationType
			, covi_account4j_si.Fn_GetBaseCodeName('ExpAppType', A.ApplicationType, #{CompanyCode}) ApplicationTypeName
			, A.ApplicationStatus
			, covi_account4j_si.Fn_GetBaseCodeName('ExpenceApplicationStatus', A.ApplicationStatus, #{CompanyCode}) ApplicationStatusName
			, A.RegisterID
			, A.RegisterName
			, A.ApplicationDate
			, A.RequestType
			, A.RequestTypeName
			, A.RegistDate
			, A.ChargeJob
			, A.ProcessID
			, A.ExpenceApplicationListID
			, A.ExpenceApplicationListID cdRownum
			, A.ProofDate
			, A.PostingDate
			, ProofCode
			, covi_account4j_si.Fn_GetBaseCodeName('ProofCode', A.ProofCode, #{CompanyCode}) ProofCodeName
			, CardUID
			, CashUID
			, TaxUID
			, ReceiptID
			, TaxType
			, TaxCode
			, PayAdjustMethod
			, PayMethod
			, IsWithholdingTax
			, IncomeTax
			, LocalTax
			, PayDate
			, VendorNo
			, VendorName
			, CardReceiptID
			, CardApproveNo
			, TaxInvoiceID
			, TaxNTSConfirmNum
			, CashNTSConfirmNum
			, FileCnt
			, AppCnt
			, TotalAmount
			, TotalAmountNum
			, TaxAmount
			, TaxAmountNum
			, RepAmount
			, RepAmountNum
			, AmountSum
			, AmountSumNum
			, DocNo
			, DocPostingDate
			, DocPayDate
			, ReceiptFileID
			, ProofTime
			, ProofHour
			, UsageComment
	  	<if test="AmountUse == 'Y'.toString()">
			, AAA.ApplicationColor AS AmountSumColor
		</if>
	  	<if test="WeekendUse == 'Y'.toString()">
			, AAW.ApplicationColor AS WeekendColor
		</if>
	  	<if test="HolidayUse == 'Y'.toString()">
			, AAH.ApplicationColor AS HolidayColor
		</if>
	  	<if test="VacationUse == 'Y'.toString()">
			, AAV.ApplicationColor AS VacationColor
		</if>
	  	<if test="MidnightUse == 'Y'.toString()">
			, AAM.ApplicationColor AS MidnightColor
		</if>
	  	<!-- <if test="LimitSectorUse == 'Y'.toString()">
			, AAL.ApplicationColor AS LimitSectorColor
		</if>
	  	<if test="OutsideUse == 'Y'.toString()">
			, AAO.ApplicationColor AS OutsideColor
		</if> -->
		FROM
		(
			SELECT AEA.ExpenceApplicationID 
				, AEA.CompanyCode
				, AEA.ApplicationTitle
				, AEA.ApplicationType
				, AEA.ApplicationStatus
				, AEA.RegisterID
				, USR.DisplayName RegisterName
				, DATE_FORMAT( IFNULL(AEA.ApplicationDate, AEA.RegistDate), '%Y.%m.%d') AS ApplicationDate
				, AEA.RequestType
				, AEF.FormName AS RequestTypeName
				, AEA.RegistDate
				, AEA.ChargeJob
				, AEA.ProcessID
				
				, AEAL.ExpenceApplicationListID
				, AEAL.ExpenceApplicationListID cdRownum
				, DATE_FORMAT( AEAL.ProofDate, '%Y.%m.%d') AS ProofDate
				, DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d') AS PostingDate
				, AEAL.ProofCode
				
				, AEAL.CardUID
				, AEAL.CashUID
				, AEAL.TaxUID
				, AEAL.ReceiptID
				, AEAL.TaxType
				, AEAL.TaxCode
				, AEAL.PayAdjustMethod
				, AEAL.PayMethod
				, AEAL.IsWithholdingTax
				, AEAL.IncomeTax
				, AEAL.LocalTax
				, DATE_FORMAT( AEAL.PayDate, '%Y.%m.%d') AS PayDate
				, AEAL.VendorNo
				, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
				, CR.ReceiptID CardReceiptID
				, CR.ApproveNo CardApproveNo
				, ATI.TaxInvoiceID
				, ATI.NTSConfirmNum TaxNTSConfirmNum
				, ACB.NTSConfirmNum CashNTSConfirmNum
				
				, (SELECT COUNT(*) FROM covi_account4j_si. act_expence_application_file AEAF
					WHERE AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
					) FileCnt
				, (SELECT COUNT(*) 
					FROM covi_account4j_si. act_expence_application_list AEALD
					WHERE AEAL.ExpenceApplicationID = AEALD.ExpenceApplicationID
					) AppCnt
			
				, FORMAT(AEAL.TotalAmount,2)				AS TotalAmount
				, AEAL.TotalAmount TotalAmountNum
				
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.TaxAmount, 2)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.TaxTotal, 2)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.Tax, 2)
					ELSE ''
					END TaxAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.TaxAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.TaxTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.Tax
					ELSE ''
					END TaxAmountNum
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.RepAmount, 2)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.SupplyCostTotal, 2)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.SupplyCost, 2)
					ELSE ''
					END RepAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.RepAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.SupplyCostTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.SupplyCost
					ELSE ''
					END RepAmountNum
					
				, (
					SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN FORMAT(SUM(AEAD.Amount) + AEAL.TaxAmount,2) 
							ELSE FORMAT(SUM(AEAD.Amount),2) 
						END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSum
				, (
					SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
							ELSE SUM(AEAD.Amount) 
						END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSumNum
				
				, AEAL.DocNo
				, CASE WHEN AEAL.DocNo IS NULL 
						THEN 
							DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d')
						ELSE 
							DATE_FORMAT( AEAL.DocPostingDate, '%Y.%m.%d')
					END DocPostingDate
				, CASE WHEN AEAL.DocNo IS NULL 
						THEN 
							DATE_FORMAT( AEAL.PayDate, '%Y.%m.%d')
						ELSE 
							DATE_FORMAT( AEAL.DocPayDate, '%Y.%m.%d')
					END DocPayDate
				, AR.ReceiptFileID
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CONCAT(LEFT(CR.ApproveTime, 2), ':', SUBSTRING(CR.ApproveTime, 3, 2), ':', RIGHT(CR.ApproveTime, 2)) 
					WHEN AEAL.ProofCode = 'Receipt' THEN CONCAT(AR.UseTime, ':00') 
					ELSE NULL 
				  END AS ProofTime
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN LEFT(CR.ApproveTime, 2) 
					WHEN AEAL.ProofCode = 'Receipt' THEN LEFT(AR.UseTime, 2) 
					ELSE NULL 
				  END AS ProofHour
				, (SELECT GROUP_CONCAT(AEAD.UsageComment) FROM covi_account4j_si.act_expence_application_div AEAD WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) AS UsageComment
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user USR
		ON AEA.RegisterID = USR.UserCode
		LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
		ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
		LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
		ON AEAL.CardUID = CR.ReceiptID
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
		ON AEAL.CashUID = ACB.CashBillID
		LEFT OUTER JOIN covi_account4j_si.act_receipt AR
		ON AEAL.ReceiptID = AR.ReceiptID
		WHERE 1=1
		AND AEA.ApplicationStatus != 'DELETE'
			
	  	<if test="DocNo != null and DocNo != ''">
	  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%')
		</if>
		
	  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
		 	AND AEA.ApplicationStatus = #{ApplicationStatus}
		</if>
	  	
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
		</if>
			  	
	  	<if test="ChargeJob != null and ChargeJob != ''">
		 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
		</if>
				
		<if test="RequestType != null and RequestType != ''">
		 	AND AEA.RequestType = #{RequestType}
		</if>
	  	
	  	<if test="ProofCode != null and ProofCode != ''">
		 	AND AEAL.ProofCode = #{ProofCode}
		</if>
	  	
	  	<if test="CompanyCode != null and CompanyCode != ''">
			AND AEA.CompanyCode = #{CompanyCode}
		</if>
		
	  	<if test="ProofDateSt != null and ProofDateSt != ''">
			<![CDATA[
			 	AND AEAL.ProofDate >= #{ProofDateSt}
			]]>
		</if>
	  	<if test="ProofDateEd != null and ProofDateEd != ''">
			<![CDATA[
			 	AND AEAL.ProofDate <= #{ProofDateEd}
			]]>
		</if>
	  	
	  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
			]]>
		</if>
	  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
			]]>
		</if>
	  	
	  	
	  	<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>
	  	
	  	<if test="VendorName != null and VendorName != ''">
		 	AND (
		 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 	)
		</if>
	  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
	  	    <![CDATA[
		 	AND AEAL.TotalAmount > #{SearchAmtSt}
			]]>
		</if>
	  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
	  		<![CDATA[
		 	AND AEAL.TotalAmount < #{SearchAmtEd}
			]]>
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
	  		AND #{StandardBriefID} IN (
	  			SELECT StandardBriefID 
	  			FROM covi_account4j_si.act_expence_application_div AEAD
	  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
	  		)
		</if>
		<if test="PayDate != null and PayDate != ''">
		    AND AEAL.PayDate = #{PayDate}
		</if>
		<choose>
			<when test="SessionUser != null and SessionUser != ''">
		 		AND AEA.RegisterID = #{SessionUser}
			</when>
			<otherwise>
			    AND AEA.ApplicationStatus NOT IN ('T')
			</otherwise>
		</choose>
		) A
	  	<if test="AmountUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_account4j_si.act_audit AAA
				ON AAA.RuleCode = 'amount'
				AND AAA.IsUse = 'Y'
				AND AAA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
				AND A.AmountSumNum > (AAA.StdValue * 10000)
				AND A.ApplicationType != 'CO'
		</if>
	  	<if test="WeekendUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_account4j_si.act_audit AAW
				ON AAW.RuleCode = 'weekend'
				AND AAW.IsUse = 'Y'
				AND AAW.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
				AND DAYOFWEEK(A.ProofDate) IN (1, 7)
				AND A.ApplicationType != 'CO'
		</if>
	  	<if test="HolidayUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_smart4j.sys_calendar SC
				ON SC.SolarDate = DATE_FORMAT(A.ProofDate, '%Y-%m-%d')
				AND SC.Anniversary IS NOT NULL
			LEFT OUTER JOIN covi_account4j_si.act_audit AAH
				ON AAH.RuleCode = 'holiday'
				AND AAH.IsUse = 'Y'
				AND AAH.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
				AND SC.SolarDate IS NOT NULL
				AND A.ApplicationType != 'CO'
		</if>
	  	<if test="VacationUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_smart4j.vm_vacationinfo VI
				ON (DATE_FORMAT(A.ProofDate, '%Y.%m.%d') BETWEEN VI.Sdate AND VI.Edate)
				AND VI.GUBUN NOT IN ('VACATION_CANCEL', 'VACATION_PUBLIC_CANCEL') 
				AND VI.UR_Code = A.RegisterID
				AND SDate NOT IN (
					SELECT SDate 
					FROM covi_smart4j.vm_vacationinfo VVI 
					WHERE VVI.GUBUN IN ('VACATION_CANCEL', 'VACATION_PUBLIC_CANCEL')
					AND VI.VacFlag = VVI.VacFlag
					AND VI.VacDay = VVI.VacDay * -1
					AND VVI.UR_Code = A.RegisterID
				)
			LEFT OUTER JOIN covi_account4j_si.act_audit AAV
				ON AAV.RuleCode = 'vacation'
				AND AAV.IsUse = 'Y'
				AND AAV.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
				AND VI.Sdate IS NOT NULL
				AND A.ApplicationType != 'CO'
		</if>
	  	<if test="MidnightUse == 'Y'.toString()">
			LEFT OUTER JOIN covi_account4j_si.act_audit AAM
				ON AAM.RuleCode = 'midnight'
				AND AAM.IsUse = 'Y'
				AND AAM.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
				<![CDATA[
				AND (A.ProofHour >= AAM.StdStartTime OR A.ProofHour <= AAM.StdEndTime)
				]]> 
				AND A.ApplicationType != 'CO'
		</if>
		GROUP BY A.ExpenceApplicationListID
		<trim prefix="ORDER BY"  prefixOverrides =",">
		    <if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				, A.RegistDate DESC  
				, A.ApplicationTitle
				, A.ProofCode
				, A.ExpenceApplicationListID
		    </if>
		  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
			 	<choose>
					<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationStatusName")'>ApplicationStatusName</when>
					<when test='sortColumn.equalsIgnoreCase("RequestTypeName")'>RequestTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("PayDate")'>PayDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofDate")'>ProofDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofTime")'>ProofTime</when>
					<when test='sortColumn.equalsIgnoreCase("ProofCodeName")'>ProofCodeName</when>
					<when test='sortColumn.equalsIgnoreCase("VendorName")'>VendorName</when>
					<when test='sortColumn.equalsIgnoreCase("UsageComment")'>UsageComment</when>
					<when test='sortColumn.equalsIgnoreCase("TaxAmount")'>TaxAmount</when>
					<when test='sortColumn.equalsIgnoreCase("RepAmount")'>RepAmount</when>
					<when test='sortColumn.equalsIgnoreCase("TotalAmount")'>TotalAmount</when>
					<when test='sortColumn.equalsIgnoreCase("AmountSum")'>AmountSum</when>
					<when test='sortColumn.equalsIgnoreCase("DocNo")'>DocNo</when>
					<otherwise>ApplicationDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
	</select>
	
	<select id="selectExpenceApplicationListCnt" resultType="java.lang.Long">
		/*
			expenceApplication.selectExpenceApplicationListCnt
		*/
		
		SELECT Count(*)
		FROM
		(
			SELECT A.ExpenceApplicationListID
			FROM
			(
				SELECT AEAL.ExpenceApplicationListID
				FROM covi_account4j_si.act_expence_application AEA
				INNER JOIN covi_account4j_si.act_expence_application_list AEAL
				ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
				LEFT OUTER JOIN covi_account4j_si.act_vendor VD
				ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
				LEFT OUTER JOIN covi_smart4j.sys_object_user USR
				ON AEA.RegisterID = USR.UserCode
				LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
				ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
				LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
				ON AEAL.CardUID = CR.ReceiptID
				LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
				ON AEAL.TaxUID = ATI.TaxInvoiceID
				LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
				ON AEAL.CashUID = ACB.CashBillID
				LEFT OUTER JOIN covi_account4j_si.act_receipt AR
				ON AEAL.ReceiptID = AR.ReceiptID
				WHERE 1=1
				AND AEA.ApplicationStatus != 'DELETE'
			
			  	<if test="DocNo != null and DocNo != ''">
			  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%')
				</if>
				
			  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
				 	AND AEA.ApplicationStatus = #{ApplicationStatus}
				</if>
			  	
			  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
				 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
				</if>
			  	
			  	<if test="ChargeJob != null and ChargeJob != ''">
				 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%') 
				</if>
				
				<if test="RequestType != null and RequestType != ''">
				 	AND AEA.RequestType = #{RequestType}
				</if>
			  	
			  	<if test="ProofCode != null and ProofCode != ''">
				 	AND AEAL.ProofCode = #{ProofCode}
				</if>
			  	
			  	<if test="CompanyCode != null and CompanyCode != ''">
				 	AND AEA.CompanyCode = #{CompanyCode}
				</if>
				
			  	<if test="ProofDateSt != null and ProofDateSt != ''">
					<![CDATA[
					 	AND AEAL.ProofDate >= #{ProofDateSt}
					]]>
				</if>
			  	<if test="ProofDateEd != null and ProofDateEd != ''">
					<![CDATA[
					 	AND AEAL.ProofDate <= #{ProofDateEd}
					]]>
				</if>
			  	
			  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
					<![CDATA[
					 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
					]]>
				</if>
			  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
					<![CDATA[
					 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
					]]>
				</if>
			  	
			  	
			  	<if test="RegisterNm != null and RegisterNm != ''">
				 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
				</if>
			  	
			  	<if test="VendorName != null and VendorName != ''">
				 	AND (
				 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%')) 
				 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
				 	)
				</if>
			  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
			  	    <![CDATA[
				 	AND AEAL.TotalAmount > #{SearchAmtSt}
					]]>
				</if>
			  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
			  		<![CDATA[
				 	AND AEAL.TotalAmount < #{SearchAmtEd}
					]]>
				</if>
			  	<if test="StandardBriefID != null and StandardBriefID != ''">
			  		AND #{StandardBriefID} IN (
			  			SELECT StandardBriefID 
			  			FROM covi_account4j_si.act_expence_application_div AEAD
			  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			  		)
				</if>
				<if test="PayDate != null and PayDate != ''">
				    AND AEAL.PayDate = #{PayDate}
				</if>
				<choose>
					<when test="SessionUser != null and SessionUser != ''">
				 		AND AEA.RegisterID = #{SessionUser}
					</when>
					<otherwise>
					    AND AEA.ApplicationStatus NOT IN ('T')
					</otherwise>
				</choose>
			) A
			GROUP BY A.ExpenceApplicationListID
		) A
	</select>
	
	<select id="selectExpenceApplicationManDiv" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationManDiv
		*/
		select *
			, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, #{CompanyCode}) CompanyName
			, covi_account4j_si.Fn_GetBaseCodeName('ExpAppType', A.ApplicationType, #{CompanyCode}) ApplicationTypeName
			, covi_account4j_si.Fn_GetBaseCodeName('ExpenceApplicationStatus', A.ApplicationStatus, #{CompanyCode}) ApplicationStatusName
			, covi_account4j_si.Fn_GetBaseCodeName('ProofCode', A.ProofCode, #{CompanyCode}) ProofCodeName
		from (
			SELECT AEA.ExpenceApplicationID 
				, AEA.CompanyCode
				, AEA.ApplicationTitle
				, AEA.ApplicationType					
				, AEA.ApplicationStatus
				, AEA.RegisterID
				, USR.DisplayName RegisterName
				, DATE_FORMAT( IFNULL(AEA.ApplicationDate, AEA.RegistDate), '%Y.%m.%d') AS ApplicationDate			
				, AEA.RequestType
				, AEF.FormName AS RequestTypeName
				, AEA.RegistDate
				, AEA.ChargeJob	
				, AEA.ProcessID				
				, AEAL.ExpenceApplicationListID
				, AEAL.ExpenceApplicationListID cdRownum
				, DATE_FORMAT( AEAL.ProofDate, '%Y.%m.%d') AS ProofDate
				, DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d') AS PostingDate
				, AEAL.ProofCode			
				, AEAL.CardUID
				, AEAL.CashUID
				, AEAL.TaxUID
				, AEAL.TaxType
				, AEAL.TaxCode
				, AEAL.PayAdjustMethod
				, AEAL.PayMethod
				, AEAL.IsWithholdingTax
				, AEAL.IncomeTax
				, AEAL.LocalTax
				, DATE_FORMAT( AEAL.PayDate, '%Y.%m.%d') AS PayDate
				, AEAL.VendorNo
				, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
				, CR.ReceiptID CardReceiptID
				, CR.ApproveNo CardApproveNo
				, ATI.TaxInvoiceID
				, ATI.NTSConfirmNum TaxNTSConfirmNum
				, ACB.NTSConfirmNum CashNTSConfirmNum		
				, (SELECT COUNT(*) FROM covi_account4j_si. act_expence_application_file AEAF
					WHERE AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
					) FileCnt				
				, AEAD.AccountCode
				, AEAD.AccountName
				, AEAD. CostCenterCode
				, AEAD.CostCenterName
				, AEAD. IOCode
				, AEAD. IOName
				, AEAD.StandardBriefID
				, AEAD.StandardBriefName
				, FORMAT(AEAL.TotalAmount,2)				AS TotalAmount		
				, AEAL.TotalAmount							AS TotalAmountNum			
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.TaxAmount, 2)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.TaxTotal, 2)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.Tax, 2)
					ELSE ''
					END TaxAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.TaxAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.TaxTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.Tax
					ELSE ''
					END TaxAmountNum
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.RepAmount, 2)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.SupplyCostTotal, 2)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.SupplyCost, 2)
					ELSE ''
					END RepAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.RepAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.SupplyCostTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.SupplyCost
					ELSE ''
					END RepAmountNum			
				, FORMAT(AEAD.Amount,2) AS Amount
				, AEAD.Amount AS AmountNum	
				, AEAD.UsageComment
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AEAD
			ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user USR
			ON AEA.RegisterID = USR.UserCode
			LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
			ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
			ON AEAL.CardUID = CR.ReceiptID
			LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
			ON AEAL.TaxUID = ATI.TaxInvoiceID
			LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
			ON AEAL.CashUID = ACB.CashBillID
			WHERE 1=1		
			AND AEA.ApplicationStatus != 'DELETE'
				
		  	<if test="DocNo != null and DocNo != ''">
		  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%') 
			</if>
			
		  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
			 	AND AEA.ApplicationStatus = #{ApplicationStatus}
			</if>
		  	
		  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
			 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
			</if>
			  	
		  	<if test="ChargeJob != null and ChargeJob != ''">
			 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
			</if>
				
			<if test="RequestType != null and RequestType != ''">
			 	AND AEA.RequestType = #{RequestType}
			</if>
		  	
		  	<if test="ProofCode != null and ProofCode != ''">
			 	AND AEAL.ProofCode = #{ProofCode}
			</if>
		  	
		  	<if test="CompanyCode != null and CompanyCode != ''">
				AND AEA.CompanyCode = #{CompanyCode}
			</if>
			
		  	<if test="ProofDateSt != null and ProofDateSt != ''">
				<![CDATA[
				 	AND AEAL.ProofDate >= #{ProofDateSt}
				]]>
			</if>
		  	<if test="ProofDateEd != null and ProofDateEd != ''">
				<![CDATA[
				 	AND AEAL.ProofDate <= #{ProofDateEd}
				]]>
			</if>
		  	
		  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
				<![CDATA[
				 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
				]]>
			</if>
		  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
				<![CDATA[
				 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
				]]>
			</if>
		  	
		  	
		  	<if test="RegisterNm != null and RegisterNm != ''">
			 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%')) 
			</if>
		  	
		  	<if test="VendorName != null and VendorName != ''">
			 	AND (
			 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%')) 
			 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
			 	)
			</if>
			
		  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
		  	    <![CDATA[
			 	AND AEAD.Amount > #{SearchAmtSt}
				]]>
			</if>
		  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
		  		<![CDATA[
			 	AND AEAD.Amount < #{SearchAmtEd}
				]]>
			</if>
		  	<if test="AccountCode != null and AccountCode != ''">
			 	AND AEAD.AccountCode = #{AccountCode}
			</if>
		  	<if test="CostCenterCode != null and CostCenterCode != ''">
			 	AND AEAD.CostCenterCode = #{CostCenterCode}
			</if>
		  	<if test="IOCode != null and IOCode != ''">
			 	AND AEAD.IOCode = #{IOCode}
			</if>
		  	<if test="StandardBriefID != null and StandardBriefID != ''">
			 	AND AEAD.StandardBriefID = #{StandardBriefID}
			</if>
			<if test="PayDate != null and PayDate != ''">
			    AND AEAL.PayDate = #{PayDate}
			</if>
			
			<choose>
				<when test="SessionUser != null and SessionUser != ''">
			 		AND AEA.RegisterID = #{SessionUser}
				</when>
				<otherwise>
				    AND AEA.ApplicationStatus NOT IN ('T')
				</otherwise>
			</choose>
		) A
		<trim prefix="ORDER BY"  prefixOverrides =",">
		    <if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				, A.RegistDate DESC
				, A.ApplicationTitle
				, A.ProofCode
				, A.ExpenceApplicationListID 
		    </if>
		  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
			 	<choose>
					<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationStatusName")'>ApplicationStatusName</when>
					<when test='sortColumn.equalsIgnoreCase("RequestTypeName")'>RequestTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("PayDate")'>PayDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofDate")'>ProofDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofCodeName")'>ProofCodeName</when>
					<when test='sortColumn.equalsIgnoreCase("VendorName")'>VendorName</when>
					<when test='sortColumn.equalsIgnoreCase("UsageComment")'>UsageComment</when>
					<when test='sortColumn.equalsIgnoreCase("TaxAmount")'>TaxAmount</when>
					<when test='sortColumn.equalsIgnoreCase("RepAmount")'>RepAmount</when>
					<when test='sortColumn.equalsIgnoreCase("TotalAmount")'>TotalAmount</when>
					<when test='sortColumn.equalsIgnoreCase("Amount")'>Amount</when>
					<when test='sortColumn.equalsIgnoreCase("CostCenterName")'>CostCenterName</when>
					<when test='sortColumn.equalsIgnoreCase("IOName")'>IOName</when>
					<when test='sortColumn.equalsIgnoreCase("AccountName")'>AccountName</when>
					<when test='sortColumn.equalsIgnoreCase("StandardBriefName")'>StandardBriefName</when>
					<otherwise>ApplicationDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	<select id="selectExpenceApplicationManDivExcel" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationManDivExcel
		*/
		select *
			, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, #{CompanyCode}) CompanyName
			, covi_account4j_si.Fn_GetBaseCodeName('ExpAppType', A.ApplicationType, #{CompanyCode}) ApplicationTypeName
			, covi_account4j_si.Fn_GetBaseCodeName('ExpenceApplicationStatus', A.ApplicationStatus, #{CompanyCode}) ApplicationStatusName
			, covi_account4j_si.Fn_GetBaseCodeName('ProofCode', A.ProofCode, #{CompanyCode}) ProofCodeName
		from (
			SELECT AEA.ExpenceApplicationID 
				, AEA.CompanyCode
				, AEA.ApplicationTitle
				, AEA.ApplicationType
				, AEA.ApplicationStatus
				, AEA.RegisterID
				, USR.DisplayName RegisterName
				, DATE_FORMAT( IFNULL(AEA.ApplicationDate, AEA.RegistDate), '%Y.%m.%d') AS ApplicationDate	
				, AEA.RequestType
				, AEF.FormName AS RequestTypeName
				, AEA.RegistDate		
				, AEA.ChargeJob			
				, AEA.ProcessID		
				, AEAL.ExpenceApplicationListID
				, AEAL.ExpenceApplicationListID cdRownum
				, DATE_FORMAT( AEAL.ProofDate, '%Y.%m.%d') AS ProofDate
				, DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d') AS PostingDate
				, AEAL.ProofCode
				, AEAL.CardUID
				, AEAL.CashUID
				, AEAL.TaxUID
				, AEAL.TaxType
				, AEAL.TaxCode
				, AEAL.PayAdjustMethod
				, AEAL.PayMethod
				, AEAL.IsWithholdingTax
				, AEAL.IncomeTax
				, AEAL.LocalTax
				, DATE_FORMAT( AEAL.PayDate, '%Y.%m.%d') AS PayDate
				, AEAL.VendorNo
				, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
				, CR.ReceiptID CardReceiptID
				, CR.ApproveNo CardApproveNo
				, ATI.TaxInvoiceID
				, ATI.NTSConfirmNum TaxNTSConfirmNum
				, ACB.NTSConfirmNum CashNTSConfirmNum		
				, (SELECT COUNT(*) FROM covi_account4j_si. act_expence_application_file AEAF
					WHERE AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
					) FileCnt				
				, AEAD.AccountCode
				, AEAD.AccountName
				, AEAD. CostCenterCode
				, AEAD.CostCenterName
				, AEAD. IOCode
				, AEAD. IOName
				, AEAD.StandardBriefID
				, AEAD.StandardBriefName
				, FORMAT(AEAL.TotalAmount,2)				AS TotalAmount	
				, AEAL.TotalAmount							AS TotalAmountNum				
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.TaxAmount, 2)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.TaxTotal, 2)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.Tax, 2)
					ELSE ''
					END TaxAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.TaxAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.TaxTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.Tax
					ELSE ''
					END TaxAmountNum
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.RepAmount, 2)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.SupplyCostTotal, 2)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.SupplyCost, 2)
					ELSE ''
					END RepAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.RepAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.SupplyCostTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.SupplyCost
					ELSE ''
					END RepAmountNum	
				, FORMAT(AEAD.Amount,2) AS Amount
				, AEAD.Amount AS AmountNum
				, AEAD.UsageComment		
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AEAD
			ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user USR
			ON AEA.RegisterID = USR.UserCode
			LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
			ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
			ON AEAL.CardUID = CR.ReceiptID
			LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
			ON AEAL.TaxUID = ATI.TaxInvoiceID
			LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
			ON AEAL.CashUID = ACB.CashBillID
			WHERE 1=1
			AND AEA.ApplicationStatus != 'DELETE'
			
	  	<if test="DocNo != null and DocNo != ''">
	  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%')
		</if>
		
	  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
		 	AND AEA.ApplicationStatus = #{ApplicationStatus}
		</if>
	  	
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
		</if>
			  	
	  	<if test="ChargeJob != null and ChargeJob != ''">
		 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
		</if>
				
		<if test="RequestType != null and RequestType != ''">
		 	AND AEA.RequestType = #{RequestType}
		</if>
	  	
	  	<if test="ProofCode != null and ProofCode != ''">
		 	AND AEAL.ProofCode = #{ProofCode}
		</if>
	  	
	  	<if test="CompanyCode != null and CompanyCode != ''">
			AND AEA.CompanyCode = #{CompanyCode}
		</if>
		
	  	<if test="ProofDateSt != null and ProofDateSt != ''">
			<![CDATA[
			 	AND AEAL.ProofDate >= #{ProofDateSt}
			]]>
		</if>
	  	<if test="ProofDateEd != null and ProofDateEd != ''">
			<![CDATA[
			 	AND AEAL.ProofDate <= #{ProofDateEd}
			]]>
		</if>
	  	
	  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
			]]>
		</if>
	  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
			]]>
		</if>
	  	
	  	
	  	<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>
	  	
	  	<if test="VendorName != null and VendorName != ''">
		 	AND (
		 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 	)
		</if>
	  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
	  	    <![CDATA[
		 	AND AEAD.Amount > #{SearchAmtSt}
			]]>
		</if>
	  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
	  		<![CDATA[
		 	AND AEAD.Amount < #{SearchAmtEd}
			]]>
		</if>
	  	<if test="AccountCode != null and AccountCode != ''">
		 	AND AEAD.AccountCode = #{AccountCode}
		</if>
	  	<if test="CostCenterCode != null and CostCenterCode != ''">
		 	AND AEAD.CostCenterCode = #{CostCenterCode}
		</if>
	  	<if test="IOCode != null and IOCode != ''">
		 	AND AEAD.IOCode = #{IOCode}
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
		 	AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>
		<if test="PayDate != null and PayDate != ''">
		    AND AEAL.PayDate = #{PayDate}
		</if>
		<choose>
			<when test="SessionUser != null and SessionUser != ''">
		 		AND AEA.RegisterID = #{SessionUser}
			</when>
			<otherwise>
			    AND AEA.ApplicationStatus NOT IN ('T')
			</otherwise>
		</choose>
		) A
		<trim prefix="ORDER BY"  prefixOverrides =",">
		    <if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				, A.RegistDate DESC
				, A.ApplicationTitle
				, A.ProofCode
				, A.ExpenceApplicationListID 
		    </if>
		  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
			 	<choose>
					<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationStatusName")'>ApplicationStatusName</when>
					<when test='sortColumn.equalsIgnoreCase("RequestTypeName")'>RequestTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("PayDate")'>PayDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofDate")'>ProofDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofCodeName")'>ProofCodeName</when>
					<when test='sortColumn.equalsIgnoreCase("VendorName")'>VendorName</when>
					<when test='sortColumn.equalsIgnoreCase("UsageComment")'>UsageComment</when>
					<when test='sortColumn.equalsIgnoreCase("TaxAmount")'>TaxAmount</when>
					<when test='sortColumn.equalsIgnoreCase("RepAmount")'>RepAmount</when>
					<when test='sortColumn.equalsIgnoreCase("TotalAmount")'>TotalAmount</when>
					<when test='sortColumn.equalsIgnoreCase("Amount")'>Amount</when>
					<when test='sortColumn.equalsIgnoreCase("CostCenterName")'>CostCenterName</when>
					<when test='sortColumn.equalsIgnoreCase("IOName")'>IOName</when>
					<when test='sortColumn.equalsIgnoreCase("AccountName")'>AccountName</when>
					<when test='sortColumn.equalsIgnoreCase("StandardBriefName")'>StandardBriefName</when>
					<otherwise>ApplicationDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
	</select>
	
	<select id="selectExpenceApplicationManDivCnt" resultType="java.lang.Long">
		/*
			expenceApplication.selectExpenceApplicationManDivCnt
		*/
		
		SELECT Count(*)
		
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		LEFT OUTER JOIN covi_smart4j.sys_object_user USR
		ON AEA.RegisterID = USR.UserCode
		LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
		ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
		LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
		ON AEAL.CardUID = CR.ReceiptID
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
		ON AEAL.CashUID = ACB.CashBillID
		WHERE 1=1
		AND AEA.ApplicationStatus != 'DELETE'
			
	  	<if test="DocNo != null and DocNo != ''">
	  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%')
		</if>
		
	  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
		 	AND AEA.ApplicationStatus = #{ApplicationStatus}
		</if>
	  	
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
		</if>
			  	
	  	<if test="ChargeJob != null and ChargeJob != ''">
		 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
		</if>
				
		<if test="RequestType != null and RequestType != ''">
		 	AND AEA.RequestType = #{RequestType}
		</if>
	  	
	  	<if test="ProofCode != null and ProofCode != ''">
		 	AND AEAL.ProofCode = #{ProofCode}
		</if>
	  	
	  	<if test="CompanyCode != null and CompanyCode != ''">
			AND AEA.CompanyCode = #{CompanyCode}
		</if>
		
	  	<if test="ProofDateSt != null and ProofDateSt != ''">
			<![CDATA[
			 	AND AEAL.ProofDate >= #{ProofDateSt}
			]]>
		</if>
	  	<if test="ProofDateEd != null and ProofDateEd != ''">
			<![CDATA[
			 	AND AEAL.ProofDate <= #{ProofDateEd}
			]]>
		</if>
	  	
	  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
			]]>
		</if>
	  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
			]]>
		</if>
	  	
	  	
	  	<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>
	  	
	  	<if test="VendorName != null and VendorName != ''">
		 	AND (
		 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 	)
		</if>
	  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
	  	    <![CDATA[
		 	AND AEAD.Amount > #{SearchAmtSt}
			]]>
		</if>
	  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
	  		<![CDATA[
		 	AND AEAD.Amount < #{SearchAmtEd}
			]]>
		</if>
	  	<if test="AccountCode != null and AccountCode != ''">
		 	AND AEAD.AccountCode = #{AccountCode}
		</if>
	  	<if test="CostCenterCode != null and CostCenterCode != ''">
		 	AND AEAD.CostCenterCode = #{CostCenterCode}
		</if>
	  	<if test="IOCode != null and IOCode != ''">
		 	AND AEAD.IOCode = #{IOCode}
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
		 	AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>
		<if test="PayDate != null and PayDate != ''">
		    AND AEAL.PayDate = #{PayDate}
		</if>
	  	
		<choose>
			<when test="SessionUser != null and SessionUser != ''">
		 		AND AEA.RegisterID = #{SessionUser}
			</when>
			<otherwise>
			    AND AEA.ApplicationStatus NOT IN ('T')
			</otherwise>
		</choose>
	</select>
	
	<select id="selectExpenceApplication" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplication
		*/
		
		SELECT A.ExpenceApplicationID 
			, A.CompanyCode
			, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, #{companyCode}) AS CompanyName
			, A.ApplicationTitle
			, A.ApplicationType
			, A.ApplicationStatus
			, A.RequestType
			, A.RequestTypeName
			, A.ProcessID
			, A.RegisterID
			, A.RegisterName
			, A.maxCdRownum
			, A.TotalAmountSum
			, A.ExpenceApplicationDivID
			, A.ChargeJob
			, A.PayDateType
			, A.AuditReason
			, A.RuleItemInfo
			, DV.IOCode
			, DV.IOName
			, DV.CostCenterCode
			, DV.CostCenterName
			, A.Sub_UR_Code
			, A.Sub_UR_Info
			, A.Sub_UR_Name
			, A.Note
			, A.Currency
			, A.ExchangeRate
			, A.LocalAmount
		FROM 
		(
			SELECT AEA.ExpenceApplicationID 
				, AEA.CompanyCode
				, AEA.ApplicationTitle
				, AEA.ApplicationType
				, AEA.ApplicationStatus
				, AEA.RequestType
				, AEF.FormName AS RequestTypeName
				, AEA.ProcessID
				, AEA.RegisterID
				, USR.MultiDisplayName as RegisterName
				, MAX(AEAL.ExpenceApplicationListID) AS maxCdRownum
				, SUM(AEAL.TotalAmount) AS TotalAmountSum
				, CASE WHEN AEA.ApplicationType ='SC'
					THEN (
						SELECT MAX(AEAD.ExpenceApplicationDivID) ExpenceApplicationDivID
						FROM covi_account4j_si.act_expence_application_div AEAD
						WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					)
					ELSE NULL 
					END AS ExpenceApplicationDivID
				, AEA.ChargeJob
				, AEA.PayDateType
				, AEA.AuditReason
				, AEA.RuleItemInfo
				, AEA.Sub_UR_Code
				, AEA.Sub_UR_Info
				, SUB_USR.MultiDisplayName as Sub_UR_Name
				, AEA.Note
				, AEAL.Currency
				, AEAL.ExchangeRate
				, AEAL.LocalAmount
			FROM covi_account4j_si.act_expence_application AEA
			LEFT OUTER JOIN covi_smart4j.sys_object_user USR
				ON AEA.RegisterID = USR.UserCode
			LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
				ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_expence_application_list AEAL
				ON AEAL.ExpenceApplicationID = AEA.ExpenceApplicationID
			LEFT OUTER JOIN covi_smart4j.sys_object_user SUB_USR
				ON AEA.Sub_UR_Code = SUB_USR.UserCode
			WHERE AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		) A
		LEFT OUTER JOIN covi_account4j_si.act_expence_application_div DV
			ON A.ExpenceApplicationDivID = DV.ExpenceApplicationDivID
	</select>
	
	<select id="selectExpenceApplicationDetailListAll" parameterType="cmap" resultType="cmap">
		/* expenceApplication.selectExpenceApplicationDetailListAll */
		SELECT
			AEA.ApplicationType,
			AEAL.ExpenceApplicationID,
			AEAL.ExpenceApplicationListID,
			AEAL.ExpenceApplicationListID AS cdRownum,
			AEAL.ExpenceApplicationListID AS PaperBillID,
			DATE_FORMAT(AEAL.ProofDate, '%Y%m%d') AS ProofDate, 
			DATE_FORMAT(AEAL.ProofDate, '%Y.%m.%d') AS ProofDateStr,
			DATE_FORMAT(AEAL.PostingDate, '%Y%m%d') AS PostingDate,
			DATE_FORMAT(AEAL.PostingDate, '%Y.%m.%d') AS PostingDateStr,
			AEAL.ProofCode,
			AEAL.CardUID,
			AEAL.TaxUID,
			AEAL.CashUID,
			AEAL.TaxType,
			AEAL.TaxCode,
			AEAL.PayAdjustMethod,
			AEAL.PayMethod,
			AEAL.PayType,
			AEAL.PayTarget,
			AEAL.IncomeTax,
			AEAL.LocalTax,
			DATE_FORMAT(AEAL.PayDate, '%Y%m%d') AS PayDate,
			DATE_FORMAT(AEAL.PayDate, '%Y.%m.%d') AS PayDateStr,
			AEAL.VendorNo,
			AEAL.TotalAmount,
			AEAL.PersonalCardNo, 
			CONCAT('**********', SUBSTRING(AEAL.PersonalCardNo, 11)) AS PersonalCardNoView,
			AEAL.DocNo,
			AEAL.BankCode AS AccountBank,
			AEAL.BankAccountNo AS AccountInfo,
			AEAL.BankAccountName AS AccountHolder,
			AEAL.ReservedStr1,
			AEAL.ReservedStr2,
			AEAL.ReservedStr3,
			AEAL.ReservedStr4,
			AEAL.ReservedStr5,
			AEAL.ReservedInt1,
			AEAL.ReservedInt2,
			DATE_FORMAT(IFNULL(AEAL.RealPayDate, AEAL.PayDate), '%Y.%m.%d') AS RealPayDate,
			AEAL.RealPayAmount,
			AEAL.AlterPayeeNo,
			AEAL.AlterPayeeName,
			AEAL.CreditAccount,
			AEAL.DebitAccount,
			AEAL.ProviderNo,
			AEAL.ProviderName,
			AEAL.Providee,
			AEAL.BillType,
			AEAL.TaxAmount AS Tax,
			AEAL.RepAmount AS SupplyCost,
			IFNULL(CR.RepAmount, AEAL.RepAmount) AS RepAmount,
			IFNULL(CR.TaxAmount, AEAL.TaxAmount) AS TaxAmount,
			(
				SELECT 
					MAX(ExpenceApplicationDivID) 
				FROM 
					covi_account4j_si.act_expence_application_div AEAD 
				WHERE 
					AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			) AS maxDivRownum,
			(
				SELECT 
					CASE 
						WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
						ELSE SUM(AEAD.Amount) 
					END
				FROM 
					covi_account4j_si.act_expence_application_div AEAD 
				WHERE 
					AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			) AS divSum,
			'N' AS IsNewStr,
			/* 법인카드 */
			CR.ServiceAmount,
			CR.ApproveNo AS CardApproveNo,
			TIME_FORMAT(CR.ApproveTime, '%H%i%s') AS ProofTime,
			TIME_FORMAT(CR.ApproveTime, '%H:%i:%s') AS ProofTimeStr,
			CR.ReceiptID,
			CR.ItemNo,
			CR.CardNo,
			CR.StoreName,
			CR.StoreNo,
			CR.StoreCondition,
			CR.StoreAddress1 || CR.StoreAddress2 AS StoreAddress,
			CR.StoreTel,
			CR.StoreCategory,
			/* 전자세금계산서 */
			ATI.NTSConfirmNum AS TaxNTSConfirmNum,
			ATI.TaxInvoiceID,
			ATI.TaxInvoiceID AS TaxUID,
			ATI.InvoicerCorpNum,
			ATI.InvoicerCorpName,
			ATI.InvoicerCEOName,
			ATI.InvoicerAddr,
			ATI.InvoicerBizType,
			ATI.InvoicerBizClass,
			ATI.InvoiceeCorpNum,
			ATI.InvoiceeCorpName,
			ATI.InvoiceeCEOName,
			ATI.InvoiceeAddr,
			ATI.InvoiceeBizType,
			ATI.InvoiceeBizClass,
			ATI.TotalAmount,
			ATI.Remark1 AS Remark,
			ATI.PurposeType,
			DATE_FORMAT(ATI.WriteDate,'%Y.%m.%d') AS FormatWriteDate,
			( 
				SELECT 
					ATII.ItemName 
				FROM 
					covi_account4j_si.act_taxinvoice_item ATII 
				WHERE 
					ATI.TaxInvoiceID = ATII.TaxInvoiceID 
				LIMIT 1
			) AS ItemName,
			/* 현금영수증 */
			CB.NTSConfirmNum AS CashNTSConfirmNum,
			CB.TradeDT,
			CB.TradeType,
			CB.SupplyCost,
			CB.Tax,
			CB.ServiceFree,
			CB.TotalAmount,
			CB.FranchiseCorpName,
			CB.CashBillID,
			/* 모바일영수증 */
			AR.CompanyCode, 
			AR.ExpenceMgmtCode, 
			SF.FileID,
			SF.SavedName,
			SF.FilePath,
			SF.FileName,
			CONCAT(REPLACE(ST.FilePath, '{0}', SF.CompanyCode), SF.FilePath, SF.SavedName) FullPath,
			/* 거래처 */
			VD.VendorID,
			CASE 
				WHEN AEAL.ProofCode = 'TaxBill' THEN IFNULL(VD.VendorName, ATI.InvoicerCorpName)
				WHEN AEAL.ProofCode = 'CashBill'THEN IFNULL(VD.VendorName, CB.FranchiseCorpName)
				ELSE VD.VendorName
			END AS VendorName,
			CASE 
				WHEN AEAL.ProofCode = 'TaxBill' THEN IFNULL(VD.VendorNo, ATI.InvoicerCorpNum)
				WHEN AEAL.ProofCode = 'CashBill'THEN IFNULL(VD.VendorNo, CB.FranchiseCorpNum)
				ELSE VD.VendorName
			END AS VendorNo,
			CASE 
				WHEN AEAL.ProofCode = 'TaxBill' THEN IFNULL(VD.BusinessNumber, ATI.InvoicerCorpNum)
				WHEN AEAL.ProofCode = 'CashBill'THEN IFNULL(VD.BusinessNumber, CB.FranchiseCorpNum)
				ELSE VD.VendorName
			END AS BusinessNumber,
			VD.CorporateNo,
			VD.CEOName,
			VD.Address,
			VD.Industry,
			VD.Sector,
			AEAL.BankCode AS BankCode,
			covi_account4j_si.Fn_GetBaseCodeName('Bank', AEAL.BankCode, #{companyCode}) AS BankName,
			AEAL.BankAccountNo AS BankAccountNo,
			AEAL.BankAccountName AS BankAccountName,
			CONCAT(AEAL.BankAccountName, '/', AEAL.BankAccountNo) AS BankAccountInfo,
			VD.PaymentCondition,
			covi_account4j_si.Fn_GetBaseCodeName('PayType', VD.PaymentCondition, #{companyCode}) PaymentConditionName,
			(
				SELECT 
					COUNT(*) 
				FROM 
					covi_account4j_si.act_vendor SBV 
				WHERE 
					SBV.BusinessNumber = ATI.InvoicerCorpNum
			) AS BusinessNumberCnt
		FROM
			covi_account4j_si.act_expence_application AEA
		INNER JOIN
			covi_account4j_si.act_expence_application_list AEAL
		ON
			AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		LEFT OUTER JOIN
			covi_account4j_si.act_card_receipt CR
		ON 
			AEAL.CardUID = CR.ReceiptID
		LEFT OUTER JOIN 
			covi_account4j_si.act_taxinvoice ATI
		ON 
			AEAL.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN 
			covi_account4j_si.act_cashbill CB
		ON 
			AEAL.CashUID = CB.CashBillID
		LEFT OUTER JOIN 
			covi_account4j_si.act_receipt AR
		ON 
			AEAL.ReceiptID = AR.ReceiptID
		LEFT OUTER JOIN 
			covi_smart4j.sys_file SF
		ON 
			AR.ReceiptFileID = SF.FileID
		LEFT OUTER JOIN 
			covi_smart4j.sys_storage ST 
		ON 
			ST.StorageID = SF.StorageID
		LEFT OUTER JOIN 
			covi_account4j_si.act_vendor VD
		ON 
			AEAL.VendorNo = VD.VendorNo AND AEA.CompanyCode = VD.CompanyCode
		WHERE 
			1 = 1
			<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
				AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
			</if>
			<if test="expAppListIDs != null">
				AND 
				<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEALCC.ExpenceApplicationListID IN (" close=")">
					#{item}
				</foreach>
			</if>
	</select>
	
	<!-- 미사용 -->
	<select id="selectExpenceApplicationDetailList" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDetailList
		*/
		SELECT AEAL.ExpenceApplicationListID
			, AEAL.ExpenceApplicationListID cdRownum
			, AEAL.ExpenceApplicationID
			, AEAL.ProofDate
			, AEAL.ProofCode
			, AEAL.CardUID
			, AEAL.CashUID
			, AEAL.TaxUID
			, AEAL.PostingDate
			, AEAL.TaxType
			, AEAL.TaxCode
			, AEAL.PayAdjustMethod
			, AEAL.PayMethod
			, AEAL.IsWithholdingTax
			, AEAL.IncomeTax
			, AEAL.LocalTax
			, AEAL.PayDate
			, AEAL.VendorNo
			, AEAL.TotalAmount
			, (SELECT MAX(ExpenceApplicationDivID) FROM covi_account4j_si.act_expence_application_div AEAD WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) maxDivRownum
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		WHERE AEA.ExpenceApplicationID = #{ExpenceApplicationID}
	</select>

	<select id="selectExpenceApplicationDetailListCC" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDetailListCC
		*/
				
		SELECT AEALCC.ExpenceApplicationListID
			, AEALCC.ExpenceApplicationListID cdRownum
			, AEALCC.ExpenceApplicationID
			, AEA.ApplicationType
			, DATE_FORMAT( AEALCC.ProofDate, '%Y%m%d') AS ProofDate 
			, DATE_FORMAT( AEALCC.ProofDate, '%Y.%m.%d') AS ProofDateStr
			, DATE_FORMAT( AEALCC.PostingDate, '%Y%m%d') AS PostingDate
			, DATE_FORMAT( AEALCC.PostingDate, '%Y.%m.%d') AS PostingDateStr
			, AEALCC.ProofCode
			, AEALCC.CardUID
			, AEALCC.TaxType
			, AEALCC.TaxCode
			, covi_account4j_si.Fn_GetBaseCodeName('TaxType', AEALCC.TaxType, #{companyCode}) TaxTypeName
			, covi_account4j_si.Fn_GetBaseCodeName('TaxCode', AEALCC.TaxCode, #{companyCode}) TaxCodeName
			, AEALCC.PayAdjustMethod
			, AEALCC.PayMethod
			, AEALCC.IsWithholdingTax
			, AEALCC.IncomeTax
			, AEALCC.LocalTax
			, DATE_FORMAT( AEALCC.PayDate, '%Y%m%d') AS PayDate
			, DATE_FORMAT( AEALCC.PayDate, '%Y.%m.%d') AS PayDateStr
			, AEALCC.VendorNo
			, AEALCC.TotalAmount
			, AEALCC.DocNo
			, AEALCC.BankCode AS AccountBank
			, AEALCC.BankAccountNo AS AccountInfo
			, AEALCC.BankAccountName AS AccountHolder
			, AEALCC.ReservedStr1
			, AEALCC.ReservedStr2
			, AEALCC.ReservedStr3
			, AEALCC.ReservedStr4
			, AEALCC.ReservedStr5
			, AEALCC.ReservedInt1
			, AEALCC.ReservedInt2
			, DATE_FORMAT(IFNULL(AEALCC.RealPayDate, AEALCC.PayDate), '%Y.%m.%d') AS RealPayDate
			, AEALCC.RealPayAmount
			
			, IFNULL(CR.RepAmount, AEALCC.RepAmount) AS RepAmount
			, IFNULL(CR.TaxAmount, AEALCC.TaxAmount) AS TaxAmount
			, CR.ServiceAmount
			, CR.ApproveNo CardApproveNo
			, TIME_FORMAT( CR.ApproveTime, '%H%i%s') AS ProofTime
			, TIME_FORMAT( CR.ApproveTime, '%H:%i:%s') AS ProofTimeStr
			, CR.ReceiptID
			, CR.ItemNo
			, CR.CardNo
			, CR.StoreName
			, CR.StoreNo
			, CR.StoreCondition
			, CR.StoreAddress1 || CR.StoreAddress2 AS StoreAddress
			, CR.StoreTel
			, CR.StoreCategory
			, (SELECT MAX(ExpenceApplicationDivID) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALCC.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) maxDivRownum
			, (SELECT SUM(AEAD.Amount) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALCC.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) divSum
			, 'N' as IsNewStr
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEALCC
		ON AEA.ExpenceApplicationID = AEALCC.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
		ON AEALCC.CardUID = CR.ReceiptID
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEALCC.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
		AND AEALCC.ProofCode = 'CorpCard'
	</select>	
	<select id="selectExpenceApplicationDetailListTB" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDetailListTB
		*/
		SELECT AEALTB.ExpenceApplicationListID
			, AEALTB.ExpenceApplicationListID cdRownum
			, AEALTB.ExpenceApplicationID
			, AEA.ApplicationType
			, DATE_FORMAT( AEALTB.ProofDate, '%Y%m%d') AS ProofDate
			, DATE_FORMAT( AEALTB.ProofDate, '%Y.%m.%d') AS ProofDateStr
			, DATE_FORMAT( AEALTB.PostingDate, '%Y%m%d') AS PostingDate
			, DATE_FORMAT( AEALTB.PostingDate, '%Y.%m.%d') AS PostingDateStr
			, AEALTB.ProofCode
			, AEALTB.TaxUID
			, AEALTB.TaxType
			, AEALTB.TaxCode
			, AEALTB.PayAdjustMethod
			, AEALTB.PayMethod
			, AEALTB.PayType
			, AEALTB.PayTarget
			, AEALTB.IsWithholdingTax
			, AEALTB.IncomeTax
			, AEALTB.LocalTax
			, DATE_FORMAT( AEALTB.PayDate, '%Y%m%d') AS PayDate
			, DATE_FORMAT( AEALTB.PayDate, '%Y.%m.%d') AS PayDateStr
			, AEALTB.VendorNo
			, AEALTB.TotalAmount
			, AEALTB.DocNo
			, AEALTB.BankCode AS AccountBank
			, AEALTB.BankAccountNo AS AccountInfo
			, AEALTB.BankAccountName AS AccountHolder
			, AEALTB.ReservedStr1
			, AEALTB.ReservedStr2
			, AEALTB.ReservedStr3
			, AEALTB.ReservedStr4
			, AEALTB.ReservedStr5
			, AEALTB.ReservedInt1
			, AEALTB.ReservedInt2
			, DATE_FORMAT(IFNULL(AEALTB.RealPayDate, AEALTB.PayDate), '%Y.%m.%d') AS RealPayDate
			, AEALTB.RealPayAmount
			, AEALTB.AlterPayeeNo
			, AEALTB.AlterPayeeName
			, AEALTB.CreditAccount
			, AEALTB.DebitAccount
			
			, ATI.NTSConfirmNum TaxNTSConfirmNum
			, ATI.TaxInvoiceID
			, ATI.TaxInvoiceID TaxUID
			, ATI.InvoicerCorpNum
			, ATI.InvoicerCorpName
			, ATI.InvoicerCEOName
			, ATI.InvoicerAddr
			, ATI.InvoicerBizType
			, ATI.InvoicerBizClass
			, ATI.InvoiceeCorpNum
			, ATI.InvoiceeCorpName
			, ATI.InvoiceeCEOName
			, ATI.InvoiceeAddr
			, ATI.InvoiceeBizType
			, ATI.InvoiceeBizClass
			, ATI.TotalAmount
			, ATI.Remark1 Remark
			, ATI.PurposeType
			, DATE_FORMAT(ATI.WriteDate,'%Y.%m.%d')	AS FormatWriteDate
		    , ( SELECT ATII.ItemName FROM covi_account4j_si.act_taxinvoice_item ATII WHERE ATI.TaxInvoiceID = ATII.TaxInvoiceID LIMIT 1) AS ItemName
			
			, AEALTB.TaxAmount AS Tax
			, AEALTB.RepAmount AS SupplyCost
			, AEALTB.TaxAmount AS TaxAmount
			, AEALTB.RepAmount AS RepAmount
			
			, VD.VendorID
			, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
			, IFNULL(VD.VendorNo, ATI.InvoicerCorpNum) AS VendorNo
			, IFNULL(VD.BusinessNumber, ATI.InvoicerCorpNum) AS BusinessNumber
			, VD.CEOName
			, VD.Address
			, VD.Industry
			, VD.Sector
			, AEALTB.BankCode AS BankCode
			, covi_account4j_si.Fn_GetBaseCodeName('Bank', AEALTB.BankCode, #{companyCode}) AS BankName
			, AEALTB.BankAccountNo AS BankAccountNo
			, AEALTB.BankAccountName AS BankAccountName
			, VD.PaymentCondition
			, covi_account4j_si.Fn_GetBaseCodeName('PayType', VD.PaymentCondition, #{companyCode}) PaymentConditionName
			, (SELECT MAX(ExpenceApplicationDivID) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALTB.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) maxDivRownum
			, (SELECT 
					CASE 
						WHEN (AEALTB.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEALTB.TotalAmount) THEN SUM(AEAD.Amount) + AEALTB.TaxAmount 
						ELSE SUM(AEAD.Amount) 
					END
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALTB.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) divSum
			, 'N' as IsNewStr
		    , ( SELECT COUNT(*) FROM covi_account4j_si.act_vendor SBV WHERE SBV.BusinessNumber = ATI.InvoicerCorpNum) AS BusinessNumberCnt
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEALTB
		ON AEA.ExpenceApplicationID = AEALTB.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEALTB.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEALTB.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>	
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEALTB.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
		AND AEALTB.ProofCode = 'TaxBill'
	</select>	
	
	<select id="selectExpenceApplicationDetailListPB" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDetailListPB
		*/
			
		SELECT AEALPB.ExpenceApplicationListID
			, AEALPB.ExpenceApplicationListID cdRownum
			, AEALPB.ExpenceApplicationListID PaperBillID
			, AEALPB.ExpenceApplicationID
			, AEA.ApplicationType
			, DATE_FORMAT(AEALPB.ProofDate, '%Y%m%d') AS ProofDate
			, DATE_FORMAT(AEALPB.ProofDate, '%Y.%m.%d') AS ProofDateStr
			, DATE_FORMAT(AEALPB.PostingDate, '%Y%m%d') AS PostingDate
			, DATE_FORMAT(AEALPB.PostingDate, '%Y.%m.%d') AS PostingDateStr
			, AEALPB.ProofCode
			, AEALPB.TaxType
			, AEALPB.TaxCode
			, AEALPB.PayAdjustMethod
			, AEALPB.PayMethod
			, AEALPB.PayType
			, AEALPB.PayTarget
			, DATE_FORMAT(AEALPB.PayDate, '%Y%m%d') AS PayDate
			, DATE_FORMAT(AEALPB.PayDate, '%Y.%m.%d') AS PayDateStr
			, AEALPB.VendorNo
			, AEALPB.TotalAmount
			, AEALPB.RepAmount
			, AEALPB.TaxAmount
			, AEALPB.DocNo
			, AEALPB.BankCode AS AccountBank
			, AEALPB.BankAccountNo AS AccountInfo
			, AEALPB.BankAccountName AS AccountHolder
			, AEALPB.ReservedStr1
			, AEALPB.ReservedStr2
			, AEALPB.ReservedStr3
			, AEALPB.ReservedStr4
			, AEALPB.ReservedStr5
			, AEALPB.ReservedInt1
			, AEALPB.ReservedInt2
			, DATE_FORMAT(IFNULL(AEALPB.RealPayDate, AEALPB.PayDate), '%Y.%m.%d') AS RealPayDate
			, AEALPB.AlterPayeeNo
			, AEALPB.AlterPayeeName
			, AEALPB.CreditAccount
			, AEALPB.DebitAccount
			, AEALPB.RealPayAmount
			, AEALPB.ProviderNo
			, AEALPB.ProviderName
			, AEALPB.Providee
			, AEALPB.BillType
			
			, VD.VendorID
			, VD.VendorNo
			, VD.BusinessNumber
			, VD.CorporateNo
			, VD.VendorName
			, VD.CEOName
			, VD.Industry
			, VD.Sector
			, VD.Address
			, AEALPB.BankCode AS BankCode
			, covi_account4j_si.Fn_GetBaseCodeName('Bank', AEALPB.BankCode, #{companyCode}) AS BankName
			, AEALPB.BankAccountNo AS BankAccountNo
			, AEALPB.BankAccountName AS BankAccountName
			, CONCAT(AEALPB.BankAccountName, '/', AEALPB.BankAccountNo) AS BankAccountInfo
			, VD.PaymentCondition
			, covi_account4j_si.Fn_GetBaseCodeName('PayType', VD.PaymentCondition, #{companyCode}) PaymentConditionName
			, (
				SELECT MAX(ExpenceApplicationDivID) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALPB.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			) maxDivRownum
			, (
				SELECT SUM(AEAD.Amount) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALPB.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			) divSum
			, 'N' as IsNewStr
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEALPB
		ON AEA.ExpenceApplicationID = AEALPB.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEALPB.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEALPB.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
		AND AEALPB.ProofCode = 'PaperBill'
	</select>	
				
	<select id="selectExpenceApplicationDetailListCB" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDetailListCB
		*/
		SELECT AEALCB.ExpenceApplicationListID
			, AEALCB.ExpenceApplicationListID cdRownum
			, AEALCB.ExpenceApplicationID
			, AEA.ApplicationType
			, DATE_FORMAT( AEALCB.ProofDate, '%Y%m%d') AS ProofDate
			, DATE_FORMAT( AEALCB.ProofDate, '%Y.%m.%d') AS ProofDateStr
			, DATE_FORMAT( AEALCB.PostingDate, '%Y%m%d') AS PostingDate
			, DATE_FORMAT( AEALCB.PostingDate, '%Y.%m.%d') AS PostingDateStr
			, AEALCB.ProofCode
			, AEALCB.CashUID
			, AEALCB.TaxType
			, AEALCB.TaxCode
			, AEALCB.PayAdjustMethod
			, AEALCB.PayMethod
			, AEALCB.PayType
			, AEALCB.PayTarget
			, AEALCB.IsWithholdingTax
			, AEALCB.IncomeTax
			, AEALCB.LocalTax
			, DATE_FORMAT( AEALCB.PayDate, '%Y%m%d') AS PayDate
			, DATE_FORMAT( AEALCB.PayDate, '%Y.%m.%d') AS PayDateStr
			, AEALCB.VendorNo
			, AEALCB.TotalAmount
			, AEALCB.DocNo
			, AEALCB.BankCode AS AccountBank
			, AEALCB.BankAccountNo AS AccountInfo
			, AEALCB.BankAccountName AS AccountHolder
			, AEALCB.ReservedStr1
			, AEALCB.ReservedStr2
			, AEALCB.ReservedStr3
			, AEALCB.ReservedStr4
			, AEALCB.ReservedStr5
			, AEALCB.ReservedInt1
			, AEALCB.ReservedInt2
			, DATE_FORMAT(IFNULL(AEALCB.RealPayDate, AEALCB.PayDate), '%Y.%m.%d') AS RealPayDate
			, AEALCB.RealPayAmount
			, AEALCB.AlterPayeeNo
			, AEALCB.AlterPayeeName
			, AEALCB.CreditAccount
			, AEALCB.DebitAccount
			
			, CB.NTSConfirmNum AS CashNTSConfirmNum
			, CB.TradeDT
			, CB.TradeType
			, CB.SupplyCost
			, CB.Tax
			, CB.ServiceFree
			, CB.TotalAmount
			, CB.FranchiseCorpName
			, CB.CashBillID
			
			, VD.VendorID
			, VD.CorporateNo
			, IFNULL(VD.VendorName, CB.FranchiseCorpName) AS VendorName
			, IFNULL(VD.VendorNo, CB.FranchiseCorpNum) AS VendorNo
			, IFNULL(VD.BusinessNumber, CB.FranchiseCorpNum) AS BusinessNumber
			, VD.CEOName
			, VD.Industry
			, VD.Sector
			, VD.Address
			, AEALCB.BankCode AS BankCode
			, covi_account4j_si.Fn_GetBaseCodeName('Bank', AEALCB.BankCode, #{companyCode}) AS BankName
			, AEALCB.BankAccountNo AS BankAccountNo
			, AEALCB.BankAccountName AS BankAccountName
			, VD.PaymentCondition
			, covi_account4j_si.Fn_GetBaseCodeName('PayType', VD.PaymentCondition, #{companyCode}) PaymentConditionName
			, (SELECT MAX(ExpenceApplicationDivID) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALCB.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) maxDivRownum
			, (SELECT SUM(AEAD.Amount) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALCB.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) divSum
			, 'N' as IsNewStr
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEALCB
		ON AEA.ExpenceApplicationID = AEALCB.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_cashbill CB
		ON AEALCB.CashUID = CB.CashBillID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEALCB.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEALCB.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
		AND AEALCB.ProofCode = 'CashBill'
	</select>	
			
	<select id="selectExpenceApplicationDetailListPC" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDetailListPC
		*/
			
		SELECT AEALPC.ExpenceApplicationListID
			, AEALPC.ExpenceApplicationListID cdRownum
			, AEALPC.ExpenceApplicationListID ExpAppPrivID
			, AEALPC.ExpenceApplicationID
			, AEA.ApplicationType
			, DATE_FORMAT( AEALPC.ProofDate, '%Y%m%d') AS ProofDate
			, DATE_FORMAT( AEALPC.ProofDate, '%Y.%m.%d') AS ProofDateStr
			, DATE_FORMAT( AEALPC.PostingDate, '%Y%m%d') AS PostingDate
			, DATE_FORMAT( AEALPC.PostingDate, '%Y.%m.%d') AS PostingDateStr
			, AEALPC.ProofCode
			, AEALPC.TaxType
			, AEALPC.TaxCode
			, AEALPC.PayAdjustMethod
			, AEALPC.PayMethod
			, AEALPC.PayType
			, AEALPC.PayTarget
			, DATE_FORMAT( AEALPC.PayDate, '%Y%m%d') AS PayDate
			, DATE_FORMAT( AEALPC.PayDate, '%Y.%m.%d') AS PayDateStr
			, AEALPC.VendorNo
			, AEALPC.TotalAmount
			, AEALPC.PersonalCardNo
			, CONCAT('**********',	SUBSTRING(AEALPC.PersonalCardNo,11))	PersonalCardNoView
			, AEALPC.DocNo
			, AEALPC.BankCode AS AccountBank
			, AEALPC.BankAccountNo AS AccountInfo
			, AEALPC.BankAccountName AS AccountHolder
			, AEALPC.ReservedStr1
			, AEALPC.ReservedStr2
			, AEALPC.ReservedStr3
			, AEALPC.ReservedStr4
			, AEALPC.ReservedStr5
			, AEALPC.ReservedInt1
			, AEALPC.ReservedInt2
			, DATE_FORMAT(IFNULL(AEALPC.RealPayDate, AEALPC.PayDate), '%Y.%m.%d') AS RealPayDate
			, AEALPC.RealPayAmount
			, AEALPC.AlterPayeeNo
			, AEALPC.AlterPayeeName
			, AEALPC.CreditAccount
			, AEALPC.DebitAccount
			
			, VD.VendorID
			, VD.VendorNo
			, VD.BusinessNumber
			, VD.CorporateNo
			, VD.VendorName
			, VD.CEOName
			, VD.Industry
			, VD.Sector
			, VD.Address
			, AEALPC.BankCode AS BankCode
			, covi_account4j_si.Fn_GetBaseCodeName('Bank', AEALPC.BankCode, #{companyCode}) AS BankName
			, AEALPC.BankAccountNo AS BankAccountNo
			, AEALPC.BankAccountName AS BankAccountName
			, VD.PaymentCondition
			, covi_account4j_si.Fn_GetBaseCodeName('PayType', VD.PaymentCondition, #{companyCode}) PaymentConditionName
			, (SELECT MAX(ExpenceApplicationDivID) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALPC.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) maxDivRownum
			, (SELECT SUM(AEAD.Amount) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALPC.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) divSum
			, 'N' as IsNewStr
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEALPC
			ON AEA.ExpenceApplicationID = AEALPC.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON AEALPC.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>	
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEALPC.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
		AND AEALPC.ProofCode = 'PrivateCard'
	</select>	
		
			
	<select id="selectExpenceApplicationDetailListEE" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDetailListEE
		*/
			
		SELECT AEALEE.ExpenceApplicationListID
			, AEALEE.ExpenceApplicationListID cdRownum
			, AEALEE.ExpenceApplicationListID ExpAppEtcID
			, AEALEE.ExpenceApplicationID
			, AEA.ApplicationType
			, DATE_FORMAT( AEALEE.ProofDate, '%Y%m%d') AS ProofDate
			, DATE_FORMAT( AEALEE.ProofDate, '%Y.%m.%d') AS ProofDateStr
			, DATE_FORMAT( AEALEE.PostingDate, '%Y%m%d') AS PostingDate
			, DATE_FORMAT( AEALEE.PostingDate, '%Y.%m.%d') AS PostingDateStr
			, AEALEE.ProofCode
			, AEALEE.TaxType
			, AEALEE.TaxCode
			, AEALEE.PayAdjustMethod
			, AEALEE.PayMethod
			, AEALEE.PayType
			, AEALEE.PayTarget
			, AEALEE.IsWithholdingTax
			, AEALEE.IncomeTax
			, AEALEE.LocalTax
			, DATE_FORMAT( AEALEE.PayDate, '%Y%m%d') AS PayDate
			, DATE_FORMAT( AEALEE.PayDate, '%Y.%m.%d') AS PayDateStr
			, AEALEE.VendorNo
			, AEALEE.TotalAmount
			, AEALEE.RepAmount
			, AEALEE.TaxAmount
			, AEALEE.DocNo
			, AEALEE.BankCode AS AccountBank
			, AEALEE.BankAccountNo AS AccountInfo
			, AEALEE.BankAccountName AS AccountHolder
			, AEALEE.ReservedStr1
			, AEALEE.ReservedStr2
			, AEALEE.ReservedStr3
			, AEALEE.ReservedStr4
			, AEALEE.ReservedStr5
			, AEALEE.ReservedInt1
			, AEALEE.ReservedInt2
			, DATE_FORMAT(IFNULL(AEALEE.RealPayDate, AEALEE.PayDate), '%Y.%m.%d') AS RealPayDate
			, AEALEE.RealPayAmount
			, AEALEE.AlterPayeeNo
			, AEALEE.AlterPayeeName
			, AEALEE.CreditAccount
			, AEALEE.DebitAccount
			
			, VD.VendorID
			, VD.VendorNo
			, VD.BusinessNumber
			, VD.CorporateNo
			, VD.VendorName
			, VD.CEOName
			, VD.Industry
			, VD.Sector
			, VD.Address
			, AEALEE.BankCode AS BankCode
			, covi_account4j_si.Fn_GetBaseCodeName('Bank', AEALEE.BankCode, #{companyCode}) AS BankName
			, AEALEE.BankAccountNo AS BankAccountNo
			, AEALEE.BankAccountName AS BankAccountName
			, CONCAT(AEALEE.BankAccountName, '/', AEALEE.BankAccountNo) AS BankAccountInfo
			, VD.PaymentCondition
			, covi_account4j_si.Fn_GetBaseCodeName('PayType', VD.PaymentCondition, #{companyCode}) PaymentConditionName
			, (SELECT MAX(ExpenceApplicationDivID) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALEE.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) maxDivRownum
			, (SELECT SUM(AEAD.Amount) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALEE.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) divSum
			, 'N' as IsNewStr
			, AEALEE.EmpInsurance
			, AEALEE.AccidInsurance
			, AEALEE.Currency
			, AEALEE.ExchangeRate
			, AEALEE.LocalAmount
			, AEALEE.WorkingDay
			, AEALEE.ActualDay
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEALEE
		ON AEA.ExpenceApplicationID = AEALEE.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEALEE.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>	
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEALEE.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
		AND AEALEE.ProofCode = 'EtcEvid'
	</select>	
		
	<select id="selectExpenceApplicationDetailListMR" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDetailListMR
		*/
			
		SELECT AEALMR.ExpenceApplicationListID
			, AEALMR.ExpenceApplicationListID cdRownum
			, AEALMR.ExpenceApplicationListID ExpAppRcptID
			, AEALMR.ExpenceApplicationID
			, AEA.ApplicationType
			, DATE_FORMAT( AEALMR.ProofDate, '%Y%m%d') AS ProofDate
			, DATE_FORMAT( AEALMR.ProofDate, '%Y.%m.%d') AS ProofDateStr
			, DATE_FORMAT( AEALMR.PostingDate, '%Y%m%d') AS PostingDate
			, DATE_FORMAT( AEALMR.PostingDate, '%Y.%m.%d') AS PostingDateStr
			, AEALMR.ProofCode
			, AEALMR.TaxType
			, AEALMR.TaxCode
			, AEALMR.PayAdjustMethod
			, AEALMR.PayMethod
			, AEALMR.PayType
			, AEALMR.PayTarget
			, AEALMR.IsWithholdingTax
			, AEALMR.IncomeTax
			, AEALMR.LocalTax
			, DATE_FORMAT( AEALMR.PayDate, '%Y%m%d') AS PayDate
			, DATE_FORMAT( AEALMR.PayDate, '%Y.%m.%d') AS PayDateStr
			, AEALMR.VendorNo
			, AEALMR.TotalAmount
			, AEALMR.ReceiptID
			, AEALMR.PersonalCardNo
			, CONCAT('**********',	SUBSTRING(AEALMR.PersonalCardNo,11))	PersonalCardNoView
			, AEALMR.DocNo
			, AEALMR.BankCode AS AccountBank
			, AEALMR.BankAccountNo AS AccountInfo
			, AEALMR.BankAccountName AS AccountHolder	
			, AEALMR.ReservedStr1
			, AEALMR.ReservedStr2
			, AEALMR.ReservedStr3
			, AEALMR.ReservedStr4
			, AEALMR.ReservedStr5
			, AEALMR.ReservedInt1
			, AEALMR.ReservedInt2
			, DATE_FORMAT(IFNULL(AEALMR.RealPayDate, AEALMR.PayDate), '%Y.%m.%d') AS RealPayDate
			, AEALMR.RealPayAmount		
			, AEALMR.AlterPayeeNo
			, AEALMR.AlterPayeeName
			, AEALMR.CreditAccount
			, AEALMR.DebitAccount	
		
			, AR.CompanyCode
			, AR.ExpenceMgmtCode
			
			, VD.VendorID
			, VD.VendorNo
			, VD.VendorName
			, VD.BusinessNumber
			, VD.CorporateNo
			, VD.CEOName
			, VD.Industry
			, VD.Sector
			, VD.Address
			, AEALMR.BankCode AS BankCode
			, covi_account4j_si.Fn_GetBaseCodeName('Bank', AEALMR.BankCode, #{companyCode}) AS BankName
			, AEALMR.BankAccountNo AS BankAccountNo
			, AEALMR.BankAccountName AS BankAccountName
			, CONCAT(AEALMR.BankAccountName, '/', AEALMR.BankAccountNo) AS BankAccountInfo
			, VD.PaymentCondition
			, covi_account4j_si.Fn_GetBaseCodeName('PayType', VD.PaymentCondition, #{companyCode}) PaymentConditionName
			
			, SF.FileID
			, SF.SavedName
			, SF.FilePath
			, SF.FileName
			, CONCAT(REPLACE(ST.FilePath,'{0}',SF.CompanyCode), SF.FilePath, SF.SavedName) FullPath
		
			, (SELECT MAX(ExpenceApplicationDivID) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALMR.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) maxDivRownum
			, (SELECT SUM(AEAD.Amount) 
				FROM covi_account4j_si.act_expence_application_div AEAD 
				WHERE AEALMR.ExpenceApplicationListID = AEAD.ExpenceApplicationListID) divSum
			, 'N' as IsNewStr
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEALMR
		ON AEA.ExpenceApplicationID = AEALMR.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEALMR.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		LEFT OUTER JOIN covi_account4j_si.act_receipt AR
		ON AEALMR.ReceiptID = AR.ReceiptID
		LEFT OUTER JOIN covi_smart4j.sys_file SF
		ON AR.ReceiptFileID = SF.FileID
		LEFT OUTER JOIN covi_smart4j.sys_storage ST ON ST.StorageID = SF.StorageID
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEALMR.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
		AND AEALMR.ProofCode = 'Receipt'
	</select>	
	
	
	
	<select id="selectExpenceApplicationDailyList" parameterType="cmap" resultType="cmap">
		SELECT ABD.BizTripDailyID
			, AEAL.ExpenceApplicationListID
			, AEAL.ExpenceApplicationID
			, ABD.BizTripDateSt
			, ABD.BizTripDateEd
			, ABD.DailyType
			, ABD.DailyAmount
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_biztrip_daily ABD
		ON AEAL.ExpenceApplicationListID = ABD.ExpenceApplicationListID
		WHERE AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		ORDER BY AEAL.ExpenceApplicationListID, ABD.BizTripDailyID
	</select>
	
	<select id="selectExpenceApplicationFuelList" parameterType="cmap" resultType="cmap">
		SELECT ABF.BizTripFuelID
			, AEAL.ExpenceApplicationListID
			, AEAL.ExpenceApplicationID
			, ABF.BizTripDate
			, DATE_FORMAT(ABF.BizTripDate,'%Y.%m.%d') AS BizTripDateStr
			, ABF.StartPoint
			, ABF.EndPoint
			, ABF.FuelType
			, ABF.Distance
			, ABF.UnitPrice AS FuelUnitPrice
			, ABF.RealPrice AS FuelRealPrice
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_biztrip_fuel ABF
		ON AEAL.ExpenceApplicationListID = ABF.ExpenceApplicationListID
		WHERE AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		ORDER BY AEAL.ExpenceApplicationListID, ABF.BizTripFuelID
	</select>
	
	 
	<select id="selectExpenceApplicationDiv" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDiv
		*/
		SELECT AEAD.ExpenceApplicationDivID
			, AEAD.ExpenceApplicationDivID Rownum
			, AEAL.ExpenceApplicationListID
			, AEAL.ExpenceApplicationID
			, AEAL.DocNo
			, AEAL.ProofDate
			, AEAD.AccountCode
			, AEAD.AccountName
			, AEAD.CostCenterCode
			, AEAD.CostCenterName
			, AEAD.IOCode
			, AEAD.IOName
			, AEAD.Amount
			, AEAD.UsageComment
			, AEAD.StandardBriefID
			, AEAD.StandardBriefName
			, AEAD.ReservedStr1 AS ReservedStr1_Div
			, AEAD.ReservedStr2 AS ReservedStr2_Div
			, AEAD.ReservedStr3 AS ReservedStr3_Div
			, AEAD.ReservedStr4 AS ReservedStr4_Div
			, AEAD.ReservedStr5 AS ReservedStr5_Div
			, AEAD.ReservedInt1 AS ReservedInt1_Div
			, AEAD.ReservedInt2 AS ReservedInt2_Div
			, AEA.RequestType
			, AEA.RegisterID
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si. act_expence_application_div AEAD
			ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		/*
		LEFT OUTER JOIN covi_account4j_si.act_account AA
			ON AEAD.AccountCode = AA.AccountCode
		LEFT OUTER JOIN covi_account4j_si.act_cost_center CC
			 ON AEAD.CostCenterCode = CC.CostCenterCode
		LEFT OUTER JOIN covi_account4j_si.act_standard_brief SB
			 ON AEAD.StandardBriefID = SB.StandardBriefID
		*/
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEAL.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
		ORDER BY AEAL.ExpenceApplicationListID, AEAD.ExpenceApplicationDivID
		
	</select>
	
	<select id="selectExpenceApplicationFile" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationFile
		*/
		SELECT AEAL.ExpenceApplicationListID
			, AEAL.ExpenceApplicationID
			, AEAF.FileID
			, File.StorageID
			, File.ServiceType
			, File.ObjectID
			, File.ObjectType
			, File.MessageID
			, File.Version
			, File.SaveType
			, File.LastSeq
			, File.Seq
			, File.FilePath
			, File.FileName
			, File.SavedName
			, File.Extention
			, File.Size
			, File.CompanyCode
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si. act_expence_application_file AEAF
			ON AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
		INNER JOIN covi_smart4j.sys_file File
			ON AEAF.FileID = File.FileID
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEAL.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
	</select>
	<select id="selectExpenceApplicationFileByListID" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationFileByListID
		*/
		SELECT AEAL.ExpenceApplicationListID
			, AEAL.ExpenceApplicationID
			, AEAF.FileID
			, File.StorageID
			, File.ServiceType
			, File.ObjectID
			, File.ObjectType
			, File.MessageID
			, File.Version
			, File.SaveType
			, File.LastSeq
			, File.Seq
			, File.FilePath
			, File.FileName
			, File.SavedName
			, File.Extention
			, File.Size
			, File.CompanyCode
		FROM covi_account4j_si.act_expence_application_list AEAL
		INNER JOIN covi_account4j_si. act_expence_application_file AEAF
			ON AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
		INNER JOIN covi_smart4j.sys_file File
			ON AEAF.FileID = File.FileID
		
		WHERE AEAL.ExpenceApplicationListID = #{ExpenceApplicationListID}
	</select>
	<select id="selectExpenceApplicationFileByListIDCnt" resultType="java.lang.Long">
		/*
			expenceApplication.selectExpenceApplicationFileByListIDCnt
		*/
		SELECT COUNT(*) 
		FROM covi_account4j_si.act_expence_application_list AEAL
		INNER JOIN covi_account4j_si. act_expence_application_file AEAF
			ON AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
		INNER JOIN covi_smart4j.sys_file File
			ON AEAF.FileID = File.FileID
		
		WHERE AEAL.ExpenceApplicationListID = #{ExpenceApplicationListID}
	</select>
	<select id="selectExpenceApplicationRef" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationRef
		*/
				
		SELECT 
			AEAL.ExpenceApplicationListID
			, AEAR.ProcessID
			, AEAR.bstored
			, AEAR.BusinessData1
			, AEAR.BusinessData2
			, PA.DocSubject AS Subject
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_ref AEAR
			ON AEAL.ExpenceApplicationListID = AEAR.ExpenceApplicationListID
		INNER JOIN covi_approval4j.jwf_process PA 
			ON AEAR.ProcessID = PA.ProcessID
		WHERE 1=1
		<if test="ExpenceApplicationID != null and ExpenceApplicationID != ''">
			AND AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		</if>
		<if test="expAppListIDs != null">
			AND 
			<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEAL.ExpenceApplicationListID IN (" close=")">
				#{item}
			</foreach>
		</if>
	</select>
	
	<select id="selectExpenceApplicationAuditEvid" parameterType="cmap" resultType="cmap">
		SELECT		
		<trim prefixOverrides =",">
			<if test="AmountUse != null and AmountUse != '' and AmountUse == 'Y'.toString()">
			, AAA.ApplicationColor amountColor, AAA.RuleCode amountRuleCode, AAA.RuleName amountRuleName, AAA.RuleInfo amountRuleInfo, AAA.StdType amountStdType  
			</if>
			<if test="WeekendUse != null and WeekendUse != '' and WeekendUse == 'Y'.toString()">
			, AAW.ApplicationColor weekendColor, AAW.RuleCode weekendRuleCode, AAW.RuleName weekendRuleName, AAW.RuleInfo weekendRuleInfo, AAW.StdType weekendStdType
			</if>
			<if test="HolidayUse != null and HolidayUse != '' and HolidayUse == 'Y'.toString()">
			, AAH.ApplicationColor holidayColor, AAH.RuleCode holidayRuleCode, AAH.RuleName holidayRuleName, AAH.RuleInfo holidayRuleInfo, AAH.StdType holidayStdType
			</if>
			<if test="VacationUse != null and VacationUse != '' and VacationUse == 'Y'.toString()">
			, AAV.ApplicationColor vacationColor, AAV.RuleCode vacationRuleCode, AAV.RuleName vacationRuleName, AAV.RuleInfo vacationRuleInfo, AAV.StdType vacationStdType
			</if>
			<if test="MidnightUse != null and MidnightUse != '' and MidnightUse == 'Y'.toString()">
			, AAM.ApplicationColor midnightColor, AAM.RuleCode midnightRuleCode, AAM.RuleName midnightRuleName, AAM.RuleInfo midnightRuleInfo, AAM.StdType midnightStdType
			</if>
			, A.*
		</trim>
		FROM (
			SELECT
				AEA.RegisterID,
				AEAL.ExpenceApplicationListID,
				AEAL.ProofCode,
				AEAL.ProofDate,
				DATE_FORMAT(AEAL.ProofDate, '%Y.%m.%d') AS ProofDateStr,
				AEAL.CardUID,
				AEAL.ReceiptID,
				(
					SELECT SUM(AEAD.Amount)
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSumNum
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN LEFT(CR.ApproveTime, 2) 
					WHEN AEAL.ProofCode = 'Receipt' THEN LEFT(AR.UseTime, 2) 
					ELSE NULL 
				  END AS ProofHour
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CONCAT(LEFT(CR.ApproveTime, 2), ':', SUBSTRING(CR.ApproveTime, 3, 2), ':', RIGHT(CR.ApproveTime, 2))
					WHEN AEAL.ProofCode = 'Receipt' THEN CONCAT(AR.UseTime, ':00')
					ELSE NULL 
				  END AS ProofTime
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEAL.ExpenceApplicationID = AEA.ExpenceApplicationID
			LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
			ON AEAL.CardUID = CR.ReceiptID
			LEFT OUTER JOIN covi_account4j_si.act_receipt AR
			ON AEAL.ReceiptID = AR.ReceiptID
			WHERE AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		) A
		<if test="AmountUse != null and AmountUse != '' and AmountUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_account4j_si.act_audit AAA
			ON AAA.RuleCode = 'amount'
			AND AAA.IsUse = 'Y'
			AND AAA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
			<if test="displayType = 'DocDisplay'.toString()"> 
			AND AAA.RuleInfo LIKE '%"Evid"%'
			</if>
			AND A.AmountSumNum > (AAA.StdValue * 10000)
		</if>
		<if test="WeekendUse != null and WeekendUse != '' and WeekendUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_account4j_si.act_audit AAW
			ON AAW.RuleCode = 'weekend'
			AND AAW.IsUse = 'Y'
			AND AAW.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
			<if test="displayType = 'DocDisplay'.toString()"> 
			AND AAW.RuleInfo LIKE '%"Evid"%'
			</if>
			AND DAYOFWEEK(A.ProofDate) IN (1, 7)
		</if>
		<if test="HolidayUse != null and HolidayUse != '' and HolidayUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_smart4j.sys_calendar SC 
			ON SC.SolarDate = DATE_FORMAT(A.ProofDate, '%Y-%m-%d')
			AND SC.Anniversary IS NOT NULL
		LEFT OUTER JOIN covi_account4j_si.act_audit AAH
			ON AAH.RuleCode = 'holiday'
			AND AAH.IsUse = 'Y'
			AND AAH.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
			<if test="displayType = 'DocDisplay'.toString()"> 
			AND AAH.RuleInfo LIKE '%"Evid"%'
			</if>
			AND SC.SolarDate IS NOT NULL
		</if>
		<if test="VacationUse != null and VacationUse != '' and VacationUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_smart4j.vm_vacationinfo VI 
			ON (DATE_FORMAT(A.ProofDate, '%Y-%m-%d') BETWEEN VI.Sdate AND VI.Edate)
			AND VI.GUBUN NOT IN ('VACATION_CANCEL', 'VACATION_PUBLIC_CANCEL') 
			AND VI.UR_Code = A.RegisterID
			AND SDate NOT IN (
				SELECT SDate 
				FROM covi_smart4j.vm_vacationinfo VVI
				WHERE VVI.GUBUN IN ('VACATION_CANCEL', 'VACATION_PUBLIC_CANCEL')
				AND VI.VacFlag = VVI.VacFlag
				AND VI.VacDay = VVI.VacDay * -1
				AND VVI.UR_Code = A.RegisterID
			)
		LEFT OUTER JOIN covi_account4j_si.act_audit AAV
			ON AAV.RuleCode = 'vacation'
			AND AAV.IsUse = 'Y'
			AND AAV.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
			<if test="displayType = 'DocDisplay'.toString()"> 
			AND AAV.RuleInfo LIKE '%"Evid"%'
			</if>
			AND VI.Sdate IS NOT NULL
		</if>
		<if test="MidnightUse != null and MidnightUse != '' and MidnightUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_account4j_si.act_audit AAM
			ON AAM.RuleCode = 'midnight'
			AND AAM.IsUse = 'Y'
			AND AAM.RuleInfo LIKE CONCAT('%"',#{displayType},'"%')
			<if test="displayType = 'DocDisplay'.toString()"> 
			AND AAM.RuleInfo LIKE '%"Evid"%'
			</if>
			<![CDATA[
			AND (A.ProofHour >= AAM.StdStartTime OR A.ProofHour <= AAM.StdEndTime)
			]]>
		</if>
		<trim prefix="WHERE" prefixOverrides="OR">
			<if test="AmountUse != null and AmountUse != '' and AmountUse == 'Y'.toString()">
			OR
			AAA.RuleCode IS NOT NULL
			</if>
			<if test="WeekendUse != null and WeekendUse != '' and WeekendUse == 'Y'.toString()">
			OR
			AAW.RuleCode IS NOT NULL
			</if>
			<if test="HolidayUse != null and HolidayUse != '' and HolidayUse == 'Y'.toString()">
			OR
			AAH.RuleCode IS NOT NULL
			</if>
			<if test="VacationUse != null and VacationUse != '' and VacationUse == 'Y'.toString()">
			OR
			AAV.RuleCode IS NOT NULL
			</if>
			<if test="MidnightUse != null and MidnightUse != '' and MidnightUse == 'Y'.toString()">
			OR
			AAM.RuleCode IS NOT NULL
			</if>
		</trim>
	</select>
	
	<select id="selectExpenceApplicationAuditCnt" parameterType="cmap" resultType="cmap">
		SELECT		
		<trim prefixOverrides =",">
			<if test="AmountUse != null and AmountUse != '' and AmountUse == 'Y'.toString()">
			, MAX(AAA.RuleName) AS AmountRuleName, COUNT(AAA.RuleCode) AS AmountCnt
			</if>
			<if test="WeekendUse != null and WeekendUse != '' and WeekendUse == 'Y'.toString()">
			, MAX(AAW.RuleName) AS WeekendRuleName, COUNT(AAW.RuleCode) AS WeekendCnt
			</if>
			<if test="HolidayUse != null and HolidayUse != '' and HolidayUse == 'Y'.toString()">
			, MAX(AAH.RuleName) AS HolidayRuleName, COUNT(AAH.RuleCode) AS HolidayCnt
			</if>
			<if test="VacationUse != null and VacationUse != '' and VacationUse == 'Y'.toString()">
			, MAX(AAV.RuleName) AS VacationRuleName, COUNT(AAV.RuleCode) AS VacationCnt 
			</if>
			<if test="MidnightUse != null and MidnightUse != '' and MidnightUse == 'Y'.toString()">
			, MAX(AAM.RuleName) AS MidnightRuleName, COUNT(AAM.RuleCode) AS MidnightCnt
			</if>
		</trim>
		FROM (
			SELECT 
				AEA.RegisterID,
				AEAL.ProofDate,
				(
					SELECT SUM(AEAD.Amount)
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSumNum
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN LEFT(CR.ApproveTime, 2) 
					WHEN AEAL.ProofCode = 'Receipt' THEN LEFT(AR.UseTime, 2) 
					ELSE NULL 
				  END AS ProofHour
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEAL.ExpenceApplicationID = AEA.ExpenceApplicationID
			LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
			ON AEAL.CardUID = CR.ReceiptID
			LEFT OUTER JOIN covi_account4j_si.act_receipt AR
			ON AEAL.ReceiptID = AR.ReceiptID
			WHERE AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		) A
		<if test="AmountUse != null and AmountUse != '' and AmountUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_account4j_si.act_audit AAA
			ON AAA.RuleCode = 'amount'
			AND AAA.IsUse = 'Y'
			AND AAA.RuleInfo LIKE CONCAT('%"',#{displayType},'"%') AND AAA.RuleInfo LIKE '%TopCount%' 
			AND A.AmountSumNum > (AAA.StdValue * 10000)
		</if>
		<if test="WeekendUse != null and WeekendUse != '' and WeekendUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_account4j_si.act_audit AAW
			ON AAW.RuleCode = 'weekend'
			AND AAW.IsUse = 'Y'
			AND AAW.RuleInfo LIKE CONCAT('%"',#{displayType},'"%') AND AAW.RuleInfo LIKE '%TopCount%'
			AND DAYOFWEEK(A.ProofDate) IN (1, 7)
		</if>
		<if test="HolidayUse != null and HolidayUse != '' and HolidayUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_smart4j.sys_calendar SC 
			ON SC.SolarDate = DATE_FORMAT(A.ProofDate, '%Y-%m-%d')
			AND SC.Anniversary IS NOT NULL
		LEFT OUTER JOIN covi_account4j_si.act_audit AAH
			ON AAH.RuleCode = 'holiday'
			AND AAH.IsUse = 'Y'
			AND AAH.RuleInfo LIKE CONCAT('%"',#{displayType},'"%') AND AAH.RuleInfo LIKE '%TopCount%'
			AND SC.SolarDate IS NOT NULL
		</if>
		<if test="VacationUse != null and VacationUse != '' and VacationUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_smart4j.vm_vacationinfo VI 
			ON (DATE_FORMAT(A.ProofDate, '%Y-%m-%d') BETWEEN VI.Sdate AND VI.Edate)
			AND VI.GUBUN NOT IN ('VACATION_CANCEL', 'VACATION_PUBLIC_CANCEL') 
			AND VI.UR_Code = A.RegisterID
			AND SDate NOT IN (
				SELECT SDate 
				FROM covi_smart4j.vm_vacationinfo VVI
				WHERE VVI.GUBUN IN ('VACATION_CANCEL', 'VACATION_PUBLIC_CANCEL')
				AND VI.VacFlag = VVI.VacFlag
				AND VI.VacDay = VVI.VacDay * -1
				AND VVI.UR_Code = A.RegisterID
			)
		LEFT OUTER JOIN covi_account4j_si.act_audit AAV
			ON AAV.RuleCode = 'vacation'
			AND AAV.IsUse = 'Y'
			AND AAV.RuleInfo LIKE CONCAT('%"',#{displayType},'"%') AND AAV.RuleInfo LIKE '%TopCount%'
			AND VI.Sdate IS NOT NULL
		</if>
		<if test="MidnightUse != null and MidnightUse != '' and MidnightUse == 'Y'.toString()">
		LEFT OUTER JOIN covi_account4j_si.act_audit AAM
			ON AAM.RuleCode = 'midnight'
			AND AAM.IsUse = 'Y'
			AND AAM.RuleInfo LIKE CONCAT('%"',#{displayType},'"%') AND AAM.RuleInfo LIKE '%TopCount%'
			<![CDATA[
			AND (A.ProofHour >= AAM.StdStartTime OR A.ProofHour <= AAM.StdEndTime)
			]]>
		</if>
	</select>
	
	<select id="selectBriefList" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectBriefList
		*/
		
		SELECT	SB.StandardBriefID
			, SB.StandardBriefName
			, DATE_FORMAT(SB.RegistDate,'%Y.%m.%d') AS RegistDate
			, AC.AccountID
			, AC.AccountCode
			, AC.AccountName
			, SB.StandardBriefDesc
			, AC.TaxCode
	    	, covi_account4j_si.Fn_GetBaseCodeName('TaxCode',AC.TaxCode,#{companyCode})		AS TaxCodeName
			, AC.TaxType
	    	, covi_account4j_si.Fn_GetBaseCodeName('TaxType',AC.TaxType,#{companyCode})		AS TaxTypeName
			, SB.CtrlCode
	    	, SB.IsFile
	    	, SB.IsDocLink
		FROM covi_account4j_si.act_standard_brief	SB
		LEFT OUTER JOIN
			covi_account4j_si.act_account		AC
			ON		SB.AccountID	= AC.AccountID
		WHERE	1=1
		AND		AC.ISUSE		= 'Y'
		AND		SB.ISUSE		= 'Y'
		<if test ="isSimp != null and isSimp !='' and isSimp != 'N'.toString()">
		AND		SB.ISUSESIMP	= #{isSimp}
		</if>
		<if test ="StandardBriefSearchStr != null">
			AND 
			<foreach collection="StandardBriefSearchStr" item="item" index="index" separator="," open="SB.StandardBriefID IN (" close=")">
				#{item}
			</foreach>
		</if>
		AND		AC.CompanyCode = #{companyCode}
		ORDER BY AC.AccountID,SB.StandardBriefID
	</select>
	
	<select id="selectUserBriefList" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectUserBriefList
		*/
		
		SELECT	SB.StandardBriefID
			, SB.StandardBriefName
			, DATE_FORMAT(SB.RegistDate,'%Y.%m.%d') AS RegistDate
			, AC.AccountID
			, AC.AccountCode
			, AC.AccountName
			, SB.StandardBriefDesc
			, AC.TaxCode
	    	, covi_account4j_si.Fn_GetBaseCodeName('TaxCode',AC.TaxCode,#{companyCode})		AS TaxCodeName
			, AC.TaxType
	    	, covi_account4j_si.Fn_GetBaseCodeName('TaxType',AC.TaxType,#{companyCode})		AS TaxTypeName
			, SB.CtrlCode
	    	, SB.IsFile
	    	, SB.IsDocLink
		FROM covi_account4j_si.act_user_standard_brief USB
		INNER JOIN covi_account4j_si.act_standard_brief SB
		ON		USB.StandardBriefID = SB.StandardBriefID
		INNER JOIN covi_account4j_si.act_account AC
		ON		SB.AccountID	= AC.AccountID
		WHERE	1=1
		AND		USB.UserCode	= #{UR_Code}
		AND		AC.ISUSE		= 'Y'
		AND		SB.ISUSE		= 'Y'
		<if test ="isSimp != null and isSimp !='' and isSimp != 'N'.toString()">
			AND		SB.ISUSESIMP	= #{isSimp}
		</if>
		<if test ="StandardBriefSearchStr != null">
			AND 
			<foreach collection="StandardBriefSearchStr" item="item" index="index" separator="," open="SB.StandardBriefID IN (" close=")">
				#{item}
			</foreach>
		</if>
		AND		AC.CompanyCode = #{companyCode}
		ORDER BY AC.AccountID, SB.StandardBriefID
	</select>
	
	<select id="selectCardReceiptList" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectCardReceiptList
		*/
		
		SELECT 		
			CR.ReceiptID
			, CR.ItemNo
			, 'CorpCard' as ProofCode
			, CR.CardNo
			, DATE_FORMAT( CR.UseDate, '%Y%m%d') AS ProofDate
			, DATE_FORMAT( CR.UseDate, '%Y.%m.%d') AS ProofDateStr
			, TIME_FORMAT( CR.ApproveTime, '%H%i%s') AS ProofTime
			, TIME_FORMAT( CR.ApproveTime, '%H:%i:%s') AS ProofTimeStr
			, CR.ReceiptID CardUID
			, CR.ApproveNo CardApproveNo
			, CR.AmountWon AS TotalAmount
			, CR.RepAmount 
			, CR.TaxAmount 
			, CR.ServiceAmount 
			, CR.StoreName
			, CR.StoreNo
			, CR.StoreCondition
			, CONCAT(CR.StoreAddress1, CR.StoreAddress2) AS StoreAddress
			, CR.StoreTel
			, (CASE WHEN SC.AccountCode IS NOT NULL AND SC.AccountCode != '' THEN SC.AccountCode ELSE CR.AccountCode END) AS AccountCode
			, (SELECT AccountName FROM covi_account4j_si.act_account AA WHERE AA.CompanyCode = CC.COMPANYCODE AND AA.AccountCode
				= CASE WHEN SC.AccountCode IS NOT NULL AND SC.AccountCode != '' THEN SC.AccountCode ELSE CR.AccountCode END) AS AccountName
			, (CASE WHEN SC.StandardBriefID IS NOT NULL AND SC.StandardBriefID != '' THEN SC.StandardBriefID ELSE CR.StandardBriefID END) AS StandardBriefID
			, (SELECT StandardBriefName FROM covi_account4j_si.act_standard_brief ASB WHERE ASB.StandardBriefID
				= CASE WHEN SC.StandardBriefID IS NOT NULL AND SC.StandardBriefID != '' THEN SC.StandardBriefID ELSE CR.StandardBriefID END) AS StandardBriefName
			, CR.CostCenterCode
			, (SELECT CostCenterName FROM covi_account4j_si.act_cost_center ACC WHERE ACC.CostCenterCode = CR.CostCenterCode) AS CostCenterName
			, CR.UsageText
			, CR.Amount
			, AL.ExpenceApplicationListID
			, CR.StoreCategory
			, IF(AL.ExpenceApplicationListID IS NULL, 'N', 'Y') IsDuplicate
		FROM covi_account4j_si.act_card_receipt CR
		INNER JOIN covi_account4j_si.act_corp_card CC
			ON CR.CardNo = CC.CardNo
		LEFT OUTER JOIN (
							SELECT MAX(AL.ExpenceApplicationListID) ExpenceApplicationListID
								, AL.CardUID
								, AL.ExpenceApplicationID
							FROM covi_account4j_si.act_expence_application_list AL
							INNER JOIN covi_account4j_si.act_expence_application AA
								ON AL.ExpenceApplicationID = AA.ExpenceApplicationID
							WHERE AA.ApplicationStatus NOT IN ('R', 'C', 'DELETE')
							GROUP BY  CardUID
							) AL
			ON CR.ReceiptID = AL.CardUID
		LEFT
		JOIN	covi_account4j_si.act_corp_card_return RET
		ON		CC.CardNo = RET.CardNo
		AND		CONCAT(CR.UseDate,CR.APPROVETIME)<![CDATA[>=]]> DATE_FORMAT( RET.ReleaseDate, '%Y%m%d%H%i%s' ) 
		AND		CONCAT(CR.UseDate,CR.APPROVETIME)<![CDATA[<=]]> CASE WHEN RET.ReturnDate IS NULL THEN '29991231235959' ELSE DATE_FORMAT( RET.ReturnDate, '%Y%m%d%H%i%s' )  END
		LEFT JOIN covi_account4j_si.act_store_category SC
		ON	CR.StoreCategory = SC.CategoryCode
		AND CC.COMPANYCODE = SC.COMPANYCODE
		WHERE 1=1
			<if test ="CardID != null and CardID !=''">
				AND CC.CorpCardID =#{CardID}
			</if>
			AND		CR.ApproveStatus	= 'A'
			AND		CR.InfoIndex		IN ('A','C','D')
			AND		CR.Class			IN ('A','B','D')
			AND (AL.ExpenceApplicationListID IS NULL
				OR AL.ExpenceApplicationID = #{ExpenceApplicationID})
			
			AND ( (IFNULL(NULLIF(CR.TossUserCode,''),'NODATA') = 'NODATA' AND CC.OwnerUserCode	= #{SessionUser})
				OR (RET.ReleaseUserCode	= #{SessionUser})
				OR (CR.TossUserCode	= #{SessionUser})
				OR (CC.CorpCardID IN (SELECT	ACCSU.CorpCardID
										FROM	covi_account4j_si.act_corp_card_search_user	ACCSU
										WHERE	ACCSU.OwnerUserCode = #{SessionUser})
					)
			)
		
			AND	IFNULL(NULLIF(CR.IsPersonalUse,''),'N') = 'N'

			<if test="addPageList != null">
				AND 
				<foreach collection="addPageList" item="item" index="index" separator="," open="CR.ReceiptID NOT IN (" close=")">
					#{item}
				</foreach>
			</if>
			
			<if test ="StartDate != null and StartDate !=''">
				<![CDATA[
				 	AND CR.UseDate >= #{StartDate}
				]]>
			</if>
			<if test ="EndDate != null and EndDate !=''">
				<![CDATA[
				 	AND CR.UseDate <= #{EndDate}
				]]>
			</if>
		ORDER BY ProofDate ASC, ProofTime ASC
		<if test="pageSize != null and pageOffset != null">	
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	
	<select id="selectCardReceiptListCnt" resultType="java.lang.Long">
		/*
			expenceApplication.selectCardReceiptListCnt
		*/
		SELECT 	COUNT(CR.ReceiptID) 
		FROM covi_account4j_si.act_card_receipt CR
		INNER JOIN covi_account4j_si.act_corp_card CC
			ON CR.CardNo = CC.CardNo
		LEFT OUTER JOIN (
							SELECT MAX(AL.ExpenceApplicationListID) ExpenceApplicationListID
								, AL.CardUID
								, AL.ExpenceApplicationID
							FROM covi_account4j_si.act_expence_application_list AL
							INNER JOIN covi_account4j_si.act_expence_application AA
								ON AL.ExpenceApplicationID = AA.ExpenceApplicationID
							WHERE AA.ApplicationStatus NOT IN ('R', 'C', 'DELETE')
							GROUP BY  CardUID
							) AL
			ON CR.ReceiptID = AL.CardUID
		LEFT
		JOIN	covi_account4j_si.act_corp_card_return RET
		ON		CC.CardNo = RET.CardNo
		AND		CONCAT(CR.UseDate,CR.APPROVETIME)<![CDATA[>=]]> DATE_FORMAT( RET.ReleaseDate, '%Y%m%d%H%i%s' ) 
		AND		CONCAT(CR.UseDate,CR.APPROVETIME)<![CDATA[<=]]> CASE WHEN RET.ReturnDate IS NULL THEN '29991231235959' ELSE DATE_FORMAT( RET.ReturnDate, '%Y%m%d%H%i%s' )  END
		WHERE 1=1
			<if test ="CardID != null and CardID !=''">
				AND CC.CorpCardID =#{CardID}
			</if>
			AND		CR.ApproveStatus	= 'A'
			AND		CR.InfoIndex		IN ('A','C','D')
			AND		CR.Class			IN ('A','B','D')
			AND (AL.ExpenceApplicationListID IS NULL
				OR AL.ExpenceApplicationID = #{ExpenceApplicationID})
			
			AND ( (IFNULL(NULLIF(CR.TossUserCode,''),'NODATA') = 'NODATA' AND CC.OwnerUserCode	= #{SessionUser})
				OR (CR.TossUserCode	= #{SessionUser})
				OR (RET.ReleaseUserCode	= #{SessionUser})
				OR (CC.CorpCardID IN (SELECT	ACCSU.CorpCardID
										FROM	covi_account4j_si.act_corp_card_search_user	ACCSU
										WHERE	ACCSU.OwnerUserCode = #{SessionUser})
					)
			)
		
			AND	IFNULL(NULLIF(CR.IsPersonalUse,''),'N') = 'N'
			
			<if test="addPageList != null">
				AND 
				<foreach collection="addPageList" item="item" index="index" separator="," open="CR.ReceiptID NOT IN (" close=")">
					#{item}
				</foreach>
			</if>
			
			<if test ="StartDate != null and StartDate !=''">
				<![CDATA[
				 	AND CR.UseDate >= #{StartDate}
				]]>
			</if>
			<if test ="EndDate != null and EndDate !=''">
				<![CDATA[
				 	AND CR.UseDate <= #{EndDate}
				]]>
			</if>
	</select>
	
	
	<select id="getCardReceiptDetail" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.getCardReceiptDetail
 	    	법인카드 사용내역 상세
 	    */
		SELECT 		
			CR.ReceiptID
			, CR.ItemNo
			, CR.CardNo
			, CR.ApproveNo
			, DATE_FORMAT( CR.UseDate, '%Y.%m.%d') AS UseDate
			, TIME_FORMAT( CR.ApproveTime, '%H:%i:%s') AS ApproveTime
			, CR.StoreName
			, CR.StoreNo
			, CR.StoreRepresentative
			, CR.StoreRegNo
			, CR.StoreTel
			, CR.StoreAddress1 || CR.StoreAddress2 AS StoreAddress
			, CR.StoreCondition
			, CR.RepAmount
			, CR.TaxAmount
			, CR.ServiceAmount
			, CR.AmountWon
			, CR.InfoIndex
		FROM covi_account4j_si.act_card_receipt CR
		WHERE CR.ReceiptID = #{receiptID}
	</select>
	
	<select id="getUserCC" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.getUserCC
 	    	법인카드 사용내역 상세
 	    */
		SELECT UCC.CostCenterCode
			, CC.CostCenterID
			, CC.CostCenterName
			, CC.CompanyCode
			, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', CC.CompanyCode, CC.CompanyCode) AS CompanyName
		FROM covi_account4j_si.act_user_cost_center  UCC
		LEFT OUTER JOIN covi_account4j_si.act_cost_center CC
			ON UCC.CostCenterCode = CC.CostCenterCode
		WHERE UserCode = #{UserCode}
	</select>
	
	
	
	<select id="makeSlipNo" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.makeSlipNo
 	    	전표번호 생성
 	    */
		SELECT 
			AEAL.ExpenceApplicationListID
			,(
				SELECT IFNULL(CONCAT(DATE_FORMAT(now(), '%Y%m%d')
				, LPAD(MAX(SUBSTR(DocNo, 9,3))+1, 3, '0'))
				, CONCAT(DATE_FORMAT(now(), '%Y%m%d'), '001'))
				FROM covi_account4j_si.act_expence_application_list 
				WHERE SUBSTR(DocNo, 1,8) = DATE_FORMAT(now(), '%Y%m%d')
			) DocNo
			, AEAL.ProofCode
			, AEAL.PostingDate
			, AEAL.PayDate
		FROM covi_account4j_si.act_expence_application_list AEAL
		WHERE AEAL.ExpenceApplicationListID = #{ExpenceApplicationListID}
	</select>
	
	<select id="makeSlipNo_BACKUP" resultType="java.lang.Long">
 	    /*
 	    	expenceApplication.makeSlipNo_BACKUP
 	    	전표번호 생성 수정전 백업
 	    */
		SELECT IFNULL(CONCAT(DATE_FORMAT(now(), '%Y%m%d')
						, LPAD(MAX(SUBSTR(DocNo, 9,3))+1, 3, '0'))
					, CONCAT(DATE_FORMAT(now(), '%Y%m%d'), '001'))
		FROM covi_account4j_si.act_expence_application_list 
		WHERE SUBSTR(DocNo, 1,8) = DATE_FORMAT(now(), '%Y%m%d')
	</select>
	
	<select id="makeSlipInfoList" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.makeSlipInfoList
 	    	전표발행 정보 - 증빙
 	    */
		SELECT 
			AEA.CompanyCode
			, AEA.ExpenceApplicationID
			, AEA.ApplicationTitle
			, DATE_FORMAT(AEA.ModifyDate, '%Y-%m-%d')
			, AEAL.ExpenceApplicationListID
			, AEAL.ProofCode
			, DATE_FORMAT(IFNULL(AEAL.DocPostingDate, AEAL.PostingDate), '%Y-%m-%d')
			, DATE_FORMAT(IFNULL(AEAL.DocPayDate, AEAL.PayDate), '%Y-%m-%d')
			, DATE_FORMAT(AEAL.ProofDate, '%Y-%m-%d')
			, AEAL.TaxCode
			, CASE 
				WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.TaxAmount, 0)
				WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(IFNULL(AEAL.TaxAmount, ATI.TaxTotal), 0)
				WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.Tax, 0)
                WHEN AEAL.ProofCode = 'EtcEvid' THEN FORMAT(AEAL.TaxAmount, 0)
			ELSE '0'
			END TaxAmount
			, CASE 
				WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.RepAmount, 0)
				WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(IFNULL(AEAL.RepAmount, ATI.SupplyCostTotal), 0)
				WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.SupplyCost, 0)
                WHEN AEAL.ProofCode = 'EtcEvid' THEN FORMAT(AEAL.RepAmount, 0)
			ELSE FORMAT(AEAL.TotalAmount, 0)
			END RepAmount
			, IFNULL(AEAL.VendorNo, (SELECT VendorNo FROM covi_account4j_si.act_corp_card WHERE CardNo = (SELECT CardNo FROM covi_account4j_si.act_card_receipt WHERE ReceiptID = AEAL.CardUID))) AS VendorNo
			, IFNULL(VD.VendorName, (SELECT VendorName FROM covi_account4j_si.act_vendor WHERE VendorNo = (SELECT VendorNo FROM covi_account4j_si.act_corp_card WHERE CardNo = (SELECT CardNo FROM covi_account4j_si.act_card_receipt WHERE ReceiptID = AEAL.CardUID)))) AS VendorName
			, AEAL.TotalAmount
			, IFNULL(VD.CurrencyCode, 'KRW') AS CurrencyCode
			, AEAL.RegisterID
			, ATI.NTSConfirmNum
			, ATI.ISSUEDT ISSUE_DATE
		FROM covi_account4j_si.act_expence_application_list AEAL
		LEFT OUTER JOIN covi_account4j_si.act_expence_application AEA 
		ON AEAL.ExpenceApplicationID = AEA.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
		ON AEAL.CardUID = CR.ReceiptID
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
		ON AEAL.CashUID = ACB.CashBillID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		WHERE AEAL.ExpenceApplicationListID = #{ExpenceApplicationListID}
	</select>
	
	<select id="makeSlipInfoDiv" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.makeSlipInfoDiv
 	    	전표발행 정보 - 세부증빙
 	    */
		SELECT 
			AEAD.ExpenceApplicationDivID
			, AEAL.ExpenceApplicationListID
			, AEAL.TaxCode
			, CASE 
				WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.TaxAmount, 0)
				WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(IFNULL(AEAL.TaxAmount, ATI.TaxTotal), 0)
				WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.Tax, 0)
                WHEN AEAL.ProofCode = 'EtcEvid' THEN FORMAT(AEAL.TaxAmount, 0)
			ELSE '0'
			END TaxAmount
			, CASE 
				WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.RepAmount, 0)
				WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(IFNULL(AEAL.RepAmount, ATI.SupplyCostTotal), 0)
				WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.SupplyCost, 0)
                WHEN AEAL.ProofCode = 'EtcEvid' THEN FORMAT(AEAL.RepAmount, 0)
			ELSE FORMAT(AEAL.TotalAmount, 0)
			END RepAmount
			, AEAL.TotalAmount
			, AEAD.AccountCode
			, AEAD.CostCenterCode
			, AEAD.IOCode
			, AEAD.Amount
			, AEAD.UsageComment
		FROM covi_account4j_si.act_expence_application_div AEAD
		LEFT OUTER JOIN covi_account4j_si.act_expence_application_list AEAL 
		ON AEAD.ExpenceApplicationListID = AEAL.ExpenceApplicationListID
		LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
		ON AEAL.CardUID = CR.ReceiptID
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
		ON AEAL.CashUID = ACB.CashBillID
		WHERE AEAD.ExpenceApplicationListID = #{ExpenceApplicationListID}
	</select>
	
	<select id="selectAutoSlipMakeList" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.selectAutoSlipMakeList
 	    	전표 자동생성 타겟 목록
 	    */
		SELECT 
			AEAL.ExpenceApplicationListID
			, AEA.ProcessID
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list  AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		WHERE AEA.ExpenceApplicationID = #{ExpenceApplicationID}
		AND AEA.ApplicationStatus = 'E'
	</select>
	
	
    <update id="updateSlipInfo" parameterType="cmap">
 	    /*
 	    	expenceApplication.updateSlipInfo
 	    	전표작성
 	    */
 	    UPDATE covi_account4j_si.act_expence_application_list
 	    SET 
 	    <choose>
 	        <when test='flag == "Y"'>
	 	    	DocNo = #{DocNo}
 	        </when>
			<otherwise>
	 	    	unDocNo = #{DocNo}
			</otherwise> 	        
 	    </choose>
			, DocPostingDate = IF('Y'= #{PostingDateCk}, PostingDate, DATE_FORMAT(#{SetPostingDate}, '%Y%m%d'))
			, DocPayDate = IF('Y'= #{PayDayCk}, PayDate, DATE_FORMAT(#{SetPayDay}, '%Y%m%d'))
		WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
	</update>
	
	<update id="updateUnSlipInfo" parameterType="cmap">
 	    /*
 	    	expenceApplication."updateUnSlipInfo"
 	    	전표취소
 	    */
 	    UPDATE covi_account4j_si.act_expence_application_list
 	    	SET unDocNo = #{unDocNo}
			, DocPostingDate = ''
			, DocPayDate = ''	
		WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
	</update>
	
    
	<select id="statCheckExpenceApplication" resultType="java.lang.Long">
 		/*
 			expenceApplication.statCheckExpenceApplication
			결재 처리전 상태체크
 		*/
 			SELECT	COUNT(*)
			FROM covi_account4j_si.act_expence_application AEA
			WHERE 1=1
			 	AND 
			 	<choose>
					<when test="ExpenceApplicationIDList != null">
						<foreach collection="ExpenceApplicationIDList" item="item" index="index" separator="," open="AEA.ExpenceApplicationID IN (" close=")">
							#{item}
						</foreach>
					</when>
					<otherwise>
						1=2
					</otherwise>
				</choose>
				
			 	<choose>
					<when test="ckStatList != null">
						AND 
						<foreach collection="ckStatList" item="item" index="index" separator="," open="AEA.ApplicationStatus NOT IN (" close=")">
							#{item}
						</foreach>
					</when>
				</choose>
	</select>	
    <update id="statChangeExpenceApplicationManList" parameterType="cmap">
 	    /*
 	    	expenceApplication.statChangeExpenceApplicationManList
 	    	상태 변경
 	    */
 	    
 	    UPDATE covi_account4j_si.act_expence_application
 	    SET ApplicationStatus = #{ApplicationStatus}
			, ModifierID = #{SessionUser}
			, ModifyDate = now()
		WHERE ExpenceApplicationID = #{ExpenceApplicationID}
		
	</update>
    
	<select id="getWorkItemArchiveIDForDelMarking" parameterType="cmap" resultType="java.lang.String">
		 SELECT GROUP_CONCAT(WorkItemID) 
		 FROM covi_approval4j.jwf_workitem WA
		 INNER JOIN covi_approval4j.jwf_process PA
		 ON WA.ProcessID = PA.ProcessID
		 INNER JOIN covi_account4j_si.act_expence_application AEA
		 ON PA.ProcessID = AEA.ProcessID
		 WHERE ExpenceApplicationID = #{ExpenceApplicationID}
	</select>
    
    
	
	
	<select id="getMobileReceiptList" parameterType="cmap" resultType="cmap">
		SELECT	AR.ReceiptID,
				AR.CompanyCode,
				AR.ExpenceMgmtCode,
				'Receipt' AS ProofCode,
				DATE_FORMAT(AR.PhotoDate, '%Y%m%d') AS PhotoDate,
				DATE_FORMAT(AR.PhotoDate, '%Y.%m.%d') AS PhotoDateYMD,
				DATE_FORMAT(AR.PhotoDate, '%T') AS PhotoDateHMS,
				DATE_FORMAT(AR.PhotoDate, '%Y.%m.%d %H:%i') AS PhotoDateStr,
				AR.ReceiptType,
				AR.ReceiptFileID,
				AR.Active,
				covi_account4j_si.Fn_GetBaseCodeName('Active', AR.Active, #{companyCode}) AS ActiveName,
				AR.RegisterID,
				DATE_FORMAT(AR.RegistDate, '%Y%m%d') AS RegistDate,
				DATE_FORMAT(AR.RegistDate, '%Y.%m.%d %H:%i') AS RegistDateStr,
				
				SF.FileID,
				SF.SavedName,
				SF.FilePath,
				SF.FileName,		
				CONCAT(REPLACE(ST.FilePath,'{0}',SF.CompanyCode), SF.FilePath, SF.SavedName) AS FullPath,
				
				AR.TotalAmount,
				AR.StoreName,
				AR.StoreAddress,
				DATE_FORMAT(AR.UseDate, '%Y.%m.%d') AS UseDate,
				DATE_FORMAT(AR.UseDate, '%Y%m%d') AS ProofDate,
				DATE_FORMAT(AR.UseDate, '%Y.%m.%d') AS ProofDateStr,
				TIME_FORMAT(AR.UseTime, '%H%i%s') AS ProofTime,
				TIME_FORMAT(AR.UseTime, '%H:%i:%s') AS ProofTimeStr,
				AR.UsageText,
				AR.Amount,
				AR.AccountCode,
				(SELECT AccountName FROM covi_account4j_si.act_account AA WHERE AA.AccountCode = AR.AccountCode) AS AccountName,
				AR.StandardBriefID,
				(SELECT StandardBriefName FROM covi_account4j_si.act_standard_brief ASB WHERE ASB.StandardBriefID = AR.StandardBriefID) AS StandardBriefName,
				AR.CostCenterCode,
				(SELECT CostCenterName FROM covi_account4j_si.act_cost_center ACC WHERE ACC.CostCenterCode = AR.CostCenterCode) AS CostCenterName,
				
				AL.ExpenceApplicationListID			
		FROM	covi_account4j_si.act_receipt AR
		INNER JOIN covi_smart4j.sys_file SF
		ON AR.ReceiptFileID = SF.FileID
		INNER JOIN covi_smart4j.sys_storage ST ON ST.StorageID = SF.StorageID
		LEFT OUTER JOIN (
							SELECT MAX(AL.ExpenceApplicationListID) ExpenceApplicationListID
									, AL.ReceiptID
									, AL.ExpenceApplicationID
							FROM covi_account4j_si.act_expence_application_list AL
							INNER JOIN covi_account4j_si.act_expence_application AA
							ON AL.ExpenceApplicationID = AA.ExpenceApplicationID
							WHERE AA.ApplicationStatus NOT IN ('R', 'C', 'DELETE')
							GROUP BY ReceiptID, AL.ExpenceApplicationID
		) AL
		ON AR.ReceiptID = AL.ReceiptID
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			AND (
				AL.ExpenceApplicationListID IS NULL
				<if test ="ExpenceApplicationID != null and ExpenceApplicationID !=''">
				OR AL.ExpenceApplicationID = #{ExpenceApplicationID}
				</if>
			)
			<if test ="addPageList != null and addPageList !=''">
			AND AR.ReceiptID NOT IN 
			<foreach collection="addPageList" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
			</if>		
			<if test ="SDate != null and SDate !=''">
			AND AR.RegistDate <![CDATA[>=]]> #{SDate}
			</if>
			<if test ="EDate != null and EDate !=''">
			AND AR.RegistDate <![CDATA[<=]]> #{EDate}
			</if>
			<if test ="UR_Code != null and UR_Code !=''">
			AND AR.RegisterID = #{UR_Code}
			</if>
		</trim>
		ORDER BY AR.ReceiptID ASC
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="getMobileReceiptListCnt" resultType="java.lang.Long">
		SELECT	COUNT(AR.ReceiptID)		
		FROM	covi_account4j_si.act_receipt AR
		LEFT OUTER JOIN (
							SELECT MAX(AL.ExpenceApplicationListID) ExpenceApplicationListID
									, AL.ReceiptID
									, AL.ExpenceApplicationID
							FROM covi_account4j_si.act_expence_application_list AL
							INNER JOIN covi_account4j_si.act_expence_application AA
							ON AL.ExpenceApplicationID = AA.ExpenceApplicationID
							WHERE AA.ApplicationStatus NOT IN ('R', 'C', 'DELETE')
							GROUP BY ReceiptID, AL.ExpenceApplicationID
		) AL
		ON AR.ReceiptID = AL.ReceiptID
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			AND (
				AL.ExpenceApplicationListID IS NULL
				<if test ="ExpenceApplicationID != null and ExpenceApplicationID !=''">
				OR AL.ExpenceApplicationID = #{ExpenceApplicationID}
				</if>
			)
			<if test ="addPageList != null and addPageList !=''">
			AND AR.ReceiptID NOT IN 
			<foreach collection="addPageList" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
			</if>		
			<if test ="SDate != null and SDate !=''">
			AND AR.RegistDate <![CDATA[>=]]> #{SDate}
			</if>
			<if test ="EDate != null and EDate !=''">
			AND AR.RegistDate <![CDATA[<=]]> #{EDate}
			</if>
			<if test ="UR_Code != null and UR_Code !=''">
			AND AR.RegisterID = #{UR_Code}
			</if>
		</trim>
	</select>
	
	<select id="getMobileReceipt" parameterType="cmap" resultType="cmap">
		SELECT	AR.ReceiptID,
				'Receipt' as ProofCode,
				AR.CompanyCode,
				AR.ExpenceMgmtCode,
				AR.UsageText,
				AR.UseDate,
				AR.UseTime,
				AR.StoreName,
				AR.StoreAddress,
				FORMAT(AR.TotalAmount,0) AS TotalAmount,
				DATE_FORMAT(AR.UseDate, '%Y.%m.%d') AS ProofDateStr,
				DATE_FORMAT(AR.PhotoDate, '%Y%m%d') AS PhotoDate,
				DATE_FORMAT(AR.PhotoDate, '%Y.%m.%d %H:%i') AS PhotoDateStr,
				AR.PhotoDate AS PhotoDateFull,
				AR.ReceiptType,
				AR.ReceiptFileID,
				AR.Active,
				covi_account4j_si.Fn_GetBaseCodeName('Active', AR.Active, #{companyCode}) AS ActiveName,
				AR.RegisterID,
				DATE_FORMAT(AR.RegistDate, '%Y%m%d') AS RegistDate,
				DATE_FORMAT(AR.RegistDate, '%Y.%m.%d %H:%i') AS RegistDateStr,
				SB.StandardBriefID,
				SB.StandardBriefName	
		FROM	covi_account4j_si.act_receipt AR
		LEFT OUTER JOIN
				covi_account4j_si.act_standard_brief SB
		ON		AR.StandardBriefID	= SB.StandardBriefID
		WHERE 1=1
			AND 
			<choose>
				<when test="receiptIDList != null">
					<foreach collection="receiptIDList" item="item" index="index" separator="," open="AR.ReceiptID IN (" close=")">
						#{item}
					</foreach>
				</when>
				<otherwise>
					1=2
				</otherwise>
			</choose>
	</select>
	
	<delete id="deleteMobileReceipt" parameterType="cmap">
	    DELETE FROM covi_account4j_si.act_receipt		
		WHERE ReceiptID = #{receiptID}	
	</delete>
	
	<insert id="insertMobileReceipt" parameterType="cmap">
	    INSERT INTO covi_account4j_si.act_receipt
		(
			CompanyCode
			, ExpenceMgmtCode
			, StandardBriefID
			, AccountCode
			, UseDate
			, UseTime
			, UsageText
			, StoreName
			, StoreAddress
			, TotalAmount
			, PhotoDate
			, ReceiptType
			, ReceiptFileID
			, Active
			, RegisterID
			, RegistDate
		)
		VALUES
		(
			 #{CompanyCode}
			, #{ExpenceMgmtCode}
			, #{StandardBriefID}
			, #{AccountCode}
			, #{UseDate}
			, #{UseTime}
			, #{UsageText}
			, #{StoreName}
			, #{StoreAddress}
			, #{TotalAmount}
			, #{PhotoDate}
			, #{ReceiptType}
			, #{ReceiptFileID}
			, #{Active}
			, #{SessionUser}
			, now()
		)
	</insert>
	
	<update id="updateMobileReceipt" parameterType="cmap">
	    UPDATE covi_account4j_si.act_receipt
		SET StandardBriefID = #{StandardBriefID},
			AccountCode = #{AccountCode},
			TotalAmount = #{TotalAmount},
			UseDate = #{UseDate},
			UseTime = #{UseTime},
			UsageText = #{UsageText},
			StoreName = #{StoreName},
			ReceiptType = #{ReceiptType}
		WHERE ReceiptID = #{ReceiptID}
	</update>
	
	<update id="updateCorpCardReceipt" parameterType="cmap">
	    UPDATE covi_account4j_si.act_card_receipt
		SET StandardBriefID = #{StandardBriefID},
			AccountCode = #{AccountCode},
			UsageText = #{UsageText}
		WHERE ReceiptID = #{ReceiptID}
	</update>
	
	<select id="selectExpenceApplicationReviewList" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationReviewList
		*/
		select *
			, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, #{companyCode}) CompanyName
			, covi_account4j_si.Fn_GetBaseCodeName('ExpenceApplicationStatus', A.ApplicationStatus, #{companyCode}) ApplicationStatusName
			, covi_account4j_si.Fn_GetBaseCodeName('ProofCode', A.ProofCode, #{companyCode}) ProofCodeName
		from (
			SELECT AEA.ExpenceApplicationID 
				, AEA.CompanyCode
				, AEA.ApplicationTitle
				, AEA.ApplicationType
				, AEA.ApplicationStatus
				, AEA.RegisterID
				, USR.DisplayName RegisterName
				, DATE_FORMAT( IFNULL(AEA.ApplicationDate, AEA.RegistDate), '%Y.%m.%d') AS ApplicationDate
				, AEA.RequestType
				, AEA.RegistDate
				, AEAL.ExpenceApplicationListID
				, AEAL.ExpenceApplicationListID cdRownum
				#, AEAL.ExpenceApplicationID
				, DATE_FORMAT( AEAL.ProofDate, '%Y.%m.%d') AS ProofDate
				, DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d') AS PostingDate
				, AEAL.ProofCode
				, AEAL.CardUID
				, AEAL.CashUID
				, AEAL.TaxUID
				, AEAL.ReceiptID
				, AEAL.TaxType
				, AEAL.TaxCode
				, AEAL.PayAdjustMethod
				, AEAL.PayMethod
				, AEAL.IsWithholdingTax
				, AEAL.IncomeTax
				, AEAL.LocalTax
				, AEAL.PayDate
				, AEAL.RealPayDate
				, AEAL.RealPayAmount
				, AEAL.VendorNo
				, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
				#, CR.ReceiptID
				, ATI.TaxInvoiceID
				, (SELECT COUNT(*) FROM covi_account4j_si. act_expence_application_file AEAF
					WHERE AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
					) FileCnt
				, (SELECT COUNT(*) 
					FROM covi_account4j_si. act_expence_application_list AEALD
					WHERE AEAL.ExpenceApplicationID = AEALD.ExpenceApplicationID
					) AppCnt
				, FORMAT(AEAL.TotalAmount,0)				AS TotalAmount
				, AEAL.TotalAmount TotalAmountNum
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.TaxAmount, 0)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.TaxTotal, 0)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.Tax, 0)
					ELSE ''
					END TaxAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.TaxAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.TaxTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.Tax
					ELSE ''
					END TaxAmountNum
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN FORMAT(CR.RepAmount, 0)
					WHEN AEAL.ProofCode = 'TaxBill' THEN FORMAT(ATI.SupplyCostTotal, 0)
					WHEN AEAL.ProofCode = 'CashBill' THEN FORMAT(ACB.SupplyCost, 0)
					ELSE ''
					END RepAmount
				, CASE 
					WHEN AEAL.ProofCode = 'CorpCard' THEN CR.RepAmount
					WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.SupplyCostTotal
					WHEN AEAL.ProofCode = 'CashBill' THEN ACB.SupplyCost
					ELSE ''
					END RepAmountNum
				, (
					SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN FORMAT(SUM(AEAD.Amount) + AEAL.TaxAmount,0) 
							ELSE FORMAT(SUM(AEAD.Amount),0) 
						END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSum
				, (
					SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
							ELSE SUM(AEAD.Amount) 
						END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSumNum
				#, USR.DisplayName RegisterName
				, AEAL.DocNo
				, AEAL.UnDocNo
				, CASE WHEN AEAL.DocNo IS NULL 
						THEN 
							DATE_FORMAT( AEAL.PostingDate, '%Y.%m.%d')
						ELSE 
							DATE_FORMAT( AEAL.DocPostingDate, '%Y.%m.%d')
					END DocPostingDate
				, CASE WHEN AEAL.DocNo IS NULL 
						THEN 
							DATE_FORMAT( AEAL.PayDate, '%Y.%m.%d')
						ELSE 
							DATE_FORMAT( AEAL.DocPayDate, '%Y.%m.%d')
					END DocPayDate
				, AR.ReceiptFileID
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user USR
			ON AEA.RegisterID = USR.UserCode
			LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
			ON AEAL.CardUID = CR.ReceiptID
			LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
			ON AEAL.TaxUID = ATI.TaxInvoiceID
			LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
			ON AEAL.CashUID = ACB.CashBillID
			LEFT OUTER JOIN covi_account4j_si.act_receipt AR
			ON AEAL.ReceiptID = AR.ReceiptID
			WHERE 1=1
		 		AND AEA.ApplicationStatus = 'E'
			<choose>
				<when test="searchText != null and searchText !=''">
				    <choose>
					    <when test="searchType == 'title'.toString()">
				AND		AEA.ApplicationTitle		LIKE CONCAT('%' , #{searchText} , '%')
					    </when>
					    <when test="searchType == 'user'.toString()">
				AND		USR.DisplayName		LIKE CONCAT('%' , #{searchText} , '%')
					    </when>
					    <when test="searchType == 'docno'.toString()">
				AND		AEAL.DocNo			LIKE CONCAT('%' , #{searchText} , '%')
					    </when>
					</choose>
				</when>
			</choose>
			<if test ="companyCode != null and companyCode !=''">
			AND		AEA.CompanyCode = #{companyCode}
			</if>
			<if test ="proofCode != null and proofCode !=''">
			AND		AEAL.ProofCode = #{proofCode}
			</if>
			<if test ="payDate != null and payDate !=''">
			AND		AEAL.PayDate = #{payDate}
			</if>
			<if test ="postingDate != null and postingDate !=''">
			AND		AEAL.PostingDate = #{postingDate}
			</if>
		) A
		<trim prefix="ORDER BY"  prefixOverrides =",">
		    <if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
		        , DATE_FORMAT( IFNULL(A.ApplicationDate, A.RegistDate), '%Y.%m.%d') DESC
				, A.ExpenceApplicationID  DESC
		    </if>
		  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
			 	, 	
				<choose>	
					<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationStatusName")'>ApplicationStatusName</when>
					<when test='sortColumn.equalsIgnoreCase("DocNo")'>DocNo</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationDate")'>ApplicationDate</when>
					<when test='sortColumn.equalsIgnoreCase("DocPayDate")'>DocPayDate</when>
					<when test='sortColumn.equalsIgnoreCase("DocPostingDate")'>DocPostingDate</when>
					<when test='sortColumn.equalsIgnoreCase("VendorName")'>VendorName</when>
					<when test='sortColumn.equalsIgnoreCase("TaxAmount")'>TaxAmount</when>
					<when test='sortColumn.equalsIgnoreCase("RepAmount")'>RepAmount</when>
					<when test='sortColumn.equalsIgnoreCase("AmountSum")'>AmountSum</when>
					<when test='sortColumn.equalsIgnoreCase("ProofCodeName")'>ProofCodeName</when>
					<when test='sortColumn.equalsIgnoreCase("DocCnt")'>DocCnt</when>
				</choose>	
				<choose>	
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>	
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="selectExpenceApplicationReviewListCnt" resultType="java.lang.Long">
		/*
			expenceApplication.selectExpenceApplicationReviewListCnt
		*/
		
		SELECT COUNT(*)
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user USR
		ON AEA.RegisterID = USR.UserCode
		LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
		ON AEAL.CardUID = CR.ReceiptID
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_receipt AR
		ON AEAL.ReceiptID = AR.ReceiptID
		WHERE 1=1
	 		AND AEA.ApplicationStatus = 'E'
		<choose>
			<when test="searchText != null and searchText !=''">
			    <choose>
				    <when test="searchType == 'title'.toString()">
			AND		AEA.ApplicationTitle		LIKE CONCAT('%' , #{searchText} , '%')
				    </when>
				    <when test="searchType == 'user'.toString()">
			AND		USR.DisplayName		LIKE CONCAT('%' , #{searchText} , '%')
				    </when>
				    <when test="searchType == 'docno'.toString()">
			AND		AEAL.DocNo			LIKE CONCAT('%' , #{searchText} , '%')
				    </when>
				</choose>
			</when>
		</choose>
		<if test ="companyCode != null and companyCode !=''">
		AND		AEA.CompanyCode = #{companyCode}
		</if>
		<if test ="proofCode != null and proofCode !=''">
		AND		AEAL.ProofCode = #{proofCode}
		</if>
		<if test ="payDate != null and payDate !=''">
		AND		AEAL.PayDate = #{payDate}
		</if>
		<if test ="postingDate != null and postingDate !=''">
		AND		AEAL.PostingDate = #{postingDate}
		</if>
	</select>
		
	<select id="getExpenceApplicationSaveIDs" parameterType="cmap" resultType="cmap">
	    /*
 	    	expenceApplication.getExpenceApplicationSaveCnts
 	    */
		SELECT	COUNT(*) AS CNT
			,	EA.ExpenceApplicationID
			,	EL.ExpenceApplicationListID
			,	ED.ExpenceApplicationDivID
		FROM	(	SELECT	ExpenceApplicationID
					FROM	covi_account4j_si.act_expence_application
					WHERE	InterfaceKeyID	= #{interfaceKeyID}
					) EA
			,	(	SELECT	ExpenceApplicationListID
					FROM	covi_account4j_si.act_expence_application_list
					WHERE	InterfaceKeyID	= #{interfaceKey_list}
					) EL
			,	(	SELECT	ExpenceApplicationDivID
					FROM	covi_account4j_si.act_expence_application_div
					WHERE	InterfaceKeyID	= #{interfaceKey_Div}
					) ED
	</select>
	
	<insert id="expenceApplicationInterfaceInsert" parameterType="cmap">
	    /*
 	    	expenceApplication.expenceApplicationInterfaceInsert
 	    */
		INSERT INTO covi_account4j_si.act_expence_application (
				CompanyCode
			,	ApplicationTitle
			,	ApplicationType
			,	ApplicationStatus
			,	ApplicationDate
			,	RequestType
			,	ProcessID
			,	Ur_code
			,	Comment
			,	InterfaceKeyID
			,	RegisterID
			,	RegistDate
			,	ModifierID
			,	ModifyDate
		)VALUES(
				#{companyCode}			/*회사코드*/
			,	#{applicationTitle}		/*신청제목*/
			,	#{applicationType}		/*신청유형*/
			,	#{applicationStatus}	/*신청상태*/
			,	#{applicationDate}		/*신청일*/
			,	#{requestType}			/*신청서구분*/
			,	#{processID}			/*결재 Process ID*/
			,	#{ur_code}				/*결재행위자*/
			,	#{comment}				/*결재내용(반려사유포함)*/
			,	#{interfaceKeyID}
			,	#{SessionUser}
			,	now()
			,	#{SessionUser}
			,	now()
		)
		<selectKey keyProperty="expenceApplicationID" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>
	
	<update id="expenceApplicationInterfaceUpdate" parameterType="cmap">
	    /*
 	    	expenceApplication.expenceApplicationInterfaceUpdate
 	    */
 	    UPDATE covi_account4j_si.act_expence_application
 	    	SET
 	    		companyCode			= #{companyCode}		/*회사코드*/
			,	applicationTitle	= #{applicationTitle}	/*신청제목*/
			,	applicationType		= #{applicationType}	/*신청유형*/
			,	applicationStatus	= #{applicationStatus}	/*신청상태*/
			,	applicationDate		= #{applicationDate}	/*신청일*/
			,	processID			= #{processID}			/*결재 Process ID*/
			,	ur_code				= #{ur_code}			/*결재행위자*/
			,	comment				= #{comment}			/*결재내용(반려사유포함)*/
			,	ModifierID			= #{SessionUser}
			,	ModifyDate			= now()
 	    WHERE	InterfaceKeyID	= #{interfaceKeyID}
	</update>
	
	<insert id="expenceApplicationListInterfaceInsert" parameterType="cmap">
	    /*
 	    	expenceApplication.expenceApplicationListInterfaceInsert
 	    */
 	    INSERT INTO covi_account4j_si.act_expence_application_list (
 	    		ExpenceApplicationID
	 	    ,	proofDate			/*증빙일자*/
			,	proofCode			/*증빙타입*/
			,	cardUID		/*카드승인번호*/
			,	cashUID	/*현금영수증승인번호*/
			,	taxUID	/*세금계산서승인번호*/
			,	receiptID			/*모바일영수증ID*/
			,	postingDate			/*전기일자*/
			,	taxType				/*세금유형*/
			,	taxCode				/*세금코드*/
			,	payAdjustMethod		/*정산방법*/
			,	payMethod			/*지급방법*/
			,	payDate				/*지급일자*/
			,	isWithholdingTax	/*원천세여부*/
			,	incomeTax			/*소득세유형*/
			,	localTax			/*지방세유형*/
			,	vendorNo			/*거래처등록번호*/
			,	personalCardNo		/*개인카드번호*/
			,	totalAmount			/*합계액*/
			,	docNo				/*전표번호*/
			,	docPostingDate		/*전표전기일자*/
			,	docPayDate			/*전표지급일자*/
			,	InterfaceKeyID
			,	RegisterID
			,	RegistDate
			,	ModifierID
			,	ModifyDate
			,	ReservedStr1
			,	ReservedStr2
			,	ReservedStr3
			,	ReservedStr4
			,	ReservedStr5
			,	ReservedInt1
			,	ReservedInt2
		)VALUES(
				#{expenceApplicationID}
			,	#{proofDate}			/*증빙일자*/
			,	#{proofCode}			/*증빙타입*/
			,	#{cardUID}		/*카드승인번호*/
			,	#{cashUID}	/*현금영수증승인번호*/
			,	#{taxUID}		/*세금계산서승인번호*/
			,	#{receiptID}			/*모바일영수증ID*/
			,	#{postingDate}			/*전기일자*/
			,	#{taxType}				/*세금유형*/
			,	#{taxCode}				/*세금코드*/
			,	#{payAdjustMethod}		/*정산방법*/
			,	#{payMethod}			/*지급방법*/
			,	#{payDate}				/*지급일자*/
			,	#{isWithholdingTax}		/*원천세여부*/
			,	#{incomeTax}			/*소득세유형*/
			,	#{localTax}				/*지방세유형*/
			,	#{vendorNo}				/*거래처등록번호*/
			,	#{personalCardNo}		/*개인카드번호*/
			,	#{totalAmount}			/*합계액*/
			,	#{docNo}				/*전표번호*/
			,	#{docPostingDate}		/*전표전기일자*/
			,	#{docPayDate}			/*전표지급일자*/
			,	#{interfaceKey_list}
			,	#{SessionUser}
			,	now()
			,	#{SessionUser}
			,	now()
			,	#{ReservedStr1}
			,	#{ReservedStr2}
			,	#{ReservedStr3}
			,	#{ReservedStr4}
			,	#{ReservedStr5}
			,	IF(CAST(#{ReservedInt1} AS VARCHAR(10)) = '', NULL, #{ReservedInt1})
			,	IF(CAST(#{ReservedInt2} AS VARCHAR(10)) = '', NULL, #{ReservedInt2})
		)
		<selectKey keyProperty="expenceApplicationListID" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>
	
	<update id="expenceApplicationListInterfaceUpdate" parameterType="cmap">
	    /*
 	    	expenceApplication.expenceApplicationListInterfaceUpdate
 	    */
 	    UPDATE covi_account4j_si.act_expence_application_list
 	    	SET
 	    		ProofDate			=	#{proofDate}			/*증빙일자*/
			,	ProofCode			=	#{proofCode}			/*증빙타입*/
			,	CardUID				=	#{cardUID}				/*카드승인번호*/
			,	CashUID				=	#{cashUID}				/*현금영수증승인번호*/
			,	TaxUID				=	#{taxUID}				/*세금계산서승인번호*/
			,	ReceiptID			=	#{receiptID}			/*모바일영수증ID*/
			,	PostingDate			=	#{postingDate}			/*전기일자*/
			,	TaxType				=	#{taxType}				/*세금유형*/
			,	TaxCode				=	#{taxCode}				/*세금코드*/
			,	PayAdjustMethod		=	#{payAdjustMethod}		/*정산방법*/
			,	PayMethod			=	#{payMethod}			/*지급방법*/
			,	PayDate				=	#{payDate}				/*지급일자*/
			,	IsWithholdingTax	=	#{isWithholdingTax}		/*원천세여부*/
			,	IncomeTax			=	#{incomeTax}			/*소득세유형*/
			,	LocalTax			=	#{localTax}				/*지방세유형*/
			,	VendorNo			=	#{vendorNo}				/*거래처등록번호*/
			,	PersonalCardNo		=	#{personalCardNo}		/*개인카드번호*/
			,	TotalAmount			=	#{totalAmount}			/*합계액*/
			,	DocNo				=	#{docNo}				/*전표번호*/
			,	DocPostingDate		=	#{docPostingDate}		/*전표전기일자*/
			,	DocPayDate			=	#{docPayDate}			/*전표지급일자*/
			,	ModifierID			= 	#{SessionUser}
			,	ModifyDate			= 	now()
			,	ReservedStr1		= 	#{ReservedStr1}
			,	ReservedStr2		= 	#{ReservedStr2}
			,	ReservedStr3		= 	#{ReservedStr3}
			,	ReservedStr4		= 	#{ReservedStr4}
			,	ReservedStr5		= 	#{ReservedStr5}
			,	ReservedInt1		= 	IF(CAST(#{ReservedInt1} AS VARCHAR(10)) = '', NULL, #{ReservedInt1})
			,	ReservedInt2		= 	IF(CAST(#{ReservedInt2} AS VARCHAR(10)) = '', NULL, #{ReservedInt2})
			,	Currency			=	IF(CAST(#{Currency} AS VARCHAR(10)) = '', NULL, #{Currency})			/*환종*/
			,	ExchangeRate		=	IF(CAST(#{ExchangeRate} AS VARCHAR(10)) = '', NULL, #{ExchangeRate})	/*환율*/
			,	LocalAmount			=	IF(CAST(#{LocalAmount} AS VARCHAR(10)) = '', NULL, #{LocalAmount})		/*현지금액*/
 	    WHERE	InterfaceKeyID	= #{interfaceKey_list}
	</update>
	
	<insert id="expenceApplicationDivInterfaceInsert" parameterType="cmap">
	    /*
 	    	expenceApplication.expenceApplicationDivInterfaceInsert
 	    */
 	    INSERT INTO covi_account4j_si.act_expence_application_div (
 	    		ExpenceApplicationListID
 	    	,	AccountCode
			,	StandardBriefID
			,	CostCenterCode
			,	IOCode
			,	Amount
			,	UsageComment
			,	InterfaceKeyID
			,	RegisterID
			,	RegistDate
			,	ReservedStr1
			,	ReservedStr2
			,	ReservedStr3
			,	ReservedStr4
			,	ReservedStr5
			,	ReservedInt1
			,	ReservedInt2
		)VALUES(
				#{expenceApplicationListID}
			,	#{accountCode}		/*계정과목*/
			,	#{standardBriefID}	/*표준적요ID*/
			,	#{costCenterCode}	/*코스트센터코드*/
			,	#{iOCode}			/*IO코드*/
			,	#{amount}			/*금액*/
			,	#{usageComment}		/*사용내역*/
			,	#{interfaceKey_Div}
			,	#{SessionUser}
			,	now()
			,	#{ReservedStr1_Div}
			,	#{ReservedStr2_Div}
			,	#{ReservedStr3_Div}
			,	#{ReservedStr4_Div}
			,	#{ReservedStr5_Div}
			,	IF(CAST(#{ReservedInt1_Div} AS VARCHAR(10)) = '', NULL, #{ReservedInt1_Div}) 
			,	IF(CAST(#{ReservedInt2_Div} AS VARCHAR(10)) = '', NULL, #{ReservedInt2_Div})
		)
	</insert>
	
	<update id="expenceApplicationDivInterfaceUpdate" parameterType="cmap">
	    /*
 	    	expenceApplication.expenceApplicationDivInterfaceUpdate
 	    */
 	    UPDATE covi_account4j_si.act_expence_application_div
 	    	SET
				AccountCode		= #{accountCode}		/*계정과목*/
			,	StandardBriefID	= #{standardBriefID}	/*표준적요ID*/
			,	CostCenterCode	= #{costCenterCode}		/*코스트센터코드*/
			,	IOCode			= #{iOCode}				/*IO코드*/
			,	Amount			= #{amount}				/*금액*/
			,	UsageComment	= #{usageComment}		/*사용내역*/
			,	ReservedStr1	= #{ReservedStr1_Div}
			,	ReservedStr2	= #{ReservedStr2_Div}
			,	ReservedStr3	= #{ReservedStr3_Div}
			,	ReservedStr4	= #{ReservedStr4_Div}
			,	ReservedStr5	= #{ReservedStr5_Div}
			,	ReservedInt1	= IF(CAST(#{ReservedInt1_Div} AS VARCHAR(10)) = '', NULL, #{ReservedInt1_Div})
			,	ReservedInt2	= IF(CAST(#{ReservedInt2_Div} AS VARCHAR(10)) = '', NULL, #{ReservedInt2_Div})
 	    WHERE	InterfaceKeyID	= #{interfaceKey_Div}
	</update>
	
	<select id="getInterFaceListEVIDENCE" parameterType="cmap" resultType="cmap">
		SELECT	#{interFaceSetType}	AS InterFaceSetType
			,	CASE	WHEN IFNULL(NULLIF(EA.InterfaceKeyID,''),'NODATA') = 'NODATA'
						THEN EA.ExpenceApplicationID
						ELSE EA.InterfaceKeyID
				END	AS FORM_INST_ID
			,	CASE	WHEN IFNULL(NULLIF(EL.InterfaceKeyID,''),'NODATA') = 'NODATA'
						THEN EL.ExpenceApplicationListID
						ELSE SUBSTR(EL.InterfaceKeyID,LENGTH(EA.InterfaceKeyID)+1)
				END	AS EVIDENCE_INDEX
			/*act_expence_application*/
			,	EA.applicationTitle				/*신청제목*/
			,	EA.applicationDate				/*신청일*/
			,	EA.ur_code						/*결재행위자*/
			
			/*act_expence_application_list*/
			,	EL.ExpenceApplicationID
			,	EL.ProofDate					/*증빙일자*/
			,	EL.ProofCode					/*증빙타입*/
			,	EL.CardUID				/*카드승인번호*/
			,	EL.TaxType						/*세금유형*/
			,	EL.TaxCode						/*세금코드*/
			,	EL.PayAdjustMethod				/*정산방법*/
			,	EL.PayMethod					/*지급방법*/
			,	EL.VendorNo						/*거래처등록번호*/
			,	EL.TotalAmount					/*합계액*/
			,	EL.DocNo						/*전표번호*/
		FROM	covi_account4j_si.act_expence_application EA
		LEFT OUTER JOIN	covi_account4j_si.act_expence_application_list	EL 
			ON EA.ExpenceApplicationID = EL.ExpenceApplicationID
		WHERE 
		<choose>
			<when test="keyIDs != null">
				<foreach collection="keyIDs" item="item" index="index" separator="," open="EA.ExpenceApplicationID IN (" close=")">
					#{item}
				</foreach>
			</when>
			<otherwise>
				1=2
			</otherwise>
		</choose>
	</select>
	
	<select id="getInterFaceListEVIDENCEDIVISION" parameterType="cmap" resultType="cmap">
		SELECT	#{interFaceSetType}	AS InterFaceSetType
			,	CASE	WHEN IFNULL(NULLIF(EA.InterfaceKeyID,''),'NODATA') = 'NODATA'
						THEN EA.ExpenceApplicationID
						ELSE EA.InterfaceKeyID
				END	AS FORM_INST_ID
			,	CASE	WHEN IFNULL(NULLIF(LD.EL_InterfaceKeyID,''),'NODATA') = 'NODATA'
						THEN LD.ExpenceApplicationListID
						ELSE SUBSTR(LD.EL_InterfaceKeyID,LENGTH(EA.InterfaceKeyID)+1)
				END	AS EVIDENCE_INDEX
			,	CASE	WHEN IFNULL(NULLIF(LD.ED_InterfaceKeyID,''),'NODATA') = 'NODATA'
						THEN LD.ExpenceApplicationDivID
						ELSE SUBSTR(LD.ED_InterfaceKeyID,LENGTH(EA.InterfaceKeyID)+1)
				END	AS DIVISION_INDEX
			/*act_expence_application*/
			,	EA.applicationTitle				/*신청제목*/
			,	EA.applicationDate				/*신청일*/
			,	EA.ur_code						/*결재행위자*/

			/*act_expence_application_list*/
			,	LD.proofDate					/*증빙일자*/
			,	LD.proofCode					/*증빙타입*/
			,	LD.cardUID				/*카드승인번호*/
			,	LD.taxType						/*세금유형*/
			,	LD.taxCode						/*세금코드*/
			,	LD.payAdjustMethod				/*정산방법*/
			,	LD.payMethod					/*지급방법*/
			,	LD.vendorNo						/*거래처등록번호*/
			,	LD.totalAmount					/*합계액*/
			,	LD.docNo						/*전표번호*/

			/*act_expence_application_div*/
			,	LD.accountCode					/*계정과목*/
			,	LD.costCenterCode				/*코스트센터코드*/
			,	LD.amount						/*금액*/
			,	LD.usageComment				/*사용내역*/
		FROM	covi_account4j_si.act_expence_application EA
		LEFT OUTER JOIN (	SELECT	/*act_expence_application_list*/
									EL.ExpenceApplicationID
								,	EL.ExpenceApplicationListID
								,	EL.ProofDate					/*증빙일자*/
								,	EL.ProofCode					/*증빙타입*/
								,	EL.CardUID				/*카드승인번호*/
								,	EL.TaxType						/*세금유형*/
								,	EL.TaxCode						/*세금코드*/
								,	EL.PayAdjustMethod				/*정산방법*/
								,	EL.PayMethod					/*지급방법*/
								,	EL.VendorNo						/*거래처등록번호*/
								,	EL.TotalAmount					/*합계액*/
								,	EL.DocNo						/*전표번호*/
								,	EL.InterfaceKeyID				AS EL_InterfaceKeyID
								/*act_expence_application_div*/
								,	ED.ExpenceApplicationDivID
								,	ED.accountCode					/*계정과목*/
								,	ED.costCenterCode				/*코스트센터코드*/
								,	ED.amount						/*금액*/
								,	ED.usageComment					/*사용내역*/
								,	ED.InterfaceKeyID				AS ED_InterfaceKeyID
							FROM	covi_account4j_si.act_expence_application_list EL
							LEFT OUTER JOIN covi_account4j_si.act_expence_application_div ED
								ON	EL.ExpenceApplicationListID	= ED.ExpenceApplicationListID
						)	LD
			ON EA.ExpenceApplicationID = LD.ExpenceApplicationID
		WHERE	
		<choose>
			<when test="keyIDs != null">
				<foreach collection="keyIDs" item="item" index="index" separator="," open="EA.ExpenceApplicationID IN (" close=")">
					#{item}
				</foreach>
			</when>
			<otherwise>
				1=2
			</otherwise>
		</choose>
	</select>
	
	<select id="selectCapitalSpendingStatus" parameterType="cmap" resultType="cmap">
		SELECT 
			A.ExpenceApplicationID 
			, A.CompanyCode
			, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, #{companyCode}) CompanyName
			, A.ProcessID
			, A.FormInstID
			, A.RequestType
			, A.RequestTypeName
			, A.ApplicationTitle
			, A.ApplicationDate
			, A.RegistDate
			, A.RegisterID
			, A.RegisterName
			, A.ExpenceApplicationListID
			, A.ProofCode			
			, covi_account4j_si.Fn_GetBaseCodeName('ProofCode', A.ProofCode, #{companyCode}) ProofCodeName	
			, A.CardUID 
			, A.CashUID
			, A.TaxUID
			, A.ReceiptID
			, A.VendorName
			, A.TotalAmount
			, A.AmountSum
			, FileCnt
			, A.RealPayDate
			, IFNULL(A.RealPayAmount, A.AmountSum) AS RealPayAmount  
			, A.CapitalStatus
			, covi_account4j_si.Fn_GetBaseCodeName('CapitalStatus', A.CapitalStatus, #{companyCode}) CapitalStatusName	
			, A.CapitalProcessID
			, A.CapitalFormInstID
			, A.ReceiptFileID
		FROM(
			SELECT
				AEA.ExpenceApplicationID
				, AEA.CompanyCode 
				, AEA.ProcessID
				, (SELECT FormInstID FROM covi_approval4j.jwf_process P WHERE AEA.ProcessID = P.ProcessID) AS FormInstID
				, AEA.RequestType
				, AEF.FormName AS RequestTypeName
				, AEA.ApplicationTitle
				, AEA.ApplicationDate
				, AEA.RegistDate
				, AEA.RegisterID
				, USR.DisplayName AS RegisterName
				, AEAL.ExpenceApplicationListID
				, AEAL.ProofCode			
				, AEAL.CardUID
				, AEAL.CashUID
				, AEAL.TaxUID
				, AEAL.ReceiptID
				, IFNULL(
					IFNULL(VD.VendorName, ATI.InvoicerCorpName), 
					(SELECT DisplayName FROM covi_smart4j.sys_object_user WHERE UserCode = (IFNULL(AEAL.VendorNo, AEA.RegisterID)))
				) AS VendorName		
				, AEAL.TotalAmount
				, (
					SELECT 
					CASE 
						WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
						ELSE SUM(AEAD.Amount) 
					END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSum
				, (
					SELECT COUNT(*) 
					FROM covi_account4j_si.act_expence_application_file AEAF
					WHERE AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
				) AS FileCnt		
				, DATE_FORMAT(IFNULL(AEAL.RealPayDate, AEAL.PayDate), '%Y.%m.%d') AS RealPayDate
				, AEAL.RealPayAmount
				, AEAL.CapitalStatus
				, AEAL.CapitalProcessID
				, (SELECT FormInstID FROM covi_approval4j.jwf_process P WHERE AEAL.CapitalProcessID = P.ProcessID) AS CapitalFormInstID
				, AR.ReceiptFileID
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user USR
			ON AEA.RegisterID = USR.UserCode
			LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
			ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
			ON AEAL.TaxUID = ATI.TaxInvoiceID
			LEFT OUTER JOIN covi_account4j_si.act_receipt AR
			ON AEAL.ReceiptID = AR.ReceiptID
			WHERE 1=1
			AND AEAL.CapitalStatus IS NOT NULL
			<if test ="companyCode != null and companyCode !=''">
				AND	AEA.CompanyCode = #{companyCode}
			</if>
		  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
			 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
			</if>		  	
		  	<if test="RegisterNm != null and RegisterNm != ''">
			 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
			</if>
		  	<if test="ProofCode != null and ProofCode != ''">
			 	AND AEAL.ProofCode = #{ProofCode}
			</if>	
		  	<if test="RequestType != null and RequestType != ''">
			 	AND AEA.RequestType = #{RequestType}
			</if>	
		  	<if test="CapitalStatus != null and CapitalStatus != ''">
			 	AND AEAL.CapitalStatus = #{CapitalStatus}
			</if>	
			<if test="RealPayDate != null and RealPayDate != ''">
			    AND (CASE WHEN AEAL.RealPayDate IS NULL THEN AEAL.PayDate ELSE AEAL.RealPayDate END) = #{RealPayDate}
			</if>	
		  	<if test="VendorName != null and VendorName != ''">
			 	AND (
			 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
			 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
			 	)
			</if>
		  	<if test="CostCenterCode != null and CostCenterCode != ''">
		  		AND #{CostCenterCode} IN (
		  			SELECT CostCenterCode 
		  			FROM covi_account4j_si.act_expence_application_div AEAD
		  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		  		)
			</if>
		  	<if test="AccountCode != null and AccountCode != ''">
		  		AND #{AccountCode} IN (
		  			SELECT AccountCode 
		  			FROM covi_account4j_si.act_expence_application_div AEAD
		  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		  		)
			</if>
		  	<if test="StandardBriefID != null and StandardBriefID != ''">
		  		AND #{StandardBriefID} IN (
		  			SELECT StandardBriefID 
		  			FROM covi_account4j_si.act_expence_application_div AEAD
		  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		  		)
			</if>
		  	<if test="IOCode != null and IOCode != ''">
		  		AND #{IOCode} IN (
		  			SELECT IOCode 
		  			FROM covi_account4j_si.act_expence_application_div AEAD
		  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		  		)
			</if>	
		) AS A
		<trim prefix="ORDER BY"  prefixOverrides =",">
			 <if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
		        IFNULL(A.ApplicationDate, A.RegistDate) DESC
				, A.ExpenceApplicationID DESC 
		    </if>
		  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>	
					<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<when test='sortColumn.equalsIgnoreCase("RequestTypeName")'>RequestTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("CapitalStatusName")'>CapitalStatusName</when>
					<when test='sortColumn.equalsIgnoreCase("RealPayDate")'>RealPayDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofCodeName")'>ProofCodeName</when>
					<when test='sortColumn.equalsIgnoreCase("VendorName")'>VendorName</when>
					<when test='sortColumn.equalsIgnoreCase("TotalAmount")'>TotalAmount</when>
					<when test='sortColumn.equalsIgnoreCase("AmountSum")'>AmountSum</when>
					<when test='sortColumn.equalsIgnoreCase("RealPayAmount")'>RealPayAmount</when>
					<when test='sortColumn.equalsIgnoreCase("FileCnt")'>FileCnt</when>
					<when test='sortColumn.equalsIgnoreCase("DocCnt")'>DocCnt</when>
				</choose>	
				<choose>	
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>	
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="selectCapitalSpendingStatusCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user USR
		ON AEA.RegisterID = USR.UserCode
		LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
		ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_receipt AR
		ON AEAL.ReceiptID = AR.ReceiptID
		WHERE 1=1
		AND AEAL.CapitalStatus IS NOT NULL
		<if test ="companyCode != null and companyCode !=''">
			AND	AEA.CompanyCode = #{companyCode}
		</if>
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
		</if>		  	
	  	<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>
	  	<if test="ProofCode != null and ProofCode != ''">
		 	AND AEAL.ProofCode = #{ProofCode}
		</if>	
	  	<if test="CapitalStatus != null and CapitalStatus != ''">
		 	AND AEAL.CapitalStatus = #{CapitalStatus}
		</if>	
		<if test="RealPayDate != null and RealPayDate != ''">
		    AND (CASE WHEN AEAL.RealPayDate IS NULL THEN AEAL.PayDate ELSE AEAL.RealPayDate END) = #{RealPayDate}
		</if>	
	  	<if test="VendorName != null and VendorName != ''">
		 	AND (
		 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 	)
		</if>
	  	<if test="CostCenterCode != null and CostCenterCode != ''">
	  		AND #{CostCenterCode} IN (
	  			SELECT CostCenterCode 
	  			FROM covi_account4j_si.act_expence_application_div AEAD
	  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
	  		)
		</if>
	  	<if test="AccountCode != null and AccountCode != ''">
	  		AND #{AccountCode} IN (
	  			SELECT AccountCode 
	  			FROM covi_account4j_si.act_expence_application_div AEAD
	  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
	  		)
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
	  		AND #{StandardBriefID} IN (
	  			SELECT StandardBriefID 
	  			FROM covi_account4j_si.act_expence_application_div AEAD
	  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
	  		)
		</if>
	  	<if test="IOCode != null and IOCode != ''">
	  		AND #{IOCode} IN (
	  			SELECT IOCode 
	  			FROM covi_account4j_si.act_expence_application_div AEAD
	  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
	  		)
		</if>
	</select>
	
	<select id="selectCapitalSpendingStatusExcel" parameterType="cmap" resultType="cmap">
		SELECT 
			A.ExpenceApplicationID 
			, A.CompanyCode
			, covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', A.CompanyCode, #{companyCode}) CompanyName
			, A.ProcessID
			, A.RequestType
			, A.RequestTypeName
			, A.ApplicationTitle
			, A.ApplicationDate
			, A.RegistDate
			, A.RegisterID
			, A.RegisterName
			, A.ExpenceApplicationListID
			, A.ProofCode			
			, covi_account4j_si.Fn_GetBaseCodeName('ProofCode', A.ProofCode, #{companyCode}) ProofCodeName	
			, A.CardUID 
			, A.CashUID
			, A.TaxUID
			, A.ReceiptID
			, A.VendorName
			, A.TotalAmount
			, A.AmountSum
			, FileCnt
			, A.RealPayDate
			, IFNULL(A.RealPayAmount, A.AmountSum) AS RealPayAmount  
			, A.CapitalStatus
			, covi_account4j_si.Fn_GetBaseCodeName('CapitalStatus', A.CapitalStatus, #{companyCode}) CapitalStatusName	
			, A.CapitalProcessID
			, A.ReceiptFileID
		FROM(
			SELECT
				AEA.ExpenceApplicationID 
				, AEA.CompanyCode
				, AEA.ProcessID
				, AEA.RequestType
				, AEF.FormName AS RequestTypeName
				, AEA.ApplicationTitle
				, AEA.ApplicationDate
				, AEA.RegistDate
				, AEA.RegisterID
				, USR.DisplayName AS RegisterName
				, AEAL.ExpenceApplicationListID
				, AEAL.ProofCode			
				, AEAL.CardUID
				, AEAL.CashUID
				, AEAL.TaxUID
				, AEAL.ReceiptID
				, IFNULL(
					IFNULL(VD.VendorName, ATI.InvoicerCorpName), 
					(SELECT DisplayName FROM covi_smart4j.sys_object_user WHERE UserCode = (IFNULL(AEAL.VendorNo, AEA.RegisterID)))
				) AS VendorName		
				, AEAL.TotalAmount
				, (
					SELECT 
					CASE 
						WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
						ELSE SUM(AEAD.Amount) 
					END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSum
				, (
					SELECT COUNT(*) 
					FROM covi_account4j_si.act_expence_application_file AEAF
					WHERE AEAL.ExpenceApplicationListID = AEAF.ExpenceApplicationListID
				) AS FileCnt		
				, DATE_FORMAT(IFNULL(AEAL.RealPayDate, AEAL.PayDate), '%Y.%m.%d') AS RealPayDate
				, AEAL.RealPayAmount
				, AEAL.CapitalStatus
				, AEAL.CapitalProcessID
				, AR.ReceiptFileID
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user USR
			ON AEA.RegisterID = USR.UserCode
			LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
			ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
			ON AEAL.TaxUID = ATI.TaxInvoiceID
			LEFT OUTER JOIN covi_account4j_si.act_receipt AR
			ON AEAL.ReceiptID = AR.ReceiptID
			WHERE 1=1
			AND AEAL.CapitalStatus IS NOT NULL
			<if test ="companyCode != null and companyCode !=''">
				AND	AEA.CompanyCode = #{companyCode}
			</if>
		  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
			 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
			</if>		  	
		  	<if test="RegisterNm != null and RegisterNm != ''">
			 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
			</if>
		  	<if test="ProofCode != null and ProofCode != ''">
			 	AND AEAL.ProofCode = #{ProofCode}
			</if>	
		  	<if test="RequestType != null and RequestType != ''">
			 	AND AEA.RequestType = #{RequestType}
			</if>	
		  	<if test="CapitalStatus != null and CapitalStatus != ''">
			 	AND AEAL.CapitalStatus = #{CapitalStatus}
			</if>	
			<if test="RealPayDate != null and RealPayDate != ''">
			    AND (CASE WHEN AEAL.RealPayDate IS NULL THEN AEAL.PayDate ELSE AEAL.RealPayDate END) = #{RealPayDate}
			</if>	
		  	<if test="VendorName != null and VendorName != ''">
			 	AND (
			 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
			 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
			 	)
			</if>
		  	<if test="CostCenterCode != null and CostCenterCode != ''">
		  		AND #{CostCenterCode} IN (
		  			SELECT CostCenterCode 
		  			FROM covi_account4j_si.act_expence_application_div AEAD
		  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		  		)
			</if>
		  	<if test="AccountCode != null and AccountCode != ''">
		  		AND #{AccountCode} IN (
		  			SELECT AccountCode 
		  			FROM covi_account4j_si.act_expence_application_div AEAD
		  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		  		)
			</if>
		  	<if test="StandardBriefID != null and StandardBriefID != ''">
		  		AND #{StandardBriefID} IN (
		  			SELECT StandardBriefID 
		  			FROM covi_account4j_si.act_expence_application_div AEAD
		  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		  		)
			</if>
		  	<if test="IOCode != null and IOCode != ''">
		  		AND #{IOCode} IN (
		  			SELECT IOCode 
		  			FROM covi_account4j_si.act_expence_application_div AEAD
		  			WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		  		)
			</if>
		) AS A
		<trim prefix="ORDER BY"  prefixOverrides =",">
			 <if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
		        IFNULL(A.ApplicationDate, A.RegistDate) DESC
				, A.ExpenceApplicationID DESC 
		    </if>
		  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>	
					<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<when test='sortColumn.equalsIgnoreCase("RequestTypeName")'>RequestTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("CapitalStatusName")'>CapitalStatusName</when>
					<when test='sortColumn.equalsIgnoreCase("RealPayDate")'>RealPayDate</when>
					<when test='sortColumn.equalsIgnoreCase("ProofCodeName")'>ProofCodeName</when>
					<when test='sortColumn.equalsIgnoreCase("VendorName")'>VendorName</when>
					<when test='sortColumn.equalsIgnoreCase("TotalAmount")'>TotalAmount</when>
					<when test='sortColumn.equalsIgnoreCase("AmountSum")'>AmountSum</when>
					<when test='sortColumn.equalsIgnoreCase("RealPayAmount")'>RealPayAmount</when>
					<when test='sortColumn.equalsIgnoreCase("FileCnt")'>FileCnt</when>
					<when test='sortColumn.equalsIgnoreCase("DocCnt")'>DocCnt</when>
				</choose>	
				<choose>	
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>	
			</if>
		</trim>
	</select>
	
	<select id="selectCapitalEditData" parameterType="cmap" resultType="cmap">
		SELECT 
			RealPayDate
			, IFNULL(RealPayAmount, AmountSum) AS RealPayAmount
		FROM (
			SELECT
				DATE_FORMAT(IFNULL(AEAL.RealPayDate, AEAL.PayDate), '%Y.%m.%d') AS RealPayDate
				, RealPayAmount
				, (
					SELECT 
					CASE 
						WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
						ELSE SUM(AEAD.Amount) 
					END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				) AS AmountSum
			FROM covi_account4j_si.act_expence_application_list AEAL
			WHERE 1=1
			<if test="expAppListID != null and expAppListID != ''">
				AND ExpenceApplicationListID = #{expAppListID}
			</if>
		) A
	</select>
	
	<update id="updateCapitalEditInfo" parameterType="cmap">
		UPDATE covi_account4j_si.act_expence_application_list
		SET
			RealPayDate = #{RealPayDate}
			<if test="expAppListID.length == 1">
			, RealPayAmount = #{RealPayAmount}
			</if>
		WHERE 1=1
		AND ExpenceApplicationListID IN
		<foreach collection="expAppListID" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</update>
    
    <insert id="insertCapitalReportInfo" parameterType="cmap">
    	INSERT INTO covi_account4j_si.act_capital_report
    	(
    		ProcessID,
    		Subject,
    		expAppListIDs,
    		InitiatorCodeDisplay,
    		InitiatorDisplay,
    		RealPayDate,
    		RealPayAmount,
    		AccountCode,
    		AccountName,
    		StandardBriefID,
    		StandardBriefName
    	) VALUES (
    		#{ProcessID},
    		#{Subject},
    		#{strExpAppListIDs},
    		#{InitiatorCodeDisplay},
    		#{InitiatorDisplay},
    		#{RealPayDate},
    		#{RealPayAmount},
    		(SELECT AccountCode FROM covi_account4j_si.act_account WHERE AccountID = (SELECT AccountID FROM covi_account4j_si.act_standard_brief WHERE StandardBriefID = #{StandardBriefID})),
    		(SELECT AccountName FROM covi_account4j_si.act_account WHERE AccountID = (SELECT AccountID FROM covi_account4j_si.act_standard_brief WHERE StandardBriefID = #{StandardBriefID})),
    		#{StandardBriefID},
    		(SELECT StandardBriefName FROM covi_account4j_si.act_standard_brief WHERE StandardBriefID = #{StandardBriefID})
    	)
    </insert>
    
    <update id="updateIsCapitalReport" parameterType="cmap">
    	UPDATE covi_account4j_si.act_expence_application_list
    	SET ReservedStr5 = 'Y'
    	WHERE 
    	<choose>
			<when test="expAppListIDs != null">
				<foreach collection="expAppListIDs" item="item" index="index" separator="," open="ExpenceApplicationListID IN (" close=")">
					#{item}
				</foreach>
			</when>
			<otherwise>
				1=2
			</otherwise>
		</choose>
    </update>
	
	<select id="getCapitalSpendingList" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.getCapitalSpendingList
		*/
		
		SELECT A.ExpenceApplicationID 
			, A.ApplicationTitle
			, A.ProcessID
			, A.RequestType
			, A.RequestTypeName
			, A.RegisterID
			, A.RegisterName
			, A.ExpenceApplicationListID
			, A.ProofCode
			, covi_account4j_si.Fn_GetBaseCodeName('ProofCode', A.ProofCode, #{companyCode}) ProofCodeName
			, A.RealPayDate
			, A.PayMethod
			, covi_account4j_si.Fn_GetBaseCodeName('PayMethod', A.PayMethod, #{companyCode}) PayMethodName
			, A.VendorNo
			, A.VendorName
			, A.TotalAmount
			, A.AmountSum
			, IFNULL(A.RealPayAmount, A.AmountSum) AS RealPayAmount  
			, A.StandardBriefID
			, A.StandardBriefName
			, A.Amount
			, A.UsageComment
		FROM (
			SELECT AEA.ExpenceApplicationID 
				, AEA.ApplicationTitle
				, AEA.ProcessID
				, AEA.RequestType
				, AEF.FormName AS RequestTypeName
				, AEA.RegisterID
				, USR.DisplayName RegisterName
				, AEAL.ExpenceApplicationListID
				, AEAL.ProofCode
				, DATE_FORMAT(IFNULL(AEAL.RealPayDate, AEAL.PayDate), '%Y.%m.%d') AS RealPayDate
				, CASE 
					WHEN AEAL.PayMethod IS NULL THEN CASE WHEN AEAL.ProofCode = 'CorpCard' THEN 'D' ELSE 'C' END
					ELSE AEAL.PayMethod
				  END AS PayMethod
				, IFNULL(AEAL.VendorNo, AEA.RegisterID) AS VendorNo
				, IFNULL(IFNULL(VD.VendorName, ATI.InvoicerCorpName), (SELECT DisplayName FROM covi_smart4j.sys_object_user WHERE UserCode = (IFNULL(AEAL.VendorNo, AEA.RegisterID)))) AS VendorName
				, AEAL.TotalAmount
				, (
					SELECT 
					CASE 
						WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
						ELSE SUM(AEAD.Amount) 
					END
					FROM covi_account4j_si.act_expence_application_div AEAD
					WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
				  ) AS AmountSum
				, AEAL.RealPayAmount
				, AEAD.StandardBriefID
				, AEAD.StandardBriefName
				, AEAD.Amount
				, AEAD.UsageComment
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AEAD
			ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			LEFT OUTER JOIN covi_smart4j.sys_object_user USR
			ON AEA.RegisterID = USR.UserCode
			LEFT OUTER JOIN covi_account4j_si.act_expence_forms AEF
			ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
			ON AEAL.TaxUID = ATI.TaxInvoiceID
			WHERE 1=1
			AND AEAL.CapitalStatus = 'W'
			AND AEA.CompanyCode = #{CompanyCode}
		  	<if test="RealPayDate != null and RealPayDate != ''">
				<![CDATA[
				    AND (CASE WHEN AEAL.RealPayDate IS NULL THEN AEAL.PayDate ELSE AEAL.RealPayDate END) = #{RealPayDate}
				]]>
			</if>		
			<if test="expAppListIDs != null">
				AND 
				<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEAL.ExpenceApplicationListID IN (" close=")">
					#{item}
				</foreach>
			</if>
		  	<if test="StandardBriefID != null and StandardBriefID != ''">
				<![CDATA[
				 	AND AEAD.StandardBriefID = #{StandardBriefID}
				]]>
			</if>
		) AS A
		ORDER BY A.ExpenceApplicationListID
	</select>
	
	<select id="getCapitalSpendingListVendor" parameterType="cmap" resultType="cmap">
		SELECT SUM(A.RealPayAmount) AS RealPayAmountSum
				, SUM(A.TotalAmount) AS TotalAmountSum
				, COUNT(A.ExpenceApplicationID) AS ListCnt
				, A.ExpenceApplicationID
				, GROUP_CONCAT(A.ExpenceApplicationListID) AS expAppListIDs
				, A.RegisterID
				, MAX(A.RegisterName) RegisterName
				, A.PayMethod
				, covi_account4j_si.Fn_GetBaseCodeName('PayMethod', A.PayMethod, #{companyCode}) PayMethodName
				, A.VendorNo
				, MAX(A.VendorName) AS VendorName
				, MAX(A.RealPayDate) AS RealPayDate
				, A.StandardBriefID
				, MAX(A.StandardBriefName) AS StandardBriefName
				, MIN(A.UsageComment) AS UsageComment
		FROM (
			SELECT 
				AEA.ExpenceApplicationID
				, AEA.RegisterID
				, USR.DisplayName RegisterName
				, AEAL.ExpenceApplicationListID
				, CASE 
					WHEN AEAL.PayMethod IS NULL THEN CASE WHEN AEAL.ProofCode = 'CorpCard' THEN 'D' ELSE 'C' END
					ELSE AEAL.PayMethod
					END AS PayMethod
				, CASE WHEN AEAL.RealPayAmount IS NULL
					THEN (
						SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
							ELSE SUM(AEAD.Amount) 
						END
						FROM covi_account4j_si.act_expence_application_div AEAD
						WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					)
					ELSE AEAL.RealPayAmount END AS RealPayAmount
				, AEAL.TotalAmount
				, IFNULL(AEAL.VendorNo, AEA.RegisterID) AS VendorNo
				, IFNULL(IFNULL(VD.VendorName, ATI.InvoicerCorpName), (SELECT DisplayName FROM covi_smart4j.sys_object_user WHERE UserCode = (IFNULL(AEAL.VendorNo, AEA.RegisterID)))) AS VendorName
				, DATE_FORMAT(IFNULL(AEAL.RealPayDate, AEAL.PayDate), '%Y.%m.%d') AS RealPayDate
				, (SELECT StandardBriefID FROM covi_account4j_si.act_expence_application_div AEAD WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID LIMIT 1) StandardBriefID
				, (SELECT StandardBriefName FROM covi_account4j_si.act_expence_application_div AEAD WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID LIMIT 1) StandardBriefName
				, (SELECT UsageComment FROM covi_account4j_si.act_expence_application_div AEAD WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID LIMIT 1) UsageComment 	
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL 
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_smart4j.sys_object_user USR 
			ON AEA.RegisterID = USR.UserCode
			INNER JOIN covi_account4j_si.act_expence_forms AEF 
			ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_vendor VD
			ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
			LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
			ON AEAL.TaxUID = ATI.TaxInvoiceID
			WHERE 1=1
			AND AEF.MenuType = 'V'
			AND AEA.RequestType IN ('VENDOR') 
			AND AEAL.CapitalStatus = 'W'
			AND AEA.CompanyCode = #{CompanyCode}
			<if test="RealPayDate != null and RealPayDate != ''">
				AND (CASE WHEN AEAL.RealPayDate IS NULL THEN AEAL.PayDate ELSE AEAL.RealPayDate END) = #{RealPayDate}
			</if>
			<if test="expAppListIDs != null">
				AND 
				<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEAL.ExpenceApplicationListID IN (" close=")">
					#{item}
				</foreach>
			</if>
		  	<if test="StandardBriefID != null and StandardBriefID != ''">
				<![CDATA[
				 	AND (SELECT StandardBriefID FROM covi_account4j_si.act_expence_application_div AEAD WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID LIMIT 1) = #{StandardBriefID}
				]]>
			</if>
		) A
		GROUP BY A.ExpenceApplicationID
				, A.RegisterID
				, A.PayMethod
				, A.VendorNo
				, A.StandardBriefID
	</select>
    
    <select id="getCapitalSpendingListReport" parameterType="cmap" resultType="cmap">
    	SELECT
    		CapitalReportID,
    		ProcessID,
    		Subject,
    		expAppListIDs,
    		InitiatorCodeDisplay,
    		InitiatorDisplay,
    		RealPayDate,
    		RealPayAmount,
    		AccountCode,
    		AccountName,
    		StandardBriefID,
    		StandardBriefName
    	FROM covi_account4j_si.act_capital_report
    	WHERE 1=1
    	<if test="RealPayDate != null and RealPayDate != ''">
    		AND RealPayDate = #{RealPayDate}
    	</if> 
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
			<![CDATA[
			 	AND StandardBriefID = #{StandardBriefID}
			]]>
		</if>	
    </select>
	
	<select id="getCapitalSpendingListEmployee" parameterType="cmap" resultType="cmap">
		SELECT SUM(A.RealPayAmount) RealPayAmountSum
			, A.RequestType
			, MAX(A.RequestTypeName) RequestTypeName
			, MAX(A.RealPayDate) AS RealPayDate
			, GROUP_CONCAT(A.ExpenceApplicationListID) AS expAppListIDs
		FROM (
			SELECT 
				AEA.RequestType
				, AEA.ExpenceApplicationID
				, AEF.FormName RequestTypeName
				, AEAL.ExpenceApplicationListID
				, CASE WHEN AEAL.RealPayAmount IS NULL
					THEN (
						SELECT 
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + AEAL.TaxAmount 
							ELSE SUM(AEAD.Amount) 
						END
						FROM covi_account4j_si.act_expence_application_div AEAD
						WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					)
					ELSE AEAL.RealPayAmount END AS RealPayAmount
				, DATE_FORMAT(IFNULL(AEAL.RealPayDate, AEAL.PayDate), '%Y.%m.%d') AS RealPayDate
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL 
			ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_forms AEF
			ON AEA.RequestType = AEF.FormCode and AEF.CompanyCode = AEA.CompanyCode
			WHERE 1=1
			AND AEF.MenuType = 'E'
			AND AEA.RequestType IN ('NORMAL', 'PROJECT', 'ENTERTAIN', 'BIZTRIP', 'OVERSEA') 
			AND AEAL.CapitalStatus = 'W'
			AND AEA.CompanyCode = #{CompanyCode}
			<if test="RealPayDate != null and RealPayDate != ''">
				AND (CASE WHEN AEAL.RealPayDate IS NULL THEN AEAL.PayDate ELSE AEAL.RealPayDate END) = #{RealPayDate}
			</if>
			<if test="expAppListIDs != null">
				AND 
				<foreach collection="expAppListIDs" item="item" index="index" separator="," open="AEAL.ExpenceApplicationListID IN (" close=")">
					#{item}
				</foreach>
			</if>
		  	<if test="StandardBriefID != null and StandardBriefID != ''">
				<![CDATA[
				 	AND (SELECT StandardBriefID FROM covi_account4j_si.act_expence_application_div AEAD WHERE AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID LIMIT 1) = #{StandardBriefID}
				]]>
			</if>
		) A
		GROUP BY A.RequestType
	</select>
	
	<select id="selectCapitalSummary" parameterType="cmap" resultType="cmap">
		SELECT
		CASE WHEN RealPayDate = 'TOTAL' THEN RealPayDate ELSE DATE_FORMAT(RealPayDate, '%Y-%m-%d') END AS RealPayDate
		, ProcessId
		, FormInstID
		, Subject
		, IFNULL(FORMAT(C_Sum, 0), '-') AS C_Sum
		, IFNULL(FORMAT(A_Sum, 0), '-') AS A_Sum
		, IFNULL(FORMAT(D_Sum, 0), '-') AS D_Sum
		, IFNULL(FORMAT(G_Sum, 0), '-') AS G_Sum
		, IFNULL(FORMAT(T_Sum, 0), '-') AS T_Sum
		, IFNULL(FORMAT(TotalSum, 0), '-') AS TotalSum
		FROM (
			SELECT 
			RealPayDate
			, GROUP_CONCAT(JF.FormInstId) AS FormInstID
			, GROUP_CONCAT(JF.ProcessId) AS ProcessId
			, GROUP_CONCAT(JF.Subject SEPARATOR '^^^') AS Subject
			, SUM(CorpCardAmount) AS C_Sum
			, SUM(AutoAmount)AS A_Sum
			, SUM(NormalAmount) AS D_Sum
			, SUM(CashAmount) AS G_Sum
			, SUM(AccountAmount) AS T_Sum
			, SUM(RealPayAmount) AS TotalSum
			FROM covi_account4j_si.act_capital_resolution AS ACR
			INNER JOIN covi_approval4j.jwf_forminstance AS JF ON ACR.FormInstId = JF.FormInstID
			WHERE 1=1
			<if test="CompanyCode != null and CompanyCode != ''">
			AND JF.EntCode = #{CompanyCode}
			</if>
			<if test="RealPayDateSt != null and RealPayDateSt != ''">
			AND ACR.RealPayDate <![CDATA[>=]]> #{RealPayDateSt}
			</if>
			<if test="RealPayDateEd != null and RealPayDateEd != ''">
			AND ACR.RealPayDate <![CDATA[<=]]> #{RealPayDateEd}
			</if>
			GROUP BY ACR.RealPayDate
			
			UNION ALL
			
			SELECT 
			'TOTAL' AS RealPayDate
			, NULL AS FormInstID
			, NULL AS ProcessId
			, NULL AS Subject
			, SUM(CorpCardAmount) AS C_Sum
			, SUM(AutoAmount)AS A_Sum
			, SUM(NormalAmount) AS D_Sum
			, SUM(CashAmount) AS G_Sum
			, SUM(AccountAmount) AS T_Sum
			, SUM(RealPayAmount) AS TotalSum
			FROM covi_account4j_si.act_capital_resolution AS ACR
			INNER JOIN covi_approval4j.jwf_forminstance AS JF ON ACR.FormInstId = JF.FormInstID
			WHERE 1=1
			<if test="CompanyCode != null and CompanyCode != ''">
			AND JF.EntCode = #{CompanyCode}
			</if>
			<if test="RealPayDateSt != null and RealPayDateSt != ''">
			AND ACR.RealPayDate <![CDATA[>=]]> #{RealPayDateSt}
			</if>
			<if test="RealPayDateEd != null and RealPayDateEd != ''">
			AND ACR.RealPayDate <![CDATA[<=]]> #{RealPayDateEd}
			</if>
			<trim prefix="ORDER BY"  prefixOverrides =",">
			    <if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
					,RealPayDate ASC 
			    </if>
			  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				 	, 	
				<choose>	
					<when test='sortColumn.equalsIgnoreCase("RealPayDate")'>RealPayDate</when>
					<when test='sortColumn.equalsIgnoreCase("A_Sum")'>A_Sum</when>
					<when test='sortColumn.equalsIgnoreCase("D_Sum")'>D_Sum</when>
					<when test='sortColumn.equalsIgnoreCase("C_Sum")'>C_Sum</when>
					<when test='sortColumn.equalsIgnoreCase("G_Sum")'>G_Sum</when>
					<when test='sortColumn.equalsIgnoreCase("T_Sum")'>T_Sum</when>
					<when test='sortColumn.equalsIgnoreCase("TotalSum")'>TotalSum</when>
				</choose>	
				<choose>	
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>	
				</if>
			</trim>
		) Result
	</select>
	
	<select id="selectCapitalSummaryCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM (
			SELECT 
			RealPayDate
			, SUM(CorpCardAmount) AS C_Sum
			, SUM(AutoAmount)AS A_Sum
			, SUM(NormalAmount) AS D_Sum
			, SUM(CashAmount) AS G_Sum
			, SUM(AccountAmount) AS T_Sum
			, SUM(RealPayAmount) AS TotalSum
			FROM covi_account4j_si.act_capital_resolution AS ACR
			INNER JOIN covi_approval4j.jwf_forminstance AS JF ON ACR.FormInstId = JF.FormInstID
			WHERE 1=1
			<if test="CompanyCode != null and CompanyCode != ''">
			AND JF.EntCode = #{CompanyCode}
			</if>
			<if test="RealPayDateSt != null and RealPayDateSt != ''">
			AND ACR.RealPayDate <![CDATA[>=]]> #{RealPayDateSt}
			</if>
			<if test="RealPayDateEd != null and RealPayDateEd != ''">
			AND ACR.RealPayDate <![CDATA[<=]]> #{RealPayDateEd}
			</if>
			GROUP BY ACR.RealPayDate
		) A
	</select>
	
	<select id="selectExpenceApplicationDouzoneExcel" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDouzoneExcel
		*/
		
		SELECT 	DATE_FORMAT( AEAL.ProofDate, '%Y') AS ProofYear
			, DATE_FORMAT( AEAL.ProofDate, '%m') AS ProofMonth
			, DATE_FORMAT( AEAL.ProofDate, '%d') AS ProofDay
			, 
			CASE
				WHEN AEAL.ProofCode = 'TaxBill' THEN CASE WHEN ATI.DataIndex = 'AUT' THEN '1' WHEN ATI.DataIndex = 'BUY' THEN '2' ELSE '' END
				WHEN AEAL.ProofCode like '%Card' THEN CASE WHEN CR.DataIndex = 'AUT' THEN '1' WHEN CR.DataIndex = 'BUY' THEN '2' ELSE '2' END
				WHEN AEAL.ProofCode = 'CashBill' THEN CASE WHEN ACB.InvoiceType = 'AUT' THEN '1' WHEN ACB.InvoiceType = 'BUY' THEN '2' ELSE '2' END 
			END AS BuyAutType
			, 
			CASE 
				WHEN AEAL.ProofCode = 'TaxBill' THEN '51' 
				WHEN AEAL.ProofCode like '%Card' THEN '57' 
				WHEN AEAL.ProofCode = 'CashBill' THEN '61' 
			END AS ProofTaxType
			, '' AS DeductReason
			, CC.DouzoneCardID AS DouzoneCardID
			, CC.CardCompany AS CardCompany
			, CR.CardNo AS CardNo
			, IFNULL(VD.VendorName, ATI.InvoicerCorpName) AS VendorName
			, IFNULL(VD.VendorNo, ATI.InvoicerCorpNum) AS CorpRegNum 
			, 
			CASE
				WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.SupplyCostTotal
				WHEN AEAL.ProofCode like '%Card' THEN CR.RepAmount
				WHEN AEAL.ProofCode = 'CashBill' THEN ACB.SupplyCost
			END AS SupplyCost
			, 
			CASE
				WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.TaxTotal
				WHEN AEAL.ProofCode like '%Card' THEN CR.TaxAmount
				WHEN AEAL.ProofCode = 'CashBill' THEN ACB.Tax
			END AS Tax		
			, IF(AEAD.IOName != '', CONCAT(AEAD.IOName, ' ', AEAD.StandardBriefName), AEAD.StandardBriefName) AS ItemName
			, IF(AEAL.ProofCode = 'TaxBill', '1', '') AS IsTaxInvoice
			, AEAD.AccountCode AS AccountCode
			, '' AS ContraAccountCode
			, ACB.NTSConfirmNum AS NTSConfirmNum
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user USR
		ON AEA.RegisterID = USR.UserCode
		LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
		ON AEAL.CardUID = CR.ReceiptID
		LEFT OUTER JOIN covi_account4j_si.act_corp_card CC
		ON CR.CardNo = CC.CardNo
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice_item ATIT
		ON ATI.TaxInvoiceID = ATIT.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
		ON AEAL.CashUID = ACB.CashBillID
		LEFT OUTER JOIN covi_account4j_si.act_receipt AR
		ON AEAL.ReceiptID = AR.ReceiptID
		WHERE 1=1
		AND AEAL.ProofCode in ('CorpCard', 'TaxBill', 'CashBill')
			
	  	<if test="DocNo != null and DocNo != ''">
	  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%')
		</if>
		
	  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
		 	AND AEA.ApplicationStatus = #{ApplicationStatus}
		</if>
	  	
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
		</if>
			  	
	  	<if test="ChargeJob != null and ChargeJob != ''">
		 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%') 
		</if>
				
		<if test="RequestType != null and RequestType != ''">
		 	AND AEA.RequestType = #{RequestType}
		</if>
	  	
	  	<if test="ProofCode != null and ProofCode != ''">
		 	AND AEAL.ProofCode = #{ProofCode}
		</if>
	  	
	  	<if test="CompanyCode != null and CompanyCode != ''">
			AND AEA.CompanyCode = #{CompanyCode}
		</if>
		
	  	<if test="ProofDateSt != null and ProofDateSt != ''">
			<![CDATA[
			 	AND AEAL.ProofDate >= #{ProofDateSt}
			]]>
		</if>
	  	<if test="ProofDateEd != null and ProofDateEd != ''">
			<![CDATA[
			 	AND AEAL.ProofDate <= #{ProofDateEd}
			]]>
		</if>
	  	
	  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
			]]>
		</if>
	  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
			]]>
		</if>
	  	
	  	
	  	<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>
	  	
	  	<if test="VendorName != null and VendorName != ''">
		 	AND (
		 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 	)
		</if>
	  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
	  	    <![CDATA[
		 	AND AEAL.TotalAmount > #{SearchAmtSt}
			]]>
		</if>
	  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
	  		<![CDATA[
		 	AND AEAL.TotalAmount < #{SearchAmtEd}
			]]>
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
		 	AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>
		<if test="PayDate != null and PayDate != ''">
		    AND AEAL.PayDate = #{PayDate}
		</if>
		<choose>
			<when test="SessionUser != null and SessionUser != ''">
		 		AND AEA.RegisterID = #{SessionUser}
			</when>
			<otherwise>
			    AND AEA.ApplicationStatus NOT IN ('T')
			</otherwise>
		</choose>
		<trim prefix="ORDER BY"  prefixOverrides =",">
			<if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
					, AEA.RegistDate DESC
					, AEA.ApplicationTitle
					, AEAL.ProofCode
					, AEAL.ExpenceApplicationListID
		    </if>
		  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
			 		,
			 		<choose>
						<when test='sortColumn.equalsIgnoreCase("CompanyCode")'>CompanyCode</when>
						<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
						<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
						<when test='sortColumn.equalsIgnoreCase("ApplicationStatusName")'>ApplicationStatusName</when>
						<when test='sortColumn.equalsIgnoreCase("RequestTypeName")'>RequestTypeName</when>
						<when test='sortColumn.equalsIgnoreCase("PayDate")'>PayDate</when>
						<when test='sortColumn.equalsIgnoreCase("ProofDate")'>ProofDate</when>
						<when test='sortColumn.equalsIgnoreCase("ProofTime")'>ProofTime</when>
						<when test='sortColumn.equalsIgnoreCase("ProofCodeName")'>ProofCodeName</when>
						<when test='sortColumn.equalsIgnoreCase("VendorName")'>VendorName</when>
						<when test='sortColumn.equalsIgnoreCase("UsageComment")'>UsageComment</when>
						<when test='sortColumn.equalsIgnoreCase("TaxAmount")'>TaxAmount</when>
						<when test='sortColumn.equalsIgnoreCase("RepAmount")'>RepAmount</when>
						<when test='sortColumn.equalsIgnoreCase("TotalAmount")'>TotalAmount</when>
						<when test='sortColumn.equalsIgnoreCase("AmountSum")'>AmountSum</when>
						<when test='sortColumn.equalsIgnoreCase("DocNo")'>DocNo</when>
						<otherwise>ApplicationDate</otherwise>
					</choose>
					<choose>
						<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
						<otherwise> DESC</otherwise>
					</choose>
			</if>
		</trim>
	</select>
	
	<select id="selectExpenceApplicationDouzoneExcelCnt" resultType="java.lang.Long">
		/*
			expenceApplication.selectExpenceApplicationDouzoneExcelCnt
		*/
		
		SELECT COUNT(*)
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user USR
		ON AEA.RegisterID = USR.UserCode
		LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
		ON AEAL.CardUID = CR.ReceiptID
		LEFT OUTER JOIN covi_account4j_si.act_corp_card CC
		ON CR.CardNo = CC.CardNo
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice_item ATIT
		ON ATI.TaxInvoiceID = ATIT.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_cashbill ACB
		ON AEAL.CashUID = ACB.CashBillID
		LEFT OUTER JOIN covi_account4j_si.act_receipt AR
		ON AEAL.ReceiptID = AR.ReceiptID
		WHERE 1=1
		AND AEAL.ProofCode in ('CorpCard', 'TaxBill', 'CashBill')
			
	  	<if test="DocNo != null and DocNo != ''">
	  	    AND AEAL.DocNo LIKE CONCAT('%',#{DocNo},'%')
		</if>
		
	  	<if test="ApplicationStatus != null and ApplicationStatus != ''">
		 	AND AEA.ApplicationStatus = #{ApplicationStatus}
		</if>
	  	
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%')) 
		</if>
			  	
	  	<if test="ChargeJob != null and ChargeJob != ''">
		 	AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
		</if>
				
		<if test="RequestType != null and RequestType != ''">
		 	AND AEA.RequestType = #{RequestType}
		</if>
	  	
	  	<if test="ProofCode != null and ProofCode != ''">
		 	AND AEAL.ProofCode = #{ProofCode}
		</if>
	  		  	
	  	<if test="CompanyCode != null and CompanyCode != ''">
			AND AEA.CompanyCode = #{CompanyCode}
		</if>
		
	  	<if test="ProofDateSt != null and ProofDateSt != ''">
			<![CDATA[
			 	AND AEAL.ProofDate >= #{ProofDateSt}
			]]>
		</if>
	  	<if test="ProofDateEd != null and ProofDateEd != ''">
			<![CDATA[
			 	AND AEAL.ProofDate <= #{ProofDateEd}
			]]>
		</if>
	  	
	  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) >= #{ApplicationDateSt}
			]]>
		</if>
	  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
			<![CDATA[
			 	AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <= #{ApplicationDateEd}
			]]>
		</if>
	  	
	  	
	  	<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(USR.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>
	  	
	  	<if test="VendorName != null and VendorName != ''">
		 	AND (
		 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 	)
		</if>
	  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
	  	    <![CDATA[
		 	AND AEAL.TotalAmount > #{SearchAmtSt}
			]]>
		</if>
	  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
	  		<![CDATA[
		 	AND AEAL.TotalAmount < #{SearchAmtEd}
			]]>
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
		 	AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>
		<if test="PayDate != null and PayDate != ''">
		    AND AEAL.PayDate = #{PayDate}
		</if>
		<choose>
			<when test="SessionUser != null and SessionUser != ''">
		 		AND AEA.RegisterID = #{SessionUser}
			</when>
			<otherwise>
			    AND AEA.ApplicationStatus NOT IN ('T')
			</otherwise>
		</choose>
	</select>
	
	<select id="selectExpenceApplicationTaxInvoiceExcel" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationTaxInvoiceExcel
		*/
		
		SELECT
			SOUB.DeptName,
			SOU.DisplayName,
			AEA.ApplicationTitle,
			DATE_FORMAT(AEA.ApplicationDate, '%Y-%m-%d') AS ApplicationDate,
			ATI.NTSConfirmNum,
			DATE_FORMAT(ATI.WriteDate, '%Y-%m-%d') AS WriteDate,
			ATI.InvoicerCorpName,
			ATI.InvoicerCorpNum,
			ATI.InvoicerContactName,
			ATI.InvoiceeEmail1,
			ATII.Remark,
			ATI.SupplyCostTotal,
			ATI.TaxTotal,
			ATI.TotalAmount,
			AEAD.Amount,
			AEAD.AccountName,
			AEAD.StandardBriefName,
			AEAD.UsageComment
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		INNER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		INNER JOIN covi_account4j_si.act_taxinvoice_item ATII
		ON ATI.TaxInvoiceID = ATII.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user SOU
		ON AEA.RegisterID = SOU.UserCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user_basegroup SOUB
		ON SOU.UserCode = SOUB.UserCode AND SOUB.JobType = 'Origin'
		WHERE AEAL.ProofCode = 'TaxBill'
		AND AEA.ApplicationStatus = 'E'
		<if test="SessionUser != null and SessionUser != ''">
	 		AND AEA.RegisterID = #{SessionUser}
		</if>	
		<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>	 
	  	<if test="CompanyCode != null and CompanyCode != ''">
			AND AEA.CompanyCode = #{CompanyCode}
		</if>		
	  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
		 	AND AEAL.TotalAmount <![CDATA[>]]> #{SearchAmtSt}
		</if>
	  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
		 	AND AEAL.TotalAmount <![CDATA[<]]> #{SearchAmtEd}
		</if>
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
		</if>
	  	<if test="ProofDateSt != null and ProofDateSt != ''">
			AND AEAL.ProofDate <![CDATA[>=]]> #{ProofDateSt}
		</if>
	  	<if test="ProofDateEd != null and ProofDateEd != ''">
			AND AEAL.ProofDate <![CDATA[<=]]> #{ProofDateEd}
		</if>	 
		<if test="RequestType != null and RequestType != ''">
		 	AND AEA.RequestType = #{RequestType}
		</if> 	
	  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
			AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <![CDATA[>=]]> #{ApplicationDateSt}
		</if>
	  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
			AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <![CDATA[<=]]> #{ApplicationDateEd}
		</if> 	
	  	<if test="VendorName != null and VendorName != ''">
		 	AND (
		 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 	)
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
		 	AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>
		<if test="PayDate != null and PayDate != ''">
		    AND AEAL.PayDate = #{PayDate}
		</if>
		ORDER BY AEA.ApplicationDate DESC
	</select>
	
	<select id="selectExpenceApplicationTaxInvoiceExcelCnt" parameterType="cmap" resultType="java.lang.Long">
		/*
			expenceApplication.selectExpenceApplicationTaxInvoiceExcelCnt
		*/
		
		SELECT COUNT(*)
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		INNER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		INNER JOIN covi_account4j_si.act_taxinvoice_item ATII
		ON ATI.TaxInvoiceID = ATII.TaxInvoiceID
		LEFT OUTER JOIN covi_account4j_si.act_vendor VD
		ON AEAL.VendorNo = VD.VendorNo and AEA.CompanyCode = VD.CompanyCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user SOU
		ON AEA.RegisterID = SOU.UserCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user_basegroup SOUB
		ON SOU.UserCode = SOUB.UserCode AND SOUB.JobType = 'Origin'
		WHERE AEAL.ProofCode = 'TaxBill'
		AND AEA.ApplicationStatus = 'E'
		<if test="SessionUser != null and SessionUser != ''">
	 		AND AEA.RegisterID = #{SessionUser}
		</if>	
		<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>	 
	  	<if test="CompanyCode != null and CompanyCode != ''">
			AND AEA.CompanyCode = #{CompanyCode}
		</if>		
	  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
		 	AND AEAL.TotalAmount <![CDATA[>]]> #{SearchAmtSt}
		</if>
	  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
		 	AND AEAL.TotalAmount <![CDATA[<]]> #{SearchAmtEd}
		</if>
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
		</if>
	  	<if test="ProofDateSt != null and ProofDateSt != ''">
			AND AEAL.ProofDate <![CDATA[>=]]> #{ProofDateSt}
		</if>
	  	<if test="ProofDateEd != null and ProofDateEd != ''">
			AND AEAL.ProofDate <![CDATA[<=]]> #{ProofDateEd}
		</if>	 
		<if test="RequestType != null and RequestType != ''">
		 	AND AEA.RequestType = #{RequestType}
		</if> 	
	  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
			AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <![CDATA[>=]]> #{ApplicationDateSt}
		</if>
	  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
			AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <![CDATA[<=]]> #{ApplicationDateEd}
		</if> 	
	  	<if test="VendorName != null and VendorName != ''">
		 	AND (
		 		UPPER(VD.VendorName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 		OR UPPER(ATI.InvoicerCorpName) LIKE UPPER(CONCAT('%',#{VendorName},'%'))
		 	)
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
		 	AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>
		<if test="PayDate != null and PayDate != ''">
		    AND AEAL.PayDate = #{PayDate}
		</if>
	</select>
	
	<select id="selectExpenceApplicationCardReceiptExcel" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationCardReceiptExcel
		*/
		
		SELECT
			SOUB.CompanyCode,
			SOUB.DeptName,
			SOU.DisplayName,
			AEA.ApplicationType,
			AEA.ApplicationTitle,
			DATE_FORMAT(AEA.ApplicationDate, '%Y-%m-%d') AS ApplicationDate,
			ACR.CardNo,
			ACR.ApproveNo,
			CONCAT(DATE_FORMAT(ACR.ApproveDate, '%Y-%m-%d'), ' ('
				, CASE DAYOFWEEK(ACR.ApproveDate) WHEN'1'THEN'일' WHEN'2'THEN'월' WHEN'3'THEN'화' WHEN'4'THEN'수' WHEN'5'THEN'목' WHEN'6'THEN'금' WHEN'7'THEN'토' END
				, ')'
			) AS ApproveDate,
			TIME_FORMAT(IFNULL(ACR.ApproveTime, "NULL"), '%H:%i:%s') AS ApproveTime,
			CONCAT(DATE_FORMAT(AEAL.PayDate, '%Y-%m-%d'), ' ('
				, CASE DAYOFWEEK(AEAL.PayDate) WHEN'1'THEN'일' WHEN'2'THEN'월' WHEN'3'THEN'화' WHEN'4'THEN'수' WHEN'5'THEN'목' WHEN'6'THEN'금' WHEN'7'THEN'토' END
				, ')'
			) AS PayDate,
			AEAL.VendorName,
			AEAL.TaxAmount,
			ACR.AmountWon AS ApproveAmount,
			AEAD.Amount,
			ACR.StoreName,
			ACR.StoreCategory,
			AEAD.AccountName,
			AEA.DocNo, 
			AEAD.StandardBriefName,
			AEAD.UsageComment
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		LEFT JOIN covi_account4j_si.act_card_receipt ACR
		ON AEAL.CardUID = ACR.ReceiptID
		LEFT OUTER JOIN covi_smart4j.sys_object_user SOU
		ON AEA.RegisterID = SOU.UserCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user_basegroup SOUB
		ON SOU.UserCode = SOUB.UserCode AND SOUB.JobType = 'Origin'
		WHERE AEAL.ProofCode = 'CorpCard'
		AND AEA.ApplicationStatus = 'E'
		<if test="SessionUser != null and SessionUser != ''">
	 		AND AEA.RegisterID = #{SessionUser}
		</if>	
		<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>	 
	  	<if test="CompanyCode != null and CompanyCode != ''">
			AND AEA.CompanyCode = #{CompanyCode}
		</if>		
	  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
		 	AND AEAL.TotalAmount <![CDATA[>]]> #{SearchAmtSt}
		</if>
	  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
		 	AND AEAL.TotalAmount <![CDATA[<]]> #{SearchAmtEd}
		</if>
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
		</if>
	  	<if test="ProofDateSt != null and ProofDateSt != ''">
			AND AEAL.ProofDate <![CDATA[>=]]> #{ProofDateSt}
		</if>
	  	<if test="ProofDateEd != null and ProofDateEd != ''">
			AND AEAL.ProofDate <![CDATA[<=]]> #{ProofDateEd}
		</if>	 
		<if test="RequestType != null and RequestType != ''">
		 	AND AEA.RequestType = #{RequestType}
		</if> 	
	  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
			AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <![CDATA[>=]]> #{ApplicationDateSt}
		</if>
	  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
			AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <![CDATA[<=]]> #{ApplicationDateEd}
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
		 	AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>
		<if test="PayDate != null and PayDate != ''">
		    AND AEAL.PayDate = #{PayDate}
		</if>
		ORDER BY AEA.ApplicationDate DESC
	</select>
		
	<select id="selectExpenceApplicationCardReceiptExcelCnt" parameterType="cmap" resultType="java.lang.Long">
		/*
			expenceApplication.selectExpenceApplicationCardReceiptExcelCnt
		*/
		
		SELECT COUNT(*)
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		INNER JOIN covi_account4j_si.act_card_receipt ACR
		ON AEAL.CardUID = ACR.ReceiptID
		LEFT OUTER JOIN covi_smart4j.sys_object_user SOU
		ON AEA.RegisterID = SOU.UserCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user_basegroup SOUB
		ON SOU.UserCode = SOUB.UserCode AND SOUB.JobType = 'Origin'
		WHERE AEAL.ProofCode = 'CorpCard'
		AND AEA.ApplicationStatus = 'E'
		<if test="SessionUser != null and SessionUser != ''">
	 		AND AEA.RegisterID = #{SessionUser}
		</if>	
		<if test="RegisterNm != null and RegisterNm != ''">
		 	AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>	 
	  	<if test="CompanyCode != null and CompanyCode != ''">
			AND AEA.CompanyCode = #{CompanyCode}
		</if>		
	  	<if test="SearchAmtSt != null and SearchAmtSt != ''">
		 	AND AEAL.TotalAmount <![CDATA[>]]> #{SearchAmtSt}
		</if>
	  	<if test="SearchAmtEd != null and SearchAmtEd != ''">
		 	AND AEAL.TotalAmount <![CDATA[<]]> #{SearchAmtEd}
		</if>
	  	<if test="ApplicationTitle != null and ApplicationTitle != ''">
		 	AND UPPER(AEA.ApplicationTitle) LIKE UPPER(CONCAT('%',#{ApplicationTitle},'%'))
		</if>
	  	<if test="ProofDateSt != null and ProofDateSt != ''">
			AND AEAL.ProofDate <![CDATA[>=]]> #{ProofDateSt}
		</if>
	  	<if test="ProofDateEd != null and ProofDateEd != ''">
			AND AEAL.ProofDate <![CDATA[<=]]> #{ProofDateEd}
		</if>	 
		<if test="RequestType != null and RequestType != ''">
		 	AND AEA.RequestType = #{RequestType}
		</if> 	
	  	<if test="ApplicationDateSt != null and ApplicationDateSt != ''">
			AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <![CDATA[>=]]> #{ApplicationDateSt}
		</if>
	  	<if test="ApplicationDateEd != null and ApplicationDateEd != ''">
			AND IFNULL(AEA.ApplicationDate, AEA.RegistDate) <![CDATA[<=]]> #{ApplicationDateEd}
		</if>
	  	<if test="StandardBriefID != null and StandardBriefID != ''">
		 	AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>
		<if test="PayDate != null and PayDate != ''">
		    AND AEAL.PayDate = #{PayDate}
		</if>
		ORDER BY AEA.ApplicationDate DESC
	</select>
	
	<select id="getUserBankAccount" parameterType="cmap" resultType="cmap">
	    SELECT 
		  VD.VendorNo
		  , VDB.BankID
		  , VDB.BankCode
		  , VDB.BankName
		  , VDB.BankAccountNo
		  , VDB.BankAccountName
          , CONCAT(VDB.BankAccountNo, '(', VDB.BankName, ', ', VDB.BankAccountName, ')') AS BankAccountView
		FROM covi_account4j_si.act_vendor VD
		INNER JOIN covi_account4j_si.act_vendor_bank VDB ON VD.VendorID = VDB.VendorID
		WHERE VD.VendorType = 'OR' 
		AND VD.VendorNo = #{SessionUser}
    </select>
    
    <select id="checkActVendorForWrite" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM covi_account4j_si.act_vendor
		WHERE VendorNo = #{VendorNo}
    </select>
    
    <insert id="insertActVendorForWrite" parameterType="cmap">
		INSERT INTO covi_account4j_si.act_vendor
		(
			CompanyCode
			, VendorType
			, VendorNo
			, VendorName
			, BusinessNumber
			, RegisterID
			, RegistDate
			, ModifierID
			, ModifyDate
		)
		VALUES
		(
			 #{CompanyCode}
			, #{VendorType}
			, #{VendorNo}
			, #{VendorName}
			, #{VendorNo}
			, #{RegisterID}
			, now()
			, #{RegisterID}
			, now()
		)
	</insert>
 
	<select id="selectActVendorIsRegistered" parameterType="cmap" resultType="cmap">
	    SELECT *
		FROM covi_account4j_si.act_vendor
		WHERE 1=1
		<if test="VendorNo != null and VendorNo != ''">
		AND VendorNo = #{VendorNo}
		</if>
		<if test="VendorName != null and VendorName != ''">
		AND VendorName = #{VendorName}
		</if>
		LIMIT 1
    </select>
    
	<select id="selectVendorNoByAuto" parameterType="cmap" resultType="java.lang.String">
		SELECT 
		CONCAT('V',LPAD(IFNULL(MAX(RIGHT(VendorNo, 6)), '0')+1, 6, '0')) AS VendorNo
    	FROM covi_account4j_si.act_vendor 
    	WHERE VendorNo like 'V%';
    </select>
    
    <select id="selectMonthlyAccountHeaderData" parameterType="cmap" resultType="cmap">
	    SELECT 
	    	AA.AccountCode, AA.AccountName
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		LEFT OUTER JOIN covi_account4j_si.act_account AS AA ON AEAD.AccountCode = AA.AccountCode
		LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode
		LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
		WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
		AND AA.AccountCode IS NOT NULL
		<if test="companyCode != null and companyCode != ''">
		AND AEA.CompanyCode = #{companyCode}
		</if>
		<if test="ChargeJob != null and ChargeJob != ''">
		AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
		</if>
		<if test="RequestType != null and RequestType != ''">
		 AND AEA.RequestType = #{RequestType}
		</if>
		<if test="ProofDate != null and ProofDate != ''">
		AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
		</if>
		<if test="AccountCode != null and AccountCode != ''">
		AND AA.AccountCode = #{AccountCode}
		</if>
		<if test="CostCenterCode != null and CostCenterCode != ''">
		AND ACC.CostCenterCode = #{CostCenterCode}
		</if>
		<if test="RegisterNm != null and RegisterNm != ''">
		AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>
		GROUP BY AA.AccountCode
    </select>
    
    <select id="selectMonthlyAccountHeaderDataExcel" parameterType="cmap" resultType="java.lang.String">
    	SELECT GROUP_CONCAT(CONCAT(AccountCode, 'Sum'))
	    FROM (
		    SELECT 
		    	AA.AccountCode
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			LEFT OUTER JOIN covi_account4j_si.act_account AS AA ON AEAD.AccountCode = AA.AccountCode
			LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
			WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
			AND AA.AccountCode IS NOT NULL
			<if test="companyCode != null and companyCode != ''">
			AND AEA.CompanyCode = #{companyCode}
			</if>
			<if test="ChargeJob != null and ChargeJob != ''">
			AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
			</if>
			<if test="RequestType != null and RequestType != ''">
			AND AEA.RequestType = #{RequestType}
			</if>
			<if test="ProofDate != null and ProofDate != ''">
			AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
			</if>
			<if test="AccountCode != null and AccountCode != ''">
			AND AA.AccountCode = #{AccountCode}
			</if>
			<if test="CostCenterCode != null and CostCenterCode != ''">
			AND ACC.CostCenterCode = #{CostCenterCode}
			</if>
			<if test="RegisterNm != null and RegisterNm != ''">
			AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
			</if>
			GROUP BY AA.AccountCode
		) AS A
    </select>
    
    <select id="selectMonthlyAccountSummaryList" parameterType="cmap" resultType="cmap">
    	SET @stmt = NULL;
		SELECT
			GROUP_CONCAT(DISTINCT
				CONCAT(
      				'SUM(CASE WHEN AccountCode = ', AccountCode, ' THEN AmountSum ELSE 0 END) AS `', AccountCode, 'Sum`'
				)
			) INTO @stmt
		FROM
		(
			SELECT
				AA.AccountCode,
				CASE
					WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END)
					ELSE SUM(AEAD.Amount) 
				END AS AmountSum  
			FROM covi_account4j_si.act_expence_application AS AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			LEFT OUTER JOIN covi_account4j_si.act_account AS AA ON AEAD.AccountCode = AA.AccountCode
			LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
			LEFT OUTER JOIN ( 
				SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
				FROM covi_account4j_si.act_expence_application_div AEAD
				GROUP BY AEAD.ExpenceApplicationListID
			) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
			WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
			<if test="companyCode != null and companyCode != ''">
			AND AEA.CompanyCode = #{companyCode}
			</if>
			<if test="ChargeJob != null and ChargeJob != ''">
			AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
			</if>
			<if test="RequestType != null and RequestType != ''">
			AND AEA.RequestType = #{RequestType}
			</if>
			<if test="ProofDate != null and ProofDate != ''">
			AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
			</if>
			<if test="AccountCode != null and AccountCode != ''">
			AND AA.AccountCode = #{AccountCode}
			</if>
			<if test="CostCenterCode != null and CostCenterCode != ''">
			AND ACC.CostCenterCode = #{CostCenterCode}
			</if>
			<if test="RegisterNm != null and RegisterNm != ''">
			AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
			</if>
			GROUP BY SOU.UserCode, AA.AccountCode WITH ROLLUP
		) AS A;

		SET @stmt = CONCAT('SELECT A.GroupCode, A.GroupName, A.UserCode, A.UserName', IF(@stmt IS NULL, '', CONCAT(', ', @stmt)), 
								', SUM(CASE WHEN AccountCode IS NULL THEN AmountSum ELSE 0 END) AS TotalSum  
						  	FROM ( 
								SELECT 
									ACC.CostCenterCode AS GroupCode, 
									ACC.CostCenterName AS GroupName, 
									covi_account4j_si.fn_getGroupPathByCostCenter(ACC.CostCenterCode) AS GroupSortPath,
									SOU.UserCode, 
									SOU.DisplayName AS UserName, 
									AA.AccountCode AS AccountCode, 
									AA.AccountName AS AccountName,
									CASE 
										WHEN (AEAL.ProofCode = ''TaxBill'' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
												ELSE SUM(AEAD.Amount) 
									END AS AmountSum  
			                  	FROM covi_account4j_si.act_expence_application AS AEA 
									INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID 
									INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID 
								LEFT OUTER JOIN covi_account4j_si.act_account AS AA ON AEAD.AccountCode = AA.AccountCode
								LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode
									LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
									LEFT OUTER JOIN ( 
										SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
										FROM covi_account4j_si.act_expence_application_div AEAD
										GROUP BY AEAD.ExpenceApplicationListID
									) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
									WHERE AEA.ApplicationStatus IN (''E'', ''CD'', ''CP'', ''CR'', ''CE'', ''CC'')
									<if test="companyCode != null and companyCode != ''">
									AND AEA.CompanyCode = '#{companyCode}'
									</if>
									<if test="ChargeJob != null and ChargeJob != ''">
									AND AEA.ChargeJob LIKE CONCAT('#{ChargeJob}',''%'')
									</if>
									<if test="RequestType != null and RequestType != ''">
									AND AEA.RequestType = '#{RequestType}'
									</if>
									<if test="ProofDate != null and ProofDate != ''">
									AND AEAL.ProofDate LIKE CONCAT('#{ProofDate}',''%'')
									</if>
									<if test="AccountCode != null and AccountCode != ''">
								AND AA.AccountCode = '#{AccountCode}' 
								</if>
								<if test="CostCenterCode != null and CostCenterCode != ''">
								AND ACC.CostCenterCode = '#{CostCenterCode}'
									</if>
									<if test="RegisterNm != null and RegisterNm != ''">
									AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT(''%'','#{RegisterNm}',''%'')) 
									</if>
			                  	GROUP BY SOU.UserCode, AA.AccountCode WITH ROLLUP 
							) AS A
					 		WHERE A.UserCode IS NOT NULL
							GROUP BY A.UserCode 
							ORDER BY A.GroupSortPath, A.GroupName, A.UserName'
					);

		PREPARE stmt FROM @stmt;
		EXECUTE stmt;
		DEALLOCATE PREPARE stmt;	
    </select>
    
    <select id="selectMonthlyAccountSummaryListCnt" parameterType="cmap" resultType="java.lang.Long">
	    SELECT COUNT(UserCode)
			FROM (
				SELECT UserCode
				FROM (
					SELECT
						ACC.CostCenterCode AS GroupCode, 
						ACC.CostCenterName AS GroupName, 
						covi_account4j_si.fn_getGroupPathByCostCenter(ACC.CostCenterCode) AS GroupSortPath,
						SOU.UserCode, 
						SOU.DisplayName AS UserName, 
						AA.AccountCode AS AccountCode, 
						AA.AccountName AS AccountName,
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
									ELSE SUM(AEAD.Amount) 
						END AS AmountSum
					FROM covi_account4j_si.act_expence_application AS AEA
					INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
					INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					LEFT OUTER JOIN covi_account4j_si.act_account AS AA ON AEAD.AccountCode = AA.AccountCode
					LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode
					LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
					LEFT OUTER JOIN ( 
						SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
						FROM covi_account4j_si.act_expence_application_div AEAD
						GROUP BY AEAD.ExpenceApplicationListID
					) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
					WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
					<if test="companyCode != null and companyCode != ''">
					AND AEA.CompanyCode = #{companyCode}
					</if>
					<if test="ChargeJob != null and ChargeJob != ''">
					AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
					</if>
					<if test="RequestType != null and RequestType != ''">
					AND AEA.RequestType = #{RequestType}
					</if>
					<if test="ProofDate != null and ProofDate != ''">
					AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%') 
					</if>
					<if test="AccountCode != null and AccountCode != ''">
					AND AA.AccountCode = #{AccountCode}
					</if>
					<if test="CostCenterCode != null and CostCenterCode != ''">
					AND ACC.CostCenterCode = #{CostCenterCode}
					</if>
					<if test="RegisterNm != null and RegisterNm != ''">
					AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
					</if>
					GROUP BY SOU.UserCode, AA.AccountCode WITH ROLLUP
				) AS A
				WHERE A.UserCode IS NOT NULL
				GROUP BY A.UserCode
			) AS B
    </select>
    
    <select id="selectMonthlyAccountDeptSummaryList" parameterType="cmap" resultType="cmap">
    	SET @stmt = NULL;
		SELECT
			GROUP_CONCAT(DISTINCT
				CONCAT(
      				'SUM(CASE WHEN AccountCode = ', AccountCode, ' THEN AmountSum ELSE 0 END) AS `', AccountCode, 'Sum`'
				)
			) INTO @stmt
		FROM
		(
			SELECT
				AA.AccountCode,
				CASE
					WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
					ELSE SUM(AEAD.Amount) 
				END AS AmountSum  
			FROM covi_account4j_si.act_expence_application AS AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			LEFT OUTER JOIN covi_account4j_si.act_account AS AA ON AEAD.AccountCode = AA.AccountCode
			LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
			LEFT OUTER JOIN ( 
				SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
				FROM covi_account4j_si.act_expence_application_div AEAD
				GROUP BY AEAD.ExpenceApplicationListID
			) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
			WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
			<if test="companyCode != null and companyCode != ''">
			AND AEA.CompanyCode = #{companyCode}
			</if>
			<if test="ChargeJob != null and ChargeJob != ''">
			AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
			</if>
			<if test="RequestType != null and RequestType != ''">
			AND AEA.RequestType = #{RequestType}
			</if>
			<if test="ProofDate != null and ProofDate != ''">
			AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
			</if>
			<if test="AccountCode != null and AccountCode != ''">
			AND AA.AccountCode = #{AccountCode}
			</if>
			<if test="CostCenterCode != null and CostCenterCode != ''">
			AND ACC.CostCenterCode = #{CostCenterCode}
			</if>
			GROUP BY ACC.CostCenterCode, AA.AccountCode WITH ROLLUP
		) AS A;

		SET @stmt = CONCAT('SELECT * FROM (
								SELECT A.GroupCode, A.GroupName, A.GroupSortPath', IF(@stmt IS NULL, '', CONCAT(', ', @stmt)), 
								', SUM(CASE WHEN AccountCode IS NULL THEN AmountSum ELSE 0 END) AS TotalSum  
							  	FROM ( 
									SELECT 
										ACC.CostCenterCode AS GroupCode, 
										ACC.CostCenterName AS GroupName, 
										covi_account4j_si.fn_getGroupPathByCostCenter(ACC.CostCenterCode) AS GroupSortPath,
										AA.AccountCode AS AccountCode, 
										AA.AccountName AS AccountName,
										CASE 
											WHEN (AEAL.ProofCode = ''TaxBill'' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
													ELSE SUM(AEAD.Amount) 
										END AS AmountSum   
				                  	FROM covi_account4j_si.act_expence_application AS AEA 
										INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID 
										INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID 
										LEFT OUTER JOIN covi_account4j_si.act_account AS AA ON AEAD.AccountCode = AA.AccountCode
										LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
										LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
										LEFT OUTER JOIN ( 
											SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
											FROM covi_account4j_si.act_expence_application_div AEAD
											GROUP BY AEAD.ExpenceApplicationListID
										) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
										WHERE AEA.ApplicationStatus IN (''E'', ''CD'', ''CP'', ''CR'', ''CE'', ''CC'')
										<if test="companyCode != null and companyCode != ''">
										AND AEA.CompanyCode = '#{companyCode}'
										</if>
										<if test="ChargeJob != null and ChargeJob != ''">
										AND AEA.ChargeJob LIKE CONCAT('#{ChargeJob}',''%'')
										</if>
										<if test="RequestType != null and RequestType != ''">
										AND AEA.RequestType = '#{RequestType}'
										</if>
										<if test="ProofDate != null and ProofDate != ''">
										AND AEAL.ProofDate LIKE CONCAT('#{ProofDate}',''%'')
										</if>
										<if test="AccountCode != null and AccountCode != ''">
										AND AA.AccountCode = '#{AccountCode}'
										</if>
										<if test="CostCenterCode != null and CostCenterCode != ''">
										AND ACC.CostCenterCode = '#{CostCenterCode}'
										</if>
				                  		GROUP BY ACC.CostCenterCode, AA.AccountCode WITH ROLLUP 
								) AS A
						 		WHERE A.GroupCode IS NOT NULL
								GROUP BY A.GroupCode 
								
								UNION ALL
								
								SELECT ''DEPT_TOTAL'' AS GroupCode, ''TOTAL'' AS GroupName, ''99'' AS GroupSortPath', IF(@stmt IS NULL, '', CONCAT(', ', @stmt)), 
									', SUM(CASE WHEN AccountCode IS NULL THEN AmountSum ELSE 0 END) AS TotalSum  
							  	FROM ( 
									SELECT 
										AA.AccountCode,
										CASE 
											WHEN (AEAL.ProofCode = ''TaxBill'' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
													ELSE SUM(AEAD.Amount) 
										END AS AmountSum  
				                  	FROM covi_account4j_si.act_expence_application AS AEA 
										INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID 
										INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID 
										LEFT OUTER JOIN covi_account4j_si.act_account AS AA ON AEAD.AccountCode = AA.AccountCode
										LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
										LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
										LEFT OUTER JOIN ( 
											SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
											FROM covi_account4j_si.act_expence_application_div AEAD
											GROUP BY AEAD.ExpenceApplicationListID
										) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
										WHERE AEA.ApplicationStatus IN (''E'', ''CD'', ''CP'', ''CR'', ''CE'', ''CC'')
										<if test="companyCode != null and companyCode != ''">
										AND AEA.CompanyCode = '#{companyCode}'
										</if>
										<if test="ChargeJob != null and ChargeJob != ''">
										AND AEA.ChargeJob LIKE CONCAT('#{ChargeJob}',''%'')
										</if>
										<if test="RequestType != null and RequestType != ''">
										AND AEA.RequestType = '#{RequestType}'
										</if>
										<if test="ProofDate != null and ProofDate != ''">
										AND AEAL.ProofDate LIKE CONCAT('#{ProofDate}',''%'')
										</if>
										<if test="AccountCode != null and AccountCode != ''">
										AND AA.AccountCode = '#{AccountCode}'
										</if>
										<if test="CostCenterCode != null and CostCenterCode != ''">
										AND ACC.CostCenterCode = '#{CostCenterCode}'
										</if>
				                  	GROUP BY AA.AccountCode WITH ROLLUP 
								) AS B
							) AS AA
					 		WHERE AA.TotalSum IS NOT NULL
							ORDER BY AA.GroupSortPath, AA.GroupName'
					);

		PREPARE stmt FROM @stmt;
		EXECUTE stmt;
		DEALLOCATE PREPARE stmt;	
    </select>
    
    <select id="selectMonthlyAccountDeptSummaryListCnt" parameterType="cmap" resultType="java.lang.Long">
	    SELECT COUNT(GroupCode)
			FROM (
				SELECT GroupCode
				FROM (
					SELECT
						ACC.CostCenterCode AS GroupCode, 
						ACC.CostCenterName AS GroupName, 
						covi_account4j_si.fn_getGroupPathByCostCenter(ACC.CostCenterCode) AS GroupSortPath,
						AA.AccountCode AS AccountCode, 
						AA.AccountName AS AccountName,
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
									ELSE SUM(AEAD.Amount) 
						END AS AmountSum      
					FROM covi_account4j_si.act_expence_application AS AEA
					INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
					INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					LEFT OUTER JOIN covi_account4j_si.act_account AS AA ON AEAD.AccountCode = AA.AccountCode
					LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
					LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
					LEFT OUTER JOIN ( 
						SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
						FROM covi_account4j_si.act_expence_application_div AEAD
						GROUP BY AEAD.ExpenceApplicationListID
					) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
					WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
					<if test="companyCode != null and companyCode != ''">
					AND AEA.CompanyCode = #{companyCode}
					</if>
					<if test="ChargeJob != null and ChargeJob != ''">
					AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
					</if>
					<if test="RequestType != null and RequestType != ''">
					AND AEA.RequestType = #{RequestType}
					</if>
					<if test="ProofDate != null and ProofDate != ''">
					AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
					</if>
					<if test="AccountCode != null and AccountCode != ''">
					AND AA.AccountCode = #{AccountCode}
					</if>
					<if test="CostCenterCode != null and CostCenterCode != ''">
					AND ACC.CostCenterCode = #{CostCenterCode}
					</if>
					GROUP BY ACC.CostCenterCode, AA.AccountCode WITH ROLLUP
				) AS A
				WHERE A.GroupCode IS NOT NULL
				GROUP BY A.GroupCode
			) AS B
    </select>
    
    <select id="selectMonthlyStandardBriefHeaderData" parameterType="cmap" resultType="cmap">
	    SELECT 
	    	ASB.StandardBriefID, ASB.StandardBriefName
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		LEFT OUTER JOIN covi_account4j_si.act_standard_brief AS ASB ON AEAD.StandardBriefID = ASB.StandardBriefID
		LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
		LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
		WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
		AND ASB.StandardBriefID IS NOT NULL
		<if test="companyCode != null and companyCode != ''">
		AND AEA.CompanyCode = #{companyCode}
		</if>
		<if test="ChargeJob != null and ChargeJob != ''">
		AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
		</if>
		<if test="RequestType != null and RequestType != ''">
		AND AEA.RequestType = #{RequestType}
		</if>
		<if test="ProofDate != null and ProofDate != ''">
		AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
		</if>
		<if test="StandardBriefID != null and StandardBriefID != ''">
		AND ASB.StandardBriefID = #{StandardBriefID}
		</if>
		<if test="CostCenterCode != null and CostCenterCode != ''">
		AND ACC.CostCenterCode = #{CostCenterCode}
		</if>
		<if test="RegisterNm != null and RegisterNm != ''">
		AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
		</if>
		GROUP BY ASB.StandardBriefID
    </select>
    
    <select id="selectMonthlyStandardBriefHeaderDataExcel" parameterType="cmap" resultType="java.lang.String">
    	SELECT GROUP_CONCAT(CONCAT(StandardBriefID, 'Sum'))
	    FROM (
		    SELECT 
		    	ASB.StandardBriefID
			FROM covi_account4j_si.act_expence_application AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			LEFT OUTER JOIN covi_account4j_si.act_standard_brief AS ASB ON AEAD.StandardBriefID = ASB.StandardBriefID
			LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
			WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
			AND ASB.StandardBriefID IS NOT NULL
			<if test="companyCode != null and companyCode != ''">
			AND AEA.CompanyCode = #{companyCode}
			</if>
			<if test="ChargeJob != null and ChargeJob != ''">
			AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
			</if>
			<if test="RequestType != null and RequestType != ''">
			AND AEA.RequestType = #{RequestType}
			</if>
			<if test="ProofDate != null and ProofDate != ''">
			AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
			</if>
			<if test="StandardBriefID != null and StandardBriefID != ''">
			AND ASB.StandardBriefID = #{StandardBriefID}
			</if>
			<if test="CostCenterCode != null and CostCenterCode != ''">
			AND ACC.CostCenterCode = #{CostCenterCode}
			</if>
			<if test="RegisterNm != null and RegisterNm != ''">
			AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
			</if>
			GROUP BY ASB.StandardBriefID
		) AS A
    </select>
    
    <select id="selectMonthlyStandardBriefSummaryList" parameterType="cmap" resultType="cmap">
    	SET @stmt = NULL;
		SELECT
			GROUP_CONCAT(DISTINCT
				CONCAT(
      				'SUM(CASE WHEN StandardBriefID = ', StandardBriefID, ' THEN AmountSum ELSE 0 END) AS `', StandardBriefID, 'Sum`'
				)
			) INTO @stmt
		FROM
		(
			SELECT
				ASB.StandardBriefID,
				CASE
					WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
					ELSE SUM(AEAD.Amount) 
				END AS AmountSum    
			FROM covi_account4j_si.act_expence_application AS AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			LEFT OUTER JOIN covi_account4j_si.act_standard_brief AS ASB ON AEAD.StandardBriefID = ASB.StandardBriefID
			LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode
			LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
			LEFT OUTER JOIN ( 
				SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
				FROM covi_account4j_si.act_expence_application_div AEAD
				GROUP BY AEAD.ExpenceApplicationListID
			) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
			WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
			<if test="companyCode != null and companyCode != ''">
			AND AEA.CompanyCode = #{companyCode}
			</if>
			<if test="ChargeJob != null and ChargeJob != ''">
			AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
			</if>
			<if test="RequestType != null and RequestType != ''">
			AND AEA.RequestType = #{RequestType}
			</if>
			<if test="ProofDate != null and ProofDate != ''">
			AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
			</if>
			<if test="StandardBriefID != null and StandardBriefID != ''">
			AND ASB.StandardBriefID = #{StandardBriefID}
			</if>
			<if test="CostCenterCode != null and CostCenterCode != ''">
			AND ACC.CostCenterCode = #{CostCenterCode}
			</if>
			<if test="RegisterNm != null and RegisterNm != ''">
			AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
			</if>
			GROUP BY SOU.UserCode, ASB.StandardBriefID WITH ROLLUP
		) AS A;

		SET @stmt = CONCAT('SELECT A.GroupCode, A.GroupName, A.UserCode, A.UserName', IF(@stmt IS NULL, '', CONCAT(', ', @stmt)), 
								', SUM(CASE WHEN StandardBriefID IS NULL THEN AmountSum ELSE 0 END) AS TotalSum  
						  	FROM ( 
								SELECT 
									ACC.CostCenterCode AS GroupCode, 
									ACC.CostCenterName AS GroupName, 
									covi_account4j_si.fn_getGroupPathByCostCenter(ACC.CostCenterCode) AS GroupSortPath,
									SOU.UserCode, 
									SOU.DisplayName AS UserName, 
									ASB.StandardBriefID AS StandardBriefID, 
									ASB.StandardBriefName AS StandardBriefName,
									CASE 
										WHEN (AEAL.ProofCode = ''TaxBill'' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
												ELSE SUM(AEAD.Amount) 
									END AS AmountSum   
			                  	FROM covi_account4j_si.act_expence_application AS AEA 
									INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID 
									INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID 
									LEFT OUTER JOIN covi_account4j_si.act_standard_brief AS ASB ON AEAD.StandardBriefID = ASB.StandardBriefID
									LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
									LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
									LEFT OUTER JOIN ( 
										SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
										FROM covi_account4j_si.act_expence_application_div AEAD
										GROUP BY AEAD.ExpenceApplicationListID
									) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
									WHERE AEA.ApplicationStatus IN (''E'', ''CD'', ''CP'', ''CR'', ''CE'', ''CC'')
									<if test="companyCode != null and companyCode != ''">
									AND AEA.CompanyCode = '#{companyCode}'
									</if>
									<if test="ChargeJob != null and ChargeJob != ''">
									AND AEA.ChargeJob LIKE CONCAT('#{ChargeJob}',''%'')
									</if>
									<if test="RequestType != null and RequestType != ''">
									AND AEA.RequestType = '#{RequestType}'
									</if>
									<if test="ProofDate != null and ProofDate != ''">
									AND AEAL.ProofDate LIKE CONCAT('#{ProofDate}',''%'')
									</if>
									<if test="StandardBriefID != null and StandardBriefID != ''">
									AND ASB.StandardBriefID = '#{StandardBriefID}'
									</if>
									<if test="CostCenterCode != null and CostCenterCode != ''">
									AND ACC.CostCenterCode = '#{CostCenterCode}' 
									</if>
									<if test="RegisterNm != null and RegisterNm != ''">
									AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT(''%'','#{RegisterNm}',''%''))
									</if>
			                  	GROUP BY SOU.UserCode, ASB.StandardBriefID WITH ROLLUP 
							) AS A 
							WHERE A.UserCode IS NOT NULL
							GROUP BY A.UserCode 
							ORDER BY A.GroupSortPath, A.GroupName, A.UserName'
					);

		PREPARE stmt FROM @stmt;
		EXECUTE stmt;
		DEALLOCATE PREPARE stmt;	
    </select>
    
    <select id="selectMonthlyStandardBriefSummaryListCnt" parameterType="cmap" resultType="java.lang.Long">
	    SELECT COUNT(UserCode)
			FROM (
				SELECT UserCode
				FROM (
					SELECT
						ACC.CostCenterCode AS GroupCode, 
						ACC.CostCenterName AS GroupName, 
						covi_account4j_si.fn_getGroupPathByCostCenter(ACC.CostCenterCode) AS GroupSortPath,
						SOU.UserCode, 
						SOU.DisplayName AS UserName, 
						ASB.StandardBriefID AS StandardBriefID, 
						ASB.StandardBriefName AS StandardBriefName,
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
									ELSE SUM(AEAD.Amount) 
						END AS AmountSum    
					FROM covi_account4j_si.act_expence_application AS AEA
					INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
					INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					LEFT OUTER JOIN covi_account4j_si.act_standard_brief AS ASB ON AEAD.StandardBriefID = ASB.StandardBriefID
					LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
					LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
					LEFT OUTER JOIN ( 
						SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
						FROM covi_account4j_si.act_expence_application_div AEAD
						GROUP BY AEAD.ExpenceApplicationListID
					) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
					WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
					<if test="companyCode != null and companyCode != ''">
					AND AEA.CompanyCode = #{companyCode}
					</if>
					<if test="ChargeJob != null and ChargeJob != ''">
					AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
					</if>
					<if test="RequestType != null and RequestType != ''">
					AND AEA.RequestType = #{RequestType}
					</if>
					<if test="ProofDate != null and ProofDate != ''">
					AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
					</if>
					<if test="StandardBriefID != null and StandardBriefID != ''">
					AND ASB.StandardBriefID = #{StandardBriefID}
					</if>
					<if test="CostCenterCode != null and CostCenterCode != ''">
					AND ACC.CostCenterCode = #{CostCenterCode}
					</if>
					<if test="RegisterNm != null and RegisterNm != ''">
					AND UPPER(SOU.DisplayName) LIKE UPPER(CONCAT('%',#{RegisterNm},'%'))
					</if>
					GROUP BY SOU.UserCode, ASB.StandardBriefID WITH ROLLUP
				) AS A
				WHERE A.UserCode IS NOT NULL
				GROUP BY A.UserCode
			) AS B
    </select> 
    
    <select id="selectMonthlyStandardBriefDeptSummaryList" parameterType="cmap" resultType="cmap">
    	SET @stmt = NULL;
		SELECT
			GROUP_CONCAT(DISTINCT
				CONCAT(
      				'SUM(CASE WHEN StandardBriefID = ', StandardBriefID, ' THEN AmountSum ELSE 0 END) AS `', StandardBriefID, 'Sum`'
				)
			) INTO @stmt
		FROM
		(
			SELECT
				ASB.StandardBriefID,
				CASE
					WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
					ELSE SUM(AEAD.Amount) 
				END AS AmountSum    
			FROM covi_account4j_si.act_expence_application AS AEA
			INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
			LEFT OUTER JOIN covi_account4j_si.act_standard_brief AS ASB ON AEAD.StandardBriefID = ASB.StandardBriefID
			LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
			LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
			LEFT OUTER JOIN ( 
				SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
				FROM covi_account4j_si.act_expence_application_div AEAD
				GROUP BY AEAD.ExpenceApplicationListID
			) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
			WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
			<if test="companyCode != null and companyCode != ''">
			AND AEA.CompanyCode = #{companyCode}
			</if>
			<if test="ChargeJob != null and ChargeJob != ''">
			AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
			</if>
			<if test="RequestType != null and RequestType != ''">
			AND AEA.RequestType = #{RequestType}
			</if>
			<if test="ProofDate != null and ProofDate != ''">
			AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
			</if>
			<if test="StandardBriefID != null and StandardBriefID != ''">
			AND ASB.StandardBriefID = #{StandardBriefID}
			</if>
			<if test="CostCenterCode != null and CostCenterCode != ''">
			AND ACC.CostCenterCode = #{CostCenterCode}
			</if>
			GROUP BY ACC.CostCenterCode, ASB.StandardBriefID WITH ROLLUP
		) AS A;

		SET @stmt = CONCAT('SELECT * FROM (
								SELECT A.GroupCode, A.GroupName, A.GroupSortPath', IF(@stmt IS NULL, '', CONCAT(', ', @stmt)), 
								', SUM(CASE WHEN StandardBriefID IS NULL THEN AmountSum ELSE 0 END) AS TotalSum  
							  	FROM ( 
									SELECT 
										ACC.CostCenterCode AS GroupCode, 
										ACC.CostCenterName AS GroupName, 
										covi_account4j_si.fn_getGroupPathByCostCenter(ACC.CostCenterCode) AS GroupSortPath,
										ASB.StandardBriefID AS StandardBriefID, 
										ASB.StandardBriefName AS StandardBriefName,
										CASE 
											WHEN (AEAL.ProofCode = ''TaxBill'' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
													ELSE SUM(AEAD.Amount) 
										END AS AmountSum  
				                  	FROM covi_account4j_si.act_expence_application AS AEA 
										INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID 
										INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID 
										LEFT OUTER JOIN covi_account4j_si.act_standard_brief AS ASB ON AEAD.StandardBriefID = ASB.StandardBriefID
										LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
										LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
										LEFT OUTER JOIN ( 
											SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
											FROM covi_account4j_si.act_expence_application_div AEAD
											GROUP BY AEAD.ExpenceApplicationListID
										) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
										WHERE AEA.ApplicationStatus IN (''E'', ''CD'', ''CP'', ''CR'', ''CE'', ''CC'')
										<if test="companyCode != null and companyCode != ''">
										AND AEA.CompanyCode = '#{companyCode}'
										</if>
										<if test="ChargeJob != null and ChargeJob != ''">
										AND AEA.ChargeJob LIKE CONCAT('#{ChargeJob}',''%'')
										</if>
										<if test="RequestType != null and RequestType != ''">
										AND AEA.RequestType = '#{RequestType}'
										</if>
										<if test="ProofDate != null and ProofDate != ''">
										AND AEAL.ProofDate LIKE CONCAT('#{ProofDate}',''%'')
										</if>
										<if test="StandardBriefID != null and StandardBriefID != ''">
										AND ASB.StandardBriefID = '#{StandardBriefID}' 
										</if>
										<if test="CostCenterCode != null and CostCenterCode != ''">
										AND ACC.CostCenterCode = '#{CostCenterCode}'
										</if>
				                  	GROUP BY ACC.CostCenterCode, ASB.StandardBriefID WITH ROLLUP 
								) AS A
						 		WHERE A.GroupCode IS NOT NULL
								GROUP BY A.GroupCode 
								
								UNION ALL
								
								SELECT ''DEPT_TOTAL'' AS GroupCode, ''TOTAL'' AS GroupName, ''99'' AS GroupSortPath', IF(@stmt IS NULL, '', CONCAT(', ', @stmt)), 
									', SUM(CASE WHEN StandardBriefID IS NULL THEN AmountSum ELSE 0 END) AS TotalSum  
							  	FROM ( 
									SELECT 
										ASB.StandardBriefID,
										CASE 
											WHEN (AEAL.ProofCode = ''TaxBill'' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
													ELSE SUM(AEAD.Amount) 
										END AS AmountSum   
				                  	FROM covi_account4j_si.act_expence_application AS AEA 
										INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID 
										INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID 
										LEFT OUTER JOIN covi_account4j_si.act_standard_brief AS ASB ON AEAD.StandardBriefID = ASB.StandardBriefID
										LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
										LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
										LEFT OUTER JOIN ( 
											SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
											FROM covi_account4j_si.act_expence_application_div AEAD
											GROUP BY AEAD.ExpenceApplicationListID
										) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
										WHERE AEA.ApplicationStatus IN (''E'', ''CD'', ''CP'', ''CR'', ''CE'', ''CC'')
										<if test="companyCode != null and companyCode != ''">
										AND AEA.CompanyCode = '#{companyCode}'
										</if>
										<if test="ChargeJob != null and ChargeJob != ''">
										AND AEA.ChargeJob LIKE CONCAT('#{ChargeJob}',''%'') 
										</if>
										<if test="RequestType != null and RequestType != ''">
										AND AEA.RequestType = '#{RequestType}'
										</if>
										<if test="ProofDate != null and ProofDate != ''">
										AND AEAL.ProofDate LIKE CONCAT('#{ProofDate}',''%'')  
										</if>
										<if test="StandardBriefID != null and StandardBriefID != ''">
										AND ASB.StandardBriefID = '#{StandardBriefID}'
										</if>
										<if test="CostCenterCode != null and CostCenterCode != ''">
										AND ACC.CostCenterCode = '#{CostCenterCode}'
										</if>
				                  	GROUP BY ASB.StandardBriefID WITH ROLLUP 
								) AS B
							) AS AA
					 		WHERE AA.TotalSum IS NOT NULL
							ORDER BY AA.GroupSortPath, AA.GroupName'
					);

		PREPARE stmt FROM @stmt;
		EXECUTE stmt;
		DEALLOCATE PREPARE stmt;	
    </select>
    
    <select id="selectMonthlyStandardBriefDeptSummaryListCnt" parameterType="cmap" resultType="java.lang.Long">
	    SELECT COUNT(GroupCode)
			FROM (
				SELECT GroupCode
				FROM (
					SELECT
						ACC.CostCenterCode AS GroupCode, 
						ACC.CostCenterName AS GroupName, 
						covi_account4j_si.fn_getGroupPathByCostCenter(ACC.CostCenterCode) AS GroupSortPath,
						ASB.StandardBriefID AS StandardBriefID, 
						ASB.StandardBriefName AS StandardBriefName,
						CASE 
							WHEN (AEAL.ProofCode = 'TaxBill' AND SUM(AEAD.Amount) != AEAL.TotalAmount) THEN SUM(AEAD.Amount) + SUM(CASE WHEN M_AEAD.ExpenceApplicationDivID IS NOT NULL THEN AEAL.TaxAmount ELSE 0 END) 
									ELSE SUM(AEAD.Amount) 
						END AS AmountSum     
					FROM covi_account4j_si.act_expence_application AS AEA
					INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
					INNER JOIN covi_account4j_si.act_expence_application_div AS AEAD ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
					LEFT OUTER JOIN covi_account4j_si.act_standard_brief AS ASB ON AEAD.StandardBriefID = ASB.StandardBriefID
					LEFT OUTER JOIN covi_account4j_si.act_cost_center AS ACC ON AEAD.CostCenterCode = ACC.CostCenterCode 
					LEFT OUTER JOIN covi_smart4j.sys_object_user AS SOU ON AEA.RegisterID = SOU.UserCode
					LEFT OUTER JOIN ( 
						SELECT MIN(AEAD.ExpenceApplicationDivID) AS ExpenceApplicationDivID
						FROM covi_account4j_si.act_expence_application_div AEAD
						GROUP BY AEAD.ExpenceApplicationListID
					) M_AEAD ON M_AEAD.ExpenceApplicationDivID = AEAD.ExpenceApplicationDivID
					WHERE AEA.ApplicationStatus IN ('E', 'CD', 'CP', 'CR', 'CE', 'CC')
					<if test="companyCode != null and companyCode != ''">
					AND AEA.CompanyCode = #{companyCode}
					</if>
					<if test="ChargeJob != null and ChargeJob != ''">
					AND AEA.ChargeJob LIKE CONCAT(#{ChargeJob},'%')
					</if>
					<if test="RequestType != null and RequestType != ''">
					AND AEA.RequestType = #{RequestType}
					</if>
					<if test="ProofDate != null and ProofDate != ''">
					AND AEAL.ProofDate LIKE CONCAT(#{ProofDate},'%')
					</if>
					<if test="StandardBriefID != null and StandardBriefID != ''">
					AND ASB.StandardBriefID = #{StandardBriefID}
					</if>
					<if test="CostCenterCode != null and CostCenterCode != ''">
					AND ACC.CostCenterCode = #{CostCenterCode}
					</if>
					GROUP BY ACC.CostCenterCode, ASB.StandardBriefID WITH ROLLUP
				) AS A
				WHERE A.GroupCode IS NOT NULL
				GROUP BY A.GroupCode
			) AS B
    </select>
    
    
    
    
     <insert id="insertExpAppDailyList" parameterType="cmap">
 	    /*
 	    	expenceApplication.insertExpAppDailyList
 	    	일비 내역 저장
 	    */
		INSERT INTO covi_account4j_si.act_biztrip_daily
		(
			ExpenceApplicationID
			, ExpenceApplicationListID
			, BizTripDateSt
			, BizTripDateEd
			, DailyType
			, DailyAmount
			, RegisterID
			, RegistDate
			, ModifierID
			, ModifyDate
		)
		VALUES
		(
			#{ExpenceApplicationID}
			, #{ExpenceApplicationListID}
			, #{BizTripDateSt}
			, #{BizTripDateEd}
			, #{DailyType}
			, #{DailyAmount}
			, #{SessionUser}
			, NOW()
			, #{SessionUser}
			, NOW()
		)
	</insert>
	<delete id="deleteExpAppDailyList" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteExpAppDailyList
 	    	일비 내역 삭제
 	    */
	    DELETE FROM covi_account4j_si.act_biztrip_daily
	    WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </delete>
    
    <insert id="insertExpAppFuelList" parameterType="cmap">
 	    /*
 	    	expenceApplication.insertExpAppFuelList
 	    	유류비 내역 저장
 	    */
		INSERT INTO covi_account4j_si.act_biztrip_fuel
		(
			ExpenceApplicationID
			, ExpenceApplicationListID
			, BizTripDate
			, StartPoint
			, EndPoint
			, FuelType
			, Distance
			, UnitPrice
			, RealPrice
			, RegisterID
			, RegistDate
			, ModifierID
			, ModifyDate
		)
		VALUES
		(
			#{ExpenceApplicationID}
			, #{ExpenceApplicationListID}
			, #{BizTripDate}
			, #{StartPoint}
			, #{EndPoint}
			, #{FuelType}
			, #{Distance}
			, #{FuelUnitPrice}
			, #{FuelRealPrice}
			, #{SessionUser}
			, NOW()
			, #{SessionUser}
			, NOW()
		)
	</insert>
	<delete id="deleteExpAppFuelList" parameterType="cmap">
 	    /*
 	    	expenceApplication.deleteExpAppFuelList
 	    	유류비 내역 삭제
 	    */
	    DELETE FROM covi_account4j_si.act_biztrip_fuel
	    WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </delete>
    
    <select id="selectFormData" parameterType="cmap" resultType="cmap">
    	SELECT 
			WP.BusinessState
			, WP.ProcessState AS ProcessState
			, WP.ParentProcessID
			, WP.DeputyID
			, WP.UserCode
			, WP.State AS WorkitemState
			, F.ExtInfo
			, F.FormName
			, F.FormPrefix
			, F.FormID
			, S.SchemaContext
			, ChargeJob
			, WP.FormInstID
		FROM ( SELECT P.BusinessState
					, P.ProcessState
					, P.ProcessID AS ProcessID
					, P.ParentProcessID
					, W.DeputyID
					, W.UserCode
					, W.State
					, P.FormInstID
					, AEA.ChargeJob
				FROM covi_approval4j.jwf_process AS P
				INNER JOIN covi_account4j_si.act_expence_application AS AEA 
					ON AEA.ProcessID IN (P.ProcessID, P.ParentProcessID)
				INNER JOIN covi_approval4j.jwf_process AS JP 
					ON JP.ProcessID IN (P.ProcessID, P.ParentProcessID)
				INNER JOIN covi_approval4j.jwf_workitem AS W
					ON JP.ProcessID = W.ProcessID
				WHERE ExpenceApplicationID = #{ExpAppID}
				<if test="WorkitemID != null and WorkitemID != ''">
					AND W.WorkitemID = #{WorkitemID}
				</if>
			) WP
		INNER JOIN covi_approval4j.jwf_formInstance AS I
			ON WP.FormInstID = I.FormInstID
		INNER JOIN covi_approval4j.jwf_forms AS F
			ON I.FormID = F.FormID
		INNER JOIN covi_approval4j.jwf_formsschema AS S
			ON F.SchemaID = S.SchemaID
		ORDER BY WP.ProcessID desc
		LIMIT 1
    </select>
    
    <select id="selectExpAppListIDs" parameterType="cmap" resultType="cmap">
    	SELECT ExpenceApplicationListID
    	FROM covi_account4j_si.act_expence_application_list
    	WHERE ExpenceApplicationID = #{ExpenceApplicationID}
    </select>
    
	<select id="selectExpenceApplicationDuplicateCheck" parameterType="cmap" resultType="cmap">
    	SELECT ProcessID
    	FROM covi_account4j_si.act_expence_application
    	WHERE ExpenceApplicationID = #{ExpenceApplicationID}
    </select>
    
    <insert id="insertExpAppForReuse" parameterType="cmap">
    	INSERT INTO covi_account4j_si.act_expence_application
    	(
    		CompanyCode
    		, ApplicationStatus
    		, ApplicationTitle
    		, ApplicationType
    		, RegisterID
    		, RegistDate
    		, ModifierID
    		, ModifyDate
    		, ChargeJob
    		, PayDateType
    		, RequestType
    		, ReservedStr1
    		, ReservedStr2
    		, ReservedStr3
    		, ReservedStr4
    		, ReservedStr5
    		, ReservedInt1
    		, ReservedInt2
    		, DocNo
    		, CompanyName
    		, UR_DisplayName
    		, RuleItemInfo
    		, Sub_UR_Code
    		, Sub_UR_Info
    	) 
    	SELECT 
    		CompanyCode
    		, 'T'
    		, ApplicationTitle
    		, ApplicationType
    		, RegisterID
    		, NOW(3)
    		, ModifierID
    		, NOW(3)
    		, ChargeJob
    		, PayDateType
    		, RequestType
    		, ReservedStr1
    		, ReservedStr2
    		, ReservedStr3
    		, ReservedStr4
    		, ReservedStr5
    		, ReservedInt1
    		, ReservedInt2
    		, DocNo
    		, CompanyName
    		, UR_DisplayName
    		, RuleItemInfo
    		, Sub_UR_Code
    		, Sub_UR_Info
    	FROM covi_account4j_si.act_expence_application
    	WHERE ExpenceApplicationID = #{ExpenceApplicationID}
		
		<selectKey keyProperty="newExpAppID" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
    </insert>
    
    <insert id="insertExpAppBizTripForReuse" parameterType="cmap">
    	INSERT INTO covi_account4j_si.act_biztrip_application
    	(
    		BizTripRequestID
    		, ExpenceApplicationID
    		, CompanyCode
    		, ApplicationTitle
    		, ApplicationStatus
    		, ApplicationDate
    		, FormInstanceID
    		, ProcessID
    		, UserID
    		, UserName
    		, StartDate
    		, EndDate
    		, BusinessArea
    		, BusinessPurpose
    		, BusinessDay
    		, WorkingDay
    		, Amount
    		, BizTripNoteMap
    		, RegisterID
    		, RegistDate
    		, ReservedStr1
    		, ReservedStr2
    		, ReservedStr3
    		, ReservedStr4
    		, ReservedStr5
    		, ReservedInt1
    		, ReservedInt2
    	) 
    	SELECT 
    		BizTripRequestID
    		, #{newExpAppID}
    		, CompanyCode
    		, ApplicationTitle
    		, 'T'
    		, ApplicationDate
    		, FormInstanceID
    		, ProcessID
    		, UserID
    		, UserName
    		, StartDate
    		, EndDate
    		, BusinessArea
    		, BusinessPurpose
    		, BusinessDay
    		, WorkingDay
    		, Amount
    		, BizTripNoteMap
    		, RegisterID
    		, NOW(3)
    		, ReservedStr1
    		, ReservedStr2
    		, ReservedStr3
    		, ReservedStr4
    		, ReservedStr5
    		, ReservedInt1
    		, ReservedInt2
    	FROM covi_account4j_si.act_biztrip_application
    	WHERE ExpenceApplicationID = #{ExpenceApplicationID}
    </insert>
    
    <insert id="insertExpAppListForReuse" parameterType="cmap">
    	INSERT INTO covi_account4j_si.act_expence_application_list
    	(
    		ExpenceApplicationID
    		, ProofDate
    		, ProofCode
    		, CardApproveNo
    		, CardUID
    		, CashNTSConfirmNum
    		, CashUID
    		, TaxNTSConfirmNum
    		, TaxUID
    		, ReceiptID
    		, PostingDate
    		, TaxType
    		, TaxCode
    		, PayAdjustMethod
    		, PayMethod
    		, PayDate
    		, IsWithholdingTax
    		, IncomeTax
    		, LocalTax
    		, VendorNo
    		, PersonalCardNo
    		, TotalAmount
    		, DocNo
    		, unDocNo
    		, DocPostingDate
    		, DocPayDate
    		, InterfaceKeyID
    		, RegisterID
    		, RegistDate
    		, ModifierID
    		, ModifyDate
    		, BankCode
    		, BankAccountNo
    		, BankAccountName
    		, ReservedStr1
    		, ReservedStr2
    		, ReservedStr3
    		, ReservedStr4
    		, ReservedStr5
    		, ReservedInt1
    		, ReservedInt2
    		, RepAmount
    		, TaxAmount
    		, VendorName
    		, RealPayDate
    		, RealPayAmount
    	) 
    	SELECT 
    		#{newExpAppID}
    		, ProofDate
    		, ProofCode
    		, CardApproveNo
    		, CardUID
    		, CashNTSConfirmNum
    		, CashUID
    		, TaxNTSConfirmNum
    		, TaxUID
    		, ReceiptID
    		, PostingDate
    		, TaxType
    		, TaxCode
    		, PayAdjustMethod
    		, PayMethod
    		, PayDate
    		, IsWithholdingTax
    		, IncomeTax
    		, LocalTax
    		, VendorNo
    		, PersonalCardNo
    		, TotalAmount
    		, DocNo
    		, unDocNo
    		, DocPostingDate
    		, DocPayDate
    		, InterfaceKeyID
    		, RegisterID
    		, NOW(3)
    		, ModifierID
    		, NOW(3)
    		, BankCode
    		, BankAccountNo
    		, BankAccountName
    		, ReservedStr1
    		, ReservedStr2
    		, ReservedStr3
    		, ReservedStr4
    		, ReservedStr5
    		, ReservedInt1
    		, ReservedInt2
    		, RepAmount
    		, TaxAmount
    		, VendorName
    		, RealPayDate
    		, RealPayAmount
    	FROM covi_account4j_si.act_expence_application_list
    	WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
		
		<selectKey keyProperty="newExpAppListID" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
    </insert>
    
    <insert id="insertExpAppFileForReuse" parameterType="cmap">
    	INSERT INTO covi_account4j_si.act_expence_application_file
    	(
    		ExpenceApplicationListID
    		, FileID
    		, RegisterID
    		, RegistDate
    	) 
    	SELECT 
    		#{newExpAppListID}
    		, FileID
    		, RegisterID
    		, NOW(3)
    	FROM covi_account4j_si.act_expence_application_file
    	WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </insert>
    
    <insert id="insertExpAppRefForReuse" parameterType="cmap">
    	INSERT INTO covi_account4j_si.act_expence_application_ref
    	(
    		ExpenceApplicationListID
    		, ProcessID
    		, RegisterID
    		, RegistDate
    	) 
    	SELECT 
    		#{newExpAppListID}
    		, ProcessID
    		, RegisterID
    		, NOW(3)
    	FROM covi_account4j_si.act_expence_application_ref
    	WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </insert>
    
    <insert id="insertExpAppDailyForReuse" parameterType="cmap">
    	INSERT INTO covi_account4j_si.act_biztrip_daily
    	(
    		ExpenceApplicationID
    		, ExpenceApplicationListID
    		, BizTripDateSt
    		, BizTripDateEd
    		, DailyType
    		, DailyAmount
    		, RegisterID
    		, RegistDate
    	) 
    	SELECT
    		#{newExpAppID}
    		, #{newExpAppListID}
    		, BizTripDateSt
    		, BizTripDateEd
    		, DailyType
    		, DailyAmount
    		, RegisterID
    		, NOW(3)
    	FROM covi_account4j_si.act_biztrip_daily
    	WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </insert>
    
    <insert id="insertExpAppFuelForReuse" parameterType="cmap">
    	INSERT INTO covi_account4j_si.act_biztrip_fuel
    	(
    		ExpenceApplicationID
    		, ExpenceApplicationListID
    		, BizTripDate
    		, StartPoint
    		, EndPoint
    		, FuelType
    		, Distance
    		, UnitPrice
    		, RealPrice
    		, RegisterID
    		, RegistDate
    	) 
    	SELECT 
    		#{newExpAppID}
    		, #{newExpAppListID}
    		, BizTripDate
    		, StartPoint
    		, EndPoint
    		, FuelType
    		, Distance
    		, UnitPrice
    		, RealPrice
    		, RegisterID
    		, NOW(3)
    	FROM covi_account4j_si.act_biztrip_fuel
    	WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </insert>
    
    <insert id="insertExpAppDivForReuse" parameterType="cmap">
    	INSERT INTO covi_account4j_si.act_expence_application_div
    	(
    		ExpenceApplicationListID
    		, AccountCode
    		, AccountName
    		, StandardBriefID
    		, StandardBriefName
    		, CostCenterCode
    		, CostCenterName
    		, IOCode
    		, IOName
    		, Amount
    		, UsageComment
    		, InterfaceKeyID
    		, RegisterID
    		, RegistDate
    		, ReservedStr1
    		, ReservedStr2
    		, ReservedStr3
    		, ReservedStr4
    		, ReservedStr5
    		, ReservedInt1
    		, ReservedInt2
    	) 
    	SELECT 
    		#{newExpAppListID}
    		, AccountCode
    		, AccountName
    		, StandardBriefID
    		, StandardBriefName
    		, CostCenterCode
    		, CostCenterName
    		, IOCode
    		, IOName
    		, Amount
    		, UsageComment
    		, InterfaceKeyID
    		, RegisterID
    		, NOW(3)
    		, ReservedStr1
    		, ReservedStr2
    		, ReservedStr3
    		, ReservedStr4
    		, ReservedStr5
    		, ReservedInt1
    		, ReservedInt2
    	FROM covi_account4j_si.act_expence_application_div
    	WHERE ExpenceApplicationListID = #{ExpenceApplicationListID}
    </insert>
    
    <select id="selectCardList" parameterType="cmap" resultType="cmap">
 	    /*
 	    	expenceApplication.selectCardList
 	    	카드목록 조회
 	    */
		
		SELECT 	DISTINCT CC.CorpCardID
			, 	CC.CardNo
			, 	CONCAT(CC.CardNo,'||',IFNULL(UR.DisplayName,'')) as 'CorpCardName'
		FROM 	covi_account4j_si.act_corp_card AS CC	
		LEFT JOIN covi_smart4j.sys_object_user as UR 
		ON CC.OwnerUserCode = UR.UserCode
		LEFT JOIN covi_account4j_si.act_corp_card_return RET
		ON CC.CardNo = RET.CardNo
		WHERE	CC.CardClass = CASE WHEN (
			SELECT ExpAppType FROM covi_account4j_si.act_expence_forms A 
			WHERE FormCode = #{RequestType} AND IsUse = 'Y'
			AND	CompanyCode = (
				CASE WHEN EXISTS (SELECT ExpenceFormID FROM covi_account4j_si.act_expence_forms WHERE CompanyCode = #{CompanyCode} AND FormCode = #{RequestType} AND IsUse = 'Y')
				THEN #{CompanyCode}
				ELSE 'ALL'
				END
			)
		) = 'CO' THEN 'CCL3' ELSE CardClass END /*거래처 정산서는 공용법인카드만*/
		AND		(
					CC.OwnerUserCode	= #{UR_Code}
					OR (
						RET.ReleaseUserCode = #{UR_Code}
						AND (
							SELECT COUNT(CR.ReceiptID)
							FROM covi_account4j_si.act_card_receipt CR 
							WHERE CR.ApproveDate BETWEEN DATE_FORMAT(RET.ReleaseDate, '%Y%m%d') AND DATE_FORMAT(IFNULL(RET.ReturnDate, '29991231'), '%Y%m%d')
							AND RET.ReleaseUserCode = #{UR_Code}
							AND CR.CardNo = RET.CardNo
							AND CR.Active = 'N'
						) > 0
					)
					OR CC.CardNo		IN (SELECT	CR.CardNo
											FROM	covi_account4j_si.act_card_receipt CR
											WHERE	CR.TossUserCode = #{UR_Code}
											AND 	CR.Active = 'N'
										)
					OR CC.CorpCardID	IN (SELECT	ACCSU.CorpCardID
											FROM	covi_account4j_si.act_corp_card_search_user ACCSU 
											WHERE	ACCSU.OwnerUserCode = #{UR_Code}
										)
				)
			AND CC.CardStatus NOT IN ('CSTS03')
	</select>
    
    <update id="updateAuditReason" parameterType="cmap">
    	UPDATE covi_account4j_si.act_expence_application
    	SET AuditReason = #{AuditReason}
    	WHERE ExpenceApplicationID = #{ExpenceApplicationID}
    </update>
    
    <select id="selRecentVendorInfo" parameterType="cmap" resultType="cmap">
    	/*
    		expenceApplication.selRecentVendorInfo
    		최근사용한 Vendor의 증빙정보를 가져온다.
    	*/
    	SELECT *
		FROM covi_account4j_si.act_expence_application_list as EAL 
	    INNER JOIN covi_account4j_si.act_expence_application_div AS EAD 
		ON EAL.ExpenceApplicationListID = EAD.ExpenceApplicationListID
		WHERE EAL.ExpenceApplicationListID = (
			SELECT  EAD.ExpenceApplicationListID
			FROM covi_account4j_si.act_expence_application as EA
			INNER JOIN covi_account4j_si.act_expence_application_list AS EAL
			ON EA.ExpenceApplicationID = eal.ExpenceApplicationID
			INNER JOIN covi_account4j_si.act_expence_application_div AS  EAD
			ON EAL.ExpenceApplicationListID = EAD.ExpenceApplicationListID
			WHERE 1=1
			AND EA.ApplicationStatus = 'E'
			AND ( ProofCode = 'TaxBill' OR ProofCode = 'PaperBill' OR ProofCode = 'EtcEvid')
			AND REPLACE(EAL.VendorNo, '-', '') =REPLACE(#{BusinessNumber}, '-', '')
			AND EAL.ProofCode = #{proofCode}
			AND EA.RegisterID = #{UR_Code}
			ORDER BY EA.RegistDate DESC
			LIMIT 1
		)
		
    </select>
    
    
	<select id="selectStoreCategoryList" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectStoreCategoryList
		*/
		
		SELECT	A.*
			,	B.StandardBriefName
		FROM 	covi_account4j_si.act_store_category A
		LEFT
		JOIN	covi_account4j_si.act_standard_brief B
		ON		A.StandardBriefID	=	B.StandardBriefID
		WHERE	1=1
	</select>
        
	<select id="selectStandardBriefCtrlCombo" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectStandardBriefCtrlCombo
		*/
		
		SELECT
			SB.StandardBriefID,
			SB.StandardBriefName
		FROM covi_account4j_si.act_account AC
		INNER JOIN covi_account4j_si.act_standard_brief SB
		ON AC.AccountID = SB.AccountID
		WHERE SB.CtrlCode IS NOT NULL AND SB.CtrlCode != ''
		<if test="companyCode != null and companyCode != ''">
		AND AC.CompanyCode = #{CompanyCode}
		</if>
	</select>
    
	<select id="selectCtrlCode" parameterType="cmap" resultType="java.lang.String">
		/*
			expenceApplication.selectCtrlCode
		*/
		
		SELECT CtrlCode
		FROM covi_account4j_si.act_standard_brief
		WHERE StandardBriefID = #{StandardBriefID}
	</select>
    
	<select id="selectCtrlCodeHeader" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectCtrlCodeHeader
		*/
		
		SELECT Code, CodeName
		FROM covi_account4j_si.act_base_code
		WHERE Code IN
		<foreach collection="CtrlCode" item="item" index="index" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</select>
    
	<select id="selectMajorAccountUsageHistory" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectMajorAccountUsageHistory
		*/
		
		SELECT 
			covi_account4j_si.Fn_GetBaseCodeName('CompanyCode', AEA.CompanyCode, #{CompanyCode}) AS CompanyName,
			AEA.ApplicationTitle,
			(SELECT DeptName FROM covi_smart4j.sys_object_user_basegroup SOUB WHERE AEA.RegisterID = SOUB.UserCode AND SOUB.JobType = 'Origin') AS DeptName,		
			(SELECT DisplayName FROM covi_smart4j.sys_object_user SOU WHERE AEA.RegisterID = SOU.UserCode) AS UserName,
			DATE_FORMAT(AEAL.PostingDate, '%Y-%m-%d') AS PostingDate,
			AEAD.CostCenterName,
			AEAD.AccountName,
			AEAD.StandardBriefName,
			AEAL.TotalAmount,
			AEAD.Amount,						
			AEAD.UsageComment,			
			<if test="CtrlCode != null">
				<foreach collection="CtrlCode" item="item" index="index" close="," separator=",">
					REPLACE(JSON_EXTRACT(AEAD.ReservedStr2, CONCAT('$.', #{item})), '"', '') AS ${item}
				</foreach>
			</if>
			
			AEA.RegisterID,
			AEAD.CostCenterCode,
			AEAD.AccountCode,
			AEAD.StandardBriefID,
			
			AEA.ExpenceApplicationID,
			AEA.ProcessID,
			(SELECT FormInstID FROM covi_approval4j.jwf_process P WHERE AEA.ProcessID = P.ProcessID) AS FormInstID,		
			AEA.ApplicationStatus
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		WHERE AEA.ApplicationStatus = 'E'
		<if test="CompanyCode != null and CompanyCode != ''">
		AND AEA.CompanyCode = #{CompanyCode}
		</if>
		<if test="PostingDate != null and PostingDate != ''">
		AND AEAL.PostingDate LIKE CONCAT(#{PostingDate}, '%')
		</if>
		<if test="StandardBriefID != null and StandardBriefID != ''">
		AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>					
		<trim prefix="ORDER BY"  prefixOverrides =",">
			<if test = "sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				, AEA.ExpenceApplicationID ASC
		    </if>
		  	<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
			 	, 	
				<choose>	
					<when test='sortColumn.equalsIgnoreCase("CompanyName")'>CompanyName</when>
					<when test='sortColumn.equalsIgnoreCase("ApplicationTitle")'>ApplicationTitle</when>
					<when test='sortColumn.equalsIgnoreCase("DeptName")'>DeptName</when>
					<when test='sortColumn.equalsIgnoreCase("UserName")'>UserName</when>
					<when test='sortColumn.equalsIgnoreCase("PostingDate")'>PostingDate</when>
					<when test='sortColumn.equalsIgnoreCase("CostCenterName")'>CostCenterName</when>
					<when test='sortColumn.equalsIgnoreCase("AccountName")'>AccountName</when>
					<when test='sortColumn.equalsIgnoreCase("StandardBriefName")'>StandardBriefName</when>
					<when test='sortColumn.equalsIgnoreCase("TotalAmount")'>TotalAmount</when>
					<when test='sortColumn.equalsIgnoreCase("Amount")'>Amount</when>
					<when test='sortColumn.equalsIgnoreCase("UsageComment")'>UsageComment</when>
				</choose>	
				<choose>	
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>	
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
    
	<select id="selectMajorAccountUsageHistoryCnt" parameterType="cmap" resultType="java.lang.Long">
		/*
			expenceApplication.selectMajorAccountUsageHistoryCnt
		*/
		
		SELECT COUNT(*)
		FROM covi_account4j_si.act_expence_application AEA
		INNER JOIN covi_account4j_si.act_expence_application_list AEAL
		ON AEA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AEAD
		ON AEAL.ExpenceApplicationListID = AEAD.ExpenceApplicationListID
		WHERE AEA.ApplicationStatus = 'E'
		<if test="CompanyCode != null and CompanyCode != ''">
		AND AEA.CompanyCode = #{CompanyCode}
		</if>
		<if test="PostingDate != null and PostingDate != ''">
		AND AEAL.PostingDate LIKE CONCAT(#{PostingDate}, '%')
		</if>
		<if test="StandardBriefID != null and StandardBriefID != ''">
		AND AEAD.StandardBriefID = #{StandardBriefID}
		</if>
	</select>
	
		<select id="selectExpenceApplicationDouzoneicubeList" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDouzoneicubeList
		*/
		
		SELECT EA.ExpenceApplicationID
			, AEAL.ExpenceApplicationListID
			, EA.ApplicationTitle
			, EA.CompanyCode 
			, AEAL.ProofDate	
			, CASE WHEN AEAL.ProofCode = 'TaxBill' THEN ATI.invoicerCorpNum
				WHEN AEAL.ProofCode = 'PaperBill' THEN AEAL.ProviderNo
				WHEN AEAL.ProofCode = 'CorpCard' THEN CR.CardNo
				WHEN AEAL.ProofCode = 'EtcEvid' THEN EA.RegisterID
				ELSE 'NoNumber'
			END AS REG_NB
			, AEAL.ProofCode
			, AEAL.TotalAmount 
			, AEAL.RepAmount
			, AEAL.TaxAmount
			, EA.ApplicationTitle
			, CASE WHEN AEAL.ProofCode = 'CorpCard' THEN CR.StoreName
				WHEN AEAL.ProofCode = 'TaxBill'	THEN ATI.InvoicerCorpName
				WHEN AEAL.ProofCode = 'PaperBill'	THEN AEAL.VendorName
				ELSE 'NoNumber'
			END AS TR_NM
			, CASE WHEN AEAL.ProofCode = 'CorpCard' THEN CR.CardNo
				WHEN AEAL.ProofCode = 'TaxBill'	THEN ATI.invoicerCorpNum
				WHEN AEAL.ProofCode = 'PaperBill'	THEN AEAL.ProviderNo
				ELSE 'NoNumber'
			END AS TR_CD
			, CASE WHEN AEAL.ProofCode = 'TaxBill'	THEN '1'
				ELSE '0' 
			END AS JEONJA_YN
		FROM covi_account4j_si.act_expence_application AS EA 
		INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL
		ON EA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		LEFT OUTER JOIN covi_account4j_si.act_card_receipt CR
		ON AEAL.CardUID = CR.ReceiptID
		LEFT OUTER JOIN covi_account4j_si.act_taxinvoice ATI
		ON AEAL.TaxUID = ATI.TaxInvoiceID
		WHERE EA.ApplicationStatus = 'E'
		AND AEAL.ProofDate LIKE  CONCAT(#{SlipDate},'%')
  	
	</select>
	
	<select id="selectExpenceApplicationDouzoneicubeDiv" parameterType="cmap" resultType="cmap">
		/*
			expenceApplication.selectExpenceApplicationDouzoneicubeDiv
		*/
		
		SELECT EAD.*
		FROM covi_account4j_si.act_expence_application AS EA 
		INNER JOIN covi_account4j_si.act_expence_application_list AS AEAL
		ON EA.ExpenceApplicationID = AEAL.ExpenceApplicationID
		INNER JOIN covi_account4j_si.act_expence_application_div AS EAD 
		ON AEAL.ExpenceApplicationListID = EAD.ExpenceApplicationListID
		WHERE EA.ApplicationStatus = 'E'
		AND AEAL.ProofDate LIKE  CONCAT(#{SlipDate},'%')
	</select>
	
	<select id="existsFormAuth" parameterType="cmap" resultType="java.lang.Integer">
		SELECT COUNT(1)
		FROM covi_approval4j.jwf_forms AS jf
		INNER JOIN covi_approval4j.JWF_FormClass as jfc on
			<choose>
				<when test="formId != null and formId != '' ">
					jf.FormID = #{formId}
				</when>
				<when test="formPrefix != null and formPrefix != '' ">
					jf.FormPrefix = #{formPrefix}
				</when>
			</choose>
		and jf.FormClassID = jfc.FormClassID
		where 
		(
			( jfc.AclAllYN = 'Y' and jfc.EntCode IN ('ORGROOT',  #{entCode}) )
			OR exists 
			( 
				select 1 from covi_approval4j.jwf_forms_acl jfa 
				where jfa.TargetID = jfc.FormClassID and jfa.ObjectType = 'CLASS'
				and 
				(
					jfa.GroupType = 'Company' and jfa.CompanyCode = #{entCode}
					or
					jfa.GroupType = 'Dept' and jfa.GroupCode  = #{deptCode}
				)
			)
		)
		AND 
		(
			(
				jf.AclAllYN = 'Y'
				<if test='isSaaS == "Y"'>
				AND	jf.CompanyCode IN ('ORGROOT',  #{entCode})
				</if>
			)
			OR exists 
			( 
				select 1 from covi_approval4j.jwf_forms_acl jfa 
				where jfa.TargetID = jf.FormID and jfa.ObjectType = 'FORM'
				and 
				(
				jfa.GroupType = 'Company' and jfa.CompanyCode = #{entCode}
				or
				jfa.GroupType = 'Dept' and jfa.GroupCode  = #{deptCode}
				)
			)
		)
	</select>
	
	<select id="selectDomainCheck" parameterType="cmap" resultType="cmap">
	    SELECT FI.FormInstID 
	    FROM covi_approval4j.jwf_forminstance AS FI
		WHERE FI.FormInstID = #{FormInstID}
		AND FI.EntCode IN 
        <foreach item="item" index="index" collection="EntCodeList" open="(" close=")" separator=",">
           	#{item.optionValue}
   		</foreach>
		LIMIT 1;
	</select>
	
	<select id="selectUsingSignImageId" parameterType="java.lang.String" resultType="java.lang.String">
	    SELECT FileID FROM covi_approval4j.jwf_signimage
	    WHERE UserCode = #{UserCode} AND IsUse = 'Y'
	    ORDER BY InsertDate DESC
	    LIMIT 1
	</select>
	
	<select id="selectFormInstanceIsArchived" parameterType="cmap" resultType="cmap">
		SELECT CASE WHEN COUNT(*) > 0 THEN 'false' ELSE 'true' END AS isArchive
		FROM covi_approval4j.jwf_process
		WHERE FormInstID = #{FormInstID}
		AND ProcessState = 288
	</select>
	
	<select id="selectProcess" parameterType="cmap" resultType="cmap">
		<![CDATA[
			SELECT
			Process.ProcessID,
			Process.ProcessDescriptionID,
			Process.FormInstID,
			Workitem.State,
			Process.ProcessState,
			Process.ParentProcessID,
			Workitem.UserCode,
			Process.DocSubject,
			IFNULL(Workitem.DeputyID,'') AS DeputyID,
			Process.BusinessState,
			Process.ProcessName,
			Workitem.TaskID,
			Performer.SubKind
			FROM covi_approval4j.jwf_process AS Process
			INNER JOIN covi_approval4j.jwf_workitem AS Workitem ON Process.ProcessID = Workitem.ProcessID
			INNER JOIN covi_approval4j.jwf_performer AS Performer ON Workitem.PerformerID = Performer.PerformerID
			WHERE Workitem.WorkitemID = #{workitemID};
		]]>
	</select>
	
	<select id="selectOnlyProcess" parameterType="cmap" resultType="cmap">
		<![CDATA[
	    	SELECT 	ProcessID,
	    	ProcessDescriptionID,
	    	FormInstID,
	    	'' AS State,
	    	ProcessState, 
	    	ParentProcessID, 
	    	'' AS UserCode,
	    	DocSubject,
	    	'' AS DeputyID,
	    	BusinessState,
	    	ProcessName
			FROM covi_approval4j.jwf_process
			WHERE ProcessID = #{processID};
	    ]]>
	</select>
	
	<select id="selectProcessDes" parameterType="cmap" resultType="cmap">
		<![CDATA[
			SELECT ProcessDescriptionID,
			FormInstID,
			FormID,
			FormName,
			FormSubject,
			IsSecureDoc,
			IsFile,
			FileExt,
			IsComment,
			ApproverCode,
			ApproverName,
			ApprovalStep,
			ApproverSIPAddress,
			IsReserved,
			ReservedGubun,
			ReservedTime,
			Priority,
			IsModify,
			Reserved1,
			Reserved2,
			BusinessData1,
			BusinessData2,
			BusinessData3,
			BusinessData4,
			BusinessData5,
			BusinessData6,
			BusinessData7,
			BusinessData8,
			BusinessData9,
			BusinessData10
			FROM covi_approval4j.jwf_processdescription
			WHERE ProcessDescriptionID = #{processDescID} ;
		]]>
	</select>
	
	<select id="selectFormInstance" parameterType="cmap" resultType="cmap">
		<![CDATA[
			SELECT FormInstID,
			ProcessID,
			FormID,
			SchemaID,
			Subject,
			InitiatorID,
			InitiatorName,
			InitiatorUnitID,
			InitiatorUnitName,
			InitiatedDate,
			CompletedDate,
			DeletedDate,
			LastModifiedDate,
			LastModifierID,
			EntCode,
			EntName,
			DocNo,
			DocLevel,
			DocClassID,
			DocClassName,
			DocSummary,
			IsPublic,
			SaveTerm,
			AttachFileInfo,
			AppliedDate,
			AppliedTerm,
			ReceiveNo,
			ReceiveNames,
			ReceiptList,
			BodyType,
			BodyContext,
			DocLinks,  
			EDMSDocLinks,
			RuleItemInfo
			FROM covi_approval4j.jwf_forminstance
			WHERE FormInstID = #{formInstID};
		]]>
	</select>
	
	<select id="selectDomainData" parameterType="cmap" resultType="cmap">
		<![CDATA[
			SELECT DomainDataID,
			DomainDataName,
			ProcessID,
			DomainDataContext 
			FROM covi_approval4j.jwf_domaindata
			WHERE ProcessID = #{processID};
		]]>
	</select>
	
	<select id="selectFormSchema" parameterType="cmap" resultType="cmap">
		<![CDATA[
			SELECT SchemaID,
			SchemaName,
			SchemaDesc,
			SchemaContext
			FROM covi_approval4j.jwf_formsschema
			WHERE SchemaID = #{schemaID};
		]]>
	</select>
	
	<select id="selectPravateDomainData" parameterType="cmap" resultType="cmap">
	    <![CDATA[
			SELECT
			PrivateDomainDataID,
			CustomCategory,
			DefaultYN,
			DisplayName,
			OwnerID,
			Abstract,
			Description,
			PrivateContext
			FROM covi_approval4j.jwf_privatedomaindata
			WHERE OwnerID = #{OwnerID} ]]>
			<if test="DefaultYN != null">
				AND DefaultYN = #{DefaultYN}
			</if>
			LIMIT 1
	</select>
	
	<select id="selectForm" parameterType="cmap" resultType="cmap">
		SELECT F.FormID,
			F.FormClassID,
			F.SchemaID,
			F.IsUse,
			F.Revision,
			F.SortKey,
			F.FormName,
			F.FormPrefix,
			F.FormDesc,
			F.FileName,
			F.BodyDefault,
			F.EntCode,
			F.ExtInfo,
			F.AutoApprovalLine,
			F.BodyType,
			F.SubTableInfo,
			F.RegID,
			F.RegDate,
			F.ModID,
			F.ModDate,
			F.FormHelperContext,
			F.FormNoticeContext,
			CASE WHEN UF.CreateDate IS NOT NULL THEN 'Y' ELSE 'N' END AS IsFavorite,
			INSTR(  IF(F.AclAllYN ='Y', 
					IF(#{isSaaS}='Y', CONCAT(';', CompanyCode, ';'), CONCAT(';', #{DN_CODE}, ';')), 
					(SELECT CONCAT(';', GROUP_CONCAT(DISTINCT(CompanyCode) SEPARATOR ';'), ';') FROM covi_approval4j.jwf_forms_acl WHERE ObjectType ='FORM' AND TargetID = F.FormID) ), #{DN_CODE}) AS Companysort 
		FROM covi_approval4j.jwf_forms AS F
		LEFT OUTER JOIN covi_approval4j.jwf_userforms AS UF ON F.FormID = UF.FormID AND UF.UserCode = #{userID}
		<if test="formPrefix != null and formPrefix != '' ">
				INNER JOIN covi_approval4j.jwf_formclass AS jfc on F.FormPrefix = #{formPrefix} and F.FormClassID = jfc.FormClassID
		</if>
		WHERE 
		<if test="formID != null and formID != '' ">
			F.FormID = #{formID}
		</if>
		<if test="formPrefix != null and formPrefix != '' ">
			F.FormPrefix = #{formPrefix}
				AND(
				( jfc.AclAllYN = 'Y' and jfc.EntCode IN ('ORGROOT',  #{DN_CODE}) )
				OR exists 
				(
					select 1 from covi_approval4j.jwf_forms_acl AS jfa 
					where jfa.TargetID = jfc.FormClassID and jfa.ObjectType = 'CLASS'
					and 
					(
						jfa.GroupType = 'Company' and jfa.CompanyCode = #{DN_CODE}
						or
						jfa.GroupType = 'Dept' and jfa.GroupCode  = #{GR_CODE}
					)
				)
			)
			AND 
			(
				(
					F.AclAllYN = 'Y'
					AND	F.CompanyCode IN ('ORGROOT',  #{DN_CODE})
				)
				OR exists 
				( 
					select 1 from covi_approval4j.jwf_forms_acl AS jfa 
					where jfa.TargetID = F.FormID and jfa.ObjectType = 'FORM'
					and 
					(
					jfa.GroupType = 'Company' and jfa.CompanyCode = #{DN_CODE}
					or
					jfa.GroupType = 'Dept' and jfa.GroupCode  = #{GR_CODE}
					)
				)
			)
		</if>
		ORDER BY CompanySort desc, Revision desc
		LIMIT 1 ;
	</select>
	
	<select id="selectPerformerData" parameterType="cmap" resultType="cmap">
	    SELECT WI.PerformerID FROM covi_approval4j.jwf_workitem AS WI
		INNER JOIN covi_approval4j.jwf_process AS P ON WI.ProcessID = P.ProcessID
		INNER JOIN covi_approval4j.jwf_performer AS PF ON WI.PerformerID = PF.PerformerID
		WHERE P.FormInstID = #{FormInstID}
		AND WI.UserCode IN (#{UserID}, #{DeptID})
		AND PF.State = '1'
		ORDER BY WI.Created DESC
		LIMIT 1;
	</select>
	
	<select id="selectPerformerDataArchive" parameterType="cmap" resultType="cmap">
	    SELECT WI.PerformerID FROM covi_approval4j.jwf_workitem AS WI
		INNER JOIN covi_approval4j.jwf_process AS P ON WI.ProcessID = P.ProcessID
		WHERE P.FormInstID = #{FormInstID}
		AND P.ProcessState = 528
		AND WI.UserCode IN (#{UserID}, #{DeptID})
		AND WI.Deleted IS NULL
		ORDER BY WI.Created DESC
		LIMIT 1;
	</select>
	
	<select id="selectPerformerDeputyData" parameterType="cmap" resultType="cmap">
	    SELECT WI.PerformerID FROM covi_approval4j.jwf_workitem AS WI
		INNER JOIN covi_approval4j.jwf_process AS P ON WI.ProcessID = P.ProcessID
		INNER JOIN covi_approval4j.jwf_performer AS PF ON WI.PerformerID = PF.PerformerID
		WHERE P.FormInstID = #{FormInstID}
		AND WI.DeputyID = #{UserID}
		AND PF.State = '1'
		ORDER BY WI.Created DESC
		LIMIT 1;
	</select>
	
	<select id="selectPerformerDeputyDataArchive" parameterType="cmap" resultType="cmap">
	    SELECT WI.PerformerID FROM covi_approval4j.jwf_workitem AS WI
		INNER JOIN covi_approval4j.jwf_process AS P ON WI.ProcessID = P.ProcessID
		WHERE P.FormInstID = #{FormInstID}
		AND P.ProcessState = 528
		AND WI.DeputyID = #{UserID}
		AND WI.Deleted IS NULL
		ORDER BY WI.Created DESC
		LIMIT 1;
	</select>
	
	<select id="selectJobFunctionData" parameterType="cmap" resultType="cmap">
	    SELECT WI.PerformerID FROM covi_approval4j.jwf_workitem AS WI
		JOIN covi_approval4j.jwf_jobfunction B ON WI.UserCode=B.JobFunctionCode AND B.EntCode = #{entCode}
		JOIN covi_approval4j.jwf_jobfunctionmember C ON B.JobFunctionID=C.JobFunctionID
		INNER JOIN covi_approval4j.jwf_process AS P ON WI.ProcessID = P.ProcessID
		INNER JOIN covi_approval4j.jwf_performer AS PF ON WI.PerformerID = PF.PerformerID
		WHERE P.FormInstID = #{FormInstID}
		AND C.UserCode = #{UserID}
		AND PF.State = '1'
		ORDER BY WI.Created DESC
		LIMIT 1;
	</select>
	
	<select id="selectJobFunctionDataArchive" parameterType="cmap" resultType="cmap">
	    SELECT WI.PerformerID FROM covi_approval4j.jwf_workitem AS WI
		JOIN covi_approval4j.jwf_jobfunction B ON WI.UserCode=B.JobFunctionCode AND B.EntCode = #{entCode}
		JOIN covi_approval4j.jwf_jobfunctionmember C ON B.JobFunctionID=C.JobFunctionID
		INNER JOIN covi_approval4j.jwf_process AS P ON WI.ProcessID = P.ProcessID
		WHERE P.FormInstID = #{FormInstID}
		AND P.ProcessState = 528
		AND C.UserCode = #{UserID}
		AND WI.Deleted IS NULL
		ORDER BY WI.Created DESC
		LIMIT 1;
	</select>
	
	<select id="selectDeptReceiveData" parameterType="cmap" resultType="cmap">
	    SELECT WI.PerformerID FROM covi_approval4j.jwf_workitem AS WI
		INNER JOIN covi_approval4j.jwf_process AS P ON WI.ProcessID = P.ProcessID
		INNER JOIN covi_approval4j.jwf_performer AS PF ON WI.PerformerID = PF.PerformerID
		WHERE P.FormInstID =#{FormInstID}
		AND WI.UserCode = #{DeptID}
		AND PF.State = '1'
		AND PF.SubKind IN ('R','C','AD','AS','AE') -- 2015.12 수정 합의함등도 추가 AND PF_SUB_KIND = 'R'
		ORDER BY WI.Created DESC
		LIMIT 1;
	</select>
	
	<select id="selectDeptReceiveDataArchive" parameterType="cmap" resultType="cmap">
	    SELECT * FROM covi_approval4j.jwf_workitem AS WI
		INNER JOIN covi_approval4j.jwf_process AS P ON WI.ProcessID = P.ProcessID
		WHERE P.FormInstID = #{FormInstID}
		AND P.ProcessState = 528
		AND WI.UserCode = #{DeptID}
		AND WI.Deleted IS NULL
		AND WI.SubKind = 'REQCMP'
		ORDER BY WI.Created DESC
		LIMIT 1;
	</select>
	
	<select id="selectFormPrefixData" parameterType="cmap" resultType="cmap">
	    SELECT F.FormPrefix FROM covi_approval4j.jwf_forminstance AS FI
		INNER JOIN covi_approval4j.jwf_forms AS F ON F.FormID = FI.FormID
		WHERE FormInstID = #{FormInstID}
		LIMIT 1
	</select>
	
	<select id="selectBizDocData" parameterType="cmap" resultType="cmap">
	    SELECT COUNT(*) AS CNT FROM covi_approval4j.jwf_bizdocform AS A
		JOIN covi_approval4j.jwf_bizdocmember B ON A.BizDocID = B.BizDocID
		WHERE A.FormPrefix = #{FormPreFix}
		AND B.UserCode = #{UserID};
	</select>
	
	<select id="selectTCInfoData" parameterType="cmap" resultType="cmap">
	    SELECT COUNT(*) AS CNT FROM covi_approval4j.jwf_circulationbox
		WHERE FormInstID = #{FormInstID}
		AND ReceiptID IN ( #{UserID}, #{DeptID});
	</select>
	
	<select id="selectAuditDocData" parameterType="cmap" resultType="cmap">
		SELECT MenuID, DomainCode FROM covi_smart4j.sys_object_acl AS A
		INNER JOIN covi_smart4j.sys_object_menu AS M ON (A.ObjectType = 'MN' AND A.ObjectID = M.MenuID)
		INNER JOIN covi_smart4j.sys_object_domain AS D ON M.DomainID = D.DomainID
		WHERE M.BizSection = 'Approval'
		AND M.Reserved1 = 'Audit'
 	</select>
 	
 	<select id="selectEntCode" parameterType="cmap" resultType="java.lang.String">
		<![CDATA[
			SELECT 
			EntCode
			FROM covi_approval4j.jwf_forminstance
			WHERE FormInstID = #{FormInstID};
		]]>
	</select>
	
	<select id="selectIsLinkedDocData" parameterType="cmap" resultType="cmap">
	  	SELECT COUNT(*) AS CNT FROM covi_approval4j.jwf_forminstance AS fi
		INNER JOIN covi_approval4j.jwf_process AS wp ON fi.FormInstID = wp.FormInstID
		INNER JOIN covi_approval4j.jwf_processdescription AS wpd ON wp.ProcessDescriptionID = wpd.ProcessDescriptionID
		WHERE 
		wp.ProcessID = #{OwnerProcessId} AND wpd.IsSecureDoc = 'N' AND
		(fi.DocLinks LIKE CONCAT(#{ProcessID}, '@@@%') OR fi.DocLinks LIKE CONCAT('%^^^',#{ProcessID},'@@@%'))
	</select>
	
	<select id="selectIsLinkedDocExpData" parameterType="cmap" resultType="cmap">
		SELECT COUNT(*) AS CNT FROM covi_account4j_si.act_expence_application_list AS actList
		INNER JOIN covi_account4j_si.act_expence_application_ref AS actRef ON actRef.ExpenceApplicationListID = actList.ExpenceApplicationListID
		INNER JOIN covi_approval4j.jwf_process AS wp ON actRef.ProcessID = wp.ProcessID
		INNER JOIN covi_approval4j.jwf_processdescription AS wpd ON wp.ProcessDescriptionID = wpd.ProcessDescriptionID
		WHERE 
		actList.ExpenceApplicationID =  #{ExpAppID} AND actRef.ProcessID = #{ProcessID} AND wpd.IsSecureDoc = 'N' 
	</select>
	
	<select id="selectIsDeletedDoc" parameterType="cmap" resultType="cmap">
	  	SELECT COUNT(*) AS CNT 
		FROM covi_approval4j.jwf_process
		WHERE ProcessID = #{processID}
		AND DeleteDate IS NOT NULL
	</select>
	
	<select id="selectManageTarget" parameterType="cmap" resultType="cmap">
		SELECT 'P' as TARGETTYPE, TARGETCODE, mem.ViewStartDate AS VIEWSTARTDATE, mem.ViewEndDate AS VIEWENDDATE
		FROM covi_approval4j.jwf_persondirector AS p
		INNER JOIN covi_approval4j.jwf_persondirectormember AS mem ON p.UserCode = mem.UserCode
		WHERE p.UserCode = #{UserID}
		AND (p.AuthEndDate IS NULL OR p.AuthEndDate = '00:00:00' or DATE(NOW()) BETWEEN p.AuthStartDate AND p.AuthEndDate)
		
		UNION
		
		SELECT 'P' as TARGETTYPE, jdmem.UnitCode AS TARGETCODE, jdmem.ViewStartDate AS VIEWSTARTDATE, jdmem.ViewEndDate AS VIEWENDDATE
		FROM covi_approval4j.jwf_director AS jd
		INNER JOIN covi_approval4j.jwf_directormember AS jdmem ON jd.UserCode = jdmem.UserCode
		WHERE jd.UserCode = #{UserID}
		AND (jd.AuthEndDate IS NULL OR jd.AuthEndDate = '00:00:00' or DATE(NOW()) BETWEEN jd.AuthStartDate AND jd.AuthEndDate)
		
		UNION
		
		SELECT 'U' as TARGETTYPE, TargetUnitCode as TARGETCODE, umem.ViewStartDate AS VIEWSTARTDATE, umem.ViewEndDate AS VIEWENDDATE
		FROM covi_approval4j.jwf_unitdirector AS unit
		INNER JOIN covi_approval4j.jwf_unitdirectormember AS umem ON unit.UnitCode = umem.UnitCode
		WHERE unit.UnitCode = #{DeptID}
		AND (unit.AuthEndDate IS NULL OR unit.AuthEndDate = '00:00:00' or DATE(NOW()) BETWEEN unit.AuthStartDate AND unit.AuthEndDate)
	</select> 
	 
	<select id="selectManageDocDataCnt" parameterType="cmap" resultType="int">
		SELECT COUNT(*) AS CNT FROM covi_approval4j.jwf_process AS wp
		INNER JOIN covi_approval4j.jwf_workitem AS ww ON wp.ProcessID = ww.ProcessID
		INNER JOIN covi_approval4j.jwf_performer AS wpf ON ww.WorkItemID = wpf.WorkitemID
		WHERE formInstID = #{FormInstID}
		AND ww.State = 528 AND wp.ProcessState = 528
		AND wpf.UserCode = #{TargetCode}
		AND 
		(
		((#{ViewStartDate} IS NULL OR #{ViewStartDate} = '' OR #{ViewStartDate} = '0000-00-00 00:00:00') AND (#{ViewEndDate} IS NULL OR #{ViewEndDate} = '' OR #{ViewEndDate} = '0000-00-00 00:00:00'))
		OR
		((#{ViewStartDate} IS NULL OR #{ViewStartDate} = '' OR #{ViewStartDate} = '0000-00-00 00:00:00') and wp.StartDate &lt;= TIMESTAMPADD(Day,1,STR_TO_DATE(#{ViewEndDate}, '%Y-%m-%d %H:%i:%s')))
		OR
		((#{ViewEndDate} IS NULL OR #{ViewEndDate} = '' OR #{ViewEndDate} = '0000-00-00 00:00:00') and wp.StartDate &gt;= STR_TO_DATE(#{ViewStartDate}, '%Y-%m-%d %H:%i:%s'))
		OR
		(wp.StartDate &lt;= TIMESTAMPADD(Day,1,STR_TO_DATE(#{ViewEndDate}, '%Y-%m-%d %H:%i:%s')) and wp.StartDate &gt;= STR_TO_DATE(#{ViewStartDate}, '%Y-%m-%d %H:%i:%s'))
		)
	</select> 
	
	<select id="selectManageDocTcInfoDataCnt" parameterType="cmap" resultType="int">
		SELECT COUNT(*) AS CNT FROM covi_approval4j.jwf_circulationbox
		WHERE FormInstID = #{FormInstID}
		AND ReceiptID  = #{TargetCode}
		AND 
		(
		((#{ViewStartDate} IS NULL OR #{ViewStartDate} = '' OR #{ViewStartDate} = '0000-00-00 00:00:00') AND (#{ViewEndDate} IS NULL OR #{ViewEndDate} = '' OR #{ViewEndDate} = '0000-00-00 00:00:00'))
		OR
		((#{ViewStartDate} IS NULL OR #{ViewStartDate} = '' OR #{ViewStartDate} = '0000-00-00 00:00:00') and ReceiptDate &lt;= TIMESTAMPADD(Day,1,STR_TO_DATE(#{ViewEndDate}, '%Y-%m-%d %H:%i:%s')))
		OR
		((#{ViewEndDate} IS NULL OR #{ViewEndDate} = '' OR #{ViewEndDate} = '0000-00-00 00:00:00') and ReceiptDate &gt;= STR_TO_DATE(#{ViewStartDate}, '%Y-%m-%d %H:%i:%s'))
		OR
		(ReceiptDate &lt;= TIMESTAMPADD(Day,1,STR_TO_DATE(#{ViewEndDate}, '%Y-%m-%d %H:%i:%s')) and ReceiptDate &gt;= STR_TO_DATE(#{ViewStartDate}, '%Y-%m-%d %H:%i:%s'))
		)
	</select>
	
	<select id="selectChargeJob" parameterType="cmap" resultType="cmap">
		SELECT ChargeJob
		FROM covi_account4j_si.act_expence_application
		WHERE ExpenceApplicationID = #{ExpAppID}
	</select>
</mapper>
