<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="user.resource">
    
    <!-- EVENT_ATTENDANT : 2022.03.15 자원예약 시 참석자 추가 될 경우 insert -->
    <insert id="insertResEventAttendant" parameterType="cmap">
        INSERT INTO covi_smart4j.EVENT_ATTENDANT
        (	EventID
		  , AttenderCode
		  , MultiAttenderName
		  , IsOutsider
		  , IsAllow) 
 	VALUES (   #{EventID}				<!-- EVENT의 ID -->
		  , #{AttenderCode}			<!--  참석자 코드 -->
		  , #{MultiAttenderName}	<!--  참석자 명 (다국어값) -->
		  , #{IsOutsider}			<!--  외부참석자 여부 -->
		  , #{IsAllow}				<!--  '' -->
		)
    </insert>

	<!-- Attendant 테이블 데이터 삭제 -->
    <delete id="deleteEventAttendant" parameterType="cmap">
        DELETE FROM covi_smart4j.EVENT_ATTENDANT
         WHERE EventID = #{EventID}
    </delete>
    
    <!-- 삭제된 참석자가 개인일정으로 별도 등록했을 경우 삭제 -->
    <delete id="deleteEventByAttendeeData">
        DELETE FROM covi_smart4j.EVENT
         WHERE LinkEventID = #{EventID}
           AND EventType = 'A'
        <if test="AttenderCode != null and AttenderCode != '' ">
           AND OwnerCode = #{AttenderCode}
        </if>
    </delete>
  
  	<!-- EVENT_ATTENDANT -->
    <insert id="insertEventAttendant" parameterType="cmap">
        INSERT INTO covi_smart4j.EVENT_ATTENDANT
		(   EventID
		  , AttenderCode
		  , MultiAttenderName
		  , IsOutsider
		  , IsAllow
		) VALUES (
			#{EventID}					# EVENT의 ID
			, #{AttenderCode}			# 참석자 코드
			, #{MultiAttenderName}	# 참석자 명 (다국어값)
			, #{IsOutsider}			# 외부참석자 여부
			, #{IsAllow}				# ''
		);
    </insert>
 	<!-- Resource Event selectResEventAttendant 조회 -->
    <select id="selectResEventAttendant" parameterType="cmap" resultType="cmap">
       	SELECT   AttenderCode AS UserCode
        	   , Fn_BaseGetDictionary_S(#{lang}, MultiAttenderName) AS UserName
        	   , DeptCode
        	   , Fn_BaseGetDictionary_S(#{lang}, MultiDeptName) AS DeptName
        	   , IsOutsider
        	   , IsAllow
          FROM   covi_smart4j.EVENT_ATTENDANT AS EA
     LEFT JOIN   covi_smart4j.SYS_OBJECT_USER_BASEGROUP AS BG 
     		ON 	 EA.AttenderCode = BG.UserCode AND BG.JobType = 'Origin'
         WHERE   EventID = #{EventID};
    </select>
    
    <select id="selectACLData" parameterType="cmap" resultType="cmap">
        <if test="S_FolderIDs != ''  or  C_FolderIDs != ''  or D_FolderIDs != ''  or M_FolderIDs != ''  or E_FolderIDs != ''  or R_FolderIDs != '' ">
	        SELECT `type`
	        	, FolderID
				, FolderType
				, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) AS MultiDisplayName
			FROM (
			<trim prefixOverrides="UNION ALL">
				<if test="S_FolderIDs != null and S_FolderIDs != '' ">
					SELECT
						'S' as `type`
				      , FD.*
					FROM covi_smart4j.SYS_OBJECT_FOLDER AS FD
					WHERE 1=1
					<if test='S_FolderIDArr != null and S_FolderIDArr.length != 0'>
						AND FolderID IN  
						<foreach collection="S_FolderIDArr" item="item" open="(" close=")" separator=",">
							#{item}
						</foreach>
					</if>
					AND	ObjectType = 'Resource'
					AND DeleteDate IS NULL
					AND IsUse = 'Y' 
	  				AND IsDisplay = 'Y'
				</if>
				<if test="C_FolderIDs != null and C_FolderIDs != '' ">
					UNION ALL
					
					SELECT
						'C' as `type`
				      , FD.*
					FROM covi_smart4j.SYS_OBJECT_FOLDER AS FD
					WHERE 1=1
					<if test='C_FolderIDArr != null and C_FolderIDArr.length != 0'>
						AND FolderID IN  
						<foreach collection="C_FolderIDArr" item="item" open="(" close=")" separator=",">
							#{item}
						</foreach>
					</if>
					AND	ObjectType = 'Resource'
					AND DeleteDate IS NULL
					AND IsUse = 'Y' 
	  				AND IsDisplay = 'Y'
				</if>
				<if test="D_FolderIDs != null and D_FolderIDs != '' ">
					UNION ALL
					
					SELECT
						'D' as `type`
				      , FD.*
					FROM covi_smart4j.SYS_OBJECT_FOLDER AS FD
					WHERE 1=1
					<if test='D_FolderIDArr != null and D_FolderIDArr.length != 0'>
						AND FolderID IN  
						<foreach collection="D_FolderIDArr" item="item" open="(" close=")" separator=",">
							#{item}
						</foreach>
					</if>
					AND	ObjectType = 'Resource'
					AND DeleteDate IS NULL
					AND IsUse = 'Y' 
	  				AND IsDisplay = 'Y'
				</if>
				<if test="M_FolderIDs != null and M_FolderIDs != '' ">
					UNION ALL
					
					SELECT
						'M' as `type`
				      , FD.*
					FROM covi_smart4j.SYS_OBJECT_FOLDER AS FD
					WHERE 1=1
					<if test='M_FolderIDArr != null and M_FolderIDArr.length != 0'>
						AND FolderID IN  
						<foreach collection="M_FolderIDArr" item="item" open="(" close=")" separator=",">
							#{item}
						</foreach>
					</if>
					AND	ObjectType = 'Resource'
					AND DeleteDate IS NULL
					AND IsUse = 'Y' 
	  				AND IsDisplay = 'Y'
				</if> 
				<if test="E_FolderIDs != null and E_FolderIDs != '' ">
					UNION ALL
					
					SELECT
						'E' as `type`
				      , FD.*
					FROM covi_smart4j.SYS_OBJECT_FOLDER AS FD
					WHERE 1=1
					<if test='E_FolderIDArr != null and E_FolderIDArr.length != 0'>
						AND FolderID IN  
						<foreach collection="E_FolderIDArr" item="item" open="(" close=")" separator=",">
							#{item}
						</foreach>
					</if>
					AND	ObjectType = 'Resource'
					AND DeleteDate IS NULL
					AND IsUse = 'Y' 
	  				AND IsDisplay = 'Y'
				</if>
				<if test="V_FolderIDs != null and V_FolderIDs != '' ">
					UNION ALL
					
					SELECT
						'V' as `type`
				      , FD.*
					FROM covi_smart4j.SYS_OBJECT_FOLDER AS FD
					WHERE 1=1
					<if test='V_FolderIDArr != null and V_FolderIDArr.length != 0'>
						AND FolderID IN  
						<foreach collection="V_FolderIDArr" item="item" open="(" close=")" separator=",">
							#{item}
						</foreach>
					</if>
					AND	ObjectType = 'Resource'
					AND DeleteDate IS NULL
					AND IsUse = 'Y' 
	  				AND IsDisplay = 'Y'
				</if>
				<if test="R_FolderIDs != null and R_FolderIDs != '' ">
					UNION ALL
					
					SELECT
						'R' as `type`
				      , FD.*
					FROM covi_smart4j.SYS_OBJECT_FOLDER AS FD
					WHERE 1=1
					<if test='R_FolderIDArr != null and R_FolderIDArr.length != 0'>
						AND FolderID IN  
						<foreach collection="R_FolderIDArr" item="item" open="(" close=")" separator=",">
							#{item}
						</foreach>
					</if>
					AND	ObjectType = 'Resource'
					AND DeleteDate IS NULL
					AND IsUse = 'Y' 
	  				AND IsDisplay = 'Y'
				</if>
			</trim>
			) A
			ORDER BY SortPath;
		</if>
    </select>
    
    <!--예약 정보 조회 (목록형)  -->
    <select id="selectBookingList" parameterType="cmap" resultType="cmap">
    	/* queryID : user.resource.selectBookingList */
			<![CDATA[
					 SELECT a.EventID
							  ,b.DateID
							  ,CASE WHEN a.FolderType LIKE 'Schedule%' AND d.ResourceID IS NOT NULL THEN c.ResourceID
							  		ELSE a.FolderID END AS FolderID
							  ,e.FolderType
							  ,c.ResourceID
							  ,b.RepeatID
							  , (CASE WHEN (e.DomainID != #{domainID}) THEN CONCAT('[',Fn_GetSelDictionary(#{lang}, 'lbl_sharing', 0),'] ', Fn_BaseGetDictionary_S(#{lang},e.MultiDisplayName))
								ELSE  Fn_BaseGetDictionary_S(#{lang},e.MultiDisplayName)
								END ) AS ResourceName
							  ,a.Subject
							  ,b.StartDateTime
							  , DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i') AS EndDateTime
							  ,b.IsRepeat
							  ,IF(f.ReturnType = 'AutoReturn' AND b.EndDateTime < #{localCurrentDate} AND c.ApprovalState = 'Approval', 'ReturnComplete' , c.ApprovalState)  AS ApprovalState
							  ,IF(f.ReturnType = 'AutoReturn' AND b.EndDateTime < #{localCurrentDate} AND c.ApprovalState = 'Approval', 'ReturnComplete' , c.ApprovalState)  AS ApprovalStateCode
							  ,f.BookingType
							  ,f.ReturnType
							  ,f.ReturnType AS ReturnTypeCode
							  ,a.RegisterCode
							  ,Fn_BaseGetDictionary_S(#{lang},a.MultiRegisterName) AS RegisterName
							  ,a.RegistDate
					  FROM covi_smart4j.event AS a 
					  INNER JOIN covi_smart4j.event_date AS b ON a.EventID = b.EventID
					  LEFT JOIN covi_smart4j.event_resource_booking AS c ON b.DateID = c.DateID
					  LEFT JOIN covi_smart4j.event_relation AS d ON c.ResourceID = d.ResourceID AND a.EventID = d.ScheduleID 
					  INNER JOIN covi_smart4j.sys_object_folder AS e ON c.ResourceID = e.FolderID
					  LEFT JOIN covi_smart4j.resource AS f ON f.FolderID = Fn_ResourceParentIDGet_S(IFNULL(e.LinkFolderID,e.FolderID))
					  WHERE ( (a.FolderType LIKE 'Resource%') OR (a.FolderType LIKE 'Schedule%' AND d.ResourceID IS NOT NULL) )
					  AND a.DeleteDate IS NULL
					  AND c.DeleteDate IS NULL
					  AND e.DeleteDate IS NULL
			]]>
		   <if test="Subject != null and Subject !='' ">
				AND a.Subject LIKE CONCAT('%',#{Subject},'%')
			</if>
			<if test="RegisterName !=null and RegisterName !='' ">
				 AND  Fn_BaseGetDictionary_S(#{lang},a.MultiRegisterName) LIKE CONCAT('%',#{RegisterName},'%')
			</if>
			<if test="StartDate != null and StartDate != '' and EndDate != null and EndDate != '' ">
			    <choose>
				    <when test="searchDateType == 'RegistDate'">
				      AND a.RegistDate BETWEEN #{StartDate} AND #{EndDate}
				    </when>
				    <when test="searchDateType == 'BookingDate' " >
				     AND  (StartDateTime BETWEEN concat(#{StartDate},' 00:00:00') AND concat(#{EndDate},' 23:59:59') 
				     	OR  c.RealEndDateTime BETWEEN str_to_date(concat(#{StartDate},' 00:00:00'),'%Y-%m-%d %H:%i:%s') AND str_to_date(concat(#{EndDate},' 23:59:59'),'%Y-%m-%d %H:%i:%s')   )
				    </when>
			    </choose>
		  	</if>
		  	<if test="userID != null and userID !='' and userID.length() gt 0">
		  	     AND a.RegisterCode = #{userID}
		  	</if>
		  	<choose>
		  		<when test='isGetShared != null and isGetShared.equalsIgnoreCase("Y")'>
		  			<if test="linkFolderIDs != null and linkFolderIDs.length != 0">
		  		AND c.ResourceID  in
		  				<foreach collection="linkFolderIDs" item="item" index="index" separator="," open="(" close=")">
		  					#{item}
		  				</foreach>
		  			</if>
		  		</when>
		  		<otherwise>
		  			<if test="FolderIDs != null and FolderIDs.length != 0">
		  		AND c.ResourceID  in
		  				<foreach collection="FolderIDs" item="item" index="index" separator="," open="(" close=")">
		  					#{item}
		  				</foreach>
		  			</if>
		  			<if test="domainID != null and domainID !=''">
		  		AND ( e.DomainID = #{domainID} OR e.DomainID = 0)
		  			</if>
		  		</otherwise>
		  	</choose>
		  	<if test="arrApprovalState != null and arrApprovalState != '' ">
		  	    <![CDATA[  AND IF(f.ReturnType = 'AutoReturn' AND b.EndDateTime < #{localCurrentDate} AND c.ApprovalState = 'Approval', 'ReturnComplete' , c.ApprovalState)  IN ]]>
		  	     <foreach item="item" index="index" collection="arrApprovalState" open="(" close=")" separator=",">
		            #{item}
		    	</foreach>
		  	</if>
		  	<if test="SearchText != null and SearchText != ''">
		  	    AND (
					a.Subject LIKE CONCAT('%',#{SearchText},'%') OR <!-- 용도 -->
					a.MultiRegisterName LIKE CONCAT('%',#{SearchText},'%') OR <!-- 등록자 -->
					e.DisplayName LIKE CONCAT('%',#{SearchText},'%') <!-- 자원명 -->
				)
		  	</if>
		  	<!-- <if test="approvalState != null and approvalState !='' and approvalState.length() gt 0">
		  	    AND c.ApprovalState =#{approvalState}
		  	</if> -->
		    <!-- Order by 절 -->
		    <trim prefix="ORDER BY"  prefixOverrides =",">
				<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
					StartDateTime DESC
				</if>
				<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
					<choose>
						<when test='sortColumn.equalsIgnoreCase("StartDateTime")'>StartDateTime</when>
						<when test='sortColumn.equalsIgnoreCase("EndDateTime")'>EndDateTime</when>
						<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
						<when test='sortColumn.equalsIgnoreCase("ResourceName")'>ResourceName</when>
						<when test='sortColumn.equalsIgnoreCase("ApprovalStateCode")'>ApprovalStateCode</when>
						<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
						<otherwise>RegistDate</otherwise>
					</choose>
					<choose>
						<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
						<otherwise> DESC</otherwise>
					</choose>
				</if>
			</trim>
		    <if test="pageSize != null and pageOffset != null ">
		   		LIMIT #{pageSize} OFFSET #{pageOffset}
		   	</if>
	</select>
	
    
     <select id="selectBookingListCnt" parameterType="cmap" resultType="java.lang.Long">
     	/* queryID : user.resource.selectBookingListCnt */
			<![CDATA[
					  SELECT COUNT(*)
					  FROM covi_smart4j.event AS a 
					  INNER JOIN covi_smart4j.event_date AS b ON a.EventID = b.EventID
					  LEFT JOIN covi_smart4j.event_resource_booking AS c ON b.DateID = c.DateID
					  LEFT JOIN covi_smart4j.event_relation AS d ON c.ResourceID = d.ResourceID AND a.EventID = d.ScheduleID 
					  INNER JOIN covi_smart4j.sys_object_folder AS e ON c.ResourceID = e.FolderID
					  LEFT JOIN covi_smart4j.resource AS f ON f.FolderID = Fn_ResourceParentIDGet_S(IFNULL(e.LinkFolderID,e.FolderID))
					  WHERE ( (a.FolderType LIKE 'Resource%') OR (a.FolderType LIKE 'Schedule%' AND d.ResourceID IS NOT NULL) )
		 			  AND a.DeleteDate IS NULL
		 			  AND c.DeleteDate IS NULL
		 			  AND e.DeleteDate IS NULL
			]]>
			<if test="Subject != null and Subject !='' ">
				AND a.Subject LIKE CONCAT('%',#{Subject},'%')
			</if>
			<if test="RegisterName !=null and RegisterName !='' ">
				 AND  Fn_BaseGetDictionary_S(#{lang},a.MultiRegisterName) LIKE CONCAT('%',#{RegisterName},'%')
			</if>
			<if test="StartDate != null and StartDate != '' and EndDate != null and EndDate != '' ">
			    <choose>
				    <when test="searchDateType == 'RegistDate'">
				      AND a.RegistDate BETWEEN #{StartDate} AND #{EndDate}
				    </when>
				    <when test="searchDateType == 'BookingDate' " >
				     AND  (StartDateTime BETWEEN concat(#{StartDate},' 00:00:00') AND concat(#{EndDate},' 23:59:59') 
				     	OR  c.RealEndDateTime BETWEEN str_to_date(concat(#{StartDate},' 00:00:00'),'%Y-%m-%d %H:%i:%s') AND str_to_date(concat(#{EndDate},' 23:59:59'),'%Y-%m-%d %H:%i:%s')   )
				    </when>
			    </choose>
		  	</if>
		  	<if test="userID != null and userID !='' and userID.length() gt 0">
		  	     AND a.RegisterCode = #{userID}
		  	</if>
			<choose>
				<when test='isGetShared != null and isGetShared.equalsIgnoreCase("Y")'>
					<if test="linkFolderIDs != null and linkFolderIDs.length != 0">
				AND c.ResourceID  in
						<foreach collection="linkFolderIDs" item="item" index="index" separator="," open="(" close=")">
							#{item}
						</foreach>
					</if>
				</when>
				<otherwise>
					<if test="FolderIDs != null and FolderIDs.length != 0">
				AND c.ResourceID  in
						<foreach collection="FolderIDs" item="item" index="index" separator="," open="(" close=")">
							#{item}
						</foreach>
					</if>
					<if test="domainID != null and domainID !=''">
				AND ( e.DomainID = #{domainID} OR e.DomainID = 0)
					</if>
				</otherwise>
			</choose>
		  	<if test="arrApprovalState != null and arrApprovalState != '' ">
		  	    <![CDATA[  AND IF(f.ReturnType = 'AutoReturn' AND b.EndDateTime < #{localCurrentDate} AND c.ApprovalState = 'Approval', 'ReturnComplete' , c.ApprovalState)  IN ]]>
		  	     <foreach item="item" index="index" collection="arrApprovalState" open="(" close=")" separator=",">
		            #{item}
		    	</foreach>
		  	</if>
		  	<if test="SearchText != null and SearchText != ''">
		  	    AND (
					a.Subject LIKE CONCAT('%',#{SearchText},'%') OR <!-- 용도 -->
					a.MultiRegisterName LIKE CONCAT('%',#{SearchText},'%') OR <!-- 등록자 -->
					e.DisplayName LIKE CONCAT('%',#{SearchText},'%') <!-- 자원명 -->
				)
		  	</if>
	</select>
	
     
    <!--예약 정보 조회 (일간/주간/월간) -->
    <!-- 향후 주간과 일간 쿼리가 차이가 없을 경우 하나로 통일 => 통일 -->
    <select id="selectBookingPeriodList" parameterType="cmap" resultType="cmap">
        /* queryID : user.resource.selectBookingPeriodList */
	        SELECT a.EventID
						  ,b.DateID
						  ,CASE WHEN a.FolderType LIKE 'Schedule%' AND d.ResourceID IS NOT NULL THEN c.ResourceID
						  		ELSE a.FolderID END AS FolderID
						  ,c.ResourceID     # type이 Schedule인 경우를 위해 FolderID를 event_resource_booking 에서 조회
						  <if test="FolderIDs != null and FolderIDs.length != 0">
						  , IFNULL(	CASE
						  		<foreach collection="FolderIDs" item="item" index="index" separator="" open="" close="">
						  			WHEN (e.DomainID = #{DomainID} AND e.FolderID = #{item} ) THEN e.FolderID
						  		</foreach>
						  		END
						  		,
						  		<choose>
						  			<when test='DomainID.equals("0")'>
						  		e.LinkFolderID
						  			</when>
						  			<otherwise>
						  		(SELECT MIN(FolderID) FROM sys_object_folder WHERE DomainID = #{DomainID} AND e.FolderID = LinkFolderID AND IsUse = 'Y' AND IsDisplay = 'Y')
						  			</otherwise>
						  		</choose>
						  	) AS IntegratedID
						  </if>
						  , (CASE WHEN (e.LinkFolderID IS NOT NULL AND e.IsShared = 'N') THEN CONCAT('[',Fn_GetSelDictionary(#{lang}, 'lbl_sharing', 0),'] ',Fn_BaseGetDictionary_S(#{lang},e.MultiDisplayName))
								WHEN (e.IsShared = 'Y') THEN CONCAT('[',Fn_GetSelDictionary(#{lang}, 'lbl_sharing', 0),'] ',Fn_BaseGetDictionary_S(#{lang},e.MultiDisplayName))
								ELSE Fn_BaseGetDictionary_S(#{lang},e.MultiDisplayName)
								END
							) AS FolderName
						  ,b.RepeatID
	 					  ,b.IsRepeat
						  ,a.Subject
						  ,b.StartDate
						  ,b.StartTime
						  ,DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d') AS EndDate
						  ,DATE_FORMAT(c.RealEndDateTime,'%H:%i') AS EndTime
						  ,DATE_FORMAT(b.StartDateTime,'%Y-%m-%d %H:%i') AS StartDateTime
						  ,DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i') AS EndDateTime
						  ,IF(f.ReturnType = 'AutoReturn' AND b.EndDateTime <![CDATA[<]]> #{localCurrentDate} AND c.ApprovalState = 'Approval', 'ReturnComplete' , c.ApprovalState)  AS ApprovalState
						  ,a.RegisterCode
						  ,Fn_BaseGetDictionary_S(#{lang},a.MultiRegisterName) AS RegisterName
				  FROM covi_smart4j.event AS a 
				  INNER JOIN covi_smart4j.event_date AS b ON a.EventID = b.EventID
				  LEFT JOIN covi_smart4j.event_resource_booking AS c ON b.DateID = c.DateID
				  LEFT JOIN covi_smart4j.event_relation AS d ON c.ResourceID = d.ResourceID AND a.EventID = d.ScheduleID 
				  INNER JOIN covi_smart4j.sys_object_folder AS e ON c.ResourceID = e.FolderID
				  LEFT JOIN covi_smart4j.resource AS f ON f.FolderID = Fn_ResourceParentIDGet_S(IFNULL(e.LinkFolderID,e.FolderID))
				  WHERE ( (a.FolderType LIKE 'Resource%') OR (a.FolderType LIKE 'Schedule%' AND d.ResourceID IS NOT NULL) )
		  		  AND a.DeleteDate IS NULL
		  		  AND c.DeleteDate IS NULL
		  		  AND e.DeleteDate IS NULL
				  AND c.ApprovalState IN ('ApprovalRequest', 'Approval', 'ReturnRequest', 'ReturnComplete')
			<choose>
				<when test='isGetShared != null and isGetShared.equalsIgnoreCase("Y")'>
					<if test="linkFolderIDs != null and linkFolderIDs.length != 0">
				AND c.ResourceID  in
						<foreach collection="linkFolderIDs" item="item" index="index" separator="," open="(" close=")">
							#{item}
						</foreach>
					</if>
				</when>
				<otherwise>
					<if test="FolderIDs != null and FolderIDs.length != 0">
						AND c.ResourceID  in
						<foreach collection="FolderIDs" item="item" index="index" separator="," open="(" close=")">
							#{item}
						</foreach>
					</if>
				</otherwise>
			</choose>
			<if test="StartDate != null and StartDate != '' and EndDate != null and EndDate != '' ">
			  	   <![CDATA[
					AND ( 	(#{StartDate} <= b.StartDateTime AND DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDate}) OR 
				  	   	(#{StartDate} < b.StartDateTime  AND b.StartDateTime < #{EndDate} AND #{EndDate} <= DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i')) OR
				  	   	(b.StartDateTime <= #{StartDate} AND #{StartDate} < DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i') AND DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDate}) OR 
				  	   	(b.StartDateTime <= #{StartDate} AND #{EndDate} <= DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i'))    )
			  	  ]]>
		  	</if>
		  	ORDER BY StartDateTime ASC
	</select>
     
	 <select id="selectBookingData" parameterType="cmap" resultType="cmap">
	 	/* queryId : user.resource.selectBookingData */
			<![CDATA[
					SELECT a.EventID
							  ,b.DateID
							  ,a.FolderID
							  ,a.FolderType
							  ,Fn_BaseGetDictionary_S(#{lang}, FD.MultiDisplayName) AS ResourceName
							  ,c.ResourceID
							  ,b.RepeatID
							  ,b.IsRepeat
							  ,b.IsAllDay
							  ,a.Subject
							  ,a.Description
							  ,b.StartDateTime
							  ,DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i') AS EndDateTime
							  ,IF(R.ReturnType = 'AutoReturn' AND b.EndDateTime < #{localCurrentDate} AND c.ApprovalState = 'Approval', 'ReturnComplete' , c.ApprovalState)  AS ApprovalState
							  ,IF(R.ReturnType = 'AutoReturn' AND b.EndDateTime < #{localCurrentDate} AND c.ApprovalState = 'Approval', 'ReturnComplete' , c.ApprovalState)  AS ApprovalStateCode
							  ,R.BookingType
							  ,R.BookingType AS BookingTypeCode
							  ,R.ReturnType
							  ,a.RegisterCode
							  ,UR.PhotoPath AS RegisterPhoto
							  ,a.OwnerCode
							  ,Fn_BaseGetDictionary_S(#{lang},a.MultiRegisterName) AS RegisterName
							  ,IF(a.FolderType LIKE 'Resource%','',a.EventID) AS LinkScheduleID
							  , Fn_BaseGetDictionary_S(#{lang}, UG.MultiJobPositionName) AS UserPositionName
							  , Fn_BaseGetDictionary_S(#{lang}, UG.MultiDeptName) AS UserDeptName
							  , Fn_BaseGetDictionary_S(#{lang}, UG.MultiJobLevelName) AS UserLevelName
							  , Fn_BaseGetDictionary_S(#{lang}, UG.MultiJobTitleName) AS UserTitleName
					FROM covi_smart4j.event AS a 
					INNER JOIN covi_smart4j.event_date AS b ON a.EventID = b.EventID
					LEFT JOIN covi_smart4j.event_resource_booking AS c ON b.DateID = c.DateID
					LEFT JOIN covi_smart4j.event_relation AS d ON c.ResourceID = d.ResourceID AND a.EventID = d.ScheduleID 
					LEFT JOIN covi_smart4j.sys_object_folder AS FD ON FD.FolderID = c.ResourceID
					LEFT JOIN covi_smart4j.resource AS R ON Fn_ResourceParentIDGet_S(FD.FolderID) = R.FolderID
					LEFT JOIN covi_smart4j.sys_object_user_basegroup AS UG ON a.RegisterCode = UG.UserCode AND UG.JobType = 'Origin'
					LEFT JOIN covi_smart4j.sys_object_user AS UR ON a.RegisterCode = UR.UserCode
					WHERE ( (a.FolderType LIKE 'Resource%') OR (a.FolderType LIKE 'Schedule%' AND d.ResourceID IS NOT NULL) )
			]]>
			
			<!-- 1개 예약 정보 조회   -->
			<if test="FolderIDArr == null or FolderIDArr.size == 0">
				<if test="FolderID != null and FolderID != '' ">
			    AND c.ResourceID = #{FolderID}
				</if>
			</if>
			<if test="EventID != null and EventID !='' ">
			    AND a.EventID = #{EventID}
			</if>
			<if test="RepeatID != null and RepeatID !='' ">
			    AND b.RepeatID = #{RepeatID}
			</if>
			<if test="DateID != null and DateID !='' ">
			    AND b.DateID = #{DateID}
			</if>
			
			<!-- N개의 예약정보 조회 (N > 1)  -->
			<if test="FolderIDArr != null and FolderIDArr.size != 0">
		  		AND c.ResourceID IN 
		        <foreach item="folderID" index="index" collection="FolderIDArr" open="(" close=")" separator=",">
		            #{folderID}
		       	</foreach>
			</if>
			<if test="EventIDArr != null and EventIDArr.size != 0">
		  		AND a.EventID IN 
		        <foreach item="eventID" index="index" collection="EventIDArr" open="(" close=")" separator=",">
		            #{eventID}
		       	</foreach>
			</if>
			<if test="RepeatIDArr != null and RepeatIDArr.size != 0">
		  		AND b.RepeatID IN 
		        <foreach item="repeatID" index="index" collection="RepeatIDArr" open="(" close=")" separator=",">
		            #{repeatID}
		       	</foreach>
			</if>
			<if test="DateIDArr != null and DateIDArr.size != 0">
		  		AND b.DateID IN 
		        <foreach item="dateID" index="index" collection="DateIDArr" open="(" close=")" separator=",">
		            #{dateID}
		       	</foreach>
			</if>
			
	</select>
    

    <select id="selectFolderData" parameterType="cmap" resultType="cmap">
			<![CDATA[
					SELECT a.FolderID
							, Fn_BaseGetDictionary_S(#{lang},a.MultiDisplayName) AS ResourceName
							, Fn_BaseGetDictionary_S(#{lang},b.MultiDisplayName)  AS ParentFolderName
							, a.Reserved1 AS PlaceOfBusiness
							, a.Description
							, a.Reserved3 AS ResourceImage
					FROM sys_object_folder AS a 
					INNER JOIN sys_object_folder AS b ON a.MemberOf = b.FolderID 
					WHERE a.FolderID = #{FolderID}
			]]>
	</select>
	
	<select id="selectEquipmentList" parameterType="cmap" resultType="cmap">
			<![CDATA[
					SELECT a.EquipmentID
								,Fn_BaseGetDictionary_S(#{lang},b.MultiEquipmentName) AS EquipmentName
								,b.IconPath
					FROM resource_equipment_def AS a 
					INNER JOIN resource_equipment AS b ON a.EquipmentID = b.EquipmentID
					WHERE b.IsUse = 'Y' AND a.FolderID = Fn_ResourceParentIDGet_S(#{FolderID});
			]]>
	</select>
    
    <select id="selectAttributeList" parameterType="cmap" resultType="cmap">
			<![CDATA[
				SELECT a.AttributeID
						, Fn_BaseGetDictionary_S(#{lang},a.MultiAttributeName) AS AttributeName
						, Fn_BaseGetDictionary_S(#{lang},a.MultiAttributeValue)  AS AttributeValue
				FROM resource_attribute AS a 
				WHERE FolderID = Fn_ResourceParentIDGet_S(#{FolderID})
				ORDER BY a.SortKey ASC
			]]>
	</select>

    <select id="selectManagerCodes" parameterType="cmap" resultType="java.lang.String">
			SELECT GROUP_CONCAT(a.SubjectCode SEPARATOR ';')
			FROM covi_smart4j.sys_object_acl  a
			WHERE A.ObjectType =#{ObjectType} AND A.ObjectID = Fn_ResourceParentIDGet_S(#{FolderID}) AND A.SubjectType = 'RM' 
	</select>    

    <select id="selectManagerList" parameterType="cmap" resultType="cmap">
			<![CDATA[
				SELECT
					A.AclID
					, A.ObjectID
					, A.ObjectType
					, A.SubjectCode
					, Fn_BaseGetDictionary_S(#{lang},U.MultiDisplayName) AS SubjectName
					,'User' AS UserType
					, Fn_BaseGetDictionary_S(#{lang}, UG.MultiJobPositionName) AS UserPositionName
					, Fn_BaseGetDictionary_S(#{lang}, UG.MultiDeptName) AS UserDeptName
					, U.PhotoPath
				FROM covi_smart4j.sys_object_acl A 
				INNER JOIN covi_smart4j.sys_object_user U ON A.SubjectCode = U.UserCode
				INNER JOIN covi_smart4j.sys_object_user_basegroup AS UG ON U.UserCode = UG.UserCode AND UG.JobType = 'Origin'
				WHERE A.ObjectType =#{ObjectType} AND A.ObjectID = Fn_ResourceParentIDGet_S(#{FolderID}) AND A.SubjectType = 'RM' 
				
				UNION
				
				SELECT 
					A.AclID
					, A.ObjectID
					, A.ObjectType
					, A.SubjectCode
					, Fn_BaseGetDictionary_S(#{lang}, G.MultiDisplayName) AS SubjectName
					, 'Group' AS UserType
					, '' AS UserPositionName
					, '' AS UserDeptName
					, ''  AS PhotoPath
				FROM covi_smart4j.sys_object_acl A 
				INNER JOIN covi_smart4j.sys_object_group G ON A.SubjectCode = G.GroupCode
				WHERE A.ObjectType = #{ObjectType} AND A.ObjectID = Fn_ResourceParentIDGet_S(#{FolderID}) AND A.SubjectType = 'RM'
			]]>
	</select>
	
    
    <!--목록의 표시할 자원 정보 조회   -->
    <!-- a.SecurityLevel >= (SELECT SecurityLevel FROM sys_object_user WHERE UserCode = #{userID} LIMIT 1)  트리 목록에서 제거 되므로 where 추가 X-->
     <select id="selectResourceListData" parameterType="cmap" resultType="cmap">
     	/* queryID : user.resource.selectResourceListData */
			<![CDATA[
				SELECT a.FolderID
				, ( CASE WHEN (a.LinkFolderID IS NOT NULL AND a.IsShared = 'N') 
						THEN CONCAT('[',Fn_GetSelDictionary(#{lang},'lbl_sharing',0) ,'] ',Fn_BaseGetDictionary_S(#{lang},a.MultiDisplayName))
						WHEN a.IsShared = 'Y'
						THEN CONCAT('[',Fn_GetSelDictionary(#{lang},'lbl_sharing',0) ,'] ',Fn_BaseGetDictionary_S(#{lang},a.MultiDisplayName))
					ELSE Fn_BaseGetDictionary_S(#{lang},a.MultiDisplayName)
					END
					) AS DisplayName 
				, a.FolderType
				, IFNULL(b.LeastPartRentalTime, 0) AS LeastPartRentalTime
				, b.BookingType
				, COVI_SMART4J.FN_FOLDERPATHBYLANGGET_S(#{lang}, a.MemberOf) AS ParentFolderName
				FROM covi_smart4j.sys_object_folder AS a
				LEFT JOIN resource AS b ON b.FolderID = Fn_ResourceParentIDGet_S(a.FolderID)
			]]>
			<if test="FolderIDs != null and FolderIDs.length != 0">
				WHERE a.FolderID  in 
	        	<foreach collection="FolderIDs" item="item" index="index" separator="," open="(" close=")">
	                    #{item}
	            </foreach>
			    AND a.DeleteDate IS NULL
			</if>                
		  	ORDER BY a.SortPath ASC
	</select>
 
    <select id="selectUserDefValueList"  parameterType="cmap" resultType="cmap">
			<![CDATA[
					SELECT
						v.UserFormID
						, v.FieldValue
						, IFNULL(Fn_BaseGetDictionary_S(#{lang}, uo.MultiOptionName), v.FieldValue) AS FieldText
						, uf.SortKey
						, Fn_BaseGetDictionary_S(#{lang}, uf.MultiFieldName) AS FieldName
						, uf.FieldType
					FROM resource_userform_value AS v
					INNER JOIN covi_smart4j.resource_userform AS uf ON v.UserFormID = uf.UserFormID
					LEFT JOIN covi_smart4j.resource_userform_option AS uo ON v.FieldValue = uo.OptionValue AND uf.UserFormID = uo.UserFormID
					WHERE EventID = #{EventID}
					ORDER BY uf.SortKey
			]]>
	</select>
     
    <!-- isRepeatAll이 Y일 경우 결과값 list, N일 경우 결과값 map  -->
    <select id="selectBookingStateData" parameterType="cmap" resultType="cmap">
           SELECT a.EventID
                , a.DateID
                , a.ResourceID AS FolderID
                , CASE WHEN e.FolderType = 'Resource' THEN 'N' ELSE 'Y' END AS IsSchedule
                , IFNULL(a.ApprovalState,'') AS ApprovalState
                , b.RepeatID
                , b.IsRepeat
                , b.StartDateTime
                , b.EndDateTime 
                , ReturnType
                , BookingType
                , e.Subject
                <!-- 등록 코드 확인 필요 -->
                , e.RegisterCode  
		   FROM covi_smart4j.event_resource_booking AS a
		   INNER JOIN covi_smart4j.event_date AS b ON a.DateID = b.DateID
		   INNER JOIN covi_smart4j.`event`  AS e ON e.EventID = b.EventID  
		   INNER JOIN resource AS c ON c.FolderID = Fn_ResourceParentIDGet_S(a.ResourceID)
		   <trim prefix="WHERE" prefixOverrides="AND |OR ">
		   		<if test="ResourceID != null and ResourceID != ''">
		   			AND a.ResourceID = #{ResourceID}
		   		</if>
		   		<choose>
		   			<when test="IsRepeatAll !=null and IsRepeatAll.equalsIgnoreCase('Y')">
				   	   AND a.eventID = #{EventID}
				   	</when>
				   	<otherwise>
					   AND a.DateID =  #{DateID}
			           LIMIT 1
				   	</otherwise>
		   		</choose>
		   </trim>
    </select>
    
    <update id="updateBookingState" parameterType="cmap" >
        	UPDATE covi_smart4j.event_resource_booking
			SET ApprovalState = #{ApprovalState}
				, ApprovalDate = now(3)
			WHERE DateID = #{DateID}
			<if test="ResourceID != null and ResourceID != '' ">
			 	AND ResourceID = #{ResourceID}
			</if>
    </update>

    <update id="updateReturnBookingState" parameterType="cmap" >
        	 UPDATE event_resource_booking 
			 SET ApprovalState = #{ApprovalState}
				 , ApprovalDate = now(3)
				 , RealEndDateTime = #{localCurrentDate}
			 WHERE DateID = #{DateID}
			 <if test="ResourceID != null and ResourceID != '' ">
			 	AND ResourceID = #{ResourceID}
			 </if>
    </update>

    <select id="selectDuplicateTime" parameterType="cmap"  resultType="java.lang.Long">
      	SELECT COUNT(*) AS cnt
		FROM event_resource_booking AS a
		LEFT JOIN event_date AS b ON a.DateID = b.DateID
    	WHERE a.ResourceID =  (SELECT IFNULL(LinkFolderID,folderID) FROM sys_object_folder WHERE folderID = #{FolderID}  ORDER BY folderID DESC LIMIT 1)
     	AND a.DeleteDate IS NULL
       	AND a.ApprovalState IN('Approval','ReturnRequest','ReturnComplete')
   	 	<if test="DateID != null and DateID !=''">
  	  		  AND a.DateID !=  #{DateID}
  		</if>
   	 	<if test="EventID != null and EventID !=''">
  	  		  AND a.EventID !=  #{EventID}
  		</if>
  		<![CDATA[
	       	AND (
	       	(#{StartDateTime} <= b.StartDateTime AND DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDateTime})
	      	OR (#{StartDateTime} < b.StartDateTime AND b.StartDateTime < #{EndDateTime} AND #{EndDateTime} <= DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i'))
	      	OR (b.StartDateTime <= #{StartDateTime} AND #{StartDateTime} < DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i') AND DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDateTime})
	       	OR (b.StartDateTime <= #{StartDateTime} AND #{EndDateTime} <= DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i') )
	       	);
  		]]>
    </select>
    
    <!-- 해당 시간에 예약 가능한 동일한 종류의 다른 자원 목록 조회  -->
    <select id="selectCheckTime" parameterType="cmap"  resultType="cmap">
				SELECT a.FolderID, Fn_BaseGetDictionary_S(#{lang}, a.MultiDisplayName) AS FolderName
				FROM covi_smart4j.sys_object_folder AS a
				WHERE a.FolderType = #{FolderType}
				<if test="FolderIDs != null and FolderIDs.length != 0">
					AND a.FolderID  in 
		        	<foreach collection="FolderIDs" item="item" index="index" separator="," open="(" close=")">
		                    #{item}
		            </foreach>
				</if>                
				AND a.FolderID NOT IN (
						SELECT b.ResourceID
						FROM event_resource_booking AS b
						LEFT JOIN event_date AS c ON b.DateID = c.DateID
						WHERE b.DeleteDate IS NULL
						AND b.ApprovalState IN('Approval','ReturnRequest','ReturnComplete')
						<if test="DateID != null and DateID !='' and DateID.length() gt 0">
					  		  AND b.DateID !=  #{DateID}
						</if>						
			<![CDATA[
						AND (
							   	(#{StartDateTime} <= c.StartDateTime AND DATE_FORMAT(b.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDateTime})
						      	OR (#{StartDateTime} < c.StartDateTime AND c.StartDateTime < #{EndDateTime} AND #{EndDateTime} <= DATE_FORMAT(b.RealEndDateTime,'%Y-%m-%d %H:%i'))
						      	OR (c.StartDateTime <= #{StartDateTime} AND #{StartDateTime} < DATE_FORMAT(b.RealEndDateTime,'%Y-%m-%d %H:%i') AND DATE_FORMAT(b.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDateTime})
						       	OR (c.StartDateTime <= #{StartDateTime} AND #{EndDateTime} <= DATE_FORMAT(b.RealEndDateTime,'%Y-%m-%d %H:%i') )
						)		
				)
			]]>
			ORDER BY a.SortKey ASC
    </select>
    
    <!-- 해당 자원이 예약 가능한 자원인지 조회  -->
	<select id="selectCheckResourceApv" parameterType="cmap"  resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM covi_smart4j.resource
		WHERE FolderID = #{FolderID}
		AND BookingType = 'ApprovalProhibit'
	</select>
    
    <!-- 같은 종류의 자원 목록 조회  -->
    <select id="selectSameTypeFolderList" parameterType="cmap"  resultType="cmap">
        SELECT a.FolderID, Fn_BaseGetDictionary_S(#{lang}, a.MultiDisplayName) AS FolderName
		FROM covi_smart4j.sys_object_folder AS a
		WHERE a.FolderType = #{FolderType}
		<if test="FolderID != null and FolderID !='' and FolderID.length() gt 0">
  	  		  AND a.FolderID !=  #{FolderID}
  		</if>
		ORDER BY a.SortKey ASC
    </select>
    
     <!-- 특정 자원의 n시 ~ n시 의 예약 정보 조회 -->
    <select id="selectCheckList" parameterType="cmap"  resultType="cmap">
			<![CDATA[
				SELECT b.StartDateTime,DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i') AS EndDateTime
				FROM event_resource_booking AS a
				LEFT JOIN event_date AS b ON a.DateID = b.DateID
				WHERE a.ResourceID =  (SELECT IFNULL(LinkFolderID,folderID) FROM sys_object_folder WHERE folderID = #{FolderID}  ORDER BY folderID DESC LIMIT 1)
				AND a.DeleteDate IS NULL
				AND a.ApprovalState IN('Approval','ReturnRequest','ReturnComplete')
				AND (
					(#{StartDateTime} <= b.StartDateTime AND DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDateTime})
					OR (#{StartDateTime} < b.StartDateTime AND b.StartDateTime < #{EndDateTime} AND #{EndDateTime} <= DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i'))
					OR (b.StartDateTime <= #{StartDateTime} AND #{StartDateTime} < DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i') AND DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDateTime})
					OR (b.StartDateTime <= #{StartDateTime} AND #{EndDateTime} <= DATE_FORMAT(a.RealEndDateTime,'%Y-%m-%d %H:%i') )
				)		
			]]>
    </select>
    
    <insert id="insertUserformValue" parameterType="cmap" >
        INSERT INTO covi_smart4j.resource_userform_value
		(
			EventID
			, UserFormID
			, FolderID
			, FieldValue
		) VALUES (
			#{EventID}					# EVENT의 ID
			, #{UserFormID}				# 확장필드 ID
			, #{FolderID}					# 자원 폴더 ID
			, #{FieldValue}				# 입력값
		);
    </insert>
    
    <delete id="deleteUserformValue" parameterType="cmap" >
        DELETE FROM resource_userform_value 
		WHERE EventID = #{EventID}
    </delete>
    
	<select id="selectResourceList" parameterType ="cmap" resultType="cmap">
		SELECT	  a.FolderID 
				, a.FolderType
				, SUBSTRING_INDEX(a.FolderType, '.', -1) AS TypeCode
				, Fn_BaseGetDictionary_S(#{lang}, IFNULL(b.MultiCodeName,'')) AS TypeName
				, Fn_BaseGetDictionary_S(#{lang}, IFNULL(a.MultiDisplayName,a.DisplayName)) AS FolderName 
		FROM sys_object_folder AS a 
		LEFT JOIN sys_base_code AS b ON SUBSTRING_INDEX(a.FolderType, '.', -1) = b.Code AND b.CodeGroup = 'ResourceType'
		WHERE FolderType LIKE 'Resource%'
		<if test='aclFolderIDArr != null and aclFolderIDArr.length != 0'>
			AND a.FolderID IN  
			<foreach collection="aclFolderIDArr" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
		AND a.DeleteDate IS NULL 
		AND a.IsUse = 'Y'
		AND a.IsDisplay = 'Y'
		AND b.DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = b.Code AND CodeGroup = 'ResourceType' ORDER BY IF(DomainID = a.DomainID, 0, 1) LIMIT 1 )
		ORDER BY a.SortKey 
	</select>
    
	<select id="selectRootFolderID" parameterType="cmap" resultType="cmap">
		SELECT FolderID AS "FolderID" -- root가 없을 경우 -1로 반환 
			, DomainID as "DomainID"
		FROM sys_object_folder 
		WHERE FolderType = 'Root'
		<if test='aclFolderIDArr != null and aclFolderIDArr.length != 0'>
			AND FolderID IN  
			<foreach collection="aclFolderIDArr" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
		AND ObjectType = 'Resource'
		AND	DomainID in (0, #{DomainID} )
		AND IsUse = 'Y' 
		AND IsDisplay = 'Y'
		AND DeleteDate IS NULL;
	</select>
    
	<select id="selectChildResource" parameterType="cmap" resultType="cmap">
		/* queryID : user.resource.selectChildResource */
		SELECT	  FolderID
				, IF(FolderType='Folder','Folder','Resource') AS FolderType
				, ( CASE WHEN (LinkFolderID IS NULL AND IsShared = 'N') THEN Fn_BaseGetDictionary_S(#{lang},MultiDisplayName)
					ELSE CONCAT('[', Fn_GetSelDictionary(#{lang}, 'lbl_sharing', 0), '] ', Fn_BaseGetDictionary_S(#{lang},MultiDisplayName))
					END ) AS FolderName
		FROM sys_object_folder
		WHERE 
		<if test="folderID != null and folderID !='' ">
		 	MemberOf = #{folderID} 
		</if>
		<if test="folderID == null or folderID =='' ">
			MemberOf in 
			<foreach collection="rootFolderIDArr" item="item" open="(" close=")" separator=",">
					#{item.FolderID}
			</foreach>
		</if>
		<if test="placeOfBusiness != null and placeOfBusiness !='' and placeOfBusiness.length() gt 0">
			AND (Reserved1 LIKE CONCAT('%',#{placeOfBusiness},'%') OR Reserved1 is null OR Reserved1 = '')
		</if>
		<if test='aclFolderIDArr != null and aclFolderIDArr.length != 0'>
			AND FolderID IN  
			<foreach collection="aclFolderIDArr" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
		AND IsUse = 'Y' 
		AND IsDisplay = 'Y'
		AND ObjectType = 'Resource'
		AND	(DomainID = #{DomainID} OR DomainID = 0)
		ORDER BY DomainID, SortKey 
	</select>
    
    <select id="selectManageInfo" parameterType="cmap" resultType="cmap">
      		SELECT ObjectID AS FolderID FROM covi_smart4j.sys_object_acl AS a
			WHERE a.DeleteDate IS NULL
			AND SubjectType = 'RM'
			AND 
				(a.SubjectCode IN 
				<foreach collection="subjectInArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
				OR  #{groupPath} LIKE CONCAT('%;',a.SubjectCode,'%;')
				)
    </select>
    
    <select id="selectManageInfoCnt" parameterType="cmap" resultType="java.lang.Long">
      		SELECT COUNT(*) FROM covi_smart4j.sys_object_acl AS a
			WHERE a.DeleteDate IS NULL
			AND SubjectType = 'RM'
			AND 
				(a.SubjectCode IN 
				<foreach collection="subjectInArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
				OR  #{groupPath} LIKE CONCAT('%;',a.SubjectCode,'%;')
				)
    </select>
    
     <!-- 메인 화면 자원 관리 목록 조회-->
    <select id = "selectMainResourceList" parameterType="cmap" resultType ="cmap">
		<![CDATA[
			SELECT a.FolderID
			FROM resource_front AS a
		]]>
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			AND a.IsDefault = 'Y'
			<if test='FolderIDArr != null and FolderIDArr.length != 0'>
				AND a.FolderID IN  
				<foreach collection="FolderIDArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
		</trim>
    </select>
    
	<select id="selectResourceTreeList" parameterType="cmap" resultType ="cmap">
		SELECT	  a.FolderID AS "FolderID" 
				, a.FolderType AS "FolderType"
				, a.DomainID  AS "DomainID"
				, (CASE WHEN a.FolderType = 'Root' THEN d.MultiDisplayName ELSE IFNULL(a.MultiDisplayName,a.DisplayName) END) AS "MultiDisplayName"
				, COVI_SMART4J.FN_FOLDERPATHBYLANGGET_S(#{lang}, a.FolderPath) AS "FolderPath"
				, a.MemberOf AS "MemberOf"
				, a.SortKey AS "SortKey"
				, a.SortPath AS "SortPath"
				, IFNULL(b.IconCode, ' ') AS "IconCode"
				, b.BookingType AS "BookingType"
		FROM COVI_SMART4J.SYS_OBJECT_FOLDER a
		LEFT JOIN COVI_SMART4J.RESOURCE b ON a.FolderID = b.FolderID
		LEFT JOIN COVI_SMART4J.SYS_OBJECT_DOMAIN d ON a.DomainID = d.DomainID
		WHERE a.IsUse = 'Y' AND a.DeleteDate IS NULL
		AND ObjectType = 'Resource'
		<if test='FolderIDArr != null and FolderIDArr.length != 0'>
			AND a.FolderID IN  
			<foreach collection="FolderIDArr" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
		AND (a.DomainID = #{domainID} OR a.DomainID = 0)
		<if test="placeOfBusiness != null and placeOfBusiness !='' and placeOfBusiness.length() gt 0">
			AND (Reserved1 LIKE CONCAT('%',#{placeOfBusiness},'%') OR Reserved1 is null OR Reserved1 = '')
		</if>
		ORDER BY a.DomainID ASC, a.SortPath ASC, a.SortKey ASC
	</select>
    
    <!-- 확장 필드 조회 -->
    <select id="selectUserFormData" parameterType="cmap" resultType ="cmap">
        SELECT
			UserFormID
			, FolderID
			, SortKey
			, Fn_BaseGetDictionary_S(#{lang}, MultiFieldName) AS MultiFieldName
			, FieldType
			, FieldInputLimit
			, IsList
			, IsOption
		FROM covi_smart4j.resource_userform
		WHERE FolderID = #{FolderID}
		AND IsList = 'Y'
		ORDER BY SortKey
    </select>
    
    <select id="selectLeftCalendarEvent" parameterType="cmap" resultType ="cmap">
        SELECT
        	CONCAT(b.StartDate, '~',DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d')) AS StartEndDate,
        	GROUP_CONCAT(a.EventID)
        FROM covi_smart4j.event AS a
        INNER JOIN covi_smart4j.event_date AS b ON a.EventID = b.EventID
        LEFT JOIN covi_smart4j.event_resource_booking AS c ON b.DateID = c.DateID
        LEFT JOIN covi_smart4j.event_relation AS d ON c.ResourceID = d.ResourceID AND a.EventID = d.ScheduleID
        INNER JOIN covi_smart4j.sys_object_folder AS e ON c.ResourceID = e.FolderID
        LEFT JOIN covi_smart4j.resource AS f ON f.FolderID = Fn_ResourceParentIDGet_S(IFNULL(e.LinkFolderID,e.FolderID))
        WHERE ( (a.FolderType LIKE 'Resource%') OR (a.FolderType LIKE 'Schedule%' AND d.ResourceID IS NOT NULL) )
        	AND c.DeleteDate IS NULL
        	AND c.ApprovalState IN ('ApprovalRequest', 'Approval', 'ReturnRequest', 'ReturnComplete')
			<if test="FolderIDs != null and FolderIDs.length != 0">
				AND c.ResourceID  in 
	        	<foreach collection="FolderIDs" item="item" index="index" separator="," open="(" close=")">
	                    #{item}
	            </foreach>
			</if>                
        	<![CDATA[
			AND ( 	(#{StartDate} <= b.StartDateTime AND DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDate}) OR 
		  	   	(#{StartDate} < b.StartDateTime  AND b.StartDateTime < #{EndDate} AND #{EndDate} <= DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i')) OR
		  	   	(b.StartDateTime <= #{StartDate} AND #{StartDate} < DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i') AND DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i') <= #{EndDate}) OR 
		  	   	(b.StartDateTime <= #{StartDate} AND #{EndDate} <= DATE_FORMAT(c.RealEndDateTime,'%Y-%m-%d %H:%i'))    )
		  	]]> 
	  	GROUP BY StartEndDate
		ORDER BY StartEndDate ASC;
    </select>
    
    <update id="updateEventResourceBookingResID" parameterType="cmap">
        UPDATE
        	covi_smart4j.event_resource_booking
        SET
        	ResourceID = #{ResourceID}
        WHERE
        	ResourceID = #{oldResourceID}
        	AND EventID = #{EventID}
        	AND DateID = #{DateID};
    </update>
    
    <select id="selectLinkFolderList" parameterType="cmap" resultType ="cmap">
    	/* queryID : user.resource.selectLinkFolderList */
    	with vt AS (
    		SELECT 	FolderID, LinkFolderID
    		FROM	covi_smart4j.sys_object_folder
			WHERE	1=1    		
    	<if test='FolderIDs != null'>
    		AND
    		<foreach collection="FolderIDs" item="item" open="(" close=")" separator="OR">
    		FolderID = #{item} OR LinkFolderID = #{item}
    		</foreach>
    	</if>
    		AND  	ObjectType = 'Resource'
			AND		IsUse = 'Y'
			AND  	IsDisplay = 'Y'
    	)
    	
    	SELECT	vtt.FolderID
		FROM	(
					SELECT 	FolderID
					FROM	vt
					WHERE	FolderID IS NOT NULL
					UNION ALL
					SELECT 	LinkFolderID 
					FROM 	vt
					WHERE	LinkFolderID IS NOT NULL
		) vtt
		GROUP BY FolderID
    </select>
    
</mapper>