<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="admin.new.attendance">
	<select id="getAttMstSecomIFList" resultType="cmap">
		SELECT
			CompanyCode
		FROM
			covi_smart4j.attendance_mng_mst
		WHERE 1=1
		AND ValidYn = 'Y'
		AND OthYn = 'Y'
	</select>
	
	<select id="getSecomIFUserList" parameterType="cmap" resultType="cmap">
		SELECT
			a.*
			,UR_Code
			,Sabun
			,EmpNo
			,bWS
			,bWC
			,WSTime
			,WCTime
			,CASE
				WHEN DATE_FORMAT(StartTime,'%Y%m%d%H%i%s') <![CDATA[ >= ]]>  WSTime THEN 'Y'
				ELSE 'N'
			END StartUpdYn
			,CASE
				WHEN DATE_FORMAT(EndTime,'%Y%m%d%H%i%s') <![CDATA[ <= ]]> WCTime THEN 'Y'
				ELSE 'N'
			END EndUpdYn
		FROM
		(
		SELECT
			UserCode
			,h.*
		FROM
		(
			SELECT
				UserCode
				,MAX(b.HisSeq) HisSeq
			FROM
				covi_smart4j.attendance_commuting_mst m
			JOIN covi_smart4j.attendance_commuting_history a
			JOIN (
					SELECT 
						MAX(HisSeq) HisSeq
					FROM covi_smart4j.attendance_commuting_history
					WHERE 1=1
					AND CompanyCode = #{CompanyCode}
				<!-- 	AND EndTime IS null -->
					GROUP BY TargetDate , CommuSeq
					) b
				ON m.CommuSeq = a.CommuSeq
				AND a.HisSeq = b.HisSeq
				GROUP BY UserCode
			) m JOIN covi_smart4j.attendance_commuting_history h
			ON m.HisSeq = h.HisSeq
		) a RIGHT JOIN (
			SELECT
				UserCode UR_Code
				,s.Sabun
				,EmpNo
				,bWS
				,bWC
				,WSTime
				,WCTime
			FROM (
				SELECT 
					sou.UserCode
					,EmpNo
				FROM
					covi_smart4j.sys_object_user_basegroup soub
					JOIN covi_smart4j.sys_object_user sou
					ON soub.UserCode = sou.UserCode
				WHERE 1=1
				AND sou.IsUse ='Y'
				AND sou.IsDisplay ='Y'
				AND soub.CompanyCode = #{CompanyCode}
				GROUP BY UserCode
			)u JOIN (
				SELECT
					*
				FROM legacy_secom.t_secom_workhistory
				WHERE 1=1
				<choose>
				<when test="TargetDate != null and TargetDate != ''">
				AND WorkDate = #{TargetDate}
				</when>
				<otherwise>
				AND WorkDate = DATE_FORMAT(NOW(),'%Y%m%d')
				</otherwise>
				</choose>
				AND ( bWS = 1 OR bWC = 1 )
			) s
			ON s.Sabun = u.EmpNo
		) b
		ON a.UserCode = b.UR_Code
	</select>
	<select id="getSecomIFUserList2" parameterType="cmap" resultType="cmap">
		SELECT
			UserCode
			,EmpNo
			,bWS
			,bWC
			,WSTime
			,WCTime
			,tfWSTime
			,tfWCTime
			,WorkDate
			,HisSeq
			,TargetDate
			,tfTargetDate
			,StartTime
			,EndTime
			,tfStartTime
			,tfEndTime
			,StartChannel
			,EndChannel
			,StartType
			,EndType
		FROM
		(
			SELECT
				*		
				,CASE WHEN bWS = 1 THEN
					CASE
						WHEN tfStartTime IS NULL THEN 'CRE'
						WHEN WorkDate = tfTargetDate THEN
							CASE
								WHEN tfEndTime IS NULL AND tfWSTime <![CDATA[ < ]]> tfStartTime THEN 'UPD'
							END
						WHEN tfEndTime IS NOT NULL THEN 'CRE'
						END
					END StartType
				,CASE WHEN bWC = 1 THEN
					CASE
						WHEN tfStartTime IS NOT NULL THEN
							CASE 
								WHEN tfEndTime IS NULL THEN 'CRE'
								WHEN tfWCTime <![CDATA[ > ]]> tfEndTime THEN 'UPD'
							END 
						END
					END EndType
			FROM		
			(
				SELECT
					u.UserCode
					,u.EmpNo
					,s.bWS
					,s.bWC
					,s.WSTime
					,s.WCTime
					,DATE_FORMAT(s.WSTime,'%Y%m%d%H%i%s') tfWSTime
					,DATE_FORMAT(s.WCTime,'%Y%m%d%H%i%s') tfWCTime
					,WorkDate
				FROM
				(
					SELECT 
						sou.UserCode 
						,EmpNo
					FROM
						covi_smart4j.sys_object_user_basegroup soub
						JOIN covi_smart4j.sys_object_user sou
						ON soub.UserCode = sou.UserCode
					WHERE 1=1
					AND sou.IsUse ='Y'
					AND sou.IsDisplay ='Y'
					AND soub.CompanyCode = #{CompanyCode}
					GROUP BY UserCode
				) u JOIN (
					SELECT
						*
					FROM legacy_secom.t_secom_workhistory
					WHERE 1=1
					AND WorkDate = #{TargetDate}
					AND ( bWS = 1 OR bWC = 1 )
				) s 
				ON s.Sabun = u.EmpNo
			) s LEFT JOIN (
				SELECT
					UserCode UR_Code
					,TargetDate
					,h.HisSeq
					,DATE_FORMAT(TargetDate,'%Y%m%d') tfTargetDate
					,StartTime
					,EndTime
					,DATE_FORMAT(StartTime,'%Y%m%d%H%i%s') tfStartTime
					,DATE_FORMAT(EndTime,'%Y%m%d%H%i%s') tfEndTime
					,h.StartChannel
					,h.EndChannel
				FROM
					(	
					SELECT
						UserCode
						,MAX(b.HisSeq) HisSeq
					FROM
						covi_smart4j.attendance_commuting_mst m
					JOIN covi_smart4j.attendance_commuting_history a
					JOIN (
							SELECT 
								MAX(HisSeq) HisSeq
							FROM covi_smart4j.attendance_commuting_history
							WHERE 1=1
							AND CompanyCode = #{CompanyCode}
							GROUP BY TargetDate , CommuSeq
							) b
						ON m.CommuSeq = a.CommuSeq
						AND a.HisSeq = b.HisSeq
						GROUP BY UserCode
					) m JOIN covi_smart4j.attendance_commuting_history h
					ON m.HisSeq = h.HisSeq
			) h	
			ON s.UserCode = h.UR_Code
		) a WHERE (StartType IS NOT NULL OR EndType IS NOT NULL)
	</select>
	
		
	<update id="setSecomIFCommuHis" parameterType="cmap" >
		UPDATE covi_smart4j.attendance_commuting_history SET
			ModifyerCode = #{RegCode}
			,ModifyDate = now()
			<if test="StartChannel != null and StartChannel != '' and StartTime != null and StartTime != '' ">
				,StartTime = DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s')
				,StartChannel = #{StartChannel}
				,StartSts = covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayStartTime},#{AttDayAc},'Y',DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s'),null,0 )
				,StartColSts = covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayStartTime},#{AttDayAc},'Y',DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s'),null,1 )
				,DisplayStartSts = IF(#{AttDaySts} = 'B',IF(DATE_FORMAT(#{StartTime},'%H%i')<![CDATA[ > ]]>#{AttDayStartTime} ,DATE_FORMAT(#{StartTime},'%H%i'),#{AttDayStartTime}),DATE_FORMAT(#{StartTime},'%H%i'))
			</if>
			<if test="EndChannel != null and EndChannel != ''">
				,EndTime = DATE_FORMAT(#{EndTime},'%Y-%m-%d %H:%i:%s')
				,EndChannel = #{EndChannel}
				,EndSts = covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayEndTime},#{AttDayAc},'N',DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s'),DATE_FORMAT(#{EndTime},'%Y-%m-%d %H:%i:%s'),0 )
				,EndColSts = covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayEndTime},#{AttDayAc},'N',DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s'),DATE_FORMAT(#{EndTime},'%Y-%m-%d %H:%i:%s'),1 )
				,DisplayEndSts = IF(#{AttDaySts} = 'B',IF(DATE_FORMAT(#{EndTime},'%H%i')<![CDATA[ < ]]>#{AttDayEndTime} ,DATE_FORMAT(#{EndTime},'%H%i'),#{AttDayEndTime}),DATE_FORMAT(#{EndTime},'%H%i'))
			</if> 
		WHERE HisSeq = #{HisSeq}			
	</update>
	
	<select id="getAttCommuMstSeq" parameterType="cmap" resultType="cmap">
		SELECT 
			*
		FROM
			covi_smart4j.attendance_commuting_mst
		WHERE 1=1
		AND	UserCode = #{UserCode}
		AND CompanyCode = #{CompanyCode}	
		<if test='nowD eq "Y"'>
		AND 
			TargetDate = DATE_FORMAT(NOW(),'%Y-%m-%d')
		</if>
		<if test="TargetDate != null and TargetDate != ''">
		AND 
			TargetDate = DATE_FORMAT(#{TargetDate},'%Y-%m-%d')
		</if>
	</select>
	
	
	<insert id="createCommutingMst" parameterType="cmap" useGeneratedKeys="true" keyProperty="CommuSeq">
		INSERT INTO covi_smart4j.attendance_commuting_mst
		(
			CommuSeq
			,UserCode
			,TargetDate
			,CompanyCode
			,RegisterCode
			,RegistDate
			,ModifyerCode
			,ModifyDate
		)
		VALUES
		(
			#{CommuSeq}
			,#{UserCode}
			<choose>
				<when test="TargetDate != null and TargetDate != ''">
				,DATE_FORMAT(#{TargetDate},'%Y-%m-%d')
				</when>
				<otherwise>
				,DATE_FORMAT(NOW(),'%Y-%m-%d')
				</otherwise>
			</choose>	
			,#{CompanyCode}
			,#{RegCode}
			,now()
			,#{RegCode}
			,now()
		)
			
		<selectKey resultType="cmap" keyProperty="CommuSeq,TargetDate" order="AFTER">
		    SELECT CommuSeq,TargetDate FROM covi_smart4j.attendance_commuting_mst 
		    WHERE CommuSeq = LAST_INSERT_ID()
		</selectKey> 
	</insert>
	
	
	<select id="t_getSchMemberInfo" parameterType="cmap" resultType="cmap">
		SELECT
			 m.AttSeq
			,m.CompanyCode
			,m.SchSeq
			,m.ScMemSeq
			,m.SchName
			,m.MultiDisplayName
			,m.schMulti
			,m.UserName
			,m.userMulti
			,m.TransChargeBusiness
			,m.UserCode
			,m.StartDtm
			,m.EndDtm
			,m.ValidYn
			,m.NowDate
			,CASE
				WHEN m.NowDate <![CDATA[ <  ]]> m.StartDtm THEN 'A1'
				WHEN m.NowDate <![CDATA[ <= ]]> m.EndDtm THEN 'A2'
				WHEN m.NowDate <![CDATA[ >  ]]> m.EndDtm THEN 'A3'
			END Sts
			,CASE
				WHEN m.NowDate <![CDATA[ >= ]]> m.EndDtm THEN 'N'
				ELSE ValidYn
			END Valid
		FROM
		(
			SELECT 
					amm.AttSeq
					,amm.CompanyCode
					,ams.SchSeq
					,amsm.ScMemSeq
					,ams.SchName
					,ams.MultiDisplayName
					,Fn_BaseGetDictionary_S(#{lang},ams.MultiDisplayName) schMulti
					,sou.DisplayName AS UserName
					,Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) userMulti
					,Fn_BaseGetDictionary_S(#{lang},sou.MultiDeptName) TransChargeBusiness
					,amsm.UserCode
					,amsm.StartDtm
					,amsm.EndDtm
					,amsm.ValidYn
					,DATE_FORMAT(NOW(),'%Y-%m-%d') AS NowDate
				FROM covi_smart4j.attendance_mng_schedule_member amsm
				LEFT JOIN (
					SELECT ur.*,bg.MultiDeptName,bg.DeptCode FROM covi_smart4j.sys_object_user_basegroup bg
					LEFT JOIN covi_smart4j.sys_object_user AS ur ON ur.UserCode = bg.UserCode
				) sou
				ON sou.UserCode = amsm.UserCode
				LEFT JOIN covi_smart4j.attendance_mng_schedule ams
				ON ams.SchSeq = amsm.SchSeq
				LEFT JOIN covi_smart4j.attendance_mng_mst amm
				ON ams.AttSeq = amm.AttSeq
			WHERE
				1=1
				AND sou.IsUse = 'Y'
				AND ams.ValidYn = 'Y'
				AND amm.ValidYn = 'Y'
				AND amm.CompanyCode = #{CompanyCode}
			<if test="ValidCheck != null and ValidCheck != ''">
				/*근무제 활성여부*/
				AND amsm.ValidYn = #{ValidCheck}
			</if>
			<if test="UserCode != null and UserCode != ''">
				/*특정고객조회시*/
				AND amsm.UserCode = #{UserCode}
			</if>
			<if test="SchSeq != null and SchSeq != ''">
				/*근무제 조회*/
				AND amsm.SchSeq = #{SchSeq}
			</if>
			<if test="ScMemSeq != null and ScMemSeq != ''">
				/*근무제 지정자 번호 조회*/
				AND amsm.ScMemSeq = #{ScMemSeq}
			</if>
		) m
			WHERE 1=1
		<if test="TargetDate != null and TargetDate != ''">
			/*지정일기준 */
			AND DATE_FORMAT(#{TargetDate},'%Y-%m-%d') BETWEEN m.StartDtm AND m.EndDtm
		</if>
	</select>
	
	<select id="getCompanySchBaseInfo" parameterType="cmap" resultType="String">
	SELECT
		SchSeq
	FROM covi_smart4j.attendance_mng_mst amm
		LEFT JOIN  covi_smart4j.attendance_mng_schedule ams ON amm.AttSeq = ams.AttSeq
		WHERE 1=1
		AND amm.CompanyCode = #{CompanyCode}
		AND	amm.ValidYn = 'Y'
		AND ams.ValidYn = 'Y'
		AND ams.BaseYn = 'Y'
	</select>
	
	<select id="getNowSchInfoDate" parameterType="cmap" resultType="cmap">
		SELECT
				CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN CONCAT(StartMonHour,StartMonMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN CONCAT(StartTueHour,StartTueMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN CONCAT(StartWedHour,StartWedMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN CONCAT(StartThuHour,StartThuMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN CONCAT(StartFriHour,StartFriMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN CONCAT(StartSatHour,StartSatMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN CONCAT(StartSunHour,StartSunMin)
				END StartTime
				,CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN CONCAT(EndMonHour,EndMonMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN CONCAT(EndTueHour,EndTueMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN CONCAT(EndWedHour,EndWedMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN CONCAT(EndThuHour,EndThuMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN CONCAT(EndFriHour,EndFriMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN CONCAT(EndSatHour,EndSatMin)
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN CONCAT(EndSunHour,EndSunMin)
				END EndTime
				,CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN AcMon
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN AcTue
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN AcWed
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN AcThu
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN AcFri
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN AcSat
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN AcSun
				END AcTime
				,CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN IdleMon
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN IdleTue
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN IdleWed
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN IdleThu
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN IdleFri
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN IdleSat
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN IdleSun
				END IdleTime
				,CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN AttDayStsMon
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN AttDayStsTue
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN AttDayStsWed
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN AttDayStsThu
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN AttDayStsFri
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN AttDayStsSat
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN AttDayStsSun
				END AttDaySts
				,CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN StartMonHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN StartTueHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN StartWedHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN StartThuHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN StartFriHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN StartSatHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN StartSunHour
				END StartHour
				,CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN StartMonMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN StartTueMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN StartWedMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN StartThuMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN StartFriMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN StartSatMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN StartSunMin
				END StartMin
				,CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN EndMonHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN EndTueHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN EndWedHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN EndThuHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN EndFriHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN EndSatHour
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN EndSunHour
				END EndHour
				,CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN EndMonMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN EndTueMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN EndWedMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN EndThuMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN EndFriMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN EndSatMin
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN EndSunMin
				END EndMin
				,DATE_FORMAT(STR_TO_DATE(#{p_TargetDate},'%Y%m%d'),'%Y.%m.%d %H:%i:%s') TransDate
				,CASE
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 0 THEN 'lbl_att_806_s_1_mon'
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 1 THEN 'lbl_att_806_s_1_tue'
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 2 THEN 'lbl_att_806_s_1_wed'
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 3 THEN 'lbl_att_806_s_1_thu'
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 4 THEN 'lbl_att_806_s_1_fri'
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 5 THEN 'lbl_att_806_s_1_sat'
					WHEN WEEKDAY(STR_TO_DATE(#{p_TargetDate},'%Y%m%d')) = 6 THEN 'lbl_att_806_s_1_sun'
				END dayLabelId
				,covi_smart4j.fn_attendance_holidayCheck(#{UserCode},#{CompanyCode},DATE_FORMAT(#{p_TargetDate},'%Y-%m-%d')) holiType
		FROM 
			covi_smart4j.attendance_mng_schedule
		WHERE 1=1
		<if test="SchSeq != null and SchSeq != ''">
			/*근무제별*/
			AND SchSeq = #{SchSeq}
		</if>		
	</select> 
	
	<insert id="updCommutingDetailHistory" parameterType="cmap" useGeneratedKeys="true" keyProperty="HisSeq">
		INSERT INTO
			covi_smart4j.attendance_commuting_history
			(
				CommuSeq
				,HisSeq
				,SchSeq
				,TargetDate
				,AttDaySts
				
				,AttDayStartTime
				,AttDayEndTime
				,AttDayAc
				,AttDayIdle
				
				<if test="StartTime != null and StartTime != ''">
				,DisplayStartSts 
				,StartTime

				,StartSts
				,StartColSts

				,StartChannel
				,StartBatchYn
				</if>
				
				<if test="EndTime != null and EndTime != ''">
				,DisplayEndSts
				,EndTime
				,EndSts
				,EndColSts
				,EndChannel
				</if>
				
				,CompanyCode
				,RegisterCode
				,RegistDate
				,ModifyerCode
				,ModifyDate
			)
			VALUES
			(
				#{CommuSeq}
				,#{HisSeq}
				,#{SchSeq}
				,DATE_FORMAT(#{TargetDate},'%Y-%m-%d')
				,#{AttDaySts}
				,#{AttDayStartTime}
				,#{AttDayEndTime}
				,#{AttDayAc}
				,#{AttDayIdle}
				<if test="StartTime != null and StartTime != ''">
				,IF(#{AttDaySts} = 'B',IF(DATE_FORMAT(#{StartTime},'%H%i')<![CDATA[ > ]]>#{AttDayStartTime} ,DATE_FORMAT(#{StartTime},'%H%i'),#{AttDayStartTime}),DATE_FORMAT(#{StartTime},'%H%i'))
				,DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s')
				,covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayStartTime},#{AttDayAc},'Y',DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s'),null,0 )
				<choose>
					<when test='StartBatchYn eq "Y"'>
					,NULL
					</when>
					<otherwise>
					,covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayStartTime},#{AttDayAc},'Y',DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s'),null,1 )
					</otherwise>
				</choose>
				,#{StartChannel}
				,#{StartBatchYn}
				</if>
				<if test="EndTime != null and EndTime != ''">
				,IF(#{AttDaySts} = 'B',IF(DATE_FORMAT(#{EndTime},'%H%i')<![CDATA[ < ]]>#{AttDayEndTime} ,DATE_FORMAT(#{EndTime},'%H%i'),#{AttDayEndTime}),DATE_FORMAT(#{EndTime},'%H%i'))
				,DATE_FORMAT(#{EndTime},'%Y-%m-%d %H:%i:%s')
				,covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayEndTime},#{AttDayAc},'N',DATE_FORMAT(#{EnStartTime},'%Y-%m-%d %H:%i:%s'),DATE_FORMAT(#{EndTime},'%Y-%m-%d %H:%i:%s'),0 )
				,covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayEndTime},#{AttDayAc},'N',DATE_FORMAT(#{EnStartTime},'%Y-%m-%d %H:%i:%s'),DATE_FORMAT(#{EndTime},'%Y-%m-%d %H:%i:%s'),1 )
				,#{EndChannel}
				</if>
				,#{CompanyCode} 
				,#{RegCode}
				,NOW()
				,#{RegCode}
				,NOW()
			)ON DUPLICATE KEY UPDATE    
			    ModifyerCode   = #{RegCode}   
			    ,ModifyDate     = NOW()      
				<if test="StartTime != null and StartTime != ''">
				,DisplayStartSts   = IF(#{AttDaySts} = 'B',IF(DATE_FORMAT(#{StartTime},'%H%i')<![CDATA[ > ]]>#{AttDayStartTime} ,DATE_FORMAT(#{StartTime},'%H%i'),#{AttDayStartTime}),DATE_FORMAT(#{StartTime},'%H%i'))
				,StartTime         = DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s')
				,StartSts          = covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayStartTime},#{AttDayAc},'Y',DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s'),null,0 )
				<choose>
					<when test='StartBatchYn eq "Y"'>
					,StartColSts = NULL
					</when>
					<otherwise>
					,StartColSts = covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayStartTime},#{AttDayAc},'Y',DATE_FORMAT(#{StartTime},'%Y-%m-%d %H:%i:%s'),null,1 )
					</otherwise>
				</choose>
				,StartChannel      = #{StartChannel}
				,StartPointX	=  NULL
				,StartPointY	=  NULL
				,StartBatchYn 	= #{StartBatchYn}
				</if>     
				<if test="EndTime != null and EndTime != ''">
				,DisplayEndSts      = IF(#{AttDaySts} = 'B',IF(DATE_FORMAT(#{EndTime},'%H%i')<![CDATA[ < ]]>#{AttDayEndTime} ,DATE_FORMAT(#{EndTime},'%H%i'),#{AttDayEndTime}),DATE_FORMAT(#{EndTime},'%H%i'))
 				,EndTime            = DATE_FORMAT(#{EndTime},'%Y-%m-%d %H:%i:%s')
 				,EndSts             = covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayEndTime},#{AttDayAc},'N',DATE_FORMAT(#{EnStartTime},'%Y-%m-%d %H:%i:%s'),DATE_FORMAT(#{EndTime},'%Y-%m-%d %H:%i:%s'),0 )
 				,EndColSts          = covi_smart4j.fn_attendance_setCommuStatus(#{AttDaySts},#{AttDayEndTime},#{AttDayAc},'N',DATE_FORMAT(#{EnStartTime},'%Y-%m-%d %H:%i:%s'),DATE_FORMAT(#{EndTime},'%Y-%m-%d %H:%i:%s'),1 )
 				,EndChannel         = #{EndChannel}
 				,EndPointX	=  NULL
				,EndPointY	=  NULL
				</if>     
	</insert>
	
	<select id="getPreCommuHistory" parameterType="cmap" resultType="cmap">
		SELECT CommuSeq,DATE_FORMAT(StartTime,'%Y%m%d%H%i%s') as StartTime FROM covi_smart4j.attendance_commuting_history WHERE HisSeq = #{HisSeq}
	</select>
	
	
	
	<select id="getAttBatchList" parameterType="cmap" resultType="cmap">
	<![CDATA[ 
		SELECT
			*
		FROM
		(
				SELECT
				*
				,CASE 
					WHEN UR_Code IS NULL THEN
						CASE 
							WHEN (bWS = 1 AND bWC = 1 ) THEN 
								'CRE/CRE'
							WHEN bWS = 1 THEN 
								IF(NowYn = 'Y','CRE/NO','CRE/24')
							WHEN bWC = 1 THEN 
								'24/CRE'
						END
					ELSE
						CASE 
							WHEN (bWS = 1 AND bWC = 1 ) THEN
								CASE 
									WHEN (ifbWS != 1 AND ifbWC != 1) THEN
										'UPD/UPD'
									WHEN (ifbWS = 1 AND ifbWC = 1) THEN
										CASE 
											WHEN ifbWC = 1 THEN
												IF(WCTime > tfEndTime,'NO/UPD',NULL)
											ELSE NULL
										END
									WHEN ifbWS != 1 THEN
										IF(WCTime > tfEndTime,'UPD/UPD','UPD/NO')
									WHEN ifbWC != 1  THEN
										'NO/UPD'
								END
							WHEN (bWS = 1 AND ifbWS != 1)  THEN
								'UPD/NO'
							WHEN bWC = 1 THEN
								CASE WHEN NowYN != 'Y' THEN
									CASE 
										WHEN ifbWC != 1 THEN 'NO/UPD'
										WHEN ifbWC = 1 THEN
											IF(WCTime > tfEndTime,'NO/UPD',NULL)
									END
								END
							WHEN (bWC = 0 AND ifbWC != 1)  THEN
								CASE WHEN NowYN != 'Y' THEN
									IF(CONCAT(WorkDate,235959) > tfEndTime,'NO/24',NULL)
								END
						END 
					END BatchType
			FROM
			(
				SELECT
					u.UserCode
					,u.EmpNo
					,s.bWS
					,s.bWC
					,s.WSTime
					,s.WCTime
					,WorkDate
					,CASE WHEN DATE_FORMAT(now(),'%Y%m%d') = WorkDate THEN 'Y'
							ELSE 'N'
					END NowYn
				FROM
				(
					SELECT 
						sou.UserCode 
						,EmpNo
					FROM
						covi_smart4j.sys_object_user_basegroup soub
						JOIN covi_smart4j.sys_object_user sou
						ON soub.UserCode = sou.UserCode
					WHERE 1=1
					AND sou.IsUse ='Y'
					AND sou.IsDisplay ='Y'
					AND soub.CompanyCode = #{CompanyCode}
					GROUP BY UserCode
				) u JOIN (
						SELECT
							*
						FROM legacy_secom.t_secom_workhistory 
						WHERE 1=1
						AND ( bWS = 1 OR bWC= 1 )
				) s 
				ON s.Sabun = u.EmpNo
			) s LEFT JOIN (
				SELECT
					UserCode UR_Code
					,m.TargetDate
					,m.CommuSeq
					,h.HisSeq
					,DATE_FORMAT(m.TargetDate,'%Y%m%d') tfTargetDate
					,StartTime
					,EndTime
					,IFNULL(DATE_FORMAT(StartTime,'%Y%m%d%H%i%s'),0) tfStartTime
					,IFNULL(DATE_FORMAT(EndTime,'%Y%m%d%H%i%s'),0) tfEndTime
					,h.StartChannel
					,h.EndChannel
					,IFNULL(m.ifbWS,0) ifbWS
					,IFNULL(m.ifbWC,0) ifbWC
				FROM
					(
					SELECT
						UserCode
						,m.TargetDate
						,MAX(b.HisSeq) HisSeq
						,m.CommuSeq
						,m.ifbWS
						,m.ifbWC
					FROM
						(
							SELECT
								m.*
								,h.bWS AS ifbWS
								,h.bWC AS ifbWC
							FROM
								covi_smart4j.attendance_commuting_mst m
								LEFT JOIN covi_smart4j.attendance_commuting_if_history h
								ON m.CommuSeq = h.CommuSeq
						) m
					JOIN covi_smart4j.attendance_commuting_history a
					JOIN (
							SELECT 
								MAX(HisSeq) HisSeq
							FROM covi_smart4j.attendance_commuting_history
							WHERE 1=1
							AND CompanyCode = #{CompanyCode}
							GROUP BY TargetDate , CommuSeq
							) b
						ON m.CommuSeq = a.CommuSeq
						AND a.HisSeq = b.HisSeq
						GROUP BY UserCode, m.TargetDate
					) m JOIN covi_smart4j.attendance_commuting_history h
					ON m.HisSeq = h.HisSeq
			) h 
			ON s.UserCode = h.UR_Code
			AND s.WorkDate = h.tfTargetDate
		) B WHERE BatchType IS NOT NULL 
	]]>
	</select>
	
	<insert id="setBatchIFHistory" parameterType="cmap"> 
		INSERT INTO covi_smart4j.attendance_commuting_if_history
		(
			CompanyCode
			,CommuSeq
			,WorkDate
			,UserCode
			,bWS
			,bWC
			,WSTime
			,WCTime
			,RegistDate
			,ModifyDate
		)
		VALUES
		(
			#{CompanyCode}
			,#{CommuSeq}
			,DATE_FORMAT(#{WorkDate},'%Y%m%d')
			,#{UserCode}
			,#{bWS}
			,#{bWC}
			,#{WSTime}
			,#{WCTime}
			,NOW()
			,NOW()
		) ON DUPLICATE KEY UPDATE    
			ModifyDate   = now()
			<if test="bWS != null and bWS != ''">
		    ,bWS        = #{bWS}  
			</if>  
			<if test="WSTime != null and WSTime != ''">
		    ,WSTime        = #{WSTime}  
			</if> 
			<if test="bWC != null and bWC != ''">
		    ,bWC        = #{bWC}  
			</if>  
			<if test="WCTime != null and v != ''">
		    ,WCTime        = #{WCTime}  
			</if>     
	</insert>
	
	<select id="getAttBatchList2" parameterType = "cmap" resultType= "cmap">
	<![CDATA[ 
		SELECT
			*
			,CASE
				WHEN VacDay  < 1 AND VacDay > 0 THEN 'Y'
			END VacHalfYn
			,CASE
				WHEN (AttDaySts = 'H' OR HolidayStart IS NOT NULL ) THEN 'Y'
				ELSE 'N'
			END HolidayYn
			,IF(ExHoTime IS NOT NULL ,'Y' ,'N' ) ExHoYn
			,IF(VacDay IS NOT NULL ,'Y' ,'N' ) VacationYn
		FROM
		(
			SELECT
				u.*
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN CONCAT(StartMonHour,StartMonMin)
					WHEN WEEKDAY(TargetDate) = 1 THEN CONCAT(StartTueHour,StartTueMin)
					WHEN WEEKDAY(TargetDate) = 2 THEN CONCAT(StartWedHour,StartWedMin)
					WHEN WEEKDAY(TargetDate) = 3 THEN CONCAT(StartThuHour,StartThuMin)
					WHEN WEEKDAY(TargetDate) = 4 THEN CONCAT(StartFriHour,StartFriMin)
					WHEN WEEKDAY(TargetDate) = 5 THEN CONCAT(StartSatHour,StartSatMin)
					WHEN WEEKDAY(TargetDate) = 6 THEN CONCAT(StartSunHour,StartSunMin)
				END AttDayStartTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN CONCAT(EndMonHour,EndMonMin)
					WHEN WEEKDAY(TargetDate) = 1 THEN CONCAT(EndTueHour,EndTueMin)
					WHEN WEEKDAY(TargetDate) = 2 THEN CONCAT(EndWedHour,EndWedMin)
					WHEN WEEKDAY(TargetDate) = 3 THEN CONCAT(EndThuHour,EndThuMin)
					WHEN WEEKDAY(TargetDate) = 4 THEN CONCAT(EndFriHour,EndFriMin)
					WHEN WEEKDAY(TargetDate) = 5 THEN CONCAT(EndSatHour,EndSatMin)
					WHEN WEEKDAY(TargetDate) = 6 THEN CONCAT(EndSunHour,EndSunMin)
				END AttDayEndTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN AttDayStsMon
					WHEN WEEKDAY(TargetDate) = 1 THEN AttDayStsTue
					WHEN WEEKDAY(TargetDate) = 2 THEN AttDayStsWed
					WHEN WEEKDAY(TargetDate) = 3 THEN AttDayStsThu
					WHEN WEEKDAY(TargetDate) = 4 THEN AttDayStsFri
					WHEN WEEKDAY(TargetDate) = 5 THEN AttDayStsSat
					WHEN WEEKDAY(TargetDate) = 6 THEN AttDayStsSun
				END AttDaySts
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN AcMon
					WHEN WEEKDAY(TargetDate) = 1 THEN AcTue
					WHEN WEEKDAY(TargetDate) = 2 THEN AcWed
					WHEN WEEKDAY(TargetDate) = 3 THEN AcThu
					WHEN WEEKDAY(TargetDate) = 4 THEN AcFri
					WHEN WEEKDAY(TargetDate) = 5 THEN AcSat
					WHEN WEEKDAY(TargetDate) = 6 THEN AcSun
				END AcDayTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN IdleMon
					WHEN WEEKDAY(TargetDate) = 1 THEN IdleTue
					WHEN WEEKDAY(TargetDate) = 2 THEN IdleWed
					WHEN WEEKDAY(TargetDate) = 3 THEN IdleThu
					WHEN WEEKDAY(TargetDate) = 4 THEN IdleFri
					WHEN WEEKDAY(TargetDate) = 5 THEN IdleSat
					WHEN WEEKDAY(TargetDate) = 6 THEN IdleSun
				END IdleDayTime
			FROM
			(
				SELECT
					us.*		/*user 기본정보*/
					,eh.*		/*연장휴일근무*/
					,v.*		/*휴가*/
					,hh.*		/*회사휴무일*/
					,CASE
						WHEN shm.SchSeq IS NOT NULL THEN shm.SchSeq
						ELSE (SELECT SchSeq FROM covi_smart4j.attendance_mng_schedule WHERE CompanyCode = #{CompanyCode} AND ValidYn = 'Y' AND BaseYn = 'Y')
					END userSchSeq	/*해당일 등록 된 근무제 seq*/
				FROM
				(	
					SELECT
						UserCode
						,bWS
						,ihBWS
						,bWC
						,ihBWC
						,WSTime
						,WCTime
						,WorkDate
						,DATE_FORMAT(WorkDate,'%Y-%m-%d') TargetDate
						,IF(CommuSeq IS NULL,aCommuSeq,CommuSeq) CommuSeq
						,HisSeq
						,stYn
						,etYn
						,tfStartTime
						,tfEndTime
						,stYn as StartTime
						,etYn as EndTime
					FROM
					(
						SELECT
							*
							,CASE 
								WHEN IFNULL(ihBWS,0) = 1 THEN NULL
								ELSE
								CASE 
									WHEN NowYn= 'Y' THEN
										CASE
											WHEN WSTime = '' THEN
												IF(WCTime != '' ,CONCAT(WorkDate,'000000'), NULL )
											ELSE
												IF(WSTime < IFNULL(tfStartTime,'99999999999999') , WSTime , NULL ) 
										END
									ELSE
										IF(IF(WSTime = '',CONCAT(WorkDate,'000000'),WSTime) < IFNULL(tfStartTime,'99999999999999') , IF(WSTime = '',CONCAT(WorkDate,'000000'),WSTime) , NULL )
								END
							END stYn
							,CASE 
								WHEN IFNULL(ihBWC,0) = 1 THEN 
									IF(WCTime > IFNULL(tfEndTime,'00000000000000') , WCTime , NULL )
								ELSE
								CASE 
									WHEN NowYn= 'Y' THEN
										CASE 
											WHEN WCTime = '' THEN NULL
											ELSE
												IF(WCTime > IFNULL(tfEndTime,'00000000000000') , WCTime , NULL ) 
										END
									ELSE
										IF(IF(WCTime = '',CONCAT(WorkDate,'235959'),WCTime) > IFNULL(tfEndTime,'00000000000000') , IF(WCTime = '',CONCAT(WorkDate,'235959'),WCTime) , NULL )
								END
							END etYn
			 			FROM
						(
							SELECT
								u.UserCode
								,s.bWS
								,s.bWC
								,s.WSTime
								,s.WCTime
								,WorkDate
								,CASE WHEN DATE_FORMAT(now(),'%Y%m%d') = WorkDate THEN 'Y'
										ELSE 'N'
								END NowYn
							FROM
							(
								SELECT 
									sou.UserCode 
									,EmpNo
								FROM
									covi_smart4j.sys_object_user_basegroup soub
									JOIN covi_smart4j.sys_object_user sou
									ON soub.UserCode = sou.UserCode
								WHERE 1=1
								AND sou.IsUse ='Y'
								AND sou.IsDisplay ='Y'
								AND soub.CompanyCode = #{CompanyCode}
								GROUP BY UserCode
							) u JOIN (
									SELECT
										*
									FROM legacy_secom.t_secom_workhistory 
									WHERE 1=1
									AND ( bWS = 1 OR bWC= 1 )
							) s 
							ON s.Sabun = u.EmpNo
						) uh LEFT JOIN (
							SELECT
								CommuSeq
								,UserCode ihUserCode
								,WorkDate ihWorkDate
								,bWS ihBWS
								,bWC ihBWC
							FROM 
							covi_smart4j.attendance_commuting_if_history
							WHERE CompanyCode = #{CompanyCode}
						) ih
						ON uh.UserCode = ih.ihUserCode
						AND uh.WorkDate = ih.ihWorkDate
						LEFT JOIN (
							SELECT
								acm.*
								,ach.TargetDate
								,DATE_FORMAT(ach.TargetDate,'%Y%m%d') tfTargetDate
								,ach.StartTime
								,ach.EndTime
								,IFNULL(DATE_FORMAT(ach.StartTime,'%Y%m%d%H%i%s'),0) tfStartTime
								,IFNULL(DATE_FORMAT(ach.EndTime,'%Y%m%d%H%i%s'),0) tfEndTime
								,ach.StartChannel
								,ach.EndChannel
							FROM
							(
								SELECT
									acm.UserCode shUserCode
									,acm.CompanyCode
									,acm.Etc
									,acm.UserEtc
									,MAX(ach.HisSeq) HisSeq
									,acm.CommuSeq aCommuSeq
								FROM
									covi_smart4j.attendance_commuting_mst acm 
									JOIN covi_smart4j.attendance_commuting_history ach
									ON acm.CommuSeq = ach.CommuSeq
									AND acm.CompanyCode = #{CompanyCode}
								GROUP BY acm.UserCode , ach.TargetDate 
							) acm JOIN covi_smart4j.attendance_commuting_history ach
							ON acm.HisSeq = ach.HisSeq
						) h
						ON DATE_FORMAT(uh.WorkDate,'%Y%m%d') = DATE_FORMAT(h.TargetDate,'%Y%m%d') 
						AND uh.UserCode = h.shUserCode
					) a
					WHERE (stYn IS NOT NULL OR etYn IS NOT NULL) 
				) us LEFT JOIN (
						SELECT
							UserCode ehUserCode
							,TargetDate ehTargetDate
							,SUM(ExHoTime) ExHoTime
							,SUM(HTime) HTime
							,SUM(OTime) OTime
							,StartTime exStartTime
							,EndTime exEndTime
						FROM
						(	
							SELECT
								UserCode
								,JobDate TargetDate
								,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60 ExHoTime
								,IF(JobStsName = 'H' ,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60,0) HTime 
								,IF(JobStsName = 'O' ,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60,0) OTime
								,StartTime
								,EndTime
							FROM
								covi_smart4j.attendance_mng_extensionholiday
							WHERE 1=1
							AND CompanyCode = #{CompanyCode}	
							AND IFNULL(ApprovalSts,'')  <>  'N'		-- 연장/휴일 취소승인 시 계산하지 않음			
						) e GROUP BY UserCode ,TargetDate
				) eh
				ON us.UserCode = eh.ehUserCode
				AND us.TargetDate = eh.ehTargetDate
				LEFT JOIN (
					SELECT
						UserCode shmUserCode
						,amsm.ScMemSeq
						,amsm.SchSeq
						,amsm.StartDtm
						,amsm.EndDtm
					FROM
						covi_smart4j.attendance_mng_schedule ams
						JOIN covi_smart4j.attendance_mng_schedule_member amsm	
					WHERE 1=1
						AND amsm.CompanyCode =  #{CompanyCode}
						AND ams.ValidYn = 'Y'
						AND amsm.ValidYn = 'Y'
						AND amsm.SchSeq = ams.SchSeq	
				) shm 
				ON us.UserCode = shm.shmUserCode
				AND us.TargetDate BETWEEN shm.StartDtm AND shm.EndDtm
				LEFT JOIN (
					SELECT
						UR_Code vUserCode
						,Sdate
						,Edate
						,CASE WHEN SUM(VacDay)  >=  1 THEN 1
						ELSE SUM(VacDay) 
						END VacDay
						,CASE 
							WHEN A.SettingValue LIKE CONCAT('%',VacFlag,'%') THEN '연차' 
							WHEN B.SettingValue LIKE CONCAT('%',VacFlag,'%') THEN '반차' 
							WHEN C.SettingValue LIKE CONCAT('%',VacFlag,'%') THEN '경휴' 
							ELSE '일휴'
						END CodeName
					FROM
					(
						SELECT 
							A.*
						FROM covi_smart4j.vm_vacationinfo A
						LEFT JOIN covi_smart4j.sys_base_code C ON A.GUBUN = C.Code
						LEFT JOIN covi_smart4j.sys_base_code D ON A.VacFlag = D.CODE
						WHERE 1=1
						AND C.DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = C.Code ORDER BY IF(DomainID = #{domainID}, 0, 1) LIMIT 1 )
						AND D.DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = D.Code ORDER BY IF(DomainID = #{domainID}, 0, 1) LIMIT 1 )
					) v 
					,(SELECT SettingValue FROM covi_smart4j.sys_base_config WHERE SETTINGKEY = 'VacationType_ANNUAL') A	 	/*연차코드*/
					,(SELECT SettingValue FROM covi_smart4j.sys_base_config WHERE SETTINGKEY = 'VacationType_OFF') B		/*반차코드*/
					,(SELECT SettingValue FROM covi_smart4j.sys_base_config WHERE SETTINGKEY = 'VacationType_CON') C		/*경휴코드*/
						WHERE 1=1
					GROUP BY UR_Code , VacFlag	,Sdate , Edate
					HAVING VacDay  >  0
				) v 
				ON us.UserCode = v.vUserCode
				AND us.TargetDate BETWEEN v.Sdate AND v.Edate
				LEFT JOIN (
					SELECT
						HolidayStart
						,HolidayEnd
					FROM covi_smart4j.attendance_mng_holiday_schedule
					WHERE	CompanyCode = #{CompanyCode}
				) hh
				ON HolidayStart <= us.TargetDate AND HolidayEnd  >=  us.TargetDate
			) u LEFT JOIN covi_smart4j.attendance_mng_schedule ams 
			ON u.userSchSeq = ams.SchSeq
		) R
	]]>
	</select>
	<select id="getAttBatchList3" parameterType = "cmap" resultType= "cmap">
	<![CDATA[ 
		SELECT
			*
			,CASE
				WHEN VacDay  < 1 AND VacDay > 0 THEN 'Y'
			END VacHalfYn
			,CASE
				WHEN (AttDaySts = 'H' OR HolidayStart IS NOT NULL ) THEN 'Y'
				ELSE 'N'
			END HolidayYn
			,IF(ExHoTime IS NOT NULL ,'Y' ,'N' ) ExHoYn
			,IF(VacDay IS NOT NULL ,'Y' ,'N' ) VacationYn
		FROM
		(
			SELECT
				u.*
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN CONCAT(StartMonHour,StartMonMin)
					WHEN WEEKDAY(TargetDate) = 1 THEN CONCAT(StartTueHour,StartTueMin)
					WHEN WEEKDAY(TargetDate) = 2 THEN CONCAT(StartWedHour,StartWedMin)
					WHEN WEEKDAY(TargetDate) = 3 THEN CONCAT(StartThuHour,StartThuMin)
					WHEN WEEKDAY(TargetDate) = 4 THEN CONCAT(StartFriHour,StartFriMin)
					WHEN WEEKDAY(TargetDate) = 5 THEN CONCAT(StartSatHour,StartSatMin)
					WHEN WEEKDAY(TargetDate) = 6 THEN CONCAT(StartSunHour,StartSunMin)
				END AttDayStartTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN CONCAT(EndMonHour,EndMonMin)
					WHEN WEEKDAY(TargetDate) = 1 THEN CONCAT(EndTueHour,EndTueMin)
					WHEN WEEKDAY(TargetDate) = 2 THEN CONCAT(EndWedHour,EndWedMin)
					WHEN WEEKDAY(TargetDate) = 3 THEN CONCAT(EndThuHour,EndThuMin)
					WHEN WEEKDAY(TargetDate) = 4 THEN CONCAT(EndFriHour,EndFriMin)
					WHEN WEEKDAY(TargetDate) = 5 THEN CONCAT(EndSatHour,EndSatMin)
					WHEN WEEKDAY(TargetDate) = 6 THEN CONCAT(EndSunHour,EndSunMin)
				END AttDayEndTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN AttDayStsMon
					WHEN WEEKDAY(TargetDate) = 1 THEN AttDayStsTue
					WHEN WEEKDAY(TargetDate) = 2 THEN AttDayStsWed
					WHEN WEEKDAY(TargetDate) = 3 THEN AttDayStsThu
					WHEN WEEKDAY(TargetDate) = 4 THEN AttDayStsFri
					WHEN WEEKDAY(TargetDate) = 5 THEN AttDayStsSat
					WHEN WEEKDAY(TargetDate) = 6 THEN AttDayStsSun
				END AttDaySts
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN AcMon
					WHEN WEEKDAY(TargetDate) = 1 THEN AcTue
					WHEN WEEKDAY(TargetDate) = 2 THEN AcWed
					WHEN WEEKDAY(TargetDate) = 3 THEN AcThu
					WHEN WEEKDAY(TargetDate) = 4 THEN AcFri
					WHEN WEEKDAY(TargetDate) = 5 THEN AcSat
					WHEN WEEKDAY(TargetDate) = 6 THEN AcSun
				END AcDayTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN IdleMon
					WHEN WEEKDAY(TargetDate) = 1 THEN IdleTue
					WHEN WEEKDAY(TargetDate) = 2 THEN IdleWed
					WHEN WEEKDAY(TargetDate) = 3 THEN IdleThu
					WHEN WEEKDAY(TargetDate) = 4 THEN IdleFri
					WHEN WEEKDAY(TargetDate) = 5 THEN IdleSat
					WHEN WEEKDAY(TargetDate) = 6 THEN IdleSun
				END IdleDayTime
			FROM
			(
				SELECT
					us.*		/*user 기본정보*/
					,eh.*		/*연장휴일근무*/
					,v.*		/*휴가*/
					,hh.*		/*회사휴무일*/
					,CASE
						WHEN shm.SchSeq IS NOT NULL THEN shm.SchSeq
						ELSE (SELECT SchSeq FROM covi_smart4j.attendance_mng_schedule WHERE CompanyCode = #{CompanyCode} AND ValidYn = 'Y' AND BaseYn = 'Y')
					END userSchSeq	/*해당일 등록 된 근무제 seq*/
				FROM
				(	
					SELECT
						*
					FROM
					(
						SELECT
							UserCode
							,WSTime
							,WCTime
							,bWS
							,bWC
							,IF(tfStartTime = IF(WSTime='',CONCAT(WorkDate,'000000'),WSTime),NULL,IF(WSTime='',CONCAT(WorkDate,'000000'),WSTime)) StartTime
							,CASE
								WHEN NowYn = 'Y' THEN
									IF(tfEndTime = IF(WCTime='',NULL,WCTime),NULL,IF(WCTime='',NULL,WCTime)) 
								ELSE
									IF(tfEndTime = IF(WCTime='',CONCAT(WorkDate,'235959'),WCTime),NULL,IF(WCTime='',CONCAT(WorkDate,'235959'),WCTime)) 
							END EndTime
							,IF(tfStartTime = IF(WSTime='',CONCAT(WorkDate,'000000'),WSTime),tfStartTime,IF(WSTime='',CONCAT(WorkDate,'000000'),WSTime)) EnStartTime
							,DATE_FORMAT(WorkDate,'%Y-%m-%d') TargetDate
							,IF(CommuSeq IS NULL,aCommuSeq,CommuSeq) CommuSeq
							,tfStartTime
							,tfEndTime
							,HisSeq
							,NowYn
							,ChangeYn
			 			FROM
						(
							SELECT
								u.UserCode
								,s.bWS
								,s.bWC
								,s.WSTime
								,s.WCTime
								,WorkDate
								,CASE WHEN DATE_FORMAT(now(),'%Y%m%d') = WorkDate THEN 'Y'
										ELSE 'N'
								END NowYn
							FROM
							(
								SELECT 
									sou.UserCode 
									,EmpNo
								FROM
									covi_smart4j.sys_object_user_basegroup soub
									JOIN covi_smart4j.sys_object_user sou
									ON soub.UserCode = sou.UserCode
								WHERE 1=1
								AND sou.IsUse ='Y'
								AND sou.IsDisplay ='Y'
								AND soub.CompanyCode = #{CompanyCode}
								GROUP BY UserCode
							) u JOIN (
									SELECT
										*
									FROM legacy_secom.t_secom_workhistory 
									WHERE 1=1
									AND ( bWS = 1 OR bWC= 1 )
							) s 
							ON s.Sabun = u.EmpNo
						) uh LEFT JOIN (
							SELECT
								acm.*
								,ach.TargetDate
								,DATE_FORMAT(ach.TargetDate,'%Y%m%d') tfTargetDate
								,ach.StartTime
								,ach.EndTime
								,IFNULL(DATE_FORMAT(ach.StartTime,'%Y%m%d%H%i%s'),null) tfStartTime
								,IFNULL(DATE_FORMAT(ach.EndTime,'%Y%m%d%H%i%s'),null) tfEndTime
								,ach.StartChannel
								,ach.EndChannel
							FROM
							(
								SELECT
									acm.UserCode shUserCode
									,acm.CompanyCode
									,acm.Etc
									,acm.UserEtc
									,MAX(ach.HisSeq) HisSeq
									,acm.CommuSeq aCommuSeq
									,ach.ChangeYn
									,ach.CommuSeq
								FROM
									covi_smart4j.attendance_commuting_mst acm 
									JOIN covi_smart4j.attendance_commuting_history ach
									ON acm.CommuSeq = ach.CommuSeq
									AND acm.CompanyCode = #{CompanyCode}
								GROUP BY acm.UserCode , ach.TargetDate 
							) acm JOIN covi_smart4j.attendance_commuting_history ach
							ON acm.HisSeq = ach.HisSeq
						) h
						ON DATE_FORMAT(uh.WorkDate,'%Y%m%d') = DATE_FORMAT(h.TargetDate,'%Y%m%d') 
						AND uh.UserCode = h.shUserCode
					) R
					WHERE 1=1
					AND (StartTime IS NOT NULL OR EndTime IS NOT NULL )
					AND ChangeYn IS NULL 	
				) us LEFT JOIN (
						SELECT
							UserCode ehUserCode
							,TargetDate ehTargetDate
							,SUM(ExHoTime) ExHoTime
							,SUM(HTime) HTime
							,SUM(OTime) OTime
							,StartTime exStartTime
							,EndTime exEndTime
						FROM
						(	
							SELECT
								UserCode
								,JobDate TargetDate
								,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60 ExHoTime
								,IF(JobStsName = 'H' ,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60,0) HTime 
								,IF(JobStsName = 'O' ,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60,0) OTime
								,StartTime
								,EndTime
							FROM
								covi_smart4j.attendance_mng_extensionholiday
							WHERE 1=1
							AND CompanyCode = #{CompanyCode}	
							AND IFNULL(ApprovalSts,'')  <>  'N'		-- 연장/휴일 취소승인 시 계산하지 않음			
						) e GROUP BY UserCode ,TargetDate
				) eh
				ON us.UserCode = eh.ehUserCode
				AND us.TargetDate = eh.ehTargetDate
				LEFT JOIN (
					SELECT
						UserCode shmUserCode
						,amsm.ScMemSeq
						,amsm.SchSeq
						,amsm.StartDtm
						,amsm.EndDtm
					FROM
						covi_smart4j.attendance_mng_schedule ams
						JOIN covi_smart4j.attendance_mng_schedule_member amsm	
					WHERE 1=1
						AND amsm.CompanyCode =  #{CompanyCode}
						AND ams.ValidYn = 'Y'
						AND amsm.ValidYn = 'Y'
						AND amsm.SchSeq = ams.SchSeq	
				) shm 
				ON us.UserCode = shm.shmUserCode
				AND us.TargetDate BETWEEN shm.StartDtm AND shm.EndDtm
				LEFT JOIN (
					SELECT
						UR_Code vUserCode
						,Sdate
						,Edate
						,CASE WHEN SUM(VacDay)  >=  1 THEN 1
						ELSE SUM(VacDay) 
						END VacDay
						,CASE 
							WHEN A.SettingValue LIKE CONCAT('%',VacFlag,'%') THEN '연차' 
							WHEN B.SettingValue LIKE CONCAT('%',VacFlag,'%') THEN '반차' 
							WHEN C.SettingValue LIKE CONCAT('%',VacFlag,'%') THEN '경휴' 
							ELSE '일휴'
						END CodeName
					FROM
					(
						SELECT 
							A.*
						FROM covi_smart4j.vm_vacationinfo A
						LEFT JOIN covi_smart4j.sys_base_code C ON A.GUBUN = C.Code
						LEFT JOIN covi_smart4j.sys_base_code D ON A.VacFlag = D.CODE
						WHERE 1=1
						AND C.DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = C.Code ORDER BY IF(DomainID = #{domainID}, 0, 1) LIMIT 1 )
						AND D.DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = D.Code ORDER BY IF(DomainID = #{domainID}, 0, 1) LIMIT 1 )
					) v 
					,(SELECT SettingValue FROM covi_smart4j.sys_base_config WHERE SETTINGKEY = 'VacationType_ANNUAL') A	 	/*연차코드*/
					,(SELECT SettingValue FROM covi_smart4j.sys_base_config WHERE SETTINGKEY = 'VacationType_OFF') B		/*반차코드*/
					,(SELECT SettingValue FROM covi_smart4j.sys_base_config WHERE SETTINGKEY = 'VacationType_CON') C		/*경휴코드*/
						WHERE 1=1
					GROUP BY UR_Code , VacFlag	,Sdate , Edate
					HAVING VacDay  >  0
				) v 
				ON us.UserCode = v.vUserCode
				AND us.TargetDate BETWEEN v.Sdate AND v.Edate
				LEFT JOIN (
					SELECT
						HolidayStart
						,HolidayEnd
					FROM covi_smart4j.attendance_mng_holiday_schedule
					WHERE	CompanyCode = #{CompanyCode}
				) hh
				ON HolidayStart <= us.TargetDate AND HolidayEnd  >=  us.TargetDate
			) u LEFT JOIN attendance_mng_schedule ams 
			ON u.userSchSeq = ams.SchSeq
		) R
	]]>
	</select>
	<select id="getAttBatchList4" parameterType = "cmap" resultType= "cmap">
		<![CDATA[ 
		SELECT
			TargetDate
			,UserCode
			,eStartTime StartTime
			,eEndTime EndTime
			,eStartTime EnStartTime
			,tfStartTime
			,tfEndTime
			,bWS
			,bWC
			,HisChangeYn
			,WD
			,CommuSeq
			,HisSeq
			,ExHoTime
			,HTime
			,OTime
			,exStartTime
			,exEndTime
			,VacDay
			,CodeName
			,HolidayStart
			,HolidayEnd
			,AttDayStartTime
			,AttDayEndTime
			,AttDaySts
			,AcDayTime
			,IdleDayTime
			,userSchSeq
			,CASE
				WHEN VacDay  < 1 AND VacDay > 0 THEN 'Y'
			END VacHalfYn
			,CASE
				WHEN (AttDaySts = 'H' OR HolidayStart IS NOT NULL ) THEN 'Y'
				ELSE 'N'
			END HolidayYn
			,IF(ExHoTime IS NOT NULL ,'Y' ,'N' ) ExHoYn
			,IF(VacDay IS NOT NULL ,'Y' ,'N' ) VacationYn
		FROM
		(
			SELECT
				u.*
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN CONCAT(StartMonHour,StartMonMin)
					WHEN WEEKDAY(TargetDate) = 1 THEN CONCAT(StartTueHour,StartTueMin)
					WHEN WEEKDAY(TargetDate) = 2 THEN CONCAT(StartWedHour,StartWedMin)
					WHEN WEEKDAY(TargetDate) = 3 THEN CONCAT(StartThuHour,StartThuMin)
					WHEN WEEKDAY(TargetDate) = 4 THEN CONCAT(StartFriHour,StartFriMin)
					WHEN WEEKDAY(TargetDate) = 5 THEN CONCAT(StartSatHour,StartSatMin)
					WHEN WEEKDAY(TargetDate) = 6 THEN CONCAT(StartSunHour,StartSunMin)
				END AttDayStartTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN CONCAT(EndMonHour,EndMonMin)
					WHEN WEEKDAY(TargetDate) = 1 THEN CONCAT(EndTueHour,EndTueMin)
					WHEN WEEKDAY(TargetDate) = 2 THEN CONCAT(EndWedHour,EndWedMin)
					WHEN WEEKDAY(TargetDate) = 3 THEN CONCAT(EndThuHour,EndThuMin)
					WHEN WEEKDAY(TargetDate) = 4 THEN CONCAT(EndFriHour,EndFriMin)
					WHEN WEEKDAY(TargetDate) = 5 THEN CONCAT(EndSatHour,EndSatMin)
					WHEN WEEKDAY(TargetDate) = 6 THEN CONCAT(EndSunHour,EndSunMin)
				END AttDayEndTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN AttDayStsMon
					WHEN WEEKDAY(TargetDate) = 1 THEN AttDayStsTue
					WHEN WEEKDAY(TargetDate) = 2 THEN AttDayStsWed
					WHEN WEEKDAY(TargetDate) = 3 THEN AttDayStsThu
					WHEN WEEKDAY(TargetDate) = 4 THEN AttDayStsFri
					WHEN WEEKDAY(TargetDate) = 5 THEN AttDayStsSat
					WHEN WEEKDAY(TargetDate) = 6 THEN AttDayStsSun
				END AttDaySts
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN AcMon
					WHEN WEEKDAY(TargetDate) = 1 THEN AcTue
					WHEN WEEKDAY(TargetDate) = 2 THEN AcWed
					WHEN WEEKDAY(TargetDate) = 3 THEN AcThu
					WHEN WEEKDAY(TargetDate) = 4 THEN AcFri
					WHEN WEEKDAY(TargetDate) = 5 THEN AcSat
					WHEN WEEKDAY(TargetDate) = 6 THEN AcSun
				END AcDayTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN IdleMon
					WHEN WEEKDAY(TargetDate) = 1 THEN IdleTue
					WHEN WEEKDAY(TargetDate) = 2 THEN IdleWed
					WHEN WEEKDAY(TargetDate) = 3 THEN IdleThu
					WHEN WEEKDAY(TargetDate) = 4 THEN IdleFri
					WHEN WEEKDAY(TargetDate) = 5 THEN IdleSat
					WHEN WEEKDAY(TargetDate) = 6 THEN IdleSun
				END IdleDayTime
			FROM
			(
				SELECT
					TargetDate
					,UserCode
					,StartTime
					,EndTime
					,HisChangeYn
					,CommuSeq
					,HisSeq
					,tfStartTime
					,tfEndTime
					,bWS
					,bWC
					,WD
					,IF(StartTime = '99991231235959' ,CONCAT(TargetDate,'000000'),StartTime) AS eStartTime
					,CASE
						WHEN WD IS NOT NULL THEN 	#해당일 이후 데이터가 있는지 여부
							IF(EndTime = '00000000000000' ,CONCAT(TargetDate,'235959'),EndTime)
						ELSE
							IF(EndTime = '00000000000000' ,NULL,EndTime)
					END eEndTime
					,CASE
						WHEN shm.SchSeq IS NOT NULL THEN shm.SchSeq
						ELSE (SELECT SchSeq FROM covi_smart4j.attendance_mng_schedule WHERE CompanyCode = #{CompanyCode} AND ValidYn = 'Y' AND BaseYn = 'Y')
					END userSchSeq
					,eh.*		/*연장휴일근무*/
					,v.*		/*휴가*/
					,hh.*		/*회사휴무일*/
				FROM
				(	
					SELECT
						TargetDate
						,UserCode
						,StartTime
						,EndTime
						,HisChangeYn
						,CommuSeq
						,HisSeq
						,tfStartTime
						,tfEndTime
						,EmpNo
						,bWS
						,bWC
						,(SELECT MIN(WorkDate) WorkDate FROM legacy_secom.t_secom_workhistory WHERE Sabun = EmpNo AND WorkDate > TargetDate AND ( bWS = 1 OR bWC= 1 )) WD
					FROM
					(
						SELECT
							TargetDate
							,UserCode
							,MIN(StartTime) AS StartTime
							,MAX(EndTime) AS EndTime
							,MAX(HisChangeYn) AS HisChangeYn
							,EmpNo
							,MAX(bWS) AS bWS
							,MAX(bWC) AS bWC
						FROM
						(
							SELECT
								ls.WorkDate TargetDate
								,IF(ls.WSTime='','99991231235959',WSTime)	StartTime
								,IF(ls.WCTime='','00000000000000',WCTime)	EndTime
								,us.UserCode
								,NULL AS HisChangeYn 
								,EmpNo
								,bWS
								,bWC
							FROM
							(
								SELECT
									WorkDate
									,WSTime
									,WCTime
									,Sabun
									,bWS
									,bWC
								FROM legacy_secom.t_secom_workhistory 
								WHERE 1=1
								AND ( bWS = 1 OR bWC= 1 )
							) ls JOIN (	
								SELECT 
									sou.UserCode 
									,EmpNo
								FROM
									covi_smart4j.sys_object_user_basegroup soub
									JOIN covi_smart4j.sys_object_user sou
									ON soub.UserCode = sou.UserCode
								WHERE 1=1
								AND sou.IsUse ='Y'
								AND sou.IsDisplay ='Y'
								AND soub.CompanyCode = #{CompanyCode}
								#AND sou.UserCode = 'baek61'
								GROUP BY UserCode
							) us ON ls.Sabun = us.EmpNo
							UNION
							SELECT
								IFNULL(DATE_FORMAT(ach.TargetDate,'%Y%m%d'),NULL) TargetDate 
								,IFNULL(DATE_FORMAT(ach.StartTime,'%Y%m%d%H%i%s'),'99991231235959') StartTime
								,IFNULL(DATE_FORMAT(ach.EndTime,'%Y%m%d%H%i%s'),'00000000000000') EndTime
								,acm.UserCode 
								,ChangeYn AS HisChangeYn
								,acsu.EmpNo 
								,0 bWS
								,0 bWC
							FROM
								covi_smart4j.attendance_commuting_mst acm 
								JOIN covi_smart4j.attendance_commuting_history ach
								ON acm.CommuSeq = ach.CommuSeq
								AND acm.CompanyCode = #{CompanyCode}	
								LEFT JOIN covi_smart4j.sys_object_user acsu
								ON acm.UserCode  = acsu.UserCode
								#WHERE UserCode = 'baek61'
							GROUP BY acm.UserCode , ach.TargetDate 
						) al
						GROUP BY TargetDate,UserCode
					) secom LEFT JOIN (
						SELECT
							acm.UserCode shUserCode
							,ach.ChangeYn
							,ach.CommuSeq
							,HisSeq
							,ach.TargetDate shTargetDate
							,IFNULL(DATE_FORMAT(ach.StartTime,'%Y%m%d%H%i%s'),NULL) tfStartTime
							,IFNULL(DATE_FORMAT(ach.EndTime,'%Y%m%d%H%i%s'),NULL) tfEndTime
						FROM
							covi_smart4j.attendance_commuting_mst acm 
							JOIN covi_smart4j.attendance_commuting_history ach
							ON acm.CommuSeq = ach.CommuSeq
							AND acm.CompanyCode = #{CompanyCode}	
						GROUP BY acm.UserCode , ach.TargetDate 
					) h
					ON DATE_FORMAT(secom.TargetDate,'%Y%m%d') = DATE_FORMAT(h.shTargetDate,'%Y%m%d') 
					AND secom.UserCode = h.shUserCode
					WHERE StartTime <> IFNULL(tfStartTime,'99991231235959') OR EndTime <> IFNULL(tfEndTime,'00000000000000')
				) us LEFT JOIN (
					SELECT
						UserCode ehUserCode
						,TargetDate ehTargetDate
						,SUM(ExHoTime) ExHoTime
						,SUM(HTime) HTime
						,SUM(OTime) OTime
						,StartTime exStartTime
						,EndTime exEndTime
					FROM
					(	
						SELECT
							UserCode
							,JobDate TargetDate
							,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60 ExHoTime
							,IF(JobStsName = 'H' ,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60,0) HTime 
							,IF(JobStsName = 'O' ,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60,0) OTime
							,StartTime
							,EndTime
						FROM
							covi_smart4j.attendance_mng_extensionholiday
						WHERE 1=1
						AND CompanyCode = #{CompanyCode}	
						AND IFNULL(ApprovalSts,'')  <>  'N'		-- 연장/휴일 취소승인 시 계산하지 않음			
					) e GROUP BY UserCode ,TargetDate
					) eh
					ON us.UserCode = eh.ehUserCode
					AND us.TargetDate = eh.ehTargetDate
					LEFT JOIN (
						SELECT
							UserCode shmUserCode
							,amsm.ScMemSeq
							,amsm.SchSeq
							,amsm.StartDtm
							,amsm.EndDtm
						FROM
							covi_smart4j.attendance_mng_schedule ams
							JOIN covi_smart4j.attendance_mng_schedule_member amsm	
							WHERE 1=1
								AND amsm.CompanyCode =  #{CompanyCode}
								AND ams.ValidYn = 'Y'
								AND amsm.ValidYn = 'Y'
								AND amsm.SchSeq = ams.SchSeq	
					) shm 
						ON us.UserCode = shm.shmUserCode
						AND us.TargetDate BETWEEN shm.StartDtm AND shm.EndDtm
					LEFT JOIN (
						SELECT
							UR_Code vUserCode
							,Sdate
							,Edate
							,CASE WHEN SUM(VacDay)  >=  1 THEN 1
							ELSE SUM(VacDay) 
							END VacDay
							,CASE 
								WHEN A.SettingValue LIKE CONCAT('%',VacFlag,'%') THEN '연차' 
								WHEN B.SettingValue LIKE CONCAT('%',VacFlag,'%') THEN '반차' 
								WHEN C.SettingValue LIKE CONCAT('%',VacFlag,'%') THEN '경휴' 
								ELSE '일휴'
							END CodeName
						FROM
							(
								SELECT 
									A.*
								FROM covi_smart4j.vm_vacationinfo A
								LEFT JOIN covi_smart4j.sys_base_code C ON A.GUBUN = C.CODE AND A.VacFlag = C.CODE  
								WHERE 1=1
								AND C.DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = C.Code ORDER BY IF(DomainID = #{domainID}, 0, 1) LIMIT 1 )
							) v
							,(SELECT SettingValue FROM covi_smart4j.sys_base_config WHERE SETTINGKEY = 'VacationType_ANNUAL') A	 	/*연차코드*/
							,(SELECT SettingValue FROM covi_smart4j.sys_base_config WHERE SETTINGKEY = 'VacationType_OFF') B		/*반차코드*/
							,(SELECT SettingValue FROM covi_smart4j.sys_base_config WHERE SETTINGKEY = 'VacationType_CON') C		/*경휴코드*/
								WHERE 1=1
								GROUP BY UR_Code , CodeName	,Sdate , Edate
								HAVING VacDay  >  0
						) v  	ON us.UserCode = v.vUserCode
								AND us.TargetDate BETWEEN v.Sdate AND v.Edate
					LEFT JOIN (
							SELECT
								HolidayStart
								,HolidayEnd
							FROM covi_smart4j.attendance_mng_holiday_schedule
								WHERE	CompanyCode = #{CompanyCode}
						) hh ON HolidayStart <= us.TargetDate AND HolidayEnd  >=  us.TargetDate
				) u LEFT JOIN attendance_mng_schedule ams 	ON u.userSchSeq = ams.SchSeq
			) us 	WHERE HisChangeYn IS NULL OR (HisChangeYn = 'Y' AND WD IS NOT NULL )
		]]>
	</select>
	
	
	<select id="getNullInEndTimeList" statementType="CALLABLE" parameterType= "cmap" resultType= "cmap" >
	 	{CALL covi_smart4j.sp_attendance_getNotEndList(#{CompanyCode , mode=IN, jdbcType=VARCHAR})}
	</select>
	
	<update id="updNotEndCommute" parameterType="cmap">
		UPDATE covi_smart4j.attendance_commuting_history SET
			DisplayEndSts = #{DisplayEndSts}
			,EndTime = #{EndDate}
			,EndBatchYn = #{EndBatchYn}
			,EndChannel = #{EndChannel}
			,EndSts = #{EndSts}
			,EndColSts = NULL
		WHERE
			CommuSeq = #{CommuSeq}
	</update>
	
	<select id="getAttBatchList5" parameterType = "cmap" resultType= "cmap">
	<![CDATA[ 
		SELECT
			*
			,CASE
				WHEN VacDay  < 1 AND VacDay > 0 THEN 'Y'
			END VacHalfYn
			,CASE
				WHEN (AttDaySts = 'H' OR HolidayStart IS NOT NULL ) THEN 'Y'
				ELSE 'N'
			END HolidayYn
			,IF(ExHoTime IS NOT NULL ,'Y' ,'N' ) ExHoYn
			,IF(VacDay IS NOT NULL ,'Y' ,'N' ) VacationYn
			,HTime
			,EnStartTime
		FROM
		(
			SELECT
				u.UserCode
				,u.WorkDate
				,u.TargetDate
				,bWS
				,bWC
				,StartTime
				,StartBatchYn
				,EndTime
				,userSchSeq
				,VacDay
				,ExHoTime
				,HolidayStart
				,HTime
				,CommuSeq
				,HisSeq
				,exStartTime
				,exEndTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN CONCAT(StartMonHour,StartMonMin)
					WHEN WEEKDAY(TargetDate) = 1 THEN CONCAT(StartTueHour,StartTueMin)
					WHEN WEEKDAY(TargetDate) = 2 THEN CONCAT(StartWedHour,StartWedMin)
					WHEN WEEKDAY(TargetDate) = 3 THEN CONCAT(StartThuHour,StartThuMin)
					WHEN WEEKDAY(TargetDate) = 4 THEN CONCAT(StartFriHour,StartFriMin)
					WHEN WEEKDAY(TargetDate) = 5 THEN CONCAT(StartSatHour,StartSatMin)
					WHEN WEEKDAY(TargetDate) = 6 THEN CONCAT(StartSunHour,StartSunMin)
				END AttDayStartTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN CONCAT(EndMonHour,EndMonMin)
					WHEN WEEKDAY(TargetDate) = 1 THEN CONCAT(EndTueHour,EndTueMin)
					WHEN WEEKDAY(TargetDate) = 2 THEN CONCAT(EndWedHour,EndWedMin)
					WHEN WEEKDAY(TargetDate) = 3 THEN CONCAT(EndThuHour,EndThuMin)
					WHEN WEEKDAY(TargetDate) = 4 THEN CONCAT(EndFriHour,EndFriMin)
					WHEN WEEKDAY(TargetDate) = 5 THEN CONCAT(EndSatHour,EndSatMin)
					WHEN WEEKDAY(TargetDate) = 6 THEN CONCAT(EndSunHour,EndSunMin)
				END AttDayEndTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN AttDayStsMon
					WHEN WEEKDAY(TargetDate) = 1 THEN AttDayStsTue
					WHEN WEEKDAY(TargetDate) = 2 THEN AttDayStsWed
					WHEN WEEKDAY(TargetDate) = 3 THEN AttDayStsThu
					WHEN WEEKDAY(TargetDate) = 4 THEN AttDayStsFri
					WHEN WEEKDAY(TargetDate) = 5 THEN AttDayStsSat
					WHEN WEEKDAY(TargetDate) = 6 THEN AttDayStsSun
				END AttDaySts
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN AcMon
					WHEN WEEKDAY(TargetDate) = 1 THEN AcTue
					WHEN WEEKDAY(TargetDate) = 2 THEN AcWed
					WHEN WEEKDAY(TargetDate) = 3 THEN AcThu
					WHEN WEEKDAY(TargetDate) = 4 THEN AcFri
					WHEN WEEKDAY(TargetDate) = 5 THEN AcSat
					WHEN WEEKDAY(TargetDate) = 6 THEN AcSun
				END AcDayTime
				,CASE
					WHEN WEEKDAY(TargetDate) = 0 THEN IdleMon
					WHEN WEEKDAY(TargetDate) = 1 THEN IdleTue
					WHEN WEEKDAY(TargetDate) = 2 THEN IdleWed
					WHEN WEEKDAY(TargetDate) = 3 THEN IdleThu
					WHEN WEEKDAY(TargetDate) = 4 THEN IdleFri
					WHEN WEEKDAY(TargetDate) = 5 THEN IdleSat
					WHEN WEEKDAY(TargetDate) = 6 THEN IdleSun
				END IdleDayTime
				,EnStartTime
			FROM
			(
				SELECT
					*
					,CASE
						WHEN shm.SchSeq IS NOT NULL THEN shm.SchSeq
						ELSE (SELECT SchSeq FROM covi_smart4j.attendance_mng_schedule WHERE CompanyCode = #{CompanyCode} AND ValidYn = 'Y' AND BaseYn = 'Y')
					END userSchSeq
				FROM
				(	
					SELECT
						TargetDate
						,WorkDate
						,UserCode
						,CommuSeq
						,HisSeq
						,bWS
						,bWC
						,IF(StartTime <> IFNULL(tfStartTime,'') , StartTime , NULL) StartTime
						,StartBatchYn
						,IF(EndTime <> IFNULL(tfEndTime,'') , EndTime , NULL) EndTime
						,StartTime EnStartTime
					FROM
					(
						SELECT
							WorkDate
							,STR_TO_DATE(WorkDate,'%Y%m%d') AS TargetDate
							,acsu.UserCode
							,CommuSeq
							,HisSeq
							,StartChangeYn
							,EndChangeYn
							,bWS
							,bWC
							,CASE
								WHEN bWS = 0 THEN
									IF(StartTime IS NULL , WSTime , tfStartTime ) 
								WHEN bWS = 1 THEN
									IF(StartTime IS NULL , WSTime , IF(WSTime < tfStartTime , WSTime , tfStartTime ) )
							END AS StartTime
							,CASE
								WHEN bWS = 0 THEN
									IF(StartTime IS NULL , 'Y' , NULL ) 
								WHEN bWS = 1 THEN NULL
							END AS StartBatchYn
							,CASE
								WHEN bWC = 0 THEN tfEndTime
								WHEN bWC = 1 THEN
									IF(EndTime IS NULL , WCTime , IF(WCTime > tfEndTime , WCTime , tfEndTime ) )
							END AS EndTime			
							,tfStartTime
							,tfEndTime
						FROM
						(
							SELECT
								WorkDate
								,IF(WSTime = '' AND WCTime != '' , CONCAT(WorkDate,'000000') ,WSTime ) WSTime
								,WCTime
								,Sabun
								,bWS
								,bWC 
							FROM legacy_secom.t_secom_workhistory 
							,(SELECT SettingValue FROM covi_smart4j.SYS_BASE_CONFIG WHERE SETTINGKEY = 'AttendanceBatchDay') A
							WHERE ( bWS = 1 OR bWC= 1 )
							AND Sabun != ''
							AND WorkDate BETWEEN DATE_FORMAT(DATE_SUB(NOW(),INTERVAL SettingValue DAY),'%Y%m%d') AND DATE_FORMAT(DATE_ADD(NOW(),INTERVAL SettingValue DAY),'%Y%m%d') 
						) secom JOIN (
							SELECT sou.UserCode,EmpNo ,CompanyCode FROM covi_smart4j.sys_object_user sou
									JOIN covi_smart4j.sys_object_user_basegroup soub
									ON soub.UserCode = sou.UserCode
								WHERE CompanyCode = #{CompanyCode}
							GROUP BY UserCode
						) acsu ON secom.Sabun = acsu.EmpNo 	
						LEFT JOIN (
							SELECT
								acm.CommuSeq
								,ach.HisSeq
								,acm.TargetDate
								,DATE_FORMAT(acm.TargetDate,'%Y%m%d') AS F_TargetDate
								,acm.UserCode
								,ach.StartChangeYn
								,ach.EndChangeYn
								,ach.StartTime
								,ach.EndTime
								,DATE_FORMAT(ach.StartTime,'%Y%m%d%H%i%s') tfStartTime
								,DATE_FORMAT(ach.EndTime,'%Y%m%d%H%i%s') tfEndTime 
							FROM
								covi_smart4j.attendance_commuting_mst acm #/*! use index(CompanyCode) */
								JOIN covi_smart4j.attendance_commuting_history ach
								ON acm.CommuSeq = ach.CommuSeq
								AND acm.CompanyCode = #{CompanyCode}	
								,(SELECT SettingValue FROM covi_smart4j.SYS_BASE_CONFIG WHERE SETTINGKEY = 'AttendanceBatchDay') A
								WHERE acm.TargetDate BETWEEN DATE_FORMAT(DATE_SUB(NOW(),INTERVAL SettingValue DAY),'%Y-%m-%d') AND DATE_FORMAT(DATE_ADD(NOW(),INTERVAL SettingValue DAY),'%Y-%m-%d') 
						) comm 
						ON secom.WorkDate = comm.F_TargetDate
						AND comm.UserCode  = acsu.UserCode
					) se
					WHERE ( StartChangeYn IS NULL AND StartTime <> IFNULL(tfStartTime,'') )
					OR ( EndChangeYn IS NULL AND IFNULL(EndTime,'') <> IFNULL(tfEndTime,'') )
				) us LEFT JOIN (
					SELECT
						UserCode ehUserCode
						,TargetDate ehTargetDate
						,SUM(ExHoTime) ExHoTime
						,SUM(HTime) HTime
						,SUM(OTime) OTime
						,StartTime exStartTime
						,EndTime exEndTime
					FROM
					(	
						SELECT
							UserCode
							,JobDate TargetDate
							,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60 ExHoTime
							,IF(JobStsName = 'H' ,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60,0) HTime 
							,IF(JobStsName = 'O' ,SUBSTRING(WorkTime,1,2)*60*60 + SUBSTRING(WorkTime,3,2)*60,0) OTime
							,StartTime
							,EndTime
						FROM
							covi_smart4j.attendance_mng_extensionholiday
						WHERE 1=1
						AND CompanyCode =#{CompanyCode}
						AND IFNULL(ApprovalSts,'')  <>  'N'		-- 연장/휴일 취소승인 시 계산하지 않음			
					) e GROUP BY UserCode ,TargetDate
					) eh
					ON us.UserCode = eh.ehUserCode
					AND us.TargetDate = eh.ehTargetDate
					LEFT JOIN (
						SELECT
							UserCode shmUserCode
							,amsm.ScMemSeq
							,amsm.SchSeq
							,amsm.StartDtm
							,amsm.EndDtm
						FROM
							covi_smart4j.attendance_mng_schedule ams
							LEFT JOIN covi_smart4j.attendance_mng_schedule_member amsm	
							ON ams.SchSeq = amsm.SchSeq
							WHERE 1=1
								AND amsm.CompanyCode =  #{CompanyCode}
								AND ams.ValidYn = 'Y'
								AND amsm.ValidYn = 'Y'
								AND amsm.SchSeq = ams.SchSeq	
					) shm 
						ON us.UserCode = shm.shmUserCode
						AND us.TargetDate BETWEEN shm.StartDtm AND shm.EndDtm
					LEFT JOIN (
						SELECT
							UR_Code vUserCode
							,Sdate
							,Edate
							,CASE WHEN SUM(VacDay)  >=  1 THEN 1
							ELSE SUM(VacDay) 
							END VacDay
						FROM
							(
							SELECT 
								A.*
							FROM covi_smart4j.vm_vacationinfo A
							,(SELECT SettingValue FROM covi_smart4j.SYS_BASE_CONFIG WHERE SETTINGKEY = 'AttendanceBatchDay') A
							WHERE
							(
								Sdate between DATE_FORMAT(DATE_SUB(NOW(),INTERVAL SettingValue DAY),'%Y-%m-%d') AND  DATE_FORMAT(DATE_ADD(NOW(),INTERVAL SettingValue DAY),'%Y-%m-%d')
								OR Edate between DATE_FORMAT(DATE_SUB(NOW(),INTERVAL SettingValue DAY),'%Y-%m-%d') AND  DATE_FORMAT(DATE_ADD(NOW(),INTERVAL SettingValue DAY),'%Y-%m-%d')
								OR DATE_FORMAT(DATE_ADD(NOW(),INTERVAL SettingValue DAY),'%Y-%m-%d') BETWEEN Sdate AND Edate
								OR DATE_FORMAT(DATE_SUB(NOW(),INTERVAL SettingValue DAY),'%Y-%m-%d') BETWEEN Sdate AND Edate
								)
							) v
								WHERE 1=1
								GROUP BY UR_Code ,Sdate , Edate
								HAVING VacDay  >  0
						) v  	ON us.UserCode = v.vUserCode
								AND us.TargetDate BETWEEN v.Sdate AND v.Edate
					LEFT JOIN (
							SELECT
								HolidayStart
								,HolidayEnd
							FROM covi_smart4j.attendance_mng_holiday_schedule
								WHERE	CompanyCode = #{CompanyCode}
						) hh ON HolidayStart <= us.TargetDate AND HolidayEnd  >=  us.TargetDate
			) u LEFT JOIN covi_smart4j.attendance_mng_schedule ams 	ON u.userSchSeq = ams.SchSeq
		) ls
	]]>
	</select>


	<select id="getPCAttBatchList" statementType="CALLABLE" parameterType= "cmap" resultType= "cmap" >
	 	{CALL covi_smart4j.sp_attendance_getIFList(#{CompanyCode , mode=IN, jdbcType=VARCHAR})}
	</select>
	
</mapper>

