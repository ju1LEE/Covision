<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="collab.project">
	<sql id="searchMyTask">
		<!--내용 검색 -->
		<if test="searchOption != null and  searchOption !=''">
			<if test="searchOption eq '1'.toString() and searchWord != '' and searchWord != ''">
				AND B.TaskName LIKE CONCAT('%',#{searchWord},'%')
			</if>
			<if test="searchOption eq '2'.toString() and searchWord != '' and searchWord != ''">
				AND B.Remark LIKE CONCAT('%',#{searchWord},'%')
			</if>
			<if test="searchOption eq '3'.toString() and searchWord != '' and searchWord != ''">
				AND (B.TaskName LIKE CONCAT('%',#{searchWord},'%') OR B.Remark LIKE CONCAT('%',#{searchWord},'%')
				 OR B.TaskSeq IN (SELECT TaskSeq FROM collab_task_tag t WHERE b.taskseq = b.taskseq AND t.tagName LIKE  CONCAT('%',#{searchWord},'%')))
			</if>
			<if test="searchOption eq '4'.toString() and searchWord != '' and searchWord != ''">
			    AND B.TaskSeq IN (SELECT TaskSeq FROM collab_task_tag t WHERE b.taskseq = b.taskseq AND t.tagName LIKE  CONCAT('%',#{searchWord},'%'))
			</if>
		</if>
		<if test="searchText != null and  searchText !=''">
			AND (B.TaskName LIKE CONCAT('%',#{searchText},'%') 
			 OR B.Remark LIKE CONCAT('%',#{searchText},'%')
			 OR B.TaskSeq IN (SELECT TaskSeq FROM collab_task_tag t WHERE b.taskseq = b.taskseq AND t.tagName LIKE  CONCAT('%',#{searchText},'%')))
		</if>
		<!--기간 검색 -->
		<if test="date1 != null and date1 !='' and date2 != null and date2 !=''">
			<![CDATA[
			AND ((#{date1} <=  B.EndDate AND #{date2}  >= B.StartDate) OR (#{date1}  <= B.EndDate AND #{date2} >= B.EndDate) OR (B.StartDate <= #{date2} AND B.EndDate >= #{date2}))
			]]>
		</if>
		<!-- 파일검색 -->
		<if test="searchFile != null and  searchFile !=''">
			AND f.FileName LIKE CONCAT('%',#{searchFile},'%') 
		</if>
		<!-- 결재검색 -->
		<if test="searchApproval != null and  searchApproval !=''">
			AND TaskName LIKE CONCAT('%',#{searchApproval},'%') 
		</if>
		<!-- 설문검색 -->
		<if test="searchSurvey != null and  searchSurvey !=''">
			AND Subject LIKE CONCAT('%',#{searchSurvey},'%') 
		</if>
		<!--진행률 검색 -->
		<if test="rate1 != '' and rate1 != null or rate2 != '' and rate2 != null">
			<if test="rate1 != null and rate1 > 0 and rate2 != null and rate2 > 0 ">
				AND B.ProgRate BETWEEN #{rate1} AND #{rate2}
			</if>
			<if test="rate1 == 0 and rate2 > 0">
				AND B.ProgRate BETWEEN 0 AND #{rate2}
			</if>
		</if>
		<if test="objectType != '' and objectType != null" >
			AND b.objectType = #{objectType}
		</if>
		<!--태그 검색-->
		<if test="tagtype != '' and tagtype != 'CTAG'">
			<trim prefix="AND" prefixOverrides="AND |OR">
			${tagData}
			</trim>
		</if>
		<if test="tagtype eq 'CTAG'">
			AND a.TaskSeq in (SELECT TaskSeq FROM collab_task_tag d WHERE a.TaskSeq = d.taskSeq AND d.tagName = #{tagval})
		</if>
		<if test="completMonth != null and  completMonth !=''">
			AND ((TaskStatus = 'C' AND B.EndDate > DATE_FORMAT(date_sub(NOW(), interval #{completMonth}  MONTH),'%Y%m%d')
					OR TaskStatus!='C')) 
		</if>
		<if test='noEndDate == "Y"'>
			AND b.EndDate is null
		</if>
		<if test="taskStatus != null and  taskStatus !=''">
			AND TaskStatus = #{taskStatus}
		</if>
		<if test="sectionSeq != null and  sectionSeq !=''">
			AND SectionSeq = #{sectionSeq}
		</if>
		<if test="memberId != null and  memberId !=''">
			<if test="memberId == 'NONE'">
			AND A.UserCode is null
			</if>
			<if test="memberId != 'NONE'">
			AND A.UserCode = #{memberId}
			</if>
		</if>
		<!-- 끝-->
	</sql>
	

	<!--  프로젝트 조회-->
	<select id="getProject"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProject */
		SELECT PrjSeq, PrjName, StartDate, EndDate, PrjStatus, PrjColor, ProgRate, Remark, RegisterCode, RegisteDate, ModifierCode, ModifyDate,"P" as PrjType, RoomId
				,(SELECT Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) FROM  SYS_OBJECT_USER sou where sou.userCode = p.RegisterCode) as "RegisterName"
				, IFNULL((SELECT COUNT(*) FROM covi_smart4j.collab_project_favorite WHERE p.PrjSeq = PrjSeq AND UserCode = #{USERID}),0) IsFav
		  FROM covi_smart4j.collab_project p
		 WHERE prjSeq =  #{prjSeq}
	</select>

	<!--  팀 조회-->
	<select id="getTeam"   parameterType="cmap" resultType="cmap">
	/* collab.project.getTeam */
	 	SELECT GroupId PrjSeq, Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) PrjName,"T" as PrjType
			, ManagerCode
	      FROM covi_smart4j.sys_object_group sg 
	     WHERE sg.GroupId=  #{prjSeq}
	</select>

	<!--  프로젝트 상태 -->	
	<select id="getProjectStat"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectStat */
		SELECT 
		T.TotCnt, T.DelayCnt, T.EmgCnt, T.LvlHCnt, T.LvlMCnt, T.LvlLCnt, T.WaitCnt, T.ProcCnt, T.HoldCnt, T.CompCnt,
		T.NowCompCnt, T.NowTotCnt,
		(CASE WHEN T.TotCnt = 0 THEN 0 ELSE ROUND(T.CompCnt/T.TotCnt, 3) END) ProjRate
		FROM (
			<![CDATA[
			SELECT COUNT(*) TotCnt
				, IFNULL(SUM(CASE WHEN b.TaskStatus != 'C' AND (b.EndDate is null or b.EndDate <  DATE_FORMAT(NOW(),'%Y%m%d'))  then 1 ELSE 0 END),0) DelayCnt
				, IFNULL(SUM(CASE WHEN b.Label = 'E' then 1 ELSE 0 END),0) EmgCnt
				, IFNULL(SUM(CASE WHEN b.ImpLevel = 'H' then 1 ELSE 0 END),0) LvlHCnt
				, IFNULL(SUM(CASE WHEN b.ImpLevel = 'M' then 1 ELSE 0 END),0) LvlMCnt
				, IFNULL(SUM(CASE WHEN b.ImpLevel = 'L' then 1 ELSE 0 END),0) LvlLCnt
				, IFNULL(SUM(CASE WHEN b.TaskStatus = 'W' then 1 ELSE 0 END),0) WaitCnt
				, IFNULL(SUM(CASE WHEN b.TaskStatus = 'P' then 1 ELSE 0 END),0) ProcCnt
				, IFNULL(SUM(CASE WHEN b.TaskStatus = 'H' then 1 ELSE 0 END),0) HoldCnt
				, IFNULL(SUM(CASE WHEN b.TaskStatus = 'C' then 1 ELSE 0 END),0) CompCnt
				, IFNULL(SUM(case when (b.EndDate is null or b.EndDate <=  DATE_FORMAT(NOW(),'%Y%m%d'))  and b.TaskStatus = 'C' then 1 ELSE 0 END),0) NowCompCnt
				, IFNULL(SUM(case when b.EndDate is null or b.EndDate <=  DATE_FORMAT(NOW(),'%Y%m%d') then 1 ELSE 0 END),0) NowTotCnt
			 FROM collab_task_map a 
			 JOIN collab_task b ON a.taskSeq = b.TaskSeq
			WHERE a.PrjType = #{prjType}
			  AND a.PrjSeq = #{prjSeq}
	  		  AND b.parentkey=0
			]]>
		) T
	</select>

	<select id="getTeamMember"   parameterType="cmap" resultType="cmap">
	/* collab.project.getTeamMember */
		SELECT soub.UserCode
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},soub.MultiDeptName) DeptName
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},soub.MultiJobPositionName) JobPositionName
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) DisplayName
		  FROM covi_smart4j.sys_object_group sb 
	      JOIN covi_smart4j.sys_object_user_basegroup soub ON sb.GroupCode = soub.DeptCode 
	      JOIN covi_smart4j.sys_object_user sou on sou.UserCode = soub.UserCode  #AND soub.JobType ='Origin'
	     WHERE 
	     <if test="groupPath != null and  groupPath !=''">
	     	sb.GroupPath=      #{groupPath}
	     </if>
	     <if test="groupPath == null or groupPath ==''">
	     	sb.GroupId=      #{prjSeq}
	     </if>
	     <if test="searchText != null and  searchText !=''">
	     	AND sou.MultiDisplayName like concat('%', #{searchText},'%')
	     </if>
		AND    sou.IsUse = 'Y'
		AND    sou.IsDisplay = 'Y'
      ORDER BY soub.JobTitleSortKey, soub.JobPositionSortKey, sou.MultiDisplayName
	</select>
	
	<insert id="addProject"   parameterType="cmap">
	/* collab.project.addProject */
		INSERT INTO covi_smart4j.collab_project 
					( prjName , CompanyCode , StartDate, EndDate, PrjStatus, ProgRate, PrjColor, Remark, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
		VALUES		( #{prjName},#{CompanyCode}, #{startDate}, #{endDate}, #{prjStatus}, #{progRate}, #{prjColor}, #{remark}, #{USERID}, now(), #{USERID}, now())
	   <selectKey keyProperty="PrjSeq" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>
	
	<insert id="saveProject"   parameterType="cmap">
	/* collab.project.saveProject */
		UPDATE covi_smart4j.collab_project
		   SET prjName =  #{prjName}
		       ,StartDate=  #{startDate}
               ,EndDate=  #{endDate}
               ,PrjStatus=  #{prjStatus}
               ,ProgRate=  case when #{progRate} = 'C' then 100 else #{progRate} end
               ,PrjColor=  #{prjColor}
               ,Remark=  #{remark}
               ,ModifierCode=  #{USERID}
               ,ModifyDate=  now()
		 WHERE prjSeq =  #{prjSeq}
	</insert>

	<delete id="deleteProject"   parameterType="cmap">
	/* collab.project.deleteProject */
		DELETE FROM covi_smart4j.collab_project WHERE prjSeq =  #{prjSeq}
	</delete>

	<select id="getProjectMileList"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectMileList */
		SELECT m.PrjSeq, m.TaskSeq, m.PrjType, t.TaskName, t.EndDate, t.TaskStatus, s.SectionSeq, s.SectionName
			,(SELECT GROUP_CONCAT(CONCAT(ctm.UserCode,'^',covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName),'^',sou.PhotoPath,'^',bg.DeptName)  SEPARATOR '|') 
				FROM covi_smart4j.collab_task_member ctm 
				JOIN covi_smart4j.sys_object_user sou on ctm.userCode = sou.userCode
				JOIN covi_smart4j.sys_object_user_basegroup bg ON bg.UserCode = sou.UserCode AND bg.JobType = 'Origin'
				WHERE ctm.taskSeq = m.TaskSeq) tmUser
		FROM collab_task_map m 
		LEFT JOIN covi_smart4j.collab_section s ON m.SectionSeq = s.SectionSeq
		LEFT JOIN covi_smart4j.collab_task t ON t.TaskSeq = m.TaskSeq 
		WHERE m.prjSeq = #{prjSeq}
			AND t.IsMile = 'Y'
	</select>
	
	<select id="getProjectUserForm"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectUserForm */
		SELECT OptionTitle, OptionType, OptionVal
		  FROM covi_smart4j.collab_project_userform 
		 WHERE prjSeq =  #{prjSeq}
	</select>
	
	<insert id="addProjectUserForm"   parameterType="cmap">
	/* collab.project.addProjectUserForm */
		<foreach collection="userFormList" item="form" open="" close="" separator=";">
		INSERT INTO covi_smart4j.collab_project_userform
					(prjSeq, optionTitle, optionType, optionVal, sortKey, RegisterCode, RegisteDate, ModifierCode, ModifyDate )
			 VALUES (#{prjSeq}, #{form.optionTitle}, #{form.optionType} ,  #{form.optionVal}, #{form.sortKey},#{USERID}, now(), #{USERID}, now())
		</foreach>	 
	</insert>


	<delete id="deleteProjectUserForm"   parameterType="cmap">
	/* collab.project.deleteProjectUserForm */
		DELETE FROM covi_smart4j.collab_project_userform WHERE prjSeq =  #{prjSeq}
	</delete>

	<select id="getProjectMember"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectMember */
		SELECT cpm.UserCode
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},soub.MultiDeptName) DeptName
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},soub.MultiJobPositionName) JobPositionName
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) DisplayName
				,sou.PhotoPath
				,sou.UserID 
		  FROM covi_smart4j.collab_project_member cpm 
		  JOIN covi_smart4j.sys_object_user sou on cpm.userCode = sou.userCode
		  JOIN covi_smart4j.sys_object_user_basegroup soub		ON sou.UserCode = soub.UserCode  AND soub.JobType ='Origin'
		 WHERE cpm.prjSeq =  #{prjSeq}
      ORDER BY soub.JobTitleSortKey, soub.JobPositionSortKey , sou.MULTIDISPLAYNAME
	</select>
	
	<insert id="addProjectMember"   parameterType="cmap">
	/* collab.project.addProjectMember */
		<foreach collection="memberList" item="user" open="" close="" separator=";">
		INSERT INTO covi_smart4j.collab_project_member
					(prjSeq	,userCode	,RegisterCode,RegisteDate)
		VALUES		( #{prjSeq},#{user.userCode},#{USERID},now())
		ON DUPLICATE KEY UPDATE    
		    RegisterCode   = #{USERID}    
		    ,RegisteDate     = NOW()     
		</foreach>     
	</insert>

	<delete id="deleteProjectMember"   parameterType="cmap">
	/* collab.project.deleteProjectMember */
		DELETE FROM covi_smart4j.collab_project_member WHERE prjSeq =  #{prjSeq}
	</delete>

	<select id="getProjectManager"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectManager */
		SELECT cpm.UserCode
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},soub.MultiDeptName) DeptName
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},soub.MultiJobPositionName) JobPositionName
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) DisplayName
				,sou.PhotoPath
				,sou.UserID 
		  FROM covi_smart4j.collab_project_manager cpm 
		  JOIN covi_smart4j.sys_object_user sou on cpm.userCode = sou.userCode
		  JOIN covi_smart4j.sys_object_user_basegroup soub		ON sou.UserCode = soub.UserCode  AND soub.JobType ='Origin'
		 WHERE cpm.prjSeq =  #{prjSeq}
	</select>


	<insert id="addProjectManager"   parameterType="cmap">
	/* collab.project.addProjectManager */
		<foreach collection="managerList" item="user" open="" close="" separator=";">
		INSERT INTO covi_smart4j.collab_project_manager
					(prjSeq	,userCode	,RegisterCode,RegisteDate)
		VALUES		( #{prjSeq},#{user.userCode}	,#{USERID},now())
		ON DUPLICATE KEY UPDATE    
		    RegisterCode   = #{USERID}    
		    ,RegisteDate     = NOW()      
		</foreach>     
	</insert>

	<delete id="deleteProjectManager"   parameterType="cmap">
	/* collab.project.deleteProjectManager */
		DELETE FROM covi_smart4j.collab_project_manager WHERE prjSeq =  #{prjSeq}
	</delete>

	<select id="getProjectViewer"   parameterType="cmap" resultType="cmap">
		SELECT cpv.UserCode
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},soub.MultiDeptName) DeptName
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},soub.MultiJobPositionName) JobPositionName
				,covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) DisplayName
				,sou.PhotoPath
				,sou.UserID 
		  FROM covi_smart4j.collab_project_viewer cpv 
		  JOIN covi_smart4j.sys_object_user sou on cpv.userCode = sou.userCode
		  JOIN covi_smart4j.sys_object_user_basegroup soub		ON sou.UserCode = soub.UserCode  AND soub.JobType ='Origin'
		 WHERE cpv.prjSeq =  #{prjSeq}
	</select>


	<insert id="addProjectViewer"   parameterType="cmap">
		<foreach collection="viewerList" item="user" open="" close="" separator=";">
		INSERT INTO covi_smart4j.collab_project_viewer
					(prjSeq	,userCode	,RegisterCode,RegisteDate)
		VALUES		( #{prjSeq},#{user.userCode}	,#{USERID},now())
		ON DUPLICATE KEY UPDATE    
		    RegisterCode   = #{USERID}    
		    ,RegisteDate     = NOW()      
		</foreach>     
	</insert>

	<delete id="deleteProjectViewer"   parameterType="cmap">
		DELETE FROM covi_smart4j.collab_project_viewer WHERE prjSeq =  #{prjSeq}
	</delete>

	<select id="getExistsProjectSection"   parameterType="cmap" resultType= "java.lang.Long" >
	/* collab.project.getExistsProjectSection */
		SELECT COUNT(*)
		  FROM covi_smart4j.collab_section
		 WHERE prjSeq  = #{prjSeq}
		   AND prjType = #{prjType}
		   
		 <if test="sectionName != '' and sectionName != null" >
		   AND SectionName = #{sectionName}
		 </if>
	</select>
	
	<select id="getProjectSection"   parameterType="cmap"  resultType="cmap">
	/* collab.project.getProjectSection */
		SELECT 
			SectionSeq
			, SectionName
		FROM covi_smart4j.collab_section
		<if test="prjSeq != null and prjSeq != '' and prjType != null and prjType != ''">
			WHERE PrJSeq = #{prjSeq}
			   AND PrjType = #{prjType}
		</if>
		ORDER BY SectionOrder ASC
	</select>
	
	<select id="getProjectSectionSeq"   parameterType="cmap"  resultType="cmap">
	/* collab.project.getProjectSectionSeq */
		SELECT SectionSeq
		  FROM covi_smart4j.collab_section 
		 WHERE PrJSeq = #{prjSeq}
		   AND PrjType = #{prjType}
		ORDER BY SectionOrder ASC
		LIMIT 0, 1
	</select>
	
	<select id="getProjectTask" parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectTask */
		<![CDATA[
		SELECT b.TaskSeq
			,(SELECT IFNULL(COUNT(*),0) FROM collab_task WHERE ParentKey = b.TaskSeq AND ParentKey > 0) AS PCnt
			,(SELECT COUNT(*) FROM covi_smart4j.sys_comment sc WHERE sc.TargetServiceType='Collab' AND 	sc.TargetId = b.TaskSeq  AND DELETEDATE IS NULL) CommentCnt
			, A.UserCode
			, A.LikeFlag
			, B.TaskName
			, B.Remark
			, B.Label
			, b.ImpLevel
			, B.ParentKey
			, B.StartDate
			, B.EndDate
			, case when B.EndDate IS NOT NULL and B.EndDate != '' then DATEDIFF(STR_TO_DATE(B.EndDate,'%Y%m%d'),NOW()) ELSE '' end AS RemainDay
			, case when (B.EndDate is null OR STR_TO_DATE(B.EndDate,'%Y%m%d')<NOW()) AND B.TaskStatus NOT IN ('C','H')  then 'Y' end AS IsDelay
			, B.TaskStatus
			, ifnull(B.ProgRate, 0) as ProgRate
			, B.CloseDate
			, B.ObjectType
			, B.ObjectID
			, B.ModifierCode
			, B.ModifyDate
			, B.ImagePath
		 	, b.IsMile
			, f.FileID
			, f.FileName
			, f.FilePath
			, f.SavedName
			, f.CompanyCode
		 	, f.Size
		 	, f.Extention
		 	, DATE_FORMAT(f.RegistDate, '%Y-%m-%d %H:%i:%s') AS FileRegistDate
		 	, f.SaveType
		 	,(SELECT LinkTaskSeq FROM covi_smart4j.collab_task_link ctl WHERE b.TaskSeq = ctl.TaskSeq LIMIT 1) LinkTaskSeq
			,IFNULL((SELECT TaskName FROM covi_smart4j.collab_task cln WHERE TaskSeq = (SELECT LinkTaskSeq FROM covi_smart4j.collab_task_link ctll WHERE b.TaskSeq = ctll.TaskSeq LIMIT 1)), '') AS LinkTaskName
			,(SELECT GROUP_CONCAT(CONCAT(ctm.UserCode,'^',covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName),'^',sou.PhotoPath,'^',bg.DeptName)  SEPARATOR '|') 
				FROM covi_smart4j.collab_task_member ctm 
			   JOIN covi_smart4j.sys_object_user sou on ctm.userCode = sou.userCode
	     	   JOIN covi_smart4j.sys_object_user_basegroup bg ON bg.UserCode = sou.UserCode AND bg.JobType = 'Origin'
				WHERE ctm.taskSeq = b.TaskSeq) tmUser
			, CASE	WHEN b.RegisterCode = #{USERID} || A.UserCode IS NOT NULL THEN 'Y'
					ELSE 'N'
			  END AS authSave]]>
			<choose>
				<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
	     	    ,(SELECT concat(c.PrjType ,'^', case when c.prjType = 'P' then p.PrjName ELSE t.DisplayName END ,'^', PrjColor,'^', s.SectionName)
	     	        FROM collab_task_map C 
		            JOIN collab_section s on c.sectionseq = s.sectionseq
	     	   LEFT JOIN collab_project P on c.PrjType='P' and p.PrjSeq = c.PrjSeq
	     	   LEFT JOIN sys_object_group T on c.PrjType!='P' and t.GroupId = c.PrjSeq
	     	       WHERE C.TaskSeq = B.TaskSeq limit 1) PrjDesc	     	     	
				</when>
				<otherwise>
				, C.PrjSeq
				, C.PrjType
				, c.SectionSeq
				, (SELECT SectionName FROM covi_smart4j.collab_section s where s.SectionSeq = c.SectionSeq) SectionName
				</otherwise>
			</choose>	
		FROM collab_task B	
	LEFT JOIN covi_smart4j.sys_file f ON f.FileID=(select MAX(FileID) from covi_smart4j.sys_file f2 where  b.TaskSeq = f2.ObjectID AND f2.ServiceType = 'Collab' AND f2.saveType='IMAGE')
		<choose>
			<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
		 	  JOIN collab_task_member A on  A.TaskSeq = B.TaskSeq   AND A.UserCode = #{USERID} 
		 	 WHERE 1=1
			</when>
			<otherwise>
				<if test='allView != "" and allView == "Y"'>LEFT</if>
				JOIN COVI_SMART4J.COLLAB_TASK_MEMBER A on A.TaskSeq = B.TaskSeq  
					<if test="memberId != null and  memberId !=''">
						<if test="memberId != 'NONE'">
							AND A.UserCode = #{memberId}
						</if>
					</if>
					<if test="memberId == null or  memberId ==''">
						AND A.UserCode = #{USERID}
					</if>
		 LEFT JOIN collab_task_map C ON (C.TaskSeq = B.TaskSeq)
			 WHERE c.PrjSeq = #{prjSeq}   
			   AND c.PrjType = #{prjType}
			</otherwise>
		</choose>
		AND B.ParentKey = 0
		<include refid="searchMyTask" />
		<trim prefix='ORDER BY'>
			<if test='sortColumn != null and sortColumn != "" and sortDirection != null and sortDirection != ""'>
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Delay")'>IsDelay desc, EndDate</when>
					<otherwise>B.EndDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
			<if test='sortColumn == null or sortColumn == "" or sortDirection == null or sortDirection == ""'>
				<choose>
		     		<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
						A.Todoorder ASC
					</when>
					<otherwise>
					 	c.workOrder ASC
			 		</otherwise>
				</choose>
				, B.EndDate
			</if>
		</trim>
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="getProjectTaskCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.getProjectTaskCnt */
		SELECT COUNT(0)
		FROM collab_task B
		<choose>
			<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
				JOIN collab_task_member A on  A.TaskSeq = B.TaskSeq   AND A.UserCode = #{USERID} 
				WHERE 1=1
			</when>
			<otherwise>
				<if test='allView != "" and allView == "Y"'>LEFT</if>
				JOIN COVI_SMART4J.COLLAB_TASK_MEMBER A on A.TaskSeq = B.TaskSeq  
					<if test="memberId != null and  memberId !=''">
						<if test="memberId != 'NONE'">
							AND A.UserCode = #{memberId}
						</if>
					</if>
					<if test="memberId == null or  memberId ==''">
						AND A.UserCode = #{USERID}
					</if>
		    LEFT JOIN collab_task_map C ON (C.TaskSeq = B.TaskSeq)
				WHERE c.PrjSeq = #{prjSeq}   
				AND c.PrjType = #{prjType}
			</otherwise>
		</choose>
		AND B.ParentKey = 0
		<include refid="searchMyTask" />
	</select>
	
	<select id="getProjectTaskFile" parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectFile*/
		with cte as (SELECT b.TaskSeq, b.TaskName, b.RegisterCode <if test='myTodo == "" or myTodo != "Y"'>,c.sectionSeq</if>
					  FROM COLLAB_TASK B		
							<choose>
								<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
							 	  JOIN COLLAB_TASK_MEMBER A on  A.TaskSeq = B.TaskSeq   AND A.UserCode = #{USERID} 
							 	 WHERE 1=1
								</when>
								<otherwise>
								<if test='allView != "" and allView == "Y"'>LEFT</if>
									JOIN COLLAB_TASK_MEMBER A on A.TaskSeq = B.TaskSeq  
										<if test="memberId != null and  memberId !=''">
											<if test="memberId != 'NONE'">
												AND A.UserCode = #{memberId}
											</if>	
										</if>
										<if test="memberId == null or  memberId ==''">
										AND A.UserCode = #{USERID}
										</if>
							 LEFT JOIN COLLAB_TASK_MAP C ON (C.TaskSeq = B.TaskSeq)
								 WHERE c.PrjSeq = #{prjSeq}   
								   AND c.PrjType = #{prjType}
								</otherwise>
							</choose>
							AND B.ParentKey = 0)
		SELECT  TaskSeq 
				,TaskName
				,ServiceType  
				,FileID
				,FileName 
				,FilePath 
				,SavedName			
				,Size
				,Extention
		 		,DATE_FORMAT(RegistDate, '%Y-%m-%d %H:%i:%s') AS FileRegistDate
				,SaveType 
				,CompanyCode
				,CASE	WHEN RegisterCode = #{USERID} THEN 'Y'
						ELSE 'N'
				  END AS authSave
			<choose>
				<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
	     	    ,(SELECT concat(c.PrjType ,'^', case when c.prjType = 'P' then p.PrjName ELSE t.DisplayName END ,'^', PrjColor,'^', s.SectionName)
	     	        FROM collab_task_map C 
		            JOIN collab_section s on c.sectionseq = s.sectionseq
	     	   LEFT JOIN collab_project P on c.PrjType='P' and p.PrjSeq = c.PrjSeq
	     	   LEFT JOIN sys_object_group T on c.PrjType!='P' and t.GroupId = c.PrjSeq
	     	       WHERE C.TaskSeq = B.TaskSeq limit 1) PrjDesc	     	     	
				</when>
				<otherwise>
				, (SELECT SectionName FROM collab_section s where s.SectionSeq = b.SectionSeq) as SectionName
				</otherwise>
			</choose>
		  FROM ( 
				SELECT b.TaskSeq 
					, B.TaskName 
				 	, f.ServiceType
					, f.FileID 
					, F.FileName
					, F.FilePath
					, F.SavedName		
				 	, F.Size
				 	, F.Extention	
				 	, F.RegistDate
				 	, F.SaveType 
				 	, F.CompanyCode
				 	, b.RegisterCode
				 	<if test='myTodo == "" or myTodo != "Y"'>,sectionSeq</if>
			 	FROM CTE b
		     	JOIN sys_file f ON  f.ServiceType = 'Collab' AND f.MessageID = 0 AND b.TaskSeq = f.ObjectID 
		     	WHERE 1=1
		    	<include refid="searchMyTask" />
 			union all
			   SELECT  b.TaskSeq 
					, concat(B.TaskName ,'>',c.`Comment`)
				 	, f.ServiceType
					, f.FileID 
					, F.FileName
					, F.FilePath
					, F.SavedName		
				 	, F.Size
				 	, F.Extention	
				 	, F.RegistDate
				 	, F.SaveType 
				 	, F.CompanyCode
				 	, c.RegisterCode
				 	<if test='myTodo == "" or myTodo != "Y"'>,sectionSeq</if>
				FROM CTE  b
		     	JOIN sys_comment c on c.TargetServiceType = 'Collab' AND c.TargetID = b.TaskSeq AND c.DeleteDate IS null
		     	JOIN sys_file f ON  f.ServiceType = 'Comment' AND f.MessageID = 0 AND c.CommentID = f.ObjectID
		     	WHERE 1=1
				<include refid="searchMyTask" />
		   union all
			   SELECT  b.TaskSeq 
					, B.TaskName 
				 	, f.ServiceType
					, f.FileID 
					, F.FileName
					, F.FilePath
					, F.SavedName		
				 	, F.Size
				 	, F.Extention	
				 	, F.RegistDate
				 	, F.SaveType 
				 	, F.CompanyCode
				 	, b.RegisterCode
				 	<if test='myTodo == "" or myTodo != "Y"'>,sectionSeq</if>
				FROM CTE  
		     	JOIN COLLAB_TASK b ON b.TopParentKey = CTE.TaskSeq
		     	JOIN sys_file f ON  f.ServiceType = 'Collab' AND f.MessageID = 0 AND b.TaskSeq = f.ObjectID
		     	WHERE 1=1
				<include refid="searchMyTask" />
			union all
			   SELECT  b.TaskSeq 
					, concat(B.TaskName ,'>',c.`Comment`)
				 	, f.ServiceType
					, f.FileID 
					, F.FileName
					, F.FilePath
					, F.SavedName		
				 	, F.Size
				 	, F.Extention	
				 	, F.RegistDate
				 	, F.SaveType 
				 	, F.CompanyCode
				 	, c.RegisterCode
				 	<if test='myTodo == "" or myTodo != "Y"'>,sectionSeq</if>
				FROM CTE    
		     	JOIN COLLAB_TASK b ON b.TopParentKey = CTE.TaskSeq
		     	JOIN sys_comment c on c.TargetServiceType = 'Collab' AND c.TargetID = b.TaskSeq AND c.DeleteDate IS null
		     	JOIN sys_file f ON  f.ServiceType = 'Comment' AND f.MessageID = 0 AND c.CommentID = f.ObjectID
		     	WHERE 1=1
				<include refid="searchMyTask" />
		)	B	
		<trim prefix='ORDER BY'>
			<if test='sortColumn != null and sortColumn != "" and sortDirection != null and sortDirection != ""'>
				<choose>
					<when test='sortColumn.equalsIgnoreCase("FileName")'>F.FileName</when>
					<when test='sortColumn.equalsIgnoreCase("Size")'>F.Size_</when>
					<otherwise>FileRegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
			<if test='sortColumn == null or sortColumn == "" or sortDirection == null or sortDirection == ""'>
				FileRegistDate
			</if>
		</trim>
	</select>
	
	<select id="getProjectTaskFileCnt" parameterType="cmap"  resultType="java.lang.Long">
	/* collab.project.getProjectTaskFileCnt*/
		with cte as (SELECT b.TaskSeq
					  FROM COLLAB_TASK B		
							<choose>
								<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
							 	  JOIN COLLAB_TASK_MEMBER A on  A.TaskSeq = B.TaskSeq   AND A.UserCode = #{USERID} 
							 	 WHERE 1=1
								</when>
								<otherwise>
								<if test='allView != "" and allView == "Y"'>LEFT</if>
									JOIN COLLAB_TASK_MEMBER A on A.TaskSeq = B.TaskSeq  
										<if test="memberId != null and  memberId !=''">
											<if test="memberId != 'NONE'">
												AND A.UserCode = #{memberId}
											</if>	
										</if>
										<if test="memberId == null or  memberId ==''">
										AND A.UserCode = #{USERID}
										</if>
							 LEFT JOIN COLLAB_TASK_MAP C ON (C.TaskSeq = B.TaskSeq)
								 WHERE c.PrjSeq = #{prjSeq}   
								   AND c.PrjType = #{prjType}
								</otherwise>
							</choose>
							AND B.ParentKey = 0)
		SELECT  count(*)
		  FROM ( 
				SELECT b.TASKSEQ 
					, f.FileID 
			 	FROM CTE b
		     	JOIN sys_file f ON  f.ServiceType = 'Collab' AND f.MessageID = 0 AND b.TaskSeq = f.ObjectID 
		     	WHERE 1=1
		    	<include refid="searchMyTask" />
		   union all
			   SELECT b.TASKSEQ 
					, f.FileID 
				FROM CTE  b
		     	JOIN sys_comment c on c.TargetServiceType = 'Collab' AND c.TargetID = b.TaskSeq AND c.DeleteDate IS null
		     	JOIN sys_file f ON  f.ServiceType = 'Comment' AND f.MessageID = 0 AND c.CommentID = f.ObjectID
		     	WHERE 1=1
				<include refid="searchMyTask" />
		   union all
			   SELECT b.TASKSEQ 
					, f.FileID 
				FROM CTE  
		     	JOIN COLLAB_TASK b ON b.TopParentKey = CTE.TASKSEQ
		     	JOIN sys_file f ON  f.ServiceType = 'Collab' AND f.MessageID = 0 AND b.TaskSeq = f.ObjectID
		     	WHERE 1=1
				<include refid="searchMyTask" />
		   union all
			   SELECT b.TASKSEQ 
					, f.FileID 
				FROM CTE    
		     	JOIN COLLAB_TASK b ON b.TopParentKey = CTE.TaskSeq
		     	JOIN sys_comment c on c.TargetServiceType = 'Collab' AND c.TargetID = b.TaskSeq AND c.DeleteDate IS null
		     	JOIN sys_file f ON  f.ServiceType = 'Comment' AND f.MessageID = 0 AND c.CommentID = f.ObjectID
		     	WHERE 1=1
				<include refid="searchMyTask" />
		)	B	
	</select>
	
	<insert id="addProjectSection"   parameterType="cmap">
	/* collab.project.addProjectSection */
		INSERT INTO covi_smart4j.collab_section 
					( prjSeq , prjType, SectionName, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
		VALUES		( #{prjSeq}, #{prjType},#{sectionName}, #{USERID}, now(), #{USERID}, now())
	   <selectKey keyProperty="SectionSeq" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>
	
	<insert id="saveProjectSection"   parameterType="cmap">
	/* collab.project.saveProjectSection */
		UPDATE covi_smart4j.collab_section
		   SET sectionName =#{sectionName}
		   		,ModifierCode= #{USERID}
		   		,ModifyDate = now()
		 WHERE 	sectionSeq = 	#{sectionSeq}
	</insert>
	

	<delete id="deleteProjectSection"   parameterType="cmap">
	/* collab.project.deleteProjectSection */
		DELETE FROM covi_smart4j.collab_section 
		 WHERE 
		 <if test='prjSeq != null and prjSeq != ""'>
		    prjType = #{prjType}
		 	AND prjSeq =  #{prjSeq}
		 </if>
		 <if test='sectionSeq != null and sectionSeq != ""'>
		 	sectionSeq =  #{sectionSeq}
		 </if>
	</delete>

	<delete id="deleteProjectSectionMap"   parameterType="cmap">
	/* collab.project.deleteProjectSectionMap */
		UPDATE covi_smart4j.collab_task_map
		   SET sectionSeq = null
		 WHERE sectionSeq =  #{sectionSeq}
	</delete>

	<delete id="deleteProjectMap"   parameterType="cmap">
	/* collab.project.deleteProjectMap */
		DELETE FROM covi_smart4j.collab_task_map WHERE prjType ='P' AND prjSeq =  #{prjSeq}
	</delete>

	<insert id="copyProject"   parameterType="cmap">
	/* collab.project.copyProject */
		INSERT INTO covi_smart4j.collab_project 
					( prjName , CompanyCode , StartDate, EndDate, PrjStatus, PrjColor, ProgRate, Remark, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
			(SELECT #{prjName},#{CompanyCode}, StartDate, EndDate, PrjStatus, PrjColor, #{progRate}, Remark, #{USERID}, now(), #{USERID}, now()
			   FROM covi_smart4j.collab_project
			  WHERE prjSeq =  #{orgPrjSeq})
			    
	   <selectKey keyProperty="PrjSeq" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>
	
	<insert id="copyProjectUserform"   parameterType="cmap">
	/* collab.project.copyProjectUserform */
		INSERT INTO covi_smart4j.collab_project_userform
				(prjSeq, optionTitle, optionType, optionVal, sortKey, RegisterCode, RegisteDate, ModifierCode, ModifyDate )
		(SELECT #{prjSeq}, optionTitle, optionType, optionVal, sortKey, #{USERID}, now(), #{USERID}, now()
		   FROM covi_smart4j.collab_project_userform
		  WHERE prjSeq =  #{orgPrjSeq})
	</insert>
	
	<insert id="copyProjectMember"   parameterType="cmap">
	/* collab.project.copyProjectMember */
		INSERT INTO covi_smart4j.collab_project_member
					(prjSeq	,userCode	,RegisterCode,RegisteDate)
			(SELECT #{prjSeq},userCode,#{USERID},now()
			   FROM covi_smart4j.collab_project_member
			  WHERE prjSeq =  #{orgPrjSeq})
	</insert>
	
	<insert id="copyProjectManager"   parameterType="cmap">
	/* collab.project.copyProjectManager */
		INSERT INTO covi_smart4j.collab_project_manager
					(prjSeq	,userCode	,RegisterCode,RegisteDate)
			(SELECT #{prjSeq},userCode,#{USERID},now()
			   FROM covi_smart4j.collab_project_manager
			  WHERE prjSeq =  #{orgPrjSeq})
	</insert>
	
	<insert id="copyProjectViewer"   parameterType="cmap">
	/* collab.project.copyProjectViewer */
		INSERT INTO covi_smart4j.collab_project_viewer
					(prjSeq	,userCode	,RegisterCode,RegisteDate)
			(SELECT #{prjSeq},userCode,#{USERID},now()
			   FROM covi_smart4j.collab_project_viewer
			  WHERE prjSeq =  #{orgPrjSeq})
	</insert>

	<insert id="copyProjectSection"   parameterType="cmap">
	/* collab.project.copyProjectSection */
		INSERT INTO covi_smart4j.collab_section 
					( prjSeq, prjType , SectionName, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
			(SELECT #{prjSeq}, #{prjType}, SectionName, #{USERID}, now(), #{USERID}, now()
			   FROM covi_smart4j.collab_section
			  WHERE prjSeq =  #{orgPrjSeq})  
	</insert>
	
	<select id="selectProjectMemberList" parameterType="cmap" resultType="cmap">
	/* collab.project.selectProjectMemberList */
		SELECT	  sou.UserCode
				, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, soub.MultiDeptName) AS DeptName
				, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, soub.MultiJobPositionName) AS JobPositionName
				, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, sou.MultiDisplayName) AS DisplayName
				, sou.PhotoPath
				<if test="thisTaskSeq != null and thisTaskSeq != ''">
		        , (select m.UserCode from covi_smart4j.COLLAB_TASK_MEMBER m WHERE m.taskseq = #{thisTaskSeq}  and m.UserCode = sou.USERCODE) IsAlloc
		        </if>
		FROM covi_smart4j.sys_object_user sou
		<if test="prjType != null and prjType != ''">
			JOIN (
				<if test='prjType == "P"'>
					SELECT UserCode
					FROM covi_smart4j.collab_project_manager
					WHERE prjSeq = #{prjSeq}
					
					UNION
					
					SELECT UserCode
					FROM covi_smart4j.collab_project_member
					WHERE prjSeq = #{prjSeq}
				</if>
				<if test='prjType != "P"'>
					SELECT A.UserCode
					FROM covi_smart4j.sys_object_user_basegroup A
					INNER JOIN covi_smart4j.sys_object_group B ON A.DeptCode = B.GroupCode AND B.GroupID = #{prjSeq}
				</if>
			) user ON user.UserCode = sou.UserCode
		</if>		
		JOIN covi_smart4j.sys_object_user_basegroup soub ON sou.UserCode = soub.UserCode
		WHERE sou.IsUse = 'Y'
      	AND sou.IsDisplay = 'Y'
		<if test="searchWord != null and searchWord != ''">
			AND sou.MultiDisplayName LIKE CONCAT('%', #{searchWord}, '%')
		</if>
		<trim prefix="ORDER BY">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection != ''">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DeptName")'>DeptName</when>
					<when test='sortColumn.equalsIgnoreCase("JobPositionName")'>JobPositionName</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<otherwise>DisplayName</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageSize >= 0 and pageOffset != null and pageOffset >= 0">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="selectProjectMemberListCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.selectProjectMemberListCnt */
		SELECT COUNT(*)
		FROM (
			SELECT	  sou.UserCode
					, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, soub.MultiDeptName) AS DeptName
					, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, soub.MultiJobPositionName) AS JobPositionName
					, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, sou.MultiDisplayName) AS DisplayName
					, sou.PhotoPath
			FROM covi_smart4j.sys_object_user sou
			<if test="prjType != null and prjType != ''">
				JOIN (
					<if test='prjType == "P"'>
						SELECT UserCode
						FROM covi_smart4j.collab_project_manager
						WHERE prjSeq = #{prjSeq}
						
						UNION
						
						SELECT UserCode
						FROM covi_smart4j.collab_project_member
						WHERE prjSeq = #{prjSeq}
					</if>
					<if test='prjType != "P"'>
						SELECT A.UserCode
						FROM covi_smart4j.sys_object_user_basegroup A
						INNER JOIN covi_smart4j.sys_object_group B ON A.DeptCode = B.GroupCode AND B.GroupID = #{prjSeq}
					</if>
				) user ON user.UserCode = sou.UserCode
			</if>		
			JOIN covi_smart4j.sys_object_user_basegroup soub ON sou.UserCode = soub.UserCode
			WHERE sou.IsUse = 'Y'
	      	AND sou.IsDisplay = 'Y'
			<if test="searchWord != null and searchWord != ''">
				AND sou.MultiDisplayName LIKE CONCAT('%', #{searchWord}, '%')
			</if>
		) RESULT
	</select>
	
	<select id="selectProjectMemberTagList" parameterType="cmap" resultType="cmap">
	/* collab.project.selectProjectMemberTagList */
		SELECT	  sou.UserCode
				, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, soub.MultiDeptName) AS DeptName
				, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, soub.MultiJobPositionName) AS JobPositionName
				, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, sou.MultiDisplayName) AS DisplayName
				, sou.PhotoPath
				<if test="thisTaskSeq != null and thisTaskSeq != ''">
		        , (select m.UserCode from covi_smart4j.COLLAB_TASK_MEMBER m WHERE m.taskseq = #{thisTaskSeq}  and m.UserCode = sou.USERCODE) IsAlloc
		        </if>
		FROM covi_smart4j.sys_object_user sou	
		JOIN covi_smart4j.sys_object_user_basegroup soub ON  sou.UserCode = soub.UserCode AND soub.JobType ='Origin'
		WHERE sou.IsUse = 'Y'
      		AND sou.IsDisplay = 'Y'
		<if test='userCodesArray != null and userCodesArray.length != 0'>
			AND sou.UserCode IN
			<foreach collection="userCodesArray" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="searchWord != null and searchWord != ''">
			AND sou.MultiDisplayName LIKE CONCAT('%', #{searchWord}, '%')
		</if>
		<trim prefix="ORDER BY">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection != ''">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DeptName")'>DeptName</when>
					<when test='sortColumn.equalsIgnoreCase("JobPositionName")'>JobPositionName</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<otherwise>DisplayName</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageSize >= 0 and pageOffset != null and pageOffset >= 0">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="selectProjectMemberTagListCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.selectProjectMemberTagListCnt */
		SELECT COUNT(*)
		FROM (
			SELECT	  sou.UserCode
					, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, soub.MultiDeptName) AS DeptName
					, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, soub.MultiJobPositionName) AS JobPositionName
					, covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, sou.MultiDisplayName) AS DisplayName
					, sou.PhotoPath
			FROM covi_smart4j.sys_object_user sou	
			JOIN covi_smart4j.sys_object_user_basegroup soub ON sou.UserCode = soub.UserCode AND soub.JobType ='Origin'
			WHERE sou.IsUse = 'Y'
	      	AND sou.IsDisplay = 'Y'
		    <if test='userCodesArray != null and userCodesArray.length != 0'>
				AND sou.UserCode IN
				<foreach collection="userCodesArray" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="searchWord != null and searchWord != ''">
				AND sou.MultiDisplayName LIKE CONCAT('%', #{searchWord}, '%')
			</if>
		) RESULT
	</select>
	
	<select id="selectCollabSurveyList" parameterType="cmap" resultType="cmap">
	/* collab.project.selectCollabSurveyList */
		SELECT	  RESULT.SurveyID
				, RESULT.Subject
				, RESULT.StartDate
				, RESULT.EndDate
				, RESULT.State
				, RESULT.RegisterCode
				, RESULT.RegisterName
				, RESULT.RegistDate
				, RESULT.ModifyDate
				, RESULT.PrjType
				, RESULT.JoinRate
				, RESULT.RespondentCnt
				, RESULT.CommentCnt
				, case when RESULT.TargetCode is not null then 'Y' else 'N' end as IsResponse
		FROM (
			-- 진행중인 설문(설문 대상)
			SELECT	  A.SurveyID
					, A.Subject
					, DATE_FORMAT(A.SurveyStartDate, '%Y.%m.%d') AS StartDate
					, DATE_FORMAT(A.SurveyEndDate, '%Y.%m.%d') AS EndDate
		  			, CASE WHEN State = 'F' THEN
						CASE WHEN (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND RespondentCode = #{userCode}) = 0 THEN 'F'
					  	WHEN (SELECT COUNT(*) FROM covi_smart4j.survey_target_resultview WHERE SurveyID = A.SurveyID AND TargetCode = #{userCode} AND TargetType = 'UR') = 0 THEN 'C'
		  			  	ELSE 'G' END 
		  			  ELSE State END AS State
		  			, A.RegisterCode
		  			, (SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM covi_smart4j.sys_object_user WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, covi_smart4j.Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM covi_smart4j.survey_target_respondent WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					,  C.TargetCode
			FROM covi_smart4j.survey A
			INNER JOIN covi_smart4j.collab_survey B ON B.SurveyID = A.SurveyID
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			INNER JOIN covi_smart4j.survey_target_respondent C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.State = 'F'
			AND A.DeleteDate IS NULL
			AND NOW() BETWEEN A.SurveyStartDate AND A.SurveyEndDate
			
			-- 완료된 설문(결과 공개 대상)
			UNION 
			
			SELECT	  A.SurveyID
					, A.Subject
					, DATE_FORMAT(A.ResultViewStartDate, '%Y.%m.%d') AS StartDate
					, DATE_FORMAT(A.ResultViewEndDate, '%Y.%m.%d') AS EndDate
					, A.State
					, A.RegisterCode
		  			, (SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM covi_smart4j.sys_object_user WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, covi_smart4j.Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM covi_smart4j.survey_target_respondent WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					,  C.TargetCode
			FROM covi_smart4j.survey A
			INNER JOIN covi_smart4j.collab_survey B ON B.SurveyID = A.SurveyID
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			INNER JOIN covi_smart4j.survey_target_resultview C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.State = 'G'
			AND A.DeleteDate IS NULL
			AND NOW() BETWEEN A.ResultViewStartDate AND A.ResultViewEndDate
			
			-- 임시저장된 설문(작성자)
			UNION 
			
			SELECT	  A.SurveyID
					, A.Subject
					, DATE_FORMAT(A.SurveyStartDate, '%Y.%m.%d') AS StartDate
					, DATE_FORMAT(A.SurveyEndDate, '%Y.%m.%d') AS EndDate
					, CASE WHEN State ='F' THEN
						CASE WHEN (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND RespondentCode = #{userCode}) = 0 THEN 'F'
					  	WHEN (SELECT COUNT(*) FROM covi_smart4j.survey_target_resultview WHERE SurveyID = A.SurveyID AND TargetCode = #{userCode} AND TargetType = 'UR') = 0 THEN 'C'
		  			  	ELSE 'G' END 
		  			  ELSE State END AS State
					, A.RegisterCode
		  			, (SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM covi_smart4j.sys_object_user WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, covi_smart4j.Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM covi_smart4j.survey_target_respondent WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					,  C.TargetCode
			FROM covi_smart4j.survey A
			INNER JOIN covi_smart4j.collab_survey B ON B.SurveyID = A.SurveyID 
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			LEFT  JOIN covi_smart4j.survey_target_respondent C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.State = 'A'
			AND A.RegisterCode = #{userCode}
			AND A.DeleteDate IS NULL
		) RESULT
		WHERE 1=1
		<include refid="searchMyTask" />
		<trim prefix='ORDER BY'>
			<if test='sortColumn != null and sortColumn != "" and sortDirection != null and sortDirection != ""'>
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("StartDate")'>StartDate</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<otherwise>JoinRate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
			<if test='sortColumn == null or sortColumn == "" or sortDirection == null or sortDirection == ""'>
				ModifyDate DESC, SurveyID DESC
			</if>
		</trim>
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="selectCollabSurveyListCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.selectCollabSurveyListCnt */
		SELECT COUNT(0)
		FROM (
			-- 진행중인 설문(설문 대상)
			SELECT	  A.SurveyID
					, A.Subject
					, DATE_FORMAT(A.SurveyStartDate, '%Y.%m.%d') AS StartDate
					, DATE_FORMAT(A.SurveyEndDate, '%Y.%m.%d') AS EndDate
					, CASE WHEN State ='F' then  
						CASE WHEN (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND RespondentCode = #{userCode}) = 0 THEN 'F'
					  	WHEN (SELECT COUNT(*) FROM covi_smart4j.survey_target_resultview WHERE SurveyID = A.SurveyID AND TargetCode = #{userCode} AND TargetType = 'UR') = 0 THEN 'C'
		  			  	ELSE 'G' END
		  			  ELSE State END AS State
		  			, A.RegisterCode
		  			, (SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM covi_smart4j.sys_object_user WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, covi_smart4j.Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM covi_smart4j.survey_target_respondent WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					, C.TargetCode
			FROM covi_smart4j.survey A
			INNER JOIN covi_smart4j.collab_survey B ON B.SurveyID = A.SurveyID
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			INNER JOIN covi_smart4j.survey_target_respondent C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.State = 'F'
			AND A.DeleteDate IS NULL
			AND NOW() BETWEEN A.SurveyStartDate AND A.SurveyEndDate
			
			-- 완료된 설문(결과 공개 대상)
			UNION 
			
			SELECT	  A.SurveyID
					, A.Subject
					, DATE_FORMAT(A.ResultViewStartDate, '%Y.%m.%d') AS StartDate
					, DATE_FORMAT(A.ResultViewEndDate, '%Y.%m.%d') AS EndDate
					, A.State
					, A.RegisterCode
		  			, (SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM covi_smart4j.sys_object_user WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, covi_smart4j.Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM covi_smart4j.survey_target_respondent WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					, C.TargetCode
			FROM covi_smart4j.survey A
			INNER JOIN covi_smart4j.collab_survey B ON B.SurveyID = A.SurveyID
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			INNER JOIN covi_smart4j.survey_target_resultview C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.State = 'G'
			AND A.DeleteDate IS NULL
			AND NOW() BETWEEN A.ResultViewStartDate AND A.ResultViewEndDate
			
			-- 임시저장된 설문(작성자)
			UNION 
			
			SELECT	  A.SurveyID
					, A.Subject
					, DATE_FORMAT(A.SurveyStartDate, '%Y.%m.%d') AS StartDate
					, DATE_FORMAT(A.SurveyEndDate, '%Y.%m.%d') AS EndDate
					, CASE WHEN State ='F' then  
						CASE WHEN (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND RespondentCode = #{userCode}) = 0 THEN 'F'
					  	WHEN (SELECT COUNT(*) FROM covi_smart4j.survey_target_resultview WHERE SurveyID = A.SurveyID AND TargetCode =#{userCode} AND TargetType = 'UR') = 0 THEN 'C'
		  			  	ELSE 'G' END
		  			  ELSE State END AS State
					, A.RegisterCode
		  			, (SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM covi_smart4j.sys_object_user WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, covi_smart4j.Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM covi_smart4j.survey_target_respondent WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM covi_smart4j.survey_respondent WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					, C.TargetCode
			FROM covi_smart4j.survey A
			INNER JOIN covi_smart4j.collab_survey B ON B.SurveyID = A.SurveyID 
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			LEFT  JOIN covi_smart4j.survey_target_respondent C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE A.RegisterCode = #{userCode}
			AND A.DeleteDate IS NULL
		) RESULT
		WHERE 1=1
		<include refid="searchMyTask" />
	</select>
	
	<select id="selectCollabApprovalList" parameterType="cmap" resultType="cmap">
	/* collab.project.selectCollabApprovalList */
		SELECT	  A.TaskSeq
				, A.TaskName
				, DATE_FORMAT(A.StartDate, '%Y.%m.%d') AS StartDate
				, DATE_FORMAT(A.EndDate, '%Y.%m.%d') AS EndDate
				, A.RegisteDate
				, A.ModifyDate
				, B.InitiatorID AS UserCode
				, covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) DisplayName
				, sou.PhotoPath
				, DATE_FORMAT(B.InitiatedDate, '%Y-%m-%d %H:%i:%s') AS InitiateDateStr
				, M.PrjType, m.PrjSeq
	     	    , case when m.prjType = 'P' then p.PrjName ELSE t.DisplayName END as "PrjName"
				, s.SectionName as "SectionName"
		FROM covi_smart4j.collab_task A
  INNER JOIN covi_smart4j.sys_file f ON a.taskseq = f.ObjectID AND f.ServiceType='Collab' AND f.ObjectType='APPROVAL'
  INNER JOIN covi_smart4j.collab_task_map M		ON M.TaskSeq = A.TaskSeq
			<if test='myTodo != null and myTodo == "N"'>
				AND M.PrjSeq = #{prjSeq}
			</if>
         JOIN COLLAB_SECTION s on m.sectionseq = s.sectionseq
    LEFT JOIN COLLAB_PROJECT P on m.PrjType='P' and p.PrjSeq = m.PrjSeq
    LEFT JOIN SYS_OBJECT_GROUP T on m.PrjType!='P' and t.GroupId = m.PrjSeq
    LEFT JOIN COLLAB_TEAM_EXEC e on t.groupid = e.groupid AND e.isClose='N'
   INNER JOIN covi_approval4j.jwf_forminstance B 			ON B.FormInstID = A.ObjectID
   INNER JOIN covi_smart4j.sys_object_user sou 			ON B.InitiatorID = sou.userCode
		WHERE 1=1
		<if test='myTodo == "Y"'>
		AND A.RegisterCode = #{userCode}
		</if>
		<include refid="searchMyTask" />
		ORDER BY ModifyDate DESC	
	</select>
	
	<insert id="addProjectTmpl"   parameterType="cmap">
	/* collab.project.addProjectTmpl */
		INSERT INTO covi_smart4j.collab_tmpl_request 
					( prjSeq , tmplKind, RequestTitle, RequestRemark, RequesterCode, RequestStatus, RegisterCode, RegisteDate, ModifierCode, ModifyDate, CompanyCode)
		VALUES		( #{prjSeq}, #{tmplKind},#{requestTitle}, #{requestRemark}, #{USERID}, 'ApprovalRequest', #{USERID}, now(), #{USERID}, now(), #{CompanyCode})
	</insert>
	
	<insert id="addProjectByTmpl"   parameterType="cmap">
	/* collab.project.addProjectByTmpl */
		INSERT INTO covi_smart4j.collab_project 
					( prjName , CompanyCode , StartDate, EndDate, PrjStatus, PrjColor, ProgRate, Remark, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
			(SELECT #{prjName},#{CompanyCode}, #{startDate}, #{endDate}, #{prjStatus}, PrjColor, #{progRate}, Remark, #{USERID}, now(), #{USERID}, now()
			   FROM covi_smart4j.collab_tmpl_project
			  WHERE tmplSeq =  #{tmplSeq})
			    
	   <selectKey keyProperty="PrjSeq" resultType="Integer" order="AFTER">
		    SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>
	
	<insert id="addProjectUserformByTmpl"   parameterType="cmap">
	/* collab.project.addProjectUserformByTmpl */
		INSERT INTO covi_smart4j.collab_project_userform
				(prjSeq, optionTitle, optionType, optionVal, sortKey, RegisterCode, RegisteDate, ModifierCode, ModifyDate )
		(SELECT #{prjSeq}, optionTitle, optionType, optionVal, sortKey, #{USERID}, now(), #{USERID}, now()
		   FROM covi_smart4j.collab_tmpl_project_userform
		  WHERE tmplSeq =  #{tmplSeq})
	</insert>
	
	<insert id="addProjectSectionByTmpl"   parameterType="cmap">
	/* collab.project.addProjectSectionByTmpl */
		INSERT INTO covi_smart4j.collab_section 
					( prjSeq, prjType , SectionName, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
			(SELECT #{prjSeq}, 'P', SectionName, #{USERID}, now(), #{USERID}, now()
			   FROM covi_smart4j.collab_tmpl_section
			  WHERE tmplSeq =  #{tmplSeq})  
	</insert>
	
	<select id="getTmplTaskList" parameterType="cmap" resultType="cmap">
	/* collab.project.getTmplTaskList */
		SELECT TaskName, StartDate, EndDate, Label, ParentKey, TopParentKey, TaskStatus, ProgRate, CloseDate, ObjectType, ObjectID, Remark
				, ns.SectionSeq
	      FROM covi_smart4j.collab_tmpl_task  tt
	      JOIN covi_smart4j.collab_tmpl_section ts on tt.tmplSeq = ts.tmplSeq AND tt.SectionSeq = ts.SectionSeq
	      JOIN covi_smart4j.collab_section ns on ts.SectionName = ns.SectionName AND ns.prjSeq = #{prjSeq} AND ns.prjType = 'P'
	     WHERE tt.tmplSeq =  #{tmplSeq}
	</select>
	
	<insert id="closeTeamExec"   parameterType="cmap">
	/* collab.project.closeTeam */
		UPDATE covi_smart4j.collab_team_exec
		   SET isClose = 'Y'
		   		,CloserCode= #{USERID}
		   		,CloseDate = now()
		 WHERE ExecYear = 	#{execYear}
		   AND GroupId = #{groupID}
	</insert>
	
	<insert id="createTeamExec"   parameterType="cmap">
	 INSERT INTO covi_smart4j.collab_team_exec 
	 			(ExecYear, GroupId ,RegisterCode, RegisteDate)
		  VALUES	( CAST(#{execYear} AS unsigned)+1, #{groupID}, #{USERID}, NOW()      )
		ON DUPLICATE KEY UPDATE    
		    RegisterCode   = #{USERID}    
		    ,RegisteDate     = NOW()      
	</insert>

	<insert id="closeProject"   parameterType="cmap">
	/* collab.project.closeProject */
		UPDATE covi_smart4j.collab_project
		   SET isClose = 'Y'
		   		,CloseDate = NOW()   
		   		,ModifyDate = NOW()   
		   		,ModifierCode= #{USERID}
		 WHERE prjSeq = #{prjSeq}
	</insert>
	
	<insert id="saveProjectChannel"   parameterType="cmap">
	/* collab.project.saveProject */
		UPDATE COVI_SMART4J.COLLAB_PROJECT
		   SET roomId =  #{roomId}
		 WHERE prjSeq =  #{prjSeq}
	</insert>
	
	<select id="getProjectFile" parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectFile*/
		SELECT  f.ServiceType
				, f.FileID
				, f.FileName
				, f.FilePath
				, f.SavedName
				, f.CompanyCode
			 	, f.Size
			 	, f.Extention
			 	, DATE_FORMAT(f.RegistDate, '%Y-%m-%d %H:%i:%s') AS FileRegistDate
			 	, f.SaveType
			 	, f.RegisterCode FileRegisterCode
		 FROM  sys_file f 
		WHERE  f.ObjectID =  #{prjSeq}
		  AND  ServiceType = 'CollabPrj' 
		  AND  MessageID = 0 
		<if test="tagtype != '' and tagtype != 'CTAG'">
			<trim prefix="AND" prefixOverrides="AND |OR">
			${tagData}
			</trim>
		</if>
		<include refid="searchMyTask" />
	</select>
	
	<select id="getProjectFileCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.getProjectFileCnt */
	   SELECT  COUNT(*)
		 FROM  sys_file f 
		WHERE  f.ObjectID =  #{prjSeq}
		  AND  ServiceType = 'CollabPrj' 
		  AND  MessageID = 0 
		<if test="tagtype != '' and tagtype != 'CTAG'">
			<trim prefix="AND" prefixOverrides="AND |OR">
			${tagData}
			</trim>
		</if>
		<include refid="searchMyTask" />
	</select>
	
	<update id="updateSectionChange" parameterType="cmap">
	/* collab.project.updateSectionChange */
		UPDATE covi_smart4j.collab_task_map
		   SET SectionSeq = #{sectionSeq}
		 WHERE PrJSeq =  #{prjSeq}
		   AND PrjType = #{prjType}
		   AND TaskSeq = #{taskSeq}
	</update>
	
	<update id="updateSectionOrder" parameterType="cmap">
	/* collab.project.updateSectionOrder */
		UPDATE covi_smart4j.collab_section
		   SET SectionOrder = #{sectionOrder}
		 WHERE PrJSeq =  #{prjSeq}
		   AND PrjType = #{prjType}
		   AND SectionSeq = #{sectionSeq}
	</update>
	
	<insert id="addProjectFavorite" parameterType="cmap">
	/* collab.project.addProjectFavorite */
		INSERT INTO covi_smart4j.collab_project_favorite
					(PrjSeq, UserCode, RegisterCode, RegisteDate)
		VALUES		( #{prjSeq},#{userCode},#{USERID},now())
		ON DUPLICATE KEY UPDATE    
		    RegisterCode   = #{USERID}    
		    ,RegisteDate     = NOW()     
	</insert>

	<delete id="deleteProjectFavorite" parameterType="cmap">
	/* collab.project.deleteProjectFavorite */
		DELETE FROM covi_smart4j.collab_project_favorite 
		WHERE PrjSeq =  #{prjSeq}
		 	AND UserCode = #{userCode}
	</delete>
	
	<!-- 프로젝트별 알림설정 -->
	<insert id="saveProjectAlarm" parameterType="cmap">
	/* collab.project.saveProjectAlarm */
		INSERT INTO covi_smart4j.collab_project_messaging
					(PrjSeq, UserCode, RegisterCode, RegisteDate)
		VALUES		( #{prjSeq},#{userCode},#{USERID},now())
		ON DUPLICATE KEY UPDATE    
		    RegisterCode   = #{USERID}    
		    ,RegisteDate     = NOW() 
	</insert>
	
	<!-- 프로젝트별 알림해제 -->
	<delete id="cencelProjectAlarm" parameterType="cmap">
	/* collab.project.cencelProjectAlarm */
		DELETE FROM covi_smart4j.collab_project_messaging 
		WHERE PrjSeq =  #{prjSeq}
		 	AND UserCode = #{userCode}
	</delete>
	
	<!-- 진행중 프로젝트 카운트-->
	<select id="getGoingProjectCnt"  parameterType="cmap" resultType="java.lang.Long">
	/* collab.common.getGoingProjectCnt */
		SELECT COUNT(PrjSeq)
		FROM   (
			SELECT distinct cp.PrjSeq
				,(SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName)
							FROM covi_smart4j.collab_project_manager ctm 
						   JOIN covi_smart4j.sys_object_user sou on ctm.userCode = sou.userCode
							WHERE ctm.PrjSeq = cp.PrjSeq
							LIMIT 1) PmUser
			  FROM collab_project cp
			  LEFT  JOIN collab_project_member cpm ON cp.PrjSeq = cpm.PrjSeq AND cpm.UserCode = #{USERID}
		LEFT  JOIN collab_project_manager cpn ON cp.PrjSeq = cpn.PrjSeq AND cpn.UserCode = #{USERID}
		LEFT  JOIN collab_project cpr ON cp.PrjSeq = cpr.PrjSeq AND cpr.RegisterCode = #{USERID}
		LEFT  JOIN collab_project_viewer cpv ON cp.PrjSeq = cpv.PrjSeq AND cpv.UserCode = #{USERID}
			 WHERE 1=1 
			 <if test='isSaaS == "Y"'>
			 	 AND cp.CompanyCode = #{CompanyCode}
			 </if>
			 <if test='inClose == null or inClose == ""'>
			   AND cp.IsClose='N'
			 </if>
			 <if test='isAdmin == null or isAdmin == ""'>
			   AND (cpm.PrjSeq IS NOT NULL OR  cpn.PrjSeq IS NOT NULL OR   cpr.PrjSeq IS NOT NULL 
			   	<if test='includeViewer == "Y"'>
			   	OR   cpv.PrjSeq IS NOT NULL 
			   	</if>
			   )
			 </if>
			 
			<if test="seValue != null and seValue != ''">
				<choose>
					<when test ="seColumn == 'PrjName'.toString()">
						AND cp.PrjName like CONCAT('%', #{seValue}, '%')
					</when>
					<when test ="seColumn == 'PmUser'.toString()">
					    AND (SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName)
							FROM covi_smart4j.collab_project_manager ctm 
						   JOIN covi_smart4j.sys_object_user sou on ctm.userCode = sou.userCode
							WHERE ctm.PrjSeq = cp.PrjSeq
							LIMIT 1) like CONCAT('%', #{seValue}, '%')
					</when>
					<when test ="seColumn == 'RegisterName'.toString()">
					    AND cp.Remark like CONCAT('%', #{seValue}, '%')
					</when>
					<otherwise>
						AND cp.PrjName like CONCAT('%', #{seValue}, '%')
				</otherwise>
				</choose>
			</if>
			
			 <if test="prjStatus != null and prjStatus != ''">
				AND cp.PrjStatus = #{prjStatus}
		  	 </if>
				) p   
	</select>
	
	<!-- 진행중 프로젝트 리스트-->
	<select id="getGoingProject"  parameterType="cmap" resultType="cmap">
	/* collab.common.getGoingProject */
		SELECT PrjSeq, PrjName, PmUser, PrjStatus, ProgRate, IsClose,  DATE_FORMAT(CloseDate ,'%Y-%m-%d %H:%i') CloseDate , PrjColor, Remark, StartDate, EndDate, RegisterCode,  DATE_FORMAT(RegisteDate ,'%Y-%m-%d %H:%i') RegisteDate, IsAlarm 
		FROM   (
			SELECT distinct cp.PrjSeq, cp.PrjName, cp.PrjStatus, cp.ProgRate, cp.IsClose, cp.CloseDate, cp.PrjColor, cp.Remark, cp.StartDate, cp.EndDate, cp.RegisterCode, cp.RegisteDate
				 ,(SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName)
							FROM covi_smart4j.collab_project_manager ctm 
						   JOIN covi_smart4j.sys_object_user sou on ctm.userCode = sou.userCode
							WHERE ctm.PrjSeq = cp.PrjSeq
							LIMIT 1) PmUser
				 , IFNULL((SELECT COUNT(*) FROM covi_smart4j.collab_project_messaging WHERE cp.PrjSeq = PrjSeq AND UserCode = #{USERID}),0) IsAlarm
				  FROM collab_project cp
			LEFT  JOIN collab_project_member cpm ON cp.PrjSeq = cpm.PrjSeq AND cpm.UserCode = #{USERID}
		LEFT  JOIN collab_project_manager cpn ON cp.PrjSeq = cpn.PrjSeq AND cpn.UserCode = #{USERID}
		LEFT  JOIN collab_project cpr ON cp.PrjSeq = cpr.PrjSeq AND cpr.RegisterCode = #{USERID}
		LEFT  JOIN collab_project_viewer cpv ON cp.PrjSeq = cpv.PrjSeq AND cpv.UserCode = #{USERID}
			 WHERE 1=1 
			 <if test='isSaaS == "Y"'>
			 	 AND cp.CompanyCode = #{CompanyCode}
			 </if>
			 <if test='inClose == null or inClose == ""'>
			   AND cp.IsClose='N'
			 </if>
			 <if test='isAdmin == null or isAdmin == ""'>
			   AND (cpm.PrjSeq IS NOT NULL OR  cpn.PrjSeq IS NOT NULL OR   cpr.PrjSeq IS NOT NULL 
			   	<if test='includeViewer == "Y"'>
			   	OR   cpv.PrjSeq IS NOT NULL 
			   	</if>
			   )
			 </if>
			 
			<if test="seValue != null and seValue != ''">
				<choose>
					<when test ="seColumn == 'PrjName'.toString()">
						AND cp.PrjName like CONCAT('%', #{seValue}, '%')
					</when>
					<when test ="seColumn == 'PmUser'.toString()">
					    AND (SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName)
							FROM covi_smart4j.collab_project_manager ctm 
						   JOIN covi_smart4j.sys_object_user sou on ctm.userCode = sou.userCode
							WHERE ctm.PrjSeq = cp.PrjSeq
							LIMIT 1) like CONCAT('%', #{seValue}, '%')
					</when>
					<when test ="seColumn == 'RegisterName'.toString()">
					    AND cp.Remark like CONCAT('%', #{seValue}, '%')
					</when>
					<otherwise>
						AND cp.PrjName like CONCAT('%', #{seValue}, '%')
				</otherwise>
				</choose>
			</if>
			
			 <if test="prjStatus != null and prjStatus != ''">
				AND cp.PrjStatus = #{prjStatus}
		  	 </if>
			 
				) p   
		
		ORDER BY RegisteDate desc
		
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
		   LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="getSurveyInfo" parameterType="cmap" resultType="cmap">
		SELECT	A.SurveyID
		  		, State 
				, case when C.TargetCode is not null then 'Y' else 'N' end as IsResponse
				, case when d.RespondentID is not null then 'Y' else 'N' end as IsAnswer 
		 FROM covi_smart4j.survey A
	LEFT JOIN covi_smart4j.survey_target_respondent C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
	LEFT JOIN covi_smart4j.survey_respondent d ON A.SurveyID = d.SurveyID AND d.RespondentCode = #{userCode}
		WHERE a.surveyID= #{surveyID}  
	</select>	
</mapper>

