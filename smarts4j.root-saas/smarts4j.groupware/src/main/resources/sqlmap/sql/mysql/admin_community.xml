<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin.community">
	<select id="selectCommunityDomain" parameterType="cmap" resultType="cmap">
	 	SELECT dn.DomainID
	 		, dn.DomainCode
	 		, Fn_BaseGetDictionary_S(#{lang}, dn.MultiDisplayName) AS DisplayName
	 	FROM sys_object_group AS gr
		INNER JOIN sys_object_domain AS dn on gr.CompanyCode = dn.DomainCode
		WHERE gr.GroupType = 'Company' 
		AND gr.IsUse = 'Y'
		AND dn.IsUse = 'Y'
		<if test="assignedDomain.size() > 0">
			AND DomainID IN 
			<foreach item="item" index="index" collection="assignedDomain" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
		ORDER BY
		<if test="domainID != null and domainID != ''">
		 	 dn.DomainID = #{domainID} DESC,
		</if>
		gr.SortKey ASC
	</select>
	
	<select id="selectCommunityTreeData" parameterType="cmap" resultType="cmap">
		SELECT		 cc.CategoryID AS FolderID
					,cc.DN_ID
					,cc.FolderType AS itemType
					,cc.FolderType
					,cc.FolderType AS type
					,cc.FolderAlias
					,IFNULL(Fn_GetSelDictionary(#{lang},CONCAT('CUCT_',cc.CategoryID), cc.DN_ID),cc.DisplayName)AS DisplayName  
					,IFNULL(Fn_GetSelDictionary(#{lang},CONCAT('CUCT_',cc.CategoryID), cc.DN_ID),cc.DisplayName)AS FolderName  
					,cc.MemberOf
					,cc.FolderPath
					,cc.SortKey
					,cc.SortPath
					,cc.IsUse
					,cc.Description
					,cc.RegisterCode
					,cc.RegistDate
					,cc.ModifierCode
					,cc.ModifyDate
					,cc.DeleteDate
					,cc.Reserved1
					,cc.Reserved2
					,(SELECT COUNT(*) FROM community_category AS cca WHERE cca.MemberOf = cc.CategoryID AND cca.IsUse = 'Y' AND cca.DeleteDate IS NULL) AS hasChild
		FROM community_category AS cc
		WHERE 1=1 
		AND cc.DN_ID = #{DN_ID}
		AND cc.DeleteDate IS NULL 
		<if test="isAll == null || isAll == ''">
		AND cc.IsUse = 'Y'
		</if>
		ORDER BY FolderType DESC, SortKey ASC 
	</select>
	
	<select id="selectCommunityGridListCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM community_category
		WHERE 1=1
		AND DeleteDate IS NULL
		<choose>
			<when test="MemberOf == null or MemberOf == '' and CategoryID == null or CategoryID == ''">
				AND DN_ID = #{DN_ID}
				AND FolderType = 'Root' 
			</when>
			<otherwise>
				AND MemberOf = #{CategoryID}
			</otherwise>
		</choose>
	</select>
	
	<select id="selectCommunityGridList" parameterType="cmap" resultType="cmap">
		SELECT  CategoryID
			  , DN_ID
			  , MN_ID
			  , FolderType
			  , FolderAlias
			  , DisplayName
			  , MemberOf
			  , FolderPath
			  , SortKey
			  , SortPath
			  , IsUse
			  , Description
			  , RegisterCode
			  , (SELECT DisplayName FROM sys_object_user WHERE UserCode = RegisterCode) AS RegDisplayName
			  , RegistDate AS RegistDate
		FROM community_category
		WHERE 1=1
		AND DeleteDate IS NULL 
		<choose>
			<when test="MemberOf == null or MemberOf == '' and CategoryID == null or CategoryID == ''">
				AND DN_ID = #{DN_ID}
				AND FolderType = 'Root' 
			</when>
			<otherwise>
				AND MemberOf = #{CategoryID}
			</otherwise>
		</choose>
		<trim prefix="ORDER BY" prefixOverrides =","> 
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !=''"> 
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("Description")'>Description</when>
					<when test='sortColumn.equalsIgnoreCase("FolderAlias")'>FolderAlias</when>
					<when test='sortColumn.equalsIgnoreCase("IsUse")'>IsUse</when>
					<when test='sortColumn.equalsIgnoreCase("RegDisplayName")'>RegDisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("RegistDate")'>RegistDate</when>
					<otherwise>SortKey</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="selectCommunitySubGridList" parameterType="cmap" resultType="cmap">
		SELECT	c.CU_ID
				, c.MN_ID
				, c.CategoryID
				, c.CU_Code
				, c.DN_ID
				, c.SearchTitle
				, c.CommunityName
				, c.CreatorCode
				, c.AppStatus
				, DATE_FORMAT(c.RegRequestDate,'%Y-%m-%d')AS RegRequestDate
				, cc.FolderPath
				, cc.SortPath
				, cc.DisplayName AS CategoryName
				, (SELECT COUNT(*) FROM community_member WHERE  MemberLevel != '0' AND MemberStatus = 'R' AND DetailStatus = 'RV' AND CU_ID = c.CU_ID ) AS MembersCount
				, c.RegProcessDate AS RegProcessDate
				, c.Point
				, c.MemberCount
				, c.Grade
				, c.MsgCount
				, sou.DisplayName
				, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS CuAppDetail
				, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityJoin', c.JoinOption)) AS CommunityJoin
				, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityType', c.CommunityType)) AS CommunityType
				, OperatorName
				, OperatorCode
		FROM community AS c
		INNER JOIN sys_object_group AS sog ON sog.GroupCode = c.CU_Code
		LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.CreatorCode
		INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID
		WHERE 1=1 
		AND c.DN_ID = #{DN_ID}
		AND c.Gubun = 'C'
		<choose>
			<when test="MemberOf != null and MemberOf != '' and CategoryID != null and CategoryID != '' and pType != 'Root' and pType != null and pType != ''">
				<if test="CategoryID != null and CategoryID != ''">
					AND cc.CategoryID = #{CategoryID}
				</if>
			</when>
			<when test="CategoryID != null and CategoryID != '' and pType == 'Root'">
				AND (cc.MemberOf = #{CategoryID} OR cc.CategoryID = #{CategoryID})
			</when>
		</choose>
		<if test="searchValue != null and searchValue != ''">
			<choose>
				<when test ="searchOption == '0'.toString()">
					AND (c.CommunityName LIKE CONCAT('%',#{searchValue},'%')	
					 OR IFNULL(sou.DisplayName,'') LIKE CONCAT('%',#{searchValue},'%') )
				</when>
				<when test ="searchOption == '1'.toString()">
					AND c.CommunityName LIKE CONCAT('%',#{searchValue},'%') 
				</when>
				<when test ="searchOption == '2'.toString()">
					AND IFNULL(sou.DisplayName,'') LIKE CONCAT('%',#{searchValue},'%') 
				</when>
				<when test ="searchOption == '3'.toString()">
					AND c.OperatorName LIKE CONCAT('%',#{searchValue},'%') 
				</when>
			</choose>
		</if>
		<if test = "communityJoin != null and communityJoin != '' ">
			AND c.JoinOption = #{communityJoin}
		</if>	
		<if test = "communityType != null and communityType != '' ">
			AND c.CommunityType = #{communityType}
		</if>	
		<if test = "communityDetail != null and communityDetail != '' ">
			AND c.AppStatus = #{communityDetail}
		</if>
		<trim prefix="ORDER BY" prefixOverrides =","> 
 			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' "> 
				<choose>
					<when test='sortColumn.equalsIgnoreCase("CategoryName")'>CategoryName</when>
					<when test='sortColumn.equalsIgnoreCase("CU_Code")'>CU_Code</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityName")'>CommunityName</when>
					<when test='sortColumn.equalsIgnoreCase("CuAppDetail")'>CuAppDetail</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityType")'>CommunityType</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityJoin")'>CommunityJoin</when>
					<when test='sortColumn.equalsIgnoreCase("Point")'>(Point + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("MembersCount")'>(MembersCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("Grade")'>(Grade + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("MsgCount")'>(MsgCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("RegProcessDate")'>RegProcessDate</when>
					<otherwise>CU_ID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
			, c.CU_ID ASC
 		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="selectCommunitySubGridListCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM community AS c 
		INNER JOIN sys_object_group AS sog ON sog.GroupCode = c.CU_Code
		LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.CreatorCode
		INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID
		WHERE 1=1 
		AND c.DN_ID = #{DN_ID}
		AND c.Gubun = 'C'
		<choose>
			<when test="MemberOf != null and MemberOf != '' and CategoryID != null and CategoryID != '' and pType != 'Root' and pType != null and pType != ''">
				<if test="CategoryID != null and CategoryID != ''">
					AND cc.CategoryID = #{CategoryID}
				</if>
			</when>
			<when test="CategoryID != null and CategoryID != '' and pType == 'Root'">
				AND (cc.MemberOf = #{CategoryID} OR cc.CategoryID = #{CategoryID})
			</when>
		</choose>
		<if test="searchValue != null and searchValue != ''">
			<choose>
				<when test ="searchOption == '0'.toString()">
					AND (c.CommunityName LIKE CONCAT('%',#{searchValue},'%')	
					 OR IFNULL(sou.DisplayName,'') LIKE CONCAT('%',#{searchValue},'%') )
				</when>
				<when test ="searchOption == '1'.toString()">
					AND c.CommunityName LIKE CONCAT('%',#{searchValue},'%') 
				</when>
				<when test ="searchOption == '2'.toString()">
					AND IFNULL(sou.DisplayName,'') LIKE CONCAT('%',#{searchValue},'%') 
				</when>
				<when test ="searchOption == '3'.toString()">
					AND c.OperatorName LIKE CONCAT('%',#{searchValue},'%') 
				</when>
			</choose>
		</if>
		<if test = "communityJoin != null and communityJoin != '' ">
			AND c.JoinOption = #{communityJoin}
		</if>	
		<if test = "communityType != null and communityType != '' ">
			AND c.CommunityType = #{communityType}
		</if>	
		<if test = "communityDetail != null and communityDetail != '' ">
			AND c.AppStatus = #{communityDetail}
		</if>
	</select>
	
	<update id="updateCategoryUseChange" parameterType="cmap" >
		UPDATE community_category
		SET 
			IsUse = #{IsUse}
		WHERE 1=1
		AND CategoryID = #{CategoryID}
	</update>
	
	<select id="setCurrentLocation"  parameterType="cmap" resultType="cmap"> 
		<![CDATA[  
			SELECT DisplayName, '0' AS num 
			FROM sys_object_domain 
			WHERE DomainID = #{DN_ID}
			
			UNION ALL 
			
			SELECT DisplayName, num FROM (
				SELECT * FROM (
					SELECT @r AS id
						  , (SELECT DisplayName FROM community_category WHERE CategoryID = id ) AS DisplayName	
						  , (SELECT @r := MemberOf FROM community_category WHERE CategoryID = id) AS parentId
						  , (@L := @L - 1) AS num
					FROM (SELECT @r := #{CategoryID}, @L := 1 + COUNT(*) FROM (
						SELECT @r AS id
							  , (SELECT @r := MemberOf FROM community_category WHERE CategoryID = id) AS parentId
						FROM (SELECT @r := #{CategoryID}, @L := 0) AS recursion, (SELECT * FROM community_category ) AS compare
						WHERE @r <> 0)C
					) AS recursion, (SELECT * FROM community_category ) AS compare
					WHERE @r <> 0
					ORDER BY num
				)A
			)B 
		]]>
	</select>
	
	<select id="selectCategoryID" parameterType="cmap" resultType="String">
		SELECT CategoryID 
		FROM community_category 
		WHERE DN_ID = #{DN_ID}
		AND FolderType = 'Root' 
		AND DeleteDate IS NULL 
		ORDER BY SortKey+0 ASC, CategoryID ASC  
		LIMIT 1
	</select>
	
	<select id="selectCommunityBaseCode" parameterType="cmap" resultType="cmap">
		SELECT	Code AS optionValue
			  , CodeName AS optionText
		FROM sys_base_code sbc
		WHERE 1=1
		AND CodeGroup = #{CodeGroup}
		AND Code !=  #{CodeGroup}
		AND IsUse = 'Y'
		AND DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = sbc.Code AND CodeGroup = #{CodeGroup} ORDER BY IF(DomainID = #{domainID}, 0, 1) LIMIT 1 )
		ORDER BY SortKey ASC
	</select>
	
	<select id="selectProperty" parameterType="cmap" resultType="cmap">
		/* queryId : admin.community.selectProperty */
		SELECT  c.CategoryID
			  , c.DN_ID
			  , c.MN_ID
			  , c.FolderType
			  , c.FolderAlias
			  , c.DisplayName
			  , c.MemberOf
			  , c.FolderPath
			  , c.SortKey
			  , c.SortPath
			  , c.IsUse
			  , c.Description
			  , c.RegisterCode
			  , IFNULL((SELECT DisplayName FROM community_category AS cc WHERE cc.CategoryID = c.MemberOf),'') AS parentDisplayName
			  , (SELECT DisplayName FROM sys_object_user WHERE UserCode = c.RegisterCode)AS RegDisplayName
			  , DATE_FORMAT(c.RegistDate,'%Y-%m-%d')AS RegistDate
			  , CONCAT( IFNULL(bd.KoFull,''), ';'
						, IFNULL(bd.EnFull,''), ';'
                        , IFNULL(bd.JaFull,''), ';'
                        , IFNULL(bd.ZhFull,''), ';;;;;;;'
				) AS MultiDisplayName
		FROM community_category c
		LEFT JOIN sys_base_dictionary bd ON bd.DicCode = CONCAT('CUCT_',c.CategoryID) AND bd.DomainID = #{DN_ID}
		WHERE 1=1
		AND c.DeleteDate IS NULL
		<choose>
			<when test="CategoryID == null or CategoryID == ''">
				 AND c.CategoryID = (SELECT CategoryID 
									FROM community_category 
									WHERE DN_ID = #{DN_ID}
										 AND FolderType = 'Root' 
									 AND DeleteDate IS NULL 
									 AND CategoryID = #{CategoryID}
									 ORDER BY SortKey+0 ASC, CategoryID ASC  
									 LIMIT 1 
								)
			</when>
			<otherwise>
				AND c.CategoryID = #{CategoryID}
			</otherwise>
		</choose>
	</select>
	
	<update id="updateCommunityProperty" parameterType="cmap">
		UPDATE community_category SET
									  DisplayName = #{DisplayName}
									, MemberOf = #{MemberOf}
									, FolderPath = IFNULL(#{MemberOf},CONCAT(#{MemberOf},';'))
									, SortKey = #{SortKey}
									, SortPath = covi_smart4j.Fn_ComSortPathCreate_S(#{CategoryID}, '', 'CC')
									, IsUse =  #{IsUse}
									, Description = #{Description}
		WHERE CategoryID = #{CategoryID}
	</update>
	
	<update id="updateCommunitySubProperty" parameterType="cmap">
		UPDATE community_category 
		SET SortPath = covi_smart4j.Fn_ComSortPathCreate_S(CategoryID,'','CC')
		WHERE MemberOf = #{CategoryID}
	</update>
	
	<select id="communityDictionaryCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM sys_base_dictionary 
		WHERE 1=1 
		AND DicCode = CONCAT('CUCT_',#{CategoryID})
		AND DomainID = #{DN_ID} 
	</select>
	
	<insert id="createCommunityDictionary" parameterType="cmap">
		INSERT INTO sys_base_dictionary
		(
			  DomainID
			, DicCode
			, KoShort
			, KoFull
			, EnShort
			, EnFull
			, JaShort
			, JaFull
			, ZhShort
			, ZhFull
			, IsUse
			, IsCaching
			, RegisterCode
			, RegistDate
		) VALUES (
			  #{DN_ID}			
			, CONCAT('CUCT_',#{CategoryID})
			, #{DIC_Code_ko} 
			, #{DIC_Code_ko} 
			, #{DIC_Code_en}
			, #{DIC_Code_en}
			, #{DIC_Code_ja}
			, #{DIC_Code_ja}
			, #{DIC_Code_zh}
			, #{DIC_Code_zh}
			, 'Y'
			, 'Y'
			, #{userID}
			, NOW(3) 
		 )
	</insert>
	
	<update id="updateCommunityDictionary" parameterType="cmap">
		UPDATE sys_base_dictionary
		SET 
			  KoShort = #{DIC_Code_ko} 
			, KoFull = #{DIC_Code_ko} 
			, EnShort = #{DIC_Code_en}
			, EnFull = #{DIC_Code_en}
			, JaShort = #{DIC_Code_ja}
			, JaFull = #{DIC_Code_ja}
			, ZhShort = #{DIC_Code_zh}
			, ZhFull = #{DIC_Code_zh} 
			, ModifierCode = #{userID}
			, ModifyDate = NOW(3)
		WHERE 1=1
		AND DicCode = CONCAT('CUCT_',#{CategoryID}) 				
		AND DomainID = #{DN_ID} 
	</update>
	
	<select id="selectCommunitySubProperty" parameterType="cmap" resultType="cmap">
		SELECT COUNT(*) AS cnt
			, GROUP_CONCAT(CategoryID) AS subCategoryID
		FROM covi_smart4j.community_category
		WHERE MemberOf = #{CategoryID}
	</select>
	
	<insert id="createCommunityProperty" parameterType="cmap">
		INSERT INTO community_category
		(			
			  DN_ID
			, MN_ID
			, FolderType
			, FolderAlias
			, DisplayName
			, MemberOf
			, FolderPath
			, SortKey
			, SortPath
			, IsUse
			, Description
			, RegisterCode
			, RegistDate
		) VALUES (
			  #{DN_ID}
			, #{MN_ID}  
			, #{FolderType}
			, #{FolderAlias}
			, #{DisplayName}
		 	, #{MemberOf}
		 	, CONCAT(#{MemberOf},';')
		 	, #{SortKey}
		 	, IFNULL(CONCAT(covi_smart4j.Fn_ComSortPathCreate_S(#{MemberOf}, '', 'CC'),CONCAT(LEFT('000000000000000', 15 - LENGTH(#{SortKey})) , #{SortKey} , ';')),CONCAT(LEFT('000000000000000', 15 - LENGTH(1)) , #{SortKey} , ';'))
		 	, #{IsUse}
		 	, #{Description}
		 	, #{userID}
		 	, NOW(3)
		)
		<selectKey resultType="java.lang.Long" keyProperty="CategoryID" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>		
	</insert>
	
	<update id="deleteCategory" parameterType="cmap">
		UPDATE community_category
		SET 
			  DeleteDate = NOW(3)
			, ModifierCode = #{userID}
		WHERE 1=1 
		AND CategoryID = #{paramArr}
	</update>

	<select id="selectCommunityInCategory" parameterType="cmap" resultType="cmap">
		SELECT 	CU_ID
		FROM 	community
		WHERE 	CategoryID = #{paramArr}
	</select>
		
	<update id="moveCommunityCategory" parameterType="cmap">
		UPDATE community_category 
		SET MemberOf = #{MemberOf}
			, FolderType = #{FolderType}
			, FolderPath = CONCAT(#{MemberOf},';')
			, ModifierCode = #{userID}
			, ModifyDate = NOW(3)
		WHERE 1=1 
		AND CategoryID = #{paramArr}		
	</update>
	
	<update id="updateCommunitySortProperty" parameterType="cmap">
		UPDATE community_category 
		SET SortPath = covi_smart4j.Fn_ComSortPathCreate_S(CategoryID,'','CC')
		WHERE CategoryID = #{CategoryID}	
	</update>
	
	<update id="createCommunityInfomationCode" parameterType="cmap">
		UPDATE community
		SET 
			CU_CODE =  CONCAT('Community', #{CU_ID})
		WHERE CU_ID = #{CU_ID}
	</update>
	
	<update id="updateCommunityStatus" parameterType="cmap">
		UPDATE community
		SET
			  RegStatus = #{RegStatus}
			, AppStatus = #{AppStatus}
			, ProcesserCode = #{userID}
		WHERE 1=1
		AND CU_ID = #{CU_ID}
	</update>
	
	<select id="checkCommunityNameCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM community
		WHERE CommunityName = #{DisplayName}
		AND DN_ID = #{domainID}
	</select>
	
	<select id="checkCommunityAliasCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM community
		WHERE CU_Code = #{CU_Code}
	</select>
	
	<select id="communityCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM sys_base_dictionary 
		WHERE 1=1 
		AND DicCode = CONCAT('CU_', #{CU_ID})
		AND DomainID = #{DN_ID}
	</select>
	
	<update id="updateCommunityNameDictionary" parameterType="cmap">
		UPDATE sys_base_dictionary
		SET
			 KoShort = #{DIC_Code_ko}
			, KoFull = #{DIC_Code_ko}
			, EnShort = #{DIC_Code_en}
			, EnFull = #{DIC_Code_en}
			, JaShort = #{DIC_Code_ja}
			, JaFull = #{DIC_Code_ja}
			, ZhShort = #{DIC_Code_zh}
			, ZhFull = #{DIC_Code_zh} 
			, ModifierCode = #{userID}
			, ModifyDate = NOW(3)
		WHERE 1=1
		AND DicCode = CONCAT('CU_', #{CU_ID})
		AND DomainID = #{DN_ID}
	</update>
	
	<insert id="createCommunityNameDictionary" parameterType="cmap">
		INSERT INTO sys_base_dictionary
		(
			  DomainID
			, DicCode
			, KoShort
			, KoFull
			, EnShort
			, EnFull
			, JaShort
			, JaFull
			, ZhShort
			, ZhFull
			, IsUse
			, IsCaching
			, RegisterCode
			, RegistDate
		)VALUES(
			  #{DN_ID}			
			, CONCAT('CU_',#{CU_ID})
			, #{DIC_Code_ko} 
			, #{DIC_Code_ko} 
			, #{DIC_Code_en}
			, #{DIC_Code_en}
			, #{DIC_Code_ja}
			, #{DIC_Code_ja}
			, #{DIC_Code_zh}
			, #{DIC_Code_zh}
			, 'Y'
			, 'Y'
			, #{userID}
			, NOW(3) 
		 )
	</insert>
	
	<insert id="createCommunityInfomation" parameterType="cmap" useGeneratedKeys="true">
		INSERT INTO community
		(
			   CU_Code
			 , CategoryID
			 , DN_ID
			 , MN_ID
			 , CommunityType
			 , CommunityName
			 , JoinOption
			 , RegStatus
			 , AppStatus
			 , DefaultMemberLevel
			 , RegProcessDate
			 , LimitFileSize
			 , SearchTitle
			 , SearchSummary
			 , OperatorCode
			 , OperatorName
			 , DefaultBoardType
			 , RegRequestDate
		) VALUES (
			   #{CU_Code}
			 , #{_ParentID}
			 , #{DN_ID}
			 , #{MN_ID}
			 , #{ddlType}
			 , #{txtCommunityName}
			 , #{ddlJoinMothod}
			 , 'R'
			 , 'RV'
			 , #{ddlMemberLevel}
			 , NOW(3)
			 , '300'
			 , #{textLineIntroduction}
			 , #{txtSummary}
			 , #{txtOperator}
			 , (SELECT DisplayName FROM sys_object_user WHERE UserCode = #{txtOperator})
			 , #{ddlDefaultBoardType}
			 , NOW(3)
		)
		<selectKey resultType="java.lang.Long" keyProperty="CU_ID" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>	
	</insert>
	
	<insert id="createCommunityDetailInfomation" parameterType="cmap">
		INSERT INTO community_detail
		(
			  CU_ID
			, Keyword
			, Description
			, DescriptionEditor
			, Provision
			, ProvisionEditor
		) VALUES (
			  #{CU_ID}
			, #{txtKeyword}
			, #{txtIntroduction}
			, #{txtIntroduction}
			, #{txtStipulation}
			, #{txtStipulation}
		)
	</insert>
	
	<update id="updateCommunityGroupCode" parameterType="cmap">
		UPDATE sys_object_group SET IsDisplay = #{IsDisplay},  IsUse = #{IsUse}
		WHERE GroupCode IN (SELECT CU_Code FROM community WHERE CU_ID = #{CU_ID})
	</update>
	
	<update id="updateCommunityGroupFD" parameterType="cmap">
		UPDATE sys_object_folder SET 
									  IsUse = #{IsUse}
									, IsDisplay = #{IsDisplay}
		WHERE FolderID IN (
			SELECT LinkFD 
			FROM community_menu_top 
			WHERE FD_ID = 0	
			AND CU_ID = #{CU_ID}
		)
	</update>
	
	<select id="selectCommunityHomeCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT	COUNT(*)
		FROM community AS A 
		INNER JOIN sys_object_domain AS B 
		ON A.DN_ID = B.DomainID 
		WHERE  A.CU_ID NOT IN (SELECT CU_ID FROM community_home WHERE CU_ID = #{CU_ID})
		AND RegStatus = 'R'
	</select>
	
	<insert id="createCommunityHome" parameterType="cmap">
		INSERT INTO community_home
		(	 
			LayoutID
			,CU_ID	
			,CommunityTheme
			,IsUse
			,RegisterCode
		)
		SELECT 
			 LayoutID
			,#{CU_ID}
			,CommunityTheme
			,IsUse
			,#{userID}
		FROM community_home_default
		ORDER BY CU_ID ASC 
		LIMIT 1 
	</insert>
	
	<select id="selectCommunityACLCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM sys_object_acl
		WHERE 1=1 
		AND ObjectID = #{ObjectID}
		AND ObjectType = #{ObjectType}
		AND SubjectCode = #{SubjectCode}
		AND SubjectType = #{SubjectType}
	</select>
	
	<select id="selectCommunityInfo" parameterType="cmap" resultType="cmap">
		SELECT  c.CU_ID
			  , c.CU_Code
			  , c.CategoryID
			  , c.DN_ID
			  , c.OperatorCode
			  , c.CommunityType
			  , sod.DomainID
			  , sod.DomainCode
			  , sod.DomainURL
			  , sod.DisplayName
			  , sod.MultiDisplayName
			  , sod.ShortName
			  , sod.MultiShortName
			  , sod.MemberOf
			  , sod.DomainPath
			  , sod.SortKey
			  , sod.SortPath
			  , sod.IsUse
			  , sod.ServiceUser
			  , sod.ServiceStart
			  , sod.ServiceEnd
			  , sod.Description
			  , sod.RegistDate
			  , sod.DeleteDate
			  , sod.MenuSyncTime
			  , c.CommunityName
			  , c.DefaultBoardType
		FROM community c
		INNER JOIN sys_object_domain sod ON sod.DomainID = c.DN_ID
		WHERE 1=1 
		AND c.CU_ID = #{CU_ID}
	</select>
	
	<insert id="createCommunityACL" parameterType="cmap">
		INSERT INTO sys_object_acl
		(				
			  ObjectID
			, ObjectType
			, SubjectCode
			, SubjectType
			, AclList
			, Security
			, `Create`
			, `Delete`
			, `Modify`
			, `Execute`
			, `View`
			, `Read`
			, RegisterCode
			, RegistDate
		) VALUES (
			  #{ObjectID}
			, #{ObjectType}
			, #{SubjectCode}	
			, #{SubjectType}
			, #{AclList}
			, #{Security}
			, #{Create}
			, #{Delete}
			, #{Modify}
			, #{Execute}
			, #{View}
			, #{Read}
			, #{userCode}
			, NOW(3) 			
		)
	</insert>
	
	<update id="updateCommunityACL" parameterType="cmap">
		UPDATE sys_object_acl SET
			  ObjectID = #{ObjectID}
			, ObjectType = #{ObjectType}
			, SubjectCode = #{SubjectCode}
			, SubjectType = #{SubjectType}
			, AclList = #{AclList}
			, Security = #{Security}
			, `Create` = #{Create}
			, `Delete` = #{Delete}
			, `Modify` = #{Modify}
			, `Execute` = #{Execute}
			, `View` = #{View}
			, `Read` = #{Read}
			, ModifierCode = #{userCode}
			, ModifyDate = NOW(3)
		WHERE 1=1 
		AND ObjectID = #{ObjectID}
		AND ObjectType = #{ObjectType}
		AND SubjectCode = #{SubjectCode}
		AND SubjectType = #{SubjectType}
	</update>
	
	<select id="selectCommunityMemberCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM community_member 
		WHERE CU_ID = #{CU_ID}
		AND UR_CODE = #{userID}
	</select>
	
	<select id="selectCommunityGroupCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM sys_object_group_member
		WHERE GroupCode = #{CU_ID}
		AND UserCode = #{userID}
	</select>
	
	<insert id="createCommunityMember" parameterType="cmap">
		INSERT INTO community_member
		(
			  CU_ID
			, UR_CODE
			, NickName
			, MemberStatus
			, DetailStatus
			, MemberLevel
			, RegMessage	
		)VALUES(
			  #{CU_ID}
			, #{userID}
			, (SELECT DisplayName FROM sys_object_user WHERE UserCode = #{userID})
			, 'R'
			, 'RV'
			, 9
			, ''
		)
	</insert>
	
	<insert id="createCommunityGroup" parameterType="cmap">
		INSERT INTO sys_object_group_member
		(	
			  GroupCode
			, UserCode
			, SortKey
			, Role
			, IsUse
			, IsHR
			, MemberStatus
		)VALUES(
			  #{CU_ID}
			, #{userID}  			
			, 100
			, 'sysops'
			, 'Y'
			, 'N'
			, 'A'
		)
	</insert>
	
	<update id="updateCommunityMemberCount" parameterType="cmap">
		UPDATE community SET MemberCount = MemberCount + 1 
		WHERE CU_ID = #{CU_ID}
	</update>
	
	<insert id="createCommunityFolder" parameterType="cmap">
		INSERT INTO sys_object_folder
		( 
			 DomainID
			,MenuID
			,ObjectType
			,FolderType
			,DisplayName
			,MultiDisplayName
			,MemberOf
			,FolderPath
			,SortKey
			,SortPath
			,IsInherited
			,IsShared
			,IsUse
			,IsDisplay
			,IsURL
			,URL
			,Description
			,OwnerCode
			,RegisterCode
			,RegistDate
			,SecurityLevel
			,Reserved2
		) VALUES (
			 #{DN_ID}
			,#{MenuID}
			,'Community'
			,#{FolderType}		
			,#{CommunityName}
			,#{CommunityName}
			,#{MemberOf}				
			,''				
			,#{SortKey}				
			,#{SortPath}			
			,#{IsInherited}				
			,'N'			
			,'Y'			
			,'Y'			
			,'N'		
			,''				
			,''				
			,#{userID}	
			,#{userID}	
			,NOW(3)		
			,#{SecurityLevel}	
			,#{Reserved2}					
		)
		<selectKey resultType="java.lang.Long" keyProperty="FolderID" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>								 
	</insert>
	
	<select id="communityFolderList" parameterType="cmap" resultType="cmap">
		SELECT  FolderType 
			  , DisplayName AS FolderName
			  , SortKey
		FROM community_board_default 
		WHERE IsUse = 'Y'
		AND DN_ID IN (0, #{DN_ID})
		AND CommunityType = #{DefaultBoardType}
		ORDER BY SortKey
	</select>
	
	<insert id="createCommunityFolderDictionary" parameterType="cmap" >
		INSERT INTO sys_base_dictionary
		(
			  DicCode
			, DomainID
			, KoShort
			, KoFull
			, EnShort
			, EnFull
			, JaShort
			, JaFull
			, ZhShort
			, ZhFull
			, DicSection
			, IsUse
			, IsCaching
			, Description
		)
		SELECT	  CONCAT('CUFD_', MAX(DicID)+1)
				, #{DN_ID}
				, KoShort
				, KoFull
				, EnShort
				, EnFull
				, JaShort
				, JaFull
				, ZhShort
				, ZhFull
				, 'CUFD'
				, IsUse
				, IsCaching
				, Description 
		 FROM sys_base_dictionary 
		 WHERE DicCode = #{DIC_Code}  
	</insert>
	
	<select id="selectCommunityMenuTopCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM community_menu_top
		WHERE 1=1
		AND CU_ID = #{CU_ID}
		AND FD_ID = #{FolderID}
	</select>
	
	<insert id="createCommunityMenuTop" parameterType="cmap">
		INSERT INTO community_menu_top(CU_ID, FD_ID, SortKey)
		SELECT	  #{CU_ID}
				, #{FolderID}
				, IFNULL(MAX(SortKey), -1) + 1
		FROM community_menu_top
		WHERE CU_ID = #{CU_ID}
	</insert>
	
	<select id="selectCommunityBoardCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) FROM board_config bc
		INNER JOIN sys_object_folder sof ON sof.FolderID = bc.FolderID 
		WHERE 1=1 AND sof.ObjectType = 'Community'
		AND MenuID =  #{CU_ID}
	</select>
	
	<insert id="createBoardConfig"  parameterType="cmap">
		INSERT INTO board_config 
		(
			 FolderID
			,UseBasicConfig
			,UseFile 
			,UseImage 
			,UseVideo
			,UsePopNotice 
			,UseTopNotice 
			,UseExpiredDate 
			,UseAnony 
			,UseReply 
			,UseComment 
			,UseInterest 
			,UseFavorite 
			,UseRecommend 
			,UseSecret 
			,UseTag
			,UseLink 
			,UsePrint 
			,LimitFileSize 
			,LimitFileCnt 
			,LimitCommentCnt 
			,LimitLinkCnt 
			,RecentlyDay 
			,ExpireDay 
			,DefaultContents 
			,UseScrap 
			,UseCopy 
			,UseCommentRecommend 
			,UseLogWrite
			,UseReadCnt 
			,UseTrackback 
			,UseRSS
			,UseReaderView 
			,UseDefaultSecret 
			,UseEmail 
			,UseCategory
			,UseBodyForm
			,UseUserForm
			,UseOwnerProcess
			,UseUserProcess
			,RegisterCode 
			,RegistDate
			,BoardTotalLimitFileSize
			,CurrentTotalFileSize
			,UseReservation
			,UsePubDeptName
		)	
		SELECT 
			 #{FolderID} 
			,'Y' 
			,UseFile 
			,UseImage 
			,UseVideo
			,'N' 
			,UseTopNotice 
			,UseExpiredDate 
			,UseAnony 
			,UseReply 
			,UseComment 
			,UseInterest 
			,'N' 
			,UseRecommend 
			,UseSecret 
			,UseTag 
			,UseLink 
			,UsePrint 
			,LimitFileSize 
			,LimitFileCnt 
			,LimitCommentCnt 
			,LimitLinkCnt 
			,RecentlyDay 
			,ExpireDay 
			,DefaultContents 
			,UseScrap 
			,UseCopy 
			,UseCommentRecommend 
			,UseLogWrite
			,UseReadCnt 
			,UseTrackback 
			,UseRSS
			,UseReaderView 
			,UseDefaultSecret 
			,UseEmail 
			,UseCategory
			,UseBodyForm
			,UseUserForm
			,'N'
			,'N'
			,#{userCode}
			,now(3)
			,BoardTotalLimitFileSize
			,CurrentTotalFileSize
			,UseReservation
			,UsePubDeptName
		FROM board_config_default
		WHERE FolderType = (SELECT FolderType FROM sys_object_folder WHERE FolderID = #{FolderID} ) 
	</insert>
	
	<update id="updateBoardConfig"  parameterType="cmap">
		UPDATE board_config SET UseIncludeRecentReg = 'Y' WHERE FolderID =  #{FolderID}
	</update>
	
	<insert id="createObjectGroup"  parameterType="cmap">
		INSERT INTO sys_object_group
		(
			GroupCode,
			CompanyCode,
			GroupType,
			MemberOf,
			OUName,
			DisplayName,
			MultiDisplayName,
			ShortName,
			MultiShortName,
			Approvable,
			Receivable,
			ApprovalUnitCode,
			ReceiptUnitCode,
			SortKey,
			IsUse,
			IsDisplay,
			IsMail,
			IsHR,
			RegistDate,
			Description
		) VALUES (
			#{CU_Code},
			#{DomainCode},
			'Community',
			CONCAT(CONCAT(#{DN_ID},'_'),'Community'),
			#{CommunityName}, 
			#{CommunityName},
			#{CommunityName},
			#{CommunityName},
			#{CommunityName},
			1,  	
			1,
			#{CU_Code}, 
			#{CU_Code},
			'100',
			'Y',
			'Y',
			'Y',
			'Y',
			NOW(3),
			''
		)
	</insert>
	
	<update id="updateObjectGroup" parameterType="cmap">
		 UPDATE sys_object_group SET GroupPath = covi_smart4j.Fn_ComObjectPathCreate_S(0,#{CU_Code},'GR')
		 							, SortPath = covi_smart4j.Fn_ComSortPathCreate_S(0, #{CU_Code}, 'GR')
		 							, OUPath = #{CommunityName}
		 WHERE 1=1 
		 AND GroupCode = #{CU_Code}
	</update>
	
	<select id="selectCommunityInfomation" parameterType="cmap" resultType="cmap">
		  SELECT	  c.CU_ID
					, c.MN_ID
					, c.CategoryID
					, c.CU_Code
					, c.DN_ID
					, c.SearchTitle
					, c.CommunityName
					, c.CreatorCode
					, c.AppStatus
					, DATE_FORMAT(c.RegRequestDate,'%Y-%m-%d')AS RegRequestDate
					, cc.FolderPath
					, cc.SortPath
					, cc.DisplayName AS CategoryName
					, (SELECT COUNT(*) FROM sys_object_group_member AS sogm WHERE sogm.GroupCode = c.CU_Code) AS MembersCount
					, c.RegProcessDate AS RegProcessDate
					, c.Point
					, c.MemberCount
					, c.Grade
					, c.MsgCount
					, sou.DisplayName
					, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS CuAppDetail
					, c.JoinOption  AS CommunityJoin
 					, c.CommunityType AS CommunityType
 					, c.JoinOption
					, c.CommunityType
					, c.RegStatus
					, c.AppStatus
					, c.LimitFileSize
					, CONCAT( IFNULL(bd.KoFull,''), ';'
						, IFNULL(bd.EnFull,''), ';'
                        , IFNULL(bd.JaFull,''), ';'
                        , IFNULL(bd.ZhFull,''), ';;;;;;;'
					) AS MultiDisplayName
					, c.DefaultBoardType
					, c.DefaultMemberLevel
					, IFNULL(cd.Keyword,'')AS Keyword
					, IFNULL(cd.Description,'')AS Description
					, IFNULL(cd.Provision,'')AS Provision
					, IFNULL(cd.Reserved1,'')AS Reserved1
					, IFNULL(cd.Reserved2,'')AS Reserved2
					, c.SearchSummary
					, cc.CategoryID
					, c.OperatorCode
		FROM community AS c
		INNER JOIN sys_object_group AS sog ON sog.GroupCode = c.CU_Code
		LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.OperatorCode
		INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID
		LEFT JOIN community_detail AS cd ON cd.CU_ID = c.CU_ID
		LEFT JOIN sys_base_dictionary AS bd ON bd.DicCode = #{DIC_Code}
		WHERE 1=1 
		AND c.CU_ID = #{CU_ID}
		Limit 1 
	</select>
	
	<select id="selectDICCode" parameterType="cmap" resultType="String">
		SELECT CONCAT('CU_',c.CU_ID) AS DIC_Code
		FROM community AS c
		WHERE 1=1 
		AND c.CU_ID = #{CU_ID}
	</select>
	
	<update id="editCommunityInfomation" parameterType="cmap" >
		UPDATE community
		SET 	  
		 	  CategoryID = #{_ParentID}
			, CommunityType = #{ddlType}
			, CommunityName = #{txtCommunityName}
			, JoinOption = #{ddlJoinMothod}
			, DefaultMemberLevel = #{ddlMemberLevel}
			, LimitFileSize = #{txtLimitFileSize}
			, Grade = #{txtGrade}
			, DefaultBoardType =  #{ddlDefaultBoardType}
			, SearchTitle = #{textLineIntroduction}
			, SearchSummary = #{txtSummary}
		WHERE 1=1
		AND CU_ID = #{CU_ID}
	</update>
	
	<select id="selectCommunityDetailInfomationCount" parameterType="cmap" resultType="java.lang.Long">
		 SELECT COUNT(*) 
		 FROM community_detail 
		 WHERE 1=1
		 AND CU_ID = #{CU_ID}
	</select>
	
	<update id="updateCommunityDetailInfomation" parameterType="cmap">
		UPDATE community_detail
		SET 
			  Keyword = #{txtKeyword}
			, DescriptionEditor = #{txtIntroduction}
			, Description = #{txtIntroduction}
			, Provision = #{txtStipulation}
			, ProvisionEditor = #{txtStipulation}
		WHERE 1=1
		AND CU_ID = #{CU_ID}
	</update>
	
	<select id="selectCommunityOperatorInfo" parameterType="cmap" resultType="cmap">
		SELECT C.OperatorCode
			 , C.CommunityName
			 , SOU.MailAddress
		FROM community AS C
		LEFT OUTER JOIN sys_object_user AS SOU ON SOU.UserCode = C.OperatorCode
		WHERE 1=1
		AND CU_ID = #{CU_ID} 
	</select>
	
	<insert id="insertTodoSendMessage" parameterType="cmap">
		INSERT INTO sys_alarm_list
		(				
			   UserCode
			 , Category
			 , MsgType
			 , Title
			 , URL
			 , Message
			 , OpenType
			 , ObjectID
			 , ObjectType
			 , IsPush
			 , PusherCode
			 , ReceivedDate
			 , IsRead
		)VALUES(
			   #{OpUR_Code}
			 , 'Community'
			 , 'ContactOperator'
			 , '커뮤니티  운영자 연락'
			 , #{url}
			 , #{sendMessage}
			 , 'PAGEMOVE'
			 , '0'
			 , ''
			 , 'Y'
			 , #{userID}
			 , NOW(3)
			 , 'N'
		)
	</insert>
	
	<select id="selectCommunityOpenGridListCount"  parameterType="cmap" resultType="java.lang.Long">
		 SELECT COUNT(*) FROM (
			 SELECT * FROM (
				SELECT	  IFNULL(SUBSTRING_INDEX( c.CreatorDept,';',1	),'') AS CreatorDept
						, IFNULL(sou.DisplayName,'')AS DisplayName
						, c.CU_ID
						, c.MN_ID
						, c.CategoryID
						, c.CU_Code
						, c.DN_ID
						, c.SearchTitle
						, c.CommunityName
						, c.CreatorCode
						, c.AppStatus
						, DATE_FORMAT(c.RegRequestDate,'%Y-%m-%d')AS RegRequestDate
						, cc.FolderPath
						, cc.SortPath
						, cc.DisplayName AS CategoryName
						,(SELECT COUNT(*) FROM sys_object_group_member AS sogm WHERE sogm.GroupCode = c.CU_Code) AS MembersCount
						, c.RegProcessDate AS RegProcessDate
						, c.Point
						, c.MemberCount
						, c.Grade
						, c.MsgCount
						, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS CuAppDetail
 						, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityJoin', c.JoinOption)) AS CommunityJoin
						, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityType', c.CommunityType)) AS CommunityType	
				 		, IFNULL(cd.Keyword,'')AS Keyword
						, IFNULL(cd.Description,'')AS Description
		 				, IFNULL(cd.Provision,'')AS Provision	
				FROM community AS c
				INNER JOIN sys_object_group AS sog ON sog.GroupCode = c.CU_Code
				LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.CreatorCode
				INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID
				LEFT JOIN community_detail AS cd ON cd.CU_ID = c.CU_ID
				WHERE 1=1 
				AND c.Appstatus= 'RA'
				AND c.DN_ID = #{DN_ID}
			) A
			WHERE 1=1 
			<choose>
				<when test ="Option =='0'.toString() ">
					AND (A.DisplayName LIKE CONCAT('%',#{searchValue},'%') 
					 OR A.CreatorDept LIKE CONCAT('%',#{searchValue},'%') )
				</when>
				<when test ="Option =='1'.toString() ">
					AND A.DisplayName LIKE CONCAT('%',#{searchValue},'%') 
				</when>
				<when test ="Option =='2'.toString() ">
					AND A.CreatorDept LIKE CONCAT('%',#{searchValue},'%') 
				</when>
			</choose>
		)B 
	</select>
	
	<select id="selectCommunityOpenGridList"  parameterType="cmap" resultType="cmap">
		SELECT * FROM (
			SELECT	  IFNULL(SUBSTRING_INDEX( c.CreatorDept,';',1	),'')AS CreatorDept
					, IFNULL(sou.DisplayName,'')AS DisplayName
					, c.CU_ID
					, c.MN_ID
					, c.CategoryID
					, c.CU_Code
					, c.DN_ID
					, c.SearchTitle
					, c.CommunityName
					, c.CreatorCode
					, c.AppStatus
					, c.RegRequestDate AS RegRequestDate
					, cc.FolderPath
					, cc.SortPath
					, cc.DisplayName AS CategoryName
					, (SELECT COUNT(*) FROM sys_object_group_member AS sogm WHERE sogm.GroupCode = c.CU_Code) AS MembersCount
					, c.RegProcessDate AS RegProcessDate
					, c.Point
					, c.MemberCount
					, c.Grade
					, c.MsgCount
					, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS CuAppDetail
					, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityJoin', c.JoinOption)) AS CommunityJoin
					, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityType', c.CommunityType)) AS CommunityType	
					, IFNULL(cd.Keyword,'') AS Keyword
					, IFNULL(cd.Description,'') AS Description
					, IFNULL(cd.Provision,'') AS Provision
			FROM community AS c
			INNER JOIN sys_object_group AS sog ON sog.GroupCode = c.CU_Code
			LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.CreatorCode
			INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID
			LEFT JOIN community_detail AS cd ON cd.CU_ID = c.CU_ID
			WHERE 1=1 
			AND c.Appstatus= 'RA'
			AND c.DN_ID = #{DN_ID}
		) A
		WHERE 1=1 
		<choose>
			<when test ="Option =='0'.toString() ">
				AND (A.DisplayName LIKE CONCAT('%',#{searchValue},'%') 
				OR A.CreatorDept LIKE CONCAT('%',#{searchValue},'%') )
			</when>
			<when test ="Option =='1'.toString() ">
				AND A.DisplayName LIKE CONCAT('%',#{searchValue},'%') 
			</when>
			<when test ="Option =='2'.toString() ">
				AND A.CreatorDept LIKE CONCAT('%',#{searchValue},'%') 
			</when>
		</choose>
		<trim prefix="ORDER BY" prefixOverrides =",">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("CategoryName")'>CategoryName</when>
					<when test='sortColumn.equalsIgnoreCase("CU_Code")'>CU_Code</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityName")'>CommunityName</when>
					<when test='sortColumn.equalsIgnoreCase("SearchTitle")'>SearchTitle</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("RegRequestDate")'>RegRequestDate</when>
					<otherwise>CU_ID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="selectCommunityCloseGridListCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM community AS c
		INNER JOIN sys_object_group AS sog ON sog.GroupCode = c.CU_Code
		LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.CreatorCode
		INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID
		WHERE 1=1 
		AND c.Appstatus= #{AppStatus}
		AND c.DN_ID = #{DN_ID}
	</select>
	
	<select id="selectCommunityCloseGridList" parameterType="cmap" resultType="cmap">
		SELECT * FROM (
			SELECT	  IFNULL(SUBSTRING_INDEX(c.CreatorDept, ';', 1), '')AS CreatorDept
					, IFNULL(sou.DisplayName, '')AS DisplayName
					, c.CU_ID
					, c.MN_ID
					, c.CategoryID
					, c.CU_Code
					, c.DN_ID
					, c.SearchTitle
					, c.CommunityName
					, c.CreatorCode
					, c.AppStatus
					, c.RegRequestDate AS RegRequestDate
					, cc.FolderPath
					, cc.SortPath
					, cc.DisplayName AS CategoryName
					, (SELECT COUNT(*) FROM sys_object_group_member AS sogm WHERE sogm.GroupCode = c.CU_Code) AS MembersCount
					, c.RegProcessDate AS RegProcessDate
					, c.UnRegRequestDate AS UnRegRequestDate 
					, c.UnRegProcessDate AS UnRegProcessDate
					, c.Point
					, c.MemberCount
					, c.Grade
					, c.MsgCount
					, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuStatus', c.RegStatus)) AS RegStatus 
					, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS CuAppDetail
					, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityJoin', c.JoinOption)) AS CommunityJoin
					, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityType', c.CommunityType)) AS CommunityType	
					, IFNULL(cd.Keyword, '') AS Keyword
					, IFNULL(cd.Description, '') AS Description
					, IFNULL(cd.Provision, '') AS Provision
			FROM community AS c
			INNER JOIN sys_object_group AS sog ON sog.GroupCode = c.CU_Code
			LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.CreatorCode
			INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID
			LEFT JOIN community_detail AS cd ON cd.CU_ID = c.CU_ID
			WHERE 1=1 
			AND c.Appstatus= #{AppStatus}
			AND c.DN_ID = #{DN_ID}
		) A
		WHERE 1=1
		<trim prefix="ORDER BY" prefixOverrides =",">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("UnRegRequestDate")'>UnRegRequestDate</when>
					<when test='sortColumn.equalsIgnoreCase("RegStatus")'>RegStatus</when>
					<when test='sortColumn.equalsIgnoreCase("CuAppDetail")'>CuAppDetail</when>
					<when test='sortColumn.equalsIgnoreCase("CategoryName")'>CategoryName</when>
					<when test='sortColumn.equalsIgnoreCase("CU_Code")'>CU_Code</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityName")'>CommunityName</when>
					<when test='sortColumn.equalsIgnoreCase("SearchTitle")'>SearchTitle</when>
					<when test='sortColumn.equalsIgnoreCase("UnRegProcessDate")'>UnRegProcessDate</when>
					<otherwise>CU_ID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<update id="staticCommunityUpdate" parameterType="cmap" >
		 UPDATE community
		 SET 
		 	<if test="RegStatus != null and RegStatus != '' and AppStatus == 'UV'">
					RegStatus = #{RegStatus}, 
		 	</if>
			 UnRegProcessDate = NOW(3), 
			 AppStatus = #{AppStatus}, 
			 ProcesserCode = #{userID}
		WHERE CU_ID = #{CU_ID}
	</update>
	
	<update id="staticCommunityGrMemberUpdate" parameterType="cmap" >
		UPDATE sys_object_group_member SET 
			IsUse = #{IsUse}
		WHERE GroupCode = CONCAT('Community',#{CU_ID})	
	</update>
	
	<update id="staticCommunityGrUpdate" parameterType="cmap" >
		UPDATE sys_object_group SET 
			IsUse = #{IsUse}
		WHERE GroupCode = CONCAT('Community',#{CU_ID})	
	</update>
	
	<select id="selectCommunityStaticGridListCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM community c
		LEFT JOIN sys_object_user AS sou ON  sou.UserCode = c.OperatorCode
		INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID 
		INNER JOIN community_detail AS cd ON cd.CU_ID = c.CU_ID 
		WHERE 1=1
		AND c.Gubun = 'C'
		<choose>
			<when test ="SearchOption =='A'.toString()">
				AND (sou.DisplayName LIKE CONCAT('%',#{searchValue},'%') 
				OR c.CommunityName LIKE CONCAT('%',#{searchValue},'%') )
			</when>
			<when test ="SearchOption =='C'.toString() ">
				AND c.CommunityName LIKE CONCAT('%',#{searchValue},'%') 
			</when>
			<when test ="SearchOption =='O'.toString() ">
				AND sou.DisplayName LIKE CONCAT('%',#{searchValue},'%') 
			</when>
		</choose>
		<if test="DN_ID != null and DN_ID != ''">
			AND c.DN_ID = #{DN_ID}
		</if>
		<if test="CommunityType != null and CommunityType != ''">
			AND c.CommunityType = #{CommunityType}
		</if>
		<if test="RegStatus != null and RegStatus != ''">
			AND c.RegStatus = #{RegStatus}
		</if>
	</select>
	
	<select id="selectCommunityStaticGridList"  parameterType="cmap" resultType="cmap">
		 SELECT A.LimitFileSize,
		  		A.UsedFileSize,
		  		A.MemberCount,
				A.MsgCount,
				A.ReplyCount,
				A.VisitCount,
				A.ViewCount,
				A.Point,
				A.Grade,
				A.RegProcessDate,
				A.CU_ID,
				A.CommunityName,
				A.RegStatus,
				A.DisplayName,
				CONCAT(CONCAT(CONCAT(CONCAT(ROUND(A.UsedFileSize / POW(1024, r), 2), '', ELT(r + 1, 'Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB', 'BB')),'/'),A.LimitFileSize),'MB')AS FileSize ,
				CONCAT(@i:= @i+1) AS number
		FROM (
			SELECT  
				IFNULL(TRUNCATE(LOG(1024, c.UsedFileSize), 0),0)AS r,
				IFNULL(c.LimitFileSize,'0')AS LimitFileSize,
				IFNULL(c.UsedFileSize,'0')AS UsedFileSize,
				<!-- c.MemberCount, -->
				(SELECT COUNT(*) FROM community_member WHERE  MemberLevel != '0' AND MemberStatus = 'R' AND DetailStatus = 'RV' AND CU_ID = c.CU_ID ) AS MemberCount,
				c.MsgCount,
				c.ReplyCount,
				c.OneMsgCount,
				c.VisitCount,
				c.ViewCount,
				c.Point,
				c.Grade,
				c.CU_ID,
				c.CommunityName,
				@i:=0,
				sou.DisplayName,
				c.RegProcessDate AS RegProcessDate,
				IFNULL(Fn_BaseGetDictionary_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuStatus', c.RegStatus)), '') AS RegStatus
			FROM community c
			LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.OperatorCode
			INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID 
			INNER JOIN community_detail AS cd ON cd.CU_ID = c.CU_ID 
			WHERE 1=1
			AND c.Gubun = 'C'
			<choose>
				<when test ="SearchOption =='A'.toString()">
					AND (sou.DisplayName LIKE CONCAT('%',#{searchValue},'%') 
					OR c.CommunityName LIKE CONCAT('%',#{searchValue},'%') )
				</when>
				<when test ="SearchOption =='C'.toString() ">
					AND c.CommunityName LIKE CONCAT('%',#{searchValue},'%') 
				</when>
				<when test ="SearchOption =='O'.toString() ">
					AND sou.DisplayName LIKE CONCAT('%',#{searchValue},'%') 
				</when>
			</choose>
			<if test="DN_ID != null and DN_ID != ''">
				AND c.DN_ID = #{DN_ID}
			</if>
			<if test="CommunityType != null and CommunityType != ''">
				AND c.CommunityType = #{CommunityType}
			</if>
			<if test="RegStatus != null and RegStatus != ''">
				AND c.RegStatus = #{RegStatus}
			</if>
		)A
		<trim prefix="ORDER BY"  prefixOverrides =","> 
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' "> 
				<choose>
					<when test='sortColumn.equalsIgnoreCase("number")'>number</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityName")'>CommunityName</when>
					<when test='sortColumn.equalsIgnoreCase("Grade")'>(Grade + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("Point")'>(Point + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("MemberCount")'>(MemberCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("VisitCount")'>(VisitCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("MsgCount")'>(MsgCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("ViewCount")'>(ViewCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("ReplyCount")'>(ReplyCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("FileSize")'>FileSize</when>
					<when test='sortColumn.equalsIgnoreCase("RegStatus")'>RegStatus</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("RegProcessDate")'>RegProcessDate</when>
					<otherwise>CU_ID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	 
	<select id="selectCommunityStaticSubGridListCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM community_log_group_daily
		WHERE 1=1
		AND CU_ID = #{CU_ID} 
		<if test="startDate != '' or endDate != ''">
			AND YYYYMMDD between #{startDate} and #{endDate}		
		</if>
	</select>
	
	<select id="selectCommunityStaticSubGridList" parameterType="cmap" resultType="cmap">
		SELECT	YYYYMMDD
				, CU_ID
				, MN_ID
				, MemberCount
				, MsgCount
				, ReplyCount
				, OneMsgCount
				, VisitCount
				, ViewCount
				, Point
				, Grade
				, Difference
				, RegistDate
				, MeetingUserCount
				, MeetingPaRate
		FROM community_log_group_daily 
		WHERE 1=1 
		AND CU_ID = #{CU_ID} 
		<if test="startDate != '' or endDate != ''">
			AND YYYYMMDD between #{startDate} and #{endDate}		
		</if>
		<trim prefix="ORDER BY" prefixOverrides =","> 
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' "> 
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Grade")'>(Grade + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("Point")'>(Point + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("MemberCount")'>(MemberCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("VisitCount")'>(VisitCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("MsgCount")'>(MsgCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("ViewCount")'>(ViewCount + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("ReplyCount")'>(ReplyCount + 0)</when>
					<otherwise>YYYYMMDD</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	
	<select id="selectCommunityExcelLogDaily" parameterType="cmap" resultType="cmap">
		SELECT	YYYYMMDD
				, CU_ID
				, MN_ID
				, MemberCount
				, MsgCount
				, ReplyCount
				, OneMsgCount
				, VisitCount
				, ViewCount
				, Point
				, Grade
				, Difference
				, RegistDate
				, MeetingUserCount
				, MeetingPaRate
		FROM community_log_group_daily 
		WHERE 1=1 
		AND CU_ID = #{CU_ID}
	</select>
	
	<select id="selectCommunityExcelInfo" parameterType="cmap" resultType="cmap">
		SELECT 	A.RegProcessDate 
			  , A.MembersCount
			  , A.Point
			  , A.MemberCount
			  , A.Grade
			  , A.MsgCount
			  , A.OpUserName
			  , A.RegStatus
			  , A.LimitFileSize
			  , A.UsedFileSize
			  , A.ReplyCount
			  , A.OneMsgCount
			  , A.VisitCount
			  , A.ViewCount
			  , A.CommunityName
			  , A.CU_ID
			  , CONCAT(CONCAT(CONCAT(CONCAT(ROUND(A.UsedFileSize / POW(1024, r), 2), '', ELT(r + 1, 'Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB', 'BB')), '/'), A.LimitFileSize), 'MB') AS FileSize
		FROM (  
			 SELECT	 
				c.RegProcessDate AS RegProcessDate
				, (SELECT COUNT(*) FROM community_member WHERE  MemberLevel != '0' AND MemberStatus = 'R' AND DetailStatus = 'RV' AND CU_ID = c.CU_ID ) AS MembersCount
				, c.Point
				, c.MemberCount
				, c.Grade
				, c.MsgCount
				, sou.DisplayName AS OpUserName
				, Fn_BaseGetDictionary_S (#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuStatus', c.RegStatus)) AS RegStatus 
				, IFNULL(c.LimitFileSize,'')AS LimitFileSize
				, IFNULL(c.UsedFileSize,'')AS UsedFileSize
				, c.ReplyCount
				, c.OneMsgCount
				, c.VisitCount
				, c.ViewCount
				, c.CommunityName
				, c.CU_ID
				, IFNULL(TRUNCATE(LOG(1024, c.UsedFileSize), 0), 0) AS r
			FROM community AS c
			INNER JOIN sys_object_group AS sog ON sog.GroupCode = c.CU_Code
			LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.OperatorCode
			INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID
			INNER JOIN community_detail AS cd ON cd.CU_ID = c.CU_ID
			WHERE 1=1 
			AND c.CU_ID = #{CU_ID}
		)A
	</select>
	 
	<select id="selectCommunityExcelInfoCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM community AS c
		INNER JOIN sys_object_group AS sog ON sog.GroupCode = c.CU_Code
		LEFT JOIN sys_object_user	AS sou ON  sou.UserCode = c.OperatorCode
		INNER JOIN community_category AS cc ON cc.CategoryID = c.CategoryID
		INNER JOIN community_detail AS cd ON cd.CU_ID = c.CU_ID
		WHERE 1=1 
		AND c.CU_ID = #{CU_ID}
	</select>
	 
	<select id="selectCommunityBoardSettingGridList" parameterType="cmap" resultType="cmap">
		SELECT * FROM (
			SELECT	  @i:=@i+1 AS num
					, LPAD(@i,'10','0') AS S_ORDER
					, DN_NAME
					, DN_ID
					, CommunityType
					, CommunityTypeName
					, FolderType
					, FolderTypeName
					, BoardName
					, exDisplayName
					, MemberOf
					, SortKey
					, IsUse
					, Description
					, P_LEVEL
					, MenuID
		 	FROM (
				SELECT	  @i:=0
						, sod.DisplayName AS DN_NAME
						, cbd.DN_ID
						, cbd.CommunityType
						, IFNULL(sbc.CodeName, '') AS CommunityTypeName
						, cbd.FolderType
						, IFNULL(soft.DisplayName, '') AS FolderTypeName
						, cbd.DisplayName AS BoardName
						, cbd.exDisplayName
						, cbd.MemberOf
						, cbd.SortKey
						, cbd.IsUse
						, cbd.Description
						, '1' AS P_LEVEL
						, cbd.MenuID
				FROM community_board_default cbd
				INNER JOIN sys_object_domain sod ON sod.DomainID = cbd.DN_ID
				LEFT OUTER JOIN sys_base_code sbc ON sbc.CodeGroup = 'CommunityDefaultBoardType' AND sbc.Code = cbd.CommunityType
				LEFT OUTER JOIN sys_object_folder_type soft ON soft.FolderType = cbd.FolderType AND soft.BizSection ='Community'
				WHERE 1=1 
				AND sbc.DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = sbc.Code AND CodeGroup = 'CommunityDefaultBoardType' ORDER BY IF(DomainID = #{domainID}, 0, 1) LIMIT 1 )
				<if test="domainID != null and domainID != ''">
					AND cbd.DN_ID = #{domainID}
				</if>
				<if test="code != null and code != ''">
					AND sbc.Code = #{code}	
				</if>
				<if test="searchValue != null and searchValue != ''">
					AND cbd.DisplayName LIKE CONCAT('%',#{searchValue},'%') 
				</if>
			)A
		)B
		<trim prefix="ORDER BY" prefixOverrides=","> 
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' "> 
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DN_NAME")'>DN_NAME</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityTypeName")'>CommunityTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("BoardName")'>BoardName</when>
					<when test='sortColumn.equalsIgnoreCase("FolderTypeName")'>FolderTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("IsUse")'>IsUse</when>
					<when test='sortColumn.equalsIgnoreCase("Description")'>Description</when>
					<otherwise>MenuID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
	 
	<select id="selectCommunityBoardSettingGridListCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT  COUNT(*)
		FROM community_board_default cbd
		INNER JOIN sys_object_domain sod ON sod.DomainID = cbd.DN_ID
		LEFT OUTER JOIN sys_base_code sbc ON sbc.CodeGroup = 'CommunityDefaultBoardType' AND sbc.Code = cbd.CommunityType
		LEFT OUTER JOIN sys_object_folder_type soft ON soft.FolderType = cbd.FolderType AND soft.BizSection ='Community'
 		WHERE 1=1
 		AND sbc.DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = sbc.Code AND CodeGroup = 'CommunityDefaultBoardType' ORDER BY IF(DomainID = #{domainID}, 0, 1) LIMIT 1 )
 		<if test="domainID != null and domainID != ''">
			AND cbd.DN_ID = #{domainID}	
		</if>
 		<if test="code != null and code != ''">
			AND sbc.Code = #{code}
		</if>
		<if test="searchValue != null and searchValue != ''">
			AND cbd.DisplayName LIKE CONCAT('%',#{searchValue},'%')
		</if>
	</select>
	 
	<update id="updateBoardSettingUseChange" parameterType="cmap">
		 UPDATE community_board_default 
		 SET IsUse = #{IsUse}
		 WHERE 1=1
		 AND MenuID = #{MenuID}
	</update>
	 
	<update id="updateBoardSetting" parameterType="cmap">
		 UPDATE community_board_default SET 
							 	DN_ID = #{DN_ID},
							 	FolderType = #{FolderType},
							 	DisplayName = #{DisplayName},
							 	exDisplayName = #{exDisplayName},
							 	SortKey = #{SortKey},
							 	IsUse = #{IsUse},
							 	CommunityType = #{CommunityType},
							 	Description = #{Description}
		 WHERE 1=1
		 AND MenuID = #{MenuID}
	</update>
	 
	<insert id="createBoardSetting" parameterType="cmap">
		 INSERT INTO community_board_default
		 (					
			DN_ID,
			FolderType,
			DisplayName,
			exDisplayName,
			SortKey,
			IsUse,
			CommunityType,
			Description
		) VALUES (
			#{DN_ID},
			#{FolderType},					
			#{DisplayName},
			#{exDisplayName},
			#{SortKey},
			#{IsUse},
			#{CommunityType},					
			#{Description}					
		)
	</insert>
	 
	<select id="selectCommunityFolderType" parameterType="cmap" resultType="cmap">
		SELECT  FolderType AS optionValue
			  , DisplayName AS optionText
		FROM sys_object_folder_type 
		WHERE BizSection = 'Community'		
	</select>
	 
	<select id="communityBoardSettingInfo" parameterType="cmap" resultType="cmap">
		/* queryId : admin.community.communityBoardSettingInfo */
		SELECT	cbd.DN_ID
				, cbd.CommunityType
				, cbd.FolderType
				, cbd.DisplayName AS BoardName
				, cbd.exDisplayName AS MultiDisplayName
				, cbd.SortKey
				, cbd.IsUse
				, IFNULL(cbd.Description,'')AS Description
				, cbd.MenuID
		FROM community_board_default cbd
		INNER JOIN sys_object_domain sod ON sod.DomainID = cbd.DN_ID
		LEFT OUTER JOIN sys_base_code sbc ON sbc.CodeGroup = 'CommunityDefaultBoardType' AND sbc.Code = cbd.CommunityType
		LEFT OUTER JOIN sys_object_folder_type soft ON soft.FolderType = cbd.FolderType AND soft.BizSection ='Community'
		WHERE 1=1 
		AND cbd.MenuID = #{MenuID}
		AND sbc.DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE Code = sbc.Code AND CodeGroup = 'CommunityDefaultBoardType' ORDER BY IF(DomainID = cbd.DN_ID, 0, 1) LIMIT 1 )
	</select>
	 
	<select id="selectCommunityFolderCnt"  parameterType="cmap" resultType="java.lang.Long">
		 SELECT COUNT(*) 
		 FROM sys_object_folder
		 WHERE 1=1 
		 AND FolderType = #{FolderType}
		 AND ObjectType = 'Community'
		 AND MenuID = #{CU_ID}
	</select>
	 
	<select id="selectCommunityScheduleMenu"  parameterType="cmap" resultType="String">
<!-- 		SELECT MenuID 
		FROM sys_object_menu 
		WHERE BizSection = 'Schedule' 
		AND MenuType ='TopSub'
		AND ParentObjectID ='1' 
		AND IsAdmin = 'N'
		AND DomainID = (SELECT DN_ID FROM community WHERE CU_ID = #{CU_ID}) -->
		SELECT CONCAT(CONCAT((SELECT SortPath FROM sys_object_folder WHERE FolderID = #{MemberOf}),CONCAT(LEFT('000000000000000', 15 - LENGTH(#{CU_ID})),#{CU_ID})),';') FROM dual
	</select>
	
	<update id="updateCommunityMemberOperatorCode" parameterType="cmap">
		UPDATE community SET OperatorCode = #{userID}
		WHERE 1=1 
		AND CU_ID = #{CU_ID}
	</update>
	
	<select id="communityMemberActivity" parameterType="cmap" resultType="cmap">
	 	 SELECT * FROM (
			SELECT @bec:=BB.CU_ID
	 			 , IFNULL(@afc, @afc:=BB.CU_ID)
	 			 , IF(@bec != @afc, @i:=1, @i:=@i+1 )AS num
	 			 , IF(@bec != @afc, @afc:=@bec,'')AS checkNum
	 			 , IFNULL(@afc, @afc:=@bec)
	 			 , BB.CU_ID
	 			 , BB.UR_Code
	 			 , IFNULL(BB.Visit_cnt,'0')AS Visit_cnt
	 			 , IFNULL(BB.MsgCount,'0')AS MsgCount
	 			 , IFNULL(BB.ViewCount,'0')AS ViewCount
	 			 , IFNULL(BB.CommentCnt,'0')AS CommentCnt
	 			 , IFNULL(BB.TotalPoint,'0')AS TotalPoint
	 		FROM(
				SELECT AA.CU_ID, AA.UR_Code, AA.Visit_cnt,(AA.MsgCount+AA.surveyCnt) AS MsgCount, AA.ViewCount, AA.CommentCnt, ((AA.Visit_cnt*15)+(AA.MsgCount*30)+AA.ViewCount+(AA.CommentCnt*10)+(AA.surveyCnt*30))AS TotalPoint, @i:=0
				FROM (
					SELECT	cm.CU_ID
							, cm.UR_Code
							, (SELECT COUNT(*) FROM community_visit WHERE CommunityID = cm.CU_ID AND UserCode = cm.UR_Code) AS Visit_cnt
							, IFNULL(A.MsgCount,'0')AS MsgCount
							, IFNULL(B.ViewCount,'0')AS ViewCount 
							, IFNULL(C.CommentCnt,'0')AS CommentCnt
							, IFNULL(E.surveyCnt,'0')AS surveyCnt
					FROM community_member cm
					LEFT OUTER JOIN (	SELECT c.CU_ID, cm.UR_Code, COUNT(*)AS MsgCount
										FROM board_message AS BM 
										INNER JOIN community_member AS cm ON cm.UR_Code = BM.CreatorCode 
										INNER JOIN community AS c ON c.CU_ID = cm.CU_ID 
								  		INNER JOIN sys_object_folder sof ON sof.FolderID = BM.FolderID AND sof.MenuID = cm.CU_ID
								  		AND BM.MsgState IN ('C', 'A') 
										AND MsgType != 'S' 
										AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= #{localCurrentDate} ) 
										AND BM.DeleteDate IS NULL GROUP BY c.CU_ID, cm.UR_Code ) A ON A.CU_ID = cm.CU_ID AND A.UR_Code = cm.UR_Code
					LEFT OUTER JOIN (	SELECT cm.CU_ID, cm.UR_Code, COUNT(*)AS ViewCount
										FROM board_message AS BM 
										INNER JOIN community_member AS cm ON cm.UR_Code = BM.CreatorCode
								  		INNER JOIN sys_object_folder sof ON sof.FolderID = BM.FolderID AND sof.MenuID = cm.CU_ID
								  		INNER JOIN board_message_reader bmr ON bmr.MessageID = BM.MessageID AND bmr.ReaderCode = cm.UR_Code
								  		AND BM.MsgState IN ('C', 'A') 
										AND MsgType != 'S' 
										AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= #{localCurrentDate} ) 
										AND BM.DeleteDate IS NULL GROUP BY cm.CU_ID, cm.UR_Code) B ON B.CU_ID = cm.CU_ID AND B.UR_Code = cm.UR_Code
					LEFT OUTER JOIN (	SELECT cm.CU_ID, cm.UR_Code, (SELECT COUNT(*) FROM sys_comment WHERE DeleteDate IS NULL AND TargetServiceType= 'Board'AND TargetID = CONCAT(BM.MessageID,'_',BM.Version))AS CommentCnt 
										FROM board_message AS BM 
										INNER JOIN community_member cm ON cm.UR_Code = BM.CreatorCode
								  		INNER JOIN sys_object_folder sof ON sof.FolderID = BM.FolderID AND sof.MenuID = cm.CU_ID
								  		AND BM.MsgState IN ('C', 'A') 
										AND MsgType != 'S' 
										AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= #{localCurrentDate} ) 
										AND BM.DeleteDate IS NULL GROUP BY cm.CU_ID, cm.UR_Code) C ON C.CU_ID = cm.CU_ID AND C.UR_Code = cm.UR_Code
					LEFT OUTER JOIN ( SELECT CommunityID, RegisterCode, COUNT(*)AS surveyCnt FROM survey WHERE 1=1 AND State IN ('F','G') GROUP BY CommunityID) E ON E.CommunityID = cm.CU_ID AND  E.RegisterCode = cm.UR_Code
					LEFT OUTER JOIN community F ON F.CU_ID = cm.CU_ID
					WHERE F.DefaultBoardType != 'TF'
					ORDER BY cm.CU_ID ASC  
				)AA
				ORDER BY CU_ID ASC, TotalPoint DESC 
			)BB
			ORDER BY CU_ID ASC, num ASC, UR_Code ASC 
		)CC
 	</select>
 	
 	<update id="communityMemberActivityPoint" parameterType="cmap">
 		UPDATE community_member SET  MemberGrade = #{num}
 									, MemberPoint = #{TotalPoint}
 									, MsgCount = #{MsgCount}
 									, ReplyCount = #{CommentCnt}
 									, OneMsgCount = '0'
 									, ViewCount = #{ViewCount}
 									, VisitCount  = #{Visit_cnt}
 		WHERE 1=1 
 		AND CU_ID = #{CU_ID}
 		AND UR_Code = #{UR_Code}
 	</update>
 	
 	<select id="communityActivity"  parameterType="cmap" resultType="cmap">
 		SELECT @bec:=BB.CU_ID
 			 , IF(@bec != @afc, @i:=1, @i:=@i+1 )AS num
 			 , IF(@bec != @afc, @afc:=@bec,'')AS checkNum
 			 , BB.CU_ID
 			 , BB.DN_ID
 			 , IFNULL(BB.Visit_cnt,'0')AS Visit_cnt
 			 , IFNULL(BB.MsgCount,'0')AS MsgCount
 			 , IFNULL(BB.ViewCount,'0')AS ViewCount
 			 , IFNULL(BB.CommentCnt,'0')AS CommentCnt
 			 , IFNULL(BB.MemberCount,'0')AS MemberCount
 			 , IFNULL(BB.TotalPoint,'0')AS TotalPoint
 		FROM(
			SELECT AA.CU_ID, AA.DN_ID, AA.Visit_cnt,(AA.MsgCount+AA.surveyCnt) AS MsgCount, AA.ViewCount, AA.CommentCnt,AA.MemberCount, ((AA.Visit_cnt*15)+(AA.MsgCount*30)+AA.ViewCount+(AA.CommentCnt*10)+(AA.MemberCount * 100)+(AA.surveyCnt*30))AS TotalPoint, @i:=0
			FROM (	
				SELECT	cm.CU_ID
						, F.DN_ID
						, (SELECT COUNT(*) FROM community_visit WHERE CommunityID = cm.CU_ID ) AS Visit_cnt
						, IFNULL(A.MsgCount,'0')AS MsgCount
						, IFNULL(B.ViewCount,'0')AS ViewCount 
						, IFNULL(C.CommentCnt,'0')AS CommentCnt
						, IFNULL(D.MemberCount,'0')AS MemberCount
						, IFNULL(E.surveyCnt,'0')AS surveyCnt
				FROM community_member cm
				LEFT OUTER JOIN (	SELECT c.CU_ID, COUNT(*)AS MsgCount
									FROM board_message AS BM 
									INNER JOIN community_member AS cm ON cm.UR_Code = BM.CreatorCode 
									INNER JOIN community AS c ON c.CU_ID = cm.CU_ID 
							  		INNER JOIN sys_object_folder sof ON sof.FolderID = BM.FolderID AND sof.MenuID = cm.CU_ID
							  		AND BM.MsgState IN ('C', 'A') 
									AND MsgType != 'S' 
									AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= #{localCurrentDate} ) 
									AND BM.DeleteDate IS NULL GROUP BY c.CU_ID ) A ON A.CU_ID = cm.CU_ID 
				LEFT OUTER JOIN (	SELECT cm.CU_ID, COUNT(*)AS ViewCount
									FROM board_message AS BM 
									INNER JOIN community_member AS cm ON cm.UR_Code = BM.CreatorCode
							  		INNER JOIN sys_object_folder sof ON sof.FolderID = BM.FolderID AND sof.MenuID = cm.CU_ID
							  		INNER JOIN board_message_reader bmr ON bmr.MessageID = BM.MessageID AND bmr.ReaderCode = cm.UR_Code
							  		AND BM.MsgState IN ('C', 'A') 
									AND MsgType != 'S' 
									AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= #{localCurrentDate} ) 
									AND BM.DeleteDate IS NULL GROUP BY cm.CU_ID) B ON B.CU_ID = cm.CU_ID 
				LEFT OUTER JOIN (	SELECT cm.CU_ID,  (SELECT COUNT(*) FROM sys_comment WHERE DeleteDate IS NULL AND TargetServiceType= 'Board'AND TargetID = CONCAT(BM.MessageID,'_',BM.Version))AS CommentCnt 
									FROM board_message AS BM 
									INNER JOIN community_member cm ON cm.UR_Code = BM.CreatorCode
							  		INNER JOIN sys_object_folder sof ON sof.FolderID = BM.FolderID AND sof.MenuID = cm.CU_ID
							  		AND BM.MsgState IN ('C', 'A') 
									AND MsgType != 'S' 
									AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= #{localCurrentDate} ) 
									AND BM.DeleteDate IS NULL
									INNER JOIN sys_comment SC ON SC.TargetID = CONCAT(BM.MessageID, '_', BM.Version) AND SC.DeleteDate IS NULL AND SC.TargetServiceType = 'Board'
									GROUP BY cm.CU_ID) C ON C.CU_ID = cm.CU_ID
				LEFT OUTER JOIN (	SELECT c.CU_ID,  COUNT(*)AS MemberCount
									FROM community c 
									INNER JOIN community_member cm ON cm.CU_ID = c.CU_ID
									WHERE 1=1
									AND cm.DetailStatus = 'RV'
									AND cm.MemberStatus = 'R'
									AND cm.MemberLevel != '0'
									GROUP BY c.CU_ID	) D ON D.CU_ID = cm.CU_ID 
				LEFT OUTER JOIN ( SELECT CommunityID,COUNT(*) AS surveyCnt FROM survey WHERE 1=1 AND State IN ('F','G')  GROUP BY CommunityID) E ON E.CommunityID = cm.CU_ID						 
				LEFT OUTER JOIN community F ON F.CU_ID = cm.CU_ID
				WHERE F.DefaultBoardType != 'TF'
				GROUP BY cm.CU_ID
				ORDER BY cm.CU_ID ASC  
			)AA
			ORDER BY TotalPoint DESC
		)BB
		ORDER BY BB.DN_ID, BB.TotalPoint DESC
 	</select>
 	
 	<update id="communityActivityPoint" parameterType="cmap">
 		UPDATE community SET  		 Grade = #{num}
 									, Point = #{TotalPoint}
 									, MsgCount = #{MsgCount}
 									, ReplyCount = #{CommentCnt}
 									, OneMsgCount = '0'
 									, ViewCount = #{ViewCount}
 									, VisitCount  = #{Visit_cnt}
 									, MemberCount = #{MemberCount}
 		WHERE 1=1 
 		AND CU_ID = #{CU_ID}
 	</update>
 	
 	<insert id="communityActivityPointHistory" parameterType="cmap">
 		INSERT INTO community_log_group_daily
 		(
 			  YYYYMMDD
			, CU_ID
			, MN_ID
			, MemberCount
			, MsgCount
			, ReplyCount
			, OneMsgCount
			, VisitCount
			, ViewCount
			, Point
			, Grade
			, Difference
		)VALUES(
			  DATE_FORMAT(NOW(),'%Y-%m-%d')
			, #{CU_ID}			
			, '0'
			, #{MemberCount}
			, #{MsgCount}
			, #{CommentCnt}
			, '0'
			, #{Visit_cnt}
			, #{ViewCount}
			, #{TotalPoint}
			, #{num}
			, IFNULL((SELECT MAX(gd.Point) - #{TotalPoint} FROM community_log_group_daily AS gd WHERE 1=1 AND gd.CU_ID = #{CU_ID}),'0')			
		 )
 	</insert>
 	
 	<insert id="communityMemberActivityPointHistory" parameterType="cmap">
 		INSERT INTO community_log_user_daily
 		(
 			  YYYYMMDD
			, CU_ID
			, UR_CODE
			, MsgCount
			, ReplyCount
			, OneMsgCount
			, VisitCount
			, ViewCount
			, Point
			, Grade
			, Difference
		) VALUES (
			  DATE_FORMAT(NOW(),'%Y-%m-%d')
			, #{CU_ID}
			, #{UR_Code}			
			, #{MsgCount}
			, #{CommentCnt}
			, '0'
			, #{Visit_cnt}
			, #{ViewCount}
			, #{TotalPoint}
			, #{num}
			, IFNULL((SELECT MAX(gd.Point) - #{TotalPoint} FROM community_log_user_daily AS gd WHERE 1=1 AND gd.CU_ID = #{CU_ID} AND gd.UR_CODE = #{UR_Code}),'0')			
		)
 	</insert>
 	
 	<update id="updateCommunityMember" parameterType="cmap">
		UPDATE community_member SET  MemberStatus = 'R'
									, DetailStatus = 'RV'
									, MemberLevel = '9'
		WHERE 1=1
		AND CU_ID = #{CU_ID}
		AND UR_CODE = #{userID}
	</update>
	
	<select id="selectCommunityAlias" parameterType="cmap" resultType="String">
		SELECT `AUTO_INCREMENT`
		FROM  INFORMATION_SCHEMA.TABLES
		WHERE TABLE_SCHEMA = 'COVI_SMART4J'
		AND	TABLE_NAME	= 'COMMUNITY'
	</select>
	
	<insert id="createCommunityWebPortal" parameterType="cmap">
		INSERT INTO portal (  	  LayoutID
								, CompanyCode
								, DisplayName
								, PortalType
								, SortKey
								, IsUse
								, RegisterCode
								, RegistDate
								, BizSection
							 	, PortalTag
								, LayoutSizeTag		
							)VALUES(
							 	  (SELECT LayoutID FROM portal_layout WHERE 1=1 AND Reserved1 = 'Y' AND IsCommunity = 'Y' LIMIT 1)				
								, (SELECT CU_Code FROM community WHERE CU_ID = #{CU_ID} )						
								, #{txtCommunityName}
								, 'Community'
								, '1'
								, 'Y'
								, #{userID}
								, NOW(3)
								, 'Community'	
								, #{PortalTag}
								, #{LayoutSizeTag}		
							)
		<selectKey resultType="java.lang.Long" keyProperty="PortalID" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>						
	</insert>
	
	<select id="communityDefaultPortalList" parameterType="cmap" resultType="cmap">
		SELECT	  BizSection
				, `Range`
				, DisplayName 
				, HtmlFilePath
				, JsFilePath
				, JsModuleName
				, IsUse
				, Reserved1 
				, Reserved2 AS LayoutDivNumber
				, Preview
				, MinHeight
				, DataJSON
				, ExtentionJSON
				, ScriptMethod
		FROM community_portal_webpart_default 
		WHERE 1=1
		AND IsUse ='Y' 
		ORDER BY Reserved ASC 
	</select>
	
	<insert id="createCommunityWebPart" parameterType="cmap">
		INSERT INTO portal_webpart
		(
			  CompanyCode
			, BizSection
			, `Range`
			, DisplayName
			, HtmlFilePath
			, JsFilePath
			, JsModuleName
			, IsUse
			, Reserved1
			, RegisterCode
			, RegistDate
			, Preview
			, MinHeight
			, DataJSON
			, ExtentionJSON
			, ScriptMethod
		) VALUES (
			  (SELECT CU_Code FROM community WHERE CU_ID = #{CU_ID} )								
			, #{BizSection}					
			, #{Range}					
			, #{DisplayName}	
			, #{HtmlFilePath}
			, #{JsFilePath}
			, #{JsModuleName}
			, #{IsUse}	
			, #{Reserved1}
			, #{userID}
			, NOW(3)
			, #{Preview}
			, #{MinHeight}	
			, #{DataJSON}
			, #{ExtentionJSON}
			, #{ScriptMethod}		
		)
		<selectKey resultType="java.lang.Long" keyProperty="WebpartID" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<insert id="createCommunityLayout" parameterType="cmap">
		INSERT INTO portal_layout_webpart
		(
		 	  PortalID
			, WebpartID
			, LayoutDivNumber 
			, LayoutDivSort
			, WebpartOrder
			, RegistDate
		) VALUES (
			  #{PortalID}
			, #{WebpartID}	
			, #{LayoutDivNumber}
			, '0'
			, '-1'
			, NOW(3)			
		)
	</insert>
	
	<select id="selectCommunitySortDuplyCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM community_category 
		WHERE DN_ID = #{DN_ID}
		AND SortKey = #{SortKey}
		AND DeleteDate IS NULL
		<if test="CategoryID != null and CategoryID != '' and CategoryID != '0'"> 
			 	AND CategoryID != #{CategoryID}
		</if>
		<if test="FolderType != null and FolderType != '' "> 
			 	AND FolderType = #{FolderType}
		</if>
		<if test="MemberOf != null and MemberOf != '' "> 
			 	AND MemberOf = #{MemberOf}
		</if>
	</select>
	
	<select id="communityUserDomainList" parameterType="cmap" resultType="cmap">
		SELECT
			SOD.DomainID
		FROM sys_object_user AS SOU
		INNER JOIN sys_object_user_basegroup AS SOUBG ON (SOUBG.UserCode = SOU.UserCode)
		INNER JOIN sys_object_domain AS SOD ON SOD.DomainCode  = SOUBG.CompanyCode
		WHERE SOU.UserCode = #{UR_Code}
		AND SOD.DomainID IS NOT NULL
	</select>
	
	<insert id="insertCommunityGroupMember" parameterType="cmap">
		INSERT INTO sys_object_group_member
		(
			GroupCode,
			UserCode,
			SortKey,
			Role,
			IsUse,
			IsHR,
			MemberStatus
		) VALUES (
			(SELECT CU_Code FROM community WHERE CU_ID = #{CU_ID}),
			#{UR_Code},
			200,	
			'member',	
			'Y',		
			'N',		
			'A'			
		)
	</insert>
	
	<!-- 커뮤니티 관리자 -->
	<select id="sendMessagingCommunityOperator" parameterType="cmap" resultType="cmap">
		SELECT cm.UR_Code AS UserCode
			 , IFNULL(Fn_GetSelDictionary(#{lang},CONCAT('CU_',c.CU_ID), c.DN_ID), c.CommunityName) AS CommunityName
			 , IFNULL(#{CU_ID}, '') AS CU_ID
		FROM covi_smart4j.community c
		INNER JOIN covi_smart4j.community_member cm ON c.CU_ID = cm.CU_ID AND cm.MemberLevel = 9
		WHERE 1=1
		AND c.CU_ID = #{CU_ID}
	</select>
	
	<!-- 가입된 커뮤니티 가입자 -->
	<select id="sendMessagingList"  parameterType="cmap" resultType="cmap">
		SELECT cm.UR_Code AS UserCode
			, IFNULL(Fn_GetSelDictionary(#{lang},CONCAT('CU_',c.CU_ID), c.DN_ID), c.CommunityName) AS CommunityName
			, IFNULL(#{CU_ID}, '') AS CU_ID
		FROM covi_smart4j.community c
		INNER JOIN covi_smart4j.community_member cm ON c.CU_ID = cm.CU_ID AND cm.UR_Code = #{UR_Code}
		WHERE 1=1
		AND c.CU_ID = #{CU_ID}
	</select>
	
	<select id="sendMessagingListAdmin" parameterType="cmap" resultType="cmap">
		SELECT 
			  DISTINCT(UserCode) AS UserCode
			, #{Code} AS Code
			, #{CU_ID} AS CU_ID
			, (SELECT IFNULL(covi_smart4j.Fn_GetSelDictionary(#{lang}, CONCAT('CU_', CU_ID), DN_ID), CommunityName) FROM covi_smart4j.community WHERE CU_ID = #{CU_ID}) AS CommunityName
		FROM covi_smart4j.sys_object_group_member 
		WHERE GroupCode IN (
			SELECT SubjectCode
			FROM covi_smart4j.sys_object_acl 
			WHERE 1=1
			AND ObjecTtype = 'MN'
			AND ObjectID = (
				SELECT MenuID
				FROM covi_smart4j.sys_object_menu
				WHERE 1=1
				AND BizSection = 'Community'
				AND IsAdmin = 'Y'
				AND MenuType = 'TopSub'
			)
		) 
	</select>
	
	<insert id="sendMessaging" parameterType="cmap">
		INSERT INTO sys_alarm_list(				
			  UserCode
			 , Category
			 , MsgType
			 , Title
			 , URL
			 , Message
			 , OpenType
			 , ObjectID
			 , ObjectType
			 , IsPush
			 , PusherCode
			 , ReceivedDate
			 , IsRead
		)VALUES(
			  #{UserCode}
			 , #{Category}
			 , #{Code}
			 , #{Title}
			 , #{URL}			
			 , #{Message}
			 , 'PAGEMOVE'
			 , #{CU_ID}
			 , #{ObjectType}
			 , #{IsPush}
			 , #{PusherCode}
			 , NOW(3)
			 , #{IsRead}
		)
	</insert>
	
	<select id="selectUserAllPwChange" parameterType="cmap"  resultType="cmap">
		SELECT UserCode
			 , MailAddress
			 , REPLACE(Mobile, '-', '') AS Mobile
		FROM sys_object_user 
		WHERE Mobile IS NOT NULL
		AND Mobile != ''
	</select>
	
	<update id="UserAllPwChange"  parameterType="cmap" >
		UPDATE sys_object_user SET LogonPassword = HEX(AES_ENCRYPT(#{key}, SHA2(#{Mobile},512)))
		WHERE UserCode = #{UserCode}		
	</update>
	
	<select id="selectCommunityGradeList" parameterType="cmap" resultType="cmap">
		SELECT	  CodeID
				, CodeName
				, Code
		FROM sys_base_code sbc
		WHERE 1=1
		AND BizSection = 'Community'
		AND CodeGroup = 'CuMemberLevel'
		AND Code != 'CuMemberLevel'
		AND DomainID = (SELECT DomainID FROM covi_smart4j.sys_base_code WHERE BizSection = 'Community' AND Code = sbc.Code AND CodeGroup = 'CuMemberLevel' ORDER BY IF(DomainID = #{domainID}, 0, 1) LIMIT 1 )
	</select>
	
	<select id="selectCommunityGroupSubCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM COVI_SMART4J.SYS_OBJECT_GROUP
		WHERE GroupCode LIKE CONCAT('CommunityGrade', #{CU_ID}, '/_%') ESCAPE '/'
	</select>
	
	<insert id="createObjectGroupSub"  parameterType="cmap">
		INSERT INTO sys_object_group
		(
			GroupCode,
			CompanyCode,
			GroupType,
			MemberOf,
			OUName,
			DisplayName,
			MultiDisplayName,
			ShortName,
			MultiShortName,
			Approvable,
			Receivable,
			SortKey,
			IsUse,
			IsDisplay,
			IsMail,
			IsHR,
			RegistDate,
			Description,
			Reserved6
		) VALUES (
			CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}),
			#{DomainCode},
			'Community',
			#{CU_Code},
			#{GradeName},
			#{GradeName},
			#{GradeName},
			#{GradeName},
			#{GradeName},
			1,  	
			1,
			((SELECT SortKey FROM (SELECT IFNULL(MAX(SortKey), '0') AS SortKey FROM sys_object_group WHERE GroupType = 'Community' AND MemberOf = #{CU_Code}) AS B) + 1),
			'Y',
			'Y',
			'Y',
			'Y',
			NOW(3),
			'',
			#{GradeCode}
		)
	</insert>
	 
	<select id="selectObjectGroupInfo" parameterType="cmap" resultType="cmap">
	 	SELECT
	 			Fn_ComObjectPathCreate_S(0, (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) B),'GR') AS GroupPath
	 		 , Fn_ComSortPathCreate_S(0, (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) B), 'GR') AS SortPath
	 		 , (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) B) AS ApprovalUnitCode
	 		 , (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) B) AS ReceiptUnitCode
	 	FROM dual 
	 			
	</select>
	 
	<update id="updateObjectGroupSub" parameterType="cmap">
		UPDATE COVI_SMART4J.sys_object_group
		SET 
 				GroupPath = #{GroupPath}
 			,	SortPath =  #{SortPath}
 			,	ApprovalUnitCode = #{ApprovalUnitCode}
 			,	ReceiptUnitCode = #{ReceiptUnitCode}
	 	 WHERE 1=1 
		 AND GroupCode IN (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) AS B)
	</update>
	 
	<select id="insertCommunityGroupMemberCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM sys_object_group_member
		WHERE 1=1
		AND GroupCode = (SELECT CU_Code FROM community WHERE CU_ID = #{CU_ID})
		AND UserCode = #{UR_Code}
	</select>
	
	<insert id="insertCommunityGroupMemberMasterGrade" parameterType="cmap" >
		INSERT INTO sys_object_group_member
		(	
			GroupCode,
			UserCode,
			SortKey,
			Role,
			IsUse,
			IsHR,
			MemberStatus
		) VALUES (
			(SELECT sog.GroupCode FROM community c INNER JOIN sys_object_group sog on c.CU_Code = sog.MemberOf WHERE sog.Reserved6 = 9 AND sog.MemberOf IN (SELECT CU_Code FROM (SELECT CU_Code FROM community WHERE CU_ID = #{CU_ID}) AS B)),
			#{UR_Code} ,
			200,	
			'member',	
			'Y',		
			'N',		
			'A'			
		)
	</insert>
	
	<delete id="DelCommunityFavorite" parameterType="cmap" >
		DELETE FROM community_favorite WHERE CU_ID = #{CU_ID}
	</delete>
	
	<select id="getCommunityName"  parameterType="cmap" resultType="String">
		SELECT CommunityName FROM community WHERE CU_ID = #{CU_ID}
	</select>
	
	<select id="maxID"  parameterType="cmap" resultType="String">
		SELECT CONCAT('Community', (SELECT `AUTO_INCREMENT`
									FROM  INFORMATION_SCHEMA.TABLES
									WHERE TABLE_SCHEMA = 'COVI_SMART4J'
									AND	TABLE_NAME = 'COMMUNITY')		
		) FROM dual
	</select>
</mapper>
