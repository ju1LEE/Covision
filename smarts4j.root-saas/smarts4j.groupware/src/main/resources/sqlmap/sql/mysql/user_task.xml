<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="user.task">
    
    <!--개인폴더(나의 업무) 조회  -->
    <select id="selectPersonalFolderList" parameterType="cmap" resultType="cmap">
        SELECT FolderID
				, IFNULL(a.ParentFolderID,0) AS ParentFolderID 
			  	, DisplayName
			  	, length(IDPath)-length(REPLACE(IDPath,';','')) AS depth
			  	, IsShare
			  	, IfNull(b.Cnt, 0) AS ChildCnt
		FROM covi_smart4j.task_folder AS a
		LEFT JOIN (
			SELECT  ParentFolderID, COUNT(*) AS Cnt
			FROM    covi_smart4j.task_folder
			WHERE DeleteDate IS NULL
			GROUP BY ParentFolderID
		) b ON a.FolderID = b.ParentFolderID
		WHERE OwnerCode = #{userID}
		AND DeleteDate IS NULL
		ORDER BY depth ASC, RegistDate ASC
    </select>
    
    <!--공유폴더(공유 업무) 조회  -->
    <select id="selectShareFolderList" parameterType="cmap" resultType="cmap">
    	SELECT DISTINCT a.FolderID
				, a.ParentFolderID
				, a.DisplayName
				, length(IDPath)-length(REPLACE(IDPath,';','')) AS depth
				, IfNull(c.Cnt, 0) AS ChildCnt
		FROM covi_smart4j.task_folder AS a
		INNER JOIN covi_smart4j.task_folder_share_member AS b ON a.FolderID = b.FolderID
		LEFT JOIN (
			SELECT  ParentFolderID, COUNT(*) AS Cnt
			FROM    covi_smart4j.task_folder
			WHERE DeleteDate IS NULL
			GROUP BY ParentFolderID
        ) c ON a.FolderID = c.ParentFolderID
		WHERE a.DeleteDate IS NULL
		AND b.MemberCode IN 
		<foreach collection="subjectArr" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
		AND a.OwnerCode != #{userID}
		ORDER BY depth ASC, RegistDate ASC
    </select>
    
    <!-- 사용자가 조회 권한이 있는 모든 폴더 (개인& 공유) 조회  (좌측 메뉴 검색용)-->
    <select id="selectUserAllFolderList" parameterType="cmap" resultType="cmap">
        SELECT DISTINCT a.FolderID
		  		, a.DisplayName
				, a.State AS FolderState
				, a.State AS FolderStateCode
				, a.IsShare 
				, a.OwnerCode
				, a.RegisterCode
				, IFNULL(a.ParentFolderID,0) AS ParentFolderID
		FROM covi_smart4j.task_folder AS a
		LEFT JOIN covi_smart4j.task_folder_share_member AS b ON a.FolderID = b.FolderID 
		WHERE ( (a.OwnerCode = #{userID}) OR (b.MemberCode IN 
		<foreach collection="subjectArr" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
		 AND a.OwnerCode != #{userID}) )
		AND a.DeleteDate IS NULL
		<if test="stateCode != null and stateCode != '' and stateCode != 'FolderState' and stateCode != 'TaskState' ">
		 	AND a.State = #{stateCode} 
	    </if>
		<if test="searchWord != null and searchWord != '' ">
		 	AND  a.DisplayName LIKE CONCAT('%',#{searchWord},'%')
	   </if>
	     <!-- Order by 절 -->
		<trim prefix="ORDER BY">
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>DisplayName</when>
					<otherwise>RegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
    </select>

    <!-- 사용자가 조회 권한이 있는 모든 업무 (개인& 공유) 조회 (좌측 메뉴 검색용)-->
    <select id="selectUserAllTaskList" parameterType="cmap" resultType="cmap">
       SELECT * FROM (
	       	SELECT DISTINCT a.TaskID
					, a.FolderID
					, a.Subject
					, a.State AS TaskState
					, a.State AS TaskStateCode
					, a.Progress AS TaskProgress
					, IF(
						(a.State = 'Waiting'  AND (a.StartDate <![CDATA[ < ]]> #{localCurrentDate}  OR date_add(a.EndDate, interval+1 day ) <![CDATA[ < ]]> #{localCurrentDate} )  )
						OR
						(a.State = 'Process' AND  date_add( a.EndDate, interval+1 day ) <![CDATA[ < ]]> #{localCurrentDate} )
					 	, 'Y', 'N'
					 ) AS IsDelay
					, d.IsRead
					, a.StartDate
					, a.EndDate
					, a.RegistDate
					, a.OwnerCode
					, a.RegisterCode
			FROM covi_smart4j.task AS a
			LEFT JOIN covI_smart4j.task_folder AS b ON a.FolderID = b.FolderID
			LEFT JOIN covi_smart4j.task_folder_share_member AS c ON b.FolderID = c.FolderID
			LEFT JOIN (
				SELECT	  TaskID
						, IF(MAX(ReadDate) IS NULL, 'N', 'Y') AS IsRead
				FROM covi_smart4j.task_read
				WHERE UserID = #{userID}
				GROUP BY TaskID
			) d ON a.TaskID = d.TaskID
			WHERE ( (a.OwnerCode = #{userID}) OR (c.MemberCode IN 
			<foreach collection="subjectArr" item="item" open="(" close=")" separator=",">
					#{item}
			</foreach> 
			AND a.OwnerCode != #{userID}) )
			AND a.DeleteDate IS NULL
			AND b.DeleteDate IS NULL
			AND (a.IsTempSave IS NULL OR a.IsTempSave != 'Y') 
       <if test="stateCode != null and stateCode != '' and stateCode != 'FolderState' and stateCode != 'TaskState' ">
		 	AND a.State = #{stateCode} 
	    </if>
		<if test="searchWord != null and searchWord != '' ">
		 	AND Subject LIKE CONCAT('%',#{searchWord},'%')
	   </if>
		) AS temp
	    <!-- Order by 절 -->
		<trim prefix="ORDER BY" >
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				IsRead DESC, IsDelay DESC, RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<otherwise>RegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
    </select>
   
    <!-- 해당사용자가 권한을 가진 모든 공유 폴더 목록 조회 -->
     <select id="selectAllShareFolderList" parameterType="cmap" resultType="cmap">
     		/* queryID : user.task.selectAllShareFolderList */
			SELECT * FROM          
				    	( SELECT  DISTINCT a.FolderID
								  , a.ParentFolderID
								  , a.DisplayName
								  , a.State AS FolderState
								  , a.State AS FolderStateCode
								  , a.IsShare 
								  , a.RegistDate
								  , Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) AS OwnerName
								  , a.Progress AS FolderProgress
						FROM covi_smart4j.task_folder AS a
						INNER JOIN covi_smart4j.task_folder_share_member AS b ON a.FolderID = b.FolderID
						LEFT JOIN covi_smart4j.sys_object_user AS c ON a.OwnerCode = c.UserCode
						WHERE a.DeleteDate IS NULL
						AND b.MemberCode IN 
						<foreach collection="subjectArr" item="item" open="(" close=")" separator=",">
							#{item}
						</foreach>
						AND a.OwnerCode != #{userID} ) AS temp
			<trim prefix="WHERE" prefixOverrides="AND|OR ">
			    <if test="stateCode != null and stateCode != '' and stateCode != 'FolderState' and stateCode != 'TaskState' ">
		 			AND temp.FolderStateCode = #{stateCode} 
	   			</if>
				<if test="searchType != null and searchType !='' and searchWord != null and searchWord != '' and searchWord.length() gt 0">
					<choose>
					    <when test="searchType == 'Subject'"> <!-- 제목 -->
					      AND temp.DisplayName LIKE CONCAT('%',#{searchWord},'%')
					    </when>
					    <when test="searchType == 'OwnerName'"><!-- 소유자 -->
					     AND  temp.OwnerName LIKE CONCAT('%',#{searchWord},'%')
					    </when>
					    <when test="searchType == 'All'"><!-- 소유자 -->
					     AND  (
							     	temp.DisplayName LIKE CONCAT('%',#{searchWord},'%')
							     	OR
							     	temp.OwnerName LIKE CONCAT('%',#{searchWord},'%')
				     	)
					    </when>
				    </choose>
				</if>
			</trim>
		    <!-- Order by 절 -->
			<trim prefix="ORDER BY" >
				<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
					RegistDate DESC
				</if>
				<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
					<choose>
						<when test='sortColumn.equalsIgnoreCase("Subject")'>DisplayName</when>
						<otherwise>RegistDate</otherwise>
					</choose>
					<choose>
						<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
						<otherwise> DESC</otherwise>
					</choose>
				</if>
			</trim>
    </select>
    
     <!-- 특정 폴더 정보 조회 -->
     <select id="selectFolderData" parameterType="cmap" resultType="cmap">
        SELECT a.FolderID
				  , IFNULL(a.ParentFolderID, 0) AS ParentFolderID
				  , a.DisplayName
				  , a.State AS FolderState
				  , a.State
				  , a.Description
				  , a.IsShare
				  , a.IDPath
				  , a.RegisterCode
				  , a.OwnerCode
				  , DATE_FORMAT(a.RegistDate,' %Y/%m/%d %H:%i:%s') AS RegistDate
				  , Fn_BaseGetDictionary_S(#{lang}, b.MultiDisplayName) AS RegisterName
				  , a.Progress
        FROM task_folder AS a
        LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode 
        WHERE a.FolderID = #{FolderID}
     </select>
    
    <!-- 특정 폴더의 하위 폴더 항목 조회-->
    <select id="selectFolderOfFolderList" parameterType="cmap" resultType="cmap">
       SELECT * FROM          
			    	( SELECT DISTINCT a.FolderID
								, a.DisplayName
								, a.State AS FolderState
								, a.State AS FolderStateCode
								, a.IsShare 
								, a.OwnerCode 
								, a.RegisterCode 
								, IFNULL(a.ParentFolderID,0) AS ParentFolderID
								, a.RegistDate
								, Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) AS OwnerName
								, a.Progress as FolderProgress
						FROM covi_smart4j.task_folder AS a
						LEFT JOIN covi_smart4j.task_folder_share_member AS b ON a.FolderID = b.FolderID
						LEFT JOIN covi_smart4j.sys_object_user AS c ON a.OwnerCode = c.UserCode
						WHERE IFNULL(a.ParentFolderID, 0)  = #{FolderID}
						AND a.DeleteDate IS NULL
						<if test="stateCode != null and stateCode != '' and stateCode != 'FolderState' and stateCode != 'TaskState'">
						 	AND a.State = #{stateCode} 
						</if>
				       	<choose>
					        <when test="isMine!=null and isMine.equalsIgnoreCase('Y')">
					        	AND a.OwnerCode  = #{userID}
					        </when>
					        <otherwise>
								AND (b.MemberCode IN 
								<foreach collection="subjectArr" item="item" open="(" close=")" separator=",">
									#{item}
								</foreach> 
								AND a.OwnerCode != #{userID})
					        </otherwise>
						</choose>
					) AS temp
       <trim prefix="WHERE" prefixOverrides="AND|OR ">
			<if test="searchType != null and searchType !='' and searchWord != null and searchWord != '' and searchWord.length() gt 0">
				<choose>
				    <when test="searchType == 'Subject'"> <!-- 제목 -->
				      AND temp.DisplayName LIKE CONCAT('%',#{searchWord},'%')
				    </when>
				    <when test="searchType == 'OwnerName'"><!-- 소유자 -->
				     AND  temp.OwnerName LIKE CONCAT('%',#{searchWord},'%')
				    </when>
				    <when test="searchType == 'All'"><!-- 소유자 -->
				     AND  (
						     	temp.DisplayName LIKE CONCAT('%',#{searchWord},'%')
						     	OR
						     	temp.OwnerName LIKE CONCAT('%',#{searchWord},'%')
			     	)
				    </when>
			    </choose>
			</if>
       </trim>
		<!-- Order by 절 -->
		<trim prefix="ORDER BY" >
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>DisplayName</when>
					<otherwise>RegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
    </select>
    
    <!-- 특정 폴더의 하위 업무 항목 조회-->
    <select id="selectTaskOfFolderList" parameterType="cmap" resultType="cmap">
		<![CDATA[
		SELECT * FROM (
			SELECT	  a.TaskID
					, a.FolderID
					, a.Subject
					, a.State AS TaskState
					, a.State AS TaskStateCode
					, a.Progress AS TaskProgress
					, IF(
						(a.State = 'Waiting'  AND (a.StartDate < #{localCurrentDate}  OR a.EndDate < #{localCurrentDate} )  )
						OR
						(a.State = 'Process' AND a.EndDate < #{localCurrentDate} )
					 	, 'Y', 'N'
					 ) AS IsDelay
					, b.IsRead
					, a.RegistDate
					, a.RegisterCode
					, a.OwnerCode
					, Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) AS OwnerName
					-- , CASE WHEN p.PerformerCode IS NULL THEN 'N' ELSE 'Y' END AS IsPerformer
			FROM covi_smart4j.task AS a
			LEFT JOIN (
				SELECT	  TaskID
						, IF(MAX(ReadDate) IS NULL, 'N', 'Y') AS IsRead
				FROM covi_smart4j.task_read
				WHERE UserID = #{userID}
				GROUP BY TaskID
			) b ON a.TaskID = b.TaskID
			LEFT JOIN covi_smart4j.sys_object_user AS c ON a.OwnerCode = c.UserCode
			WHERE a.FolderID = #{FolderID}
			AND a.DeleteDate IS NULL
			AND (a.IsTempSave IS NULL OR a.IsTempSave != 'Y')
		) AS temp
		]]>
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="FolderID!=null and FolderID.equalsIgnoreCase('0')">
				AND temp.OwnerCode =  #{userID} # 0인경우는 나의 업무, 공유 업무는 0에 업무 추가 불가.
			</if>
			<if test="stateCode != null and stateCode != '' and stateCode != 'FolderState' and stateCode != 'TaskState' ">
			 	AND temp.TaskStateCode = #{stateCode} 
			</if>
			<if test="searchType != null and searchType !='' and searchWord != null and searchWord != '' and searchWord.length() gt 0">
				<choose>
					<when test="searchType == 'Subject'"> <!-- 제목 -->
						AND temp.Subject LIKE CONCAT('%',#{searchWord},'%')
					</when>
					<when test="searchType == 'OwnerName'"><!-- 소유자 -->
						AND temp.OwnerName LIKE CONCAT('%',#{searchWord},'%')
					</when>
					<when test="searchType == 'All'"><!-- 소유자 -->
						AND (
							temp.Subject LIKE CONCAT('%',#{searchWord},'%')
							OR
							temp.OwnerName LIKE CONCAT('%',#{searchWord},'%')
				 		)
					</when>
				</choose>
			</if>
		</trim>
		<!-- Order by 절 -->
		<trim prefix="ORDER BY" >
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				IsRead DESC, IsDelay DESC, RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<otherwise>RegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
	</select>
	
    <!-- 사용자의 모든 임시저장 항목 조회 -->
    <select id="selectUserAllTempTaskList" parameterType="cmap" resultType="cmap">
	       <![CDATA[
	       SELECT * FROM (	SELECT a.TaskID
						, a.FolderID
						, a.Subject
						, a.State AS TaskState
						, a.State AS TaskStateCode
						, IF(
							(a.State = 'Waiting'  AND (a.StartDate < #{localCurrentDate}  OR a.EndDate < #{localCurrentDate} )  )
							OR
							(a.State = 'Process' AND a.EndDate < #{localCurrentDate} )
						 	, 'Y', 'N'
						 ) AS IsDelay
						, b.IsRead
						, a.RegistDate
						, a.RegisterCode
						, a.OwnerCode
						, Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) AS OwnerName
			FROM covi_smart4j.task AS a
			LEFT JOIN (
				SELECT	  TaskID
						, IF(MAX(ReadDate) IS NULL, 'N', 'Y') AS IsRead
				FROM covi_smart4j.task_read
				WHERE UserID = #{userID}
				GROUP BY TaskID
			) b ON a.TaskID = b.TaskID
			LEFT JOIN covi_smart4j.sys_object_user AS c ON a.OwnerCode = c.UserCode
			WHERE a.RegisterCode = #{userID}
			AND a.DeleteDate IS NULL 
			AND a.IsTempSave = 'Y'
	       ]]><!-- 임시저장 : IsTempSave = 'Y' -->
			<if test="stateCode != null and stateCode != '' and stateCode != 'FolderState' and stateCode != 'TaskState' ">
			 	AND a.State = #{stateCode} 
		    </if>
			<if test="searchWord != null and searchWord != '' ">
			 	AND a.Subject LIKE CONCAT('%',#{searchWord},'%')
		   </if>
			) AS temp
		<!-- Order by 절 -->
		<trim prefix="ORDER BY" >
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				IsRead DESC, IsDelay DESC, RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<otherwise>RegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
    </select>
    
    <select id="selectTempTaskOfFolderList" parameterType="cmap" resultType="cmap">
       <![CDATA[
       SELECT * FROM (	SELECT a.TaskID
					, a.FolderID
					, a.Subject
					, a.State AS TaskState
					, a.State AS TaskStateCode
					, a.Progress AS TaskProgress
					, IF(
						(a.State = 'Waiting'  AND (a.StartDate < #{localCurrentDate}  OR a.EndDate < #{localCurrentDate} )  )
						OR
						(a.State = 'Process' AND a.EndDate < #{localCurrentDate} )
					 	, 'Y', 'N'
					 ) AS IsDelay
					, b.IsRead
					, a.RegistDate
					, a.RegisterCode
					, a.OwnerCode
					, Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) AS OwnerName
		FROM covi_smart4j.task AS a
		LEFT JOIN (
			SELECT	  TaskID
					, IF(MAX(ReadDate) IS NULL, 'N', 'Y') AS IsRead
			FROM covi_smart4j.task_read
			WHERE UserID = #{userID}
			GROUP BY TaskID
		) b ON a.TaskID = b.TaskID
		LEFT JOIN covi_smart4j.sys_object_user AS c ON a.OwnerCode = c.UserCode
		WHERE a.FolderID = #{FolderID}
		AND a.DeleteDate IS NULL 
		AND a.IsTempSave = 'Y') AS temp
       ]]><!-- 임시저장 : IsTempSave = 'Y' -->
       <trim prefix="WHERE" prefixOverrides="AND|OR">
			 <if test="FolderID!=null"> 
			    AND temp.OwnerCode =  #{userID} # 0인경우는 나의 업무, 공유 업무는 0에 업무 추가 불가. 
			 </if>
	        <if test="stateCode != null and stateCode != '' and stateCode != 'FolderState' and stateCode != 'TaskState' ">
			 	AND temp.TaskStateCode = #{stateCode} 
		    </if>
			<if test="searchType != null and searchType !='' and searchWord != null and searchWord != '' and searchWord.length() gt 0">
				<choose>
				    <when test="searchType == 'Subject'"> <!-- 제목 -->
				      AND temp.Subject LIKE CONCAT('%',#{searchWord},'%')
				    </when>
				    <when test="searchType == 'OwnerName'"><!-- 소유자 -->
				     AND  temp.OwnerName LIKE CONCAT('%',#{searchWord},'%')
				    </when>
				    <when test="searchType == 'All'"><!-- 소유자 -->
				     AND  (
						     	temp.Subject LIKE CONCAT('%',#{searchWord},'%')
						     	OR
						     	temp.OwnerName LIKE CONCAT('%',#{searchWord},'%')
			     	)
				    </when>
			    </choose>
			</if>
       </trim>
		<!-- Order by 절 -->
		<trim prefix="ORDER BY" >
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				IsRead DESC, IsDelay DESC, RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<otherwise>RegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
    </select>
    
    
    <!-- 폴더 정보 추가 -->
   <insert id="insertFolderData" parameterType="cmap" >
       INSERT INTO covi_smart4j.task_folder(ParentFolderID,DisplayName,State,Description,IsShare,RegisterCode,OwnerCode,RegistDate,ModifyDate
		<if test="Progress != null"><!-- 진도율 -->
			, Progress
		</if>	
       )
	   VALUES(#{ParentFolderID},#{DisplayName},#{State},#{Description},#{IsShare},#{RegisterCode},#{OwnerCode},now(3),now(3)
		<if test="Progress != null"><!-- 진도율 -->
			,#{Progress}
		</if>		   
	   );
	   <selectKey keyProperty="FolderID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
      </selectKey>
   </insert>
   
   <!--  특정 폴더의 하위 폴더 모두 조회 (자기 자신 제외) -->
   <select id="selectChildFolder" parameterType="cmap" resultType="java.lang.String">
       CALL SP_GetChildFolder(#{FolderID},@RESULT);
	   SELECT @RESULT;
   </select>
    
   <!-- 폴더 수정 시 기존 공유 대상 조회  -->
   <select id="selectOldShareMember" parameterType="cmap" resultType="cmap">
       SELECT MemberCode AS Code, MemberType AS Type 
       FROM  covi_smart4j.task_folder_share_member
       WHERE FolderID = #{FolderID}
   </select>
   
   <!-- 폴더 정보 수정  -->
   <update id="updateFolderData" parameterType="cmap" >
       UPDATE covi_smart4j.task_folder
       SET DisplayName = #{DisplayName},
       State = #{State},
		<if test="Progress != null"><!-- 진도율 -->
       Progress = #{Progress},
		</if>       
       Description = #{Description},
       IsShare = #{IsShare},
       ModifyDate = now(3)
       WHERE FolderID = #{FolderID}
   </update>
   
   <!-- 특정 폴더의 공유자 전체 삭제 -->
   <delete id="deleteShareMemberData"  parameterType="cmap">
       DELETE FROM covi_smart4j.task_folder_share_member
	   WHERE FolderID IN
	   <foreach item="item" index="index" collection="childFolderList" open="(" close=")" separator=",">
            #{item}
       </foreach>
	    AND (
		      <foreach collection="ShareMemberList" item="ShareMemberData" index="index" separator=" OR ">
	          (MemberCode=#{ShareMemberData.Code} AND MemberType=#{ShareMemberData.Type} )
		      </foreach>
	   )
   </delete>
   
   <!-- 공유에 따라 폴더 IsShare 값 처리 -->
   <update id="updateIsShare" parameterType="cmap">
       UPDATE covi_smart4j.task_folder 
       SET IsShare = 'N';
		
		UPDATE covi_smart4j.task_folder 
       SET IsShare = 'Y'
       WHERE FolderID IN (
	        SELECT b.FolderID FROM covi_smart4j.task_folder_share_member AS b
			GROUP BY b.FolderID 
		);
   </update> 
   
   <!-- 하위 항목의 공유 정보 삭제 -->
   <delete id="deleteChildShareData" parameterType="cmap">
       DELETE FROM covi_smart4j.task_folder_share
	   WHERE FolderID IN 
        <foreach item="item" index="index" collection="childFolderList" open="(" close=")" separator=",">
            #{item}
       </foreach>
   </delete>
   
   <!-- 공유데이터 추가 - 추가용 -->
   <insert id="insertShareMemberData" parameterType="cmap">
	 INSERT INTO covi_smart4j.task_folder_share_member (FolderID, MemberCode, MemberType,SortKey)
	 VALUES
    <foreach collection="shareMemberList" item="shareMemberData" index="index" separator=",">
       (
        #{FolderID},
       	#{shareMemberData.Code},
       	#{shareMemberData.Type},
       	#{index}
       )
       </foreach>
   </insert>
   
   <!-- 공유 데이터 추가 - 수정용  -->
   <insert id="insertModifyShareMemberData" parameterType="cmap">
       INSERT INTO covi_smart4j.task_folder_share_member (FolderID, MemberCode, MemberType,SortKey)
       VALUES
       <foreach item="folderItem" index="index1" collection="childFolderList"  separator=",">
           <foreach item="memberItem" index="index2" collection="ShareMemberList" separator=",">
            	(#{folderItem},#{memberItem.Code},#{memberItem.Type},#{index2})
       		</foreach>
       </foreach>
       
   </insert>
   
   <!-- 폴더 삭제 -->
   <update id="deleteFolderData" parameterType="cmap">
       UPDATE covi_smart4j.task_folder
	   SET DeleteDate = now(3)
	   WHERE FolderID IN
	   <foreach item="item" index="index" collection="childFolderList" open="(" close=");" separator=",">
            #{item}
       </foreach>
       
		
	   UPDATE covi_smart4j.task
	   SET DeleteDate = now(3)
	   WHERE FolderID  IN
	   <foreach item="item" index="index" collection="childFolderList" open="(" close=");" separator=",">
            #{item}
       </foreach>
   </update>
   
   <!-- 업무 정보 추가 -->
   <insert id="insertTaskData" parameterType="cmap">
		INSERT INTO covi_smart4j.task(FolderID, Subject, Description, State, StartDate, EndDate, RegistDate, ModifyDate, OwnerCode, RegisterCode
		<if test="Mode != null and Mode.equalsIgnoreCase('IT')"><!-- 임시저장 -->
			, IsTempSave
		</if>
		<if test="Progress != null"><!-- 진도율 -->
			, Progress
		</if>		
		)
		VALUES(#{FolderID}, #{Subject}, #{Description}, #{State}, #{StartDate}, #{EndDate}, now(3), now(3), #{OwnerCode}, #{RegisterCode}
		<if test="Mode != null and Mode.equalsIgnoreCase('IT')"><!-- 임시저장 -->
			, 'Y'
		</if>
		<if test="Progress != null"><!-- 진도율 -->
			, #{Progress}
		</if>			
		)
	   <selectKey keyProperty="TaskID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
      </selectKey>
   </insert>
   
   <!-- 업무 정보 수정 -->
   <update id="updateTaskData" parameterType="cmap">
       UPDATE covi_smart4j.task
	   SET  Subject = #{Subject}
			, State = #{State}
			, Description = #{Description}
			, StartDate = #{StartDate}
			, EndDate = #{EndDate}
			, ModifyDate = now(3)
			<if test="Mode != null and Mode.equalsIgnoreCase('UT')"><!-- 임시저장을 등록상태로 변경 -->
				, IsTempSave = 'N'   
			</if>
			<if test="Progress != null"><!-- 진도율 없을 경우 참고 -->
				, Progress = #{Progress}
			</if>
	   WHERE TaskID = #{TaskID}
   </update>
   
   <!-- 수행자 정보 추가  -->
   <insert  id="insertTaskPerformerData" parameterType="cmap">
		INSERT INTO covi_smart4j.task_performer(TaskID,PerformerCode,SortKey)
		VALUES
    	<foreach collection="arrPerformer" item="performerData" index="index" separator=",">
	       (
	        #{TaskID},
	       	#{performerData.PerformerCode},
	       	#{index}
	       )
       </foreach>
   </insert>
   
   <!-- 수행자 정보 삭제 -->
   <delete id="deleteTaskPerformerData" parameterType="cmap">
      	DELETE FROM covi_smart4j.task_performer
		WHERE TaskID = #{TaskID} 
   </delete>
   
   <!-- 기존 폴더명 조회 -->
   <select id="selectOrginFolderName" parameterType="cmap" resultType="java.lang.String">
       SELECT DisplayName 
	   FROM covi_smart4j.task_folder
	   WHERE FolderID = #{originFolderID}
   </select> 
   
   <!-- 기존 업무명 조회  -->
   <select id="selectOrginTaskName" parameterType="cmap" resultType="java.lang.String">
       SELECT Subject 
	   FROM covi_smart4j.task
	   WHERE TaskID = #{originTaskID}
   </select> 
   
   <!-- 중복 폴더명칭 체크  -->
   <select id="checkDuplicationFolder" parameterType="cmap" resultType="java.lang.Long">
       SELECT COUNT(*) FROM task_folder
	   WHERE DisplayName = #{folderName}
	   AND IFNULL(ParentFolderID,0) = #{targetFolderID}
	   AND DeleteDate IS NULL
  	   <if test="targetFolderID!=null and targetFolderID.equalsIgnoreCase('0')">
  		  AND OwnerCode = #{ownerCode}  #내가 하는 일 최상위에 위치할 경우 사용자 코드 체크
  	   </if>
  	   <if test="isCopy!=null and isCopy.equalsIgnoreCase('N')">
  		  AND FolderID != #{originFolderID} 
  	   </if>
  	   <if test="isModify!=null and isModify.equalsIgnoreCase('Y')">
  		  AND FolderID != #{originFolderID} 
  	   </if>
   </select>
   
   <!-- 중복 업무명칭 체크   -->
   <select id="checkDuplicationTask" parameterType="cmap" resultType="java.lang.Long">
       SELECT COUNT(*) FROM task
	   WHERE Subject = #{taskName}
	   AND FolderID = #{targetFolderID}
	   AND DeleteDate IS NULL
	  <if test="targetFolderID!=null and targetFolderID.equalsIgnoreCase('0')">
	    AND OwnerCode = #{ownerCode}  #내가 하는 일 최상위에 위치할 경우 사용자 코드 체크
	  </if>
	 <if test="isCopy!=null and isCopy.equalsIgnoreCase('N')">
	 	AND TaskID != #{originTaskID} 
     </if>
     <if test="isModify!=null and isModify.equalsIgnoreCase('Y')">
	 	AND TaskID != #{originTaskID} 
     </if>
   </select>
   
   <!-- 업무 복사  -->
   <insert id="copyTask" parameterType="cmap" >
      INSERT INTO covi_smart4j.task(FolderID, Subject, Description, State, StartDate, EndDate, RegistDate, ModifyDate, OwnerCode, RegisterCode, Progress)
	   SELECT #{targetFolderID} AS FolderID
	   		, #{saveName} AS Subject
			, Description
			, State
			, StartDate
			, EndDate
			, now(3) AS RegistDate
			, now(3) AS ModifyDate
			, #{OwnerCode} AS OwnerCode
			, #{RegisterCode}  AS RegisterCode
			, Progress
		FROM covi_smart4j.task
		WHERE TaskID =#{originTaskID};
		<selectKey keyProperty="TaskID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
        </selectKey>
   </insert>
   
   <!-- 복사된 업무의 파일 복사  -->
   <insert id="copyTaskFile" parameterType="cmap" >
    INSERT INTO covi_smart4j.sys_file (StorageID,ServiceType,ObjectID,ObjectType,MessageID,Version,SaveType,LastSeq,Seq,FilePath,FileName,SavedName,Extention,`Size`,ThumWidth,ThumHeight,Description,RegistDate,RegisterCode,CompanyCode) 
	SELECT
		StorageID,
		ServiceType,
		#{targetFolderID} AS ObjectID,
		ObjectType,
		#{TaskID} AS MessageID,
		Version,
		SaveType,
		LastSeq,
		Seq,
		FilePath,
		FileName,
		SavedName,
		Extention,
		`Size`,
		ThumWidth,
		ThumHeight,
		Description,
		RegistDate,
		RegisterCode,
		CompanyCode
	  FROM covi_smart4j.sys_file
	 WHERE ServiceType = 'Task' 
	   AND ObjectID = (SELECT a.FolderID FROM covi_smart4j.task AS a  LEFT JOIN covi_smart4j.sys_object_user AS b ON a.RegisterCode = b.UserCode LEFT JOIN covi_smart4j.task_folder AS c ON a.FolderId = c.FolderID WHERE a.TaskID = #{originTaskID})
	   AND MessageID = #{originTaskID} 
	   AND SaveType != 'INLINE'
	   AND ObjectType = 'TKFD'
   </insert>
   
   <!-- 수행자 정보 복사  -->
   <insert id="copyTaskPerformer" parameterType="cmap" >
       INSERT INTO covi_smart4j.task_performer(TaskID,PerformerCode,SortKey)
	   SELECT #{TaskID} AS TaskID, PerformerCode, SortKey
	   FROM covi_smart4j.task_performer
	   WHERE TaskID = #{originTaskID} ORDER BY SortKey;
   </insert>
   
   <!-- 업무 정보 삭제  -->
   <update id="deleteTaskData" parameterType="cmap">
       UPDATE covi_smart4j.task
	   SET DeleteDate = now(3)
	   WHERE TaskID = #{TaskID}
   </update>
   
   <!-- 업무에 업로드된 파일 이동 -->
   <update id="moveTaskFile" parameterType="cmap">
	  UPDATE covi_smart4j.sys_file
	    SET ObjectID = #{targetFolderID}
	  WHERE ServiceType = 'Task' 
	    AND ObjectID = (SELECT a.FolderID FROM covi_smart4j.task AS a  LEFT JOIN covi_smart4j.sys_object_user AS b ON a.RegisterCode = b.UserCode LEFT JOIN covi_smart4j.task_folder AS c ON a.FolderId = c.FolderID WHERE a.TaskID = #{originTaskID})
	    AND MessageID = #{originTaskID} 
	    AND SaveType != 'INLINE'
	    AND ObjectType = 'TKFD'
   </update>
   
   <!-- 업무 이동  -->
   <update id="moveTask" parameterType="cmap">
      UPDATE covi_smart4j.task
	  SET Subject = #{saveName}, 
	  FolderID = #{targetFolderID}
      WHERE TaskID = #{originTaskID}
   </update>

   <!-- 폴더 이동 -->
   <update id="moveFolder" parameterType="cmap">
      UPDATE covi_smart4j.task_folder
	  SET ParentFolderID = #{targetFolderID},
	  DisplayName = #{saveName}
	  WHERE FolderID = #{originFolderID}
   </update>
   
    <!-- IDPath 수정 -->
   <update id="updateFolderIDPath" parameterType="cmap">
       UPDATE covi_smart4j.task_folder 
	   SET IDPath = covi_smart4j.Fn_TaskIDPathCreate(FolderID)
	   <if test="FolderID!=null">
	 	  WHERE FolderID = #{FolderID}
       </if>
	   <if test="childFolderList!=null">
	 	  WHERE FolderID IN 
	 	  <foreach item="item" index="index" collection="childFolderList" open="(" close=");" separator=",">
            #{item}
       	  </foreach>
       </if>
   </update>
   
   <!-- 자신과 하위 항목의 공유 폴더 개수 체크  -->
  <select id="selectShareChildCnt" parameterType="cmap" resultType="java.lang.Long">
       SELECT COUNT(*)
	   FROM covi_smart4j.task_folder
	   WHERE IsShare = 'Y'
	   AND FolderID IN 
	    <foreach item="item" index="index" collection="childFolderList" open="(" close=");" separator=",">
            #{item}
       </foreach>
   </select> 
   
  <!-- 공유 대상자 조회  -->
  <select id="selectFolderShareMember" parameterType="cmap" resultType="cmap">
     SELECT a.ShareID 
            , a.MemberCode AS Code
			, a.MemberType AS Type
			, ( CASE a.MemberType WHEN 'UR' THEN Fn_BaseGetDictionary_S(#{lang}, b.MultiDisplayName) ELSE Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) END ) AS Name
			, Fn_BaseGetDictionary_S(#{lang},d.MultiDeptName) AS DeptName
	FROM covi_smart4j.task_folder_share_member AS a
	LEFT JOIN covi_smart4j.sys_object_user AS b ON a.MemberCode = b.UserCode AND a.MemberType = 'UR'
	LEFT JOIN covi_smart4j.sys_object_group AS c ON a.MemberCode = c.GroupCode AND a.MemberType IN ('GR','CM')
	LEFT JOIN covi_smart4j.sys_object_user_basegroup AS d ON a.MemberCode = d.UserCode  AND a.MemberType = 'UR' AND d.JobType = 'Origin'
	WHERE (b.IsUse = 'Y' OR c.IsUse = 'Y')
	AND FolderID = #{FolderID}
	ORDER BY a.SortKey
  </select>
  
   <!-- 상위 폴더들의 공유 대상자 조회  -->
  <select id="selectParentFolderShareMember" parameterType="cmap" resultType="cmap">
       SELECT DISTINCT a.MemberCode AS Code
			, a.MemberType AS Type
			, ( CASE a.MemberType WHEN 'UR' THEN Fn_BaseGetDictionary_S(#{lang}, b.MultiDisplayName) ELSE Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) END ) AS Name
			, Fn_BaseGetDictionary_S(#{lang},d.MultiDeptName) AS DeptName
	FROM covi_smart4j.task_folder_share_member AS a
	LEFT JOIN covi_smart4j.sys_object_user AS b ON a.MemberCode = b.UserCode AND a.MemberType = 'UR'
	LEFT JOIN covi_smart4j.sys_object_group AS c ON a.MemberCode = c.GroupCode AND a.MemberType IN ('GR','CM')
	LEFT JOIN covi_smart4j.sys_object_user_basegroup AS d ON a.MemberCode = d.UserCode  AND a.MemberType = 'UR' AND d.JobType = 'Origin'
	WHERE (b.IsUse = 'Y' OR c.IsUse = 'Y')
	AND Fn_TaskIDPathCreate(#{ParentFolderID}) LIKE  CONCAT('%;',a.FolderID,';%') 
  </select>
  
  <!-- 이동 대상 폴더의 공유 대상자 조회(Code랑 Type만)  -->
<!--   <select id="selectTargetFolderShareMember" parameterType="cmap" resultType="cmap">
   SELECT DISTINCT a.MemberCode
			, a.MemberType
	FROM covi_smart4j.task_folder_share_member AS a
	LEFT JOIN covi_smart4j.sys_object_user AS b ON a.MemberCode = b.UserCode AND a.MemberType = 'UR'
	WHERE (b.IsUse = 'Y' OR c.IsUse = 'Y')
	AND Fn_TaskIDPathCreate(#{targetFolderID}) LIKE  CONCAT('%;',a.FolderID,';%') 
  </select> -->
  
  <!--상위 폴더의 공유자 정보를 하위 폴더들에 삽입  -->
  <insert id="insertParentShareMemberToFolder" parameterType="cmap" >
      <foreach item="item" index="index" collection="childFolderList">
	          	INSERT INTO covi_smart4j.task_folder_share_member(FolderID, MemberCode, MemberType, SortKey)
				SELECT #{item}, temp.MemberCode, temp.MemberType , (@ROWNUM := @ROWNUM + 1) AS SortKey
				FROM 
						( SELECT DISTINCT a.MemberCode
						, a.MemberType
						FROM task_folder_share_member AS a 
						WHERE Fn_TaskIDPathCreate(#{targetFolderID}) LIKE CONCAT('%;',FolderID,';%') 
						) AS temp ,  (SELECT @ROWNUM := -1) AS R;
      </foreach>
  </insert>
   
   <!-- 특정 업무 정보 조회 -->
   <select id="selectTaskData" parameterType="cmap" resultType="cmap">
       SELECT a.TaskID
			  , a.FolderID
			  , c.DisplayName AS FolderName
			  , a.Subject
			  , a.Description
			  , a.State AS TaskState
			  , a.State AS TaskStateCode
			  , a.StartDate
			  , a.EndDate
			  , DATE_FORMAT(a.RegistDate,' %Y/%m/%d %H:%i:%s') AS RegistDate
			  , a.OwnerCode
			  , a.RegisterCode
			  , a.DeleteDate
			  , a.IsTempSave
			  , Fn_BaseGetDictionary_S(#{lang},b.MultiDisplayName) AS RegisterName
			  , a.Progress
		FROM covi_smart4j.task AS a
		LEFT JOIN covi_smart4j.sys_object_user AS b ON a.RegisterCode = b.UserCode 
		LEFT JOIN covi_smart4j.task_folder AS c ON a.FolderId = c.FolderID
		WHERE a.TaskID = #{TaskID}
     </select>
    
   <!-- 수행자 정보 조회  -->
   	<select id="selectTaskPerformerList" parameterType="cmap" resultType="cmap">
   	    SELECT a.PerformerCode AS Code
				, 'UR' AS Type
				, Fn_BaseGetDictionary_S(#{lang},b.MultiDisplayName) AS Name
				, Fn_BaseGetDictionary_S(#{lang},c.MultiDeptName) AS DeptName
		FROM task_performer AS a
		LEFT JOIN covi_smart4j.sys_object_user AS b ON a.PerformerCode = b.UserCode 
		LEFT JOIN covi_smart4j.sys_object_user_basegroup AS c ON a.PerformerCode = c.UserCode  AND c.JobType = 'Origin'
		WHERE a.TaskID = #{TaskID}
		AND b.IsUse = 'Y'
		AND b.IsDisplay = 'Y'
		ORDER BY a.SortKey
   	</select>
   	
   	<!-- 공유 대상에 속하는 모든 사용자 조회 -->
   	<select id="selectShareMemberUser" parameterType="cmap" resultType="cmap">
	   	   SELECT R.* FROM (
				SELECT DISTINCT temp.Code
					, temp.Name
					, temp.Type
					, Fn_BaseGetDictionary_S(#{lang},temp.DeptName) AS DeptName
					, temp.PhotoPath
				FROM (  
					 <if test="FolderID!=null and !FolderID.equalsIgnoreCase('0')">
					 	SELECT B.UserCode  AS Code
								, Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName) AS Name
								, 'UR' AS Type
								, C.MultiDeptName AS DeptName
								, B.PhotoPath
						FROM covi_smart4j.task_folder AS A
						INNER JOIN covi_smart4j.sys_object_user AS B ON A.OwnerCode = B.UserCode OR A.RegisterCode = B.UserCode
						LEFT JOIN covi_smart4j.sys_object_user_basegroup AS C ON B.UserCode = C.UserCode
						WHERE B.IsUse = 'Y' AND B.IsDisplay = 'Y' AND C.JobType = 'Origin'
						AND A.FolderID = #{FolderID}			
									
						UNION ALL
					 </if>
					
					 <if test="FolderID!=null and FolderID.equalsIgnoreCase('0')">
					 	SELECT B.UserCode  AS Code
								, Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName) AS Name
								, 'UR' AS Type
								, C.MultiDeptName AS DeptName
								, B.PhotoPath
						FROM covi_smart4j.sys_object_user AS B
						LEFT JOIN covi_smart4j.sys_object_user_basegroup AS C ON B.UserCode = C.UserCode
						WHERE B.IsUse = 'Y' AND B.IsDisplay = 'Y' AND C.JobType = 'Origin'
						AND B.UserCode = #{userCode}
						
						UNION ALL
					 </if>
					
						SELECT  a.UserCode AS Code
						, Fn_BaseGetDictionary_S(#{lang}, a.MultiDisplayName) AS Name
						, 'UR' AS Type
						, b.MultiDeptName AS DeptName
						, a.PhotoPath
					FROM (SELECT UserCode, MultiDisplayName, PhotoPath FROM covi_smart4j.sys_object_user WHERE IsUse = 'Y' AND IsDisplay = 'Y') AS a
					LEFT JOIN (SELECT UserCode, MultiDeptName FROM covi_smart4j.sys_object_user_basegroup WHERE JobType = 'Origin') AS b ON a.UserCode = b.UserCode 
					LEFT JOIN (SELECT UserCode, GroupCode FROM covi_smart4j.sys_object_group_member WHERE IsUse = 'Y') AS c ON a.UserCode = c.UserCode 
					LEFT JOIN (SELECT GroupPath, GroupCode FROM covi_smart4j.sys_object_group WHERE IsUse = 'Y' AND IsDisplay = 'Y') AS d ON c.GroupCode = d.GroupCode 
					INNER JOIN (SELECT MemberCode AS Code, MemberType AS Type FROM covi_smart4j.task_folder_share_member WHERE FolderID = #{FolderID}) AS m	
					ON (m.type = 'UR' AND (a.UserCode = m.Code))	OR (m.type = 'GR' AND (c.GroupCode = m.Code OR d.GroupPath LIKE CONCAT('%;', m.Code, ';%')))		# 폴더지정 공유자, 그룹
				) AS temp
				<trim prefix="WHERE" prefixOverrides="OR|AND" >
			 		 <if test="KeyWord!=null and KeyWord !='' ">
				        AND temp.Name LIKE CONCAT('%', #{KeyWord} ,'%') 
				     </if>
			 		 <if test="searchWord!=null and searchWord !='' ">
				        AND temp.Name LIKE CONCAT('%', #{searchWord} ,'%') 
				     </if>
				</trim>
		 ) AS R
		<trim prefix='ORDER BY'>
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				R.Name ASC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DeptName")'>R.DeptName</when>
					<otherwise>R.Name</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<choose>
		    <when test="pageSize != null and pageOffset != null ">
		        LIMIT #{pageSize} OFFSET #{pageOffset}
		    </when>
		    <otherwise>
		        LIMIT 10
		    </otherwise>
		</choose>
   	</select>
   	
   	<!-- 공유 대상에 속하는 모든 사용자 조회(Count) -->
   	<select id="selectShareMemberUserCnt" parameterType="cmap" resultType="java.lang.Long">
	   	 SELECT COUNT(*) FROM (
				SELECT DISTINCT temp.Code
					, temp.Name
					, temp.Type
					, Fn_BaseGetDictionary_S(#{lang},temp.DeptName) AS DeptName
					, temp.PhotoPath
				FROM (  
					 <if test="FolderID!=null and !FolderID.equalsIgnoreCase('0')">
					 	SELECT B.UserCode  AS Code
								, Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName) AS Name
								, 'UR' AS Type
								, C.MultiDeptName AS DeptName
								, B.PhotoPath
						FROM covi_smart4j.task_folder AS A
						INNER JOIN covi_smart4j.sys_object_user AS B ON A.OwnerCode = B.UserCode OR A.RegisterCode = B.UserCode
						LEFT JOIN covi_smart4j.sys_object_user_basegroup AS C ON B.UserCode = C.UserCode
						WHERE B.IsUse = 'Y' AND B.IsDisplay = 'Y' AND C.JobType = 'Origin'
						AND A.FolderID = #{FolderID}			
									
						UNION ALL
					 </if>
					
					 <if test="FolderID!=null and FolderID.equalsIgnoreCase('0')">
					 	SELECT B.UserCode  AS Code
								, Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName) AS Name
								, 'UR' AS Type
								, C.MultiDeptName AS DeptName
								, B.PhotoPath
						FROM covi_smart4j.sys_object_user AS B 
						LEFT JOIN covi_smart4j.sys_object_user_basegroup AS C ON B.UserCode = C.UserCode
						WHERE B.IsUse = 'Y' AND B.IsDisplay = 'Y' AND C.JobType = 'Origin'
						AND B.UserCode = #{userCode}
						
						UNION ALL
					 </if>
					
						SELECT  a.UserCode AS Code
						, Fn_BaseGetDictionary_S(#{lang}, a.MultiDisplayName) AS Name
						, 'UR' AS Type
						, b.MultiDeptName AS DeptName
						, a.PhotoPath
					FROM (SELECT UserCode, MultiDisplayName, PhotoPath FROM covi_smart4j.sys_object_user WHERE IsUse = 'Y' AND IsDisplay = 'Y') AS a
					LEFT JOIN (SELECT UserCode, MultiDeptName FROM covi_smart4j.sys_object_user_basegroup WHERE JobType = 'Origin') AS b ON a.UserCode = b.UserCode 
					LEFT JOIN (SELECT UserCode, GroupCode FROM covi_smart4j.sys_object_group_member WHERE IsUse = 'Y') AS c ON a.UserCode = c.UserCode 
					LEFT JOIN (SELECT GroupPath, GroupCode FROM covi_smart4j.sys_object_group WHERE IsUse = 'Y' AND IsDisplay = 'Y') AS d ON c.GroupCode = d.GroupCode 
					INNER JOIN (SELECT MemberCode AS Code, MemberType AS Type FROM covi_smart4j.task_folder_share_member WHERE FolderID = #{FolderID}) AS m	
					ON (m.type = 'UR' AND (a.UserCode = m.Code))	OR (m.type = 'GR' AND (c.GroupCode = m.Code OR d.GroupPath LIKE CONCAT('%;', m.Code, ';%')))		# 폴더지정 공유자, 그룹
				) AS temp
				<trim prefix="WHERE" prefixOverrides="OR|AND" >
			 		 <if test="KeyWord!=null and KeyWord !='' ">
				        AND temp.Name LIKE CONCAT('%', #{KeyWord} ,'%') 
				     </if>
			 		 <if test="searchWord!=null and searchWord !='' ">
				        AND temp.Name LIKE CONCAT('%', #{searchWord} ,'%') 
				     </if>
				</trim>
		 ) AS R
   	</select>
   	
   	
   	<!-- 공유 대상에 속하는 모든 사용자 조회 (간단 - 필요없는 동적 쿼리 삭제)-->
   	<select id="selectShareMemberUserSimple" parameterType="cmap" resultType="cmap">
			SELECT  DISTINCT a.UserCode AS Code
					, c.GroupCode AS GroupCode
					, CONCAT(';',d.GroupPath) AS GroupPath
					, 'UR' AS Type
					, a.PhotoPath
			FROM (SELECT UserCode, MultiDisplayName, PhotoPath FROM covi_smart4j.sys_object_user WHERE IsUse = 'Y' AND IsDisplay = 'Y') AS a
			LEFT JOIN (SELECT UserCode, GroupCode FROM covi_smart4j.sys_object_group_member WHERE IsUse = 'Y') AS c ON a.UserCode = c.UserCode 
			LEFT JOIN (SELECT GroupPath, GroupCode FROM covi_smart4j.sys_object_group WHERE IsUse = 'Y' AND IsDisplay = 'Y') AS d ON c.GroupCode = d.GroupCode 
			INNER JOIN (SELECT MemberCode AS Code, MemberType AS Type FROM covi_smart4j.task_folder_share_member WHERE FolderID = #{FolderID}) AS m				# 폴더지정 공유자	
			ON (m.type = 'UR' AND (a.UserCode = m.Code OR (a.UserCode = (SELECT ownercode FROM task_folder WHERE FolderID = #{FolderID} LIMIT 1))))				# 폴더생성 소유자
					OR (m.type = 'GR' AND (c.GroupCode = m.Code OR d.GroupPath LIKE CONCAT('%;', m.Code, ';%')))											# 폴더지정 그룹
   	</select>
   	
   	<!-- 공유자가 아닌 수행자 삭제 -->
   	<delete id="deleteNoSharePerformer" parameterType="cmap">
   	    DELETE a
		FROM covi_smart4j.task_performer AS a
		INNER JOIN covi_smart4j.task AS b ON a.TaskID = b.TaskID
		WHERE b.FolderID = #{FolderID}
		<if test="shareUserList.size != 0 "> 
			AND a.PerformerCode NOT IN 
		     <foreach item="item" index="index" collection="shareUserList" open="(" close=")" separator=",">
            #{item.Code}
       </foreach>
		</if>
   	    
   	</delete>
   	
   	<!-- 특정사용자의 특정 업무 읽음 정보 조회  -->
   	<select id="selectTaskReadDataCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) AS Cnt 
		FROM covi_smart4j.task_read
		WHERE TaskID = #{TaskID} AND UserID = #{UserID}
   	</select>
   	
   	<!-- 업무 읽음 정보 저장  -->
   	<insert id="insertTaskReadData" parameterType="cmap">
		INSERT INTO covi_smart4j.task_read (TaskID, UserID, ReadDate)
		VALUES (#{TaskID}, #{UserID}, now(3));	
   	</insert>
  
   	<!-- 수행자 정보 삭제  -->
   	<delete id="deletePerformerData" parameterType="cmap">
   	    DELETE FROM covi_smart4j.task_performer
   	    WHERE TaskID = #{originTaskID};
   	</delete>
	
	<select id="selectTaskSearchList" parameterType="cmap" resultType="cmap">
   	    SELECT DISTINCT A.* FROM (
			SELECT  a.TaskID
					, a.FolderID
					, a.Subject
					, a.State AS TaskState
					, a.State AS TaskStateCode
					, a.Progress AS TaskProgress
					, IF(
						(a.State = 'Waiting' AND (a.StartDate <![CDATA[ < ]]> #{localCurrentDate} OR a.EndDate <![CDATA[ < ]]> #{localCurrentDate}))
						OR
						(a.State = 'Process' AND a.EndDate <![CDATA[ < ]]> #{localCurrentDate})
					 	, 'Y', 'N'
					 ) AS IsDelay
					, b.IsRead
					, DATE_FORMAT(a.RegistDate, '%Y.%m.%d %H:%i:%s') AS RegistDate
					, a.RegisterCode
					, a.OwnerCode
					, Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) AS OwnerName
			FROM covi_smart4j.task AS a
			LEFT JOIN (
				SELECT	  TaskID
						, IF(MAX(ReadDate) IS NULL, 'N', 'Y') AS IsRead
				FROM covi_smart4j.task_read
				WHERE UserID = #{userID}
				GROUP BY TaskID
			) b ON a.TaskID = b.TaskID
			LEFT JOIN covi_smart4j.sys_object_user AS c ON a.OwnerCode = c.UserCode
			LEFT JOIN covi_smart4j.task_folder AS d ON d.FolderID = a.FolderID
			LEFT JOIN covi_smart4j.task_folder_share_member AS e ON e.FolderID = d.FolderID
			<trim prefix="WHERE" prefixOverrides="AND|OR">
			    AND a.DeleteDate IS NULL
				AND (a.IsTempSave IS NULL OR a.IsTempSave != 'Y')
		        AND ((a.OwnerCode = #{userID}) OR (e.MemberCode IN 
		        <foreach collection="subjectArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
				 AND d.OwnerCode != #{userID}))
				<if test="searchWord != null and searchWord != '' and searchWord.length() gt 0">
					AND A.Subject LIKE CONCAT('%',#{searchWord},'%')
				</if>
	       </trim>
		) AS A
	    <trim prefix="ORDER BY"  prefixOverrides =",">
			<choose>
			    <when test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
			        <choose>
						<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
						<when test='sortColumn.equalsIgnoreCase("TaskState")'>TaskState</when>
						<when test='sortColumn.equalsIgnoreCase("RegistDate")'>RegistDate</when>
						<otherwise></otherwise>
					</choose>
					<choose>
						<when test='sortDirection.equalsIgnoreCase("DESC")'> DESC,</when>
						<otherwise> ASC,</otherwise>
					</choose>
			    </when>	  
		    </choose>
		    RegistDate DESC
		</trim>
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
   	</select>
   	
   	<select id="selectTaskSearchListCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) FROM (
			SELECT DISTINCT a.TaskID
					, a.FolderID
					, a.Subject
					, a.State AS TaskState
					, a.State AS TaskStateCode
					, a.Progress AS TaskProgress
					, IF(
						(a.State = 'Waiting' AND (a.StartDate <![CDATA[ < ]]> #{localCurrentDate} OR a.EndDate <![CDATA[ < ]]> #{localCurrentDate}))
						OR
						(a.State = 'Process' AND a.EndDate <![CDATA[ < ]]> #{localCurrentDate})
					 	, 'Y', 'N'
					 ) AS IsDelay
					, b.IsRead
					, DATE_FORMAT(a.RegistDate, '%Y.%m.%d %H:%i:%s') AS RegistDate
					, a.RegisterCode
					, a.OwnerCode
					, Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) AS OwnerName
			FROM covi_smart4j.task AS a
			LEFT JOIN (
				SELECT	  TaskID
						, IF(MAX(ReadDate) IS NULL, 'N', 'Y') AS IsRead
				FROM covi_smart4j.task_read
				WHERE UserID = #{userID}
				GROUP BY TaskID
			) b ON a.TaskID = b.TaskID
			LEFT JOIN covi_smart4j.sys_object_user AS c ON a.OwnerCode = c.UserCode
			LEFT JOIN covi_smart4j.task_folder AS d ON d.FolderID = a.FolderID
			LEFT JOIN covi_smart4j.task_folder_share_member AS e ON e.FolderID = d.FolderID
			<trim prefix="WHERE" prefixOverrides="AND|OR">
			    AND a.DeleteDate IS NULL
				AND (a.IsTempSave IS NULL OR a.IsTempSave != 'Y')
		        AND ((a.OwnerCode = #{userID}) OR (e.MemberCode IN 
		        <foreach collection="subjectArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			 AND d.OwnerCode != #{userID}))
				<if test="searchWord != null and searchWord != '' and searchWord.length() gt 0">
					AND A.Subject LIKE CONCAT('%',#{searchWord},'%')
				</if>
	       </trim>
		) AS A
   	</select>
</mapper>
