<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="user.survey">
	<insert id="insertSurvey" parameterType="cmap" useGeneratedKeys="true" keyProperty="SurveyID">	
		INSERT INTO covi_smart4j.survey (CompanyCode, Subject, SubjectHtml,
		  							Description, IsDescriptionUseEditor, 
		  							SurveyStartDate,
		  							SurveyEndDate, ResultViewStartDate, ResultViewEndDate, QuestionCount,
		  							TargetRespondentType, TargetResultViewType, SurveyType, State,
		  							IsImportance, IsAnonymouse, IsGrouping, IsSendTodo, 
		  							IsSendMail, RegisterCode, RegisterDeptCode, RegistDate,
		  							ModifyDate, ReviewerCode, ReviewerDeptCode, ApproverCode, 
		  							ApproverDeptCode, CommunityID )
	    VALUES (#{companyCode}, #{subject}, #{subjectHtml},
	    		#{description}, #{isDescriptionUseEditor}, 
	    		#{surveyStartDate}, 
	    		CONCAT(#{surveyEndDate}, ' 23:59:59'), #{resultViewStartDate}, CONCAT(#{resultViewEndDate}, ' 23:59:59'), #{questionCount},
	    		#{targetRespondentType}, #{targetResultViewType}, #{surveyType}, #{state},
	    		#{isImportance}, #{isAnonymouse}, #{isGrouping}, #{isSendTodo},
	    		#{isSendMail}, #{registerCode}, #{registerDeptCode}, #{localCurrentDate},
	    		#{localCurrentDate}, #{reviewerCode}, #{reviewerDeptCode}, #{approverCode},
	    		#{approverDeptCode}, #{communityID} )
	</insert>
	
	<insert id="insertSurveyQuestion" parameterType="cmap" useGeneratedKeys="true" keyProperty="QuestionID">	
		INSERT  INTO covi_smart4j.survey_question (SurveyID, QuestionType, QuestionNO, GroupingNo,
				  							 GroupName, Paragraph, Question, Description,
				  							 IsRequired, RequiredInfo, IsEtc, ItemCount, NextGroupingNo,
				  							 NextDefaultQuestionNO    )
	    VALUES (#{surveyID}, #{questionType}, #{questionNO}, #{groupingNo},
	    		#{groupName}, #{paragraph}, #{question}, #{description},
	    		#{isRequired}, #{requiredInfo}, #{isEtc}, #{itemCount}, #{nextGroupingNo},
	    		#{nextDefaultQuestionNO} )
	</insert>
	
	<insert id="insertSurveyQuestionItem" parameterType="cmap" useGeneratedKeys="true" keyProperty="ItemID">	
		INSERT 
		  INTO covi_smart4j.survey_question_item (SurveyID, QuestionID, ItemNO, Item,
			  									  NextQuestionNO
			  						   			 )
	    VALUES (#{surveyID}, #{questionID}, #{itemNO}, #{item},
	    		#{nextQuestionNO}
	    	   )
	</insert>
	
	<select id="selectSurveyQuestionItemList" parameterType="cmap" resultType="cmap">
		SELECT A.*, 
			   (CASE WHEN IsGrouping = 'Y' THEN (CASE WHEN groupOptions IS NULL THEN '99' 
												   	  ELSE CONCAT(groupOptions, ',', '99') 
												   	   END
												)
				 	  END) AS GroupDivOptions,
			   (CASE WHEN IsGrouping = 'N' THEN (CASE WHEN itemOptions IS NULL THEN '99' 
											   		  ELSE CONCAT(itemOptions, ',', '99') 
											   		   END)
				 	  END) AS ItemDivOptions,
			   GroupMoveOptions,				 	  
			   (CASE WHEN QuestionType = 'S' THEN '객관식'
			   		 WHEN QuestionType = 'D' THEN '주관식'
			   		 WHEN QuestionType = 'M' THEN '복수응답'
			   		 WHEN QuestionType = 'N' THEN '순위선택'
			     	  END
			   ) AS questionTypeNm,
			   (SELECT GROUP_CONCAT(FileID SEPARATOR ';') 
			   	  FROM covi_smart4j.sys_file D 
			   	 WHERE D.ServiceType = 'Survey'
			   	   AND A.FileID LIKE CONCAT('%;', D.FileID, ';%')) AS updateFileIds,
	   	   	    (SELECT CONCAT(D.UserCode, ';', D.DisplayName)
				   FROM covi_smart4j.sys_object_user D
				  WHERE A.ReviewerCode = D.UserCode) AS reviewerCodeText,
			    (SELECT CONCAT(D.UserCode, ';', D.DisplayName)
				   FROM covi_smart4j.sys_object_user D
				  WHERE A.ApproverCode = D.UserCode) AS approverCodeText,
				(SELECT D.DisplayName
				   FROM covi_smart4j.sys_object_user D
				  WHERE A.ReviewerCode = D.UserCode) AS reviewerName,
			    (SELECT D.DisplayName
				   FROM covi_smart4j.sys_object_user D
				  WHERE A.ApproverCode = D.UserCode) AS approverName,
				(SELECT D.DisplayName
				   FROM covi_smart4j.sys_object_user D
				  WHERE A.RegisterCode = D.UserCode) AS registerName
		  FROM (SELECT A.ItemID, B.QuestionID,
		  			   A.ItemNO, A.Item, A.NextQuestionNO, A.FileID,
					   B.QuestionType, B.QuestionNO, B.GroupingNo, B.GroupName,
					   B.Paragraph, B.Question, B.Description, B.IsRequired, B.RequiredInfo, B.IsEtc, 
					   B.NextGroupingNo, B.NextDefaultQuestionNO, 
					   C.SurveyID, C.CompanyCode, C.Subject, C.SubjectHtml, 
					   C.Description AS SDescription,
					   C.IsDescriptionUseEditor, 
					   DATE_FORMAT(C.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate,
					   DATE_FORMAT(C.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate,
					   DATE_FORMAT(C.ResultViewStartDate,'%Y.%m.%d') AS ResultViewStartDate,
					   DATE_FORMAT(C.ResultViewEndDate,'%Y.%m.%d') AS ResultViewEndDate, 
					   C.TargetRespondentType, C.TargetResultViewType, C.SurveyType, C.State, 
					   C.IsImportance, C.IsAnonymouse, C.IsGrouping, C.IsSendTodo, C.IsSendMail, 
					   C.RegisterCode, C.ReviewerCode, C.ApproverCode,
					   (CASE WHEN C.IsGrouping = 'Y' THEN (SELECT GROUP_CONCAT(DISTINCT(D.GroupingNo) ORDER BY D.GroupingNo SEPARATOR ',') 
													   		 FROM covi_smart4j.survey_question D
														  	WHERE B.SurveyID = D.SurveyID
														      AND B.GroupingNo <![CDATA[<]]> D.GroupingNo
														  )
							 ELSE NULL
							  END) AS groupOptions,
					   (CASE WHEN C.IsGrouping = 'N' THEN (SELECT GROUP_CONCAT(D.QuestionNO ORDER BY D.QuestionNO SEPARATOR ',') 
														     FROM covi_smart4j.survey_question D
														    WHERE A.SurveyID = D.SurveyID
														      AND B.QuestionNO <![CDATA[<]]> D.QuestionNO
								  )
							 ELSE NULL
							  END) AS itemOptions,
					   (CASE WHEN C.IsGrouping = 'Y' THEN (SELECT GROUP_CONCAT(DISTINCT(D.GroupingNo) ORDER BY D.GroupingNo SEPARATOR ',') 
													   		 FROM covi_smart4j.survey_question D
														  	WHERE B.SurveyID = D.SurveyID
														      AND B.GroupingNo != D.GroupingNo
														  )
							 ELSE NULL
							  END) AS GroupMoveOptions
				  FROM covi_smart4j.survey_question_item A
				  LEFT JOIN covi_smart4j.survey_question B
				    ON A.SurveyID = B.SurveyID
				   AND A.QuestionID = B.QuestionID
				  LEFT JOIN covi_smart4j.survey C
				    ON A.SurveyID = C.SurveyID
				   AND B.SurveyID = C.SurveyID
				 WHERE C.SurveyID = #{surveyID}
		 	   ) A			 	  
	</select>
	<select id="selectSurveyQuestionRespondentTarget" parameterType="cmap" resultType="cmap">
		 SELECT TargetType "type",TargetCode "code", CASE WHEN TargetType = 'UR' THEN B.DisplayName ELSE C.DisplayName END "label" 
		 FROM   COVI_SMART4J.SURVEY_TARGET_RESPONDENT A  
	     LEFT JOIN COVI_SMART4J.SYS_OBJECT_USER B 
		    ON A.TargetCode = B.UserCode
	     LEFT JOIN COVI_SMART4J.SYS_OBJECT_GROUP C 
		    ON A.TargetCode = C.GroupCode
		 WHERE A.SurveyID = #{surveyID}
	</select>
	<select id="selectSurveyQuestionResultviewTarget" parameterType="cmap" resultType="cmap">
		 SELECT TargetType "type",TargetCode "code", CASE WHEN TargetType = 'UR' THEN B.DisplayName ELSE C.DisplayName END "label" 
		 FROM   COVI_SMART4J.survey_target_resultview A  
	     LEFT JOIN COVI_SMART4J.SYS_OBJECT_USER B  
		    ON A.TargetCode = B.UserCode
	     LEFT JOIN COVI_SMART4J.SYS_OBJECT_GROUP C 
		    ON A.TargetCode = C.GroupCode
		 WHERE A.SurveyID = #{surveyID}
	</select>
		
	<delete id="deleteQuestionItem" parameterType="cmap">
		DELETE 
		  FROM covi_smart4j.survey_question_item 
		 WHERE SurveyID = #{surveyID};
		DELETE 
		  FROM covi_smart4j.survey_question 
		 WHERE SurveyID = #{surveyID}
	</delete>
	
	<delete id="deleteSurveyTarget" parameterType="cmap">
		DELETE FROM covi_smart4j.survey_target_respondent
		WHERE SurveyID = #{surveyID};
		
		DELETE FROM covi_smart4j.survey_target_resultview
		WHERE SurveyID = #{surveyID};
	</delete>
		
	<update id="updateSurvey" parameterType="cmap">
		UPDATE covi_smart4j.survey
		   SET CompanyCode = #{companyCode},
		   	   Subject = #{subject},
		   	   SubjectHtml = #{subjectHtml},
		   	   Description = #{description},
		   	   IsDescriptionUseEditor = #{isDescriptionUseEditor},
		   	   SurveyStartDate = #{surveyStartDate},
		   	   SurveyEndDate =  CONCAT(#{surveyEndDate}, ' 23:59:59'),
		   	   ResultViewStartDate = #{resultViewStartDate},
		   	   ResultViewEndDate = CONCAT(#{resultViewEndDate}, ' 23:59:59'),
		   	   QuestionCount = #{questionCount},
		   	   TargetRespondentType = #{targetRespondentType},
		   	   TargetResultViewType = #{targetResultViewType},
		   	   SurveyType = #{surveyType},
		   	   IsImportance = #{isImportance},
		   	   IsAnonymouse = #{isAnonymouse},
		   	   IsGrouping = #{isGrouping},
		   	   IsSendTodo = #{isSendTodo},
		   	   IsSendMail = #{isSendMail},
		   	   RegisterCode = #{registerCode},
		   	   ModifyDate = #{localCurrentDate},
		   	   ReviewerCode = #{reviewerCode},
		   	   ApproverCode = #{approverCode},
		   	   State = #{state}
		 WHERE SurveyID = #{surveyID}
	</update>
	
	<insert id="insertQuestionItemAnswer" parameterType="cmap">	
		INSERT
		  INTO covi_smart4j.survey_question_item_answer (SurveyID, QuestionID, ItemID,
														 AnswerItem, EtcOpinion, RespondentCode, RespondentDeptCode,
														 Weighting
				  						    			)
	    VALUES (#{surveyID}, #{questionID}, #{itemID},
	    		#{answerItem}, #{etcOpinion}, #{respondentCode}, #{respondentDeptCode},
	    		#{weighting}
	    	   )
	</insert>
	
	<insert id="insertSurveyEtcOpinion" parameterType="cmap">	
		INSERT 
		  INTO covi_smart4j.survey_respondent (SurveyID, EtcOpinion, RespondentCode, RespondentDeptCode, 
		  									   RegistDate
				  						      )
	    VALUES (#{surveyID}, #{etcOpinion}, #{respondentCode}, #{respondentDeptCode},
	      		#{localCurrentDate}
	    	   )
	</insert>
	
	<delete id="deleteQuestionItemAnswer" parameterType="cmap">	
		DELETE FROM covi_smart4j.survey_question_item_answer
		WHERE SurveyID = #{surveyID}
		AND RespondentCode = #{respondentCode}
	</delete>
	
	<delete id="deleteSurveyEtcOpinion" parameterType="cmap">	
		DELETE FROM covi_smart4j.survey_respondent
		WHERE SurveyID = #{surveyID}
		AND RespondentCode = #{respondentCode}
	</delete>
		
	<select id="selectQuestionItemAnswerList" parameterType="cmap" resultType="cmap">
		SELECT  B.SurveyID, B.QuestionID , B.AnswerItemId, B.AnswerItem, B.EtcOpinion, A.RespondentCode 
		FROM survey_respondent AS A
		LEFT JOIN ( SELECT SurveyID, QuestionID, EtcOpinion, RespondentCode,
			   			GROUP_CONCAT(ItemID ORDER BY Weighting SEPARATOR ';') AS AnswerItemId,
						GROUP_CONCAT(AnswerItem ORDER BY Weighting SEPARATOR ';') AS AnswerItem
			 			FROM covi_smart4j.survey_question_item_answer
		  				WHERE SurveyID = #{surveyID}
		 				GROUP BY SurveyID, QuestionID, RespondentCode )  AS B  ON A.SurveyID = B.SurveyID AND A.RespondentCode = B.RespondentCode
		 WHERE A.SurveyID =#{surveyID}
		 <if test="viewType!=null and viewType.equalsIgnoreCase('myAnswer')">
			  AND A.RespondentCode =#{userID}
		</if>
	</select>
	
	<!-- 나의 설문 - 내가 작성한 설문 목록 조회 -->
	<select id="selectMySurveyList" parameterType="cmap" resultType="cmap">
	    SELECT * 
	   FROM (SELECT a.SurveyID
							, a.Subject
							, a.SubjectHtml
							, a.IsImportance
							, a.State
							, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
							, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							, a.RegisterCode
							, b.MultiDisplayName AS RegisterName
							, b.MailAddress AS MailAddress
							, Fn_SurveyTargetRespondent_R(a.SurveyID,#{userId}) AS IsTargetRespondent
							, (SELECT IF(COUNT(*) > 0, 'Y', 'N') FROM survey_respondent AS d WHERE d.SurveyID = a.SurveyID AND d.RespondentCode =#{userId}) AS joinFg
							, a.Description
							, a.CommunityID
							, a.RegistDate
							, a.ModifyDate
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					WHERE a.DeleteDate IS NULL
				<if test='schState != null and schState != ""'>
					AND a.State = #{schState}
				</if>
					AND a.State != 'A'
					AND a.RegisterCode = #{userId}
					) AS my
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND my.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND my.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND my.Subject LIKE CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND my.Subject LIKE CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, my.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND my.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	my.Subject LIKE CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, my.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR my.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (   (   my.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( my.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
		</trim>
		<trim prefix='ORDER BY'>
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				ModifyDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("SurveyStartDate")'>SurveyStartDate</when>
					<otherwise>State</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test='pageSize != null and pageOffset != null'>
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>	 
	</select>
	
	<!-- 나의 설문 - 내가 작성한 설문 목록 개수 -->
	<select id="selectMySurveyListCnt" parameterType="cmap" resultType="java.lang.Long">
	   SELECT COUNT(*)
	   FROM (SELECT a.SurveyID
							, a.Subject
							, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
							, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							, b.MultiDisplayName AS RegisterName
							, a.Description
							, a.CommunityID
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					WHERE a.DeleteDate IS NULL
				<if test='schState != null and schState != ""'>
					AND a.State = #{schState}
				</if>
					AND a.State != 'A'
					AND a.RegisterCode = #{userId}
					) AS my
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND my.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND my.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND my.Subject LIKE CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND my.Subject LIKE CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, my.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND my.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	my.Subject LIKE CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, my.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR my.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (   (   my.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( my.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
		</trim>
	</select>
	
	<!-- 나의 설문 - 내가 참여한 설문 목록 조회 -->
	<select id="selectJoinSurveyList" parameterType="cmap" resultType="cmap">
	   		SELECT * FROM (
					SELECT a.SurveyID
							, a.Subject
							, a.SubjectHtml
							, a.IsImportance
							, a.State
							, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
							, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							, Fn_SurveyTargetResultView_R(a.SurveyID, #{userId}) AS IsTargetResultView
							, a.RegisterCode
							, c.MultiDisplayName AS RegisterName
							, c.MailAddress AS MailAddress
							, a.Description
							, a.CommunityID
							, a.RegistDate
					FROM survey AS a
					INNER JOIN survey_respondent AS b ON a.SurveyID = b.SurveyID AND b.respondentCode = #{userId}
					LEFT JOIN sys_object_user AS c ON a.RegisterCode = c.UserCode
					WHERE a.DeleteDate IS NULL
			) AS parti
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND parti.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND parti.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND parti.Subject LIKE CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND parti.Subject LIKE CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, parti.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND parti.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	parti.Subject LIKE CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, parti.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR parti.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (   (   parti.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( parti.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
		</trim>
		<trim prefix='ORDER BY'>
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("SurveyStartDate")'>SurveyStartDate</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<otherwise>State</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test='pageSize != null and pageOffset != null'>
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>	 
		
	</select>
	<!-- 나의 설문 - 내가 참여한 설문 목록 조회 -->
	<select id="selectJoinSurveyListCnt" parameterType="cmap" resultType="java.lang.Long">
	   		SELECT COUNT(*) FROM (
					SELECT a.SurveyID
							, a.Subject
							, a.State
							, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
							, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							, c.MultiDisplayName AS RegisterName
							, a.Description
							, a.CommunityID
							, a.RegistDate
					FROM survey AS a
					INNER JOIN survey_respondent AS b ON a.SurveyID = b.SurveyID AND b.respondentCode = #{userId}
					LEFT JOIN sys_object_user AS c ON a.RegisterCode = c.UserCode
					WHERE a.DeleteDate IS NULL
			) AS parti
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND parti.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND parti.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND parti.Subject LIKE CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND parti.Subject LIKE CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, parti.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND parti.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	parti.Subject LIKE CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, parti.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR parti.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (   (   parti.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( parti.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
		</trim>
	</select>
	
	<!-- 진행중인 설문 목록  -->
	<select id="selectProceedSurveyList" parameterType="cmap" resultType="cmap">
	   SELECT * 
	   FROM (SELECT a.SurveyID
							, a.Subject
							, a.SubjectHtml
							, a.IsImportance
							, a.SurveyStartDate AS D_SurveyStartDate
							, a.SurveyEndDate AS D_SurveyEndDate
							, a.ResultViewStartDate AS D_ResultViewStartDate
							, a.ResultViewEndDate AS D_ResultViewEndDate
							, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
							, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							, a.RegisterCode
							, b.MultiDisplayName AS RegisterName
							, b.MailAddress AS MailAddress
							, IF(C.ReadID IS NULL, 'N', 'Y') AS readFg
							, Fn_SurveyTargetRespondent_R(a.SurveyID, #{userId}) AS IsTargetRespondent
							, Fn_SurveyTargetResultView_R(a.SurveyID, #{userId}) AS IsTargetResultView
							, (SELECT IF(COUNT(*) > 0, 'Y', 'N') FROM survey_respondent AS d WHERE d.SurveyID = a.SurveyID AND d.RespondentCode = #{userId}) AS joinFg
							, Fn_SurveyRate_R(a.SurveyID) AS joinRate
							, a.CommunityID
							, a.Description
							, a.RegistDate
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					LEFT JOIN survey_target_read AS C ON a.SurveyID = c.SurveyID AND c.TargetCode = #{userId}
					WHERE a.State = 'F'
					AND a.DeleteDate IS NULL
					) AS Proc
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
		   	( 
		  		<![CDATA[
		  		( Proc.IsTargetRespondent = 'Y' AND  D_SurveyStartDate <= #{localCurrentDate} AND D_SurveyEndDate >= #{localCurrentDate}   ) -- 설문 기간이면서 설문 대상
				OR ( Proc.IsTargetResultView = 'Y' AND D_ResultViewStartDate <= #{localCurrentDate} AND D_ResultViewEndDate>= #{localCurrentDate} )  --  조회 기간이면서 결과 공개 대상
		  		]]>
			)		
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND Proc.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND Proc.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND Proc.Subject LIKE	CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND Proc.Subject LIKE	CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, Proc.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND Proc.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	Proc.Subject LIKE	CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, Proc.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR Proc.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (   (   Proc.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( Proc.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
			<if test='notReadFg != null and notReadFg !="" and notReadFg =="Y"'>
				AND Proc.readFg = 'N'
			</if>
		</trim>
		<trim prefix='ORDER BY'>
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				IsImportance DESC , RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("SurveyStartDate")'>SurveyStartDate</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<otherwise>joinRate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test='pageSize != null and pageOffset != null'>
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>	 
	</select>
	
	<!-- 진행중인 설문 목록 개수  -->
	<select id="selectProceedSurveyListCnt" parameterType="cmap" resultType="java.lang.Long">
	   SELECT COUNT(*) 
	   FROM (SELECT  a.Subject
	   						, a.SurveyStartDate AS D_SurveyStartDate
							, a.SurveyEndDate AS D_SurveyEndDate
							, a.ResultViewStartDate AS D_ResultViewStartDate
							, a.ResultViewEndDate AS D_ResultViewEndDate
							<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
								, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
								, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							</if>
							, a.RegisterCode
							, b.MultiDisplayName AS RegisterName
							, IF(c.ReadID IS NULL, 'N', 'Y') AS readFg
							, Fn_SurveyTargetRespondent_R(a.SurveyID, #{userId}) AS IsTargetRespondent
							, Fn_SurveyTargetResultView_R(a.SurveyID, #{userId}) AS IsTargetResultView
							, a.CommunityID
							, a.Description
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					LEFT JOIN survey_target_read AS c ON a.SurveyID = c.SurveyID AND c.TargetCode = #{userId}
					WHERE a.State = 'F'
					AND a.DeleteDate IS NULL
					) AS Proc
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			 	( 
		  		<![CDATA[
		  		( Proc.IsTargetRespondent = 'Y' AND D_SurveyStartDate <= #{localCurrentDate} AND D_SurveyEndDate >= #{localCurrentDate}  ) -- 설문 기간이면서 설문 대상
				OR ( Proc.IsTargetResultView = 'Y' AND D_ResultViewStartDate <= #{localCurrentDate} AND D_ResultViewEndDate>= #{localCurrentDate} )  --  조회 기간이면서 결과 공개 대상
		  		]]>
			)			
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND Proc.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND Proc.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND Proc.Subject LIKE	CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND Proc.Subject LIKE	CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, Proc.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND Proc.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	Proc.Subject LIKE	CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, Proc.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR Proc.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (   (   Proc.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( Proc.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
			<if test='notReadFg != null and notReadFg !="" and notReadFg =="Y"'>
				AND Proc.readFg = 'N'
			</if>
		</trim>
	</select>
	
	<!-- 완료된 설문 목록 -->
	<select id="selectCompleteSurveyList" parameterType="cmap" resultType="cmap">
   	   SELECT
	   	   Comp.SurveyID
		 , Comp.Subject
		 , Comp.SubjectHtml
		 , Comp.IsImportance
		 , Comp.D_ResultViewStartDate
		 , Comp.D_ResultViewEndDate
		 , Comp.SurveyStartDate
		 , Comp.SurveyEndDate
		 , Comp.RegisterCode
		 , Comp.RegisterName
		 , Comp.MailAddress
		 , Comp.readFg
		 , Comp.IsTargetResultView
		 , Fn_SurveyRate_R(Comp.SurveyID) AS joinRate
		 , Comp.CommunityID
		 , Comp.Description
		 , Comp.RegistDate
	   FROM (SELECT a.SurveyID
							, a.Subject
							, a.SubjectHtml
							, a.IsImportance
							, a.ResultViewStartDate AS D_ResultViewStartDate
							, a.ResultViewEndDate AS D_ResultViewEndDate
							, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
							, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							, a.RegisterCode
							, b.MultiDisplayName AS RegisterName
							, b.MailAddress AS MailAddress
							, IF(C.ReadID IS NULL, 'N', 'Y') AS readFg
							, Fn_SurveyTargetResultView_R(a.SurveyID, #{userId}) AS IsTargetResultView
							, a.CommunityID
							, a.Description
							, a.RegistDate
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					LEFT JOIN survey_target_read AS C ON a.SurveyID = c.SurveyID AND c.TargetCode = #{userId}
					WHERE a.State = 'G' -- 상태가 완료
					AND a.DeleteDate IS NULL
					) AS Comp
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			 AND Comp.IsTargetResultView = 'Y'  -- 결과 공개 대상자 
			 <![CDATA[
			 AND D_ResultViewStartDate <= #{localCurrentDate} AND D_ResultViewEndDate >= #{localCurrentDate}   -- 조회 기간
			 ]]>
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND Comp.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND Comp.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND Comp.Subject LIKE CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND Comp.Subject LIKE CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, Comp.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND Comp.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	Comp.Subject LIKE CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, Comp.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR Comp.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (   (   Comp.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( Comp.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
			<if test='notReadFg != null and notReadFg !="" and notReadFg =="Y"'>
				AND Comp.readFg = 'N'
			</if>
		</trim>
		<trim prefix='ORDER BY'>
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("SurveyStartDate")'>SurveyStartDate</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<otherwise>joinRate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test='pageSize != null and pageOffset != null'>
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>	 
	</select>
	
	<!-- 완료된 설문 목록 개수 -->
	<select id="selectCompleteSurveyListCnt" parameterType="cmap" resultType="java.lang.Long">
   	   SELECT COUNT(*)
	   FROM (SELECT  a.Subject
							, a.ResultViewStartDate AS D_ResultViewStartDate
							, a.ResultViewEndDate AS D_ResultViewEndDate
							, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
							, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							, a.RegisterCode
							, b.MultiDisplayName AS RegisterName
							, IF(C.ReadID IS NULL, 'N', 'Y') AS readFg
							, Fn_SurveyTargetResultView_R(a.SurveyID, #{userId}) AS IsTargetResultView
							, a.CommunityID
							, a.Description
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					LEFT JOIN survey_target_read AS C ON a.SurveyID = c.SurveyID AND c.TargetCode = #{userId}
					WHERE a.State = 'G'
					AND a.DeleteDate IS NULL
					) AS Comp
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
		 	 AND Comp.IsTargetResultView = 'Y'  -- 결과 공개 대상자 
			 <![CDATA[
			 AND D_ResultViewStartDate <= #{localCurrentDate} AND D_ResultViewEndDate >= #{localCurrentDate}   -- 조회 기간
			 ]]>
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND Comp.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND Comp.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND Comp.Subject LIKE CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND Comp.Subject LIKE CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, Comp.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND Comp.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	Comp.Subject LIKE CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, Comp.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR Comp.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (    (  Comp.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( Comp.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
			<if test='notReadFg != null and notReadFg !="" and notReadFg =="Y"'>
				AND Comp.readFg = 'N'
			</if>
		</trim>
	</select>
	
	
	<!-- 임시저장 설문 목록 -->
	<select id="selectTempSaveSurveyList" parameterType="cmap" resultType="cmap">
   	   SELECT * 
	   FROM (SELECT a.SurveyID
							, a.Subject
							, a.CommunityID
							, a.Description
							, Fn_BaseGetDictionary_S(#{lang}, b.MultiDisplayName) AS RegisterName
							, DATE_FORMAT(a.RegistDate,'%Y-%m-%d %H:%i:%s') AS RegistDate
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					WHERE a.State = 'A'
					AND a.DeleteDate IS NULL
					AND a.RegisterCode  = #{userId}
					) AS TempSave
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND TempSave.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND TempSave.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND TempSave.Subject LIKE CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND TempSave.Subject LIKE CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "description"'>
						AND TempSave.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	TempSave.Subject LIKE CONCAT('%',#{schTxt},'%')
					    	OR TempSave.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<!-- 임시저장의 등록 기간으로 체크  -->
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND TempSave.RegistDate BETWEEN #{startDate} AND #{endDate} 
			</if>
		</trim>
		<trim prefix='ORDER BY'>
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<otherwise>RegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test='pageSize != null and pageOffset != null'>
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>	 
	</select>
	
	<!-- 임시저장 설문 목록 개수 -->
	<select id="selectTempSaveSurveyListCnt" parameterType="cmap" resultType="java.lang.Long">
   	    SELECT COUNT(*)
	   FROM (SELECT a.SurveyID
							, a.Subject
							, a.CommunityID
							, a.Description
							, Fn_BaseGetDictionary_S(#{lang}, b.MultiDisplayName) AS RegisterName
							, DATE_FORMAT(a.RegistDate,'%Y-%m-%d %H:%i:%s') AS RegistDate
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					WHERE a.State = 'A'
					AND a.DeleteDate IS NULL
					AND a.RegisterCode = #{userId}
					) AS TempSave
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND TempSave.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND TempSave.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND TempSave.Subject LIKE CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND TempSave.Subject LIKE CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "description"'>
						AND TempSave.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	TempSave.Subject LIKE CONCAT('%',#{schTxt},'%')
					    	OR TempSave.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<!-- 임시저장의 등록 기간으로 체크  -->
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND TempSave.RegistDate BETWEEN #{startDate} AND #{endDate} 
			</if>
		</trim>
	</select>
	
	<!-- 승인 및 검토요청 -->
	<select id="selectReqApprovalSurveyList" parameterType="cmap" resultType="cmap">
	   SELECT * 
	   FROM (SELECT a.SurveyID
							, a.Subject
							, a.SubjectHtml
							, a.IsImportance
							, a.State
							, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
							, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							, a.RegisterCode
							, b.MultiDisplayName AS RegisterName
							, b.MailAddress AS MailAddress
							, a.Description
							, a.RegistDate
							, a.CommunityID
							, IFNULL(a.ReviewerCode,'') AS ReviewerCode
							, IFNULL(a.ApproverCode,'') AS ApproverCode
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					WHERE a.DeleteDate IS NULL
					AND ((a.State = 'B' AND a.ReviewerCode =  #{userId}) -- 검토 대기 상태인데 내가 검토자인 것
						OR (a.State = 'C' AND a.ApproverCode =  #{userId} ) )-- 승인 대기 상태인데 내가 승인자인 것
					) AS ReqApproval
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND ReqApproval.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND ReqApproval.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND ReqApproval.Subject LIKE	CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND ReqApproval.Subject LIKE	CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, ReqApproval.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND ReqApproval.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	ReqApproval.Subject LIKE	CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, ReqApproval.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR ReqApproval.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (   (   ReqApproval.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( ReqApproval.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
		</trim>
		<trim prefix='ORDER BY'>
			<if test="sortColumn == '' or sortColumn == null or sortDirection == '' or sortDirection == null">
				RegistDate DESC
			</if>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("SurveyStartDate")'>SurveyStartDate</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<otherwise>State</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test='pageSize != null and pageOffset != null'>
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>	 
	</select>
	
	<!-- 승인 및 검토요청 목록 개수 -->
	<select id="selectReqApprovalSurveyListCnt" parameterType="cmap" resultType="java.lang.Long">
	   SELECT COUNT(*)
	   FROM (SELECT a.Subject
							, a.State
							, DATE_FORMAT(a.SurveyStartDate,'%Y.%m.%d') AS SurveyStartDate
							, DATE_FORMAT(a.SurveyEndDate,'%Y.%m.%d') AS SurveyEndDate
							, a.RegisterCode
							, b.MultiDisplayName AS RegisterName
							, a.Description
							, a.RegistDate
							, a.CommunityID
					FROM survey AS a
					LEFT JOIN sys_object_user AS b ON a.RegisterCode = b.UserCode
					WHERE a.DeleteDate IS NULL
					AND ((a.State = 'B' AND a.ReviewerCode =  #{userId}) -- 검토 대기 상태인데 내가 검토자인 것
						OR (a.State = 'C' AND a.ApproverCode =  #{userId} ) )-- 승인 대기 상태인데 내가 승인자인 것
					) AS ReqApproval
		<trim prefix="WHERE"  prefixOverrides="AND|OR">
			<if test='communityId != null and communityId != ""'>
				<choose>
					<when test='communityId gt 0'>
						AND ReqApproval.CommunityID = #{communityId}
					</when>
					<otherwise>
						AND ReqApproval.CommunityID = 0
					</otherwise>
				</choose>
			</if>
			<if test='simpleSchTxt != null and simpleSchTxt !=""'>
					AND ReqApproval.Subject LIKE CONCAT('%',#{simpleSchTxt},'%')
			</if>
			<if test='schTxt != null and schTxt !=""'>
				<choose>
					<when test='schContentType == "subject"'>
						AND ReqApproval.Subject LIKE CONCAT('%',#{schTxt},'%')
					</when>
					<when test='schContentType == "register"'>
					    AND Fn_BaseGetDictionary_S(#{lang}, ReqApproval.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					</when>
					<when test='schContentType == "description"'>
						AND ReqApproval.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
					</when>
					<when test='isMobile != null and isMobile == "Y"'>
					    AND (
					    	ReqApproval.Subject LIKE	CONCAT('%',#{schTxt},'%')
					    	OR Fn_BaseGetDictionary_S(#{lang}, ReqApproval.RegisterName) LIKE CONCAT('%', #{schTxt}, '%')
					    	OR ReqApproval.Description LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
			    		)
					</when>
				</choose>
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != '' ">
				AND (   (   ReqApproval.SurveyStartDate BETWEEN #{startDate} AND #{endDate} ) 
				OR ( ReqApproval.SurveyEndDate BETWEEN#{startDate} AND #{endDate} )      )
			</if>
		</trim>
	</select>
	
	<delete id="deleteSurvey" parameterType="cmap">
		DELETE 
		  FROM covi_smart4j.survey_target_respondent
		 WHERE SurveyID IN
	           <foreach collection="surveyIdArr" item="surveyId" open="(" close=")" separator=",">
	           	#{surveyId}
	           </foreach>;
		DELETE 
		  FROM covi_smart4j.survey_target_resultview
		 WHERE SurveyID IN
	           <foreach collection="surveyIdArr" item="surveyId" open="(" close=")" separator=",">
	           	#{surveyId}
	           </foreach>;	           
		DELETE
		  FROM covi_smart4j.survey_question_item
		 WHERE SurveyID IN
	           <foreach collection="surveyIdArr" item="surveyId" open="(" close=")" separator=",">
	           	#{surveyId}
	           </foreach>;
		DELETE
		  FROM covi_smart4j.survey_question
		 WHERE SurveyID IN
	           <foreach collection="surveyIdArr" item="surveyId" open="(" close=")" separator=",">
	           	#{surveyId}
	           </foreach>;
		DELETE
		  FROM covi_smart4j.survey
		 WHERE SurveyID IN
	           <foreach collection="surveyIdArr" item="surveyId" open="(" close=")" separator=",">
	           	#{surveyId}
	           </foreach>;	 
	</delete>
	
	<update id="updateSurveyState" parameterType="cmap">
	    <foreach collection="surveyIdArr" item="surveyId">
			UPDATE covi_smart4j.survey AS a
			 SET a.ModifyDate = #{localCurrentDate}
			 <if test='state != "del"'>
			 	<choose>
			 	    <when test='state == "C"'>
			 	       , a.State =(
			        			SELECT * FROM (
							  			SELECT IF(b.ApproverCode IS NULL OR b.ApproverCode = '', 'F', 'C') FROM covi_smart4j.survey AS b WHERE b.SurveyID = #{surveyId}
					 			 ) AS temp
						)
						, a.ReviewerDate = #{localCurrentDate}
			 	    </when>
			 	    <when test='state == "D"'>
			 	        , a.State = #{state}
			 	        , a.ReviewerDate = #{localCurrentDate}
			 	    </when>
			 	    <when test='state == "F" or state == "X"'>
				 	    , a.State = #{state}
						, a.ApproverDate = #{localCurrentDate}
			 	    </when>
			 	    <otherwise>				<!-- 설문조기마감 -->
			 	        , a.State = #{state}
			 	    </otherwise>
			 	</choose>
	    	 </if>
			 <if test='state == "del"'>		<!-- 삭제 처리시에만, DeleteDate 업데이트  -->
			 	, a.DeleteDate = #{localCurrentDate}
			 </if>
			WHERE a.SurveyID = #{surveyId};
		</foreach>
	</update>
	
	<select id="selectAnswerForChart" parameterType="cmap" resultType="cmap">
		SELECT A.QuestionID, Weighting, A.ItemID, A.AnswerItem, A.EtcOpinion, 
			   A.RespondentCode, B.QuestionType,
			   COUNT(*) AS CNT
		  FROM covi_smart4j.survey_question_item_answer A
		  LEFT JOIN covi_smart4j.survey_question B
		    ON A.QuestionID = B.QuestionID
		 WHERE A.SurveyID = #{surveyID}
		   AND B.QuestionType != 'N'
		 GROUP BY A.QuestionID, A.ItemID, A.AnswerItem
		 UNION ALL
		SELECT A.QuestionID, Weighting, A.ItemID, A.AnswerItem, A.EtcOpinion, 
			   A.RespondentCode, B.QuestionType,
			   COUNT(*) AS CNT
		  FROM covi_smart4j.survey_question_item_answer A
		  LEFT JOIN covi_smart4j.survey_question B
		    ON A.QuestionID = B.QuestionID
		 WHERE A.SurveyID = #{surveyID}
		   AND B.QuestionType = 'N'
	  GROUP BY A.QuestionID,Weighting, A.ItemID
	  ORDER BY QuestionID,Weighting, ItemID
	</select>
	
	<select id="selectTargetRespondentList" parameterType="cmap" resultType="cmap">
		 	SELECT  A.SurveyID , A.TargetCode, CONCAT("User-", A.RespondentID) AS RespondentID, B.PhotoPath
						, Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName ) AS DisplayName
						, Fn_BaseGetDictionary_S(#{lang}, C.MultiDeptName ) AS DeptName
						, D.EtcOpinion
						, DATE_FORMAT(D.RegistDate,'%Y.%m.%d %H:%i') AS RegistDate
						, E.RegisterCode
			FROM 
			 	(
			 		# Type: UR
				 	SELECT A.SurveyID , A.TargetCode , A.RespondentID
					FROM covi_smart4j.survey_target_respondent AS A
					WHERE A.SurveyID = #{surveyID} AND A.TargetType = 'UR'
					 
					UNION
					 
					# Type: GR
					SELECT A.SurveyID, B.UserCode , A.RespondentID
					FROM covi_smart4j.survey_target_respondent AS A 
					INNER JOIN ( 
						SELECT A.UserCode, B.GroupCode, C.GroupPath FROM sys_object_user_basegroup AS A
						LEFT JOIN (SELECT GroupCode, UserCode FROM sys_object_group_member WHERE IsUse='Y') AS B ON A.UserCode = B.UserCode
						LEFT JOIN (SELECT GroupPath, GroupCode FROM sys_object_group WHERE IsDisplay = 'Y' AND IsUse = 'Y') AS C ON B.GroupCode = C.GroupCode
					) AS B
					ON (A.TargetCode = B.GroupCode OR CONCAT(';',B.GroupPath) LIKE CONCAT('%;',A.TargetCode,';%') )	 AND A.TargetType = 'GR'				
					WHERE A.SurveyID = #{surveyID}
				) AS A
			 INNER JOIN covi_smart4j.sys_object_user AS B ON A.TargetCode = B.UserCode AND B.IsUse = 'Y' AND B.IsDisplay = 'Y'
			 INNER JOIN covi_smart4j.sys_object_user_basegroup AS C ON  A.TargetCode = C.UserCode AND C.JobType = 'Origin' 
			 INNER JOIN covi_smart4j.SURVEY AS E ON E.SurveyID = #{surveyID} 
			 LEFT JOIN covi_smart4j.survey_respondent AS D ON A.SurveyID = D.SurveyID  AND A.TargetCode = D.RespondentCode
			 
		<trim prefix='WHERE'  prefixOverrides="AND | OR">
			 <if test='targetType != null and targetType !="" and schTxt != null and schTxt !="" ' >
				<choose>
					<when test='targetType == "ur"'>
						AND Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName ) LIKE CONCAT('%', #{schTxt}, '%')
		            </when>
		            <otherwise>
		                AND Fn_BaseGetDictionary_S(#{lang}, C.MultiDeptName )  LIKE CONCAT('%', #{schTxt}, '%')
		            </otherwise>
				</choose>
			 </if>
			 <if test='targetJoin != null and targetJoin !=""'>
				<choose>
					<when test='targetJoin == "attendance"'>
						AND D.RegistDate IS NOT NULL		   
		            </when>
		            <otherwise>
		                AND D.RegistDate IS NULL
		            </otherwise>
				</choose>
			 </if>
		 </trim>
		<trim prefix='ORDER BY'>
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection != ''">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DeptName")'>DeptName</when>
					<when test='sortColumn.equalsIgnoreCase("RegistDate")'>RegistDate</when>
					<when test='sortColumn.equalsIgnoreCase("EtcOpinion")'>EtcOpinion</when>
					<otherwise>DisplayName</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test='pageSize != null and pageOffset != null'>
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>			  
	</select>
	
  	<select id="selectTargetRespondentListCnt" resultType="java.lang.Long">
			SELECT  COUNT(*)
			FROM 
			 	(
			 		# Type: UR
				 	SELECT A.SurveyID , A.TargetCode 
					FROM covi_smart4j.survey_target_respondent AS A
					WHERE A.SurveyID = #{surveyID} AND A.TargetType = 'UR'
					 
					UNION
					 
					# Type: GR
					SELECT A.SurveyID ,  B.UserCode
					FROM covi_smart4j.survey_target_respondent AS A 
					INNER JOIN ( 
						SELECT A.UserCode, B.GroupCode, C.GroupPath FROM sys_object_user_basegroup AS A
						LEFT JOIN (SELECT GroupCode, UserCode FROM sys_object_group_member WHERE IsUse='Y') AS B ON A.UserCode = B.UserCode
						LEFT JOIN (SELECT GroupPath, GroupCode FROM sys_object_group WHERE IsDisplay = 'Y' AND IsUse = 'Y') AS C ON B.GroupCode = C.GroupCode
					) AS B
					ON (A.TargetCode = B.GroupCode OR CONCAT(';',B.GroupPath) LIKE CONCAT('%;',A.TargetCode,';%') )	 AND A.TargetType = 'GR'				
					WHERE A.SurveyID = #{surveyID}
				) AS A
			 INNER JOIN covi_smart4j.sys_object_user AS B ON A.TargetCode = B.UserCode AND B.IsUse = 'Y' AND B.IsDisplay = 'Y'
			 INNER JOIN covi_smart4j.sys_object_user_basegroup AS C ON  A.TargetCode = C.UserCode AND C.JobType = 'Origin' 
			 INNER JOIN covi_smart4j.SURVEY AS E ON E.SurveyID = #{surveyID} 
			 LEFT JOIN covi_smart4j.survey_respondent AS D ON A.SurveyID = D.SurveyID  AND A.TargetCode = D.RespondentCode
			 
		<trim prefix='WHERE'  prefixOverrides="AND | OR">
			 <if test='targetType != null and targetType !="" and schTxt != null and schTxt !="" ' >
				<choose>
					<when test='targetType == "ur"'>
						AND Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName ) LIKE CONCAT('%', #{schTxt}, '%')
		            </when>
		            <otherwise>
		                AND Fn_BaseGetDictionary_S(#{lang}, C.MultiDeptName )  LIKE CONCAT('%', #{schTxt}, '%')
		            </otherwise>
				</choose>
			 </if>
			 <if test='targetJoin != null and targetJoin !=""'>
				<choose>
					<when test='targetJoin == "attendance"'>
						AND D.RegistDate IS NOT NULL		   
		            </when>
		            <otherwise>
		                AND D.RegistDate IS NULL
		            </otherwise>
				</choose>
			 </if>
		 </trim>
	</select>
	
  	<!-- 미참여자 코드 조회  -->
	<select id="selectAttendanceCodes" parameterType="cmap"  resultType="cmap">
		SELECT TargetCode
		FROM 
		 	(
		 		# Type: UR
			 	SELECT A.SurveyID , A.TargetCode 
				FROM covi_smart4j.survey_target_respondent AS A
				WHERE A.SurveyID = #{surveyID} AND A.TargetType = 'UR'
				 
				UNION
				 
				# Type: GR
				SELECT A.SurveyID, B.UserCode
				FROM covi_smart4j.survey_target_respondent AS A 
				INNER JOIN ( SELECT A.UserCode, B.GroupCode, C.GroupPath FROM sys_object_user_basegroup AS A
								LEFT JOIN sys_object_group_member AS B ON A.UserCode = B.UserCode AND B.IsUse= 'Y'
								LEFT JOIN sys_object_group AS C ON B.GroupCode = C.GroupCode AND C.IsDisplay = 'Y' AND C.IsUse = 'Y') AS B
				ON (A.TargetCode = B.GroupCode OR CONCAT(';',B.GroupPath) LIKE CONCAT('%;',A.TargetCode,';%') )	 AND A.TargetType = 'GR'				
				WHERE A.SurveyID = #{surveyID}
			) AS A
		 INNER JOIN covi_smart4j.sys_object_user AS B ON A.TargetCode = B.UserCode AND B.IsUse = 'Y' AND B.IsDisplay = 'Y'
		 INNER JOIN covi_smart4j.sys_object_user_basegroup AS C ON  A.TargetCode = C.UserCode AND C.JobType = 'Origin'
		 <if test="targetType != null and targetType == 'notAttendance'.toString()">
			 LEFT JOIN covi_smart4j.survey_respondent AS D ON A.SurveyID = D.SurveyID  AND A.TargetCode = D.RespondentCode
			 WHERE D.RegistDate IS NULL
		 </if>
	</select>
  	
	<select id="selectTargetResultviewList" parameterType="cmap" resultType="cmap">
		 	SELECT  A.SurveyID , A.TargetCode, B.PhotoPath
					, Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName ) AS DisplayName
					, Fn_BaseGetDictionary_S(#{lang}, C.MultiDeptName ) AS DeptName
					, D.EtcOpinion
			FROM 
			 	(
			 		# Type: UR
				 	SELECT A.SurveyID , A.TargetCode 
					FROM covi_smart4j.survey_target_resultview AS A
					WHERE A.SurveyID = #{surveyID} AND A.TargetType = 'UR'
					 
					UNION
					 
					# Type: GR
					SELECT A.SurveyID, B.UserCode
					FROM covi_smart4j.survey_target_resultview AS A 
					INNER JOIN ( 
						SELECT A.UserCode, B.GroupCode, C.GroupPath FROM sys_object_user_basegroup AS A
						LEFT JOIN (SELECT GroupCode, UserCode FROM sys_object_group_member WHERE IsUse='Y') AS B ON A.UserCode = B.UserCode
						LEFT JOIN (SELECT GroupPath, GroupCode FROM sys_object_group WHERE IsDisplay = 'Y' AND IsUse = 'Y') AS C ON B.GroupCode = C.GroupCode
					) AS B
					ON (A.TargetCode = B.GroupCode OR CONCAT(';',B.GroupPath) LIKE CONCAT('%;',A.TargetCode,';%') )	 AND A.TargetType = 'GR'				
					WHERE A.SurveyID = #{surveyID}
				) AS A
			 INNER JOIN covi_smart4j.sys_object_user AS B ON A.TargetCode = B.UserCode AND B.IsUse = 'Y' AND B.IsDisplay = 'Y'
			 INNER JOIN covi_smart4j.sys_object_user_basegroup AS C ON  A.TargetCode = C.UserCode AND C.JobType = 'Origin'
			 LEFT JOIN covi_smart4j.survey_respondent AS D ON A.SurveyID = D.SurveyID  AND A.TargetCode = D.RespondentCode
			 <trim prefix="WHERE" prefixOverrides="AND|OR">
				 <if test='targetType != null and targetType !="" and schTxt != null and schTxt !="" ' >
				 	<choose>
						<when test='targetType == "ur"'>
							AND Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName )  LIKE CONCAT('%', #{schTxt}, '%')
		            	</when>
			            <otherwise>
			            	AND Fn_BaseGetDictionary_S(#{lang}, C.MultiDeptName ) LIKE CONCAT('%', #{schTxt}, '%')
			            </otherwise>
					</choose>
			   	 </if>	   	
			   	 <if test='targetJoin != null and targetJoin !=""'>
					<choose>
						<when test='targetJoin == "attendance"'>
							AND A.RegistDate IS NOT NULL		   
			            </when>
						<when test='targetJoin == "nonAttendance"'>
							AND A.RegistDate IS NULL		   
			            </when>
					</choose>
				 </if>			 
			 </trim>
		   	 <trim prefix='ORDER BY'>
				<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
					<choose>
						<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
						<when test='sortColumn.equalsIgnoreCase("DeptName")'>DeptName</when>
						<otherwise>RegistDate</otherwise>
					</choose>
					<choose>
						<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
						<otherwise> DESC</otherwise>
					</choose>
				</if>
			</trim>
			<if test='pageSize != null and pageOffset != null'>
				LIMIT #{pageSize} OFFSET #{pageOffset}
			</if>				     	  
	</select>
	
  	<select id="selectTargetResultviewListCnt" resultType="java.lang.Long">
			SELECT COUNT(*) 
			FROM 
			 	(
			 		# Type: UR
				 	SELECT A.SurveyID , A.TargetCode 
					FROM covi_smart4j.survey_target_resultview AS A
					WHERE A.SurveyID = #{surveyID} AND A.TargetType = 'UR'
					 
					UNION
					 
					# Type: GR
					SELECT A.SurveyID, B.UserCode
					FROM covi_smart4j.survey_target_resultview AS A 
					INNER JOIN ( 
						SELECT A.UserCode, B.GroupCode, C.GroupPath FROM sys_object_user_basegroup AS A
						LEFT JOIN (SELECT GroupCode, UserCode FROM sys_object_group_member WHERE IsUse='Y') AS B ON A.UserCode = B.UserCode
						LEFT JOIN (SELECT GroupPath, GroupCode FROM sys_object_group WHERE IsDisplay = 'Y' AND IsUse = 'Y') AS C ON B.GroupCode = C.GroupCode
					) AS B
					ON (A.TargetCode = B.GroupCode OR CONCAT(';',B.GroupPath) LIKE CONCAT('%;',A.TargetCode,';%') )	 AND A.TargetType = 'GR'				
					WHERE A.SurveyID = #{surveyID}
				) AS A
			 INNER JOIN covi_smart4j.sys_object_user AS B ON A.TargetCode = B.UserCode AND B.IsUse = 'Y' AND B.IsDisplay = 'Y'
			 INNER JOIN covi_smart4j.sys_object_user_basegroup AS C ON  A.TargetCode = C.UserCode AND C.JobType = 'Origin'
			 LEFT JOIN covi_smart4j.survey_respondent AS D ON A.SurveyID = D.SurveyID  AND A.TargetCode = D.RespondentCode
			 <trim prefix="WHERE" prefixOverrides="AND|OR">
				 <if test='targetType != null and targetType !="" and schTxt != null and schTxt !="" ' >
				 	<choose>
						<when test='targetType == "ur"'>
							AND Fn_BaseGetDictionary_S(#{lang}, B.MultiDisplayName )  LIKE CONCAT('%', #{schTxt}, '%')
		            	</when>
			            <otherwise>
			            	AND Fn_BaseGetDictionary_S(#{lang}, C.MultiDeptName ) LIKE CONCAT('%', #{schTxt}, '%')
			            </otherwise>
					</choose>
			   	 </if>	   	
			   	 <if test='targetJoin != null and targetJoin !=""'>
					<choose>
						<when test='targetJoin == "attendance"'>
							AND A.RegistDate IS NOT NULL		   
			            </when>
						<when test='targetJoin == "nonAttendance"'>
							AND A.RegistDate IS NULL		   
			            </when>
					</choose>
				 </if>			 
			 </trim>
	</select>
	
	<select id="selectSurveyManageList" parameterType="cmap" resultType="cmap">
		/* queryId = user.survey.selectSurveyManageList */
		SELECT a.SurveyID, a.State, a.Subject,
			   covi_smart4j.Fn_BaseGetDictionary_S(#{lang},  b.MultiDisplayName) AS RegisterName,
			   DATE_FORMAT(a.SurveyStartDate,'%Y-%m-%d') AS SurveyStartDate,
			   DATE_FORMAT(a.SurveyEndDate,'%Y-%m-%d') AS SurveyEndDate,
			   (CASE WHEN a.State = 'B' THEN '검토대기'
			 		 WHEN a.State = 'D' THEN '검토거부'
			 		 WHEN a.State = 'C' THEN '승인대기'
			 		 WHEN a.State = 'X' THEN '승인거부'
			 		 WHEN a.State = 'F' THEN '진행중'
			 		 WHEN a.State = 'G' THEN '설문종료'
			 	 END   ) AS StateName,
			   a.RegistDate,
			   covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, c.MultiDisplayName) AS CompanyName,
			   (SELECT COUNT(sr.RespondentCode) FROM survey_respondent sr WHERE sr.SurveyID = a.SurveyID) as RespondentCnt
		 FROM covi_smart4j.survey AS a
		 LEFT JOIN covi_smart4j.sys_object_user AS b ON a.RegisterCode = b.UserCode
		 LEFT JOIN covi_smart4j.sys_object_domain AS c ON a.CompanyCode = c.DomainCode
		WHERE a.State IN ('B','C','F','G')
		  AND a.DeleteDate IS NULL
		  <choose>
		  	<when test="companyCode != null and companyCode != ''">
		  	AND a.CompanyCode = #{companyCode}
		  	</when>
		  	<otherwise>
		  		<if test="domainId != null and domainId != ''">
		  	AND c.DomainID = #{domainId}
		  		</if>		
		  	</otherwise>
		  </choose>
	   	<if test='schTxt != null and schTxt !=""'>
			<choose>
				<when test='selType == "subject"'>
					AND a.Subject LIKE CONCAT('%',#{schTxt},'%')
            	</when>
				<when test='selType == "registerName"'>
					AND Fn_BaseGetDictionary_S(#{lang},  b.MultiDisplayName)  LIKE CONCAT('%',#{schTxt},'%')
            	</when>
			</choose>
		</if>
		<if test='state != null and state !=""'>
			AND a.State = #{state}
		</if>	
		<trim prefix='ORDER BY'>
			<if test="sortColumn != '' and sortColumn != null and sortDirection != '' and sortDirection != null">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<when test='sortColumn.equalsIgnoreCase("SurveyStartDate")'>SurveyStartDate</when>
					<when test='sortColumn.equalsIgnoreCase("SurveyEndDate")'>SurveyEndDate</when>
					<when test='sortColumn.equalsIgnoreCase("StateName")'>StateName</when>
					<otherwise>RegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test='pageSize != null and pageOffset != null'>
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>			  
	</select>
	
  	<select id="selectSurveyManageListCnt" resultType="java.lang.Long">
		/* queryId = user.survey.selectSurveyManageListCnt */
		SELECT COUNT(*)
		 FROM covi_smart4j.survey AS a
		 LEFT JOIN covi_smart4j.sys_object_user AS b ON a.RegisterCode = b.UserCode
		 LEFT JOIN covi_smart4j.sys_object_domain AS c ON a.CompanyCode = c.DomainCode
		 WHERE a.State IN ('B','C','F','G')
		   AND a.DeleteDate IS NULL
		  <choose>
		  	<when test="companyCode != null and companyCode != ''">
		  	AND a.CompanyCode = #{companyCode}
		  	</when>
		  	<otherwise>
		  		<if test="domainId != null and domainId != ''">
		  	AND c.DomainID = #{domainId}
		  		</if>		
		  	</otherwise>
		  </choose>
	   	<if test='schTxt != null and schTxt !=""'>
			<choose>
				<when test='selType == "subject"'>
					AND a.Subject LIKE CONCAT('%',REGEXP_REPLACE(#{schTxt},'(%|\'|\")','\\\\\\1'),'%')
            	</when>
				<when test='selType == "registerName"'>
					AND Fn_BaseGetDictionary_S(#{lang},  b.MultiDisplayName)  LIKE CONCAT('%',#{schTxt},'%')
            	</when>
			</choose>
		</if>
		<if test='state != null and state !=""'>
			AND a.State = #{state}
		</if>	
	</select>	
		
	<select id="selectSurveyReportList" parameterType="cmap" resultType="cmap">
		SELECT *
		FROM (SELECT A.ItemNO
						  , B.AnswerItem
						  , B.RespondentCode
						  , IF(B.Weighting IS NULL, 0, B.Weighting) AS Weighting
						  , C.QuestionID
						  , C.QuestionNO
						  , C.QuestionType
						  , (CASE WHEN C.QuestionType = 'S' THEN '객관식'
						  	     WHEN C.QuestionType = 'D' THEN '주관식'
						  		  WHEN C.QuestionType = 'M' THEN '복수응답'
						  	     WHEN C.QuestionType = 'N' THEN '순위선택' END ) AS QuestionTypeNm
						  , D.JobLevelCode
						  , D.JobLevelName
						  , D.DeptCode
						  , D.DeptName
						  , F.DisplayName
						  , D.CompanyName
					 FROM covi_smart4j.survey_question_item A
					 LEFT JOIN covi_smart4j.survey_question_item_answer B  ON A.ItemID = B.ItemID
					 LEFT JOIN covi_smart4j.survey_question C ON A.QuestionID = C.QuestionID
					 LEFT JOIN covi_smart4j.sys_object_user_basegroup D  ON B.RespondentCode = D.UserCode AND D.JobType = 'Origin'
					 LEFT JOIN covi_smart4j.sys_object_user F  ON B.RespondentCode = F.UserCode
					WHERE A.SurveyID = #{surveyID}
					AND B.RespondentCode IS NOT NULL
					AND F.IsUse = 'Y' AND F.IsDisplay = 'Y' 
					GROUP BY C.QuestionNO, A.ItemNO, B.RespondentCode
			  ) A
	</select>
	
	<insert id="insertSurveyRespondentTarget" parameterType="cmap">	
		INSERT   INTO covi_smart4j.survey_target_respondent (SurveyID, TargetCode, TargetType, TargetDeptCode, RegistDate )
	    VALUES (#{surveyId}, #{targetCode}, #{targetType}, #{targetDeptCode}, #{localCurrentDate}  )
	</insert>
	
	<insert id="insertsurveyresultviewTarget" parameterType="cmap">	
		INSERT  INTO covi_smart4j.survey_target_resultview (SurveyID, TargetCode, TargetType, TargetDeptCode, RegistDate)
	    VALUES (#{surveyId}, #{targetCode}, #{targetType}, #{targetDeptCode}, #{localCurrentDate} )
	</insert>
	
	<insert id="insertSurveyRespondentTargetCmnty" parameterType="cmap">
	    INSERT INTO covi_smart4j.survey_target_respondent(SurveyID, TargetCode, TargetType, TargetDeptCode, RegistDate )
		SELECT 	#{surveyId}
				,UR_CODE
				,'UR'
				,null
				,DATE_FORMAT(#{localCurrentDate},'%Y.%m.%d %H:%i:%s')
		FROM COVI_SMART4J.COMMUNITY_MEMBER
		WHERE CU_ID = #{communityID}	
		AND MemberStatus = 'R'    
	</insert>
	
	<insert id="insertsurveyresultviewTargetCmnty" parameterType="cmap">	
		INSERT  INTO covi_smart4j.survey_target_resultview (SurveyID, TargetCode, TargetType, TargetDeptCode, RegistDate)
	    SELECT 	#{surveyId}
				,UR_CODE
				,'UR'
				,null
				,DATE_FORMAT(#{localCurrentDate},'%Y.%m.%d %H:%i:%s')
		FROM COVI_SMART4J.COMMUNITY_MEMBER
		WHERE CU_ID = #{communityID}
		AND MemberStatus = 'R'
	</insert>	
	
	<insert id="insertCollabSurveyRespondentTarget" parameterType="cmap">
		INSERT INTO covi_smart4j.survey_target_respondent(SurveyID, TargetCode, TargetType, TargetDeptCode, RegistDate)
		SELECT	  #{surveyId}
				, A.UserCode
				, 'UR'
				, null
				, DATE_FORMAT(#{localCurrentDate}, '%Y.%m.%d %H:%i:%s')
		<if test='prjType != null and prjType == "P"'>
			FROM covi_smart4j.collab_project_member A
			WHERE PrjSeq = #{prjSeq}
		</if>
		<if test='prjType != null and prjType == "T"'>
			FROM covi_smart4j.sys_object_user_basegroup A
			INNER JOIN covi_smart4j.sys_object_group B ON A.DeptCode = B.GroupCode AND B.GroupID = #{prjSeq}
		</if>
	</insert>
	
	<insert id="insertCollabSurveyresultviewTarget" parameterType="cmap">	
		INSERT INTO covi_smart4j.survey_target_resultview(SurveyID, TargetCode, TargetType, TargetDeptCode, RegistDate)
		SELECT	  #{surveyId}
				, A.UserCode
				, 'UR'
				, null
				, DATE_FORMAT(#{localCurrentDate}, '%Y.%m.%d %H:%i:%s')
		<if test='prjType != null and prjType == "P"'>
			FROM covi_smart4j.collab_project_manager A
			WHERE PrjSeq = #{prjSeq}
		</if>
		<if test='prjType != null and prjType == "T"'>
			FROM covi_smart4j.sys_object_user_basegroup A
			INNER JOIN covi_smart4j.sys_object_group B ON A.DeptCode = B.GroupCode AND B.GroupID = #{prjSeq}
			WHERE 1=1
			<foreach collection="jobTitleCodes" item="code" open="AND (" close=")" separator="OR">
				A.JobTitleCode LIKE CONCAT(#{code}, '%')
			</foreach>
		</if>
	</insert>
	
	<update id="updateSurveyTargetRead" parameterType="cmap">
		INSERT INTO covi_smart4j.survey_target_read (SurveyID, TargetCode, ModifyDate) 
		VALUES (#{surveyId}, #{userId}, #{localCurrentDate} ) ON DUPLICATE KEY 
		UPDATE ModifyDate = #{localCurrentDate}
	</update>
	
	<update id="updateSurveyQuestionItemFileId" parameterType="cmap">
		UPDATE covi_smart4j.survey_question_item
		SET FileID = #{fileId}
		WHERE ItemID = #{itemId}
	</update>
	
	<select id="selectSurveyData" parameterType="cmap" resultType="cmap">
	    SELECT S.SurveyID,S.CompanyCode,S.Subject,S.SubjectHtml,S.Description,S.IsDescriptionUseEditor,S.SurveyStartDate,S.SurveyEndDate,S.ResultViewStartDate,S.ResultViewEndDate,S.QuestionCount,S.RespondentCount,S.TargetRespondentType,S.TargetResultViewType,S.SurveyType,S.State,S.IsImportance,S.IsAnonymouse,S.IsGrouping,S.IsSendTodo,S.IsSendMail,S.RegisterCode,S.RegisterDeptCode,S.RegistDate,S.ModifyDate,S.DeleteDate,S.ReviewerCode,S.ReviewerDeptCode,S.ApproverCode,S.ApproverDeptCode,S.ReviewerDate,S.ApproverDate,S.CommunityID
		, (SELECT COUNT(G.SurveyID) FROM covi_smart4j.survey_respondent G LEFT JOIN covi_smart4j.sys_object_user U ON G.RespondentCode = U.UserCode WHERE G.SurveyID = #{surveyID} AND U.IsUse = 'Y' AND U.IsDisplay = 'Y') AS respondentCnt
		, D.DomainID
		FROM covi_smart4j.survey S
		LEFT OUTER JOIN covi_smart4j.sys_object_domain D ON D.DomainCode = S.CompanyCode
		WHERE S.SurveyID = #{surveyID}
	</select>
	
	
	<select id="selectArrSurveyData" parameterType="cmap" resultType="cmap">
	    SELECT S.surveyID, S.subject, S.state, S.registerCode, S.reviewerCode, S.approverCode, D.DomainID AS domainID
		FROM covi_smart4j.survey S
		LEFT OUTER JOIN covi_smart4j.sys_object_domain D ON D.DomainCode = S.CompanyCode
		WHERE S.SurveyID IN 
	   <foreach collection="surveyIdArr" item="surveyID" open="(" close=")" separator=",">
            #{surveyID}
       </foreach>
	</select>

	<!-- 엑셀저장 : 설문자료 저장 -->	
	<select id="selectSurveyRawDataExcelList" parameterType="cmap" resultType="cmap">
		SELECT R.*, U.DisplayName AS RespondentName, D.DeptName AS RespondentDeptName
		FROM (
			SELECT 
				A.SurveyID, 
				A.QuestionID,
				A.RespondentCode,
				A.RespondentDeptCode,
				Q.Question,
				Q.QuestionType,
				GROUP_CONCAT(A.ItemID ORDER BY A.ItemID, ',') AS AnswerItemID,
				IF(A.EtcOpinion = '', 
					(CASE Q.QuestionType  
					WHEN 'M' THEN	GROUP_CONCAT(DISTINCT A.AnswerITem ORDER BY A.AnswerItem SEPARATOR ', ')
					WHEN 'N' THEN	GROUP_CONCAT(A.AnswerITem ORDER BY A.Weighting SEPARATOR ', ')
					ELSE
						A.AnswerItem
					END), 
					CONCAT('기타의견: ', GROUP_CONCAT(DISTINCT A.EtcOpinion ORDER BY A.ItemID SEPARATOR ', '))
				) AS AnswerItem
			FROM 
				covi_smart4j.survey_question Q
			LEFT JOIN covi_smart4j.survey_question_item_answer A ON A.SurveyID = Q.SurveyID AND A.QuestionID = Q.QuestionID
			WHERE A.SurveyID = #{surveyID}
			GROUP BY A.RespondentCode, A.SurveyID, A.QuestionID
			ORDER BY A.RespondentCode, A.SurveyID, A.QuestionID
		) R  
		LEFT JOIN covi_smart4j.sys_object_user U ON R.RespondentCode = U.UserCode
		LEFT JOIN (SELECT * FROM covi_smart4j.sys_object_user_basegroup WHERE JobType = 'Origin') D ON U.UserCode = D.UserCode AND D.DeptCode = R.RespondentDeptCode
	</select>
	
	<!-- 엑셀저장 : 설문통계 저장 -->
	<select id="selectSurveyStatisticsExcelList" parameterType="cmap" resultType="cmap">
		<![CDATA[
		 SELECT R.*, 
				(CASE WHEN R.QuestionType in ('S','N') THEN
					CONCAT(IF(R.AnswerCnt > 0, 100 * (R.AnswerCnt / R.TotalUserCnt), 0), '%')
				WHEN R.QuestionType = 'M' THEN
					CONCAT(IF(R.AnswerCnt > 0, 100 * (R.AnswerCnt / R.TotalAnswerCnt), 0), '%')
				WHEN R.QuestionType = 'D' THEN
					R.AnswerItem
				ELSE
					''
				END) AS AnswerResult
		FROM (
			SELECT 
				A.SurveyID, 
				A.QuestionID, 
				Q.QuestionType,
				A.Weighting,
				A.ItemID AS AnswerItemID, 
				IF(COUNT(IF(A.EtcOpinion = '', NULL, A.EtcOpinion)) = 0, 
					A.AnswerItem, 
					CONCAT('기타의견: ', GROUP_CONCAT(DISTINCT A.EtcOpinion ORDER BY A.AnswerItem SEPARATOR ', '))
				) AS AnswerItem,
				COUNT(A.ItemId) AS AnswerCnt,
			  (SELECT COUNT(AnswerID) 
                        FROM covi_smart4j.survey_question_item_answer C  
                        WHERE C.SurveyID = A.SurveyID and c.QuestionID = a.QuestionID) AS TotalAnswerCnt,
				(
					SELECT COUNT(*)
					FROM (
						SELECT SurveyID, RespondentCode
						FROM survey_question_item_answer
						GROUP BY SurveyId, RespondentCode
					) AS S2
					WHERE S2.SurveyId = A.SurveyID
				) AS TotalUserCnt
			FROM 
				covi_smart4j.survey_question_item_answer A, 
				covi_smart4j.survey_question Q
			WHERE A.SurveyID = Q.SurveyID and A.QuestionID = Q.QuestionID and A.SurveyID = #{surveyID}
			GROUP BY A.SurveyID, A.QuestionID, A.Weighting, A.ItemID, a.AnswerItem
			ORDER BY A.QuestionID, A.Weighting, A.ItemID
		) R
		]]>
	</select>
	
	<select id="getSurveyTargetViewRead" parameterType="cmap"  resultType="String">
		SELECT Fn_SurveyTargetResultView_R(#{surveyId}, #{userId}) AS IsTargetResultView from dual
	</select>
	
	<insert id="insertCollabSurvey" parameterType="cmap">
		INSERT INTO covi_smart4j.collab_survey (SurveyID, PrjSeq, PrjType, PrjTxt, SectionSeq)
		VALUES (#{objectID}, #{prjSeq}, #{prjType}, #{prjTxt}, #{sectionSeq})
		ON DUPLICATE KEY UPDATE
			  PrjSeq		= #{prjSeq}
			, PrjType		= #{prjType}
			, PrjTxt		= #{prjTxt}
			, SectionSeq	= #{sectionSeq}
	</insert>
	
	<select id="selectCollabSurvey" parameterType="cmap" resultType="cmap">
		SELECT	  SurveyID AS "surveyID"
				, PrjSeq AS "prjSeq"
				, PrjType AS "prjType"
				, PrjTxt AS "prjTxt"
				, SectionSeq AS "sectionSeq"
		FROM covi_smart4j.collab_survey
		WHERE SurveyID = #{surveyID}
	</select>
	
	<select id="selectCollabSurveyCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM covi_smart4j.collab_survey
		WHERE SurveyID IN
		<foreach collection="surveyIdArr" item="surveyId" open="(" close=")" separator=",">
			#{surveyId}
		</foreach>
	</select>
	
	<delete id="deleteCollabSurvey" parameterType="cmap">
		DELETE FROM covi_smart4j.collab_survey 
		WHERE SurveyID IN
		<foreach collection="surveyIdArr" item="surveyId" open="(" close=")" separator=",">
			#{surveyId}
		</foreach>
	</delete>
</mapper>
