<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="user.message">
    <sql id="chooseBoardType">
        <if test="boardType != 'MyBooking' and boardType != 'Approval'">
            AND (ReservationDate IS NULL OR ReservationDate &lt; #{localCurrentDate})
        </if>
        <choose>
		     <when test="boardType == 'Total' or boardType == 'DocTotal'">
		        AND IF(H.FolderType = 'OneToOne', A.OwnerCode = #{userCode} OR (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = A.FolderID) LIKE CONCAT('%',#{userCode},';%') , 1=1)
	    	    AND MsgState IN ('C', 'A') 
				AND MsgType != 'S' 
				<!-- UseSecurity가 Y일때 게시일 경우에는 작성자만 조회할 수 있음 -->
				AND (
					UseSecurity != 'Y'
					OR (
						UseSecurity = 'Y'
						AND (
							#{bizSection} = 'Board' AND CreatorCode = #{userCode}
							OR #{bizSection} = 'Doc'
						)
					)
				)
				AND (ExpiredDate IS NULL OR  ExpiredDate >= #{localCurrentDate} ) 
				AND A.DeleteDate IS NULL
	    	</when>
	    	<when test="boardType == 'MyInterest'">	<!-- 전 즐겨찾기 게시판 -->
	    	    AND ExpiredDate >= #{localCurrentDate}
				AND (MsgState IN ('C', 'A')) AND (MsgType IN ('O', 'C', 'M'))
	    	</when>
	    	<when test="boardType == 'MyOwnWrite'">
	    	    AND CreatorCode = #{userCode}
				AND MsgState != 'T' AND MsgType != 'S' 
	    	</when>
	    	<when test="boardType == 'RequestModify'">
	    	    AND M.RequestorCode = #{userCode}
	    	</when>
	    	<when test="boardType == 'Scrap'">
	    	    AND CreatorCode = #{userCode}
				AND (MsgState IN ('C')) AND (MsgType IN ('S'))	<!-- C:등록 상태, S: 스크랩 -->
	    	</when>
	    	<when test="boardType == 'OnWriting'">
	    	    AND CreatorCode = #{userCode}
				AND A.DeleteDate IS NULL
				AND MsgState IN ('T')							<!-- T:임시저장 -->
	    	</when>
	    	<when test="boardType == 'MyBooking'">
	    	    AND CreatorCode = #{userCode}
	    	    AND (ReservationDate IS NOT NULL AND ReservationDate >= #{localCurrentDate})
<!-- 				AND MsgState IN ('BC', 'BA') -->
	    	</when>
	    	<when test="boardType == 'CheckIn'">
	    	 	 AND IsCheckOut = 'N' 
	    	 	 AND A.DeleteDate IS NULL
				 AND (ExpiredDate IS NULL OR  ExpiredDate >= #{localCurrentDate} ) 
				  <!-- ver1일 경우에 doc_input_history에 데이터 없어서 표시 안되는 오류 수정  -->
				 AND (
				 			( DIH.CO_Code = #{userCode} AND  DIH.ActType IN ('IN', 'Revision') ) 
				 			OR ( DIH.HistoryID IS NULL AND A.OwnerCode = #{userCode} )  
				 		 )
	    	 	 <!-- AND DIH.CO_Code = #{userCode} -->
	    	 	 <!-- AND RevisionCode = #{userCode} -->
	    	 	 <!-- AND DIH.ActType IN ('IN', 'Revision')  -->
	    	</when>
	    	<when test="boardType == 'CheckOut'">
	    	 	AND IsCheckOut = 'Y' 
	    	 	AND CheckOuterCode = #{userCode} 
	    	 	AND A.DeleteDate IS NULL
				AND (ExpiredDate IS NULL OR  ExpiredDate >= #{localCurrentDate} ) 
	    	 	AND DIH.ActType = 'Out'
	    	</when> 	
	    	<when test="boardType == 'DocOwner'">
	    	    AND MsgState IN ('C', 'A') 
				AND MsgType != 'B' 
<!-- 				AND IsCurrent = 'Y'  -->
				AND (ExpiredDate IS NULL OR  ExpiredDate >= #{localCurrentDate} ) 
				AND A.DeleteDate IS NULL 
				AND A.OwnerCode = #{userCode}  
	    	</when>
			<when test="boardType == 'Approval'">
				AND (ExpiredDate IS NULL OR ExpiredDate >= #{localCurrentDate})
				AND A.DeleteDate IS NULL
			</when>
    	</choose>
    </sql>
	<!-- 폴더/게시판 게시글 목록 조회 -->
    <select id="selectNormalMessageGridCount" resultType="java.lang.Long">
    /* user.message.selectNormalMessageGridCount */
        SELECT COUNT(*) 
        FROM (
	        SELECT DISTINCT
	        	BM.MessageID 
	        FROM board_message AS BM
	        LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = BM.MessageID AND BMA.Version = BM.Version
<!-- 			LEFT OUTER JOIN sys_object_user AS SOU ON BM.CreatorCode = SOU.UserCode -->
			<if test="categoryID != null and categoryID != ''">
			    LEFT OUTER JOIN board_category AS BC ON BM.CategoryID = BC.CategoryID AND BC.FolderID = #{folderID}
			</if>
			<!-- LEFT OUTER JOIN board_progressstate AS BP ON BM.progressstate = BP.StateID --> 
			<if test='useUserForm == "Y"'>
				LEFT OUTER JOIN board_message_userform_value AS BMUV ON (BM.MessageID = BMUV.MessageID AND BM.Version = BMUV.Version)
			</if>
			<if test="grCode != null and grCode != ''">
			    LEFT OUTER JOIN covi_smart4j.sys_object_folder AS SOF ON BM.FolderID = SOF.FolderID
			</if>
			<if test="multiCategory != null and multiCategory != ''">
				INNER JOIN (
					SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
					FROM covi_smart4j.board_userform_value
					GROUP BY MessageID, Version
					HAVING 1=1
					<foreach collection="multiCategoryList" item="multiCategory" index="index">
						AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
					</foreach>
				) AS UFV ON UFV.MessageID = BM.MessageID AND UFV.Version = BM.Version
			</if>
			<!-- 보안등급 및 열람권한 체크 -->
			<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
			LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
							 FROM (
								SELECT SRA.ObjectID, SRA.MessageID
								FROM covi_smart4j.sys_read_acl AS SRA
								WHERE SRA.ObjectType = 'FD'
								AND SRA.TargetType = 'UR'
								AND SRA.TargetCode = #{userCode}
								UNION
								SELECT SRA.ObjectID, SRA.MessageID
								FROM covi_smart4j.sys_read_acl AS SRA
								WHERE SRA.ObjectType = 'FD'
								AND SRA.TargetType != 'UR'
								AND SRA.TargetCode IN
								<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
						            #{item}
							    </foreach>
							) AS SRA) SRA ON BM.FolderID = SRA.ObjectID AND BM.MessageID = SRA.MessageID
			</if>			
			WHERE 1=1
			AND BM.MsgState IN ('C', 'A') 
			AND MsgType != 'S' 
			<!-- UseSecurity가 Y일때 게시일 경우에는 작성자만 조회할 수 있음 -->
			AND (
				UseSecurity != 'Y'
				OR (
					UseSecurity = 'Y'
					AND (
						#{bizSection} = 'Board' AND CreatorCode = #{userCode}
						OR #{bizSection} = 'Doc'
					)
				)
			)
			AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate} ) 
			AND BM.DeleteDate IS NULL
			AND (BM.ReservationDate IS NULL OR BM.ReservationDate &lt; #{localCurrentDate})
<!-- 			<if test="bizSection == 'Doc'"> -->
				AND BM.IsCurrent = 'Y'
<!-- 			</if> -->
			<!-- CHECK: 권한체크, 열람권한 체크 -->
			<!-- AND (BM.IsMessageReadAuth='Y' AND BM.MessageID IN (SELECT MessageID FROM Fn_ComMessageReadAclCheck_T('Board', @DN_Code, @GR_Code, @UR_Code)) OR (BM.IsMessageReadAuth=''N'')) -->
			<if test="folderType != null and folderType == 'OneToOne'">
			    AND (BM.OwnerCode = #{userCode} OR (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = #{folderID}) LIKE CONCAT('%',#{userCode},';%'))
			    <!-- CHECK: 폴더타입 비교 후 1:1게시판일 경우 게시판 담당자만 조회가능하게 조건 추가 -->
<!-- 			    AND ( BM.Depth = 0 AND  (BM.OwnerCode = #{userCode} OR BM.OwnerCode IN  -->
<!-- 			    	<foreach item="item" index="index" collection="messageOwner" open="(" close=")" separator=","> -->
<!-- 			            #{item} -->
<!-- 			    	</foreach> -->
<!-- 			    	) -->
<!-- 			    )  -->
			</if>
			<if test="categoryID != null and categoryID != ''">
		        <choose>
			    	<when test="categoryGubun == 'Y'">
			    	    AND (BC.MemberOf = #{categoryID} OR BC.CategoryID = #{categoryID})
			        </when>
			        <otherwise>
			            AND BM.CategoryID = #{categoryID}
			        </otherwise>
			    </choose>
		    </if>
		    <if test="readSearchType != null and readSearchType != ''">
		       <!-- CHECK: 읽음/읽음 조회 설정 -->
		       AND BM.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
		    </if>
		    <!-- 보안등급 및 열람권한 체크 -->
			<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
		       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
		                 ELSE CASE WHEN (BM.SecurityLevel = '256' OR BM.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
		                	  ELSE 'N' END
		                 END) = 'Y'
		              		                		  
		       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
		                 ELSE CASE WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
					     		   WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
					     		   ELSE 'N' END
					     END) = 'Y'
		    </if>
		    <!-- 검색어 항목 -->
			<if test="searchText != null and searchText != ''">
				<choose>
		       	 	<when test="searchType == 'Total'">
		           		 AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%') || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
		       		</when>
		       		<when test="searchType == 'Mobile'">
		       	  		 AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
		       		</when>
		       		<when test="searchType == 'UserForm'">
						AND 
						<choose>
							<when test='ufColumn.equalsIgnoreCase("UF_Value1")'>BMUV.UF_Value1 </when>
							<when test='ufColumn.equalsIgnoreCase("UF_Value2")'>BMUV.UF_Value2 </when>
							<when test='ufColumn.equalsIgnoreCase("UF_Value3")'>BMUV.UF_Value3 </when>
							<when test='ufColumn.equalsIgnoreCase("UF_Value4")'>BMUV.UF_Value4 </when>
							<when test='ufColumn.equalsIgnoreCase("UF_Value5")'>BMUV.UF_Value5 </when>
							<when test='ufColumn.equalsIgnoreCase("UF_Value6")'>BMUV.UF_Value6 </when>
							<when test='ufColumn.equalsIgnoreCase("UF_Value7")'>BMUV.UF_Value7 </when>
							<when test='ufColumn.equalsIgnoreCase("UF_Value8")'>BMUV.UF_Value8 </when>
							<when test='ufColumn.equalsIgnoreCase("UF_Value9")'>BMUV.UF_Value9 </when>
							<otherwise>BMUV.UF_Value0 </otherwise>
						</choose>
						LIKE CONCAT('%',#{searchText},'%')   
		       		</when>
		       		<when test="searchType == 'Tag'">
			            AND  ( SELECT GROUP_CONCAT(Tag SEPARATOR ',') FROM board_message_tag WHERE MessageID = BM.MessageID AND Version = BM.Version ) 
			            		LIKE CONCAT('%',#{searchText},'%')  
			       	</when>
		       		<otherwise>
		       			AND 
						<choose>
							<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
							<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
							<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
							<otherwise>BM.Subject </otherwise>
						</choose>
						LIKE CONCAT('%',#{searchText},'%')   
		       		</otherwise>
				</choose>
			</if>
			<if test="startDate != '' or endDate != ''">
				AND BM.RegistDate between #{startDate} and #{endDate}
			</if>
			<choose>
				<when test="bizSection == 'Doc' and grCode != null and grCode != ''">
				    AND SOF.FolderType = #{bizSection}
					AND BM.RegistDept = #{grCode}
				</when>
				<otherwise>
					AND BM.FolderID = #{folderID}
				</otherwise>
			</choose>
			<if test="bizSection == 'Doc' and (grCode == null or grCode == '')">
			    UNION ALL
			    
			    SELECT DISTINCT
		        	BM.MessageID 
		        FROM board_message AS BM
				LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = BM.MessageID AND BMA.Version = BM.Version
		        LEFT OUTER JOIN board_message_folder AS BMF ON BMF.MessageID = BM.MessageID AND BMF.Version = BM.Version
	<!-- 			LEFT OUTER JOIN sys_object_user AS SOU ON BM.CreatorCode = SOU.UserCode -->
				<if test="categoryID != null and categoryID != ''">
				    LEFT OUTER JOIN board_category AS BC ON BM.CategoryID = BC.CategoryID AND BC.FolderID = #{folderID}
				</if>
				<!-- LEFT OUTER JOIN board_progressstate AS BP ON BM.progressstate = BP.StateID --> 
				<if test='useUserForm == "Y"'>
					LEFT OUTER JOIN board_message_userform_value AS BMUV ON (BM.MessageID = BMUV.MessageID AND BM.Version = BMUV.Version)
				</if>
				<if test="multiCategory != null and multiCategory != ''">
					INNER JOIN (
						SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
						FROM covi_smart4j.board_userform_value
						GROUP BY MessageID, Version
						HAVING 1=1
						<foreach collection="multiCategoryList" item="multiCategory" index="index">
							AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
						</foreach>
					) AS UFV ON UFV.MessageID = BM.MessageID AND UFV.Version = BM.Version
				</if>
				<!-- 보안등급 및 열람권한 체크 -->
				<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
				LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
								 FROM (
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType = 'UR'
									AND SRA.TargetCode = #{userCode}
									UNION
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType != 'UR'
									AND SRA.TargetCode IN
									<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
							            #{item}
								    </foreach>
								) AS SRA) SRA ON BM.FolderID = SRA.ObjectID AND BM.MessageID = SRA.MessageID
				</if>
				WHERE 1=1
				AND BM.MsgState IN ('C', 'A') 
				AND MsgType != 'S' 
				AND BMF.FolderID = #{folderID}
				<!-- UseSecurity가 Y일때 게시일 경우에는 작성자만 조회할 수 있음 -->
				AND (
					UseSecurity != 'Y'
					OR (
						UseSecurity = 'Y'
						AND (
							#{bizSection} = 'Board' AND CreatorCode = #{userCode}
							OR #{bizSection} = 'Doc'
						)
					)
				)
				AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate} ) 
				AND BM.DeleteDate IS NULL
				AND (BM.ReservationDate IS NULL OR BM.ReservationDate &lt; #{localCurrentDate})
	<!-- 			<if test="bizSection == 'Doc'"> -->
					AND BM.IsCurrent = 'Y'
	<!-- 			</if> -->
				<!-- CHECK: 권한체크, 열람권한 체크 -->
				<!-- AND (BM.IsMessageReadAuth='Y' AND BM.MessageID IN (SELECT MessageID FROM Fn_ComMessageReadAclCheck_T('Board', @DN_Code, @GR_Code, @UR_Code)) OR (BM.IsMessageReadAuth=''N'')) -->
				<if test="folderType != null and folderType == 'OneToOne'">
				    AND (BM.OwnerCode = #{userCode} OR (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = #{folderID}) LIKE CONCAT('%',#{userCode},';%'))
				    <!-- CHECK: 폴더타입 비교 후 1:1게시판일 경우 게시판 담당자만 조회가능하게 조건 추가 -->
	<!-- 			    AND ( BM.Depth = 0 AND  (BM.OwnerCode = #{userCode} OR BM.OwnerCode IN  -->
	<!-- 			    	<foreach item="item" index="index" collection="messageOwner" open="(" close=")" separator=","> -->
	<!-- 			            #{item} -->
	<!-- 			    	</foreach> -->
	<!-- 			    	) -->
	<!-- 			    )  -->
				</if>
				<if test="categoryID != null and categoryID != ''">
			        <choose>
				    	<when test="categoryGubun == 'Y'">
				    	    AND (BC.MemberOf = #{categoryID} OR BC.CategoryID = #{categoryID})
				        </when>
				        <otherwise>
				            AND BM.CategoryID = #{categoryID}
				        </otherwise>
				    </choose>
			    </if>
			    <if test="readSearchType != null and readSearchType != ''">
			       <!-- CHECK: 읽음/읽음 조회 설정 -->
			       AND BM.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
			    </if>
			    <!-- 보안등급 및 열람권한 체크 -->
				<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
			       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
			                 ELSE CASE WHEN (BM.SecurityLevel = '256' OR BM.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
			                	  ELSE 'N' END
			                 END) = 'Y'
			              		                		  
			       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
			                 ELSE CASE WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
						     		   WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
						     		   ELSE 'N' END
						     END) = 'Y'
			    </if>
			    <!-- 검색어 항목 -->
				<if test="searchText != null and searchText != ''">
					<choose>
			       	 	<when test="searchType == 'Total'">
			           		 AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%') || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
			       		</when>
			       		<when test="searchType == 'Mobile'">
			       	  		 AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%') || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
			       		</when>
			       		<when test="searchType == 'UserForm'">
			       	  		AND 
							<choose>
								<when test='ufColumn.equalsIgnoreCase("UF_Value1")'>BMUV.UF_Value1 </when>
								<when test='ufColumn.equalsIgnoreCase("UF_Value2")'>BMUV.UF_Value2 </when>
								<when test='ufColumn.equalsIgnoreCase("UF_Value3")'>BMUV.UF_Value3 </when>
								<when test='ufColumn.equalsIgnoreCase("UF_Value4")'>BMUV.UF_Value4 </when>
								<when test='ufColumn.equalsIgnoreCase("UF_Value5")'>BMUV.UF_Value5 </when>
								<when test='ufColumn.equalsIgnoreCase("UF_Value6")'>BMUV.UF_Value6 </when>
								<when test='ufColumn.equalsIgnoreCase("UF_Value7")'>BMUV.UF_Value7 </when>
								<when test='ufColumn.equalsIgnoreCase("UF_Value8")'>BMUV.UF_Value8 </when>
								<when test='ufColumn.equalsIgnoreCase("UF_Value9")'>BMUV.UF_Value9 </when>
								<otherwise>BMUV.UF_Value0 </otherwise>
							</choose>
							LIKE CONCAT('%',#{searchText},'%')   
			       		</when>
			       		<when test="searchType == 'Tag'">
				            AND  ( SELECT GROUP_CONCAT(Tag SEPARATOR ',') FROM board_message_tag WHERE MessageID = BM.MessageID AND Version = BM.Version ) 
				            		LIKE CONCAT('%',#{searchText},'%')  
				       	</when>
			       		<otherwise>
							AND 
						<choose>
							<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
							<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
							<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
							<otherwise>BM.Subject </otherwise>
						</choose>
						LIKE CONCAT('%',#{searchText},'%')   
			       		</otherwise>
					</choose>
				</if>
				<if test="startDate != '' or endDate != ''">
					AND BM.RegistDate between #{startDate} and #{endDate}
				</if>
			</if>
	    ) AS RESULT
		WHERE 1=1
    </select>
    
    <!-- 폴더/게시판 게시글 목록 조회 -->
    <select id="selectNormalMessageGridList" parameterType="cmap" resultType="cmap">
    /* user.message.selectNormalMessageGridList */
    	SELECT A.*, @rownum:=@rownum+1 RNUM
    	FROM  (
			SELECT
				BM.MessageID 
				, BM.Version
				, BM.Number 
				, BM.F_FolderID AS FolderID
				, BM.MenuID
				, BM.FolderPath
				, BM.IsInherited
				, BM.ParentID 
				, BM.MsgType 
				, CASE WHEN IFNULL(BM.DeleteDate, '') = '' THEN BM.MsgState ELSE 'DEL' END as MsgState
				, BM.CategoryID
				, (SELECT Fn_BaseGetDictionary_S(#{lang},DisplayName) FROM board_category WHERE CategoryPath = BM.CategoryPath) AS CategoryName
				, BM.CategoryPath
				, BM.Seq, BM.Step , BM.Depth 
				, BM.Subject
				, BM.IsPopup
				, CASE WHEN (BM.IsTop = 'Y' AND ((BM.TopStartDate IS NOT NULL AND BM.TopStartDate &lt;= #{localCurrentDate}) AND (BM.TopEndDate IS NOT NULL AND BM.TopEndDate >= #{localCurrentDate}))) THEN 'Y' ELSE 'N' END AS IsTop
				, BM.PopupStartDate, BM.PopupEndDate 
				, BM.TopStartDate, BM.TopEndDate 
				, BM.ExpiredDate 
				, BM.UseSecurity 
				, BM.UseAnonym 
				, BM.IsApproval 
				, BM.IsUserForm
				, BM.IsCheckOut 
				, BM.UseScrap 
				, BM.NoticeMedia 
				, BM.UseRSS 
				, BM.TrackBackURL 
				, BM.AnswerCnt 
				, BM.ReadCnt 
				, BM.ListTop
				, (SELECT COUNT(*) 
				 	 FROM sys_comment 
				 	WHERE DeleteDate IS NULL 
				 	<choose>
						<when test="bizSection != null and bizSection != '' and (bizSection == 'Board' or bizSection == 'Doc' or bizSection == 'Community')">
							AND TargetServiceType IN ('Board', 'Doc', 'Community')
						</when>
						<otherwise>
							AND TargetServiceType = #{bizSection}
						</otherwise>
					</choose>
				 	  AND TargetID = CONCAT(BM.MessageID,'_',BM.Version)) AS CommentCnt 
				, (SELECT COUNT(*) 
					 FROM sys_like 
					 WHERE 1=1
					 <choose>
						<when test="bizSection != null and bizSection != '' and (bizSection == 'Board' or bizSection == 'Doc' or bizSection == 'Community')">
							AND TargetServiceType IN ('Board', 'Doc', 'Community')
						</when>
						<otherwise>
							AND TargetServiceType = #{bizSection}
						</otherwise>
					</choose> 
					   AND TargetID = CONCAT(BM.MessageID,'_',BM.Version)) AS RecommendCnt
				, BM.ScrapCnt 
				, BM.ReportCnt 
				, BM.FileCnt, BM.FileExtension
				, BM.TracbackCnt
				, DATE_FORMAT(BM.RegistDate,'%Y.%m.%d %H:%i:%s') AS RegistDate
				, BM.CreatorCode 
	<!-- 			, SOU.MultiDisplayName -->
				, DATE_FORMAT(BM.CreateDate, '%Y-%m-%d %H:%i:%s') AS CreateDate
				,IF(BM.UsePubDeptName = 'Y', Fn_BaseGetDictionary_S(#{lang},BM.CreatorDept), Fn_BaseGetDictionary_S(#{lang},BM.CreatorName)) AS CreatorName
				, BM.CreatorLevel, BM.CreatorPosition, BM.CreatorTitle 
				, Fn_BaseGetDictionary_S(#{lang}, BM.CreatorDept) AS CreatorDept
				, BM.DeleteDate
				, BM.ReservationDate
				, BM.LinkURL 
				, BM.RegistDept
				, BM.OwnerCode
				, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS OwnerName
				, (SELECT Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName) FROM sys_object_group WHERE groupcode = BM.RegistDept) AS RegistDeptName
				, BM.A_OwnerCode AS FolderOwnerCode
				<!-- , BM.DisplayName AS ProgressState --> 
				, NULL AS ProgressState
				, IF(BM.RevisionDate IS NULL, DATE_FORMAT(BM.RegistDate,'%Y.%m.%d %H:%i:%s'), DATE_FORMAT(BM.RevisionDate,'%Y.%m.%d %H:%i:%s')) AS RevisionDate
				, (SELECT Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.RevisionCode) AS RevisionName
				, IF((SELECT COUNT(*) FROM board_message_reader WHERE MessageID = BM.MessageID AND ReaderCode = #{userCode}) >0, 'Y', 'N' ) AS IsRead
				, IF((SELECT COUNT(*) FROM sys_object_user WHERE UserCode = #{userCode} AND BM.SecurityLevel IS NOT NULL AND BM.SecurityLevel != 256 AND BM.SecurityLevel >= SecurityLevel) > 0, 'Y', 'N') AS IsSecurity
				<if test='useUserForm == "Y"'>
					<!-- 
					, Fn_BaseGetDictionary_S(#{lang},UF_Value0) AS UF_Value0, Fn_BaseGetDictionary_S(#{lang}, UF_Value1) AS UF_Value1
					, Fn_BaseGetDictionary_S(#{lang},UF_Value2) AS UF_Value2, Fn_BaseGetDictionary_S(#{lang}, UF_Value3) AS UF_Value3
					, Fn_BaseGetDictionary_S(#{lang},UF_Value4) AS UF_Value4, Fn_BaseGetDictionary_S(#{lang}, UF_Value5) AS UF_Value5
					, Fn_BaseGetDictionary_S(#{lang},UF_Value6) AS UF_Value6, Fn_BaseGetDictionary_S(#{lang}, UF_Value7) AS UF_Value7
					, Fn_BaseGetDictionary_S(#{lang},UF_Value8) AS UF_Value8, Fn_BaseGetDictionary_S(#{lang}, UF_Value9) AS UF_Value9
					 -->
					, UF_Value0, UF_Value1, UF_Value2, UF_Value3, UF_Value4, UF_Value5, UF_Value6, UF_Value7, UF_Value8, UF_Value9
				</if>
				<if test="bizSection == 'Board'">
			    	, (SELECT MailAddress FROM sys_object_user WHERE UserCode = BM.CreatorCode) AS MailAddress
				</if>
				<if test="bizSection == 'Doc'">
				    , (SELECT MailAddress FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS MailAddress
				    , BM.MultiFolderType
				</if>
				<if test="viewType == 'Album'">
				    ,(SELECT MAX(FileID) FROM sys_file WHERE ObjectType ='FD' AND ObjectID = BM.FolderID AND MessageID = BM.MessageID AND SaveType='IMAGE') AS FileID
				</if>
				FROM( SELECT DISTINCT BM.*, BM.FolderID AS F_FolderID, A.MenuID, A.FolderPath, BC.CategoryPath, A.OwnerCode AS 'A_OwnerCode', 'ORIGIN' AS MultiFolderType<!-- , BP.DisplayName -->
					,(CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
					<if test='useUserForm == "Y"'>
					, BMUV.UF_Value0
					, BMUV.UF_Value1
					, BMUV.UF_Value2
					, BMUV.UF_Value3
					, BMUV.UF_Value4
					, BMUV.UF_Value5
					, BMUV.UF_Value6
					, BMUV.UF_Value7
					, BMUV.UF_Value8
					, BMUV.UF_Value9
					</if>
					FROM board_message BM
					JOIN COVI_SMART4J.SYS_OBJECT_FOLDER A on BM.FolderID= A.FolderID
					<if test='useUserForm == "Y"'>
					LEFT OUTER JOIN board_message_userform_value AS BMUVF ON (BM.MessageID = BMUVF.MessageID AND BM.Version = BMUVF.Version AND BMUVF.FolderID = #{folderID})
					LEFT OUTER JOIN (
						SELECT 
							MessageID, FolderID, Version,
							MAX(IF(rnum=1, FieldValue, NULL)) AS UF_Value0,
							MAX(IF(rnum=2, FieldValue, NULL)) AS UF_Value1,
							MAX(IF(rnum=3, FieldValue, NULL)) AS UF_Value2,
							MAX(IF(rnum=4, FieldValue, NULL)) AS UF_Value3,
							MAX(IF(rnum=5, FieldValue, NULL)) AS UF_Value4,
							MAX(IF(rnum=6, FieldValue, NULL)) AS UF_Value5,
							MAX(IF(rnum=7, FieldValue, NULL)) AS UF_Value6,
							MAX(IF(rnum=8, FieldValue, NULL)) AS UF_Value7,
							MAX(IF(rnum=9, FieldValue, NULL)) AS UF_Value8,
							MAX(IF(rnum=10, FieldValue, NULL)) AS UF_Value9
						FROM board_userform_value A
				  LEFT	JOIN (
				  		SELECT UserFormID,ROW_NUMBER() OVER(ORDER BY SortKey, UserFormID) AS rnum
						  FROM board_userform b  	
						 WHERE FolderID = #{folderID} 	
						   AND IsList = 'Y'
						   AND DeleteDate IS null
						  ) b ON (a.UserFormID = b.userformId)
					   WHERE a.FolderID = #{folderID}
					GROUP BY MessageID, FolderID, Version
					) BMUV ON (BM.MessageID = BMUV.MessageID AND BM.Version = BMUV.Version AND BMUV.FolderID = #{folderID})
					</if>
					LEFT OUTER JOIN board_category AS BC ON BM.CategoryID = BC.CategoryID AND BC.FolderID = BM.FolderID
					LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = BM.MessageID AND BMA.Version = BM.Version
					<if test="multiCategory != null and multiCategory != ''">
						INNER JOIN (
							SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
							FROM covi_smart4j.board_userform_value
							GROUP BY MessageID, Version
							HAVING 1=1
							<foreach collection="multiCategoryList" item="multiCategory" index="index">
								AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
							</foreach>
						) AS UFV ON UFV.MessageID = BM.MessageID AND UFV.Version = BM.Version
					</if>
					<!-- 보안등급 및 열람권한 체크 -->
					<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
					LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
									 FROM (
										SELECT SRA.ObjectID, SRA.MessageID
										FROM covi_smart4j.sys_read_acl AS SRA
										WHERE SRA.ObjectType = 'FD'
										AND SRA.TargetType = 'UR'
										AND SRA.TargetCode = #{userCode}
										UNION
										SELECT SRA.ObjectID, SRA.MessageID
										FROM covi_smart4j.sys_read_acl AS SRA
										WHERE SRA.ObjectType = 'FD'
										AND SRA.TargetType != 'UR'
										AND SRA.TargetCode IN
										<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
								            #{item}
									    </foreach>
									) AS SRA) SRA ON BM.FolderID = SRA.ObjectID AND BM.MessageID = SRA.MessageID
					</if>					
					<!-- LEFT OUTER JOIN board_progressstate AS BP ON BM.progressstate = BP.StateID --> 
					WHERE 1=1
					AND BM.DeleteDate IS NULL
					AND BM.MsgState IN ('C', 'A') 
					AND BM.MsgType != 'S' 
					<!-- UseSecurity가 Y일때 게시일 경우에는 작성자만 조회할 수 있음 -->
					AND (
						UseSecurity != 'Y'
						OR (
							UseSecurity = 'Y'
							AND (
								#{bizSection} = 'Board' AND CreatorCode = #{userCode}
								OR #{bizSection} = 'Doc'
							)
						)
					)
					AND (ExpiredDate IS NULL OR ExpiredDate >= #{localCurrentDate} ) 
					AND (ReservationDate IS NULL OR ReservationDate &lt; #{localCurrentDate})
					<if test="folderType != null and folderType == 'OneToOne'">
					    AND (BM.OwnerCode = #{userCode} OR (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = #{folderID}) LIKE CONCAT('%',#{userCode},';%'))
					</if>
	<!-- 				<if test="bizSection == 'Doc'"> -->
						AND BM.IsCurrent = 'Y'
	<!-- 				</if> -->
					<if test="readSearchType != null and readSearchType != ''">
				       <!-- CHECK: 읽음/읽음 조회 설정 -->
				       AND BM.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
				    </if>
				    <!-- 보안등급 및 열람권한 체크 -->
					<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
				       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
				                 ELSE CASE WHEN (BM.SecurityLevel = '256' OR BM.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
				                	  ELSE 'N' END
				                 END) = 'Y'
				              		                		  
				       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
				                 ELSE CASE WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
							     		   WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
							     		   ELSE 'N' END
							     END) = 'Y'
			    	</if>
				    <!-- 검색어 항목 -->
					<if test="searchText != null and searchText != ''">
						<choose>
					        <when test="searchType == 'Total'">
					            AND ( Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%') )
					       	</when>
					       	<when test="searchType == 'Mobile'">
					       	    AND ( Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%')  || CreatorName LIKE CONCAT('%',#{searchText},'%') )
					       	</when>
					       	<when test="searchType == 'UserForm'">
								AND 
								<choose>
									<when test='ufColumn.equalsIgnoreCase("UF_Value1")'>BMUVF.UF_Value1 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value2")'>BMUVF.UF_Value2 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value3")'>BMUVF.UF_Value3 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value4")'>BMUVF.UF_Value4 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value5")'>BMUVF.UF_Value5 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value6")'>BMUVF.UF_Value6 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value7")'>BMUVF.UF_Value7 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value8")'>BMUVF.UF_Value8 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value9")'>BMUVF.UF_Value9 </when>
									<otherwise>BMUVF.UF_Value0 </otherwise>
								</choose>
								LIKE CONCAT('%',#{searchText},'%')
					       	</when>
					       	<when test="searchType == 'Tag'">
					            AND  ( SELECT GROUP_CONCAT(Tag SEPARATOR ',') FROM board_message_tag WHERE MessageID = BM.MessageID GROUP BY Version ORDER BY Version DESC LIMIT 0,1 ) 
					            		LIKE CONCAT('%',#{searchText},'%')  
					       	</when>
					       	<otherwise>
								AND 
								<choose>
									<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
									<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
									<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
									<otherwise>BM.Subject </otherwise>
								</choose>
								LIKE CONCAT('%',#{searchText},'%')
					       	</otherwise>
						</choose>
					</if>
					<if test="startDate != '' or endDate != ''">
						AND BM.RegistDate between #{startDate} and #{endDate}
					</if>
					<!-- CHECK: 권한체크, 열람권한 체크 -->
					<!-- AND (BM.IsMessageReadAuth='Y' AND BM.MessageID IN (SELECT MessageID FROM Fn_ComMessageReadAclCheck_T('Board', @DN_Code, @GR_Code, #{userCode})) OR (BM.IsMessageReadAuth='N')) -->
					<if test="categoryID != null and categoryID != ''">
				        <choose>
					    	<when test="categoryGubun == 'Y'">
					    	    AND (BC.MemberOf = #{categoryID} OR BC.CategoryID = #{categoryID})
					        </when>
					        <otherwise>
					            AND BM.CategoryID = #{categoryID}
					        </otherwise>
					    </choose>
				    </if>
					<choose>
						<when test="bizSection == 'Doc' and grCode != null and grCode != ''">
						    AND A.FolderType = #{bizSection}
							AND BM.RegistDept = #{grCode}
						</when>
						<otherwise>
							AND BM.FolderID = #{folderID}
						</otherwise>
					</choose>
				<if test="bizSection == 'Doc' and (grCode == null or grCode == '')">
					UNION ALL
					
					SELECT DISTINCT BM.*, BMF.FolderID AS F_FolderID, A.MenuID, A.FolderPath, BC.CategoryPath, A.OwnerCode AS 'A_OwnerCode', 'SUB' AS MultiFolderType<!-- , BP.DisplayName -->
					,(CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
					<if test='useUserForm == "Y"'>
					, BMUV.UF_Value0
					, BMUV.UF_Value1
					, BMUV.UF_Value2
					, BMUV.UF_Value3
					, BMUV.UF_Value4
					, BMUV.UF_Value5
					, BMUV.UF_Value6
					, BMUV.UF_Value7
					, BMUV.UF_Value8
					, BMUV.UF_Value9
					</if>
					FROM board_message BM
					LEFT OUTER JOIN board_message_folder AS BMF ON BMF.MessageID = BM.MessageID AND BMF.Version = BM.Version
					JOIN COVI_SMART4J.SYS_OBJECT_FOLDER A on BM.FolderID= A.FolderID
					<if test='useUserForm == "Y"'>
					LEFT OUTER JOIN board_message_userform_value AS BMUV ON (BM.MessageID = BMUV.MessageID AND BM.Version = BMUV.Version) AND BMUV.FolderID = #{folderID}
					</if>
					LEFT OUTER JOIN board_category AS BC ON BM.CategoryID = BC.CategoryID AND BC.FolderID = BM.FolderID
					LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = BM.MessageID AND BMA.Version = BM.Version
					<if test="multiCategory != null and multiCategory != ''">
						INNER JOIN (
							SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
							FROM covi_smart4j.board_userform_value
							GROUP BY MessageID, Version
							HAVING 1=1
							<foreach collection="multiCategoryList" item="multiCategory" index="index">
								AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
							</foreach>
						) AS UFV ON UFV.MessageID = BM.MessageID AND UFV.Version = BM.Version
					</if>
					<!-- 보안등급 및 열람권한 체크 -->
					<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
					LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
									 FROM (
										SELECT SRA.ObjectID, SRA.MessageID
										FROM covi_smart4j.sys_read_acl AS SRA
										WHERE SRA.ObjectType = 'FD'
										AND SRA.TargetType = 'UR'
										AND SRA.TargetCode = #{userCode}
										UNION
										SELECT SRA.ObjectID, SRA.MessageID
										FROM covi_smart4j.sys_read_acl AS SRA
										WHERE SRA.ObjectType = 'FD'
										AND SRA.TargetType != 'UR'
										AND SRA.TargetCode IN
										<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
								            #{item}
									    </foreach>
									) AS SRA) SRA ON BM.FolderID = SRA.ObjectID AND BM.MessageID = SRA.MessageID
					</if>					
					<!-- LEFT OUTER JOIN board_progressstate AS BP ON BM.progressstate = BP.StateID --> 
					WHERE BMF.FolderID = #{folderID}
					AND BM.DeleteDate IS NULL
					AND BM.MsgState IN ('C', 'A')
					AND BM.MsgType != 'S' 
					<!-- UseSecurity가 Y일때 게시일 경우에는 작성자만 조회할 수 있음 -->
					AND (
						UseSecurity != 'Y'
						OR (
							UseSecurity = 'Y'
							AND (
								#{bizSection} = 'Board' AND CreatorCode = #{userCode}
								OR #{bizSection} = 'Doc'
							)
						)
					)
					AND (ExpiredDate IS NULL OR ExpiredDate >= #{localCurrentDate} ) 
					AND (ReservationDate IS NULL OR ReservationDate &lt; #{localCurrentDate})
					<if test="folderType != null and folderType == 'OneToOne'">
					    AND (BM.OwnerCode = #{userCode} OR (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = #{folderID}) LIKE CONCAT('%',#{userCode},';%'))
					</if>
	<!-- 				<if test="bizSection == 'Doc'"> -->
						AND BM.IsCurrent = 'Y'
	<!-- 				</if> -->
					<if test="readSearchType != null and readSearchType != ''">
				       <!-- CHECK: 읽음/읽음 조회 설정 -->
				       AND BM.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
				    </if>
				    <!-- 보안등급 및 열람권한 체크 -->
					<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
				       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
				                 ELSE CASE WHEN (BM.SecurityLevel = '256' OR BM.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
				                	  ELSE 'N' END
				                 END) = 'Y'
				              		                		  
				       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
				                 ELSE CASE WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
							     		   WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
							     		   ELSE 'N' END
							     END) = 'Y'
				    </if>
				    <!-- 검색어 항목 -->
					<if test="searchText != null and searchText != ''">
						<choose>
					        <when test="searchType == 'Total'">
					            AND ( Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%') )
					       	</when>
					       	<when test="searchType == 'Mobile'">
					       	    AND ( Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%')  || CreatorName LIKE CONCAT('%',#{searchText},'%') )
					       	</when>
					       	<when test="searchType == 'UserForm'">
								AND 
								<choose>
									<when test='ufColumn.equalsIgnoreCase("UF_Value1")'>BMUV.UF_Value1 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value2")'>BMUV.UF_Value2 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value3")'>BMUV.UF_Value3 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value4")'>BMUV.UF_Value4 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value5")'>BMUV.UF_Value5 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value6")'>BMUV.UF_Value6 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value7")'>BMUV.UF_Value7 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value8")'>BMUV.UF_Value8 </when>
									<when test='ufColumn.equalsIgnoreCase("UF_Value9")'>BMUV.UF_Value9 </when>
									<otherwise>BMUV.UF_Value0 </otherwise>
								</choose>
								LIKE CONCAT('%',#{searchText},'%')
					       	</when>
					       	<when test="searchType == 'Tag'">
					            AND  ( SELECT GROUP_CONCAT(Tag SEPARATOR ',') FROM board_message_tag WHERE MessageID = BM.MessageID GROUP BY Version ORDER BY Version DESC LIMIT 0,1 ) 
					            		LIKE CONCAT('%',#{searchText},'%')  
					       	</when>
					       	<otherwise>
								AND 
								<choose>
									<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
									<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
									<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
									<otherwise>BM.Subject </otherwise>
								</choose>
								LIKE CONCAT('%',#{searchText},'%')
					       	</otherwise>
						</choose>	
					</if>
					<if test="startDate != '' or endDate != ''">
						AND BM.RegistDate between #{startDate} and #{endDate}
					</if>		
					<!-- CHECK: 권한체크, 열람권한 체크 -->
					<!-- AND (BM.IsMessageReadAuth='Y' AND BM.MessageID IN (SELECT MessageID FROM Fn_ComMessageReadAclCheck_T('Board', @DN_Code, @GR_Code, #{userCode})) OR (BM.IsMessageReadAuth='N')) -->
					<if test="categoryID != null and categoryID != ''">
				        <choose>
					    	<when test="categoryGubun == 'Y'">
					    	    AND (BC.MemberOf = #{categoryID} OR BC.CategoryID = #{categoryID})
					        </when>
					        <otherwise>
					            AND BM.CategoryID = #{categoryID}
					        </otherwise>
					    </choose>
				    </if>
				</if>
			) AS BM
			<trim prefix="ORDER BY"  prefixOverrides =",">
				<if test='useTopNotice == "Y"'>
					ListTop ASC,
				</if>
				<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
					<choose>
						<when test='sortColumn.equalsIgnoreCase("FileCnt")'>FileCnt</when>
						<when test='sortColumn.equalsIgnoreCase("CategoryName")'>CategoryName</when>
						<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
						<when test='sortColumn.equalsIgnoreCase("LinkURL")'>LinkURL</when>
						<when test='sortColumn.equalsIgnoreCase("CreatorName")'>CreatorName</when>
						<when test='sortColumn.equalsIgnoreCase("RegistDate")'>RegistDate</when>
						<when test='sortColumn.equalsIgnoreCase("ReadCnt")'>ReadCnt</when>
						<when test='sortColumn.equalsIgnoreCase("UF_Value0")'>UF_Value0</when>
						<when test='sortColumn.equalsIgnoreCase("UF_Value1")'>UF_Value1</when>
						<when test='sortColumn.equalsIgnoreCase("UF_Value2")'>UF_Value2</when>
						<when test='sortColumn.equalsIgnoreCase("UF_Value3")'>UF_Value3</when>
						<when test='sortColumn.equalsIgnoreCase("UF_Value4")'>UF_Value4</when>
						<when test='sortColumn.equalsIgnoreCase("UF_Value5")'>UF_Value5</when>
						<when test='sortColumn.equalsIgnoreCase("UF_Value6")'>UF_Value6</when>
						<when test='sortColumn.equalsIgnoreCase("UF_Value7")'>UF_Value7</when>
						<when test='sortColumn.equalsIgnoreCase("UF_Value9")'>UF_Value9</when>
						<when test='sortColumn.equalsIgnoreCase("Version")'>Version</when>
						<when test='sortColumn.equalsIgnoreCase("Number")'>Number</when>
						<when test='sortColumn.equalsIgnoreCase("IsCheckOut")'>IsCheckOut</when>
						<when test='sortColumn.equalsIgnoreCase("RegistDept")'>RegistDept</when>
						<when test='sortColumn.equalsIgnoreCase("OwnerName")'>OwnerName</when>
						<when test='sortColumn.equalsIgnoreCase("RevisionDate")'>RevisionDate</when>
						<otherwise>MessageID</otherwise>
					</choose>
					<choose>
						<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
						<otherwise> DESC</otherwise>
					</choose>,
				</if>
				Seq DESC, Step ASC
			</trim>
			<if test="pageSize != null and pageOffset != null">
				LIMIT #{pageSize} OFFSET #{pageOffset}
			</if>
		) a, (SELECT @rownum := #{pageOffset}) AS SWT_TabRow 
    </select>
    
	<!-- 폴더/게시판 외의 게시글 목록 조회: 나의 게시 메뉴 하위 항목 및 승인 게시판 -->
	<select id="selectMessageGridCount" resultType="java.lang.Long">
	/* user.message.selectMessageGridCount */
		SELECT COUNT(0) FROM (
			SELECT BM.*
			FROM( 
				SELECT DISTINCT
				A.MessageID ,A.Version
				,A.Number 
				,A.FolderID 
				,A.IsInherited	,A.ParentID
				,H.DisplayName AS FolderName
				,H.MenuID
				,(CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
				<choose>
			    	<when test="boardType == 'RequestModify'">
			    	    ,M.RequestID						<!-- 수정요청 ID -->
			    	    ,M.RequestMessage					<!-- 수정요청 사유 -->
			    	    ,M.RequestorCode					<!-- 수정요청자 -->
			    	    ,Fn_BaseGetDictionary_S(#{lang}, M.RequestorName) AS RequestorName	<!-- 이름 -->
			    	    , (SELECT MailAddress FROM sys_object_user WHERE UserCode = M.RequestorCode) AS RequestorMailAddress
			    	    ,DATE_FORMAT(M.RequestDate,'%Y.%m.%d %H:%i:%s') AS RequestDate		<!-- 수정요청 일자 -->
			    	    ,M.AnswererCode						<!-- 답변/처리자 ID -->
			    	    , (SELECT MailAddress FROM sys_object_user WHERE UserCode = M.AnswererCode) AS AnswererMailAddress
			    	    ,Fn_BaseGetDictionary_S(#{lang}, M.AnswererName) AS AnswererName	<!-- 답변/처리자 이름 -->
			    	    ,M.AnswerContent					<!-- 답변 처리 코멘트 -->
			    	    ,DATE_FORMAT(M.AnswerDate, '%Y.%m.%d %H:%i:%s')	AS AnswerDate		<!-- 답변 일자 -->
			    	    ,M.RequestStatus					<!-- 처리 상태 -->
			    	</when>
			    	<when test="boardType == 'Approval'">
			    	    , F.ProcessID AS ProcessID
						, F.ProcessDefID AS ProcessDefID 
						, F.State AS ProcessState 
						, F.RegistDate AS ProcessRegistDate
						, F.RegisterCode AS ProcessRegisterCode
						, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID AND State = 1 AND ActorCode = #{userCode}) AS State
						, (SELECT State FROM sys_process_activity WHERE ActorCode = #{userCode} and ProcessID = F.ProcessID and ActorRole = 'Register') AS ActivityState
						, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID) AS TotalApproverCnt
						, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID AND State IN (7,9)) AS TotalApprovalCnt 
			    	</when>
			    	<when test="boardType == 'DocAuth'">
			    	    , DRA.RequestID
			    	    , DRA.RegisterCode AS RequestorCode
			    	    , DRA.RequestMessage
			    	    , DATE_FORMAT(DRA.RequestDate, '%Y.%m.%d %H:%i:%s') AS RequestDate
			    	    , DRA.AclList AS RequestAclList
			    	    , DRA.ActType
			    	</when>
		    	</choose>
				FROM board_message AS A
				INNER JOIN sys_object_folder AS H ON A.FolderID = H.FolderID AND H.IsUse = 'Y' AND H.DeleteDate IS NULL
				LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = A.MessageID AND BMA.Version = A.Version
				<choose>
			    	<when test="boardType == 'MyInterest'"> <!-- 전 즐겨찾기 -->
			    	    INNER JOIN board_message_favorite AS J ON A.MessageID=J.MessageID AND J.RegisterCode=#{userCode}
			    	</when>
			    	<when test="boardType == 'RequestModify'">
			    	    INNER JOIN board_request_modify AS M ON (A.MessageID=M.MessageID AND M.RequestStatus != 'Deleted')
			    	</when>
			    	<when test="boardType == 'Approval'">
			    	    <if test="boxType == 'Request'">	<!-- boxType: Request, Receive......Caller, Callee로 할까 -->
							INNER JOIN sys_process AS F ON A.MessageID=F.MessageID AND F.ObjectType=#{bizSection}
						</if>
						<if test="boxType == 'Receive'">
							INNER JOIN sys_process AS F ON A.MessageID=F.MessageID AND F.ObjectType=#{bizSection} 
							AND F.ProcessID IN (SELECT DISTINCT ProcessID FROM sys_process_activity WHERE ActorCode = #{userCode} AND ActorRole != 'Register' )
						</if>
			    	</when>
			    	<when test="boardType == 'DocAuth'">
			    	    <if test="boxType == 'Request'">
			    	        INNER JOIN doc_request_acl AS DRA ON A.MessageID=DRA.MessageID AND A.Version=DRA.Version AND DRA.RegisterCode = #{userCode}
			    	    </if>
			    	    <if test="boxType == 'Receive'">
							INNER JOIN doc_request_acl AS DRA ON A.MessageID=DRA.MessageID AND A.Version=DRA.Version AND DRA.ActorCode = #{userCode}
						</if>
			    	</when>
			    	<when test="boardType == 'CheckIn' or boardType == 'CheckOut'">
			    	    LEFT OUTER JOIN (SELECT MAX(HistoryID) AS HistoryID, MessageID, MAX(Version) AS Version, CO_Code, ActType FROM doc_inout_history WHERE DeleteDate IS NULL GROUP BY MessageID, CO_Code, ActType) AS DIH 
						ON (A.MessageID = DIH.MessageID AND A.Version = DIH.Version)
			    	</when>
			    	<when test="boardType == 'DocTotal' and searchFolderIDs != null and searchFolderIDs != ''">
			    	    INNER JOIN (
							SELECT MessageID, Version
							, CONCAT(';', GROUP_CONCAT(FolderID SEPARATOR ';'), ';') AS FolderIDs
							FROM (
								SELECT MessageID, Version, FolderID
								FROM board_message_folder
								WHERE 1=1
								<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
									AND FolderID IN 
									<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
										#{searchFolderID}
									</foreach>
								</if>
								
								UNION
								
								SELECT MessageID, Version, FolderID
								FROM board_message
								WHERE 1=1
								<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
									AND FolderID IN 
									<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
										#{searchFolderID}
									</foreach>
								</if>
							) A
							GROUP BY MessageID, Version
							HAVING 1=1
							<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
								<foreach collection="searchFolderIDArr" item="searchFolderID" index="index">
									AND FolderIDs LIKE CONCAT('%;', #{searchFolderID}, ';%')
								</foreach>
							</if>
						) B ON A.MessageID = B.MessageID AND A.Version = B.Version
			    	</when>
		    	</choose>
		    	<if test="multiCategory != null and multiCategory != ''">
					INNER JOIN (
						SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
						FROM covi_smart4j.board_userform_value
						GROUP BY MessageID, Version
						HAVING 1=1
						<foreach collection="multiCategoryList" item="multiCategory" index="index">
							AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
						</foreach>
					) AS UFV ON UFV.MessageID = A.MessageID AND UFV.Version = A.Version
				</if>
				<!-- 보안등급 및 열람권한 체크 -->
				<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
				LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
								 FROM (
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType = 'UR'
									AND SRA.TargetCode = #{userCode}
									UNION
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType != 'UR'
									AND SRA.TargetCode IN
									<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
							            #{item}
								    </foreach>
								) AS SRA) SRA ON A.FolderID = SRA.ObjectID AND A.MessageID = SRA.MessageID
 				</if>
			WHERE 1=1
			AND IsCurrent = 'Y'
	        AND (H.MenuID = #{menuID} OR H.DomainID = 0)
	        <if test='aclDataArr != null and aclDataArr.length != 0'>
				AND H.FolderID IN 
				<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
	        <if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
				AND H.FolderID IN 
				<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
					#{searchFolderID}
				</foreach>
			</if>
			<if test="folderID != null and folderID != ''">
				AND H.FolderID = #{folderID}
			</if>
	        AND H.FolderType != 'QuickComment' <!-- 한줄게시 표시하지 않음 -->
			<if test="bizSection == 'Board'">
			    AND MsgType NOT IN ('N', 'B')
			</if>
			<if test="bizSection == 'Doc'">
			    AND MsgType IN ('N', 'B', 'M')
			</if>
			<if test="isMobileSupport == 'Y'">
			    AND H.isMobileSupport = 'Y'
			</if>
	        <choose>
			    <when test="communityID != null and communityID !=''">
					AND H.ObjectType = 'Community'
				</when>
				<otherwise>
					AND H.ObjectType = #{bizSection}
				</otherwise>
			</choose>
			<include refid="chooseBoardType"/>	<!-- 해당문서 최상단에 boardType 체크 부분 분리 -->
		    <if test="requestStatus != null and requestStatus != ''">
		        <choose>
			    	<when test="requestStatus == 'Ready'">
			    	    AND MsgState IN ('Ready')
			        </when>
			        <when test="requestStatus == 'Process'">
			    	    AND MsgState IN ('Process')
			        </when>
			        <otherwise>
			            AND MsgState IN ('Complete')
			        </otherwise>
			    </choose>
		    </if>
		    <if test="readSearchType != null and readSearchType != ''">
				<!-- CHECK: 읽음/읽음 조회 설정 -->
				AND A.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
		    </if>
		    <!-- 보안등급 및 열람권한 체크 -->
		    <if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
		        AND (CASE WHEN A.OwnerCode = #{userCode} THEN 'Y'
		                  ELSE CASE WHEN (A.SecurityLevel = '256' OR A.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
		                	   		ELSE 'N' END
		                  END) = 'Y'
		              		                		  
		        AND (CASE WHEN A.OwnerCode = #{userCode} THEN 'Y'
		                  ELSE CASE WHEN IFNULL(A.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
					     		    WHEN IFNULL(A.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
					     		    ELSE 'N' END
					      END) = 'Y'
			</if>		    
		    <!-- 검색어 항목 -->
			<if test="searchText != null and searchText != ''">
			    <choose>
			        <when test="searchType == 'Total'">
			            AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%') )
			       	</when>
		     	  	<when test="searchType == 'Mobile'">
		     	  	    AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%')  || CreatorName LIKE CONCAT('%',#{searchText},'%') )
		      	 	</when>
					<when test="searchType == 'Tag'">
			            AND  ( SELECT GROUP_CONCAT(Tag SEPARATOR ',') FROM board_message_tag WHERE MessageID = A.MessageID AND Version = A.Version ) 
			            		LIKE CONCAT('%',#{searchText},'%')  
			       	</when>
			       	<otherwise>
						AND 
						<choose>
							<when test='searchType.equalsIgnoreCase("BodyText")'>A.BodyText </when>
							<when test='searchType.equalsIgnoreCase("CreatorName")'>A.CreatorName </when>
							<when test='searchType.equalsIgnoreCase("Number")'>A.Number </when>
							<otherwise>A.Subject </otherwise>
						</choose>
						LIKE CONCAT('%',#{searchText},'%')   
			       	</otherwise>
				</choose>
			</if>
			<if test="startDate != '' or endDate != ''">
				AND A.RegistDate between #{startDate} and #{endDate}
			</if>
			<choose>
			   	<when test="boardType == 'Approval'">
		    	    <!-- 요청함 -->
		    	    <if test="boxType == 'Request'">	<!-- boxType: Request, Receive......Caller, Callee로 할까 -->
						AND F.RegisterCode = #{userCode}
					</if>
					<!-- 승인함의 경우 approvalStatus selectbox를 통해 승인요청을 받을 게시글을 필터링할 수 있다. -->
		    	    <choose>
				    	<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
				    		AND (MsgState IN ('R', 'BR')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State &gt; 0 -->
				        </when>
				        <when test='approvalStatus == "A"'> <!-- 승인 완료된 게시 -->
				    		AND (MsgState IN ('A', 'BA')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State = 0 -->
				        </when>
				        <when test='approvalStatus == "D"'> <!-- 반려된 게시 -->
				    		AND (MsgState IN ('D')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State = 0 -->
				        </when>
				        <when test='approvalStatus == "P"'> <!-- 다른사람이 결제해야할 승인 요청 게시 -->
				    		AND (MsgState IN ('R')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State = 0 -->
				        </when>
				        <otherwise>
				            AND (MsgState IN ('R', 'D', 'A', 'BR', 'BA')) AND (MsgType IN ('O', 'N', 'B'))
				        </otherwise>
				    </choose>
		    	</when>
		    	<when test="boardType == 'DocAuth'">
		    	    <!-- 요청함 -->
		    	    <if test="boxType == 'Receive'">	<!-- boxType: Request, Receive......Caller, Callee로 할까 -->
						<choose>
					    	<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
					    		AND (ActType IN ('R'))
					        </when>
					        <when test='approvalStatus == "A"'> <!-- 승인 완료된 게시 -->
					    		AND (ActType IN ('D', 'A'))
					        </when>
					        <when test='approvalStatus == "D"'> <!-- 반려된 게시 -->
					    		AND (ActType IN ('D'))
					        </when>
					        <otherwise>
					            
					        </otherwise>
					    </choose>
					</if>
		    	</when>
	    	</choose>
	    	
			<if test="bizSection == 'Doc' and boardType == 'DocTotal'">
			    UNION ALL
			    
			    SELECT DISTINCT
				A.MessageID ,A.Version
				,A.Number 
				,H.FolderID 
				,A.IsInherited	,A.ParentID
				,H.DisplayName AS FolderName
				,H.MenuID
				,(CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
				FROM board_message AS A
				LEFT OUTER JOIN board_message_folder AS BMF ON A.MessageID = BMF.MessageID AND A.Version = BMF.Version
				<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
					AND BMF.FolderID IN 
					<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
						#{searchFolderID}
					</foreach>
				</if>
				INNER JOIN sys_object_folder AS H ON H.FolderID = BMF.FolderID AND H.IsUse = 'Y' AND H.DeleteDate IS NULL
				LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = A.MessageID AND BMA.Version = A.Version
				INNER JOIN (
					SELECT MessageID, Version
					, CONCAT(';', GROUP_CONCAT(FolderID SEPARATOR ';'), ';') AS FolderIDs
					FROM (
						SELECT MessageID, Version, FolderID
						FROM board_message_folder
						WHERE 1=1
						<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
							AND FolderID IN 
							<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
								#{searchFolderID}
							</foreach>
						</if>
						
						UNION
						
						SELECT MessageID, Version, FolderID
						FROM board_message
						WHERE 1=1
						<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
							AND FolderID IN 
							<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
								#{searchFolderID}
							</foreach>
						</if>
					) A
					GROUP BY MessageID, Version
					HAVING 1=1
					<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
						<foreach collection="searchFolderIDArr" item="searchFolderID" index="index">
							AND FolderIDs LIKE CONCAT('%;', #{searchFolderID}, ';%')
						</foreach>
					</if>
				) B ON A.MessageID = B.MessageID AND A.Version = B.Version
				<if test="multiCategory != null and multiCategory != ''">
					INNER JOIN (
						SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
						FROM covi_smart4j.board_userform_value
						GROUP BY MessageID, Version
						HAVING 1=1
						<foreach collection="multiCategoryList" item="multiCategory" index="index">
							AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
						</foreach>
					) AS UFV ON UFV.MessageID = A.MessageID AND UFV.Version = A.Version
				</if>
				<!-- 보안등급 및 열람권한 체크 -->
				<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
				LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
								 FROM (
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType = 'UR'
									AND SRA.TargetCode = #{userCode}
									UNION
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType != 'UR'
									AND SRA.TargetCode IN
									<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
							            #{item}
								    </foreach>
								) AS SRA) SRA ON A.FolderID = SRA.ObjectID AND A.MessageID = SRA.MessageID
				</if>
				WHERE 1=1
				AND IsCurrent = 'Y'
		        AND (H.MenuID = #{menuID} OR H.DomainID = 0)
		        <if test='aclDataArr != null and aclDataArr.length != 0'>
					AND H.FolderID IN 
					<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
						#{item}
					</foreach>
				</if>
				<if test="folderID != null and folderID != ''">
					AND H.FolderID = #{folderID}
				</if>
				<if test="isMobileSupport == 'Y'">
				    AND H.isMobileSupport = 'Y'
				</if>
		        AND H.FolderType != 'QuickComment' <!-- 한줄게시 표시하지 않음 -->
			    AND MsgType IN ('N', 'B', 'M') 
				AND H.ObjectType = #{bizSection}
				<include refid="chooseBoardType"/>	<!-- 해당문서 최상단에 boardType 체크 부분 분리 -->
			    <if test="readSearchType != null and readSearchType != ''">
					<!-- CHECK: 읽음/읽음 조회 설정 -->
					AND A.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
			    </if>
				<!-- 보안등급 및 열람권한 체크 -->
			    <if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
			        AND (CASE WHEN A.OwnerCode = #{userCode} THEN 'Y'
			                  ELSE CASE WHEN (A.SecurityLevel = '256' OR A.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
			                	   		ELSE 'N' END
			                  END) = 'Y'
			              		                		  
			        AND (CASE WHEN A.OwnerCode = #{userCode} THEN 'Y'
			                  ELSE CASE WHEN IFNULL(A.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
						     		    WHEN IFNULL(A.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
						     		    ELSE 'N' END
						      END) = 'Y'
			    </if>
			    <!-- 검색어 항목 -->
				<if test="searchText != null and searchText != ''">
				    <choose>
				        <when test="searchType == 'Total'">
				            AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%') )
				       	</when>
			     	  	<when test="searchType == 'Mobile'">
			     	  	    AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%')  || CreatorName LIKE CONCAT('%',#{searchText},'%') )
			      	 	</when>
				       	<otherwise>
							AND 
							<choose>
								<when test='searchType.equalsIgnoreCase("BodyText")'>A.BodyText </when>
								<when test='searchType.equalsIgnoreCase("CreatorName")'>A.CreatorName </when>
								<when test='searchType.equalsIgnoreCase("Number")'>A.Number </when>
								<otherwise>A.Subject </otherwise>
							</choose>
							LIKE CONCAT('%',#{searchText},'%')
				       	</otherwise>
					</choose>
				</if>
				<if test="startDate != '' or endDate != ''">
					AND A.RegistDate between #{startDate} and #{endDate}
				</if>
			</if>
	    	) AS BM 
	    	WHERE 1 = 1
	    	<if test="boardType == 'Approval' and boxType == 'Receive' and approvalStatus != '' and approvalStatus != null">
	    		<choose>
			    	<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
			    		AND State &gt; 0
			        </when>
			        <otherwise> <!-- 승인 완료된 게시(A), 반려된 게시(D), 다른사람이 결제해야할 승인 요청 게시(진행중)(P)- -->
			            AND State = 0
			        </otherwise>
			    </choose>
	    	</if>
	    ) AS RESULT
	</select>
	
	<!-- 게시글 목록 Grid 데이터 / 게시판 구분에 따라 모든 데이터를 조회하므로 추후 분리 -->
	<select id="selectMessageGridList" parameterType="cmap" resultType="cmap">
	/* user.message.selectMessageGridList */
		SELECT RESULT.*, @rownum:=@rownum+1 RNUM
		FROM (
			SELECT
				BM.MessageID ,BM.Version, BM.Number, BM.FolderID, BM.IsInherited, BM.ParentID
				,BM.MsgType, CASE WHEN IFNULL(BM.DeleteDate, '') = '' THEN BM.MsgState ELSE 'DEL' END as MsgState
				,BM.CategoryID, BM.Seq, BM.Step, BM.Depth, BM.Subject
				,BM.IsPopup, BM.IsTop, BM.PopupStartDate, BM.PopupEndDate
				,BM.TopStartDate	,BM.TopEndDate ,BM.ExpiredDate, BM.ListTop
				,BM.UseSecurity ,BM.UseAnonym ,BM.IsApproval ,BM.IsUserForm
				,BM.IsCheckOut ,BM.UseScrap ,BM.NoticeMedia
				,BM.UseRSS ,BM.TrackBackURL ,BM.TracbackCnt
				,BM.AnswerCnt, BM.ReadCnt, BM.ScrapCnt ,BM.ReportCnt
				,BM.FileCnt ,BM.FileExtension
				,DATE_FORMAT(BM.RegistDate, '%Y.%m.%d %H:%i:%s') AS RegistDate
				,DATE_FORMAT(BM.CreateDate, '%Y.%m.%d %H:%i:%s') AS CreateDate
				,BM.RevisionCode ,BM.RevisionDate AS DocRevisionDate
				,BM.ReservationDate AS BoardReservationDate
				,BM.ProgressState ,BM.CreatorCode , Fn_BaseGetDictionary_S(#{lang}, BM.CreatorName) AS CreatorName
				,BM.CreatorLevel		,BM.CreatorPosition		,BM.CreatorTitle , Fn_BaseGetDictionary_S(#{lang},BM.CreatorDept) AS CreatorDept
				,BM.DeleteDate ,BM.RegistDept ,BM.OwnerCode
				,BM.FolderName ,BM.MenuID
				,(SELECT COUNT(*) 
				 	FROM sys_comment 
				   WHERE DeleteDate IS NULL 
				 	<choose>
						<when test="bizSection != null and bizSection != '' and (bizSection == 'Board' or bizSection == 'Doc' or bizSection == 'Community')">
							AND TargetServiceType IN ('Board', 'Doc', 'Community')
						</when>
						<otherwise>
							AND TargetServiceType = #{bizSection}
						</otherwise>
					</choose>
				 	  AND TargetID = CONCAT(BM.MessageID,'_',BM.Version)) AS CommentCnt  
				,(SELECT COUNT(*) 
					FROM sys_like 
					WHERE 1=1
					 <choose>
						<when test="bizSection != null and bizSection != '' and (bizSection == 'Board' or bizSection == 'Doc' or bizSection == 'Community')">
							AND TargetServiceType IN ('Board', 'Doc', 'Community')
						</when>
						<otherwise>
							AND TargetServiceType = #{bizSection}
						</otherwise>
					</choose> 
					   AND TargetID = CONCAT(BM.MessageID,'_',BM.Version)) AS RecommendCnt
				,(SELECT OwnerCode FROM sys_object_folder WHERE FolderID = BM.FolderID) AS FolderOwnerCode
				<if test="bizSection == 'Board'">
			    	, (SELECT MailAddress FROM sys_object_user WHERE UserCode = BM.CreatorCode) AS MailAddress
				</if>
				<if test="bizSection == 'Doc'">
				    , (SELECT MailAddress FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS MailAddress
				</if>
				<choose>
			    	<when test="boardType == 'RequestModify'">
			    	    ,BM.RequestID		<!-- 수정요청 ID -->
			    	    ,BM.RequestMessage	<!-- 수정요청 사유 -->
			    	    ,BM.RequestorCode	<!-- 수정요청자 -->
			    	    ,BM.RequestorName	<!-- 이름 -->
			    	    ,BM.RequestorMailAddress
			    	    ,BM.RequestDate		<!-- 수정요청 일자 -->
			    	    ,BM.AnswererCode	<!-- 답변/처리자 ID -->
			    	    ,BM.AnswererMailAddress
			    	    ,BM.AnswererName	<!-- 답변/처리자 이름 -->
			    	    ,BM.AnswerContent	<!-- 답변 처리 코멘트 -->
			    	    ,BM.AnswerDate		<!-- 답변 일자 -->
			    	    ,BM.RequestStatus	<!-- 처리 상태 -->
			    	</when>
			    	<when test="boardType == 'Approval'">
			    	    , BM.ProcessID AS ProcessID
						, BM.ProcessDefID AS ProcessDefID 
						, BM.ProcessState 
						, BM.ProcessRegistDate
						, BM.ProcessRegisterCode
						, BM.State
						, BM.ActivityState
						, BM.TotalApproverCnt
						, BM.TotalApprovalCnt 
			    	</when>
			    	<when test="boardType == 'DocAuth'">
			    	    , BM.RequestID
			    	    , BM.RequestorCode
			    	    , BM.RequestorName
			    	    , BM.RequestMessage
			    	    , BM.RequestDate
			    	    , BM.RequestAclList
			    	    , BM.ActType
			    	</when>
			    	<when test="boardType == 'DocTotal'">
			    	    , BM.MultiFolderType
			    	</when>
		    	</choose>		    	
		    	<if test='"OwnerName".equalsIgnoreCase(sortColumn)'>
				, (SELECT Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS OwnerName
				</if>
				<if test='"RegistDeptName".equalsIgnoreCase(sortColumn)'>
				, (SELECT Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName) FROM sys_object_group WHERE groupcode = BM.RegistDept) AS RegistDeptName
				</if>				
				, (SELECT Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.RevisionCode) AS RevisionName
				, BM.SecurityLevel
				, BM.RevisionDate AS RevisionDate
				, DATE_FORMAT(BM.ReservationDate, '%Y.%m.%d %H:%i:%s') AS ReservationDate
				, IF((SELECT COUNT(*) FROM board_message_reader WHERE MessageID = BM.MessageID AND ReaderCode = #{userCode}) > 0, 'Y', 'N' ) AS IsRead
				, IF((SELECT COUNT(*) FROM sys_object_user WHERE UserCode = #{userCode} AND BM.SecurityLevel IS NOT NULL AND BM.SecurityLevel != 256 AND BM.SecurityLevel >= SecurityLevel) > 0, 'Y', 'N') AS IsSecurity
		    	, (SELECT MAX(FileID) FROM sys_file WHERE ObjectType ='FD' AND ObjectID = BM.FolderID AND MessageID = BM.MessageID AND SaveType='IMAGE') AS FileID
			FROM( SELECT DISTINCT
					A.MessageID ,A.Version ,A.Number ,A.FolderID 
					,A.IsInherited	,A.ParentID
					,A.MsgType		,A.MsgState
					,A.CategoryID	,A.Seq		,A.Step		,A.Depth		,A.Subject
					,A.IsPopup		,A.IsTop
					,A.PopupStartDate	,A.PopupEndDate
					,A.TopStartDate	,A.TopEndDate
					,A.ExpiredDate	,A.UseSecurity		,A.UseAnonym 
					,A.IsApproval	,A.IsUserForm		,A.IsCheckOut
					,A.UseScrap 	,A.NoticeMedia		,A.UseRSS
					,A.TrackBackURL,A.TracbackCnt
					,A.AnswerCnt	,A.ReadCnt			,A.ScrapCnt		,A.ReportCnt
					,A.FileCnt		,A.FileExtension
					,A.RegistDate
					,A.RevisionCode 
					, IF(A.RevisionDate IS NULL, DATE_FORMAT(A.RegistDate,'%Y.%m.%d %H:%i:%s'), DATE_FORMAT(A.RevisionDate,'%Y.%m.%d %H:%i:%s')) AS RevisionDate
					,A.ReservationDate
					,A.ProgressState
					,A.CreatorCode	,A.CreateDate
					,IF(A.UsePubDeptName = 'Y', A.CreatorDept, A.CreatorName) AS CreatorName
					,A.CreatorLevel	,A.CreatorPosition	,A.CreatorTitle	,A.CreatorDept
					,A.DeleteDate		,A.RegistDept			,A.OwnerCode, A.SecurityLevel
					,H.DisplayName AS FolderName ,H.MenuID
					,(CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
					<choose>
				    	<when test="boardType == 'RequestModify'">
				    	    ,M.RequestID						<!-- 수정요청 ID -->
				    	    ,M.RequestMessage					<!-- 수정요청 사유 -->
				    	    ,M.RequestorCode					<!-- 수정요청자 -->
				    	    ,Fn_BaseGetDictionary_S(#{lang}, M.RequestorName) AS RequestorName	<!-- 이름 -->
				    	    , (SELECT MailAddress FROM sys_object_user WHERE UserCode = M.RequestorCode) AS RequestorMailAddress
				    	    ,DATE_FORMAT(M.RequestDate,'%Y.%m.%d %H:%i:%s') AS RequestDate		<!-- 수정요청 일자 -->
				    	    ,M.AnswererCode						<!-- 답변/처리자 ID -->
				    	    , (SELECT MailAddress FROM sys_object_user WHERE UserCode = M.AnswererCode) AS AnswererMailAddress
				    	    ,Fn_BaseGetDictionary_S(#{lang}, M.AnswererName) AS AnswererName	<!-- 답변/처리자 이름 -->
				    	    ,M.AnswerContent					<!-- 답변 처리 코멘트 -->
				    	    ,DATE_FORMAT(M.AnswerDate, '%Y.%m.%d %H:%i:%s')	AS AnswerDate		<!-- 답변 일자 -->
				    	    ,M.RequestStatus					<!-- 처리 상태 -->
				    	</when>
				    	<when test="boardType == 'Approval'">
				    	    , F.ProcessID AS ProcessID
							, F.ProcessDefID AS ProcessDefID 
							, F.State AS ProcessState 
							, F.RegistDate AS ProcessRegistDate
							, F.RegisterCode AS ProcessRegisterCode
							, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID AND State = 1 AND ActorCode = #{userCode}) AS State
							, (SELECT State FROM sys_process_activity WHERE ActorCode = #{userCode} and ProcessID = F.ProcessID and ActorRole = 'Register') AS ActivityState
							, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID) AS TotalApproverCnt
							, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID AND State IN (7,9)) AS TotalApprovalCnt 
				    	</when>
				    	<when test="boardType == 'DocAuth'">
				    	    , DRA.RequestID
				    	    , DRA.RegisterCode AS RequestorCode
				    	    ,  (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = DRA.RegisterCode) AS RequestorName
				    	    , DRA.RequestMessage
				    	    , DATE_FORMAT(DRA.RequestDate, '%Y.%m.%d %H:%i:%s') AS RequestDate
				    	    , DRA.AclList AS RequestAclList
				    	    , DRA.ActType
				    	</when>
				    	<when test="boardType == 'DocTotal'">
				    	    , 'ORIGIN' AS MultiFolderType
				    	</when>
			    	</choose>
				FROM board_message AS A
				INNER JOIN sys_object_folder AS H ON A.FolderID = H.FolderID AND H.IsUse = 'Y' AND H.DeleteDate IS NULL
				LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = A.MessageID AND BMA.Version = A.Version
				<choose>
			    	<when test="boardType == 'MyInterest'"> <!-- 전 즐겨찾기 -->
			    	    INNER JOIN board_message_favorite AS J ON A.MessageID=J.MessageID AND J.RegisterCode=#{userCode}
			    	</when>
			    	<!-- 전 관심게시 -->
			    	<when test="boardType == 'RequestModify'">
			    	    INNER JOIN board_request_modify AS M ON (A.MessageID=M.MessageID AND M.RequestStatus != 'Deleted')
			    	</when>
			    	<when test="boardType == 'Approval'">
			    	    <if test="boxType == 'Request'">	<!-- boxType: Request, Receive......Caller, Callee로 할까 -->
							INNER JOIN sys_process AS F ON A.MessageID=F.MessageID AND F.ObjectType=#{bizSection}
						</if>
						<if test="boxType == 'Receive'">
							INNER JOIN sys_process AS F ON A.MessageID=F.MessageID AND F.ObjectType=#{bizSection} 
							AND F.ProcessID IN (SELECT DISTINCT ProcessID FROM sys_process_activity WHERE ActorCode = #{userCode} AND ActorRole != 'Register' )
						</if>
			    	</when>
			    	<when test="boardType == 'DocAuth'">
			    	    <if test="boxType == 'Request'">
			    	        INNER JOIN doc_request_acl AS DRA ON A.MessageID=DRA.MessageID AND A.Version=DRA.Version AND DRA.RegisterCode = #{userCode}
			    	    </if>
			    	    <if test="boxType == 'Receive'">
							INNER JOIN doc_request_acl AS DRA ON A.MessageID=DRA.MessageID AND A.Version=DRA.Version AND DRA.ActorCode = #{userCode}
						</if>
			    	</when>
			    	<when test="boardType == 'CheckIn' or boardType == 'CheckOut'">
			    	    LEFT OUTER JOIN (SELECT MAX(HistoryID) AS HistoryID, MessageID, MAX(Version) AS Version, CO_Code, ActType FROM doc_inout_history WHERE DeleteDate IS NULL GROUP BY MessageID, CO_Code, ActType) AS DIH 
						ON (A.MessageID = DIH.MessageID AND A.Version = DIH.Version)
			    	</when>
			    	<when test="boardType == 'DocTotal' and searchFolderIDs != null and searchFolderIDs != ''">
		    	    	INNER JOIN (
							SELECT MessageID, Version
							, CONCAT(';', GROUP_CONCAT(FolderID SEPARATOR ';'), ';') AS FolderIDs
							FROM (
								SELECT MessageID, Version, FolderID
								FROM board_message_folder
								WHERE 1=1
								<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
									AND FolderID IN 
									<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
										#{searchFolderID}
									</foreach>
								</if>
								
								UNION
								
								SELECT MessageID, Version, FolderID
								FROM board_message
								WHERE 1=1
								<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
									AND FolderID IN 
									<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
										#{searchFolderID}
									</foreach>
								</if>
							) A
							GROUP BY MessageID, Version
							HAVING 1=1
							<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
								<foreach collection="searchFolderIDArr" item="searchFolderID" index="index">
									AND FolderIDs LIKE CONCAT('%;', #{searchFolderID}, ';%')
								</foreach>
							</if>
						) B ON A.MessageID = B.MessageID AND A.Version = B.Version
			    	</when>
		    	</choose>
		    	<if test="multiCategory != null and multiCategory != ''">
					INNER JOIN (
						SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
						FROM covi_smart4j.board_userform_value
						GROUP BY MessageID, Version
						HAVING 1=1
						<foreach collection="multiCategoryList" item="multiCategory" index="index">
							AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
						</foreach>
					) AS UFV ON UFV.MessageID = A.MessageID AND UFV.Version = A.Version
				</if>
				<!-- 보안등급 및 열람권한 체크 -->
				<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
				LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
								 FROM (
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType = 'UR'
									AND SRA.TargetCode = #{userCode}
									UNION
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType != 'UR'
									AND SRA.TargetCode IN
									<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
							            #{item}
								    </foreach>
								) AS SRA) SRA ON A.FolderID = SRA.ObjectID AND A.MessageID = SRA.MessageID
				</if>
			WHERE 1=1
			AND IsCurrent = 'Y'
			<if test="bizSection == 'Board'">
			AND (H.MenuID = #{menuID} OR H.DomainID = 0)
			</if>
			<if test='aclDataArr != null and aclDataArr.length != 0'>
				AND H.FolderID IN 
				<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
			<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
				AND H.FolderID IN 
				<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
					#{searchFolderID}
				</foreach>
			</if>
			<if test="folderID != null and folderID != ''">
				AND H.FolderID = #{folderID}
			</if>
	        AND H.FolderType != 'QuickComment' <!-- 한줄게시 표시하지 않음 -->
			<if test="bizSection == 'Board'">
			    AND MsgType NOT IN ('N', 'B')
			</if>
			<if test="bizSection == 'Doc'">
			    AND MsgType IN ('N', 'B', 'M')
			</if>
			<if test="isMobileSupport == 'Y'">
			    AND H.isMobileSupport = 'Y'
			</if>
	        <choose>
			    <when test="communityID != null and communityID !=''">
					AND H.ObjectType = 'Community'
				</when>
				<otherwise>
					AND H.ObjectType = #{bizSection}
				</otherwise>
			</choose>
			<include refid="chooseBoardType"/>	<!-- 해당문서 최상단에 boardType 체크 부분 분리 -->
		    <if test="requestStatus != null and requestStatus != ''">
		        <choose>
			    	<when test="requestStatus == 'Ready'">
			    	    AND MsgState IN ('Ready')
			        </when>
			        <when test="requestStatus == 'Process'">
			    	    AND MsgState IN ('Process')
			        </when>
			        <otherwise>
			            AND MsgState IN ('Complete')
			        </otherwise>
			    </choose>
		    </if>
		    <if test="readSearchType != null and readSearchType != ''">
				<!-- CHECK: 읽음/읽음 조회 설정 -->
				AND A.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
		    </if>
		    <!-- 보안등급 및 열람권한 체크 -->
		    <if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
		        AND (CASE WHEN A.OwnerCode = #{userCode} THEN 'Y'
		                  ELSE CASE WHEN (A.SecurityLevel = '256' OR A.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
		                	  		ELSE 'N' END
		                  END) = 'Y'
		              		                		  
		        AND (CASE WHEN A.OwnerCode = #{userCode} THEN 'Y'
		                  ELSE CASE WHEN IFNULL(A.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
					     		   	WHEN IFNULL(A.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
					     		   	ELSE 'N' END
					      END) = 'Y'
		    </if>
		    <!-- 검색어 항목 -->
			<if test="searchText != null and searchText != ''">
			    <choose>
			        <when test="searchType == 'Total'">
			            AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%') )
			       	</when>
		      	 	<when test="searchType == 'Mobile'">
		     	  	    AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%')  || CreatorName LIKE CONCAT('%',#{searchText},'%') )
		  	     	</when>
		  	     	<when test="searchType == 'Tag'">
			            AND  ( SELECT GROUP_CONCAT(Tag SEPARATOR ',') FROM board_message_tag WHERE MessageID = A.MessageID AND Version = A.Version ) 
			            		LIKE CONCAT('%',#{searchText},'%')  
			       	</when>
			       	<when test="searchType == 'Tag'">
			            AND  ( SELECT GROUP_CONCAT(Tag SEPARATOR ',') FROM board_message_tag WHERE MessageID = A.MessageID AND Version = A.Version ) 
			            		LIKE CONCAT('%',#{searchText},'%')  
			       	</when>
			       	<otherwise>
						AND 
						<choose>
							<when test='searchType.equalsIgnoreCase("BodyText")'>A.BodyText </when>
							<when test='searchType.equalsIgnoreCase("CreatorName")'>A.CreatorName </when>
							<when test='searchType.equalsIgnoreCase("Number")'>A.Number </when>
							<otherwise>A.Subject </otherwise>
						</choose>
						LIKE CONCAT('%',#{searchText},'%')   
			       	</otherwise>
				</choose>
			</if>
			<if test="startDate != '' or endDate != ''">
				AND A.RegistDate between #{startDate} and #{endDate}
			</if>
			<choose>
			   	<when test="boardType == 'Approval'">
		    	    <!-- 요청함 -->
		    	    <if test="boxType == 'Request'">	<!-- boxType: Request, Receive......Caller, Callee로 할까 -->
						AND F.RegisterCode = #{userCode}
					</if>
					<!-- 승인함의 경우 approvalStatus selectbox를 통해 승인요청을 받을 게시글을 필터링할 수 있다. -->
		    	    <choose>
				    	<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
				    		AND (MsgState IN ('R', 'BR')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State &gt; 0 -->
				        </when>
				        <when test='approvalStatus == "A"'> <!-- 승인 완료된 게시 -->
				    		AND (MsgState IN ('A', 'BA')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State = 0 -->
				        </when>
				        <when test='approvalStatus == "D"'> <!-- 반려된 게시 -->
				    		AND (MsgState IN ('D')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State = 0 -->
				        </when>
				        <when test='approvalStatus == "P"'> <!-- 다른사람이 결제해야할 승인 요청 게시 -->
				    		AND (MsgState IN ('R')) AND (MsgType IN ('O', 'N', 'B'))  <!-- AND State = 0 -->
				        </when>
				        <otherwise>
				            AND (MsgState IN ('R', 'D', 'A', 'BR', 'BA')) AND (MsgType IN ('O', 'N', 'B'))
				        </otherwise>
				    </choose>
		    	</when>
		    	<when test="boardType == 'DocAuth'">
		    	    <!-- 요청함 -->
		    	    <if test="boxType == 'Receive'">	<!-- boxType: Request, Receive......Caller, Callee로 할까 -->
						<choose>
					    	<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
					    		AND (ActType IN ('R'))
					        </when>
					        <when test='approvalStatus == "A"'> <!-- 승인 완료된 게시 -->
					    		AND (ActType IN ('D', 'A'))
					        </when>
					        <when test='approvalStatus == "D"'> <!-- 반려된 게시 -->
					    		AND (ActType IN ('D'))
					        </when>
					        <otherwise>
					            
					        </otherwise>
					    </choose>
					</if>
		    	</when>
	    	</choose>
	    	
			<if test="bizSection == 'Doc' and boardType == 'DocTotal'">
			    UNION ALL
			    
			    SELECT DISTINCT
					A.MessageID ,A.Version ,A.Number ,H.FolderID 
					,A.IsInherited	,A.ParentID
					,A.MsgType		,A.MsgState
					,A.CategoryID	,A.Seq		,A.Step		,A.Depth		,A.Subject
					,A.IsPopup		,A.IsTop
					,A.PopupStartDate	,A.PopupEndDate
					,A.TopStartDate	,A.TopEndDate
					,A.ExpiredDate	,A.UseSecurity		,A.UseAnonym 
					,A.IsApproval	,A.IsUserForm		,A.IsCheckOut
					,A.UseScrap 	,A.NoticeMedia		,A.UseRSS
					,A.TrackBackURL,A.TracbackCnt
					,A.AnswerCnt	,A.ReadCnt			,A.ScrapCnt		,A.ReportCnt
					,A.FileCnt		,A.FileExtension
					,A.RegistDate
					,A.RevisionCode 
					, IF(A.RevisionDate IS NULL, DATE_FORMAT(A.RegistDate,'%Y.%m.%d %H:%i:%s'), DATE_FORMAT(A.RevisionDate,'%Y.%m.%d %H:%i:%s')) AS RevisionDate
					,A.ReservationDate
					,A.ProgressState
					,A.CreatorCode	,A.CreateDate
					,IF(A.UsePubDeptName = 'Y', A.CreatorDept, A.CreatorName) AS CreatorName
					,A.CreatorLevel	,A.CreatorPosition	,A.CreatorTitle	,A.CreatorDept
					,A.DeleteDate		,A.RegistDept			,A.OwnerCode, A.SecurityLevel
					,H.DisplayName AS FolderName ,H.MenuID
					,(CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
					,'SUB' AS MultiFolderType
				FROM board_message AS A
				LEFT OUTER JOIN board_message_folder AS BMF ON A.MessageID = BMF.MessageID AND A.Version = BMF.Version
				<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
					AND BMF.FolderID IN 
					<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
						#{searchFolderID}
					</foreach>
				</if>
				INNER JOIN sys_object_folder AS H ON H.FolderID = BMF.FolderID AND H.IsUse = 'Y' AND H.DeleteDate IS NULL
				LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = A.MessageID AND BMA.Version = A.Version
				INNER JOIN (
					SELECT MessageID, Version
					, CONCAT(';', GROUP_CONCAT(FolderID SEPARATOR ';'), ';') AS FolderIDs
					FROM (
						SELECT MessageID, Version, FolderID
						FROM board_message_folder
						WHERE 1=1
						<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
							AND FolderID IN 
							<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
								#{searchFolderID}
							</foreach>
						</if>
						
						UNION
						
						SELECT MessageID, Version, FolderID
						FROM board_message
						WHERE 1=1
						<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
							AND FolderID IN 
							<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
								#{searchFolderID}
							</foreach>
						</if>
					) A
					GROUP BY MessageID, Version
					HAVING 1=1
					<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
						<foreach collection="searchFolderIDArr" item="searchFolderID" index="index">
							AND FolderIDs LIKE CONCAT('%;', #{searchFolderID}, ';%')
						</foreach>
					</if>
				) B ON A.MessageID = B.MessageID AND A.Version = B.Version
				<if test="multiCategory != null and multiCategory != ''">
					INNER JOIN (
						SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
						FROM covi_smart4j.board_userform_value
						GROUP BY MessageID, Version
						HAVING 1=1
						<foreach collection="multiCategoryList" item="multiCategory" index="index">
							AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
						</foreach>
					) AS UFV ON UFV.MessageID = A.MessageID AND UFV.Version = A.Version
				</if>
				<!-- 보안등급 및 열람권한 체크 -->
				<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
				LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
								 FROM (
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType = 'UR'
									AND SRA.TargetCode = #{userCode}
									UNION
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType != 'UR'
									AND SRA.TargetCode IN
									<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
							            #{item}
								    </foreach>
								) AS SRA) SRA ON A.FolderID = SRA.ObjectID AND A.MessageID = SRA.MessageID
				</if>				
				WHERE 1=1
				AND IsCurrent = 'Y'
				AND (H.MenuID = #{menuID} OR H.DomainID = 0)
				<if test='aclDataArr != null and aclDataArr.length != 0'>
					AND H.FolderID IN 
					<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
						#{item}
					</foreach>
				</if>
				<if test="folderID != null and folderID != ''">
					AND H.FolderID = #{folderID}
				</if>
		        AND H.FolderType != 'QuickComment' <!-- 한줄게시 표시하지 않음 -->
			    AND MsgType IN ('N', 'B', 'M')
				AND H.ObjectType = #{bizSection}
				<include refid="chooseBoardType"/>	<!-- 해당문서 최상단에 boardType 체크 부분 분리 -->
			    <if test="readSearchType != null and readSearchType != ''">
					<!-- CHECK: 읽음/읽음 조회 설정 -->
					AND A.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
			    </if>
			    <if test="isMobileSupport == 'Y'">
				    AND H.isMobileSupport = 'Y'
				</if>
			    <!-- 보안등급 및 열람권한 체크 -->
			    <if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
			        AND (CASE WHEN A.OwnerCode = #{userCode} THEN 'Y'
			                  ELSE CASE WHEN (A.SecurityLevel = '256' OR A.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
			                	  		ELSE 'N' END
			                  END) = 'Y'
			              		                		  
			        AND (CASE WHEN A.OwnerCode = #{userCode} THEN 'Y'
			                  ELSE CASE WHEN IFNULL(A.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
						     		   	WHEN IFNULL(A.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
						     		   	ELSE 'N' END
						      END) = 'Y'
			    </if>
			    <!-- 검색어 항목 -->
				<if test="searchText != null and searchText != ''">
				    <choose>
				        <when test="searchType == 'Total'">
				            AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%') )
				       	</when>
			      	 	<when test="searchType == 'Mobile'">
			     	  	    AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%')  || CreatorName LIKE CONCAT('%',#{searchText},'%') )
			  	     	</when>
				       	<otherwise>
							AND 
							<choose>
								<when test='searchType.equalsIgnoreCase("BodyText")'>A.BodyText </when>
								<when test='searchType.equalsIgnoreCase("CreatorName")'>A.CreatorName </when>
								<when test='searchType.equalsIgnoreCase("Number")'>A.Number </when>
								<otherwise>A.Subject </otherwise>
							</choose>
							LIKE CONCAT('%',#{searchText},'%')
				       	</otherwise>
					</choose>
				</if>
				<if test="startDate != '' or endDate != ''">
					AND A.RegistDate between #{startDate} and #{endDate}
				</if>
			</if>
		) AS BM
		LEFT OUTER JOIN sys_object_user AS B ON (CASE WHEN BM.MsgType='S' THEN BM.OwnerCode ELSE BM.CreatorCode END) = B.UserCode
<!-- 		LEFT OUTER JOIN board_category AS BC ON BM.CategoryID = BC.CategoryID AND BC.FolderID = BM.FolderID -->
<!-- 		LEFT OUTER JOIN BOARD_PROGRESSSTATE as P ON BM.progressstate = P.StateID -->
		WHERE 1=1
		<!-- 카테고리별 검색 기능 사용시 참조 -->
	    <if test="categoryID != null and categoryID != ''">
	        <choose>
		    	<when test="categoryGubun == 'Y'">
		    	    AND (C.MemberOf = #{categoryID} OR C.CategoryID = #{categoryID})
		        </when>
		        <otherwise>
		            AND BM.CategoryID = #{categoryID}
		        </otherwise>
		    </choose>
	    </if>
	    <if test="boardType == 'Approval' and boxType == 'Receive' and approvalStatus != '' and approvalStatus != null ">
    		<choose>
		    	<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
		    		AND State &gt; 0
		        </when>
		        <otherwise> <!-- 승인 완료된 게시(A), 반려된 게시(D), 다른사람이 결제해야할 승인 요청 게시(진행중)(P)- -->
		            AND State = 0
		        </otherwise>
		    </choose>
	    </if>
	   	) AS RESULT
	   	, (SELECT @rownum := #{pageOffset}) AS SWT_TabRow
	   	WHERE 1=1
	   	<trim prefix="ORDER BY" prefixOverrides =",">
			<if test='useTopNotice == "Y"'>
				ListTop ASC,
			</if>
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("FileCnt")'>(FileCnt + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("FolderName")'>FolderName</when>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("CreatorName")'>CreatorName</when>
					<when test='sortColumn.equalsIgnoreCase("RegistDate")'>RegistDate</when>
					<when test='sortColumn.equalsIgnoreCase("Version")'>Version</when>
					<when test='sortColumn.equalsIgnoreCase("Number")'>Number</when>
					<when test='sortColumn.equalsIgnoreCase("IsCheckOut")'>IsCheckOut</when>
					<when test='sortColumn.equalsIgnoreCase("RegistDept")'>RegistDept</when>
					<when test='sortColumn.equalsIgnoreCase("RegistDeptName")'>RegistDeptName</when>
					<when test='sortColumn.equalsIgnoreCase("OwnerName")'>OwnerName</when>
					<when test='sortColumn.equalsIgnoreCase("RevisionDate")'>RevisionDate</when>
					<when test='sortColumn.equalsIgnoreCase("MsgState")'>MsgState</when>
					<when test='sortColumn.equalsIgnoreCase("ReadCnt")'>(ReadCnt + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("ReservationDate")'>ReservationDate</when>
					<when test='sortColumn.equalsIgnoreCase("RequestMessage")'>RequestMessage</when>
					<when test='sortColumn.equalsIgnoreCase("RequestorName")'>RequestorName</when>
					<when test='sortColumn.equalsIgnoreCase("RequestDate")'>RequestDate</when>
					<when test='sortColumn.equalsIgnoreCase("AnswerContent")'>AnswerContent</when>
					<when test='sortColumn.equalsIgnoreCase("RequestStatus")'>RequestStatus</when>
					<when test='sortColumn.equalsIgnoreCase("ActType")'>ActType</when>
					<otherwise>MessageID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>,
			</if>
			Seq Desc, depth, step ASC
		</trim>
		<!-- paging query LIMIT {가져오는 로우수} OFFSET {몇번째 로우부터인지} -->
	    <if test="pageSize != null and pageOffset != null">
	   		LIMIT #{pageSize} OFFSET #{pageOffset}
	   	</if>
	</select>
	
	<!-- 폴더/게시판 외의 게시글 목록 개수 조회 -->
	<select id="selectSearchMessageGridCount" resultType="java.lang.Long">
		SELECT COUNT(*) FROM (
			SELECT DISTINCT
				  BM.MessageID
				, BM.MsgState
				, BM.MsgType
				, H.FolderID
			FROM board_message AS BM
			INNER JOIN sys_object_folder AS H ON BM.FolderID = H.FolderID AND H.IsUse = 'Y' AND H.DeleteDate IS NULL
			LEFT OUTER JOIN sys_object_user AS B ON (CASE WHEN BM.MsgType='S' THEN BM.OwnerCode ELSE BM.CreatorCode END) = B.UserCode
			LEFT OUTER JOIN board_category AS BC ON BM.CategoryID = BC.CategoryID AND BC.FolderID = BM.FolderID
			LEFT OUTER JOIN BOARD_PROGRESSSTATE as P ON BM.progressstate = P.StateID
			LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = BM.MessageID AND BMA.Version = BM.Version
			WHERE 1=1
			AND IsCurrent = 'Y'
			AND (H.MenuID = #{menuID} OR H.DomainID = 0)
			<if test='aclDataArr != null and aclDataArr.length != 0'>
				AND H.FolderID IN 
				<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
			AND H.FolderType != 'QuickComment' <!-- 한줄게시 표시하지 않음 -->
			AND BM.RegistDate &lt; NOW(3)
			AND BM.MsgState IN ('C', 'A')
			AND MsgType != 'S' 
			AND IF(H.FolderType = 'OneToOne', BM.OwnerCode = #{userCode} OR (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = BM.FolderID) LIKE CONCAT('%',#{userCode},';%') , 1=1)
			<!-- UseSecurity가 Y일때 게시일 경우에는 작성자만 조회할 수 있음 -->
			AND (
				UseSecurity != 'Y'
				OR (
					UseSecurity = 'Y'
					AND (
						#{bizSection} = 'Board' AND CreatorCode = #{userCode}
						OR #{bizSection} = 'Doc'
					)
				)
			)
			AND (ExpiredDate IS NULL OR  ExpiredDate >= #{localCurrentDate} ) 
			AND BM.DeleteDate IS NULL
			<choose>
				<when test="communityID != null and communityID !=''">
					AND H.ObjectType = 'Community'
				</when>
				<otherwise>
					AND H.ObjectType = #{bizSection}
				</otherwise>
			</choose>
			<if test="bizSection == 'Board'">
				AND MsgType NOT IN ('N', 'B')
			</if>
			<if test="bizSection == 'Doc'">
				AND MsgType IN ('N', 'B', 'M')
			</if>
			<!-- 검색어 항목 -->
			<if test="searchText != null and searchText != ''">
				<if test="searchType == 'Total'">
					AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
				</if>
				<if test="searchType == 'Mobile'">
					AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
				</if>
			</if>
		) AS RESULT
		WHERE 1=1
	</select>
	
	<!-- 게시글 목록 Grid 데이터 -->
	<select id="selectSearchMessageGridList" parameterType="cmap" resultType="cmap">
		SELECT * FROM (
			SELECT DISTINCT
				  BM.MessageID
				, BM.Version
				, BM.Number 
				, BM.FolderID 
				, H.DisplayName AS FolderName
				, BM.IsInherited
				, BM.ParentID
				, BM.MsgType
				, BM.MsgState
				, BM.CategoryID
				, BC.CategoryPath AS CategoryPaths 
				, H.FolderPath
				, BM.Seq
				, BM.Step
				, BM.Depth
				, BM.Subject
				, BM.IsPopup
				, BM.IsTop
				, BM.PopupStartDate
				, BM.PopupEndDate
				, BM.TopStartDate
				, BM.TopEndDate
				, BM.ExpiredDate
				, BM.UseSecurity
				, BM.UseAnonym 
				, BM.IsApproval
				, BM.IsUserForm
				, BM.IsCheckOut
				, BM.UseScrap
				, BM.NoticeMedia
				, BM.UseRSS
				, BM.TrackBackURL
				, BM.AnswerCnt
				, BM.ReadCnt
				, BM.ScrapCnt
				, BM.ReportCnt
				, (SELECT COUNT(*) 
				 	 FROM sys_comment 
				 	WHERE DeleteDate IS NULL 
				 	<choose>
						<when test="bizSection != null and bizSection != '' and (bizSection == 'Board' or bizSection == 'Doc' or bizSection == 'Community')">
							AND TargetServiceType IN ('Board', 'Doc', 'Community')
						</when>
						<otherwise>
							AND TargetServiceType = #{bizSection}
						</otherwise>
					</choose>
				 	  AND TargetID = CONCAT(BM.MessageID,'_',BM.Version)) AS CommentCnt 
				, (SELECT COUNT(*) 
					 FROM sys_like 
					 WHERE 1=1
					 <choose>
						<when test="bizSection != null and bizSection != '' and (bizSection == 'Board' or bizSection == 'Doc' or bizSection == 'Community')">
							AND TargetServiceType IN ('Board', 'Doc', 'Community')
						</when>
						<otherwise>
							AND TargetServiceType = #{bizSection}
						</otherwise>
					</choose> 
					   AND TargetID = CONCAT(BM.MessageID,'_',BM.Version)) AS RecommendCnt
				, BM.FileCnt ,BM.FileExtension
				, BM.TracbackCnt
				, DATE_FORMAT(BM.RegistDate, '%Y.%m.%d %H:%i:%s') AS RegistDate
				, BM.CreatorCode 
				, B.DisplayName 
				, DATE_FORMAT(BM.CreateDate, '%Y-%m-%d %H:%i:%s') AS CreateDate
				, IF(BM.UsePubDeptName = 'Y', Fn_BaseGetDictionary_S(#{lang},BM.CreatorDept), Fn_BaseGetDictionary_S(#{lang},BM.CreatorName)) AS CreatorName
				, BM.CreatorLevel
				, BM.CreatorPosition
				, BM.CreatorTitle
				, Fn_BaseGetDictionary_S(#{lang}, BM.CreatorDept) AS CreatorDept
				, BM.DeleteDate
				, BM.OwnerCode
				, BM.RegistDept
				, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_group WHERE groupcode = BM.RegistDept) AS RegistDeptName
				, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.RevisionCode) AS RevisionName
				, IF(BM.RevisionDate IS NULL, DATE_FORMAT(BM.RegistDate,'%Y.%m.%d %H:%i:%s'), DATE_FORMAT(BM.RevisionDate,'%Y.%m.%d %H:%i:%s')) AS RevisionDate
				, BM.ReservationDate
				, (CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
			FROM board_message AS BM
			INNER JOIN sys_object_folder AS H ON BM.FolderID = H.FolderID AND H.IsUse = 'Y' AND H.DeleteDate IS NULL
			LEFT OUTER JOIN sys_object_user AS B ON (CASE WHEN BM.MsgType='S' THEN BM.OwnerCode ELSE BM.CreatorCode END) = B.UserCode
			LEFT OUTER JOIN board_category AS BC ON BM.CategoryID = BC.CategoryID AND BC.FolderID = BM.FolderID
			LEFT OUTER JOIN BOARD_PROGRESSSTATE as P ON BM.progressstate = P.StateID
			LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = BM.MessageID AND BMA.Version = BM.Version
			WHERE 1=1
			AND IsCurrent = 'Y'
			AND (H.MenuID = #{menuID} OR H.DomainID = 0)
			<if test='aclDataArr != null and aclDataArr.length != 0'>
				AND H.FolderID IN 
				<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
			AND H.FolderType != 'QuickComment' <!-- 한줄게시 표시하지 않음 -->
			AND BM.RegistDate &lt; NOW(3)
			AND BM.MsgState IN ('C', 'A')
			AND MsgType != 'S' 
			AND IF(H.FolderType = 'OneToOne', BM.OwnerCode = #{userCode} OR (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = BM.FolderID) LIKE CONCAT('%',#{userCode},';%') , 1=1)
			<!-- UseSecurity가 Y일때 게시일 경우에는 작성자만 조회할 수 있음 -->
			AND (
				UseSecurity != 'Y'
				OR (
					UseSecurity = 'Y'
					AND (
						#{bizSection} = 'Board' AND CreatorCode = #{userCode}
						OR #{bizSection} = 'Doc'
					)
				)
			)
			AND (ExpiredDate IS NULL OR  ExpiredDate >= #{localCurrentDate} ) 
			AND BM.DeleteDate IS NULL
			<choose>
				<when test="communityID != null and communityID !=''">
					AND H.ObjectType = 'Community'
				</when>
				<otherwise>
					AND H.ObjectType = #{bizSection}
				</otherwise>
			</choose>
			<if test="bizSection == 'Board'">
				AND MsgType NOT IN ('N', 'B')
			</if>
			<if test="bizSection == 'Doc'">
				AND MsgType IN ('N', 'B', 'M')
			</if>
			<!-- 검색어 항목 -->
			<if test="searchText != null and searchText != ''">
				<if test="searchType == 'Total'">
					AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
				</if>
				<if test="searchType == 'Mobile'">
					AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
				</if>
			</if>
	   	) AS RESULT
		WHERE 1=1
		<trim prefix="ORDER BY"  prefixOverrides =",">
			<if test='useTopNotice == "Y"'>
				ListTop ASC,
			</if>
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("FileCnt")'>(FileCnt + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("FolderName")'>FolderName</when>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("Number")'>Number</when>
					<when test='sortColumn.equalsIgnoreCase("CreatorName")'>CreatorName</when>
					<when test='sortColumn.equalsIgnoreCase("RegistDate")'>RegistDate</when>
					<when test='sortColumn.equalsIgnoreCase("ReadCnt")'>(ReadCnt + 0)</when>
					<otherwise>MessageID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>,
			</if>
			Seq DESC, depth, step ASC
		</trim>
		<!-- paging query LIMIT {가져오는 로우수} OFFSET {몇번째 로우부터인지} -->
		<if test="pageSize != null and pageOffset != null">
			LIMIT #{pageSize} OFFSET #{pageOffset}
		</if>
	</select>
 	
 	<select id="selectDistributeGridCount" resultType="java.lang.Long">
 	    SELECT COUNT(*) FROM (
	 	    SELECT DDC.ConfirmType
				,DDC.DistributeID
				,DD.`Version` AS DistributeVersion
				,DD.DistributeMsg
				,DD.DistributeDate
				,DD.RegisterCode AS DistributeCode
				,SOU.MultiDisplayName
				,BM.FolderID
				,BM.MessageID
				,BM.`Version`
				,BM.IsInherited
				,BM.MsgType
				,BM.Subject
				,BM.Number
				,BM.IsCheckOut
				,BM.RevisionDate
				,BM.CheckOuterCode
				,BM.OwnerCode
				,(SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS OwnerName
			FROM doc_distribution_confirm AS DDC
			INNER JOIN doc_distribution AS DD ON (DDC.DistributeID = DD.DistributeID)
			INNER JOIN board_message AS BM ON (BM.MessageID = DD.MessageID)
			INNER JOIN sys_object_folder AS SOF ON (SOF.FolderID = BM.FolderID)
			LEFT OUTER JOIN sys_object_user AS SOU ON (DD.RegisterCode = SOU.UserCode)
			WHERE BM.MsgState IN ('C', 'A') 
			AND BM.IsCurrent = 'Y' 
			AND (BM.DeleteDate IS NULL) 
			AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate} )  
			AND DDC.UserCode = #{userCode}
			<!-- 검색어 항목 -->
		    <if test="searchText != null and searchText != ''">
				<choose>
			        <when test="searchType == 'Total'">
			            AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
			       	</when>
		       		<when test="searchType == 'Mobile'">
		      	 	    AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
		      	 	</when>
			       	<otherwise>
						AND 
						<choose>
							<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
							<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
							<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
							<otherwise>BM.Subject </otherwise>
						</choose>
						LIKE CONCAT('%',#{searchText},'%')   
			       	</otherwise>
				</choose>
			</if>
			<if test="startDate != '' or endDate != ''">
				AND DD.DistributeDate between #{startDate} and #{endDate}		
			</if>
		) AS RESULT
	   	WHERE 1=1
 	</select>
 	
 	<!-- 배포문서 수신함 -->
 	<select id="selectDistributeGridList" parameterType="cmap" resultType="cmap">
 	    SELECT * FROM (
	 	    SELECT DDC.ConfirmType
				,DDC.DistributeID
				,DD.`Version` AS DistributeVersion
				,DD.DistributeMsg
				,DATE_FORMAT(DD.DistributeDate,'%Y.%m.%d %H:%i:%s')AS DistributeDate 
				,DATE_FORMAT(DD.DistributeDate,'%Y.%m.%d %H:%i:%s')AS RegistDate 
				,DD.RegisterCode AS DistributerCode
				, (SELECT MailAddress FROM sys_object_user WHERE UserCode = DD.RegisterCode) AS MailAddress
				,(SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = DD.RegisterCode) AS DistributerName
				,SOU.MultiDisplayName
				,BM.FolderID
				,BM.MessageID
				,BM.`Version`
				,BM.IsInherited
				,BM.MsgType
				,BM.Subject
				,BM.Number
				,BM.IsCheckOut
				,DATE_FORMAT(BM.RevisionDate,'%Y.%m.%d %H:%i:%s')AS RevisionDate 
				,BM.CheckOuterCode
				,BM.OwnerCode
				, BM.FileCnt
				, BM.ReadCnt 
				, (SELECT COUNT(*) FROM sys_comment WHERE DeleteDate IS NULL AND TargetServiceType='Doc' AND TargetID = CONCAT(BM.MessageID,'_',BM.Version))AS CommentCnt 
				, (SELECT COUNT(*) FROM sys_like WHERE TargetServiceType='Doc' AND TargetID = CONCAT(BM.MessageID,'_',BM.Version))AS RecommendCnt
				,(SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS OwnerName
			FROM doc_distribution_confirm AS DDC
			INNER JOIN doc_distribution AS DD ON (DDC.DistributeID = DD.DistributeID)
			INNER JOIN board_message AS BM ON (BM.MessageID = DD.MessageID)
			INNER JOIN sys_object_folder AS SOF ON (SOF.FolderID = BM.FolderID)
			LEFT OUTER JOIN sys_object_user AS SOU ON (DD.RegisterCode = SOU.UserCode)
			WHERE BM.MsgState IN ('C', 'A') 
			AND BM.IsCurrent = 'Y' 
			AND (BM.DeleteDate IS NULL) 
			AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate} )  
			AND DDC.UserCode = #{userCode}
			<!-- 검색어 항목 -->
		    <if test="searchText != null and searchText != ''">
				<choose>
			        <when test="searchType == 'Total'">
			            AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
			       	</when>
		   	    	<when test="searchType == 'Mobile'">
		   	    	    AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
		     	  	</when>
			       	<otherwise>
						AND 
						<choose>
							<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
							<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
							<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
							<otherwise>BM.Subject </otherwise>
						</choose>
						LIKE CONCAT('%',#{searchText},'%')   
			       	</otherwise>
				</choose>
			</if>
			<if test="startDate != '' or endDate != ''">
				AND DD.DistributeDate between #{startDate} and #{endDate}		
			</if>
		) AS RESULT
	   	WHERE 1=1
	   	<trim prefix="ORDER BY"  prefixOverrides =",">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Version")'>(Version + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("Number")'>Number</when>
					<when test='sortColumn.equalsIgnoreCase("IsCheckOut")'>IsCheckOut</when>
					<when test='sortColumn.equalsIgnoreCase("DistributerName")'>DistributerName</when>
					<when test='sortColumn.equalsIgnoreCase("DistributeMsg")'>DistributeMsg</when>
					<otherwise>DistributeDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<!-- paging query LIMIT {가져오는 로우수} OFFSET {몇번째 로우부터인지} -->
	    <if test="pageSize != null and pageOffset != null">
	   		LIMIT #{pageSize} OFFSET #{pageOffset}
	   	</if>
 	</select>
 	
 	<!-- 배포문서 배포함 -->
 	<select id="selectDistributeSendGridCount" resultType="java.lang.Long">
 	    SELECT COUNT(*) FROM (
	 	    SELECT DD.`Version` AS DistributeVersion
				,DD.DistributeMsg
				,DD.DistributeDate
				,DD.RegisterCode AS DistributerCode
				,SOU.MultiDisplayName
				,BM.FolderID
				,BM.MessageID
				,BM.`Version`
				,BM.IsInherited
				,BM.MsgType
				,BM.Subject
				,BM.Number
				,BM.IsCheckOut
				,BM.RevisionDate
				,BM.CheckOuterCode
				,BM.OwnerCode
				,(SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS OwnerName
			FROM doc_distribution AS DD 
			INNER JOIN board_message AS BM ON (BM.MessageID = DD.MessageID)
			INNER JOIN sys_object_folder AS SOF ON (SOF.FolderID = BM.FolderID)
			INNER JOIN sys_object_user AS SOU ON (BM.OwnerCode = SOU.UserCode)
			WHERE BM.MsgState IN ('C', 'A') 
			AND BM.IsCurrent = 'Y' 
			AND (BM.DeleteDate IS NULL) 
			AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate} ) 
			AND DD.RegisterCode = #{userCode}
			<!-- 검색어 항목 -->
		    <if test="searchText != null and searchText != ''">
				<choose>
			        <when test="searchType == 'Total'">
			            AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
			       	</when>
		       		<when test="searchType == 'Mobile'">
		    	   	    AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
		     	  	</when>			       	
			       	<otherwise>
						AND 
						<choose>
							<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
							<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
							<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
							<otherwise>BM.Subject </otherwise>
						</choose>
						LIKE CONCAT('%',#{searchText},'%')   
			       	</otherwise>
				</choose>
			</if>
			<if test="startDate != '' or endDate != ''">
				AND DD.DistributeDate between #{startDate} and #{endDate}		
			</if>
		) AS RESULT
	   	WHERE 1=1
 	</select>
 	
 	<select id="selectDistributeSendGridList" parameterType="cmap" resultType="cmap">
 	    SELECT * FROM (
	 	    SELECT DD.`Version` AS DistributeVersion
				,DD.DistributeMsg
				,DATE_FORMAT(DD.DistributeDate,'%Y.%m.%d %H:%i:%s')AS DistributeDate 
				,DATE_FORMAT(DD.DistributeDate,'%Y.%m.%d %H:%i:%s')AS RegistDate 
				,DD.RegisterCode AS DistributerCode
				,(SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = DD.RegisterCode) AS DistributerName
				,SOU.MultiDisplayName
				,BM.FolderID
				,BM.MessageID
				,BM.`Version`
				,BM.IsInherited
				,BM.MsgType
				,BM.Subject
				,BM.Number
				,BM.IsCheckOut
				,DATE_FORMAT(BM.RevisionDate,'%Y.%m.%d %H:%i:%s')AS RevisionDate
				,BM.CheckOuterCode
				,BM.OwnerCode
				,(SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS OwnerName
				,(SELECT COUNT(*) FROM doc_distribution_confirm WHERE DistributeID = DD.DistributeID AND ConfirmType ='Read') AS DocReadCnt	
				,(SELECT COUNT(*) FROM doc_distribution_confirm WHERE DistributeID = DD.DistributeID) AS DisCnt
				, BM.FileCnt
				, BM.ReadCnt 
				, (SELECT COUNT(*) FROM sys_comment WHERE DeleteDate IS NULL AND TargetServiceType='Doc' AND TargetID = CONCAT(BM.MessageID,'_',BM.Version))AS CommentCnt 
				, (SELECT COUNT(*) FROM sys_like WHERE TargetServiceType='Doc' AND TargetID = CONCAT(BM.MessageID,'_',BM.Version))AS RecommendCnt
			FROM doc_distribution AS DD 
			INNER JOIN board_message AS BM ON (BM.MessageID = DD.MessageID)
			INNER JOIN sys_object_folder AS SOF ON (SOF.FolderID = BM.FolderID)
			INNER JOIN sys_object_user AS SOU ON (BM.OwnerCode = SOU.UserCode)
			WHERE BM.MsgState IN ('C', 'A') 
			AND BM.IsCurrent = 'Y' 
			AND (BM.DeleteDate IS NULL) 
			AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate} ) 
			AND DD.RegisterCode = #{userCode}
			<!-- 검색어 항목 -->
		    <if test="searchText != null and searchText != ''">
				<choose>
			        <when test="searchType == 'Total'">
			            AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
			       	</when>
		      	 	<when test="searchType == 'Mobile'">
		      	 	    AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
		     	  	</when>
			       	<otherwise>
						AND 
						<choose>
							<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
							<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
							<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
							<otherwise>BM.Subject </otherwise>
						</choose>
						LIKE CONCAT('%',#{searchText},'%')   
			       	</otherwise>
				</choose>
			</if>
			<if test="startDate != '' or endDate != ''">
				AND DD.DistributeDate between #{startDate} and #{endDate}		
			</if>
		) AS RESULT
	   	WHERE 1=1
	   	<trim prefix="ORDER BY"  prefixOverrides =",">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Version")'>(Version + 0)</when>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("Number")'>Number</when>
					<when test='sortColumn.equalsIgnoreCase("IsCheckOut")'>IsCheckOut</when>
					<when test='sortColumn.equalsIgnoreCase("DistributeMsg")'>DistributeMsg</when>
					<otherwise>DistributeDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<!-- paging query LIMIT {가져오는 로우수} OFFSET {몇번째 로우부터인지} -->
	    <if test="pageSize != null and pageOffset != null">
	   		LIMIT #{pageSize} OFFSET #{pageOffset}
	   	</if>
 	</select>
 	
 	<select id="selectProcessActivityList" parameterType="cmap" resultType="cmap">
 	    SELECT State, 
 	    	ActivityType, 
 	    	ActorRole, 
 	    	Fn_BaseGetDictionary_S(#{lang}, ActorName) AS ActorName, 
 	    	IFNULL(DATE_FORMAT(CompleteDate,'%Y.%m.%d'), '-') AS CompleteDate 
 	    FROM sys_process_activity 
 	    WHERE ProcessID = #{processID}
 	    ORDER BY Step, SubStep asc
 	</select>
 	
 	<!-- FIXED : 조회자 목록 Grid 데이터 관련 기존데이터와 맞는 유저정보가 없으므로 조건항목을 삭제하여 여러건 표시 -->
 	<select id="selectMessageViewerGridCount" resultType="java.lang.Long">
 	    SELECT COUNT(*)
		FROM (
			SELECT  MessageID, ReaderCode, ReadDate
			FROM board_message_reader
			WHERE MessageID = #{messageID}
			<!-- WHERE MessageID = 22 -->			<!-- FIXED -->
			)	AS BMR
		INNER JOIN sys_object_user AS SOU ON (SOU.UserCode = BMR.ReaderCode)
<!-- 		INNER JOIN sys_object_user_basegroup AS SOUB ON (SOU.UserCode = SOUB.UserCode) -->
 	</select>
 	
 	<select id="selectMessageViewerGridList" parameterType="cmap" resultType="cmap">
 	    SELECT * FROM (
	 	    SELECT  
				BMR.ReaderCode AS ReaderCode,
				BMR.MessageID AS MessageID, 
				SOU.DisplayName AS DisplayName,
	 			SOUB.DeptName AS DeptName,
 				SOUB.JobPositionName AS JobPositionName,
				DATE_FORMAT(BMR.ReadDate,'%Y.%m.%d %H:%i') AS ReadDate,
				SOU.PhotoPath AS ReaderPhoto
			FROM (
				SELECT  MessageID, ReaderCode, ReadDate
				FROM board_message_reader
				WHERE MessageID = #{messageID}
				)	AS BMR
			INNER JOIN sys_object_user AS SOU ON (SOU.UserCode = BMR.ReaderCode)
	 		INNER JOIN sys_object_user_basegroup AS SOUB ON (SOU.UserCode = SOUB.UserCode)
	 		WHERE SOUB.JobType = 'Origin'
		) AS RESULT
		WHERE 1=1
		<trim prefix="ORDER BY"  prefixOverrides =",">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("JobPositionName")'>JobPositionName</when>
					<when test='sortColumn.equalsIgnoreCase("DeptName")'>DeptName</when>
					<when test='sortColumn.equalsIgnoreCase("ReadDate")'>ReadDate</when>
					<when test='sortColumn.equalsIgnoreCase("Version")'>(Version + 0)</when>
					<otherwise>DisplayName</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="pageSize != null and pageOffset != null">
	   		LIMIT #{pageSize} OFFSET #{pageOffset}
	   	</if>
 	</select>
 	
 	<!-- 조회자 목록 Grid 데이터 관련 기존데이터와 맞는 유저정보가 없으므로 조건항목을 삭제하여 여러건 표시 -->
 	<select id="selectMessageHistoryGridCount" resultType="java.lang.Long">
 	    SELECT COUNT(BMH.MessageID)
		FROM board_message_history AS BMH
		LEFT OUTER JOIN sys_object_user AS SOU ON (BMH.RegisterCode = SOU.UserCode)
		LEFT OUTER JOIN sys_object_user_basegroup AS SOUB ON (BMH.RegisterCode = SOUB.UserCode)
		WHERE BMH.MessageID = #{messageID}
 	</select>
 	
 	<select id="selectMessageHistoryGridList" parameterType="cmap" resultType="cmap">
 	    SELECT * FROM (
	 	    SELECT BMH.MessageID
				,BMH.HistoryType
				,BMH.`Comment`
				,BMH.RegistIP
				,BMH.RegistDate
				,BMH.RegisterCode
				,SOU.DisplayName
				,SOUB.DeptName
			FROM board_message_history AS BMH
			LEFT OUTER JOIN sys_object_user AS SOU ON (BMH.RegisterCode = SOU.UserCode)
			LEFT OUTER JOIN sys_object_user_basegroup AS SOUB ON (BMH.RegisterCode = SOUB.UserCode)
			WHERE BMH.MessageID = #{messageID}
		) AS RESULT
		WHERE 1=1
		<trim prefix="ORDER BY" prefixOverrides =",">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
	 			<choose>
					<when test='sortColumn.equalsIgnoreCase("HistoryType")'>HistoryType</when>
					<when test='sortColumn.equalsIgnoreCase("Comment")'>Comment_</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("DeptName")'>DeptName</when>
					<otherwise>RegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
			<if test="sortColumn == null or sortColumn == '' or sortDirection == null or sortDirection =='' ">
				RegistDate ASC
			</if>
		</trim>
		<!-- paging query LIMIT {가져오는 로우수} OFFSET {몇번째 로우부터인지} -->
	    <if test="pageSize != null and pageOffset != null">
	   		LIMIT #{pageSize} OFFSET #{pageOffset}
	   	</if>
 	</select>
 	
 	<select id="selectCheckInHistoryGridCount" parameterType="cmap" resultType="java.lang.Long">
 	    SELECT COUNT(0)
		FROM doc_inout_history AS DIOH
		WHERE 1=1
		AND DIOH.MessageID = #{messageID}
<!-- 		AND DIOH.Version = #{version} -->
		AND DIOH.DeleteDate IS NULL
 	</select>
 	
 	<!-- 게시글 익명게시 설정 정보 -->
 	<select id="selectPrevAnonyFlag" parameterType="cmap" resultType="String">
 	    SELECT IFNULL(UseAnonym, 'N') 
 	    FROM board_message 
 	    WHERE MessageID = #{messageID} 
 	    AND `Version` = #{version}
 	</select>
 	
 	<!-- 원본글 찾성자 정보 표시 -->
 	<select id="selectCreatorCode" parameterType="cmap" resultType="String">
 	    SELECT IFNULL(CreatorCode, #{userCode})
 	    FROM board_message
 	    WHERE MessageID = #{messageID} 
 	    AND `Version` = #{version}
 	</select>
 	
 	<select id="selectCheckInHistoryGridList" parameterType="cmap" resultType="cmap">
 	    SELECT * FROM (
	 	    SELECT DIOH.HistoryID
	 	    	,DIOH.`Version`
				,DIOH.ActType
				,DIOH.Msg AS `Comment`
				,IFNULL(DIOH.CI_Date, '') AS CI_Date
				,IFNULL(DIOH.CO_Date, '') AS CO_Date
				,DIOH.CO_Code AS ActorCode
				,Fn_BaseGetDictionary_S(#{lang}, SOU.MultiDisplayName) AS ActorName
			FROM doc_inout_history AS DIOH
			LEFT OUTER JOIN sys_object_user AS SOU ON (DIOH.CO_Code = SOU.UserCode)
			WHERE 1=1
			AND DIOH.MessageID = #{messageID}
<!-- 			AND DIOH.Version = #{version} -->
			AND DIOH.DeleteDate IS NULL
		) AS RESULT
		WHERE 1=1
		<trim prefix="ORDER BY" prefixOverrides=",">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("ActType")'>ActType</when>
					<when test='sortColumn.equalsIgnoreCase("CO_Date")'>CO_Date</when>
					<when test='sortColumn.equalsIgnoreCase("CI_Date")'>CI_Date</when>
					<when test='sortColumn.equalsIgnoreCase("Comment")'>Comment</when>
					<when test='sortColumn.equalsIgnoreCase("ActorName")'>ActorName</when>
					<otherwise>Version</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<!-- paging query LIMIT {가져오는 로우수} OFFSET {몇번째 로우부터인지} -->
	    <if test="pageSize != null and pageOffset != null">
	   		LIMIT #{pageSize} OFFSET #{pageOffset}
	   	</if>
 	</select>
 	
 	<!-- 하위 게시물 조회 -->
 	<select id="selectLowerMessageID" parameterType="cmap" resultType="cmap">
 	    SELECT GROUP_CONCAT(MessageID SEPARATOR ',') AS messageIDs FROM board_message,
		        (SELECT @pv := #{messageID}) initialisation
		WHERE FIND_IN_SET(ParentID, @pv) > 0
		AND @pv := concat(@pv, ',', MessageID)
 	</select>
 	
 	
 	<insert id="createFavorite" parameterType="cmap">
 	    INERT board_interest(RegisterCode, FolderID, RegistDate)
 	    VALUES (#{userCode}, #{folderID}, NOW(3))
 	    
 	</insert>
 	
 	<delete id="deleteFavorite" parameterType="cmap">
 	    DELETE FROM board_interest 
 	    WHERE RegisterCode = #{userCode} 
 	    AND FolderID IN
 	    <foreach item="item" index="index" collection="folderIDs" open="(" close=")" separator=",">
            #{item}
    	</foreach>
 	</delete>
 	
 	<!-- 게시글 삭제 -->
 	<update id="deleteMessage" parameterType="cmap">
 	    UPDATE board_message
 	    SET
 	    	DeleteDate = now(3)
 	    	,ModifierCode = #{userCode}
 	    WHERE 1=1
 	    AND MessageID = #{messageID}
 	    <if test="bizSection == 'Doc'">
			AND IsCurrent='Y'    
		</if>
 	</update>
 	
	<!-- 하위 게시글 삭제: 답글 -->
	<update id="deleteLowerMessage" parameterType="cmap">
	UPDATE board_message
		SET	  DeleteDate = now(3)
			, ModifierCode = #{userCode}
		WHERE 1=1
		<if test='messageIDArr != null and messageIDArr.length != 0'>
			AND MessageID IN 
			<foreach collection="messageIDArr" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
	</update>
 	
 	<insert id="createHistory" parameterType="cmap">
 	    INSERT INTO board_message_history(MessageID, HistoryType, Comment, RegisterCode, RegistDate, RegistIP, DomainID)
 	    VALUES(#{messageID}, #{historyType}, #{comment}, #{userCode}, now(3), #{registIP}, #{domainID})
 	    <selectKey keyProperty="historyID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
        </selectKey>
 	</insert>
 	
 	<!-- 수정요청 게시물 상태 변경 -->
 	<update id="updateRequestStatus" parameterType="cmap">
        UPDATE board_request_modify
        SET
        	AnswererCode = #{answererCode}
        	,AnswererName = #{answererName}
        	,AnswerContent = #{answerContent}
        	,RequestStatus = #{requestStatus}
        	,AnswerDate = now(3)
        WHERE 1=1
        AND RequestID = #{requestID}
    </update>
    
 	<!-- 게시글 삭제시 소속한 폴더의 현재 사용중인 용량 업데이트 -->
    <update id="updateCurrentFileSizeByMessage" parameterType="cmap">
        UPDATE board_config AS bc LEFT JOIN (
			SELECT FolderID, MessageID FROM board_message
			WHERE MessageID = #{messageID} ) AS bm ON bm.FolderID = bc.FolderID
		SET
			bc.currentTotalFileSize = IFNULL(bc.currentTotalFileSize, 0) 
			<choose>
				<when test='storageControl.equals("-")'>-</when>
				<otherwise>+</otherwise>
			</choose>
			 IFNULL(( 
				SELECT SUM(size)
				FROM sys_file AS CF
				WHERE CF.MessageID = bm.messageid
				AND CF.ObjectID = bm.FolderID
				AND CF.ObjectType = 'FD'
				AND CF.SaveType != 'INLINE' 
			),0)
		WHERE bc.folderid = bm.folderid
    </update>
    
    <insert id="createMessage" parameterType="cmap">
 	    INSERT INTO board_message(FolderID
			,IsInherited
			,ParentID
			,MsgType ,MsgState
			,CategoryID
			,Number
			,Seq	,Step	,Depth
			,Subject
			,BodyText
			,PopupStartDate ,PopupEndDate
			,TopStartDate ,TopEndDate
			,IsApproval
			,IsCurrent
			,IsCheckOut
			,BodyFormID
			<if test="useSecurity != null and useSecurity != ''">
				,UseSecurity
			</if>
			<if test="expiredDate != null and expiredDate != ''">
				,ExpiredDate
			</if>
			<if test="bizSection != 'Doc'">
			    ,TableHistoryType
				,UseAnonym 
				<if test="isPopup != null">				
				,IsPopup	
				</if>
				,IsTop
				,IsUserForm
				,UseScrap
				,NoticeMedia
				,UseRSS
				,UseReplyNotice
				,UseCommNotice
				,TrackBackURL
			</if>
			,FileCnt
			,FileExtension
			,IsMobile 
			,RegistDate
			,CreatorCode
			,CreateDate
			,CreatorName
			,CreatorLevel
			,CreatorPosition
			,CreatorTitle
			,CreatorDept 
			,ProgressState
			,OwnerCode
			<!-- ,ScheduleStartDate
			,ScheduleEndDate
			,ScheduleDisplayColor
			,ScheduleStartHour
			,ScheduleStartMinute
			,ScheduleEndHour
			,ScheduleEndMinute
			,IsAllDay
			,AnonymousPW-->
			,ReservationDate 
			,SecurityLevel
			,UseMessageReadAuth
			,UsePubDeptName
			,Version
			<if test="keepyear != null and keepyear != ''">
				,Keepyear
			</if>
			<if test="registDept != null and registDept != ''">
				,RegistDept
			</if>
			<if test="linkURL != null and linkURL != ''">
				,LinkURL
			</if>			
			)
	VALUES(#{folderID},
			#{isInherited},
			NULL,
			#{msgType},
			#{msgState},
			#{categoryID},
			#{number},
			#{seq},		<!-- MessageID -->
			#{step},
			#{depth},
			#{subject},
			#{bodyText},
			#{popupStartDate},
			#{popupEndDate},
			#{topStartDate},
			#{topEndDate},
			#{isApproval},
			#{isCurrent},
			#{isCheckOut},
			#{bodyFormID},
			<if test="useSecurity != null and useSecurity != ''">
				#{useSecurity},
			</if>
			<if test="expiredDate != null and expiredDate != ''">
				#{expiredDate},
			</if>
			<if test="bizSection != 'Doc'">
			    #{tableHistoryType},
				#{useAnonym}, 
				<if test="isPopup != null">	
					#{isPopup},
				</if>
				#{isTop},
				#{isUserForm},
				#{useScrap},
				#{noticeMedia},
				#{useRSS},
				#{useReplyNotice},
				#{useCommNotice},
				#{trackBackURL},
			</if>
			#{fileCnt},
			#{fileExtension},
			#{isMobile}, 
			<choose>
				<when test="reservationDate != null and reservationDate != ''">
					#{reservationLocalDate}, 
				</when>
				<when test="registDate != null and registDate != ''">
					#{registDate}, 
				</when>
				<otherwise>
					now(3),
				</otherwise>
			</choose>
			#{userCode},
			now(3),
			#{creatorName},
			#{creatorLevel},
			#{creatorPosition},
			#{creatorTitle},
			#{creatorDept},
			#{progressStateID},
			#{ownerCode},		<!-- OwnerCode: 답글의 경우 원본글에 작성자가 담당자가 된다 -->
			<!-- #{scheduleStartDate},
			#{scheduleEndDate},
			#{scheduleDisplayColor},
			#{scheduleStartHour},
			#{scheduleStartMinute},
			#{scheduleEndHour},
			#{scheduleEndMinute},
			#{isAllDay},
			#{anonymousPW},-->
			#{reservationDate}, 
			#{securityLevel},
			#{useMessageReadAuth},
			#{usePubDeptName},
			#{version}
			<if test="keepyear != null and keepyear != ''">
				,#{keepyear}
			</if>
			<if test="registDept != null and registDept != ''">
				,#{registDept}
			</if>
			<if test="linkURL != null and linkURL != ''">
				,#{linkURL}
			</if>			
			)
		<selectKey keyProperty="messageID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
        </selectKey>
 	</insert>
 	
    <!-- 게시글 개정 -->
    <insert id="revisionMessage" parameterType="cmap">
 	    INSERT INTO board_message
					(
						MessageID, `Version`,		FolderID,			IsCurrent,			IsInherited,		MsgType,
						categoryID, Seq, Step, Depth,
						MsgState,		`Subject`,		KeepYear, 		number,		<!-- DocLevel, -->	ExpiredDate,
						IsCheckOut,		BodyText,		FileCnt,			FileExtension,		SecurityLevel, 			
						RegistDate,		CreatorCode,		CreateDate,		CreatorName,		CreatorLevel,		CreatorPosition,
						CreatorTitle,	CreatorDept,		RegistDept,		OwnerCode,
						RevisionCode,	RevisionDate,		CheckOuterCode
					)
		SELECT			MessageID, (#{version} + 1),		#{folderID},		'Y',			#{isInherited},		MsgType,
						#{categoryID}, Seq, Step, Depth,
						MsgState,		#{subject},		#{keepyear},	number,		<!-- #{docLevel}, -->		#{expiredDate},
						'N',			#{bodyText},	#{fileCnt},		#{fileExtension},		#{securityLevel},
						RegistDate,		CreatorCode,		CreateDate,		CreatorName,		CreatorLevel,		CreatorPosition,
						CreatorTitle,	CreatorDept,		RegistDept,		#{ownerCode},
						#{userCode},		NOW(3),			NULL
		FROM board_message 
		WHERE MessageID = #{messageID} AND Version = #{version}
 	</insert>
	
	<insert id="createMessageFolder" parameterType="cmap">
		INSERT INTO board_message_folder
		(
			  MessageID
			, FolderID
			, Version
		)
		VALUES
		<foreach collection="multiFolderIDs" item="multiFolderID" separator=",">
			(
				  #{messageID}
				, #{multiFolderID}
				, #{version}
			)
		</foreach>
	</insert>
	
	<delete id="deleteMessageFolder" parameterType="cmap">
		DELETE FROM board_message_folder
		WHERE MessageID = #{messageID}
		AND Version = #{version}
	</delete>
	
    <!-- 개정 이후 이전버전의 게시글 데이터중 checkout기록 및 최신버전 정보를 모두 N으로 변경 -->
    <update id="updatePrevMessage" parameterType="cmap">
    	UPDATE board_message 
    	SET 
    		IsCheckOut = 'N', 
    		IsCurrent = 'N', 
    		CheckOuterCode = NULL
		WHERE MessageID = #{orgMessageID} AND version &lt; #{version}
	</update>
    
    <update id="updateMessageSeq" parameterType="cmap">
        UPDATE board_message 
        SET 
        	Seq = #{seq}
        	,Depth = #{depth}
        	,Step = #{step}
        	<if test="orgMessageID != null and orgMessageID != ''">
				,ParentID = #{orgMessageID}
			</if>
        WHERE MessageID = #{messageID}
    </update>
    
    <update id="updateMessage" parameterType="cmap">
        UPDATE board_message 
        SET
        	IsInherited = #{isInherited}
        	<if test="msgState != null and msgState != ''">
				,MsgState = #{msgState}
			</if>
        	<if test="bizSection == 'Doc' and folderID != null and folderID != ''">
				,folderID = #{folderID}
			</if>
			,TableHistoryType = #{tableHistoryType}
			,CategoryID = #{categoryID}
			,Subject = #{subject}
			,BodyText = #{bodyText}
			,PopupStartDate = #{popupStartDate} 
			,PopupEndDate = #{popupEndDate}
			,TopStartDate = #{topStartDate}
			,TopEndDate = #{topEndDate}
			<if test="expiredDate != null and expiredDate != ''">
				,ExpiredDate = #{expiredDate}
			</if>
			,BodyFormID = #{bodyFormID}
			<if test="useSecurity != null and useSecurity != ''">
				,UseSecurity = #{useSecurity}	
			</if>			
			,UseAnonym = #{useAnonym}
			,UseReplyNotice = #{useReplyNotice}
			,UseCommNotice = #{useCommNotice}
			,IsPopup = #{isPopup}
			,IsTop = #{isTop}
			,IsApproval = #{isApproval}
			,IsUserForm = #{isUserForm}
			<if test="useScrap != null and useScrap != ''">
				,UseScrap = #{useScrap}
			</if>			
			,NoticeMedia = #{noticeMedia}
			,UseRSS = #{useRSS}
			,FileCnt = #{fileCnt}
			,FileExtension = #{fileExtension}
			,ModifierCode = #{userCode}
			<if test='useAnonym == "Y"'>
				,CreatorName = #{creatorName}
				,CreatorLevel = #{creatorLevel}
				,CreatorPosition = #{creatorPosition}
				,CreatorTitle = #{creatorTitle}
				,CreatorDept = #{creatorDept}
			</if>
			<if test='prevAnony == "Y" and useAnonym == "N"'>
				,CreatorName = #{creatorName}
				,CreatorLevel = #{creatorLevel}
				,CreatorPosition = #{creatorPosition}
				,CreatorTitle = #{creatorTitle}
				,CreatorDept = #{creatorDept}
			</if>
			<!-- ,ScheduleStartDate
			,ScheduleEndDate
			,ScheduleDisplayColor
			,ScheduleStartHour
			,ScheduleStartMinute
			,ScheduleEndHour
			,ScheduleEndMinute
			,IsAllDay
			,AnonymousPW-->
			,ReservationDate = #{reservationDate}
			,SecurityLevel = #{securityLevel}
			,UseMessageReadAuth = #{useMessageReadAuth}
			,UsePubDeptName = #{usePubDeptName}
			<if test="bizSection == 'Doc'">
			    ,KeepYear = #{keepyear}
			    ,RevisionCode = #{userCode}
			    ,RevisionDate = NOW(3)
			</if>
			<if test="boardType== 'OnWriting'">
				,RegistDate = NOW(3)
			</if>
			<if test="LinkURL != null and LinkURL != ''">
				,LinkURL= #{LinkURL}
			</if>				
        WHERE MessageID = #{messageID}
        <if test="version != null and version != ''">
			AND Version = #{version}
		</if>
    </update>
    
    <!-- 게시번호 조회: Domain별, Folder별 -->
    <select id="selectNumberByBoard" parameterType="cmap" resultType="String">
		SELECT IFNULL(MAX(Number), 0) + 1
		FROM board_message
		WHERE 1=1
		<choose>
	    	<when test='numberingRule == "D"'>
				AND FolderID IN (
					SELECT A.FolderID
					FROM sys_object_folder AS A
						INNER JOIN sys_object_folder AS B
						ON A.DomainID = B.DomainID
					WHERE B.FolderID = #{folderID}
				)
	        </when>
	        <otherwise>
	    	   AND FolderID = #{folderID}
	        </otherwise>
	    </choose>
    </select>
    
    <!-- 익명을 사용할경우 의미없음 -->
    <select id="selectCreatorProfileData" parameterType="cmap" resultType="cmap">
        SELECT SOU.MultiDisplayName AS creatorName,		<!-- 이름만 User 테이블에서 조회했다 !! -->
			SOUBG.MultiDeptName AS creatorDept,
			SOUBG.MultiJobTitleName AS creatorTitle,
			SOUBG.MultiJobPositionName AS creatorPosition,
			SOUBG.MultiJobLevelName AS creatorLevel
		FROM sys_object_user_basegroup AS SOUBG 
		INNER JOIN sys_object_user AS SOU ON SOU.UserCode = SOUBG.UserCode
<!-- 		WHERE SOU.usercode = #{userCode}  -->
		WHERE SOU.usercode = #{creatorCode}
		<if test="URBG_ID != null and URBG_ID != ''">
		AND SOUBG.Seq = #{URBG_ID}
		</if>
		LIMIT 1 
    </select>
    
    <!-- 열람권한 추가/삭제 -->
    <insert id="createMessageReadAuth" parameterType="cmap">
 	    INSERT sys_read_acl(
 	    	ServiceType,	<!-- 서비스 타입: Board, Doc  --> 
 	    	ObjectID, 		<!-- 폴더ID -->
 	    	ObjectType, 	<!-- FIXED: 'FD' -->
 	    	MessageID, 		<!-- 게시글 ID -->
 	    	TargetCode, 	<!-- UserCode, GroupCode-->
 	    	TargetType, 	<!-- UR, GR -->
 	    	IsSetting, 		<!-- Y: 사용자설정, N: 시스템설정 -->
 	    	RegisterCode	<!-- 등록자 -->
 	    )
 	    VALUES (
 	    	#{bizSection},
 	    	#{objectID},
 	    	'FD',
 	    	#{messageID},
 	    	#{targetCode},
 	    	#{targetType},
 	    	#{isSetting},
 	    	#{userCode}
 	    )
 	</insert>
 	
 	<delete id="deleteMessageReadAuth" parameterType="cmap">
 	    DELETE FROM sys_read_acl
 	    WHERE 1=1
 	    AND ServiceType = #{bizSection}
 	    AND ObjectID = #{objectID}		<!-- FolderID -->
 	    AND ObjectType = 'FD'	<!-- FIXED: 현재는 'FD' 고정 -->
 	    AND MessageID = #{messageID}
 	</delete>
 	
 	<!-- 열람권한 조회:group, user테이블에서 필요한 정보 추가 조회 -->
 	<select id="selectMessageReadAuthList" parameterType="cmap" resultType="cmap">
		SELECT SRA.TargetType, SRA.TargetCode, Fn_BaseGetDictionary_S(#{lang}, SOU.MultiDisplayName) AS DisplayName
		FROM sys_read_acl AS SRA
		INNER JOIN sys_object_user AS SOU ON (SRA.TargetCode = SOU.UserCode)
		WHERE 1=1 
		AND SRA.MessageID = #{messageID}
		AND SRA.ObjectID = #{folderID}
		AND SRA.ObjectType = 'FD'
		AND SRA.TargetType = 'UR'
		UNION
		SELECT SRA.TargetType, SRA.TargetCode, Fn_BaseGetDictionary_S(#{lang}, SOG.MultiDisplayName) AS DisplayName
			FROM sys_read_acl AS SRA
			INNER JOIN sys_object_group AS SOG ON (SRA.TargetCode = SOG.GroupCode)
			WHERE 1=1
			AND SRA.MessageID = #{messageID}
			AND SRA.ObjectID = #{folderID}
			AND SRA.TargetType != 'UR'
 	</select>
 	
 	<!-- 열람권한 개수 조회:group, user테이블에서 필요한 정보 추가 -->
 	<select id="selectMessageReadAuthListCnt" parameterType="cmap" resultType="java.lang.Long">
 		SELECT COUNT(*) FROM (
			SELECT SRA.TargetType, SRA.TargetCode
			FROM sys_read_acl AS SRA
			INNER JOIN sys_object_user AS SOU ON (SRA.TargetCode = SOU.UserCode)
			WHERE 1=1 
			AND SRA.MessageID = #{messageID}
			AND SRA.ObjectID = #{folderID}
			AND SRA.ObjectType = 'FD'
			AND SRA.TargetType = 'UR'
			UNION
			SELECT SRA.TargetType, SRA.TargetCode
				FROM sys_read_acl AS SRA
				INNER JOIN sys_object_group AS SOG ON (SRA.TargetCode = SOG.GroupCode)
				WHERE 1=1
				AND SRA.MessageID = #{messageID}
				AND SRA.ObjectID = #{folderID}
				AND SRA.TargetType != 'UR'
 		) AS RESULT
 	</select>
 	
 	
 	<!-- 열람권한 조회:group, user테이블에서 필요한 정보 추가 조회 -->
 	<select id="selectMessageReadAuthCount" parameterType="cmap" resultType="java.lang.Long">
 	    SELECT COUNT(*) FROM (
			SELECT SRA.TargetType, SRA.TargetCode
			FROM sys_read_acl AS SRA
			INNER JOIN sys_object_user AS SOU ON (SRA.TargetCode = SOU.UserCode)
			WHERE 1=1 
			AND SRA.MessageID = #{messageID}
			AND SRA.ObjectID = #{folderID}
			AND SRA.ObjectType = 'FD'
			AND SRA.TargetType = 'UR'
			AND SRA.TargetCode = #{userCode}
			UNION
			SELECT SRA.TargetType, SRA.TargetCode
			FROM sys_read_acl AS SRA
			INNER JOIN sys_object_group AS SOG ON (SRA.TargetCode = SOG.GroupCode)
			WHERE 1=1
			AND SRA.MessageID = #{messageID}
			AND SRA.ObjectID = #{folderID}
			AND SRA.ObjectType = 'FD'
			AND SRA.TargetType != 'UR'
			AND SRA.TargetCode IN
			<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
	            #{item}
		    </foreach>
		) AS RESULT
 	</select>
 	
 	<!-- 상세권한 조회:group, user테이블에서 필요한 정보 추가 조회 -->
 	<select id="selectMessageAuthList" parameterType="cmap" resultType="cmap">
		SELECT BMA.AclList, BMA.TargetType, BMA.TargetCode, Fn_BaseGetDictionary_S(#{lang}, SOU.MultiDisplayName) AS DisplayName, BMA.IsSubInclude, BMA.InheritedObjectID, 'User' AS GroupType, SOU.SortKey
		FROM board_message_acl AS BMA
		INNER JOIN sys_object_user AS SOU ON (BMA.TargetCode = SOU.UserCode)
		WHERE 1=1 
		AND BMA.MessageID = #{messageID}
		AND BMA.Version = #{version}
		AND BMA.TargetType = 'UR'
		UNION
		SELECT BMA.AclList, BMA.TargetType, BMA.TargetCode, Fn_BaseGetDictionary_S(#{lang}, SOG.MultiDisplayName) AS DisplayName, BMA.IsSubInclude, BMA.InheritedObjectID, G.GroupType, GT.SortKey
		FROM board_message_acl AS BMA
		INNER JOIN sys_object_group AS SOG ON (BMA.TargetCode = SOG.GroupCode)
		INNER JOIN covi_smart4j.sys_object_group G ON BMA.TargetCode = G.GroupCode
		INNER JOIN covi_smart4j.sys_object_group_type GT ON GT.GroupType = G.GroupType
		WHERE 1=1
		AND BMA.MessageID = #{messageID}
		AND BMA.Version = #{version}
		AND BMA.TargetType != 'UR'
		ORDER BY InheritedObjectID DESC, SortKey, DisplayName
 	</select>
 	
 	<!-- 상세권한 조회:group, user테이블에서 필요한 정보 추가 조회 -->
 	<select id="selectMessageAclList" parameterType="cmap" resultType="cmap">
		SELECT auth.TargetType, auth.AclList, auth.Security, auth.Create, auth.Delete, auth.Modify, auth.Execute, auth.Read
		FROM (
			SELECT BMA.TargetType
				 , BMA.AclList
				 , BMA.Security
				 , BMA.Create
				 , BMA.Delete
				 , BMA.Modify
				 , BMA.Execute
				 , BMA.Read
				 , '99' AS AclPriority
				 , 999 AS Priority
				 , '' AS GroupPath
			FROM covi_smart4j.board_message_acl AS BMA
			INNER JOIN covi_smart4j.sys_object_user AS SOU ON (BMA.TargetCode = SOU.UserCode)
			WHERE BMA.MessageID = #{messageID}
			AND BMA.Version = #{version}
			AND BMA.TargetCode = #{userCode}
			AND BMA.TargetType = 'UR'
			
			UNION ALL
			
			SELECT BMA.TargetType
				 , BMA.AclList
				 , BMA.Security
				 , BMA.Create
				 , BMA.Delete
				 , BMA.Modify
				 , BMA.Execute
				 , BMA.Read
				 , (CASE WHEN TargetType = 'CM' THEN '9' WHEN TargetType = 'GR' THEN '2' ELSE '3' END) AS AclPriority
				 , SOGT.Priority AS Priority
				 , SOG.GroupPath AS GroupPath
			FROM covi_smart4j.board_message_acl AS BMA
			INNER JOIN covi_smart4j.sys_object_group AS SOG ON (BMA.TargetCode = SOG.GroupCode)
			INNER JOIN covi_smart4j.sys_object_group_type AS SOGT ON (SOG.GroupType = SOGT.GroupType)
			WHERE BMA.MessageID = #{messageID}
			AND BMA.Version = #{version}
			AND BMA.TargetType != 'UR'
		    AND (
		    	(BMA.IsSubInclude = 'Y' AND BMA.TargetCode IN 
		    	<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
		            #{item}
			    </foreach>) 
			    OR (BMA.IsSubInclude = 'N' AND BMA.TargetCode = #{deptCode})
			    )
		) auth
		ORDER BY auth.AclPriority DESC, auth.Priority DESC, auth.GroupPath ASC
 	</select>
 	
 	<!-- 커뮤니티 상세권한 조회 -->
 	<select id="selectCommunityAclList" parameterType="cmap" resultType="cmap">
 		SELECT auth.TargetType, auth.AclList, auth.Security, auth.Create, auth.Delete, auth.Modify, auth.Execute, auth.Read
		FROM (
			SELECT BMA.TargetType
				 , BMA.AclList
				 , BMA.Security
				 , BMA.Create
				 , BMA.Delete
				 , BMA.Modify
				 , BMA.Execute
				 , BMA.Read
				 , '99' AS AclPriority
				 , 999 AS Priority
				 , '' AS GroupPath
			FROM covi_smart4j.board_message_acl AS BMA
			INNER JOIN covi_smart4j.sys_object_user AS SOU ON (BMA.TargetCode = SOU.UserCode)
			WHERE BMA.MessageID = #{messageID}
			AND BMA.TargetCode = #{userCode}
			AND BMA.TargetType = 'UR'
			
			UNION ALL
			
			SELECT BMA.TargetType
				 , BMA.AclList
				 , BMA.Security
				 , BMA.Create
				 , BMA.Delete
				 , BMA.Modify
				 , BMA.Execute
				 , BMA.Read
				 , '90' AS AclPriority
				 , SOGT.Priority AS Priority
	          	 , SOG.GroupPath AS GroupPath
			FROM covi_smart4j.board_message_acl BMA
			INNER JOIN covi_smart4j.sys_object_group SOG ON (BMA.TargetCode = SOG.GroupCode)
			INNER JOIN covi_smart4j.sys_object_group_type SOGT ON (SOG.GroupType = SOGT.GroupType)
			WHERE 1=1
			AND MessageID = #{messageID}
			AND TargetType = 'GR'
			AND TargetCode IN (SELECT CU_Code
								 FROM community AS C
									  INNER JOIN sys_object_group_member AS SOGM ON (C.CU_Code = SOGM.GroupCode)
								WHERE C.CU_ID = #{communityID}
								  AND SOGM.UserCode = #{userCode}
								  AND SOGM.MemberStatus = 'A'
								  AND SOGM.IsUse = 'Y')
			
			UNION ALL
			
			SELECT BMA.TargetType
				 , BMA.AclList
				 , BMA.Security
				 , BMA.Create
				 , BMA.Delete
				 , BMA.Modify
				 , BMA.Execute
				 , BMA.Read
				 , (CASE WHEN TargetType = 'CM' THEN '9' WHEN TargetType = 'GR' THEN '2' ELSE '3' END) AS AclPriority
				 , SOGT.Priority AS Priority
				 , SOG.GroupPath AS GroupPath
			FROM covi_smart4j.board_message_acl AS BMA
			INNER JOIN covi_smart4j.sys_object_group AS SOG ON (BMA.TargetCode = SOG.GroupCode)
			INNER JOIN covi_smart4j.sys_object_group_type AS SOGT ON (SOG.GroupType = SOGT.GroupType)
			WHERE BMA.MessageID = #{messageID}
			AND BMA.TargetType != 'UR'
		    AND (
		    	(BMA.IsSubInclude = 'Y' AND BMA.TargetCode IN 
		    	<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
		            #{item}
			    </foreach>) 
			    OR (BMA.IsSubInclude = 'N' AND BMA.TargetCode = #{deptCode})
			    )
		) auth
		ORDER BY auth.AclPriority DESC, auth.Priority DESC, auth.GroupPath ASC
 	</select>
 	
 	<!-- 상세권한 추가 -->
 	<insert id="createMessageAuth" parameterType="cmap" > 	    
 	    INSERT board_message_acl(
 	    	MessageID, 
 	    	<if test="version != null and version != ''">
 	    		Version, 		<!-- 문서용 버전 -->
 	    	</if>
 	    	TargetCode, 	<!-- 대상 객체 코드 -->
 	    	TargetType, 	<!-- 대상 객체 유형 -->
 	    	AclList, 		<!-- 권한 목럭: SCDMER-->
 	    	Security, 		<!-- S: 조회자 목록 -->
 	    	`Create`, 		<!-- C: 답글, 댓글 -->
 	    	`Delete`,
 	    	`Modify`,		<!-- 수정 -->
 	    	`Execute`,		<!-- 실행 -->
 	    	`Read`,
 	    	IsSubInclude,
 	    	InheritedObjectID,
 	    	RegisterCode	<!-- 등록자 -->
 	    )
 	    VALUES (
 	    	#{messageID},
 	    	<if test="version != null and version != ''">
 	    	    #{version},
 	    	</if>
 	    	#{targetCode},
 	    	#{targetType},
 	    	#{aclList},
 	    	#{security},
 	    	#{create},
 	    	#{delete},
 	    	#{modify},
 	    	#{execute},
 	    	#{read},
 	    	#{isSubInclude},
 	    	#{inheritedObjectID},
 	    	#{userCode}
 	    )
 	</insert>
 	
 	<!-- 상세권한 삭제 -->
    <delete id="deleteMessageAuth" parameterType="cmap">
 	    DELETE FROM board_message_acl
 	    WHERE 1=1
 	    AND MessageID = #{messageID}
 	    AND Version = #{version}
 	</delete>
 	
    <!-- 태그: Tag C/R/D -->
    <select id="selectMessageTagList" parameterType="cmap" resultType="cmap">
        SELECT Tag
        FROM board_message_tag
        WHERE 1=1
        AND MessageID = #{messageID}
        AND Version = #{version}
    </select>
    
    <insert id="createMessageTag" parameterType="cmap">
        INSERT INTO board_message_tag(MessageID, Version, Tag)
        VALUES(#{messageID}, #{version}, #{tag})
    </insert>

    <delete id="deleteMessageTag" parameterType="cmap">
        DELETE FROM board_message_tag 
        WHERE MessageID = #{messageID}
        AND Version = #{version}
    </delete>
    
    <!-- 링크: Link C/R/D -->
    <select id="selectMessageLinkList" parameterType="cmap" resultType="cmap">
        SELECT LinkID, Title, Url
        FROM board_message_link
        WHERE 1=1
        AND MessageID = #{messageID}
    </select>
    
    <insert id="createMessageLink" parameterType="cmap" >
        INSERT INTO board_message_link(Title, Url, MessageID)
        VALUES(#{title}, #{url}, #{messageID})
    </insert>
    
    <!-- 본문 정보 내용 추가 -->
    <insert id="createContents" parameterType="cmap">
        INSERT INTO sys_contents(ObjectID, ObjectType, MessageID, Version, Body, BodySize)
        VALUES(#{folderID}, 'FD', #{messageID}, #{version}, #{body}, #{bodySize})
    </insert>
    
    <!-- 본문 정보 내용 수정 -->
    <update id="updateContents" parameterType="cmap">
        UPDATE sys_contents 
        SET Body = #{body}
        	,BodySize = #{bodySize}
        WHERE 1=1
        AND ObjectID = #{folderID}
        AND ObjectType = 'FD'
        AND MessageID = #{messageID}
        AND Version = #{version}
    </update>
    
    <!-- 일괄삭제 후 재등록 -->
    <delete id="deleteMessageLink" parameterType="cmap">
        DELETE FROM board_message_link
        WHERE MessageID = #{messageID}
    </delete>
    
    <!-- 사용자정의 필드: UserDefField C/R/D -->
    <insert id="createUserDefFieldValue" parameterType="cmap" >
        INSERT INTO board_userform_value(MessageID, Version, UserFormID, FolderID, FieldValue)
        VALUES(#{messageID}, #{version}, #{userFormID}, #{folderID}, #{fieldValue})
    </insert>
    
    <!-- 화면표시용 사용자정의 필드 데이터표시: 이전에는 트리거로 추가하던 기능 -->
    <insert id="createMessageDefFieldValue" parameterType="cmap">
        INSERT INTO board_message_userform_value(
        	MessageID, FolderID, Version,
        	<foreach collection="fieldArray" item="item" index="index" separator="," >
            	<choose>
					<when test='index == 1'>UF_Value1</when>
					<when test='index == 2'>UF_Value2</when>
					<when test='index == 3'>UF_Value3</when>
					<when test='index == 4'>UF_Value4</when>
					<when test='index == 5'>UF_Value5</when>
					<when test='index == 6'>UF_Value6</when>
					<when test='index == 7'>UF_Value7</when>
					<when test='index == 8'>UF_Value8</when>
					<when test='index == 9'>UF_Value9</when>
					<otherwise>UF_Value0</otherwise>
				</choose>
        	</foreach>
        )
        VALUES( #{messageID}, #{folderID}, #{version},
        	<foreach collection="fieldArray" item="item" index="index" separator="," >
            	#{item.FieldText}
        	</foreach>
        )
    </insert>
    
    <!-- 사용자정의 필드 데이터 갱신 -->
    <update id="updateMessageDefFieldValue" parameterType="cmap">
        UPDATE board_message_userform_value
        SET MessageID = #{messageID}
	        <if test='userFormIndex == "0"'>,UF_Value0 = #{userFormValue}</if>
	        <if test='userFormIndex == "1"'>,UF_Value1 = #{userFormValue}</if>
	        <if test='userFormIndex == "2"'>,UF_Value2 = #{userFormValue}</if>
	        <if test='userFormIndex == "3"'>,UF_Value3 = #{userFormValue}</if>
	        <if test='userFormIndex == "4"'>,UF_Value4 = #{userFormValue}</if>
	        <if test='userFormIndex == "5"'>,UF_Value5 = #{userFormValue}</if>
	        <if test='userFormIndex == "6"'>,UF_Value6 = #{userFormValue}</if>
	        <if test='userFormIndex == "7"'>,UF_Value7 = #{userFormValue}</if>
	        <if test='userFormIndex == "8"'>,UF_Value8 = #{userFormValue}</if>
	        <if test='userFormIndex == "9"'>,UF_Value9 = #{userFormValue}</if>
        WHERE MessageID = #{messageID}
        AND FolderID = #{folderID}
        AND Version = #{version}
    </update>
    
    <insert id="createMessageEvent" parameterType="cmap">
		INSERT INTO board_message_event(MessageID, EventType, EventDate, EventOwner)
		VALUES(#{messageID}, #{eventType}, #{eventDate}, #{eventOwner} )
		ON DUPLICATE KEY UPDATE
		EventType=#{eventType}, EventDate=#{eventDate}, EventOwner=#{eventOwner}
    </insert>
    
    <delete id="deleteMessageEvent" parameterType="cmap">
        DELETE FROM board_message_event
        WHERE 1=1
        AND MessageID = #{messageID}
    </delete>
    
	<select id="selectUserDefFieldValue" parameterType="cmap" resultType="cmap">
		SELECT UserFormID, 
			FieldValue
		FROM board_userform_value
		WHERE 1=1
		AND MessageID = #{messageID}
		AND Version = #{version}
	</select>
    
    <!-- 일괄삭제 후 재등록 -->
    <delete id="deleteUserDefFieldValue" parameterType="cmap">
        DELETE FROM board_userform_value
        WHERE MessageID = #{messageID} AND Version = #{version}
    </delete>
    
    <delete id="deleteMessageDefFieldValue" parameterType="cmap">
        DELETE FROM board_message_userform_value
        WHERE MessageID = #{messageID} AND Version = #{version}
    </delete>
    
    <!-- 승인프로세스  -->
    <insert id="createProcess" parameterType="cmap">
        INSERT INTO sys_process (ProcessDefID, MessageID, ObjectType, `State`, `Subject`, RegisterCode)
		VALUES (
		<if test="processID != null and processID != ''">
			#{processID},
		</if>
		<if test="processID == null or processID == ''">
			(SELECT ProcessID FROM sys_process_target WHERE ObjectType = 'FD' AND ObjectID = #{folderID}),
		</if>
			#{messageID}, #{bizSection}, 1, #{subject}, #{userCode})
		<selectKey keyProperty="instanceID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
        </selectKey>	
    </insert>
        
   	<!-- 게시 작성자의 Activity 추가 -->
    <insert id="createActivity" parameterType="cmap">
		INSERT INTO sys_process_activity ( ProcessID, Step, SubStep, ActorRole, ActivityType, Seq, `State`, `Comment`, StartDate, CompleteDate, 
			ActorCode, ActorName, ActorLevel, ActorPosition, ActorTitle, ActorDept)
		VALUES ( #{instanceID}, 0, 0, 'Register', 'Serial', 0, 7, '', NOW(), NOW(), 
			#{actorCode}, #{actorName}, #{actorLevel}, #{actorPosition}, #{actorTitle}, #{actorDept})
    </insert>
    
    <!-- 정의된 Performer 데이터로 Activity 데이터 추가 -->
    <insert id="createPerformerActivity" parameterType="cmap">
        INSERT INTO sys_process_activity ( ProcessID, Step, SubStep, ActorRole, ActivityType, Seq, `State`, `Comment`, 
			ActorCode, ActorName, ActorLevel, ActorPosition, ActorTitle, ActorDept , StartDate)
		SELECT #{instanceID}, Step + 1, SubStep, ActorRole, ActivityType, Step + 1, IF(Step+1=1, 1, 0), '', 
				ActorCode, DisplayName, B.MultiJobLevelName, B.MultiJobPositionName, B.MultiJobTitleName, B.MultiDeptName, IF(Step+1=1, NOW(3), NULL)
		FROM	sys_process_performer AS A
				left outer JOIN sys_object_user_basegroup AS B
				ON	A.ActorCode = B.UserCode
		WHERE 1=1
		<if test="processID != null and processID != ''">
			AND ProcessID = #{processID}
		</if>
		<if test="processID == null or processID == ''">
			AND ProcessID = (SELECT ProcessID FROM sys_process_target WHERE ObjectType = 'FD' AND ObjectID = #{folderID})
		</if>
		GROUP BY A.ActorCode		
		ORDER BY Step ASC, SubStep ASC 
    </insert>
	
	<!-- 게시글 기본 정보 조회 -->
	<select id="selectMessageInfo" parameterType="cmap" resultType="cmap">
    	SELECT
			SOF.MenuID AS menuID,
			SOF.FolderID AS folderID,
			BM.MessageID AS messageID,
			BM.`Version` AS `version`,
			BM.CreatorCode AS creatorCode,
			BM.Subject AS subject
		FROM covi_smart4j.board_message AS BM
		LEFT OUTER JOIN covi_smart4j.sys_object_folder AS SOF ON (BM.FolderID = SOF.FolderID)
		WHERE BM.MessageID = #{messageID}
		<if test="version != null and version != ''">
			AND BM.Version = #{version}
		</if>
	</select>
	
    <!-- 상세 보기 조회 쿼리 -->
    <select id="selectMessageDetail" parameterType="cmap" resultType="cmap">
		SELECT 
			A.MessageID, A.FolderID, A.IsInherited, IFNULL(ParentID,'') AS ParentID, MsgType, 
			IFNULL(MsgState,'') AS MsgState, 
			IFNULL(A.CategoryID, '') AS CategoryID, Number, Seq, Step, Depth,
			IFNULL(A.Subject, '') AS Subject, 
			IFNULL(BodyText, '') AS BodyText, 
			IFNULL(PopupStartDate, '') AS PopupStartDate, 
			IFNULL(PopupEndDate,'') AS PopupEndDate, A.`Version` AS Version,
			IFNULL(DATE_FORMAT(A.TopStartDate,'%Y.%m.%d') ,'') AS TopStartDate, 
			IFNULL(DATE_FORMAT(A.TopEndDate,'%Y.%m.%d') , '')AS TopEndDate, 
			IFNULL(BodyFormID, '') AS BodyFormID, 
			IFNULL(UseSecurity, 'N') AS UseSecurity, 
			IFNULL(UseAnonym, 'N') AS UseAnonym, 
			IFNULL(IsPopup, 'N') AS IsPopup, IsTop, 
			IFNULL(IsApproval, 'N') AS IsApproval, 
			IFNULL(IsUserForm, 'N') AS IsUserForm, 
			IFNULL(UseScrap, 'N') AS UseScrap, 
			IFNULL(NoticeMedia, '') AS NoticeMedia, 
			IFNULL(UseRSS, 'N') AS UseRSS,
			IFNULL(UseReplyNotice, 'N') AS UseReplyNotice, 
			IFNULL(UseCommNotice, 'N') AS UseCommNotice, 
			IFNULL(TrackBackURL, '') AS TrackBackURL, AnswerCnt, ReadCnt, SatisfactionPoint,
			ScrapCnt, ReportCnt, FileCnt, 
			IFNULL(FileExtension, '') AS FileExtension, TracbackCnt, 
			IFNULL(IsMobile, 'N') AS IsMobile, IsCurrent, IsCheckOut, 
			IFNULL(CheckOuterCode, '') AS CheckOuterCode,
			IFNULL(A.ProgressState, '') as ProgressState, 
			A.CreatorCode, 
			IFNULL(A.OwnerCode, '') AS OwnerCode,
			IFNULL((SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = A.OwnerCode), '') AS OwnerName,
		  	F.OwnerCode AS FolderOwnerCode,
            F.FolderType  AS FolderType,
            F.ObjectType AS ServiceType,
            CreateDate, 
			Fn_BaseGetDictionary_S(#{lang}, CreatorName) AS CreatorName, 
			Fn_BaseGetDictionary_S(#{lang}, CreatorLevel) AS CreatorLevel, 
			Fn_BaseGetDictionary_S(#{lang}, CreatorPosition) AS CreatorPosition, 
			Fn_BaseGetDictionary_S(#{lang}, CreatorTitle) AS CreatorTitle, 
			Fn_BaseGetDictionary_S(#{lang}, CreatorDept) AS CreatorDept,
			(SELECT IFNULL(PhotoPath, '') FROM sys_object_user WHERE UserCode = A.CreatorCode) AS PhotoPath,
			DATE_FORMAT(A.RegistDate,'%Y.%m.%d %H:%i:%s') AS RegistDate,
			IFNULL(DATE_FORMAT(A.ExpiredDate,'%Y.%m.%d'),'') AS ExpiredDate,
			IFNULL(DATE_FORMAT(A.ReservationDate,'%Y.%m.%d %H:%i:%s'), '') AS ReservationDate,
			IFNULL(A.DeleteDate, '') AS DeleteDate,
			IFNULL(A.TableHistoryType, '') AS TableHistoryType,
			IFNULL(A.TableBody, '') AS TableBody,
			IFNULL(A.HistoryBody, '') AS HistoryBody,
			IFNULL(A.ScheduleStartDate,'') AS ScheduleStartDate,
			IFNULL(A.ScheduleEndDate,'') AS ScheduleEndDate,
			IFNULL(A.ScheduleDisplayColor,'') AS ScheduleDisplayColor,
			IFNULL(A.ScheduleStartHour,'') AS ScheduleStartHour,
			IFNULL(A.ScheduleStartMinute,'') AS ScheduleStartMinute,
			IFNULL(A.ScheduleEndHour,'') AS ScheduleEndHour,
			IFNULL(A.ScheduleEndMinute,'') AS ScheduleEndMinute,
			IFNULL(A.IsAllDay,'') AS IsAllDay,
			IFNULL(B.Body, '') AS Body,  
			IFNULL(Fn_BaseGetDictionary_S(#{lang}, C.DisplayName), '') AS CategoryName, 
			IFNULL(C.MemberOf, '') AS CategoryMemberOf, 
			IFNULL(P.ProcessID, '') AS ProcessID,
			IFNULL(P.ProcessDefID, '') AS ProcessDefID,
			IFNULL(A.SecurityLevel, '999') AS SecurityLevel, 
			IFNULL(A.UseMessageReadAuth, 'N') AS UseMessageReadAuth,
			(SELECT IFNULL(UseMessageAuth,'N') FROM board_config WHERE FolderID = A.FolderID) AS UseMessageAuth,
			(SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END FROM board_message_acl WHERE MessageID = A.MessageID) AS MessageAuth,
			IFNULL(A.UsePubDeptName, 'N') AS UsePubDeptName,
			IFNULL(A.KeepYear, '') AS KeepYear, 
			IFNULL(A.RegistDept, '') AS RegistDept,
			IFNULL(BME.EventOwner, '') AS EventOwnerCode,
			IFNULL(BME.EventType, '') AS EventType,
			IFNULL(DATE_FORMAT(BME.EventDate,'%Y.%m.%d'), '') AS EventDate,
			IFNULL((SELECT Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BME.EventOwner), '') AS EventOwnerName,
			IFNULL((SELECT IFNULL(Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName), '') FROM sys_object_user WHERE UserCode = A.RevisionCode), '') AS RevisionName,
			IF(A.RevisionDate IS NULL, DATE_FORMAT(A.RegistDate,'%Y.%m.%d %H:%i:%s'), DATE_FORMAT(A.RevisionDate,'%Y.%m.%d %H:%i:%s')) AS RevisionDate,
			IFNULL(Fn_BaseGetDictionary_S( #{lang}, G.MultiDisplayName), '') AS RegistDeptName,
			IFNULL(A.LinkURL, '') AS LinkURL,
			IFNULL((SELECT GROUP_CONCAT(FolderID SEPARATOR ';') FROM board_message_folder WHERE MessageID = #{messageID} AND Version = #{version}), '') AS MultiFolderIDs
		FROM board_message AS A 
		LEFT OUTER JOIN sys_contents AS B ON A.MessageID = B.MessageID AND A.FolderID = B.ObjectID AND A.Version = B.Version
		LEFT OUTER JOIN board_category AS C ON C.FolderID = #{folderID} AND A.CategoryID = C.CategoryID	
		LEFT OUTER JOIN board_message_event AS BME ON (BME.MessageID = A.MessageID)
		LEFT OUTER JOIN sys_process AS P ON P.MessageID = A.MessageID  AND P.ObjectType = #{bizSection}
		LEFT OUTER JOIN sys_object_folder AS F ON A.FolderID = f.FolderID 
        LEFT OUTER JOIN sys_object_group AS G ON A.RegistDept = G.groupcode
		WHERE A.MessageID = #{messageID}
		AND A.Version = #{version}
		LIMIT 1
    </select>
    
<!--     <select id="selectMessageNextStep" parameterType="cmap" resultType="cmap"> -->
<!--         SELECT Seq, Step, Depth, CategoryID -->
<!--         FROM board_message -->
<!--         WHERE 1=1 -->
<!--         AND seq = #{orgMessageID} -->
<!--     </select> -->
	<!-- 원본 게시글 하위에 있는 답글들의 step을 전부 1씩 증가시킴 -->
	<update id="updatePrevReplyMessage" parameterType="cmap">
	    UPDATE board_message
	    SET
	    	Step = Step+1
	    WHERE Seq = #{seq}
	    AND Step > #{step}
	</update>
	
	<!-- 체크아웃 상태 여부 확인 -->
	<select id="selectMessageCheckOutStatus" parameterType="cmap" resultType="java.lang.Long">
	    SELECT COUNT(*) 
	    FROM board_message
	    WHERE 1=1
	    AND MessageID = #{messageID}
	    AND Version = #{version}
	    <choose>
	    	<when test="actType == 'In' or actType == 'Revision' or actType == 'Cancel'">
				AND IsCheckOut  = 'Y'
	    	</when>
	    	<when test="actType == 'Renew' or actType == 'Out'">
	    	    AND IsCheckOut='N'
	    	</when>
    	</choose>
    	<if test="actType == 'Out' or actType == 'Cancel'">
    	    AND IsCurrent  = 'Y'
    	</if>
	</select>
	
	<!-- 개정이력 조회 -->
	<select id="selectRevisionHistory" parameterType="cmap" resultType="cmap">
		SELECT	BM.MessageID, BM.`Version`, BM.`Subject`, SOU.UserCode, BM.IsCurrent
			,(SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.RevisionCode) AS RevisionName
			,IF(BM.RevisionDate IS NULL, DATE_FORMAT(BM.RegistDate,'%Y.%m.%d'), DATE_FORMAT(BM.RevisionDate,'%Y.%m.%d')) AS RevisionDate
			,IF(BM.RevisionDate IS NULL, DATE_FORMAT(BM.RegistDate,'%H:%i:%s'), DATE_FORMAT(BM.RevisionDate,'%H:%i:%s')) AS RevisionTime
		FROM board_message AS BM
		LEFT OUTER JOIN sys_object_user AS SOU ON BM.RevisionCode = SOU.UserCode
		WHERE BM.MessageID = #{messageID} 
		GROUP BY BM.`Version`
		ORDER BY BM.`Version` DESC
	</select>
	
	<!-- 개정 이력 추가 -->
	<insert id="createCheckInOutHistory" parameterType="cmap">
	    INSERT INTO doc_inout_history(MessageID,`Version`, CO_Code, ActType, Msg, CO_Date, CI_Date)
		VALUES(#{messageID},#{version},#{userCode},#{actType},#{comment},
			<choose>
		    	<when test="actType == 'In' or actType == 'Cancel' or actType == 'Revision'">
		    	    NULL
					, NOW(3)
		        </when>
		        <otherwise>
		            NOW(3)
					, NULL
		        </otherwise>
		    </choose>
			
		)
	</insert>
	
	<!-- 기존에 체크아웃된 게시글 상태 변경 -->
	<update id="updateCheckInOutHistory" parameterType="cmap">
	    UPDATE doc_inout_history 
	    SET 
	    	<choose>
		    	<when test="actType == 'Cancel'">
		    	    DeleteDate = NOW(3)
		    	    , DeleterCode = #{userCode}
		    	</when>
		    	<otherwise>
		    	    CI_Date = NOW(3)
	    			, ActType = #{actType}
		    	</otherwise>
	    	</choose>
		WHERE MessageID = #{messageID} 
		AND `Version` = #{version} 
		AND ActType = 'Out'
		AND DeleteDate IS NULL
	</update>
	
	<!-- 문서 게시글 수정페이지 접근시 게시글 체크아웃 상태로 변경 -->
    <update id="updateMessageCheckOut" parameterType="cmap" >
        UPDATE board_message
        SET
        	IsCheckOut = 'Y'
        	,CheckOuterCode = #{userCode}
        WHERE MessageID = #{messageID}
        AND Version = #{version}
    </update>
    
    <!-- 수정/개정시 첨부파일 삭제 처리 -->
    <delete id="deleteFile" parameterType="cmap">
       <![CDATA[
		DELETE FROM covi_smart4j.sys_file
		WHERE ServiceType = #{ServiceType} AND ObjectID = #{ObjectID} AND ObjectType = #{ObjectType} AND MessageID = #{MessageID} AND `Version` = #{Version}
		]]>
	</delete>
    
    <!-- 게시물 이동 -->
    <update id="moveMessage" parameterType="cmap">
        UPDATE board_message
        SET
        	MsgType = 'M'
        	,FolderID = #{folderID}
        WHERE 1=1
      	AND Seq = #{messageID}	<!-- 답글 및 하위게시글 모두 이동하도록 seq로 이동 -->
    </update>
    
    <!-- 게시물 이동시 첨부파일 정보 변경 -->
    <update id="moveMessageFile" parameterType="cmap">
        UPDATE sys_file
        SET
        	objectID = #{folderID}
        WHERE MessageID = #{messageID}
        AND ObjectType = 'FD'
        AND ObjectID = #{orgFolderID}
    </update>
    
    <!-- 게시물 이동시 본문 내용 정보 변경 -->
    <update id="moveMessageContents" parameterType="cmap">
        UPDATE sys_contents
        SET
        	objectID = #{folderID}
        WHERE MessageID = #{messageID}
        AND ObjectType = 'FD'
        AND ObjectID = #{orgFolderID}
    </update>
    
    <!-- 게시물 이동시 사용자 정의 필드 정보 변경 -->
    <update id="moveMessageUserDefField" parameterType="cmap">
        UPDATE board_userform_value
        SET
        	FolderID = #{folderID}
        WHERE MessageID = #{messageID}
        AND FolderID = #{orgFolderID}
    </update>
    
    <!-- 게시글 이동 이력 추가 -->
    <insert id="createMoveHistory" parameterType="cmap">
        INSERT INTO board_message_move (SourceMessageID, SourceFD, MoveFD, HistoryID, RegisterCode, RegistDate)
		VALUES (#{messageID}, #{orgFolderID}, #{folderID}, #{historyID}, #{userCode}, NOW(3))
    </insert>
    
    <insert id="copyMessage" parameterType="cmap">
        INSERT INTO board_message
				(FolderID, Version, IsInherited, IsCurrent, IsCheckOut, ParentID, MsgType, MsgState, CategoryID, Number, Seq, Step, Depth,
				Subject, BodyText, PopupStartDate, PopupEndDate, TopStartDate, TopEndDate, ExpiredDate,
				UseSecurity, IsPopup, IsTop, IsApproval, IsUserForm, UseScrap, NoticeMedia, UseRSS,
				UseReplyNotice, UseCommNotice, TrackBackURL, AnswerCnt, ReadCnt, 
				ScrapCnt, ReportCnt, FileCnt, FileExtension, TracbackCnt, RegistDate,
				CreatorCode, CreateDate, CreatorName, CreatorLevel, CreatorPosition, CreatorTitle, CreatorDept, 
				ModifierCode, ModifyDate,OwnerCode) 
        SELECT	#{folderID}, Version, 'Y', IsCurrent, 'N', NULL, 'C', 'C', #{categoryID}, #{number}, 0, Step, Depth,
				Subject, BodyText, NULL, NULL, NULL, NULL, '9999-12-31',
				'N', 'N', 'N', 'N', IsUserForm, 'Y', NULL, 'N',
				'N', 'N', NULL, 0, 0,
				0, 0, FileCnt, FileExtension, 0, NOW(3),
				#{creatorCode}, NOW(3), #{creatorName}, #{creatorLevel}, #{creatorPosition}, #{creatorTitle}, #{creatorDept},
				NULL, NOW(3), #{ownerCode}    
		FROM board_message
		WHERE MessageID = #{orgMessageID}
		<selectKey keyProperty="messageID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>
    
      
    <insert id="copyMessageByOrg" parameterType="cmap">
        INSERT INTO board_message
				(FolderID, Version, IsInherited, IsCurrent, IsCheckOut, ParentID, MsgType, MsgState, CategoryID, Number, Seq, Step, Depth,
				Subject, BodyText, PopupStartDate, PopupEndDate, TopStartDate, TopEndDate, ExpiredDate,
				UseSecurity, IsPopup, IsTop, IsApproval, IsUserForm, UseScrap, NoticeMedia, UseRSS,
				UseReplyNotice, UseCommNotice, TrackBackURL, AnswerCnt, ReadCnt, 
				ScrapCnt, ReportCnt, FileCnt, FileExtension, TracbackCnt, RegistDate,
				CreatorCode, CreateDate, CreatorName, CreatorLevel, CreatorPosition, CreatorTitle, CreatorDept, 
				ModifierCode, ModifyDate,OwnerCode) 
        SELECT	#{folderID}, Version, 'Y', IsCurrent, 'N', NULL, 'C', 'C', #{categoryID}, #{number}, 0, 0, 0,
				Subject, BodyText, NULL, NULL, NULL, NULL, '9999-12-31',
				'N', 'N', 'N', 'N', IsUserForm, 'Y', NULL, 'N',
				'N', 'N', NULL, 0, 0,
				0, 0, FileCnt, FileExtension, 0, NOW(3),
				#{userCode}, NOW(3), #{creatorName}, #{creatorLevel}, #{creatorPosition}, #{creatorTitle}, #{creatorDept},
				#{userCode}, NOW(3), OwnerCode      
		FROM board_message
		WHERE MessageID = #{orgMessageID}
		<selectKey keyProperty="messageID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>
    
    <!-- 게시글 스크랩 -->
    <insert id="scrapMessage" parameterType="cmap">
        INSERT INTO board_message
				(FolderID, Version, IsInherited, IsCurrent, IsCheckOut, ParentID, MsgType, MsgState, CategoryID, Number, Seq, Step, Depth,
				Subject, BodyText, PopupStartDate, PopupEndDate, TopStartDate, TopEndDate, ExpiredDate,
				UseSecurity, IsPopup, IsTop, IsApproval, IsUserForm, UseScrap, NoticeMedia, UseRSS,
				UseReplyNotice, UseCommNotice, TrackBackURL, AnswerCnt, ReadCnt, 
				ScrapCnt, ReportCnt, FileCnt, FileExtension, TracbackCnt, RegistDate,
				CreatorCode, CreateDate, CreatorName, CreatorLevel, CreatorPosition, CreatorTitle, CreatorDept, 
				ModifierCode, ModifyDate,OwnerCode) 
        SELECT	FolderID, Version, 'Y', IsCurrent, 'N', NULL, 'S', 'C', CategoryID, Number, 0, Step, Depth,
				Subject, BodyText, NULL, NULL, NULL, NULL, '9999-12-31',
				'N', 'N', 'N', 'N', IsUserForm, 'Y', NULL, 'N',
				'N', 'N', NULL, 0, 0,
				0, 0, FileCnt, FileExtension, 0, NOW(3),
				#{userCode}, NOW(3), #{creatorName}, #{creatorLevel}, #{creatorPosition}, #{creatorTitle}, #{creatorDept},
				#{userCode}, NOW(3), OwnerCode      
		FROM board_message
		WHERE MessageID = #{orgMessageID}
		<selectKey keyProperty="messageID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>
    
    <insert id="scrapMessageContents" parameterType="cmap">
        INSERT INTO sys_contents
			(ObjectID, ObjectType, MessageID, Version, Body, BodySize, Reserved1)
		SELECT ObjectID, ObjectType, #{messageID}, Version, Body, BodySize, Reserved1
		FROM sys_contents
		WHERE MessageID  = #{orgMessageID}
    </insert>
    
    <!-- 스크랩 게시글의 Seq및 정보 수정 -->
    <update id="updateScrapMessageSeq" parameterType="cmap">
        UPDATE board_message
        SET Seq = #{messageID}
        WHERE MessageID = #{messageID}
    </update>
    
    <!-- 업로드된 파일 정보 복사 -->
    <insert id="copyMessageFile" parameterType="cmap">
        INSERT INTO sys_file
			   (StorageID, ServiceType, ObjectID, ObjectType, MessageID, Version
				SaveType, Seq, FilePath, FileName, SavedName, Extention, 
				Size, Description, RegistDate) 
		SELECT 	StorageID, ServiceType, #{folderID}, ObjectType, #{messageID}, Version
				SaveType, Seq, FilePath, FileName, SavedName, Extention, 
				Size, Description, NOW(3) 
		FROM sys_file  
		WHERE MessageID  = #{orgMessageID} AND ObjectID = #{orgFolderID}
    </insert>
    <!-- 링크 옵션 복사 -->
    <insert id="copyMessageLink" parameterType="cmap">
        INSERT INTO board_mesaage_link
			(MessageID, Title, URL, RegistDate)
		SELECT #{messageID}, Title, URL, GETDATE() 
		FROM dbo.BOARD_MESSAGE_LINK 
		WHERE MessageID=#{orgMessageID}
    </insert>
    
    <!-- 태그 옵션 복사 -->
    <insert id="copyMessageTag" parameterType="cmap">
        INSERT INTO board_message_tag
			(MessageID, Tag)
		SELECT #{messageID}, Tag 
		FROM board_message_tag
		WHERE MessageID=#{OrgMessageID}	
    </insert>
    
    <insert id="copyMessageContents" parameterType="cmap">
        INSERT INTO sys_contents
			(ObjectID, ObjectType, MessageID, Version,  Body, BodySize, Reserved1)
		SELECT #{folderID}, ObjectType, #{messageID}, Version, Body, BodySize, Reserved1
		FROM sys_contents
		WHERE MessageID  = #{orgMessageID} AND ObjectID = #{orgFolderID}
    </insert>
    
    <insert id="copyMessageUserDefField" parameterType="cmap">
        INSERT INTO board_userform_value
			(MessageID, UserFormID, FolderID, FieldValue)
		SELECT #{messageID}, UserFormID, #{folderID}, FieldValue 
		FROM board_userform_value  
		WHERE MessageID=#{orgMessageID} AND FolderID=#{orgFolderID}
    </insert>
    
    <!-- 복사된 게시글의 Seq정보 수정 -->
    <update id="updateCopyMessageSeq" parameterType="cmap">
        UPDATE board_message
        SET Seq = #{messageID}
        WHERE MessageID = #{messageID}
    </update>
    
    <!-- 게시글 복사 이력 추가 -->
    <insert id="createCopyHistory" parameterType="cmap">
        INSERT INTO board_message_copy (SourceMessageID, CopyMessageID, SourceFolderID, CopyFolderID, HistoryID, RegisterCode, RegistDate)
		VALUES (#{orgMessageID}, #{messageID}, #{orgFolderID}, #{folderID}, #{historyID}, #{userCode}, NOW(3))
    </insert>
    
    <!-- 게시글 신고 -->
    <insert id="reportMessage" parameterType="cmap">
        INSERT INTO board_message_report(MessageID, HistoryID, RegisterCode, RegistDate)
        VALUES(#{messageID}, #{historyID}, #{userCode}, NOW(3))
    </insert>
    
    <!-- 게시글 신고 회수 추가 -->
    <update id="updateMessageCnt" parameterType="cmap">
        UPDATE board_message
        SET ReportCnt = IFNULL(ReportCnt, 0)+1
        WHERE MessageID = #{messageID}
    </update>
    
    <!-- 신고 게시글 중복 신고 여부 확인 -->
    <select id="checkExistReport" parameterType="cmap" resultType="java.lang.Long">
        SELECT COUNT(*) 
        FROM board_message_report
        WHERE RegisterCode = #{userCode} AND MessageID = #{messageID}
    </select>
    
    <!-- 현재 사용자 결새 Step 검색 -->
    <select id="selectProcessActivityStep" parameterType="cmap" resultType="cmap">
        SELECT Step AS step
		FROM sys_process_activity
		WHERE 1=1
		AND ProcessID = #{processID}
		AND ActorCode = #{userCode}
		AND CompleteDate IS NULL
		AND StartDate IS NOT NULL
    </select>
    
    <!-- SubStep: SubStep검색 -->
    <select id="selectProcessActivitySubStep" parameterType="cmap" resultType="cmap">
        SELECT COUNT(*) AS subStep
        FROM sys_process_activity 
        WHERE ProcessID = #{processID} 
        AND Step = #{step} 
        AND `State` = 7
    </select>
    
    <!-- LastSubStep: 전체 승인 개수 검색 -->
    <select id="selectProcessActivityLastSubStep" parameterType="cmap" resultType="cmap">
        SELECT COUNT(*) AS lastSubStep
        FROM sys_process_activity
        WHERE ProcessID = #{processID} 
        AND Step = #{step} 
    </select>
    
    <select id="selectProcessActivityLastStep" parameterType="cmap" resultType="cmap">
        SELECT MAX(Step) AS lastStep 
        FROM sys_process_activity
		WHERE ProcessID = #{processID}
		ORDER BY Step DESC
    </select>
    
    <!-- 다음 승인자 상태값 변경 -->
    <update id="updateNextApproverState" parameterType="cmap">
        UPDATE sys_process_activity
        SET `State` = 1 
        	,StartDate = NOW(3)
        WHERE ProcessID = #{processID} AND Step = #{step}
    </update>
    
    <update id="updateProcessActivity" parameterType="cmap">
        UPDATE sys_process_activity
        SET `State` = #{state}		<!-- 승인:7, 반려:9 -->
        	,CompleteDate=NOW(3)
        	,Comment = #{comment} 
        WHERE ProcessID = #{processID} 
        AND ActorCode = #{userCode}
        <if test="step == null or step == ''">
			AND Step = #{step}
		</if>
    </update>
    
    <!-- 승인 거절, 반려시 병렬 진행중인 프로세스 상태값 초기화 -->
    <update id="updateProcessActivityParallel" parameterType="cmap">
        UPDATE sys_process_activity
        SET `State` = 0		<!-- 승인:7, 반려:9 -->
        	,CompleteDate = NULL
        WHERE ProcessID = #{processID}
        AND Step = #{step} 
        AND `State` = 1
    </update>
    
    <update id="updateProcess" parameterType="cmap">
        UPDATE sys_process
        SET `State` = #{state}		<!-- 승인:7, 반려:9 -->
        	,CompleteDate=NOW(3)
        WHERE ProcessID = #{processID} 
    </update>
    
    <!-- 승인/거부 이후 게시글 상태 변경 -->
    <update id="updateMessageWorkState" parameterType="cmap">
        UPDATE board_message
        SET 
        	<if test="historyType == 'Approval'">
        		MsgState = 'A'
        		,RegistDate = NOW(3)
        		,IsCheckOut = 'N'
        	</if>
        	<if test="historyType == 'Return'">
        	    MsgState = 'D'
        	</if>
       	WHERE MessageID = #{messageID}
    </update>
    
    <!-- 체크아웃 상태 변경 -->
    <update id="updateCheckOutState" parameterType="cmap">
        UPDATE board_message 
		SET IsCheckOut = #{isCheckOut}
			,CheckOuterCode = #{checkOuterCode}
			<if test="actType == 'Revision' or actType == 'Renew'">
			    IsCurrent = 'N'
			</if>
		WHERE MessageID = #{messageID}
		AND Version = #{version}
		AND DeleteDate IS NULL
    </update>
    
    <!-- 조회기록 추가 변경전 확인 -->
    <select id="selectMessageReader" parameterType="cmap" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM board_message_reader
		WHERE MessageID = #{messageID} 
		AND ReaderCode = #{userCode}
		AND Version = #{version}
    </select>
    
    <!-- 조회수 변경 -->
    <update id="updateReadCount" parameterType="cmap">
        UPDATE board_message
        SET readcnt = readcnt + 1
        WHERE 1=1
        AND MessageID = #{messageID}
        AND Version = #{version}
    </update>
    
    <!-- 조회 이력 추가 -->
    <insert id="createMessageReader" parameterType="cmap">
        INSERT INTO board_message_reader(MessageID, Version, ReaderCode, ReadDate)
        VALUES(#{messageID}, #{version}, #{userCode}, NOW(3))
    </insert>
    
    <!-- 수정요청 추가 -->
    <insert id="createRequestModifyMessage" parameterType="cmap">
        INSERT INTO board_request_modify( MessageID, FolderID, RequestMessage, RequestorCode, RequestorName, RequestDate, RequestStatus)
        VALUES(#{messageID}, #{folderID}, #{comment}, #{userCode}, (SELECT MultiDisplayName FROM sys_object_user WHERE UserCode = #{userCode}), NOW(3), #{requestStatus})
    </insert>
    
    <select id="selectNormalPrevNextMessage" parameterType="cmap" resultType="cmap">
        SELECT * FROM ( 
		SELECT
			BM.MessageID 
			, BM.Version
			, BM.FolderID 
			, (SELECT MenuID FROM sys_object_folder WHERE FolderID = BM.FolderID) AS MenuID
			, BM.Subject  
			, DATE_FORMAT(BM.RegistDate,'%Y.%m.%d %H:%i:%s') AS RegistDate
			, BM.CreatorCode 
			, BM.CreateDate 
			, BM.Seq
			, Fn_BaseGetDictionary_S(#{lang},BM.CreatorName) AS CreatorName
			, BM.CreatorLevel, BM.CreatorPosition, BM.CreatorTitle , BM.CreatorDept 
			,(CASE BM.IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN BM.TopStartDate AND BM.TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
			, IFNULL(BMUV.UF_Value0, '') AS UF_Value0
			, IFNULL(BMUV.UF_Value1, '') AS UF_Value1
			, IFNULL(BMUV.UF_Value2, '') AS UF_Value2
			, IFNULL(BMUV.UF_Value3, '') AS UF_Value3
			, IFNULL(BMUV.UF_Value4, '') AS UF_Value4
			, IFNULL(BMUV.UF_Value5, '') AS UF_Value5
			, IFNULL(BMUV.UF_Value6, '') AS UF_Value6
			, IFNULL(BMUV.UF_Value7, '') AS UF_Value7
			, IFNULL(BMUV.UF_Value8, '') AS UF_Value8
			, IFNULL(BMUV.UF_Value9, '') AS UF_Value9
		FROM board_message AS BM
		LEFT OUTER JOIN board_category AS BC ON BM.CategoryID = BC.CategoryID AND BC.FolderID = BM.FolderID
		LEFT OUTER JOIN board_progressstate AS BP ON BM.progressstate = BP.StateID 
		LEFT OUTER JOIN board_message_userform_value AS BMUV ON (BM.MessageID = BMUV.MessageID AND BM.Version = BMUV.Version)
		<!-- 보안등급 및 열람권한 체크 -->
		<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
		LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
						 FROM (
							SELECT SRA.ObjectID, SRA.MessageID
							FROM covi_smart4j.sys_read_acl AS SRA
							WHERE SRA.ObjectType = 'FD'
							AND SRA.TargetType = 'UR'
							AND SRA.TargetCode = #{userCode}
							UNION
							SELECT SRA.ObjectID, SRA.MessageID
							FROM covi_smart4j.sys_read_acl AS SRA
							WHERE SRA.ObjectType = 'FD'
							AND SRA.TargetType != 'UR'
							AND SRA.TargetCode IN
							<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
					            #{item}
						    </foreach>
						) AS SRA) SRA ON BM.FolderID = SRA.ObjectID AND BM.MessageID = SRA.MessageID
		</if>
		WHERE 1=1
		AND BM.MsgState IN ('C', 'A') 
		AND MsgType != 'S' 
		AND (UseSecurity != 'Y' OR (UseSecurity = 'Y' AND CreatorCode = #{userCode}))
		AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate} ) 
		AND DeleteDate IS NULL
		AND BM.FolderID = #{folderID}
		AND BM.Depth = 0
		<if test='IsUseListRestriction == null or IsUseListRestriction == "N"'>
			AND IFNULL(BM.SecurityLevel,999) >= (SELECT SecurityLevel FROM sys_object_user WHERE UserCode = #{userCode})
		</if>
		AND BM.IsCurrent = 'Y'
		<!-- CHECK: 권한체크, 열람권한 체크 -->
		<!-- AND (A.IsMessageReadAuth='Y' AND A.MessageID IN (SELECT MessageID FROM Fn_ComMessageReadAclCheck_T('Board', @DN_Code, @GR_Code, #{userCode})) OR (A.IsMessageReadAuth='N')) -->
		<if test="folderType != null and folderType == 'OneToOne'">
		    	AND (BM.Depth = 0 AND BM.OwnerCode = #{userCode} OR (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = #{folderID}) LIKE CONCAT('%',#{userCode},';%'))
		</if>
		<if test="categoryID != null and categoryID != ''">
	        <choose>
		    	<when test="categoryGubun == 'Y'">
		    	    AND (BC.MemberOf = #{categoryID} OR BC.CategoryID = #{categoryID})
		        </when>
		        <otherwise>
		            AND BM.CategoryID = #{categoryID}
		        </otherwise>
		    </choose>
	    </if>
	    <if test="readSearchType != null and readSearchType != ''">
	       <!-- CHECK: 읽음/읽음 조회 설정 -->
	       AND BM.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
	    </if>
	    <!-- 보안등급 및 열람권한 체크 -->
		<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
	       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
	                 ELSE CASE WHEN (BM.SecurityLevel = '256' OR BM.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
	                	  ELSE 'N' END
	                 END) = 'Y'
	              		                		  
	       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
	                 ELSE CASE WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
				     		   WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
				     		   ELSE 'N' END
				     END) = 'Y'
	    </if>
	    <!-- 검색어 항목 -->
		<if test="searchText != null and searchText != ''">
			<choose>
		        <when test="searchType == 'Total'">
		            AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
		       	</when>
		       	<when test="searchType == 'Mobile'">
		       	    AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
		       	</when>		       	
		       	<otherwise>
					AND 
					<choose>
						<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
						<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
						<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
						<otherwise>BM.Subject </otherwise>
					</choose>
					LIKE CONCAT('%',#{searchText},'%')   
		       	</otherwise>
			</choose>		
		</if>
		<if test="startDate != '' or endDate != ''">
			AND BM.RegistDate between #{startDate} and #{endDate}		
		</if>
		) AS RESULT
		WHERE 1=1
		<choose>
		    <when test="mode == 'prev'" >
		        <choose>
				    <when test="sortColumn != null and sortColumn != ''" >
				        AND #{sortColumn} &lt; (
				        	SELECT #{sortColumn} FROM board_message AS BM
				        	LEFT OUTER JOIN board_message_userform_value AS BMUV ON (BM.MessageID = BMUV.MessageID AND BM.Version = BMUV.Version)
				        	WHERE BM.MessageID = #{messageID} AND BM.Version = #{version})
						ORDER BY #{sortColumn} DESC
				    </when>
				    <otherwise>
						AND Seq &lt; (SELECT Seq FROM board_message WHERE MessageID = #{messageID} AND Version = #{version})
						ORDER BY Seq DESC
				    </otherwise> 
			    </choose>
		    </when>
		    <otherwise> <!-- next -->
		        <choose>
				    <when test="sortColumn != null and sortColumn != ''" >
				        AND #{sortColumn} &gt; (
				        	SELECT #{sortColumn} FROM board_message AS BM
				        	LEFT OUTER JOIN board_message_userform_value AS BMUV ON (BM.MessageID = BMUV.MessageID AND BM.Version = BMUV.Version)
				        	WHERE BM.MessageID = #{messageID} AND BM.Version = #{version})
						ORDER BY #{sortColumn} ASC
				    </when>
				    <otherwise>
						AND Seq &gt; (SELECT Seq FROM board_message WHERE MessageID = #{messageID} AND Version = #{version})
						ORDER BY Seq ASC
				    </otherwise>		  
			    </choose>
		    </otherwise>		  
	    </choose>
	    LIMIT 1
    </select>
    
    <select id="selectPrevNextMessage" parameterType="cmap" resultType="cmap">
        SELECT * FROM (
        	SELECT * FROM(
				SELECT 
					BM.MessageID ,BM.Version
					,H.DisplayName AS FolderName
					, (SELECT MenuID FROM sys_object_folder WHERE FolderID = BM.FolderID) AS MenuID
					,H.FolderID
					,BM.CategoryID
					,BM.Seq			,BM.Step			,BM.Depth
					,BM.Subject
					,DATE_FORMAT(BM.RegistDate, '%Y.%m.%d %H:%i:%s') AS RegistDate
					,BM.CreatorCode 
					,B.DisplayName AS CreatorName
					,BM.CreatorLevel		,BM.CreatorPosition		,BM.CreatorTitle		,BM.CreatorDept
					,(SELECT COUNT(*) 
					 	FROM sys_comment 
					   WHERE DeleteDate IS NULL 
					 	<choose>
							<when test="bizSection != null and bizSection != '' and (bizSection == 'Board' or bizSection == 'Doc' or bizSection == 'Community')">
								AND TargetServiceType IN ('Board', 'Doc', 'Community')
							</when>
							<otherwise>
								AND TargetServiceType = #{bizSection}
							</otherwise>
						</choose>
				 	 AND TargetID = CONCAT(BM.MessageID,'_',BM.Version)) AS CommentCnt 
					,(CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
					,BM.MsgState
					,BM.MsgType
					<choose>
				    	<when test="boardType == 'RequestModify'">
				    	    ,M.RequestID						<!-- 수정요청 ID -->
				    	    ,M.RequestMessage					<!-- 수정요청 사유 -->
				    	    ,M.RequestorCode					<!-- 수정요청자 -->
				    	    ,M.RequestorName					<!-- 이름 -->
				    	    ,M.RequestDate					<!-- 수정요청 일자 -->
				    	    ,M.AnswererCode					<!-- 답변/처리자 ID -->
				    	    ,M.AnswererName					<!-- 답변/처리자 이름 -->
				    	    ,M.AnswerContent					<!-- 답변 처리 코멘트 -->
				    	    ,M.AnswerDate						<!-- 답변 일자 -->
				    	    ,M.RequestStatus					<!-- 처리 상태 -->
				    	</when>
				    	<when test="boardType == 'Approval'">
				    	    , F.ProcessID AS ProcessID
							, F.ProcessDefID AS ProcessDefID 
							, F.State AS ProcessState 
							, F.RegistDate AS ProcessRegistDate
							, F.RegisterCode AS ProcessRegisterCode
							, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID AND State = 1 AND ActorCode = #{userCode}) AS State
							, (SELECT State FROM sys_process_activity WHERE ActorCode = #{userCode} and ProcessID = F.ProcessID and ActorRole = 'Register') AS ActivityState
							, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID) AS TotalApproverCnt
							, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID AND State IN (7,9)) AS TotalApprovalCnt 
				    	</when>
				    	<when test="boardType == 'CheckIn' or boardType == 'CheckOut'">
				    	 	, DIH.CO_Date, DIH.CI_Date
				    	</when>
			    	</choose>
				FROM board_message AS BM
				INNER JOIN sys_object_folder AS H ON BM.FolderID = H.FolderID AND H.IsUse = 'Y' AND H.DeleteDate IS NULL
				LEFT OUTER JOIN sys_object_user AS B ON (CASE WHEN BM.MsgType='S' THEN BM.OwnerCode ELSE BM.CreatorCode END) = B.UserCode
				LEFT OUTER JOIN board_category AS BC ON BM.CategoryID = BC.CategoryID AND BC.FolderID = BM.FolderID
				LEFT OUTER JOIN BOARD_PROGRESSSTATE as P ON BM.progressstate = P.StateID
				<!-- 보안등급 및 열람권한 체크 -->
				<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
				LEFT OUTER JOIN (SELECT SRA.ObjectID, SRA.MessageID
								 FROM (
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType = 'UR'
									AND SRA.TargetCode = #{userCode}
									UNION
									SELECT SRA.ObjectID, SRA.MessageID
									FROM covi_smart4j.sys_read_acl AS SRA
									WHERE SRA.ObjectType = 'FD'
									AND SRA.TargetType != 'UR'
									AND SRA.TargetCode IN
									<foreach item="item" index="index" collection="groupPath" open="(" close=")" separator=",">
							            #{item}
								    </foreach>
								) AS SRA) SRA ON BM.FolderID = SRA.ObjectID AND BM.MessageID = SRA.MessageID
				</if>
				<choose>
				    <when test="boardType == 'Normal'">
			    	    <!-- 에러나야해 -->
			    	    ERROR!!
			    	</when>
			    	<when test="boardType == 'MyInterest'"> <!-- 전 즐겨찾기 -->
			    	    INNER JOIN board_message_favorite AS J ON BM.MessageID=J.MessageID AND J.RegisterCode=#{userCode}
			    	</when>
			    	<when test="boardType == 'RequestModify'">
			    	    INNER JOIN board_request_modify AS M ON (BM.MessageID=M.MessageID AND M.RequestStatus != 'Deleted')
			    	</when>
			    	<when test="boardType == 'Approval'">
						INNER JOIN sys_process AS F ON BM.MessageID=F.MessageID AND F.ObjectType=#{bizSection} 
						AND F.ProcessID IN (SELECT DISTINCT ProcessID FROM sys_process_activity WHERE ActorCode = #{userCode} AND ActorRole != 'Register' )	
			    	</when>
			    	<when test="boardType == 'CheckIn' or boardType == 'CheckOut'">
			    	    LEFT OUTER JOIN doc_inout_history AS DIH ON (BM.MessageID = DIH.MessageID AND BM.`Version` = DIH.`Version` AND DIH.DeleteDate IS NULL)
			    	</when>
		    	</choose>
				WHERE 1=1
				AND BM.Depth = 0
				<if test='aclDataArr != null and aclDataArr.length != 0'>
					AND BM.FolderID IN  
					<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
						#{item}
					</foreach>
				</if>
		    	AND (H.MenuID = #{menuID} OR H.DomainID = 0)
				<if test="bizSection == 'Board'">
				    AND MsgType NOT IN ('N', 'B')
				</if>
				<if test="bizSection == 'Doc'">
				    AND MsgType IN ('N', 'B')
				</if>
				<choose>
				    <when test="boardType == 'Total'">
				        AND H.FolderType != 'OneToOne'	<!-- 1:1게시 표시하지 않음 -->
				        <if test='IsUseListRestriction == null or IsUseListRestriction == "N"'>
				        	AND IFNULL(BM.SecurityLevel,999) >= (SELECT SecurityLevel FROM sys_object_user WHERE UserCode = #{userCode})
				        </if>
			    	    AND BM.MsgState IN ('C', 'A') 
						AND BM.MsgType != 'S' 
						AND (UseSecurity != 'Y' OR (UseSecurity = 'Y' AND BM.CreatorCode = #{userCode}))
						AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate} ) 
						AND BM.DeleteDate IS NULL
			    	</when>
				    <when test="boardType == 'Normal'">
			    	    <!-- 에러나야해 -->
			    	    ERROR
			    	</when>
			    	<when test="boardType == 'MyInterest'">	<!-- 전 즐겨찾기 게시판 -->
			    	    AND BM.ExpiredDate >= #{localCurrentDate}
						AND (MsgState IN ('C', 'A')) AND (MsgType IN ('O', 'C', 'M'))
			    	</when>
			    	<when test="boardType == 'MyOwnWrite'">
			    	    AND BM.CreatorCode = #{userCode}
						AND MsgState != 'T' AND MsgType != 'S' 
			    	</when>
			    	<when test="boardType == 'RequestModify'">
			    	    AND M.RequestorCode = #{userCode}
			    	</when>
			    	<when test="boardType == 'Scrap'">
			    	    AND BM.ModifierCode = #{userCode}
						AND (MsgState IN ('C')) AND (MsgType IN ('S'))	<!-- C:등록 상태, S: 스크랩 -->
			    	</when>
			    	<when test="boardType == 'OnWriting'">
			    	    AND BM.CreatorCode = #{userCode}
						AND MsgState IN ('T')							<!-- T:임시저장 -->
			    	</when>
			    	<when test="boardType == 'MyBooking'">
			    	    AND BM.CreatorCode = #{userCode}
			    	    AND (BM.ReservationDate IS NOT NULL AND BM.ReservationDate >= #{localCurrentDate})
		<!-- 				AND MsgState IN ('BC', 'BA') -->
			    	</when>
		    	</choose>
			    <!-- 카테고리별 검색 기능 사용시 참조 -->
			    <if test="categoryID != null and categoryID != ''">
			        <choose>
				    	<when test="categoryGubun == 'Y'">
				    	    AND (BC.MemberOf = #{categoryID} OR BC.CategoryID = #{categoryID})
				        </when>
				        <otherwise>
				            AND BM.CategoryID = #{categoryID}
				        </otherwise>
				    </choose>
			    </if>
			    <if test="requestStatus != null and requestStatus != ''">
			        <choose>
				    	<when test="requestStatus == 'Ready'">
				    	    AND MsgState IN ('Ready')
				        </when>
				        <when test="requestStatus == 'Process'">
				    	    AND MsgState IN ('Process')
				        </when>
				        <otherwise>
				            AND MsgState IN ('Complete')
				        </otherwise>
				    </choose>
			    </if>
			    <!-- 보안등급 및 열람권한 체크 -->
				<if test='IsUseListRestriction != null and IsUseListRestriction == "Y"'>
			       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
			                 ELSE CASE WHEN (BM.SecurityLevel = '256' OR BM.SecurityLevel <![CDATA[ >= ]]> #{userSecurityLevel}) THEN 'Y'
			                	  ELSE 'N' END
			                 END) = 'Y'
			              		                		  
			       AND (CASE WHEN BM.OwnerCode = #{userCode} THEN 'Y'
			                 ELSE CASE WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'N' THEN 'Y' 
						     		   WHEN IFNULL(BM.UseMessageReadAuth, 'N') = 'Y' AND IFNULL(SRA.MessageID, '') != '' THEN 'Y' 
						     		   ELSE 'N' END
						     END) = 'Y'
			    </if>			    
			    <!-- 검색어 항목 -->
				<if test="searchText != null and searchText != ''">
					<choose>
				        <when test="searchType == 'Total'">
				            AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%') )
				       	</when>
				       	<when test="searchType == 'Mobile'">
				       	    AND ( BM.Subject LIKE CONCAT('%',#{searchText},'%')  || BM.BodyText LIKE CONCAT('%',#{searchText},'%')  || BM.CreatorName LIKE CONCAT('%',#{searchText},'%') )
				       	</when>
				       	<otherwise>
							AND 
							<choose>
								<when test='searchType.equalsIgnoreCase("BodyText")'>BM.BodyText </when>
								<when test='searchType.equalsIgnoreCase("CreatorName")'>BM.CreatorName </when>
								<when test='searchType.equalsIgnoreCase("Number")'>BM.Number </when>
								<otherwise>BM.Subject </otherwise>
							</choose>
							LIKE CONCAT('%',#{searchText},'%')   
				       	</otherwise>
					</choose>	
				</if>
				<if test="startDate != '' or endDate != ''">
					AND BM.RegistDate between #{startDate} and #{endDate}		
				</if>
			) AS M
			WHERE 1=1
		   	<choose>
			    <when test="mode == 'prev'" >
			        <choose>
					    <when test="sortColumn != null and sortColumn != ''" >
					        AND #{sortColumn} &lt; ( SELECT #{sortColumn} FROM board_message WHERE MessageID = #{messageID} AND Version = #{version} )
							ORDER BY #{sortColumn} DESC
					    </when>
					    <otherwise>
							AND Seq &lt; (SELECT Seq FROM board_message WHERE MessageID = #{messageID} AND Version = #{version})
							ORDER BY Seq DESC
					    </otherwise> 
				    </choose>
			    </when>
			    <otherwise> <!-- next -->
			        <choose>
					    <when test="sortColumn != null and sortColumn != ''" >
					        AND #{sortColumn} &gt; ( SELECT #{sortColumn} FROM board_message WHERE MessageID = #{messageID} AND Version = #{version} )
							ORDER BY #{sortColumn} ASC
					    </when>
					    <otherwise>
							AND Seq &gt; (SELECT Seq FROM board_message WHERE MessageID = #{messageID} AND Version = #{version})
							ORDER BY Seq ASC
					    </otherwise>		  
				    </choose>
			    </otherwise>		  
		    </choose>
	    	LIMIT 1
	    ) AS RESULT
	    WHERE 1=1
	    <choose>
			<when test="boardType == 'Approval'">
	    	    <choose>
			    	<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
			    		AND (MsgState IN ('R', 'BR')) AND (MsgType IN ('O', 'N', 'B')) AND State &gt; 0
			        </when>
			        <when test='approvalStatus == "A"'> <!-- 승인 완료된 게시 -->
			    		AND (MsgState IN ('A', 'BA')) AND (MsgType IN ('O', 'N', 'B')) AND State = 0
			        </when>
			        <when test='approvalStatus == "D"'> <!-- 반려된 게시 -->
			    		AND (MsgState IN ('D')) AND (MsgType IN ('O', 'N', 'B')) AND State = 0
			        </when>
			        <when test='approvalStatus == "P"'> <!-- 다른사람이 결제해야할 승인 요청 게시 -->
			    		AND (MsgState IN ('R')) AND (MsgType IN ('O', 'N', 'B')) AND State = 0
			        </when>
			        <otherwise>
			            AND (MsgState IN ('R', 'D', 'A', 'BR', 'BA')) AND (MsgType IN ('O', 'N', 'B'))
			        </otherwise>
			    </choose>
	    	</when>
    	</choose>
    </select>
    
    <select id="selectBodyFormData" parameterType="cmap" resultType="cmap">
        SELECT B.FormPath
        	, B.FileID
        	, S.FilePath AS "StorageFilePath"
        	, F.FilePath AS "FileFilePath"
        	, F.SavedName
        	, F.CompanyCode
        	, CONCAT(REPLACE(S.FilePath,'{0}',F.CompanyCode), F.FilePath,F.SavedName) AS "FullPath"
        FROM board_bodyform B
        LEFT OUTER JOIN sys_file F ON F.FileID = B.FileID
        LEFT OUTER JOIN sys_storage S ON S.StorageID = F.StorageID
        WHERE B.BodyFormID = #{bodyFormID}
    </select>
    
    <!-- 컨텐츠 타입 폴더의 게시물 조회. 미삭제 게시글 중 최신등록 1건으로 제한 -->
    <select id="selectContentMessage" parameterType="cmap" resultType="cmap">
 	    SELECT MessageID,
 	    	FolderID,
 	    	Version
 	    FROM board_message 
 	    WHERE FolderID = #{folderID} 
 	    AND DeleteDate IS NULL
 	    ORDER BY RegistDate DESC
        LIMIT 1
 	</select>
 	
    <!-- 게시판 담당자 조회 -->
    <select id="selectMessageOwner" parameterType="cmap" resultType="cmap">
        SELECT OwnerCode
        FROM sys_object_folder
        WHERE 1=1
        AND FolderID = #{folderID}
    </select>
    
    <!-- 게시판 개정 이력 조회 -->
    
    
    <!-- 연결 게시글 일괄삭제 후 재등록 -->
    <delete id="deleteLinkedMessage" parameterType="cmap">
        DELETE FROM board_linked
        WHERE MessageID = #{messageID}
        AND Version = #{version}
    </delete>
    
    <!-- 연결 게시글/바인더 등록-->
    <insert id="createLinkedMessage" parameterType="cmap">
        INSERT INTO board_linked(MessageID, Version, TargetID, ServiceType, RegisterCode, RegistDate)
        VALUES(#{messageID}, #{version}, #{targetID}, #{bizSection}, #{userCode}, NOW(3))
    </insert>
    
    <select id="selectLinkedMessageList" parameterType="cmap" resultType="cmap">
        SELECT BL.TargetID AS MessageID
  			,BL.Version AS Version
  			,BM.FolderID AS FolderID
  			,BM.Subject AS DisplayName
  		FROM board_linked AS BL
  		INNER JOIN board_message AS BM ON (BM.MessageID = BL.TargetID)
  		WHERE 1=1
  		AND BL.ServiceType = #{bizSection}
  		AND BL.MessageID = #{messageID}
  		AND BL.Version = #{version}
  		AND BM.IsCurrent = 'Y'
    </select>
    
    <!-- 권한 요청 -->
    <select id="selectRequestAclInfo" parameterType="cmap" resultType="cmap">
    	SELECT AclList, TargetCode
    	FROM doc_request_acl
    	WHERE 1=1
    	AND RequestID = #{requestID}
    </select>
    
    <select id="selectRequestAclDetail" parameterType="cmap" resultType="cmap">
        select DRA.RequestID , DRA.RegisterCode AS RequestorCode , 
		(SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = DRA.RegisterCode) AS RequestorName , 
		DRA.RequestMessage , 
		DATE_FORMAT(DRA.RequestDate, '%Y.%m.%d %H:%i:%s') AS RequestDate , 
		DRA.AclList AS RequestAclList , DRA.ActType 
		FROM doc_request_acl AS DRA
		WHERE RequestID = #{requestID}
    </select>
    
    <select id="checkDuplicateRequest" parameterType="cmap" resultType="java.lang.Long">
        SELECT COUNT(0)
        FROM doc_request_acl
        WHERE 1=1
        AND MessageID = #{messageID}
        AND Version = #{version}
        AND TargetCode = #{userCode}
        AND ActorCode = #{ownerCode}
        AND ActType = 'R'
    </select>
    
    <insert id="createRequestAuth" parameterType="cmap">
        INSERT INTO doc_request_acl(MessageID, Version, TargetCode, AclList, RequestMessage, RegisterCode, ActorCode, ActType)
        VALUES(#{messageID}, #{version}, #{userCode}, #{aclList}, #{requestMsg}, #{userCode}, #{ownerCode}, 'R')
    </insert>
    
    <insert id="updateRequestAuthInfo" parameterType="cmap">
		INSERT INTO board_message_acl(MessageID, `Version`, TargetCode, TargetType, AclList, `Security`, `Create`, `Delete`, `Modify`, `Execute`, `Read`, registercode)
		VALUES(#{messageID}, #{version}, #{targetCode}, 'UR', #{aclList}, #{security}, #{create}, #{delete}, #{modify}, #{execute}, #{read}, #{userCode})
		ON DUPLICATE KEY UPDATE
		AclList  = #{aclList}, `Security`=#{security}, `Create`=#{create}, `Delete`=#{delete}, `Modify`=#{modify}, `Execute`=#{execute}, `Read`=#{read}
    </insert>
    
    <update id="updateRequestAuth" parameterType="cmap">
        UPDATE doc_request_acl SET
        	ActType = #{ActType}
        	,ActMessage = #{ActMessage}
        WHERE RequestID = #{requestID}
    </update>
    
    <!-- 문서 배포 -->
    
    <insert id="createDistribution" parameterType="cmap">
        INSERT INTO doc_distribution(MessageID,		Version,	DistributeDate,		DistributeMsg,	RegisterCode)
		VALUES(#{messageID}, #{version}, NOW(),	#{comment},	#{userCode})
		<selectKey keyProperty="distributeID" resultType="long" order="AFTER">
			SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>
    
    <insert id="createDistributionTarget" parameterType="cmap">
        INSERT INTO doc_distribution_target(DistributeID, TargetCode, TargetType)
		VALUES(#{distributeID}, #{targetCode}, #{targetType})
    </insert>
    
    <insert id="updateDistributionTargetAuth" parameterType="cmap">
		INSERT INTO board_message_acl(MessageID, `Version`, TargetCode, TargetType, AclList, `Create`, `Execute`, `Read`, registercode)
		VALUES(#{messageID}, #{version}, #{targetCode}, #{targetType}, '____ER', '_', 'E', 'R', #{userCode})
		ON DUPLICATE KEY UPDATE
		AclList = CONCAT(LEFT(AclList, 4), 'ER'), `Execute`='E', `Read`='R'
    </insert>
    
    <insert id="createDistributionConfirm" parameterType="cmap">
        INSERT INTO doc_distribution_confirm(DistributeID,	UserCode)
        <choose>
            <when test="targetType == 'UR'">
                VALUES(#{distributeID}, #{targetCode})
            </when>
            <when test="targetType == 'GR'">
                Select #{distributeID}, UserCode from sys_object_group AS SOG
				LEFT OUTER JOIN sys_object_group_member AS SOGM ON (SOG.GroupCode = SOGM.GroupCode)
				WHERE SOGM.GroupCode = #{targetCode}
				AND SOGM.IsUse = 'Y'
				AND SOG.IsUse = 'Y'
				GROUP BY SOGM.UserCode
            </when>
			<when test="targetType == 'CM'">
				Select #{distributeID}, UserCode from sys_object_group AS SOG
				LEFT OUTER JOIN sys_object_group_member AS SOGM ON (SOG.GroupCode = SOGM.GroupCode)
				WHERE SOG.CompanyCode = #{targetCode}
				AND SOGM.IsUse = 'Y'
				AND SOG.IsUse = 'Y'
				GROUP BY SOGM.UserCode
			</when>
        </choose>
    </insert>
    
    <!-- 문서번호 자동발번 조회 -->
    <select id="selectAutoDocNumber" parameterType="cmap" resultType="String">
        SELECT Fn_DocNumberCreate_S(#{domainID}, #{folderID}, #{groupCode}, #{userCode})
    </select>
    
    <!-- 문서번호 발번 현황 업데이트 -->
    <insert id="updateAutoDocNumber" parameterType="cmap">
        INSERT INTO doc_number(DomainID, `Prefix`, Number, CreateDate)
		VALUES(#{domainID}, #{prefix}, 1, NOW())
		ON DUPLICATE KEY UPDATE
		Number = Number+1
    </insert>
    
    <!-- 웹파트용 공지 게시판 목록 조회 -->
    <select id="selectNoticeMessageList" parameterType="cmap" resultType="cmap">
		SELECT
			SOF.MenuID
			,BM.FolderID
			,BM.Subject
			,BM.Version
			,BM.MessageID
			,Fn_BaseGetDictionary_S(#{lang}, SOF.MultiDisplayName) AS FolderName
			, (SELECT COUNT(*) FROM sys_comment WHERE DeleteDate IS NULL AND TargetServiceType='Board' AND TargetID = CONCAT(BM.MessageID,'_',BM.Version))AS CommentCnt 
			,BM.CreatorCode 
			,DATE_FORMAT(BM.CreateDate, '%Y-%m-%d %H:%i:%s') AS CreateDate
			,IF(BM.UsePubDeptName = 'Y', Fn_BaseGetDictionary_S(#{lang},BM.CreatorDept), Fn_BaseGetDictionary_S(#{lang},BM.CreatorName)) AS CreatorName
			,(SELECT OwnerCode FROM sys_object_folder WHERE FolderID = BM.FolderID) AS FolderOwnerCode
			,(CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
			,(SELECT MAX(FileID) FROM sys_file WHERE ObjectType ='FD' AND ObjectID = BM.FolderID AND MessageID = BM.MessageID AND SaveType='IMAGE') AS FileID 
		FROM board_message AS BM
		INNER JOIN sys_object_folder AS SOF ON (BM.FolderID = SOF.FolderID)
		WHERE 1=1
		AND SOF.FolderType = 'Notice'
		AND SOF.ObjectType = 'Board'
		AND SOF.DeleteDate IS NULL
		AND SOF.IsUse = 'Y'
		AND SOF.DomainID IN (0, #{domainID})
		AND BM.DeleteDate IS NULL
		AND BM.MsgType IN ('O', 'C', 'M')
		AND BM.RegistDate <![CDATA[<=]]> #{localCurrentDate}
		AND IFNULL(BM.SecurityLevel,999) >= (SELECT SecurityLevel FROM sys_object_user WHERE UserCode = #{userCode})
		AND (BM.UseSecurity != 'Y' OR (BM.UseSecurity = 'Y' AND BM.CreatorCode = #{userCode}))
		AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate}) 
		AND BM.MsgState IN ('C', 'A') 
		<if test='aclDataArr != null and aclDataArr.length != 0'>
			AND BM.FolderID IN  
			<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
		ORDER BY BM.CreateDate DESC
		LIMIT 3;	<!-- 공지 웹파트는 3개만 조회함 -->
    </select>
    
    <select id="selectLatestMessageList" parameterType="cmap" resultType="cmap">
       SELECT
			(SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM DUAL) AS FolderName,
			RESULT.MessageID,
			FolderID,
			`Version`,
			Subject,
			DATE_FORMAT(CreateDate, '%Y-%m-%d %H:%i:%s') AS CreateDate,
			MenuID
			<!-- ,CONCAT(FilePath, SavedName) AS FilePath -->
		FROM (
			SELECT 
		        	SOF.MultiDisplayName,
			   	BM.MessageID,
					BM.FolderID,
					BM.`Version`,
					BM.Subject,
					BM.CreateDate,
					SOF.MenuID
				FROM board_message AS BM
				INNER JOIN sys_object_folder AS SOF ON BM.FolderID = SOF.FolderID
				LEFT JOIN BOARD_CONFIG AS BC ON BM.FolderID = BC.FolderID
				LEFT JOIN BOARD_CONFIG_DEFAULT AS BCD ON SOF.FolderType = BCD.FolderType
				WHERE 1=1
				AND BM.DeleteDate IS NULL
				AND SOF.DeleteDate IS NULL 
				AND SOF.IsUse = 'Y'
				AND BM.IsCurrent = 'Y'
				AND BM.MsgState IN ('C', 'A')
				<if test="bizSection == 'Board'">
				    AND MsgType IN ('O', 'C', 'M')
				</if>
				<if test="bizSection == 'Doc'">
				    AND MsgType IN ('N', 'B')
				</if>
				AND BM.RegistDate <![CDATA[<=]]> #{localCurrentDate}
				AND IF(SOF.FolderType = 'OneToOne', BM.OwnerCode = #{userCode} OR (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = BM.FolderID) LIKE CONCAT('%',#{userCode},';%') , 1=1)
				AND IFNULL(BM.SecurityLevel,999) >= (SELECT SecurityLevel FROM sys_object_user WHERE UserCode = #{userCode})
				AND (BM.UseSecurity != 'Y' OR (BM.UseSecurity = 'Y' AND BM.CreatorCode = #{userCode}))
				AND (BM.ExpiredDate IS NULL OR  BM.ExpiredDate >= #{localCurrentDate}) 
				AND SOF.ObjectType = #{bizSection}
				<if test='aclDataArr != null and aclDataArr.length != 0'>
					AND BM.FolderID IN  
					<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
						#{item}
					</foreach>
				</if>
				AND CONCAT(';',#{menuID},';') LIKE CONCAT('%;',SOF.MenuID, ';%')
				<if test="bizSection == 'Board'">
					AND IFNULL(BC.UseIncludeRecentReg, BCD.UseIncludeRecentReg) = 'Y'
				</if>
				ORDER BY BM.RegistDate DESC
				LIMIT 5
		) AS RESULT
		<!-- LEFT JOIN (
			SELECT MessageID, FilePath, SavedName 
			FROM SYS_FILE 
			WHERE ServiceType = 'Board' AND SaveType = 'IMAGE' GROUP BY MessageID HAVING MessageID = MIN(MessageID)
		) AS FI ON FI.MessageID = RESULT.MessageID -->
    </select>
    
    <select id="selectOriginReplyNotice" parameterType="cmap" resultType="String">
        SELECT IFNULL(useReplyNotice, 'N')
        FROM board_message
        WHERE 1=1
        AND MessageID = #{seq}
    </select>
    
    <select id="selectOriginMediaType" parameterType="cmap" resultType="String">
        SELECT NoticeMedia
        FROM board_message
        WHERE 1=1
        AND MessageID = #{seq}
    </select>
    
    <!-- mobile -->
    
    <!-- 상세 보기 조회 쿼리 -->
    <select id="selectMessageDetailSimple" parameterType="cmap" resultType="cmap">
        SELECT  
			A.MessageID, 
			A.FolderID, 
			IFNULL(Fn_BaseGetDictionary_S(#{lang}, SOF.MultiDisplayName), '') AS FolderName,
			IFNULL(A.CategoryID, 0) AS CategoryID, 
			IFNULL(Fn_BaseGetDictionary_S(#{lang}, C.DisplayName), '') AS CategoryName,
			A.Subject, 
			IsTop
		FROM board_message AS A
			LEFT OUTER JOIN board_category as C ON A.FolderID = C.FolderID AND A.CategoryID = C.CategoryID
			LEFT OUTER JOIN sys_object_folder as SOF on A.FolderID = SOF.FolderID
		WHERE A.MessageID = #{messageID} 
			AND A.Version = #{version}
    </select>
    
    <!-- 다음 승인자 조회 -->
    <select id="selectNextApprover" parameterType="cmap" resultType="String">
    	SELECT GROUP_CONCAT(ActorCode SEPARATOR ';') AS actorCode
    	FROM covi_smart4j.sys_process_activity
    	WHERE 1=1
    	AND state = 1
    	AND ProcessID = #{instanceID}
    </select>
    
    <!-- 승인 게시글 정보 조회 -->
    <select id="selectApprovalMessageInfo" parameterType="cmap" resultType="cmap">
    	SELECT SOF.MenuID AS menuID, SOF.FolderID AS folderID, BM.Subject AS subject
    	FROM covi_smart4j.board_message AS BM
    	INNER JOIN covi_smart4j.sys_object_folder AS SOF ON (BM.FolderID = SOF.FolderID)
    	WHERE 1=1
    	AND MessageID = #{messageID}
    </select>
    
    
    <!--[본사운영] 품질관리 - SCC 연동: key Mapping table INSERT   -->
     <insert id="insertSCCMappingInfo" parameterType="cmap">
        INSERT INTO scc_board_message(MessageID, Version, FolderID, SCCKey, SCCType)
		VALUES(#{messageID}, #{version}, #{folderID}, #{sccKey}, #{sccType})
    </insert>
    
    
    <!--[본사운영] 품질관리 - SCC 연동: 사용자 정의 Field 조회  -->
    <select id="selectSCCUserForm" parameterType="cmap" resultType="cmap">
    	SELECT UserFormID 
			, '' AS FieldValue
			, '' AS FieldText
		FROM covi_smart4j.board_userform
		WHERE FolderID = #{folderID}
		AND DeleteDate IS NULL
		ORDER BY SortKey ASC
    </select>
    
    <!--[본사운영] 품질관리 - SCC 연동: SCC Key 조회  -->
    <select id = "selectSCCKey" parameterType="cmap" resultType="cmap">
    	SELECT SCCKey, SCCType
		FROM covi_smart4j.scc_board_message
		WHERE MessageID = #{messageID}
		AND Version = #{version}
		AND FolderID = #{folderID}
    </select>
    
    <!-- 웹파트 - 링크사이트 게시글 조회 -->
    <select id="selectSystemLinkBoardList" parameterType="cmap" resultType="cmap">
		SELECT BM.*, BUO.SortKey AS "OpenType"
		FROM covi_smart4j.sys_object_folder AS SOF
		INNER JOIN covi_smart4j.board_message AS BM ON BM.FolderID = SOF.FolderID
		LEFT OUTER JOIN covi_smart4j.board_message_userform_value AS BMUV ON (BM.MessageID = BMUV.MessageID AND BM.Version = BMUV.Version) AND BMUV.FolderID = BM.FolderID
		LEFT OUTER JOIN covi_smart4j.board_userform_option AS BUO ON BUO.FolderID = BM.FolderID AND BUO.OptionName = BMUV.UF_Value0
		WHERE SOF.ObjectType = 'Board'
		AND SOF.FolderType = 'LinkSite'
		<if test="folderID != null and folderID != ''">
			AND SOF.FolderID = #{folderID}
		</if>
		AND SOF.DomainID = #{domainID}
		AND BM.DeleteDate IS NULL
		AND BM.MsgState IN ('C', 'A')
		AND BM.MsgType != 'S'
		AND (BM.UseSecurity != 'Y' OR (BM.UseSecurity = 'Y' AND BM.CreatorCode = #{userCode}))
		AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= #{localCurrentDate})
		AND (BM.ReservationDate IS NULL OR BM.ReservationDate &lt; #{localCurrentDate})
		AND IFNULL(BM.SecurityLevel, 999) >= (SELECT BM.SecurityLevel FROM covi_smart4j.sys_object_user WHERE UserCode = #{userCode})
		AND BM.IsCurrent = 'Y'
		ORDER BY CAST(IFNULL(BMUV.UF_Value1, 0) AS UNSIGNED) ASC
	</select>
	
	<select id="selectBoardGroupName" parameterType="cmap" resultType="String">
		SELECT covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) AS GroupName
		FROM covi_smart4j.sys_object_group
		WHERE GroupCode = #{grCode}
	</select>
	
	<select id="selectMultiFolderName" parameterType="cmap" resultType="String">
		SELECT GROUP_CONCAT(covi_smart4j.Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) SEPARATOR ', ')  AS MultiFolderName
		FROM covi_smart4j.sys_object_folder
		WHERE 1=1
		<if test='multiFolderIDArr != null and multiFolderIDArr.length != 0'>
			AND FolderID IN 
			<foreach collection="multiFolderIDArr" item="folderID" open="(" close=")" separator=",">
				#{folderID}
			</foreach>
		</if>
	</select>
	
	<select id="selectUserSecurityLevel" parameterType="cmap" resultType="java.lang.Long">
		SELECT SecurityLevel
		FROM covi_smart4j.sys_object_user
		WHERE UserCode = #{userCode}
	</select>
	
	<select id="selectFolderOwnerCode" parameterType="cmap" resultType="String">
		SELECT OwnerCode
		FROM covi_smart4j.SYS_OBJECT_FOLDER
		WHERE FolderID = #{folderID}
	</select>
	
	<select id="selectDocAuthCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM covi_smart4j.DOC_REQUEST_ACL
		WHERE 1=1
		AND RequestID = #{requestID}
		AND MessageID = #{messageID}
		AND Version = #{version}
		AND ActorCode = #{userCode}
	</select>
	
	<select id="selectApprovalCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM covi_smart4j.SYS_PROCESS_ACTIVITY
		WHERE 1=1 
		AND ProcessID = #{processID}
		AND State = 1
		AND ActorCode = #{userCode}
	</select>
	
	<select id="selectProcessActorList" parameterType="cmap" resultType="cmap">
		SELECT	  SP.ProcessID
				, SP.MessageID
				, SP.ObjectType
				, SP.Subject
				, SP.RegisterCode
				, SP.RegistDate
				, SPA.Step
				, SPA.ActivityType
				, SPA.ActorCode
				, SPA.ActorRole
		FROM covi_smart4j.sys_process AS SP
		INNER JOIN covi_smart4j.sys_process_activity AS SPA ON SP.ProcessID = SPA.ProcessID
		WHERE 1=1
		AND SP.MessageID = #{messageID}
		AND SPA.ActorRole != 'Register'
	</select>
	
	<select id="selectTypeList" parameterType="cmap" resultType="cmap">
		SELECT 
			<choose>
				<when test='searchGroupType.equalsIgnoreCase("category")'>FolderID</when>
				<when test='searchGroupType.equalsIgnoreCase("date")'>SUBSTR(RegistDate, 1, 10)</when>
			</choose> AS fieldID
			, COUNT(1) AS fieldCnt
			<if test="searchGroupType == 'category'">
				, MAX(FolderName) AS fieldName
			</if>
			<if test="searchGroupType == 'date'">
				, REPLACE(SUBSTR(RegistDate, 1, 10), '.', '-') AS fieldName
			</if>
		FROM (
			SELECT	  BM.MessageID
					, BM.Version
					, BM.Number
					, BM.FolderID
					, BM.IsInherited
					, BM.ParentID
					, BM.MsgType
					, BM.MsgState
					, BM.CategoryID
					, BM.Seq
					, BM.Step
					, BM.Depth
					, BM.Subject
					, BM.IsPopup
					, BM.IsTop
					, BM.PopupStartDate
					, BM.PopupEndDate
					, BM.TopStartDate
					, BM.TopEndDate
					, BM.ExpiredDate
					, BM.ListTop
					, BM.UseSecurity
					, BM.UseAnonym
					, BM.IsApproval
					, BM.IsUserForm
					, BM.IsCheckOut
					, BM.UseScrap
					, BM.NoticeMedia
					, BM.UseRSS
					, BM.TrackBackURL
					, BM.TracbackCnt
					, BM.AnswerCnt
					, BM.ReadCnt
					, BM.ScrapCnt
					, BM.ReportCnt
					, BM.FileCnt
					, BM.FileExtension
					, DATE_FORMAT(BM.RegistDate, '%Y.%m.%d %H:%i:%s') AS RegistDate
					, DATE_FORMAT(BM.CreateDate, '%Y.%m.%d %H:%i:%s') AS CreateDate
					, BM.RevisionCode
					, BM.RevisionDate AS DocRevisionDate
					, BM.ReservationDate AS BoardReservationDate
					, BM.ProgressState
					, BM.CreatorCode
					, Fn_BaseGetDictionary_S(#{lang}, BM.CreatorName) AS CreatorName
					, BM.CreatorLevel
					, BM.CreatorPosition
					, BM.CreatorTitle
					, Fn_BaseGetDictionary_S(#{lang}, BM.CreatorDept) AS CreatorDept
					, BM.DeleteDate
					, BM.RegistDept
					, BM.OwnerCode
					, BM.FolderName
					, BM.MenuID
					, (SELECT COUNT(*) 
				 	 FROM sys_comment 
				 	WHERE DeleteDate IS NULL 
				 	<choose>
						<when test="bizSection != null and bizSection != '' and (bizSection == 'Board' or bizSection == 'Doc' or bizSection == 'Community')">
							AND TargetServiceType IN ('Board', 'Doc', 'Community')
						</when>
						<otherwise>
							AND TargetServiceType = #{bizSection}
						</otherwise>
					</choose>
				 	  AND TargetID = CONCAT(BM.MessageID,'_',BM.Version)) AS CommentCnt  
					, (SELECT COUNT(*) 
					 FROM sys_like 
					 WHERE 1=1
					 <choose>
						<when test="bizSection != null and bizSection != '' and (bizSection == 'Board' or bizSection == 'Doc' or bizSection == 'Community')">
							AND TargetServiceType IN ('Board', 'Doc', 'Community')
						</when>
						<otherwise>
							AND TargetServiceType = #{bizSection}
						</otherwise>
					</choose> 
					   AND TargetID = CONCAT(BM.MessageID,'_',BM.Version)) AS RecommendCnt
					, (SELECT OwnerCode FROM sys_object_folder WHERE FolderID = BM.FolderID) AS FolderOwnerCode
				<if test="bizSection == 'Board'">
					, (SELECT MailAddress FROM sys_object_user WHERE UserCode = BM.CreatorCode) AS MailAddress
				</if>
				<if test="bizSection == 'Doc'">
					, (SELECT MailAddress FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS MailAddress
				</if>
				<choose>
					<when test="boardType == 'RequestModify'">
						, BM.RequestID		<!-- 수정요청 ID -->
						, BM.RequestMessage	<!-- 수정요청 사유 -->
						, BM.RequestorCode	<!-- 수정요청자 -->
						, BM.RequestorName	<!-- 이름 -->
						, BM.RequestorMailAddress
						, BM.RequestDate		<!-- 수정요청 일자 -->
						, BM.AnswererCode	<!-- 답변/처리자 ID -->
						, BM.AnswererMailAddress
						, BM.AnswererName	<!-- 답변/처리자 이름 -->
						, BM.AnswerContent	<!-- 답변 처리 코멘트 -->
						, BM.AnswerDate		<!-- 답변 일자 -->
						, BM.RequestStatus	<!-- 처리 상태 -->
					</when>
					<when test="boardType == 'Approval'">
						, BM.ProcessID AS ProcessID
						, BM.ProcessDefID AS ProcessDefID 
						, BM.ProcessState 
						, BM.ProcessRegistDate
						, BM.ProcessRegisterCode
						, BM.State
						, BM.ActivityState
						, BM.TotalApproverCnt
						, BM.TotalApprovalCnt 
					</when>
					<when test="boardType == 'DocAuth'">
						, BM.RequestID
						, BM.RequestorCode
						, BM.RequestorName
						, BM.RequestMessage
						, BM.RequestDate
						, BM.RequestAclList
						, BM.ActType
					</when>
					<when test="boardType == 'DocTotal'">
						, BM.MultiFolderType
					</when>
				</choose>
				, (SELECT Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.OwnerCode) AS OwnerName
				, (SELECT Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName) FROM sys_object_group WHERE GroupCode = BM.RegistDept) AS RegistDeptName
				, (SELECT Fn_BaseGetDictionary_S( #{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = BM.RevisionCode) AS RevisionName
				, BM.RevisionDate AS RevisionDate
				, DATE_FORMAT(BM.ReservationDate, '%Y.%m.%d %H:%i:%s') AS ReservationDate
				, IF((SELECT COUNT(*) FROM board_message_reader WHERE MessageID = BM.MessageID AND ReaderCode = #{userCode}) > 0, 'Y', 'N' ) AS IsRead
				, IF((SELECT COUNT(*) FROM sys_object_user WHERE UserCode = #{userCode} AND BM.SecurityLevel IS NOT NULL AND BM.SecurityLevel != 256 AND BM.SecurityLevel >= SecurityLevel) > 0, 'Y', 'N') AS IsSecurity
				, (SELECT MAX(FileID) FROM sys_file WHERE ObjectType ='FD' AND ObjectID = BM.FolderID AND MessageID = BM.MessageID AND SaveType='IMAGE') AS FileID
			FROM(
				SELECT DISTINCT
					  A.MessageID
					, A.Version
					, A.Number
					, A.FolderID 
					, A.IsInherited
					, A.ParentID
					, A.MsgType
					, A.MsgState
					, A.CategoryID
					, A.Seq
					, A.Step
					, A.Depth
					, A.Subject
					, A.IsPopup
					, A.IsTop
					, A.PopupStartDate
					, A.PopupEndDate
					, A.TopStartDate
					, A.TopEndDate
					, A.ExpiredDate
					, A.UseSecurity
					, A.UseAnonym 
					, A.IsApproval
					, A.IsUserForm
					, A.IsCheckOut
					, A.UseScrap
					, A.NoticeMedia
					, A.UseRSS
					, A.TrackBackURL
					, A.TracbackCnt
					, A.AnswerCnt
					, A.ReadCnt
					, A.ScrapCnt
					, A.ReportCnt
					, A.FileCnt
					, A.FileExtension
					, A.RegistDate
					, A.RevisionCode 
					, IF(A.RevisionDate IS NULL, DATE_FORMAT(A.RegistDate, '%Y.%m.%d %H:%i:%s'), DATE_FORMAT(A.RevisionDate, '%Y.%m.%d %H:%i:%s')) AS RevisionDate
					, A.ReservationDate
					, A.ProgressState
					, A.CreatorCode
					, A.CreateDate
					, IF(A.UsePubDeptName = 'Y', A.CreatorDept, A.CreatorName) AS CreatorName
					, A.CreatorLevel
					, A.CreatorPosition
					, A.CreatorTitle
					, A.CreatorDept
					, A.DeleteDate
					, A.RegistDept
					, A.OwnerCode
					, A.SecurityLevel
					, Fn_BaseGetDictionary_S(#{lang}, H.MultiDisplayName) AS FolderName
					, H.MenuID
					, (CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
					<choose>
						<when test="boardType == 'RequestModify'">
							, M.RequestID						<!-- 수정요청 ID -->
							, M.RequestMessage					<!-- 수정요청 사유 -->
							, M.RequestorCode					<!-- 수정요청자 -->
							, Fn_BaseGetDictionary_S(#{lang}, M.RequestorName) AS RequestorName	<!-- 이름 -->
							, (SELECT MailAddress FROM sys_object_user WHERE UserCode = M.RequestorCode) AS RequestorMailAddress
							, DATE_FORMAT(M.RequestDate,'%Y.%m.%d %H:%i:%s') AS RequestDate		<!-- 수정요청 일자 -->
							, M.AnswererCode						<!-- 답변/처리자 ID -->
							, (SELECT MailAddress FROM sys_object_user WHERE UserCode = M.AnswererCode) AS AnswererMailAddress
							, Fn_BaseGetDictionary_S(#{lang}, M.AnswererName) AS AnswererName	<!-- 답변/처리자 이름 -->
							, M.AnswerContent					<!-- 답변 처리 코멘트 -->
							, DATE_FORMAT(M.AnswerDate, '%Y.%m.%d %H:%i:%s')	AS AnswerDate		<!-- 답변 일자 -->
							, M.RequestStatus					<!-- 처리 상태 -->
						</when>
						<when test="boardType == 'Approval'">
							, F.ProcessID AS ProcessID
							, F.ProcessDefID AS ProcessDefID 
							, F.State AS ProcessState 
							, F.RegistDate AS ProcessRegistDate
							, F.RegisterCode AS ProcessRegisterCode
							, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID AND State = 1 AND ActorCode = #{userCode}) AS State
							, (SELECT State FROM sys_process_activity WHERE ActorCode = #{userCode} and ProcessID = F.ProcessID and ActorRole = 'Register') AS ActivityState
							, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID) AS TotalApproverCnt
							, (SELECT COUNT(*) FROM sys_process_activity WHERE ProcessID=F.ProcessID AND State IN (7,9)) AS TotalApprovalCnt 
						</when>
						<when test="boardType == 'DocAuth'">
							, DRA.RequestID
							, DRA.RegisterCode AS RequestorCode
							, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM sys_object_user WHERE UserCode = DRA.RegisterCode) AS RequestorName
							, DRA.RequestMessage
							, DATE_FORMAT(DRA.RequestDate, '%Y.%m.%d %H:%i:%s') AS RequestDate
							, DRA.AclList AS RequestAclList
							, DRA.ActType
						</when>
						<when test="boardType == 'DocTotal'">
							, 'ORIGIN' AS MultiFolderType
						</when>
					</choose>
				FROM board_message AS A
				INNER JOIN sys_object_folder AS H ON A.FolderID = H.FolderID AND H.IsUse = 'Y' AND H.DeleteDate IS NULL
				LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = A.MessageID AND BMA.Version = A.Version
				<choose>
					<when test="boardType == 'MyInterest'"> <!-- 전 즐겨찾기 -->
						INNER JOIN board_message_favorite AS J ON A.MessageID=J.MessageID AND J.RegisterCode=#{userCode}
					</when>
					<!-- 전 관심게시 -->
					<when test="boardType == 'RequestModify'">
						INNER JOIN board_request_modify AS M ON (A.MessageID=M.MessageID AND M.RequestStatus != 'Deleted')
					</when>
					<when test="boardType == 'Approval'">
						<if test="boxType == 'Request'">	<!-- boxType: Request, Receive......Caller, Callee로 할까 -->
							INNER JOIN sys_process AS F ON A.MessageID=F.MessageID AND F.ObjectType=#{bizSection}
						</if>
						<if test="boxType == 'Receive'">
							INNER JOIN sys_process AS F ON A.MessageID=F.MessageID AND F.ObjectType=#{bizSection} 
							AND F.ProcessID IN (SELECT DISTINCT ProcessID FROM sys_process_activity WHERE ActorCode = #{userCode} AND ActorRole != 'Register')
						</if>
					</when>
					<when test="boardType == 'DocAuth'">
						<if test="boxType == 'Request'">
							INNER JOIN doc_request_acl AS DRA ON A.MessageID=DRA.MessageID AND A.Version=DRA.Version AND DRA.RegisterCode = #{userCode}
						</if>
						<if test="boxType == 'Receive'">
							INNER JOIN doc_request_acl AS DRA ON A.MessageID=DRA.MessageID AND A.Version=DRA.Version AND DRA.ActorCode = #{userCode}
						</if>
					</when>
					<when test="boardType == 'CheckIn' or boardType == 'CheckOut'">
						LEFT OUTER JOIN (SELECT MAX(HistoryID) AS HistoryID, MessageID, MAX(Version) AS Version, CO_Code, ActType FROM doc_inout_history WHERE DeleteDate IS NULL GROUP BY MessageID, CO_Code, ActType) AS DIH 
						ON (A.MessageID = DIH.MessageID AND A.Version = DIH.Version)
					</when>
					<when test="boardType == 'DocTotal' and searchFolderIDs != null and searchFolderIDs != ''">
						INNER JOIN (
							SELECT MessageID, Version
							, CONCAT(';', GROUP_CONCAT(FolderID SEPARATOR ';'), ';') AS FolderIDs
							FROM (
								SELECT MessageID, Version, FolderID
								FROM board_message_folder
								WHERE 1=1
								<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
									AND FolderID IN 
									<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
										#{searchFolderID}
									</foreach>
								</if>
								
								UNION
								
								SELECT MessageID, Version, FolderID
								FROM board_message
								WHERE 1=1
								<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
									AND FolderID IN 
									<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
										#{searchFolderID}
									</foreach>
								</if>
							) A
							GROUP BY MessageID, Version
							HAVING 1=1
							<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
								<foreach collection="searchFolderIDArr" item="searchFolderID" index="index">
									AND FolderIDs LIKE CONCAT('%;', #{searchFolderID}, ';%')
								</foreach>
							</if>
						) B ON A.MessageID = B.MessageID AND A.Version = B.Version
					</when>
				</choose>
				<if test="multiCategory != null and multiCategory != ''">
					INNER JOIN (
						SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
						FROM covi_smart4j.board_userform_value
						GROUP BY MessageID, Version
						HAVING 1=1
						<foreach collection="multiCategoryList" item="multiCategory" index="index">
							AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
						</foreach>
					) AS UFV ON UFV.MessageID = A.MessageID AND UFV.Version = A.Version
				</if>
				WHERE 1=1
				AND IsCurrent = 'Y'
				<if test="bizSection == 'Board'">
				AND (H.MenuID = #{menuID} OR H.DomainID = 0)
				</if>
				<if test='aclDataArr != null and aclDataArr.length != 0'>
					AND H.FolderID IN 
					<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
						#{item}
					</foreach>
				</if>
				<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
					AND H.FolderID IN 
					<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
						#{searchFolderID}
					</foreach>
				</if>
				AND H.FolderType != 'QuickComment' <!-- 한줄게시 표시하지 않음 -->
				<if test="bizSection == 'Board'">
					AND MsgType NOT IN ('N', 'B')
				</if>
				<if test="bizSection == 'Doc'">
					AND MsgType IN ('N', 'B', 'M')
				</if>
				<if test="isMobileSupport == 'Y'">
					AND H.isMobileSupport = 'Y'
				</if>
				<choose>
					<when test="communityID != null and communityID !=''">
						AND H.ObjectType = 'Community'
					</when>
					<otherwise>
						AND H.ObjectType = #{bizSection}
					</otherwise>
				</choose>
				<include refid="chooseBoardType"/>	<!-- 해당문서 최상단에 boardType 체크 부분 분리 -->
				<if test="requestStatus != null and requestStatus != ''">
					<choose>
						<when test="requestStatus == 'Ready'">
							AND MsgState IN ('Ready')
						</when>
						<when test="requestStatus == 'Process'">
							AND MsgState IN ('Process')
						</when>
						<otherwise>
							AND MsgState IN ('Complete')
						</otherwise>
					</choose>
				</if>
				<if test="readSearchType != null and readSearchType != ''">
					<!-- CHECK: 읽음/읽음 조회 설정 -->
					AND A.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
				</if>
				<!-- 검색어 항목 -->
				<if test="searchText != null and searchText != ''">
					<choose>
						<when test="searchType == 'Total'">
							AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%') )
						</when>
						<when test="searchType == 'Mobile'">
							AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%')  || CreatorName LIKE CONCAT('%',#{searchText},'%') )
						</when>
						<otherwise>
							AND 
							<choose>
								<when test='searchType.equalsIgnoreCase("BodyText")'>A.BodyText </when>
								<when test='searchType.equalsIgnoreCase("CreatorName")'>A.CreatorName </when>
								<when test='searchType.equalsIgnoreCase("Number")'>A.Number </when>
								<otherwise>A.Subject </otherwise>
							</choose>
							LIKE CONCAT('%',#{searchText},'%')   
						</otherwise>
					</choose>
				</if>
				<if test="startDate != '' or endDate != ''">
					AND A.RegistDate between #{startDate} and #{endDate}
				</if>
				<choose>
					<when test="boardType == 'Approval'">
						<!-- 요청함 -->
						<if test="boxType == 'Request'">	<!-- boxType: Request, Receive......Caller, Callee로 할까 -->
							AND F.RegisterCode = #{userCode}
						</if>
						<!-- 승인함의 경우 approvalStatus selectbox를 통해 승인요청을 받을 게시글을 필터링할 수 있다. -->
						<choose>
							<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
								AND (MsgState IN ('R', 'BR')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State &gt; 0 -->
							</when>
							<when test='approvalStatus == "A"'> <!-- 승인 완료된 게시 -->
								AND (MsgState IN ('A', 'BA')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State = 0 -->
							</when>
							<when test='approvalStatus == "D"'> <!-- 반려된 게시 -->
								AND (MsgState IN ('D')) AND (MsgType IN ('O', 'N', 'B')) <!-- AND State = 0 -->
							</when>
							<when test='approvalStatus == "P"'> <!-- 다른사람이 결제해야할 승인 요청 게시 -->
								AND (MsgState IN ('R')) AND (MsgType IN ('O', 'N', 'B'))  <!-- AND State = 0 -->
							</when>
							<otherwise>
								AND (MsgState IN ('R', 'D', 'A', 'BR', 'BA')) AND (MsgType IN ('O', 'N', 'B'))
							</otherwise>
						</choose>
					</when>
					<when test="boardType == 'DocAuth'">
						<!-- 요청함 -->
						<if test="boxType == 'Receive'">	<!-- boxType: Request, Receive......Caller, Callee로 할까 -->
							<choose>
								<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
									AND (ActType IN ('R'))
								</when>
								<when test='approvalStatus == "A"'> <!-- 승인 완료된 게시 -->
									AND (ActType IN ('D', 'A'))
								</when>
								<when test='approvalStatus == "D"'> <!-- 반려된 게시 -->
									AND (ActType IN ('D'))
								</when>
							</choose>
						</if>
					</when>
				</choose>
				
				<if test="bizSection == 'Doc' and boardType == 'DocTotal'">
					UNION ALL
					
					SELECT DISTINCT
						  A.MessageID
						, A.Version
						, A.Number
						, H.FolderID 
						, A.IsInherited
						, A.ParentID
						, A.MsgType
						, A.MsgState
						, A.CategoryID
						, A.Seq
						, A.Step
						, A.Depth
						, A.Subject
						, A.IsPopup
						, A.IsTop
						, A.PopupStartDate
						, A.PopupEndDate
						, A.TopStartDate
						, A.TopEndDate
						, A.ExpiredDate
						, A.UseSecurity
						, A.UseAnonym 
						, A.IsApproval
						, A.IsUserForm
						, A.IsCheckOut
						, A.UseScrap
						, A.NoticeMedia
						, A.UseRSS
						, A.TrackBackURL
						, A.TracbackCnt
						, A.AnswerCnt
						, A.ReadCnt
						, A.ScrapCnt
						, A.ReportCnt
						, A.FileCnt
						, A.FileExtension
						, A.RegistDate
						, A.RevisionCode 
						, IF(A.RevisionDate IS NULL, DATE_FORMAT(A.RegistDate, '%Y.%m.%d %H:%i:%s'), DATE_FORMAT(A.RevisionDate, '%Y.%m.%d %H:%i:%s')) AS RevisionDate
						, A.ReservationDate
						, A.ProgressState
						, A.CreatorCode
						, A.CreateDate
						, IF(A.UsePubDeptName = 'Y', A.CreatorDept, A.CreatorName) AS CreatorName
						, A.CreatorLevel
						, A.CreatorPosition
						, A.CreatorTitle
						, A.CreatorDept
						, A.DeleteDate
						, A.RegistDept
						, A.OwnerCode
						, A.SecurityLevel
						, Fn_BaseGetDictionary_S(#{lang}, H.MultiDisplayName) AS FolderName
						, H.MenuID
						, (CASE IsTop WHEN 'N' THEN 'Z' ELSE (CASE WHEN #{localCurrentDate} BETWEEN TopStartDate AND TopEndDate THEN 'A' ELSE 'Z' END) END) AS ListTop
						, 'SUB' AS MultiFolderType
					FROM board_message AS A
					LEFT OUTER JOIN board_message_folder AS BMF ON A.MessageID = BMF.MessageID AND A.Version = BMF.Version
					<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
						AND BMF.FolderID IN 
						<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
							#{searchFolderID}
						</foreach>
					</if>
					INNER JOIN sys_object_folder AS H ON H.FolderID = BMF.FolderID AND H.IsUse = 'Y' AND H.DeleteDate IS NULL
					LEFT OUTER JOIN board_message_acl AS BMA ON BMA.MessageID = A.MessageID AND BMA.Version = A.Version
					INNER JOIN (
						SELECT MessageID, Version
						, CONCAT(';', GROUP_CONCAT(FolderID SEPARATOR ';'), ';') AS FolderIDs
						FROM (
							SELECT MessageID, Version, FolderID
							FROM board_message_folder
							WHERE 1=1
							<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
								AND FolderID IN 
								<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
									#{searchFolderID}
								</foreach>
							</if>
							
							UNION
							
							SELECT MessageID, Version, FolderID
							FROM board_message
							WHERE 1=1
							<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
								AND FolderID IN 
								<foreach collection="searchFolderIDArr" item="searchFolderID" open="(" close=")" separator=",">
									#{searchFolderID}
								</foreach>
							</if>
						) A
						GROUP BY MessageID, Version
						HAVING 1=1
						<if test='searchFolderIDArr != null and searchFolderIDArr.size != 0'>
							<foreach collection="searchFolderIDArr" item="searchFolderID" index="index">
								AND FolderIDs LIKE CONCAT('%;', #{searchFolderID}, ';%')
							</foreach>
						</if>
					) B ON A.MessageID = B.MessageID AND A.Version = B.Version
					<if test="multiCategory != null and multiCategory != ''">
						INNER JOIN (
							SELECT MessageID, Version, CONCAT(';', GROUP_CONCAT(CONCAT(UserFormID, '-', FieldValue) SEPARATOR ';'), ';') AS UserFormField
							FROM covi_smart4j.board_userform_value
							GROUP BY MessageID, Version
							HAVING 1=1
							<foreach collection="multiCategoryList" item="multiCategory" index="index">
								AND UserFormField LIKE CONCAT('%;', #{multiCategory}, ';%')
							</foreach>
						) AS UFV ON UFV.MessageID = A.MessageID AND UFV.Version = A.Version
					</if>
					WHERE 1=1
					AND IsCurrent = 'Y'
					AND (H.MenuID = #{menuID} OR H.DomainID = 0)
					<if test='aclDataArr != null and aclDataArr.length != 0'>
						AND H.FolderID IN 
						<foreach collection="aclDataArr" item="item" open="(" close=")" separator=",">
							#{item}
						</foreach>
					</if>
					<if test="isMobileSupport == 'Y'">
					    AND H.isMobileSupport = 'Y'
					</if>
					AND H.FolderType != 'QuickComment' <!-- 한줄게시 표시하지 않음 -->
					AND MsgType IN ('N', 'B', 'M')
					AND H.ObjectType = #{bizSection}
					<include refid="chooseBoardType"/>	<!-- 해당문서 최상단에 boardType 체크 부분 분리 -->
					<if test="readSearchType != null and readSearchType != ''">
						<!-- CHECK: 읽음/읽음 조회 설정 -->
						AND A.MessageID NOT IN (SELECT MessageID FROM board_message_reader WHERE ReaderCode = #{userCode})
					</if>
					<!-- 검색어 항목 -->
					<if test="searchText != null and searchText != ''">
						<choose>
							<when test="searchType == 'Total'">
								AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%') )
							</when>
							<when test="searchType == 'Mobile'">
								AND ( A.Subject LIKE CONCAT('%',#{searchText},'%')  || BodyText LIKE CONCAT('%',#{searchText},'%')  || CreatorName LIKE CONCAT('%',#{searchText},'%') )
							</when>
							<otherwise>
								AND 
								<choose>
									<when test='searchType.equalsIgnoreCase("BodyText")'>A.BodyText </when>
									<when test='searchType.equalsIgnoreCase("CreatorName")'>A.CreatorName </when>
									<when test='searchType.equalsIgnoreCase("Number")'>A.Number </when>
									<otherwise>A.Subject </otherwise>
								</choose>
								LIKE CONCAT('%',#{searchText},'%')
							</otherwise>
						</choose>
					</if>
					<if test="startDate != '' or endDate != ''">
						AND A.RegistDate BETWEEN #{startDate} and #{endDate}
					</if>
				</if>
			) AS BM
			LEFT OUTER JOIN sys_object_user AS B ON (CASE WHEN BM.MsgType='S' THEN BM.OwnerCode ELSE BM.CreatorCode END) = B.UserCode
			WHERE 1=1
			<!-- 카테고리별 검색 기능 사용시 참조 -->
			<if test="categoryID != null and categoryID != ''">
				<choose>
					<when test="categoryGubun == 'Y'">
						AND (C.MemberOf = #{categoryID} OR C.CategoryID = #{categoryID})
					</when>
					<otherwise>
						AND BM.CategoryID = #{categoryID}
					</otherwise>
				</choose>
			</if>
			<if test="boardType == 'Approval' and boxType == 'Receive' and approvalStatus != '' and approvalStatus != null ">
				<choose>
					<when test='approvalStatus == "R"'>	<!-- 승인 요청 받은 게시 -->
						AND State &gt; 0
					</when>
					<otherwise> <!-- 승인 완료된 게시(A), 반려된 게시(D), 다른사람이 결제해야할 승인 요청 게시(진행중)(P)- -->
						AND State = 0
					</otherwise>
				</choose>
			</if>
		) RESULT
		WHERE 1=1
		<!-- Group By 절 -->
		<trim prefix="GROUP BY">
			<if test="searchGroupType != null and searchGroupType != ''">
				<choose>
					<when test='searchGroupType.equalsIgnoreCase("category")'>FolderID</when>
					<when test='searchGroupType.equalsIgnoreCase("date")'>SUBSTR(RegistDate, 1, 10)</when>
				</choose>
			</if>
		</trim>
		<!-- Order by 절 -->
		<trim prefix="ORDER BY">
			<if test="searchGroupType != null">
				fieldName ASC
			</if>
		</trim>
	</select>
	
	<!-- 사용자 정의 필드 값 변경 -->
    <update id="updateMessageUserDefFieldValue" parameterType="cmap">
        UPDATE covi_smart4j.board_userform_value
        SET
        	FieldValue = #{fieldValue}
        WHERE MessageID = #{messageID}
        AND FolderID = #{folderID}
        AND Version = #{version}
        AND UserFormID = #{userFormID}
    </update>
</mapper>
