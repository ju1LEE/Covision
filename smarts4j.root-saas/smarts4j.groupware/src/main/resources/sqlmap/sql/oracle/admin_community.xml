<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin.community">
	<select id="selectCommunityDomain" parameterType="cmap" resultType="cmap">
		SELECT dn.DomainID AS "DomainID"
			 , dn.DomainCode AS "DomainCode"
			 , Fn_BaseGetDictionary_S(#{lang}, NVL(dn.MultiDisplayName,dn.DisplayName)) AS "DisplayName"
		FROM SYS_OBJECT_GROUP gr
		INNER JOIN SYS_OBJECT_DOMAIN dn on gr.CompanyCode = dn.DomainCode
		WHERE gr.GroupType = 'Company'
		AND gr.IsUse = 'Y'
		AND dn.IsUse = 'Y'
		<if test="assignedDomain.size() > 0">
			AND DomainID IN 
			<foreach item="item" index="index" collection="assignedDomain" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if> 
		ORDER BY
		<if test="domainID != null and domainID != ''">
			CASE WHEN dn.DomainID = #{domainID} THEN 0 ELSE 1 END,
		</if>
		gr.SortKey ASC
	</select>
	
	<select id="selectCommunityTreeData" parameterType="cmap" resultType="cmap">
		SELECT	  cc.CategoryID AS "FolderID"
				, cc.DN_ID AS "DN_ID"
				, cc.FolderType AS "itemType"
				, cc.FolderType AS "FolderType"
				, cc.FolderType AS "type"
				, cc.FolderAlias AS "FolderAlias"
				, NVL(FN_GETSELDICTIONARY(#{lang},CONCAT('CUCT_',cc.CategoryID), cc.DN_ID),cc.DisplayName)AS "DisplayName"
				, NVL(FN_GETSELDICTIONARY(#{lang},CONCAT('CUCT_',cc.CategoryID), cc.DN_ID),cc.DisplayName)AS "FolderName"
				, cc.MemberOf AS "MemberOf"
				, cc.FolderPath AS "FolderPath"
				, cc.SortKey AS "SortKey"
				, cc.SortPath AS "SortPath"
				, cc.IsUse AS "IsUse"
				, cc.Description AS "Description"
				, cc.RegisterCode AS "RegisterCode"
				, cc.RegistDate AS "RegistDate"
				, cc.ModifierCode AS "ModifierCode"
				, cc.ModifyDate AS "ModifyDate"
				, cc.DeleteDate AS "DeleteDate"
				, cc.Reserved1 AS "Reserved1"
				, cc.Reserved2 AS "Reserved2"
				, (SELECT COUNT(*) FROM COMMUNITY_CATEGORY cca WHERE cca.MemberOf = cc.CategoryID AND cca.IsUse = 'Y' AND cca.DeleteDate IS NULL) AS "hasChild"
		FROM COMMUNITY_CATEGORY cc
		WHERE 1=1 
		AND cc.DeleteDate IS NULL 
		AND cc.DN_ID = #{DN_ID}
		<if test="isAll == null || isAll == ''">
		AND cc.IsUse = 'Y'
		</if>
		ORDER BY cc.FolderType DESC, cc.SortKey ASC
	</select>
	
	<select id="selectCommunityGridListCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM COMMUNITY_CATEGORY A
		WHERE 1=1
		AND A.DeleteDate IS NULL 
		<choose>
			<when test="MemberOf == null or MemberOf == '' and CategoryID == null or CategoryID == ''">
				AND DN_ID = #{DN_ID}
				AND FolderType = 'Root' 
			</when>
			<otherwise>
				AND A.MemberOf = #{CategoryID}
			</otherwise>
		</choose>
	</select>
	
	<select id="selectCommunityGridList" parameterType="cmap" resultType="cmap">
		<include refid="oracle.include.pagingHeader" />
		SELECT	  RESULT.CategoryID AS "CategoryID"
				, RESULT.DN_ID AS "DN_ID"
				, RESULT.MN_ID AS "MN_ID"
				, RESULT.FolderType AS "FolderType"
				, RESULT.FolderAlias AS "FolderAlias"
				, RESULT.DisplayName AS "DisplayName"
				, RESULT.MemberOf AS "MemberOf"
				, RESULT.FolderPath AS "FolderPath"
				, RESULT.SortKey AS "SortKey"
				, RESULT.SortPath AS "SortPath"
				, RESULT.IsUse AS "IsUse"
				, RESULT.Description AS "Description"
				, RESULT.RegisterCode AS "RegisterCode"
				, RESULT.RegDisplayName AS "RegDisplayName"
				, RESULT.RegistDate AS "RegistDate"
		FROM (
			SELECT	  A.CategoryID AS CategoryID
					, A.DN_ID AS DN_ID
					, A.MN_ID AS MN_ID
					, A.FolderType AS FolderType
					, A.FolderAlias AS FolderAlias
					, A.DisplayName AS DisplayName
					, A.MemberOf AS MemberOf
					, A.FolderPath AS FolderPath
					, A.SortKey AS SortKey
					, A.SortPath AS SortPath
					, A.IsUse AS IsUse
					, A.Description AS Description
					, A.RegisterCode AS RegisterCode
					, (SELECT DisplayName FROM SYS_OBJECT_USER WHERE UserCode = A.RegisterCode) AS RegDisplayName
					, TO_CHAR(A.RegistDate, 'YYYY-MM-DD HH24:MI:SS') AS RegistDate
			FROM COMMUNITY_CATEGORY A
			WHERE 1=1
			AND A.DeleteDate IS NULL 
			<choose>
				<when test="MemberOf == null or MemberOf == '' and CategoryID == null or CategoryID == ''" >
					AND DN_ID = #{DN_ID}
					AND FolderType = 'Root' 
				</when>
				<otherwise>
					AND A.MemberOf = #{CategoryID}
				</otherwise>
			</choose>
		) RESULT
		<trim prefix="ORDER BY"  prefixOverrides =","> 
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' "> 
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("Description")'>Description</when>
					<when test='sortColumn.equalsIgnoreCase("FolderAlias")'>FolderAlias</when>
					<when test='sortColumn.equalsIgnoreCase("IsUse")'>IsUse</when>
					<when test='sortColumn.equalsIgnoreCase("RegDisplayName")'>RegDisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("RegistDate")'>RegistDate</when>
					<otherwise>SortKey</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
				<include refid="oracle.include.listOrderBy"/>
			</if>
		</trim>	
		<include refid="oracle.include.pagingFooter" />
	</select>
	
	<select id="selectCommunitySubGridList"  parameterType="cmap" resultType="cmap">
		/* queryId : admin.community.selectCommunitySubGridList */		
		<include refid="oracle.include.pagingHeader" />
		SELECT	  CU_ID AS "CU_ID"
				, MN_ID AS "MN_ID"
				, CategoryID AS "CategoryID"
				, CU_Code AS "CU_Code"
				, DN_ID AS "DN_ID"
				, SearchTitle AS "SearchTitle"
				, CommunityName AS "CommunityName"
				, CreatorCode AS "CreatorCode"
				, AppStatus AS "AppStatus"
				, RegRequestDate AS "RegRequestDate"
				, FolderPath AS "FolderPath"
				, SortPath AS "SortPath"
				, CategoryName AS "CategoryName"
				, MembersCount AS "MembersCount"
				, RegProcessDate AS "RegProcessDate"
				, Point AS "Point"
				, MemberCount AS "MemberCount"
				, Grade AS "Grade"
				, MsgCount AS "MsgCount" 
				, DisplayName AS "DisplayName" 
				, CuAppDetail AS "CuAppDetail"
				, CommunityJoin AS "CommunityJoin"
				, CommunityType AS "CommunityType"
				, OperatorName AS "OperatorName"
				, OperatorCode AS "OperatorCode"
				
		FROM (
			SELECT	  c.CU_ID
					, c.MN_ID
					, c.CategoryID
					, c.CU_Code
					, c.DN_ID
					, c.SearchTitle
					, c.CommunityName
					, c.CreatorCode
					, c.AppStatus
					, TO_CHAR(c.RegRequestDate, 'YYYY-MM-DD HH24:MI:SS') AS RegRequestDate
					, cc.FolderPath
					, cc.SortPath
					, cc.DisplayName AS CategoryName
					, (SELECT COUNT(*) FROM COMMUNITY_MEMBER WHERE  MemberLevel != '0' AND MemberStatus = 'R' AND DetailStatus = 'RV' AND CU_ID = c.CU_ID ) AS MembersCount
					, TO_CHAR(c.RegProcessDate, 'YYYY-MM-DD HH24:MI:SS') AS RegProcessDate
					, c.Point
					, c.MemberCount
					, c.Grade
					, c.MsgCount
					, sou.DisplayName
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS CuAppDetail
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityJoin', c.JoinOption)) AS CommunityJoin
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityType', c.CommunityType)) AS CommunityType
					, c.OperatorName
					, c.OperatorCode
			FROM COMMUNITY c
			INNER JOIN SYS_OBJECT_GROUP sog ON sog.GroupCode = c.CU_Code
			LEFT JOIN SYS_OBJECT_USER sou ON  sou.UserCode = c.CreatorCode
			INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID
			WHERE 1=1 
			AND c.DN_ID = #{DN_ID}
			AND c.Gubun = 'C'
			<choose>
				<when test="MemberOf != null and MemberOf != '' and CategoryID != null and CategoryID != '' and pType != 'Root' and pType != null and pType != ''">
					<if test="CategoryID != null and CategoryID != ''">
						AND cc.CategoryID = #{CategoryID}
					</if>
				</when> 
				<when test="CategoryID != null and CategoryID != '' and pType == 'Root'">
					AND (cc.MemberOf = #{CategoryID} OR cc.CategoryID = #{CategoryID})
				</when>
			</choose>
			<if test="searchValue != null and searchValue != ''">
				<choose>
					<when test ="searchOption =='0'.toString() ">
						AND (c.CommunityName LIKE '%'||#{searchValue}||'%'
						 OR NVL(sou.DisplayName, '') LIKE '%'||#{searchValue}||'%')
					</when>
					<when test ="searchOption =='1'.toString() ">
						AND c.CommunityName LIKE '%'||#{searchValue}||'%'	
					</when>
					<when test ="searchOption =='2'.toString() ">
						AND NVL(sou.DisplayName, '') LIKE '%'||#{searchValue}||'%'
					</when>
					<when test ="searchOption == '3'.toString()">
						AND c.OperatorName LIKE '%'||#{searchValue}||'%' 
					</when>
				</choose>
			</if>
			<if test = "communityJoin != null and communityJoin != '' ">
				AND c.JoinOption = #{communityJoin}
			</if>	
			<if test = "communityType != null and communityType != '' ">
				AND c.CommunityType = #{communityType}
			</if>	
			<if test = "communityDetail != null and communityDetail != '' ">
				AND c.AppStatus = #{communityDetail}
			</if>
		) RESULT
		<trim prefix="ORDER BY"  prefixOverrides =","> 
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' "> 
				<choose>
					<when test='sortColumn.equalsIgnoreCase("CategoryName")'>CategoryName</when>
					<when test='sortColumn.equalsIgnoreCase("CU_Code")'>CU_Code</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityName")'>CommunityName</when>
					<when test='sortColumn.equalsIgnoreCase("CuAppDetail")'>CuAppDetail</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityType")'>CommunityType</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityJoin")'>CommunityJoin</when>
					<when test='sortColumn.equalsIgnoreCase("Point")'>TO_NUMBER(Point)</when>
					<when test='sortColumn.equalsIgnoreCase("MembersCount")'>TO_NUMBER(MembersCount)</when>
					<when test='sortColumn.equalsIgnoreCase("Grade")'>TO_NUMBER(Grade)</when>
					<when test='sortColumn.equalsIgnoreCase("MsgCount")'>TO_NUMBER(MsgCount)</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("RegProcessDate")'>RegProcessDate</when>
					<otherwise>CU_ID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
				<include refid="oracle.include.listOrderBy"/>
			</if>
		</trim>	
	 <include refid="oracle.include.pagingFooter" />
	</select>
	
	<select id="selectCommunitySubGridListCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM COMMUNITY c 
		INNER JOIN SYS_OBJECT_GROUP sog ON sog.GroupCode = c.CU_Code
		LEFT JOIN SYS_OBJECT_USER sou ON  sou.UserCode = c.CreatorCode
		INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID
		WHERE 1=1 
		AND c.DN_ID = #{DN_ID}
		AND c.Gubun = 'C'
		<choose>
			<when test="MemberOf != null and MemberOf != '' and CategoryID != null and CategoryID != '' and pType != 'Root' and pType != null and pType != ''">
				<if test="CategoryID != null and CategoryID != ''">
					AND cc.CategoryID = #{CategoryID}
				</if>
			</when>
			<when test="CategoryID != null and CategoryID != '' and pType = 'Root'">
					<!-- AND cc.MemberOf = #{CategoryID} -->
					AND (cc.MemberOf = #{CategoryID} OR cc.CategoryID = #{CategoryID})
			</when>
		</choose>
		<if test="searchValue != null and searchValue != ''">
			<choose>
				<when test ="searchOption =='0'.toString() ">
					AND (c.CommunityName LIKE '%'||#{searchValue}||'%'
					OR sou.DisplayName LIKE '%'||#{searchValue}||'%')
				</when>
				<when test ="searchOption =='1'.toString() ">
					AND c.CommunityName LIKE '%'||#{searchValue}||'%'	
				</when>
				<when test ="searchOption =='2'.toString() ">
					AND sou.DisplayName LIKE '%'||#{searchValue}||'%'
				</when>
			</choose>
		</if>
		<if test = "communityJoin != null and communityJoin != ''">
			AND c.JoinOption = #{communityJoin}
		</if>
		<if test = "communityType != null and communityType != ''">
			AND c.CommunityType = #{communityType}
		</if>
		<if test = "communityDetail != null and communityDetail != ''">
			AND c.AppStatus = #{communityDetail}
		</if>
	</select>
	
	<update id="updateCategoryUseChange" parameterType="cmap">
		UPDATE COMMUNITY_CATEGORY SET 
			IsUse = #{IsUse}
		WHERE 1=1
		AND CategoryID = #{CategoryID}
	</update> 
	
	<select id="setCurrentLocation"  parameterType="cmap" resultType="cmap">
	 <![CDATA[
		 SELECT C.DisplayName AS "DisplayName"
			  , C.num AS "num"
		 FROM (
			SELECT	  DisplayName
					, ROWNUM -1 AS num
			FROM SYS_OBJECT_DOMAIN 
			WHERE DomainID = #{DN_ID}
			
			UNION ALL 
			
			SELECT	  B.DisplayName
					, ROWNUM AS num
			FROM (
				SELECT	  DisplayName
						, ROWNUM AS num
				FROM COMMUNITY_CATEGORY
				START WITH CategoryID = #{CategoryID}
				CONNECT BY PRIOR MemberOf = CategoryID 
				AND CategoryID <> 0
				ORDER BY num DESC 
			)B
		)C 
	]]> 
	</select> 
	
	<select id="selectCategoryID"  parameterType="cmap" resultType="String">
		SELECT CategoryID AS "CategoryID"
		FROM COMMUNITY_CATEGORY
		WHERE DN_ID = #{DN_ID}
		AND FolderType = 'Root'
		AND DeleteDate IS NULL
		AND ROWNUM = 1
		ORDER BY SortKey+0 ASC, CategoryID ASC
	</select> 
	
	<select id="selectCommunityBaseCode"  parameterType="cmap" resultType="cmap">
		SELECT	  Code AS "optionValue"
				, CodeName AS "optionText"
		FROM SYS_BASE_CODE sbc
		WHERE 1=1
		AND CodeGroup = #{CodeGroup}
		AND Code !=  #{CodeGroup}
		AND IsUse = 'Y'
		AND DomainID = (SELECT NVL(MAX(DomainID), 0) FROM SYS_BASE_CODE WHERE Code = sbc.Code AND CodeGroup = #{CodeGroup} AND DomainID = #{domainID})
		ORDER BY SortKey ASC 
	</select>
	
	<select id="selectProperty"  parameterType="cmap" resultType="cmap">
		SELECT  c.CategoryID AS "CategoryID"
			  , c.DN_ID AS "DN_ID"
			  , c.MN_ID AS "MN_ID"
			  , c.FolderType AS "FolderType"
			  , c.FolderAlias AS "FolderAlias"
			  , c.DisplayName AS "DisplayName"
			  , c.MemberOf AS "MemberOf"
			  , c.FolderPath AS "FolderPath"
			  , c.SortKey AS "SortKey"
			  , c.SortPath AS "SortPath"
			  , c.IsUse AS "IsUse"
			  , c.Description AS "Description"
			  , c.RegisterCode AS "RegisterCode"
			  , NVL((SELECT DisplayName FROM COMMUNITY_CATEGORY cc WHERE cc.CategoryID = c.MemberOf),'') AS "parentDisplayName"
			  , (SELECT DisplayName FROM SYS_OBJECT_USER WHERE UserCode = c.RegisterCode) AS "RegDisplayName"
			  , TO_CHAR(c.RegistDate, 'YYYY-MM-DD') AS "RegistDate"
			  , (NVL(bd.KoFull,'')||';'||NVL(bd.EnFull,'')||';'||NVL(bd.JaFull,'')||';'||NVL(bd.ZhFull,'')||';;;;;;;' ) AS "MultiDisplayName"
		FROM COMMUNITY_CATEGORY c
		LEFT JOIN SYS_BASE_DICTIONARY bd ON bd.DicCode = CONCAT('CUCT_',c.CategoryID) AND bd.DomainID = #{DN_ID}
		WHERE 1=1
		AND c.DeleteDate IS NULL
		<choose>
			<when test="CategoryID == null or CategoryID == ''" >
				 AND c.CategoryID = (
				 					SELECT * 
				 					FROM (	SELECT CategoryID 
											FROM COMMUNITY_CATEGORY 
											WHERE DN_ID = #{DN_ID}
									 		AND FolderType = 'Root' 
									 		AND DeleteDate IS NULL 
									 		AND CategoryID = #{CategoryID}
									 		AND ROWNUM = 1 
									 		ORDER BY SortKey+0 ASC, CategoryID ASC  
									)
								)
			</when>
			<otherwise>
				AND c.CategoryID = #{CategoryID}
			</otherwise>
		</choose>
	</select>
	
	<update id="updateCommunityProperty" parameterType="cmap" >
		UPDATE COMMUNITY_CATEGORY SET
									  DisplayName = #{DisplayName}
									, MemberOf = #{MemberOf}
									, FolderPath = NVL(#{MemberOf},CONCAT(#{MemberOf},';'))
									, SortKey = #{SortKey}
									, SortPath = #{SortPath}
									, IsUse =  #{IsUse}
									, Description = #{Description}
		WHERE CategoryID = #{CategoryID}
	</update>
	
	<select id="selectCommunitySortPath" parameterType="cmap" resultType="String">
		SELECT FN_COMSORTPATHCREATE_S(#{CategoryID}, '', 'CC') FROM dual
	</select>
	
	<update id="updateCommunitySubProperty" parameterType="cmap" >
		UPDATE COMMUNITY_CATEGORY 
		SET SortPath = #{SortPath}
		WHERE MemberOf = #{CategoryID}
	</update>
	
	<select id="communityDictionaryCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM SYS_BASE_DICTIONARY 
		WHERE 1=1 
		AND DicCode = CONCAT('CUCT_',#{CategoryID})
		AND DomainID = #{DN_ID} 
	</select>
	
	<insert id="createCommunityDictionary" parameterType="cmap" >
		INSERT INTO SYS_BASE_DICTIONARY
		(
			  DomainID
			, DicCode
			, KoShort
			, KoFull
			, EnShort
			, EnFull
			, JaShort
			, JaFull
			, ZhShort
			, ZhFull
			, IsUse
			, IsCaching
			, RegisterCode
			, RegistDate
		)VALUES(
			  #{DN_ID}
			, CONCAT('CUCT_', #{CategoryID})
			, #{DIC_Code_ko} 
			, #{DIC_Code_ko} 
			, #{DIC_Code_en}
			, #{DIC_Code_en}
			, #{DIC_Code_ja}
			, #{DIC_Code_ja}
			, #{DIC_Code_zh}
			, #{DIC_Code_zh}
			, 'Y'
			, 'Y'
			, #{userID}
			, SYSDATE
		)
	</insert>
	
	<update id="updateCommunityDictionary" parameterType="cmap" >
		UPDATE SYS_BASE_DICTIONARY SET 
									  KoShort = #{DIC_Code_ko} 
									, KoFull = #{DIC_Code_ko} 
									, EnShort = #{DIC_Code_en}
									, EnFull = #{DIC_Code_en}
									, JaShort = #{DIC_Code_ja}
									, JaFull = #{DIC_Code_ja}
									, ZhShort = #{DIC_Code_zh}
									, ZhFull = #{DIC_Code_zh} 
									, ModifierCode = #{userID}
									, ModifyDate = SYSDATE
		WHERE 1=1
		AND DicCode = CONCAT('CUCT_',#{CategoryID})
		AND DomainID = #{DN_ID} 
	</update>
	
	<select id="selectCommunitySubProperty"  parameterType="cmap" resultType="cmap">
		SELECT	  COUNT(*) AS "cnt"
				, LISTAGG(CategoryID, ',') WITHIN GROUP(ORDER BY CategoryID) AS "subCategoryID"
		FROM COMMUNITY_CATEGORY
		WHERE MemberOf = #{CategoryID}
	</select>
	
	<insert id="createCommunityProperty"  parameterType="cmap" useGeneratedKeys="true">
		INSERT INTO COMMUNITY_CATEGORY (
											  DN_ID
											, MN_ID
											, FolderType
											, FolderAlias
											, DisplayName
											, MemberOf
											, FolderPath
											, SortKey
											, SortPath
											, IsUse
											, Description
											, RegisterCode
											, RegistDate
										) VALUES (
											  #{DN_ID}
											, #{MN_ID}
											, #{FolderType}
											, #{FolderAlias}
											, #{DisplayName}
											, #{MemberOf}
											, CONCAT(#{MemberOf},';')
											, #{SortKey}
											, NVL(FN_COMSORTPATHCREATE_S(#{MemberOf}, '', 'CC')||substr('000000000000000', 0,15 - LENGTH(#{SortKey}))|| #{SortKey} ||';',substr('000000000000000',0, 15 - LENGTH(#{SortKey})) || #{SortKey} || ';')
											, #{IsUse}
											, #{Description}
											, #{userID}
											, SYSDATE
										)
		<selectKey resultType="java.lang.Long" keyProperty="CategoryID" order="AFTER">
			SELECT COMMUNITY_CATEGORY_SEQ.CURRVAL FROM dual
		</selectKey>
	</insert>
	
	<update id="deleteCategory" parameterType="cmap">
		UPDATE COMMUNITY_CATEGORY SET
									 DeleteDate = SYSDATE
									, ModifierCode = #{userID}
		WHERE 1=1 
		AND CategoryID = #{paramArr}
	</update>
	
	<select id="selectCommunityInCategory" parameterType="cmap" resultType="cmap">
		SELECT 	CU_ID
		FROM 	community
		WHERE 	CategoryID = #{paramArr}
	</select>
	
	<update id="moveCommunityCategory" parameterType="cmap">
		UPDATE COMMUNITY_CATEGORY 
		SET MemberOf = #{MemberOf}
			, FolderType = #{FolderType}
			, FolderPath = CONCAT(#{MemberOf},';')
			, ModifierCode = #{userID}
			, ModifyDate = SYSDATE
		WHERE 1=1 
		AND CategoryID = #{paramArr}
	</update>
	
	<update id="updateCommunitySortProperty" parameterType="cmap">
		UPDATE COMMUNITY_CATEGORY 
		SET SortPath = #{SortPath}
		WHERE CategoryID = #{CategoryID}
	</update>
	
	<update id="createCommunityInfomationCode" parameterType="cmap" >
		UPDATE COMMUNITY SET 
			CU_CODE =  CONCAT('Community', #{CU_ID})
		WHERE CU_ID = #{CU_ID}
	</update>
	
	<update id="updateCommunityStatus"  parameterType="cmap">
		UPDATE COMMUNITY SET
							  RegStatus = #{RegStatus}
							, AppStatus = #{AppStatus}
							, ProcesserCode = #{userID}
		WHERE 1=1
		AND CU_ID = #{CU_ID}
	</update>
	
	<select id="checkCommunityNameCount" parameterType="cmap" resultType="java.lang.Long">
		/* queryId : admin.community.checkCommunityNameCount */
		SELECT COUNT(*)
		FROM COMMUNITY
		WHERE CommunityName = #{DisplayName}
		AND DN_ID = #{domainID}
	</select>
	
	<select id="checkCommunityAliasCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM COMMUNITY
		WHERE CU_Code = #{CU_Code}
	</select>
	
	<select id="communityCnt" parameterType="cmap" resultType="java.lang.Long">
		  SELECT COUNT(*) 
		  FROM SYS_BASE_DICTIONARY 
		  WHERE 1=1 
		  AND DicCode = CONCAT('CU_',#{CU_ID})
		  AND DomainID = #{DN_ID} 
	</select>
	
	<update id="updateCommunityNameDictionary" parameterType="cmap" >
		  UPDATE SYS_BASE_DICTIONARY SET 
									  KoShort = #{DIC_Code_ko} 
									, KoFull = #{DIC_Code_ko} 
									, EnShort = #{DIC_Code_en}
									, EnFull = #{DIC_Code_en}
									, JaShort = #{DIC_Code_ja}
									, JaFull = #{DIC_Code_ja}
									, ZhShort = #{DIC_Code_zh}
									, ZhFull = #{DIC_Code_zh} 
									, ModifierCode = #{userID}
									, ModifyDate = SYSDATE
		WHERE 1=1
		AND DicCode = CONCAT('CU_',#{CU_ID})
		AND DomainID = #{DN_ID} 
	</update>
	
	<insert id="createCommunityNameDictionary" parameterType="cmap" >
		INSERT INTO SYS_BASE_DICTIONARY
		(
			  DomainID
			, DicCode
			, KoShort
			, KoFull
			, EnShort
			, EnFull
			, JaShort
			, JaFull
			, ZhShort
			, ZhFull
			, IsUse
			, IsCaching
			, RegisterCode
			, RegistDate
		)VALUES(
			  #{DN_ID}
			, CONCAT('CU_',#{CU_ID})
			, #{DIC_Code_ko} 
			, #{DIC_Code_ko} 
			, #{DIC_Code_en}
			, #{DIC_Code_en}
			, #{DIC_Code_ja}
			, #{DIC_Code_ja}
			, #{DIC_Code_zh}
			, #{DIC_Code_zh}
			, 'Y'
			, 'Y'
			, #{userID}
			, SYSDATE
		)
	</insert>
	
	<insert id="createCommunityInfomation"  parameterType="cmap" useGeneratedKeys="true">
		INSERT INTO COMMUNITY (
								CU_Code
							 , CategoryID
							 , DN_ID
							 , MN_ID
							 , CommunityType
							 , CommunityName
							 , JoinOption
							 , RegStatus
							 , AppStatus
							 , DefaultMemberLevel
							 , RegProcessDate
							 , LimitFileSize
							 , SearchTitle
							 , SearchSummary
							 , OperatorCode
							 , OperatorName
							 , DefaultBoardType
							 , RegRequestDate
							 , POINT
						) VALUES (
								#{CU_Code}
							 , #{_ParentID}
							 , #{DN_ID}
							 , #{MN_ID}
							 , #{ddlType}
							 , #{txtCommunityName}
							 , #{ddlJoinMothod}
							 , 'R'
							 , 'RV'
							 , #{ddlMemberLevel}
							 , SYSDATE
							 , '300'
							 , #{textLineIntroduction}
							 , #{txtSummary}
							 , #{txtOperator}
							 , (SELECT DisplayName FROM SYS_OBJECT_USER WHERE UserCode = #{txtOperator})
							 , #{ddlDefaultBoardType}
							 , SYSDATE
							 , 0
						)
		<selectKey resultType="java.lang.Long" keyProperty="CU_ID" order="AFTER">
			SELECT COMMUNITY_SEQ.CURRVAL FROM dual
		</selectKey>
	</insert>
	
	<insert id="createCommunityDetailInfomation"  parameterType="cmap" >
		INSERT INTO COMMUNITY_DETAIL
									(  CU_ID
									,  Keyword
									,  Description
									,  DescriptionEditor
									,  Provision
									,  ProvisionEditor	) VALUES (
									
										#{CU_ID}
									,  #{txtKeyword}
									,  #{txtIntroduction}
									,  #{txtIntroduction}
									,  #{txtStipulation}
									,  #{txtStipulation}
									)
	</insert>
	
	<update id="updateCommunityGroupCode"  parameterType="cmap" >
		UPDATE SYS_OBJECT_GROUP SET IsDisplay = #{IsDisplay}
											  , IsUse = #{IsUse}
		WHERE GroupCode IN (SELECT CU_Code FROM COMMUNITY WHERE CU_ID = #{CU_ID})
	</update>
	
	<update id="updateCommunityGroupFD"  parameterType="cmap">
		UPDATE SYS_OBJECT_FOLDER SET 
									  IsUse = #{IsUse}
									, IsDisplay = #{IsDisplay}
		WHERE FolderID IN (
			SELECT LinkFD 
			FROM COMMUNITY_MENU_TOP 
			WHERE FD_ID = 0	
			AND CU_ID = #{CU_ID}
		)
	</update>
	
	<select id="selectCommunityHomeCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM COMMUNITY A 
		INNER JOIN SYS_OBJECT_DOMAIN B ON A.DN_ID = B.DomainID
		WHERE  A.CU_ID NOT IN (SELECT CU_ID FROM COMMUNITY_HOME WHERE CU_ID = #{CU_ID})
		AND RegStatus = 'R'
	</select>
	
	<insert id="createCommunityHome" parameterType="cmap">
		INSERT INTO COMMUNITY_HOME
		(
			 LayoutID
			,CU_ID	
			,CommunityTheme
			,IsUse
			,RegisterCode
		)
		SELECT A.* FROM (
			SELECT 
					 LayoutID
					,#{CU_ID}
					,CommunityTheme
					,IsUse
					,#{userID}
			FROM COMMUNITY_HOME_DEFAULT
			ORDER BY CU_ID ASC
		)A 
		WHERE ROWNUM = 1
	</insert>
	
	<select id="selectCommunityACLCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM SYS_OBJECT_ACL
		WHERE 1=1 
		AND ObjectID = #{ObjectID}
		AND ObjectType = #{ObjectType}
		AND SubjectCode = #{SubjectCode}
		AND SubjectType = #{SubjectType}
	</select>
	
	<select id="selectCommunityInfo"  parameterType="cmap" resultType="cmap">
		SELECT  c.CU_ID AS "CU_ID"
			  , c.CU_Code AS "CU_Code"
			  , c.CategoryID AS "CategoryID"
			  , c.DN_ID AS "DN_ID"
			  , c.OperatorCode AS "OperatorCode"
			  , c.CommunityType AS "CommunityType"
			  , sod.DomainID AS "DomainID"
			  , sod.DomainCode AS "DomainCode"
			  , sod.DomainURL AS "DomainURL"
			  , sod.DisplayName AS "DisplayName"
			  , sod.MultiDisplayName AS "MultiDisplayName"
			  , sod.ShortName AS "ShortName"
			  , sod.MultiShortName AS "MultiShortName"
			  , sod.MemberOf AS "MemberOf"
			  , sod.DomainPath AS "DomainPath"
			  , sod.SortKey AS "SortKey"
			  , sod.SortPath AS "SortPath"
			  , sod.IsUse AS "IsUse"
			  , sod.ServiceUser AS "ServiceUser"
			  , sod.ServiceStart AS "ServiceStart"
			  , sod.ServiceEnd AS "ServiceEnd"
			  , sod.Description AS "Description"
			  , sod.RegistDate AS "RegistDate"
			  , sod.DeleteDate AS "DeleteDate"
			  , sod.MenuSyncTime AS "MenuSyncTime"
			  , c.CommunityName AS "CommunityName"
			  , c.DefaultBoardType AS "DefaultBoardType"
		FROM COMMUNITY c
		INNER JOIN SYS_OBJECT_DOMAIN sod ON sod.DomainID = c.DN_ID
		WHERE 1=1
		AND c.CU_ID = #{CU_ID}
	</select>
	
	<insert id="createCommunityACL" parameterType="cmap">
		INSERT INTO SYS_OBJECT_ACL
		(
			  ObjectID
			, ObjectType
			, SubjectCode
			, SubjectType
			, AclList
			, Security
			, CREATE_
			, DELETE_
			, MODIFY_
			, EXECUTE
			, VIEW_
			, READ
			, RegisterCode
			, RegistDate
		)VALUES(
			  #{ObjectID}
			, #{ObjectType}
			, #{SubjectCode}
			, #{SubjectType}
			, #{AclList}
			, #{Security}
			, #{Create}
			, #{Delete}
			, #{Modify}
			, #{Execute}
			, #{View}
			, #{Read}
			, #{userCode}
			, SYSDATE
		)
	</insert>
	
	<update id="updateCommunityACL" parameterType="cmap">
		UPDATE SYS_OBJECT_ACL SET
									  ObjectID = #{ObjectID}
									, ObjectType = #{ObjectType}
									, SubjectCode = #{SubjectCode}
									, SubjectType = #{SubjectType}
									, AclList = #{AclList}
									, Security = #{Security}
									, CREATE_ = #{Create}
									, DELETE_ = #{Delete}
									, MODIFY_ = #{Modify}
									, EXECUTE = #{Execute}
									, VIEW_ = #{View}
									, READ = #{Read}
									, ModifierCode = #{userCode}
									, ModifyDate = SYSDATE
		WHERE 1=1
		AND ObjectID = #{ObjectID}
		AND ObjectType = #{ObjectType}
		AND SubjectCode = #{SubjectCode}
		AND SubjectType = #{SubjectType}
	</update>
	
	<select id="selectCommunityMemberCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM COMMUNITY_MEMBER 
		WHERE CU_ID = #{CU_ID}
		AND UR_CODE = #{userID}
	</select>
	
	<select id="selectCommunityGroupCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM SYS_OBJECT_GROUP_MEMBER
		WHERE GroupCode = TO_CHAR(#{CU_ID})
		AND UserCode = #{userID}
	</select>
	
	<insert id="createCommunityMember" parameterType="cmap" >
		INSERT INTO COMMUNITY_MEMBER (
										  CU_ID
										, UR_CODE
										, NickName
										, MemberStatus
										, DetailStatus
										, MemberLevel
										, RegMessage	
									)VALUES(
										  #{CU_ID}
										, #{userID}
										, (SELECT DisplayName FROM SYS_OBJECT_USER WHERE UserCode = #{userID})
										, 'R'
										, 'RV'
										, 9
										, ''
									)
	</insert>
	
	<insert id="createCommunityGroup" parameterType="cmap" >
		INSERT INTO SYS_OBJECT_GROUP_MEMBER (
												  GroupCode
												, UserCode
												, SortKey
												, Role
												, IsUse
												, IsHR
												, MemberStatus
											)VALUES(
												  TO_CHAR(#{CU_ID})
												, #{userID}	
												, 100
												, 'sysops'
												, 'Y'
												, 'N'
												, 'A'
											)
	</insert>
	
	<update id="updateCommunityMemberCount" parameterType="cmap" >
		UPDATE COMMUNITY SET MemberCount = MemberCount + 1
		WHERE CU_ID = #{CU_ID}
	</update>
	
	<insert id="createCommunityFolder" parameterType="cmap" useGeneratedKeys="true">
		INSERT INTO SYS_OBJECT_FOLDER
		(
			 DomainID
			,MenuID
			,ObjectType
			,FolderType
			,DisplayName
			,MultiDisplayName
			,MemberOf
			,FolderPath
			,SortKey
			,SortPath
			,IsInherited
			,IsShared
			,IsUse
			,IsDisplay
			,IsURL
			,URL
			,Description
			,OwnerCode
			,RegisterCode
			,RegistDate
			,SecurityLevel
			,Reserved2
		)VALUES(
			 #{DN_ID}
			,#{MenuID}
			,'Community'
			,#{FolderType}
			,#{CommunityName}
			,#{CommunityName}
			,#{MemberOf}
			,''
			,#{SortKey}
			,#{SortPath}
			,#{IsInherited}
			,'N'
			,'Y'
			,'Y'
			,'N'
			,''
			,''
			,#{userID}
			,#{userID}
			,SYSDATE
			,#{SecurityLevel}
			,#{Reserved2}
		)
		<selectKey resultType="java.lang.Long" keyProperty="FolderID" order="AFTER">
			SELECT SYS_OBJECT_FOLDER_SEQ.CURRVAL FROM dual
		</selectKey>
	</insert>
	
	<select id="communityFolderList" parameterType="cmap" resultType="cmap">
		SELECT  FolderType AS "FolderType"
			  , DisplayName AS "FolderName"
			  , SortKey AS "SortKey"
		FROM COMMUNITY_BOARD_DEFAULT 
		WHERE IsUse = 'Y'
		AND DN_ID IN (0, #{DN_ID})
		AND CommunityType = #{DefaultBoardType}
		ORDER BY SortKey
	</select>
	
	<insert id="createCommunityFolderDictionary" parameterType="cmap" >
		INSERT INTO SYS_BASE_DICTIONARY( 
									  DicCode
									, DomainID
									, KoShort
									, KoFull
									, EnShort
									, EnFull
									, JaShort
									, JaFull
									, ZhShort
									, ZhFull
									, DicSection
									, IsUse
									, IsCaching
									, Description
									)
		SELECT  CONCAT('CUFD_', (SELECT MAX(DicID)+1 FROM SYS_BASE_DICTIONARY))
				, #{DN_ID}
				, KoShort
				, KoFull
				, EnShort
				, EnFull
				, JaShort
				, JaFull
				, ZhShort
				, ZhFull
				, 'CUFD'
				, IsUse
				, IsCaching
				, Description 
		FROM SYS_BASE_DICTIONARY 
		WHERE DicCode = #{DIC_Code}  
		GROUP BY DicID, KoShort, KoFull, EnShort, EnFull, JaShort, JaFull, ZhShort, ZhFull, IsUse, IsCaching, Description
	</insert>
	
	<select id="selectCommunityMenuTopCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM COMMUNITY_MENU_TOP
		WHERE 1=1
		AND CU_ID = #{CU_ID}
		AND FD_ID = #{FolderID}
	</select>
	
	<insert id="createCommunityMenuTop" parameterType="cmap">
		INSERT INTO COMMUNITY_MENU_TOP(CU_ID, FD_ID, SortKey)
		SELECT	  #{CU_ID}
				, #{FolderID}
				, NVL(MAX(SortKey), -1) + 1
		FROM COMMUNITY_MENU_TOP
		WHERE CU_ID = #{CU_ID}
	</insert>
	
	<select id="selectCommunityBoardCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) FROM BOARD_CONFIG bc
		INNER JOIN SYS_OBJECT_FOLDER sof ON sof.FolderID = bc.FolderID 
		WHERE 1=1 
		AND sof.ObjectType = 'Community'
		AND MenuID =  #{CU_ID}
	</select>
	
	<insert id="createBoardConfig" parameterType="cmap">
		INSERT INTO BOARD_CONFIG
		(
			 FolderID
			,UseBasicConfig
			,UseFile 
			,UseImage 
			,UseVideo
			,UsePopNotice 
			,UseTopNotice 
			,UseExpiredDate 
			,UseAnony 
			,UseReply 
			,UseComment 
			,UseInterest 
			,UseFavorite 
			,UseRecommend 
			,UseSecret 
			,UseTag
			,UseLink 
			,UsePrint 
			,LimitFileSize 
			,LimitFileCnt 
			,LimitCommentCnt 
			,LimitLinkCnt 
			,RecentlyDay 
			,ExpireDay 
			,DefaultContents 
			,UseScrap 
			,UseCopy 
			,UseCommentRecommend 
			,UseLogWrite
			,UseReadCnt 
			,UseTrackback 
			,UseRSS
			,UseReaderView 
			,UseDefaultSecret 
			,UseEmail 
			,UseCategory
			,UseBodyForm
			,UseUserForm
			,UseOwnerProcess
			,UseUserProcess
			,RegisterCode 
			,RegistDate
			,BoardTotalLimitFileSize
			,CurrentTotalFileSize
			,UseReservation
			,UsePubDeptName
		)
		SELECT 
			 #{FolderID} 
			,'Y' 
			,UseFile 
			,UseImage 
			,UseVideo
			,'N' 
			,UseTopNotice 
			,UseExpiredDate 
			,UseAnony 
			,UseReply 
			,UseComment 
			,UseInterest 
			,'N' 
			,UseRecommend 
			,UseSecret 
			,UseTag 
			,UseLink 
			,UsePrint 
			,LimitFileSize 
			,LimitFileCnt 
			,LimitCommentCnt 
			,LimitLinkCnt 
			,RecentlyDay 
			,ExpireDay 
			,DefaultContents 
			,UseScrap 
			,UseCopy 
			,UseCommentRecommend 
			,UseLogWrite
			,UseReadCnt 
			,UseTrackback 
			,UseRSS
			,UseReaderView 
			,UseDefaultSecret 
			,UseEmail 
			,UseCategory
			,UseBodyForm
			,UseUserForm
			,'N'
			,'N'
			,#{userCode}
			,SYSDATE
			,BoardTotalLimitFileSize
			,CurrentTotalFileSize
			,UseReservation
			,UsePubDeptName
		FROM BOARD_CONFIG_DEFAULT
		WHERE FolderType = (SELECT FolderType FROM SYS_OBJECT_FOLDER WHERE FolderID = #{FolderID})
	</insert>
	
	<update id="updateBoardConfig"  parameterType="cmap">
		UPDATE BOARD_CONFIG SET UseIncludeRecentReg = 'Y' WHERE FolderID = #{FolderID}
	</update>
	
	<insert id="createObjectGroup"  parameterType="cmap">
		INSERT INTO SYS_OBJECT_GROUP
		(
			GroupCode,
			CompanyCode,
			GroupType,
			MemberOf,
			OUName,
			DisplayName,
			MultiDisplayName,
			ShortName,
			MultiShortName,
			Approvable,
			Receivable,
			ApprovalUnitCode,
			ReceiptUnitCode,
			SortKey,
			IsUse,
			IsDisplay,
			IsMail,
			IsHR,
			RegistDate,
			Description
		) VALUES (
			#{CU_Code},
			#{DomainCode},
			'Community',
			#{DN_ID} || '_' ||'Community',
			#{CommunityName}, 
			#{CommunityName},
			#{CommunityName},
			#{CommunityName},
			#{CommunityName},
			1,	
			1,
			#{CU_Code}, 
			#{CU_Code},
			'100',
			'Y',
			'Y',
			'Y',
			'Y',
			SYSDATE,
			''
		)
	</insert>
	
	<select id="selectComObjectPath" parameterType="cmap" resultType="String">
		SELECT FN_COMOBJECTPATHCREATE_S('',#{CU_Code},'GR') FROM dual
	</select>
	
	<select id="selectSortPath" parameterType="cmap" resultType="String">
		SELECT FN_COMSORTPATHCREATE_S('', #{CU_Code}, 'GR') FROM dual
	</select>
	
	<update id="updateObjectGroup" parameterType="cmap">
		UPDATE SYS_OBJECT_GROUP SET 
									  GroupPath = #{comObjectPath}
									, SortPath = #{sortPath}
									, OUPath = #{CommunityName}
		WHERE 1=1 
		AND GroupCode = #{CU_Code}
	</update>
	
	<select id="selectCommunityInfomation" parameterType="cmap" resultType="cmap">
		SELECT	  c.CU_ID AS "CU_ID"
				, c.MN_ID AS "MN_ID"
				, c.CategoryID AS "CategoryID"
				, c.CU_Code AS "CU_Code"
				, c.DN_ID AS "DN_ID"
				, c.SearchTitle AS "SearchTitle"
				, c.CommunityName AS "CommunityName"
				, c.CreatorCode AS "CreatorCode"
				, c.AppStatus AS "AppStatus"
				, TO_CHAR(c.RegRequestDate, 'YYYY-MM-DD') AS "RegRequestDate"
				, cc.FolderPath AS "FolderPath"
				, cc.SortPath AS "SortPath"
				, cc.DisplayName AS "CategoryName"
				, (SELECT COUNT(*) FROM SYS_OBJECT_GROUP_MEMBER sogm WHERE sogm.GroupCode = c.CU_Code) AS "MembersCount"
				, c.RegProcessDate AS "RegProcessDate"
				, c.Point AS "Point"
				, c.MemberCount AS "MemberCount"
				, c.Grade AS "Grade"
				, c.MsgCount AS "MsgCount"
				, sou.DisplayName AS "DisplayName"
				, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS "CuAppDetail"
				, c.JoinOption  AS "CommunityJoin"
				, c.CommunityType AS "CommunityType"
				, c.JoinOption AS "JoinOption"
				, c.CommunityType AS "CommunityType"
				, c.RegStatus AS "RegStatus"
				, c.AppStatus AS "AppStatus"
				, c.LimitFileSize AS "LimitFileSize"
				, (NVL(bd.KoFull,'')||';'||NVL(bd.EnFull,'')||';'||NVL(bd.JaFull,'')||';'||NVL(bd.ZhFull,'')||';;;;;;;' ) AS "MultiDisplayName"
				, c.DefaultBoardType AS "DefaultBoardType"
				, c.DefaultMemberLevel AS "DefaultMemberLevel"
				, NVL(cd.Keyword,'')AS "Keyword"
				, NVL(cd.Description,'')AS "Description"
				, NVL(cd.Provision,'')AS "Provision"
				, NVL(cd.Reserved1,'')AS "Reserved1"
				, NVL(cd.Reserved2,'')AS "Reserved2"
				, c.SearchSummary  AS "SearchSummary"
				, cc.CategoryID AS "CategoryID"
				, c.OperatorCode AS "OperatorCode"
		FROM COMMUNITY c
		INNER JOIN SYS_OBJECT_GROUP sog ON sog.GroupCode = c.CU_Code
		LEFT JOIN SYS_OBJECT_USER sou ON  sou.UserCode = c.OperatorCode
		INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID
		LEFT JOIN COMMUNITY_DETAIL cd ON cd.CU_ID = c.CU_ID
		LEFT JOIN SYS_BASE_DICTIONARY bd ON bd.DicCode = #{DIC_Code}
		WHERE 1=1 
		AND c.CU_ID = #{CU_ID}
		AND ROWNUM = 1
	</select>
	
	<select id="selectDICCode" parameterType="cmap" resultType="String">
		SELECT CONCAT('CU_',c.CU_ID) AS "DIC_Code"
		FROM COMMUNITY c
		WHERE 1=1 
		AND c.CU_ID = #{CU_ID}
	</select>
	
	<update id="editCommunityInfomation" parameterType="cmap" >
		UPDATE COMMUNITY SET
			  CategoryID = #{_ParentID}
			, CommunityType = #{ddlType}
			, CommunityName = #{txtCommunityName}
			, JoinOption = #{ddlJoinMothod}
			, DefaultMemberLevel = #{ddlMemberLevel}
			, LimitFileSize = #{txtLimitFileSize}
			, Grade = #{txtGrade}
			, DefaultBoardType =  #{ddlDefaultBoardType}
			, SearchTitle = #{textLineIntroduction}
			, SearchSummary = #{txtSummary}
		WHERE 1=1
		AND CU_ID = #{CU_ID}
	</update>
	
	<select id="selectCommunityDetailInfomationCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM COMMUNITY_DETAIL
		WHERE 1=1
		AND CU_ID = #{CU_ID}
	</select>
	
	<update id="updateCommunityDetailInfomation" parameterType="cmap" >
		UPDATE COMMUNITY_DETAIL SET 
										Keyword = #{txtKeyword}
									 , DescriptionEditor = #{txtIntroduction}
									 , Description = #{txtIntroduction}
									 , Provision = #{txtStipulation}
									 , ProvisionEditor = #{txtStipulation}
		WHERE 1=1
		AND CU_ID = #{CU_ID}
	</update>
	
	<select id="selectCommunityOperatorInfo"  parameterType="cmap" resultType="cmap">
		 SELECT C.OperatorCode AS "OperatorCode"
			  , C.CommunityName AS "CommunityName"
			  , SOU.MailAddress AS "MailAddress"
		 FROM community C
		 LEFT OUTER JOIN sys_object_user SOU ON SOU.UserCode = C.OperatorCode
		 WHERE 1=1
		 AND CU_ID = #{CU_ID}
	</select>
	
	<insert id="insertTodoSendMessage" parameterType="cmap">
		INSERT INTO SYS_ALARM_LIST(
										UserCode
									 , Category
									 , MsgType
									 , Title
									 , URL
									 , Message
									 , OpenType
									 , ObjectID
									 , ObjectType
									 , IsPush
									 , PusherCode
									 , ReceivedDate
									 , IsRead
								)VALUES(
										#{OpUR_Code}
									 , 'Community'
									 , 'ContactOperator'
									 , '커뮤니티  운영자 연락'
									 , #{url}
									 , #{sendMessage}
									 , 'PAGEMOVE'
									 , '0'
									 , ''
									 , 'Y'
									 , #{userID}
									 , SYSDATE
									 , 'N'
								)
	</insert>
	
	<select id="selectCommunityOpenGridListCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) FROM (
			SELECT A.*
			FROM (
				SELECT	
						 NVL(SUBSTR(c.CreatorDept, 1 ,INSTR(c.CreatorDept, ';', 1, 1)-1),'') AS "CreatorDept"
						, NVL(sou.DisplayName,'')AS "DisplayName"
						, c.CU_ID AS "CU_ID"
						, c.MN_ID AS "MN_ID"
						, c.CategoryID AS "CategoryID"
						, c.CU_Code AS "CU_Code"
						, c.DN_ID AS "DN_ID"
						, c.SearchTitle AS "SearchTitle"
						, c.CommunityName AS "CommunityName"
						, c.CreatorCode AS "CreatorCode"
						, c.AppStatus AS "AppStatus"
						, c.RegRequestDate AS "RegRequestDate"
						, cc.FolderPath AS "FolderPath"
						, cc.SortPath AS "SortPath"
						, cc.DisplayName AS "CategoryName"
						, (SELECT COUNT(*) FROM SYS_OBJECT_GROUP_MEMBER sogm WHERE sogm.GroupCode = c.CU_Code) AS "MembersCount"
						, c.RegProcessDate AS "RegProcessDate"
						, c.Point AS "Point"
						, c.MemberCount AS "MemberCount"
						, c.Grade AS "Grade"
						, c.MsgCount AS "MsgCount"
						, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS "CuAppDetail"
						, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityJoin', c.JoinOption)) AS "CommunityJoin"
						, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityType', c.CommunityType)) AS "CommunityType"
						, NVL(cd.Keyword,'')AS "Keyword"
						, NVL(cd.Description,'')AS "Description"
						, NVL(cd.Provision,'')AS "Provision"
				 FROM COMMUNITY c
				 INNER JOIN SYS_OBJECT_GROUP sog ON sog.GroupCode = c.CU_Code
				 LEFT JOIN SYS_OBJECT_USER sou ON  sou.UserCode = c.CreatorCode
				 INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID
				 LEFT JOIN COMMUNITY_DETAIL cd ON cd.CU_ID = c.CU_ID
				 WHERE 1=1 
				 AND c.Appstatus= 'RA'
				 AND c.DN_ID = #{DN_ID}
			)A
			WHERE 1=1 
			<choose>
				<when test ="Option =='0'.toString() ">
					AND (A."DisplayName" LIKE '%'||#{searchValue}||'%'
					OR A."CreatorDept" LIKE '%'||#{searchValue}||'%')
				</when>
				<when test ="Option =='1'.toString() ">
					AND A."DisplayName" LIKE '%'||#{searchValue}||'%'
				</when>
				<when test ="Option =='2'.toString() ">
					AND A."CreatorDept" LIKE '%'||#{searchValue}||'%'
				</when>
			</choose>
		)B
	</select>
	
	<select id="selectCommunityOpenGridList"  parameterType="cmap" resultType="cmap">
		<include refid="oracle.include.pagingHeader"/>
		SELECT	  CreatorDept AS "CreatorDept"
				, DisplayName AS "DisplayName"
				, CU_ID AS "CU_ID"
				, MN_ID AS "MN_ID"
				, CategoryID AS "CategoryID"
				, CU_Code AS "CU_Code"
				, DN_ID AS "DN_ID"
				, SearchTitle AS "SearchTitle"
				, CommunityName AS "CommunityName"
				, CreatorCode AS "CreatorCode"
				, AppStatus AS "AppStatus"
				, RegRequestDate AS "RegRequestDate"
				, FolderPath AS "FolderPath"
				, SortPath AS "SortPath"
				, CategoryName AS "CategoryName"
				, MembersCount AS "MembersCount"
				, RegProcessDate AS "RegProcessDate"
				, Point AS "Point"
				, MemberCount AS "MemberCount"
				, Grade AS "Grade"
				, MsgCount AS "MsgCount"
				, CuAppDetail AS "CuAppDetail"
				, CommunityJoin AS "CommunityJoin"
				, CommunityType AS "CommunityType"	
				, Keyword AS "Keyword"
				, Description AS "Description"
				, Provision AS "Provision"
		FROM (
			SELECT	  NVL(SUBSTR(c.CreatorDept, 1, INSTR(c.CreatorDept, ';', 1, 1) - 1), '') AS CreatorDept
					, NVL(sou.DisplayName,'') AS DisplayName
					, c.CU_ID
					, c.MN_ID
					, c.CategoryID
					, c.CU_Code
					, c.DN_ID
					, c.SearchTitle
					, c.CommunityName
					, c.CreatorCode
					, c.AppStatus
					, c.RegRequestDate
					, cc.FolderPath
					, cc.SortPath
					, cc.DisplayName AS CategoryName
					, (SELECT COUNT(*) FROM SYS_OBJECT_GROUP_MEMBER sogm WHERE sogm.GroupCode = c.CU_Code) AS MembersCount
					, c.RegProcessDate
					, c.Point
					, c.MemberCount
					, c.Grade
					, c.MsgCount
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS CuAppDetail
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityJoin', c.JoinOption)) AS CommunityJoin
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityType', c.CommunityType)) AS CommunityType
					, NVL(cd.Keyword,'') AS Keyword
					, NVL(cd.Description,'') AS Description
					, NVL(cd.Provision,'') AS Provision
			FROM COMMUNITY c
			INNER JOIN SYS_OBJECT_GROUP sog ON sog.GroupCode = c.CU_Code
			LEFT JOIN SYS_OBJECT_USER sou ON sou.UserCode = c.CreatorCode
			INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID
			LEFT JOIN COMMUNITY_DETAIL cd ON cd.CU_ID = c.CU_ID
			WHERE 1=1 
			AND c.Appstatus = 'RA'
			AND c.DN_ID = #{DN_ID}
		) A
		WHERE 1=1 
		<choose>
			<when test ="Option =='0'.toString() ">
				AND (DisplayName LIKE '%'||#{searchValue}||'%'
				OR CreatorDept LIKE '%'||#{searchValue}||'%')
			</when>
			<when test ="Option =='1'.toString() ">
				AND DisplayName LIKE '%'||#{searchValue}||'%'
			</when>
			<when test ="Option =='2'.toString() ">
				AND CreatorDept LIKE '%'||#{searchValue}||'%'
			</when>
		</choose>
		<trim prefix="ORDER BY"  prefixOverrides =",">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("CategoryName")'>CategoryName</when>
					<when test='sortColumn.equalsIgnoreCase("CU_Code")'>CU_Code</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityName")'>CommunityName</when>
					<when test='sortColumn.equalsIgnoreCase("SearchTitle")'>SearchTitle</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("RegRequestDate")'>RegRequestDate</when>
					<otherwise>CU_ID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
				<include refid="oracle.include.listOrderBy"/>
			</if>
		</trim>
		<include refid="oracle.include.pagingFooter"/>
	</select>
	
	<select id="selectCommunityCloseGridListCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM COMMUNITY c
		INNER JOIN SYS_OBJECT_GROUP sog ON sog.GroupCode = c.CU_Code
		LEFT JOIN SYS_OBJECT_USER sou ON  sou.UserCode = c.CreatorCode
		INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID
		WHERE 1=1 
		AND c.Appstatus= #{AppStatus}
		AND c.DN_ID = #{DN_ID}
	</select>
	
	<select id="selectCommunityCloseGridList" parameterType="cmap" resultType="cmap">
		<include refid="oracle.include.pagingHeader"/>
		SELECT	  CreatorDept AS "CreatorDept"
				, DisplayName AS "DisplayName"
				, CU_ID AS "CU_ID"
				, MN_ID AS "MN_ID"
				, CategoryID AS "CategoryID"
				, CU_Code AS "CU_Code"
				, DN_ID AS "DN_ID"
				, SearchTitle AS "SearchTitle"
				, CommunityName AS "CommunityName"
				, CreatorCode AS "CreatorCode"
				, AppStatus AS "AppStatus"
				, RegRequestDate AS "RegRequestDate"
				, FolderPath AS "FolderPath"
				, SortPath AS "SortPath"
				, CategoryName AS "CategoryName"
				, MembersCount AS "MembersCount"
				, RegProcessDate AS "RegProcessDate"
				, UnRegRequestDate AS "UnRegRequestDate"
				, UnRegProcessDate AS "UnRegProcessDate"
				, Point AS "Point"
				, MemberCount AS "MemberCount"
				, Grade AS "Grade"
				, MsgCount AS "MsgCount"
				, RegStatus AS "RegStatus"
				, CuAppDetail AS "CuAppDetail"
				, CommunityJoin AS "CommunityJoin"
				, CommunityType AS "CommunityType"	
				, Keyword AS "Keyword"
				, Description AS "Description"
				, Provision AS "Provision"
		FROM (
			SELECT	  NVL(SUBSTR(c.CreatorDept, 1, INSTR(c.CreatorDept, ';', 1, 1) - 1), '') AS CreatorDept
					, NVL(sou.DisplayName, '') AS DisplayName
					, c.CU_ID
					, c.MN_ID
					, c.CategoryID
					, c.CU_Code
					, c.DN_ID
					, c.SearchTitle
					, c.CommunityName
					, c.CreatorCode
					, c.AppStatus
					, c.RegRequestDate
					, cc.FolderPath
					, cc.SortPath
					, cc.DisplayName AS CategoryName
					, (SELECT COUNT(*) FROM SYS_OBJECT_GROUP_MEMBER sogm WHERE sogm.GroupCode = c.CU_Code) AS MembersCount
					, c.RegProcessDate
					, c.UnRegRequestDate
					, c.UnRegProcessDate
					, c.Point
					, c.MemberCount
					, c.Grade
					, c.MsgCount
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuStatus', c.RegStatus)) AS RegStatus
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuAppDetail', c.AppStatus)) AS CuAppDetail
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityJoin', c.JoinOption)) AS CommunityJoin
					, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CommunityType', c.CommunityType)) AS CommunityType	
					, NVL(cd.Keyword, '') AS Keyword
					, NVL(cd.Description, '') AS Description
					, NVL(cd.Provision, '') AS Provision
			FROM COMMUNITY c
			INNER JOIN SYS_OBJECT_GROUP sog ON sog.GroupCode = c.CU_Code
			LEFT JOIN SYS_OBJECT_USER sou ON  sou.UserCode = c.CreatorCode
			INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID
			LEFT JOIN COMMUNITY_DETAIL cd ON cd.CU_ID = c.CU_ID
			WHERE 1=1 
			AND c.Appstatus= #{AppStatus}
			AND c.DN_ID = #{DN_ID}
		) A
		WHERE 1=1
		<trim prefix="ORDER BY" prefixOverrides =",">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' ">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("UnRegRequestDate")'>UnRegRequestDate</when>
					<when test='sortColumn.equalsIgnoreCase("RegStatus")'>RegStatus</when>
					<when test='sortColumn.equalsIgnoreCase("CuAppDetail")'>CuAppDetail</when>
					<when test='sortColumn.equalsIgnoreCase("CategoryName")'>CategoryName</when>
					<when test='sortColumn.equalsIgnoreCase("CU_Code")'>CU_Code</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityName")'>CommunityName</when>
					<when test='sortColumn.equalsIgnoreCase("SearchTitle")'>SearchTitle</when>
					<when test='sortColumn.equalsIgnoreCase("UnRegProcessDate")'>UnRegProcessDate</when>
					<otherwise>CU_ID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
				<include refid="oracle.include.listOrderBy"/>
			</if>
		</trim>
		<include refid="oracle.include.pagingFooter"/>
	</select>
	
	<update id="staticCommunityUpdate" parameterType="cmap">
		UPDATE COMMUNITY
		SET 
			<if test="RegStatus != null and RegStatus != '' and AppStatus == 'UV'">
				RegStatus = #{RegStatus}, 
			</if>
			UnRegProcessDate = SYSDATE, 
			AppStatus = #{AppStatus}, 
			ProcesserCode = #{userID}
		WHERE CU_ID = #{CU_ID}
	</update>
	
	<update id="staticCommunityGrMemberUpdate" parameterType="cmap">
		UPDATE SYS_OBJECT_GROUP_MEMBER SET 
			IsUse = #{IsUse}
		WHERE GroupCode = CONCAT('Community',#{CU_ID})	
	</update>
	
	<update id="staticCommunityGrUpdate" parameterType="cmap" >
		UPDATE SYS_OBJECT_GROUP SET 
			IsUse = #{IsUse}
		WHERE GroupCode = CONCAT('Community',#{CU_ID})	
	</update>
	
	<select id="selectCommunityStaticGridListCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT
				COUNT(*)
		FROM COMMUNITY c
		LEFT JOIN SYS_OBJECT_USER sou ON  sou.UserCode = c.OperatorCode
		INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID 
		INNER JOIN COMMUNITY_DETAIL cd ON cd.CU_ID = c.CU_ID 
		WHERE 1=1
		AND c.Gubun = 'C'
		<choose>
			<when test ="SearchOption =='A'.toString()">
				AND (sou.DisplayName LIKE '%'||#{searchValue}||'%'
				OR c.CommunityName LIKE '%'||#{searchValue}||'%')
			</when>
			<when test ="SearchOption =='C'.toString() ">
				AND c.CommunityName LIKE '%'||#{searchValue}||'%'	
			</when>
			<when test ="SearchOption =='O'.toString() ">
				AND sou.DisplayName LIKE '%'||#{searchValue}||'%'
			</when>
		</choose>
		<if test="DN_ID != null and DN_ID != ''">
			AND c.DN_ID = #{DN_ID}
		</if>
		<if test="CommunityType != null and CommunityType != ''">
			AND c.CommunityType = #{CommunityType}
		</if>
		<if test="RegStatus != null and RegStatus != ''">
			AND c.RegStatus = #{RegStatus}
		</if>
	</select>
	
	<select id="selectCommunityStaticGridList"  parameterType="cmap" resultType="cmap">
		<include refid="oracle.include.pagingHeader"/>
		SELECT	LimitFileSize AS "LimitFileSize",
				UsedFileSize AS "UsedFileSize",
				MemberCount AS "MemberCount",
				MsgCount AS "MsgCount",
				ReplyCount AS "ReplyCount",
				VisitCount AS "VisitCount",
				ViewCount AS "ViewCount",
				Point AS "Point",
				Grade AS "Grade",
				RegProcessDate AS "RegProcessDate",
				CU_ID AS "CU_ID",
				CommunityName AS "CommunityName",
				RegStatus AS "RegStatus",
				DisplayName AS "DisplayName",
				FileSize AS "FileSize",
				ROWNUM AS "number"	
		FROM (
			SELECT	A.*,
					ROUND(UsedFileSize / POWER(1024, r), 2)||''||(case when r + 1 = 1 then 'Bytes' 
																		 when r + 1 = 2 then 'KB'  
																		 when r + 1 = 3 then 'MB'  
																		 when r + 1 = 4 then 'GB'
																		 when r + 1 = 5 then 'TB'
																		 when r + 1 = 6 then 'PB'
																		 when r + 1 = 7 then 'EB'
																		 when r + 1 = 8 then 'ZB'
																		 when r + 1 = 9 then 'YB'
																		 when r + 1 = 10 then 'BB' 
																	end)||'/'||LimitFileSize||'MB' AS FileSize  
			FROM (
				SELECT	NVL(TRUNC(case when c.UsedFileSize > 0 then LOG(1024, c.UsedFileSize) else c.UsedFileSize end, 0), 0) AS r,
						NVL(c.LimitFileSize,'0') AS LimitFileSize,
						NVL(c.UsedFileSize,'0') AS UsedFileSize,
						(SELECT COUNT(*) FROM COMMUNITY_MEMBER WHERE MemberLevel != '0' AND MemberStatus = 'R' AND DetailStatus = 'RV' AND CU_ID = c.CU_ID) AS MemberCount,
						c.MsgCount,
						c.ReplyCount,
						c.OneMsgCount,
						c.VisitCount,
						c.ViewCount,
						c.Point,
						c.Grade,
						c.CU_ID,
						c.CommunityName,
						sou.DisplayName,
						c.RegProcessDate AS RegProcessDate,
						NVL(FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuStatus', c.RegStatus)), ' ') AS RegStatus
				FROM COMMUNITY c
				LEFT JOIN SYS_OBJECT_USER sou ON sou.UserCode = c.OperatorCode
				INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID 
				INNER JOIN COMMUNITY_DETAIL cd ON cd.CU_ID = c.CU_ID 
				WHERE 1=1
				AND c.Gubun = 'C'
				<choose>
					<when test ="SearchOption =='A'.toString()">
						AND (sou.DisplayName LIKE '%'||#{searchValue}||'%'
						OR c.CommunityName LIKE '%'||#{searchValue}||'%')
					</when>
					<when test ="SearchOption =='C'.toString() ">
						AND c.CommunityName LIKE '%'||#{searchValue}||'%'	
					</when>
					<when test ="SearchOption =='O'.toString() ">
						AND sou.DisplayName LIKE '%'||#{searchValue}||'%'
					</when>
				</choose>
				<if test="DN_ID != null and DN_ID != ''">
					AND c.DN_ID = #{DN_ID}
				</if>
				<if test="CommunityType != null and CommunityType != ''">
					AND c.CommunityType = #{CommunityType}
				</if>
				<if test="RegStatus != null and RegStatus != ''">
					AND c.RegStatus = #{RegStatus}
				</if>
			) A
		) RESULT
		<trim prefix="ORDER BY"  prefixOverrides =","> 
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' "> 
				<choose>
					<when test='sortColumn.equalsIgnoreCase("number")'>"number"</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityName")'>CommunityName</when>
					<when test='sortColumn.equalsIgnoreCase("Grade")'>TO_NUMBER(Grade)</when>
					<when test='sortColumn.equalsIgnoreCase("Point")'>TO_NUMBER(Point)</when>
					<when test='sortColumn.equalsIgnoreCase("MemberCount")'>TO_NUMBER(MemberCount)</when>
					<when test='sortColumn.equalsIgnoreCase("VisitCount")'>TO_NUMBER(VisitCount)</when>
					<when test='sortColumn.equalsIgnoreCase("MsgCount")'>TO_NUMBER(MsgCount)</when>
					<when test='sortColumn.equalsIgnoreCase("ViewCount")'>TO_NUMBER(ViewCount)</when>
					<when test='sortColumn.equalsIgnoreCase("ReplyCount")'>TO_NUMBER(ReplyCount)</when>
					<when test='sortColumn.equalsIgnoreCase("FileSize")'>FileSize</when>
					<when test='sortColumn.equalsIgnoreCase("RegStatus")'>RegStatus</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>DisplayName</when>
					<when test='sortColumn.equalsIgnoreCase("RegProcessDate")'>RegProcessDate</when>
					<otherwise>CU_ID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
				<include refid="oracle.include.listOrderBy"/>
			</if>
		</trim>	
		<include refid="oracle.include.pagingFooter"/>
	</select>
	
	<select id="selectCommunityStaticSubGridListCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM COMMUNITY_LOG_GROUP_DAILY
		WHERE 1=1
		AND CU_ID = #{CU_ID} 
		<if test="startDate != '' or endDate != ''">
			AND YYYYMMDD BETWEEN #{startDate} AND #{endDate}
		</if>
	</select>
	
	<select id="selectCommunityStaticSubGridList"  parameterType="cmap" resultType="cmap">
		<include refid="oracle.include.pagingHeader"/>
		SELECT	YYYYMMDD
				, CU_ID
				, MN_ID
				, MemberCount AS "MemberCount"
				, MsgCount AS "MsgCount"
				, ReplyCount AS "ReplyCount"
				, OneMsgCount AS "OneMsgCount"
				, VisitCount AS "VisitCount"
				, ViewCount AS "ViewCount"
				, Point AS "Point"
				, Grade AS "Grade"
				, Difference AS "Difference"
				, RegistDate AS "RegistDate"
				, MeetingUserCount AS "MeetingUserCount"
				, MeetingPaRate AS "MeetingPaRate"
		FROM COMMUNITY_LOG_GROUP_DAILY 
		WHERE 1=1 
		AND CU_ID = #{CU_ID} 
		<if test="startDate != '' or endDate != ''">
			AND YYYYMMDD between #{startDate} and #{endDate}
		</if>
		<trim prefix="ORDER BY" prefixOverrides =","> 
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !='' "> 
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Grade")'>TO_NUMBER(Grade)</when>
					<when test='sortColumn.equalsIgnoreCase("Point")'>TO_NUMBER(Point)</when>
					<when test='sortColumn.equalsIgnoreCase("MemberCount")'>TO_NUMBER(MemberCount)</when>
					<when test='sortColumn.equalsIgnoreCase("VisitCount")'>TO_NUMBER(VisitCount)</when>
					<when test='sortColumn.equalsIgnoreCase("MsgCount")'>TO_NUMBER(MsgCount)</when>
					<when test='sortColumn.equalsIgnoreCase("ViewCount")'>TO_NUMBER(ViewCount)</when>
					<when test='sortColumn.equalsIgnoreCase("ReplyCount")'>TO_NUMBER(ReplyCount)</when>
					<otherwise>YYYYMMDD</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
				<include refid="oracle.include.listOrderBy"/>
			</if>
		</trim>
		<include refid="oracle.include.pagingFooter"/>
	</select>
	
	<select id="selectCommunityExcelLogDaily"  parameterType="cmap" resultType="cmap">
		SELECT	YYYYMMDD
				, CU_ID
				, MN_ID
				, MemberCount AS "MemberCount"
				, MsgCount AS "MsgCount"
				, ReplyCount AS "ReplyCount"
				, OneMsgCount AS "OneMsgCount"
				, VisitCount AS "VisitCount"
				, ViewCount AS "ViewCount"
				, Point AS "Point"
				, Grade AS "Grade"
				, Difference AS "Difference"
				, RegistDate AS "RegistDate"
				, MeetingUserCount AS "MeetingUserCount"
				, MeetingPaRate AS "MeetingPaRate"
		FROM COMMUNITY_LOG_GROUP_DAILY 
		WHERE 1=1 
		AND CU_ID = #{CU_ID}
	</select>
	
	<select id="selectCommunityExcelInfo" parameterType="cmap" resultType="cmap">
		SELECT	A.RegProcessDate AS "RegProcessDate"
			  , A.MembersCount AS "MembersCount"
			  , A.Point AS "Point"
			  , A.MemberCount AS "MemberCount"
			  , A.Grade AS "Grade"
			  , A.MsgCount  AS "MsgCount"
			  , A.OpUserName AS "OpUserName"
			  , A.RegStatus AS "RegStatus"
			  , A.LimitFileSize AS "LimitFileSize"
			  , A.UsedFileSize  AS "UsedFileSize"
			  , A.ReplyCount AS "ReplyCount"
			  , A.OneMsgCount AS "OneMsgCount"
			  , A.VisitCount AS "VisitCount"
			  , A.ViewCount AS "ViewCount"
			  , A.CommunityName AS "CommunityName"
			  , A.CU_ID
			  , ROUND(A.UsedFileSize / POWER(1024, r), 2)||''||(case	when r + 1 = 1 then 'Bytes' 
																		when r + 1 = 2 then 'KB'  
																		when r + 1 = 3 then 'MB'  
																		when r + 1 = 4 then 'GB'
																		when r + 1 = 5 then 'TB'
																		when r + 1 = 6 then 'PB'
																		when r + 1 = 7 then 'EB'
																		when r + 1 = 8 then 'ZB'
																		when r + 1 = 9 then 'YB'
																		when r + 1 = 10 then 'BB' 
																end)||'/'||A.LimitFileSize||'MB' AS "FileSize"
		FROM ( 
			 SELECT	 
				c.RegProcessDate AS RegProcessDate
						, (SELECT COUNT(*) FROM COMMUNITY_MEMBER WHERE  MemberLevel != '0' AND MemberStatus = 'R' AND DetailStatus = 'RV' AND CU_ID = c.CU_ID ) AS MembersCount
						, c.Point
						, c.MemberCount
						, c.Grade
						, c.MsgCount
						, sou.DisplayName AS OpUserName
						, FN_BASEGETDICTIONARY_S(#{lang}, Fn_GetBaseMultiCodeName(c.DN_ID, 'CuStatus', c.RegStatus)) AS RegStatus 
						, NVL(c.LimitFileSize,'')AS LimitFileSize
						, NVL(c.UsedFileSize,'')AS UsedFileSize
						, c.ReplyCount
						, c.OneMsgCount
						, c.VisitCount
						, c.ViewCount
						, c.CommunityName
						, c.CU_ID
						, NVL(TRUNC(  case when c.UsedFileSize > 0 then LOG(1024, c.UsedFileSize) else c.UsedFileSize end ,0 ),0) AS r
			FROM COMMUNITY c
			INNER JOIN SYS_OBJECT_GROUP sog ON sog.GroupCode = c.CU_Code
			LEFT JOIN SYS_OBJECT_USER sou ON  sou.UserCode = c.OperatorCode
			INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID
			INNER JOIN COMMUNITY_DETAIL cd ON cd.CU_ID = c.CU_ID
			WHERE 1=1 
			AND c.CU_ID = #{CU_ID}
		)A
	</select>
	
	<select id="selectCommunityExcelInfoCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT
				COUNT(*)
		FROM COMMUNITY c
		INNER JOIN SYS_OBJECT_GROUP sog ON sog.GroupCode = c.CU_Code
		LEFT JOIN SYS_OBJECT_USER sou ON  sou.UserCode = c.OperatorCode
		INNER JOIN COMMUNITY_CATEGORY cc ON cc.CategoryID = c.CategoryID
		INNER JOIN COMMUNITY_DETAIL cd ON cd.CU_ID = c.CU_ID
		WHERE 1=1 
		AND c.CU_ID = #{CU_ID}
	</select>
	
	<select id="selectCommunityBoardSettingGridList" parameterType="cmap" resultType="cmap">
		<include refid="oracle.include.pagingHeader"/>
		SELECT	  ROWNUM AS "num"
				, LPAD(ROWNUM,'10','0') AS S_ORDER
				, DN_NAME
				, DN_ID
				, CommunityType AS "CommunityType"
				, CommunityTypeName AS "CommunityTypeName"
				, FolderType AS "FolderType"
				, FolderTypeName AS "FolderTypeName"
				, BoardName AS "BoardName"
				, exDisplayName AS "exDisplayName"
				, MemberOf AS "MemberOf"
				, SortKey AS "SortKey"
				, IsUse AS "IsUse"
				, Description AS "Description"
				, P_LEVEL AS "P_LEVEL"
				, MenuID AS "MenuID"
		FROM (
			SELECT	  sod.DisplayName AS DN_NAME
					, cbd.DN_ID
					, cbd.CommunityType
					, NVL(sbc.CodeName, '') AS CommunityTypeName
					, cbd.FolderType
					, NVL(soft.DisplayName, '') AS FolderTypeName
					, cbd.DisplayName AS BoardName
					, cbd.exDisplayName
					, cbd.MemberOf
					, cbd.SortKey
					, cbd.IsUse
					, TO_CHAR(cbd.Description) AS Description
					, '1' AS P_LEVEL
					, cbd.MenuID
			FROM COMMUNITY_BOARD_DEFAULT cbd
			INNER JOIN SYS_OBJECT_DOMAIN sod ON sod.DomainID = cbd.DN_ID
			LEFT OUTER JOIN SYS_BASE_CODE sbc ON sbc.CodeGroup = 'CommunityDefaultBoardType' AND sbc.Code = cbd.CommunityType
			LEFT OUTER JOIN SYS_OBJECT_FOLDER_TYPE soft ON soft.FolderType = cbd.FolderType AND soft.BizSection ='Community'
			WHERE 1=1
			AND sbc.DomainID = (SELECT NVL(MAX(DomainID), 0) FROM SYS_BASE_CODE WHERE Code = sbc.Code AND CodeGroup = 'CommunityDefaultBoardType' AND DomainID = #{domainID})
			<if test="domainID != null and domainID != ''">
				AND cbd.DN_ID = #{domainID}
			</if>
			<if test="code != null and code != ''">
				AND sbc.Code = #{code}
			</if>
			<if test="searchValue != null and searchValue != ''">
				AND cbd.DisplayName LIKE '%'||#{searchValue}||'%'
			</if>
		) A
		<trim prefix="ORDER BY" prefixOverrides=","> 
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection !=''">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DN_NAME")'>DN_NAME</when>
					<when test='sortColumn.equalsIgnoreCase("CommunityTypeName")'>CommunityTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("BoardName")'>BoardName</when>
					<when test='sortColumn.equalsIgnoreCase("FolderTypeName")'>FolderTypeName</when>
					<when test='sortColumn.equalsIgnoreCase("IsUse")'>IsUse</when>
					<when test='sortColumn.equalsIgnoreCase("Description")'>Description</when>
					<otherwise>MenuID</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
				<include refid="oracle.include.listOrderBy"/>
			</if>
		</trim>
		<include refid="oracle.include.pagingFooter"/>
	</select>
	
	<select id="selectCommunityBoardSettingGridListCount"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM COMMUNITY_BOARD_DEFAULT cbd
		INNER JOIN SYS_OBJECT_DOMAIN sod ON sod.DomainID = cbd.DN_ID
		LEFT OUTER JOIN SYS_BASE_CODE sbc ON sbc.CodeGroup = 'CommunityDefaultBoardType' AND sbc.Code = cbd.CommunityType
		LEFT OUTER JOIN SYS_OBJECT_FOLDER_TYPE soft ON soft.FolderType = cbd.FolderType AND soft.BizSection ='Community'
		WHERE 1=1
		AND sbc.DomainID = (SELECT NVL(MAX(DomainID), 0) FROM SYS_BASE_CODE WHERE Code = sbc.Code AND CodeGroup = 'CommunityDefaultBoardType' AND DomainID = #{domainID})
		<if test="domainID != null and domainID != ''">
			AND cbd.DN_ID = #{domainID}
		</if>
		<if test="code != '' or code != ''">
			AND sbc.Code = #{code}
		</if>
		<if test="searchValue != '' or searchValue != ''">
			AND cbd.DisplayName LIKE '%'||#{searchValue}||'%'
		</if>
	</select>
	
	<update id="updateBoardSettingUseChange"  parameterType="cmap">
		UPDATE COMMUNITY_BOARD_DEFAULT 
		SET IsUse = #{IsUse}
		WHERE 1=1
		AND MenuID = #{MenuID}
	</update>
	
	<update id="updateBoardSetting"  parameterType="cmap">
		UPDATE COMMUNITY_BOARD_DEFAULT SET 
								DN_ID = #{DN_ID},
								FolderType = #{FolderType},
								DisplayName = #{DisplayName},
								exDisplayName = #{exDisplayName},
								SortKey = #{SortKey},
								IsUse = #{IsUse},
								CommunityType = #{CommunityType},
								Description = #{Description}
		WHERE 1=1
		AND MenuID = #{MenuID}
	</update>
	
	<insert id="createBoardSetting" parameterType="cmap">
		INSERT INTO COMMUNITY_BOARD_DEFAULT (
												DN_ID,
												FolderType,
												DisplayName,
												exDisplayName,
												SortKey,
												IsUse,
												CommunityType,
												Description
											)VALUES(
												#{DN_ID},
												#{FolderType},
												#{DisplayName},
												#{exDisplayName},
												#{SortKey},
												#{IsUse},
												#{CommunityType},
												#{Description}
											)
	</insert>
	
	<select id="selectCommunityFolderType" parameterType="cmap" resultType="cmap">
		SELECT	  FolderType AS "optionValue"
				, DisplayName AS "optionText"
		FROM SYS_OBJECT_FOLDER_TYPE 
		WHERE BizSection = 'Community'
	</select>
	
	<select id="communityBoardSettingInfo" parameterType="cmap" resultType="cmap">
		SELECT	cbd.DN_ID AS "DN_ID"
				, cbd.CommunityType AS "CommunityType"
				, cbd.FolderType AS "FolderType"
				, cbd.DisplayName AS "BoardName"
				, cbd.exDisplayName AS "MultiDisplayName"
				, cbd.SortKey AS "SortKey"
				, cbd.IsUse AS "IsUse"
				, NVL(cbd.Description,'')AS "Description"
				, cbd.MenuID AS "MenuID" 
		FROM COMMUNITY_BOARD_DEFAULT cbd
		INNER JOIN SYS_OBJECT_DOMAIN sod ON sod.DomainID = cbd.DN_ID
		LEFT OUTER JOIN SYS_BASE_CODE sbc ON sbc.CodeGroup = 'CommunityDefaultBoardType' AND sbc.Code = cbd.CommunityType
		LEFT OUTER JOIN SYS_OBJECT_FOLDER_TYPE soft ON soft.FolderType = cbd.FolderType AND soft.BizSection ='Community'
		WHERE 1=1 
		AND cbd.MenuID = #{MenuID}
		AND sbc.DomainID = (SELECT NVL(MAX(DomainID), 0) FROM SYS_BASE_CODE WHERE Code = sbc.Code AND CodeGroup = 'CommunityDefaultBoardType' AND DomainID = cbd.DN_ID)
	</select>
	
	<select id="selectCommunityFolderCnt"  parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM SYS_OBJECT_FOLDER
		WHERE 1=1 
		AND FolderType = #{FolderType}
		AND ObjectType = 'Community'
		AND MenuID = #{CU_ID}
	</select>
	
	<select id="selectCommunityScheduleMenu"  parameterType="cmap" resultType="String">
		SELECT (SELECT SortPath FROM SYS_OBJECT_FOLDER WHERE FolderID = #{MemberOf})||(SUBSTR('000000000000000', 0, 15 - LENGTH(#{CU_ID}))||#{CU_ID})||';' FROM dual
	</select>
	
	<update id="updateCommunityMemberOperatorCode" parameterType="cmap">
		UPDATE COMMUNITY SET OperatorCode = #{userID}
		WHERE 1=1 
		AND CU_ID = #{CU_ID}
	</update> 
	
	<select id="communityMemberActivity" parameterType="cmap" resultType="cmap">
		 SELECT	CC.CU_ID AS "CU_ID"
				 , CC.UR_Code AS "UR_Code"
				 , CC.Visit_cnt AS "Visit_cnt"
				 , CC.MsgCount AS "MsgCount"
				 , CC.ViewCount AS "ViewCount"
				 , CC.CommentCnt AS "CommentCnt"
				 , CC.TotalPoint AS "TotalPoint" 
				 , CC.num AS "num"
				 , DECODE(num, 1, CC.CU_ID, DECODE(ROWNUM, 1, CC.CU_ID, ROWNUM * 0 ))AS "checkNum"
		 FROM (
			SELECT RANK() OVER ( PARTITION BY CU_ID ORDER BY TotalPoint DESC ) AS num
				 , BB.CU_ID
				 , BB.UR_Code
				 , NVL(BB.Visit_cnt,'0')AS Visit_cnt
				 , NVL(BB.MsgCount,'0')AS MsgCount
				 , NVL(BB.ViewCount,'0')AS ViewCount
				 , NVL(BB.CommentCnt,'0')AS CommentCnt
				 , NVL(BB.TotalPoint,'0')AS TotalPoint 
					
					FROM(	
						SELECT distinct AA.UR_Code, AA.CU_ID, AA.Visit_cnt,(AA.MsgCount+AA.surveyCnt) AS MsgCount, AA.ViewCount, AA.CommentCnt, ((AA.Visit_cnt*15)+(AA.MsgCount*30)+AA.ViewCount+(AA.CommentCnt*10)+(AA.surveyCnt*30))AS TotalPoint 
						FROM (
								SELECT	cm.CU_ID
										, cm.UR_Code
										, (SELECT COUNT(*) FROM COMMUNITY_VISIT WHERE CommunityID = cm.CU_ID AND UserCode = cm.UR_Code) AS Visit_cnt
										, NVL(A.MsgCount,'0') AS MsgCount
										, NVL(B.ViewCount,'0') AS ViewCount 
										, NVL(C.CommentCnt,'0') AS CommentCnt
										, NVL(E.surveyCnt,'0') AS surveyCnt
								FROM COMMUNITY_MEMBER cm
								LEFT OUTER JOIN (	SELECT c.CU_ID, cm.UR_Code, COUNT(*)AS MsgCount
													FROM BOARD_MESSAGE BM 
													INNER JOIN COMMUNITY_MEMBER cm ON cm.UR_Code = BM.CreatorCode 
													INNER JOIN COMMUNITY c ON c.CU_ID = cm.CU_ID 
													INNER JOIN SYS_OBJECT_FOLDER sof ON sof.FolderID = BM.FolderID AND sof.MenuID = cm.CU_ID
													AND BM.MsgState IN ('C', 'A') 
													AND MsgType != 'S' 
													AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= TO_DATE(#{localCurrentDate},'YYYY-MM-DD HH24:MI:SS'))
													AND BM.DeleteDate IS NULL GROUP BY c.CU_ID, cm.UR_Code ) A ON A.CU_ID = cm.CU_ID AND A.UR_Code = cm.UR_Code
								LEFT OUTER JOIN (	SELECT cm.CU_ID, cm.UR_Code, COUNT(*)AS ViewCount
													FROM BOARD_MESSAGE BM 
													INNER JOIN SYS_OBJECT_FOLDER sof ON sof.FolderID = BM.FolderID 
													INNER JOIN COMMUNITY_MEMBER cm ON  sof.MenuID = cm.CU_ID
													INNER JOIN BOARD_MESSAGE_READER bmr ON bmr.MessageID = BM.MessageID AND bmr.ReaderCode = cm.UR_Code
													AND BM.MsgState IN ('C', 'A') 
													AND MsgType != 'S' 
													AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= TO_DATE(#{localCurrentDate},'YYYY-MM-DD HH24:MI:SS'))
													AND BM.DeleteDate IS NULL GROUP BY cm.CU_ID, cm.UR_Code) B ON B.CU_ID = cm.CU_ID AND B.UR_Code = cm.UR_Code
								LEFT OUTER JOIN (	SELECT cm.CU_ID, cm.UR_Code, SUM((SELECT COUNT(*) FROM  SYS_COMMENT WHERE DeleteDate IS NULL AND TargetServiceType= 'Board' AND TargetID = BM.MessageID||'_'||BM.Version)) AS CommentCnt
													FROM BOARD_MESSAGE BM 
													INNER JOIN COMMUNITY_MEMBER cm ON cm.UR_Code = BM.CreatorCode
													INNER JOIN SYS_OBJECT_FOLDER sof ON sof.FolderID = BM.FolderID AND sof.MenuID = cm.CU_ID
													AND BM.MsgState IN ('C', 'A') 
													AND MsgType != 'S' 
													AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= TO_DATE(#{localCurrentDate},'YYYY-MM-DD HH24:MI:SS'))
													AND BM.DeleteDate IS NULL GROUP BY cm.CU_ID, cm.UR_Code ) C ON C.CU_ID = cm.CU_ID AND C.UR_Code = cm.UR_Code
								LEFT OUTER JOIN ( SELECT CommunityID, RegisterCode, COUNT(*)AS surveyCnt FROM SURVEY  WHERE 1=1 AND State IN ('F','G') GROUP BY CommunityID, RegisterCode) E ON E.CommunityID = cm.CU_ID AND  E.RegisterCode = cm.UR_Code
								ORDER BY cm.CU_ID ASC
							)AA
							ORDER BY CU_ID ASC, TotalPoint DESC
				)BB ORDER BY CU_ID ASC, num ASC, UR_Code ASC
			)CC
	</select>
	
	<update id="communityMemberActivityPoint" parameterType="cmap">
		UPDATE COMMUNITY_MEMBER SET	  MemberGrade = #{num}
									, MemberPoint = #{TotalPoint}
									, MsgCount = #{MsgCount}
									, ReplyCount = #{CommentCnt}
									, OneMsgCount = '0'
									, ViewCount = #{ViewCount}
									, VisitCount  = #{Visit_cnt}
		WHERE 1=1
		AND CU_ID = #{CU_ID}
		AND UR_Code = #{UR_Code}
	</update>
	
	<select id="communityActivity"  parameterType="cmap" resultType="cmap">
		 SELECT
					CC.CU_ID AS "CU_ID"
				 , CC.DN_ID AS "DN_ID"
				 , CC.Visit_cnt AS "Visit_cnt"
				 , CC.MsgCount AS "MsgCount"
				 , CC.ViewCount AS "ViewCount"
				 , CC.CommentCnt AS "CommentCnt"
				 , CC.MemberCount AS "MemberCount"
				 , CC.TotalPoint AS "TotalPoint" 
				 , CC.num AS "num"
				 , CC.CU_ID AS "checkNum"  
		 FROM (
				  SELECT RANK() OVER ( ORDER BY TotalPoint DESC ) AS num
				 , BB.CU_ID
				 , BB.DN_ID
				 , NVL(BB.Visit_cnt,'0') AS Visit_cnt
				 , NVL(BB.MsgCount,'0') AS MsgCount
				 , NVL(BB.ViewCount,'0') AS ViewCount
				 , NVL(BB.CommentCnt,'0') AS CommentCnt
				 , NVL(BB.MemberCount,'0') AS MemberCount
				 , NVL(BB.TotalPoint,'0') AS TotalPoint
				FROM (
						SELECT AA.CU_ID, AA.DN_ID, AA.Visit_cnt,(AA.MsgCount+AA.surveyCnt) AS MsgCount, AA.ViewCount, AA.CommentCnt,AA.MemberCount, ((AA.Visit_cnt*15)+(AA.MsgCount*30)+AA.ViewCount+(AA.CommentCnt*10)+(AA.MemberCount * 100)+(AA.surveyCnt*30))AS TotalPoint FROM (	
							SELECT  distinct cm.CU_ID
								  , F.DN_ID
								  , (SELECT COUNT(*) FROM COMMUNITY_VISIT WHERE CommunityID = cm.CU_ID ) AS Visit_cnt
								  , NVL(A.MsgCount,'0') AS MsgCount
								  , NVL(B.ViewCount,'0') AS ViewCount 
								  , NVL(C.CommentCnt,'0') AS CommentCnt
								  , NVL(D.MemberCount,'0') AS MemberCount
								  , NVL(E.surveyCnt,'0') AS surveyCnt
							FROM COMMUNITY_MEMBER cm
							LEFT OUTER JOIN (	SELECT c.CU_ID, COUNT(*)AS MsgCount
												FROM BOARD_MESSAGE BM 
												INNER JOIN COMMUNITY_MEMBER cm ON cm.UR_Code = BM.CreatorCode 
												INNER JOIN COMMUNITY c ON c.CU_ID = cm.CU_ID 
												INNER JOIN SYS_OBJECT_FOLDER sof ON sof.FolderID = BM.FolderID AND sof.MenuID = cm.CU_ID
												AND BM.MsgState IN ('C', 'A') 
												AND MsgType != 'S' 
												AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= TO_DATE(#{localCurrentDate},'YYYY-MM-DD HH24:MI:SS') ) 
												AND BM.DeleteDate IS NULL GROUP BY c.CU_ID ) A ON A.CU_ID = cm.CU_ID 
							LEFT OUTER JOIN (	SELECT cm.CU_ID, COUNT(*)AS ViewCount
												FROM BOARD_MESSAGE BM 
												INNER JOIN SYS_OBJECT_FOLDER sof ON sof.FolderID = BM.FolderID 
												INNER JOIN COMMUNITY_MEMBER cm ON  sof.MenuID = cm.CU_ID
												INNER JOIN BOARD_MESSAGE_READER bmr ON bmr.MessageID = BM.MessageID AND bmr.ReaderCode = cm.UR_Code
												AND BM.MsgState IN ('C', 'A') 
												AND MsgType != 'S' 
												AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= TO_DATE(#{localCurrentDate},'YYYY-MM-DD HH24:MI:SS') ) 
												AND BM.DeleteDate IS NULL GROUP BY cm.CU_ID) B ON B.CU_ID = cm.CU_ID 
							LEFT OUTER JOIN (	SELECT cm.CU_ID, COUNT(0) AS CommentCnt
												FROM BOARD_MESSAGE BM 
												INNER JOIN SYS_OBJECT_FOLDER sof ON sof.FolderID = BM.FolderID 
												INNER JOIN COMMUNITY_MEMBER cm ON sof.MenuID = cm.CU_ID
												AND BM.MsgState IN ('C', 'A') 
												AND MsgType != 'S' 
												AND (BM.ExpiredDate IS NULL OR BM.ExpiredDate >= TO_DATE(#{localCurrentDate}, 'YYYY-MM-DD HH24:MI:SS')) 
												AND BM.DeleteDate IS NULL
												INNER JOIN SYS_COMMENT SC ON SC.TargetID = BM.MessageID||'_'||BM.Version AND SC.DeleteDate IS NULL AND SC.TargetServiceType = 'Board'
												GROUP BY cm.CU_ID) C ON C.CU_ID = cm.CU_ID
							LEFT OUTER JOIN (	SELECT c.CU_ID,  COUNT(*)AS MemberCount
												FROM COMMUNITY c 
												INNER JOIN COMMUNITY_MEMBER cm ON cm.CU_ID = c.CU_ID
												WHERE 1=1
												AND cm.DetailStatus = 'RV'
												AND cm.MemberStatus = 'R'
												AND cm.MemberLevel != '0'
												GROUP BY c.CU_ID	) D ON D.CU_ID = cm.CU_ID 
							LEFT OUTER JOIN ( SELECT CommunityID, COUNT(*) AS surveyCnt FROM SURVEY WHERE 1=1 AND State IN ('F','G')  GROUP BY CommunityID) E ON E.CommunityID = cm.CU_ID
							LEFT OUTER JOIN community F ON F.CU_ID = cm.CU_ID
							ORDER BY cm.CU_ID ASC 
				)AA
				ORDER BY TotalPoint DESC
			)BB
			ORDER BY BB.TotalPoint DESC
		)CC
		ORDER BY DN_ID ASC, TotalPoint DESC
	</select>
	
	<update id="communityActivityPoint" parameterType="cmap">
		UPDATE COMMUNITY SET
			  Grade = #{num}
			, Point = #{TotalPoint}
			, MsgCount = #{MsgCount}
			, ReplyCount = #{CommentCnt}
			, OneMsgCount = '0'
			, ViewCount = #{ViewCount}
			, VisitCount  = #{Visit_cnt}
			, MemberCount = #{MemberCount}
		WHERE 1=1
		AND CU_ID = #{CU_ID}
	</update>
	
	<insert id="communityActivityPointHistory" parameterType="cmap">
		INSERT INTO COMMUNITY_LOG_GROUP_DAILY(
												 YYYYMMDD
												, CU_ID
												, MN_ID
												, MemberCount
												, MsgCount
												, ReplyCount
												, OneMsgCount
												, VisitCount
												, ViewCount
												, Point
												, Grade
												, Difference
											) VALUES (
												 TO_CHAR(SYSTIMESTAMP, 'YYYY-MM-DD')
												, #{CU_ID}
												, '0'
												, #{MemberCount}
												, #{MsgCount}
												, #{CommentCnt}
												, '0'
												, #{Visit_cnt}
												, #{ViewCount}
												, #{TotalPoint}
												, #{num}
												, NVL((SELECT MAX(gd.Point) - #{TotalPoint} FROM COMMUNITY_LOG_GROUP_DAILY gd WHERE 1=1 AND gd.CU_ID = #{CU_ID}),'0')
											)
	</insert>
	
	<insert id="communityMemberActivityPointHistory" parameterType="cmap">
		INSERT INTO COMMUNITY_LOG_USER_DAILY(
												  YYYYMMDD
												, CU_ID
												, UR_CODE
												, MsgCount
												, ReplyCount
												, OneMsgCount
												, VisitCount
												, ViewCount
												, Point
												, Grade
												, Difference
											)VALUES(
												  TO_CHAR(SYSDATE, 'YYYY-MM-DD')
												, #{CU_ID}
												, #{UR_Code}
												, #{MsgCount}
												, #{CommentCnt}
												, '0'
												, #{Visit_cnt}
												, #{ViewCount}
												, #{TotalPoint}
												, #{num}
												, NVL((SELECT MAX(gd.Point) - #{TotalPoint} FROM COMMUNITY_LOG_USER_DAILY gd WHERE 1=1 AND gd.CU_ID = #{CU_ID} AND gd.UR_CODE = #{UR_Code}),'0')
											)
	</insert>
	
	<update id="updateCommunityMember" parameterType="cmap">
		UPDATE COMMUNITY_MEMBER SET 
									 MemberStatus = 'R'
									, DetailStatus = 'RV'
									, MemberLevel = '9'
		WHERE 1=1
		AND CU_ID = #{CU_ID}
		AND UR_CODE = #{userID}
	</update>
	
	<select id="selectCommunityAlias" parameterType="cmap" resultType="String">
		SELECT CONCAT('Community',NVL(MAX(CU_ID),'0')+1)AS id FROM COMMUNITY 
	</select>
	
	<insert id="createCommunityWebPortal" parameterType="cmap" useGeneratedKeys="true">
		INSERT INTO PORTAL (
								  LayoutID
								, CompanyCode
								, DisplayName
								, PortalType
								, SortKey
								, IsUse
								, RegisterCode
								, RegistDate
								, BizSection
								, PortalTag
								, LayoutSizeTag
							)VALUES(
								  (SELECT LayoutID FROM PORTAL_LAYOUT WHERE 1=1 AND Reserved1 = 'Y' AND IsCommunity = 'Y' AND ROWNUM = 1)
								, (SELECT CU_Code FROM COMMUNITY WHERE CU_ID = #{CU_ID} )
								, #{txtCommunityName}
								, 'Community'
								, '1'
								, 'Y'
								, #{userID}
								, SYSDATE
								, 'Community'
								, #{PortalTag}
								, #{LayoutSizeTag}
							)
		<selectKey resultType="java.lang.Long" keyProperty="PortalID" order="AFTER">
			SELECT PORTAL_SEQ.CURRVAL FROM dual
		</selectKey>
	</insert>
	
	<select id="communityDefaultPortalList" parameterType="cmap" resultType="cmap">
		SELECT	  BizSection AS "BizSection"
				, RANGE AS "Range"
				, DisplayName AS "DisplayName"
				, HtmlFilePath AS "HtmlFilePath"
				, JsFilePath AS "JsFilePath"
				, JsModuleName AS "JsModuleName"
				, IsUse AS "IsUse"
				, Reserved1 AS "Reserved1"
				, Reserved2 AS "LayoutDivNumber"
				, Preview AS "Preview"
				, MinHeight AS "MinHeight"
				, DataJSON AS "DataJSON"
				, ExtentionJSON AS "ExtentionJSON"
				, ScriptMethod AS "ScriptMethod"
		FROM COMMUNITY_PORTAL_WEBPART_DEFAU 
		WHERE 1=1
		AND IsUse ='Y'
		ORDER BY Reserved ASC 
	</select>
	
	<insert id="createCommunityWebPart" parameterType="cmap" useGeneratedKeys="true">
		INSERT INTO PORTAL_WEBPART
		(
			  CompanyCode
			, BizSection
			, RANGE
			, DisplayName
			, HtmlFilePath
			, JsFilePath
			, JsModuleName
			, IsUse
			, Reserved1
			, RegisterCode
			, RegistDate
			, Preview
			, MinHeight
			, DataJSON
			, ExtentionJSON
			, ScriptMethod
		)VALUES(
			  (SELECT CU_Code FROM COMMUNITY WHERE CU_ID = #{CU_ID})
			, #{BizSection}
			, #{Range}
			, #{DisplayName}	
			, #{HtmlFilePath}
			, #{JsFilePath}
			, #{JsModuleName}
			, #{IsUse}	
			, #{Reserved1}
			, #{userID}
			, SYSDATE
			, #{Preview}
			, #{MinHeight}	
			, #{DataJSON}
			, #{ExtentionJSON}
			, #{ScriptMethod}
		)
		<selectKey resultType="java.lang.Long" keyProperty="WebpartID" order="AFTER">
			SELECT PORTAL_WEBPART_SEQ.CURRVAL FROM dual
		</selectKey>
	</insert>
	
	<insert id="createCommunityLayout"  parameterType="cmap">
		 INSERT INTO PORTAL_LAYOUT_WEBPART (
												  PortalID
												, WebpartID
												, LayoutDivNumber 
												, LayoutDivSort
												, WebpartOrder
												, RegistDate
											)VALUES(
												  #{PortalID}
												, #{WebpartID}	
												, NVL(#{LayoutDivNumber},'0')
												, '0'
												, '-1'
												, SYSDATE
											)
	</insert>
	
	<select id="selectCommunitySortDuplyCount" parameterType="cmap"  resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM COMMUNITY_CATEGORY 
		WHERE DN_ID = #{DN_ID}
		AND SortKey = #{SortKey}
		AND DeleteDate IS NULL
		<if test="CategoryID != null and CategoryID != '' and CategoryID != '0'">
			AND CategoryID != #{CategoryID}
		</if>
		<if test="FolderType != null and FolderType != ''">
			AND FolderType = #{FolderType}
		</if>
		<if test="MemberOf != null and MemberOf != ''">
			AND MemberOf = #{MemberOf}
		</if>
	</select>
	
	<select id="communityUserDomainList" parameterType="cmap" resultType="cmap">
		SELECT
			SOD.DomainID AS "DomainID"
		FROM SYS_OBJECT_USER SOU
		INNER JOIN SYS_OBJECT_USER_BASEGROUP SOUBG ON (SOUBG.UserCode = SOU.UserCode)
		INNER JOIN SYS_OBJECT_DOMAIN SOD ON SOD.DomainCode  = SOUBG.CompanyCode
		WHERE SOU.UserCode = #{UR_Code}
		AND SOD.DomainID IS NOT NULL
	</select>
	
	<select id="insertCommunityGroupMemberCount" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*) 
		FROM SYS_OBJECT_GROUP_MEMBER
		WHERE 1=1
		AND GroupCode = (SELECT CU_Code FROM COMMUNITY WHERE CU_ID = #{CU_ID})
		AND UserCode = #{UR_Code}
	</select>
	
	<insert id="insertCommunityGroupMemberMasterGrade"  parameterType="cmap" >
		INSERT INTO sys_object_group_member
		(
			GroupCode,
			UserCode,
			SortKey,
			Role,
			IsUse,
			IsHR,
			MemberStatus
		) VALUES (
			(SELECT sog.GroupCode FROM community c INNER JOIN sys_object_group sog on c.CU_Code = sog.MemberOf WHERE sog.Reserved6 = 9 AND sog.MemberOf IN (SELECT CU_Code FROM (SELECT CU_Code FROM community WHERE CU_ID = #{CU_ID}) B)),
			#{UR_Code},
			200,
			'member',
			'Y',
			'N',
			'A'
		)
	</insert>
	
	<delete id="DelCommunityFavorite" parameterType="cmap">
		DELETE FROM community_favorite WHERE CU_ID = #{CU_ID}
	</delete>
	
	<select id="getCommunityName"  parameterType="cmap" resultType="String">
		SELECT CommunityName FROM community WHERE CU_ID = #{CU_ID}
	</select>
	
	<select id="sendMessagingSettingUserCode"  parameterType="cmap" resultType="String">
		SELECT
			CM.UR_Code AS UserCode
		FROM COMMUNITY C
		INNER JOIN COMMUNITY_MEMBER CM ON C.CU_ID = CM.CU_ID AND CM.MemberLevel = 9
		WHERE C.CU_ID = #{CU_ID}
	</select>
	
	<insert id="insertCommunityGroupMember"  parameterType="cmap">
		INSERT INTO SYS_OBJECT_GROUP_MEMBER
		(
			GroupCode,
			UserCode,
			SortKey,
			Role,
			IsUse,
			IsHR,
			MemberStatus
		) VALUES (
			(SELECT CU_Code FROM COMMUNITY WHERE CU_ID = #{CU_ID}),
			#{UR_Code},
			200,
			'member',
			'Y',
			'N',
			'A'
		)
	</insert>
	
	<select id="sendMessagingList"  parameterType="cmap" resultType="cmap">
		SELECT
			  sms.UserCode AS "UserCode"
			, sbc.Code AS "Code"
			, NVL(Fn_GetSelDictionary(#{lang}, 'CU_'||c.CU_ID, c.DN_ID), c.CommunityName) AS "CommunityName"
			, #{CU_ID} AS "CU_ID"
		FROM COMMUNITY c
		INNER JOIN COMMUNITY_MEMBER cm ON c.CU_ID = cm.CU_ID AND cm.UR_Code = #{UR_Code}
		INNER JOIN SYS_MESSAGING_SETTING sms ON cm.UR_Code = sms.UserCode
		INNER JOIN SYS_BASE_CODE sbc ON sbc.BizSection = 'Community' AND sbc.CodeGroup = 'TodoMsgType' AND sbc.Code = sms.ServiceType
		WHERE 1=1
		AND c.CU_ID = #{CU_ID}
		AND sbc.IsUse = 'Y'
		AND sbc.Code = #{Code}
	</select>
	
	<select id="sendMessagingListAdmin" parameterType="cmap" resultType="cmap">
		SELECT 
			  DISTINCT(UserCode) AS "UserCode"
			, #{Code} AS "Code"
			, #{CU_ID} AS "CU_ID"
			, (SELECT NVL(Fn_GetSelDictionary(#{lang}, 'CU_'||CU_ID, DN_ID), CommunityName) FROM COMMUNITY WHERE CU_ID = #{CU_ID}) AS "CommunityName"
		FROM SYS_OBJECT_GROUP_MEMBER 
		WHERE GroupCode IN (
			SELECT SubjectCode
			FROM SYS_OBJECT_ACL 
			WHERE 1=1
			AND ObjecTtype = 'MN'
			AND ObjectID = (
				SELECT MenuID
				FROM SYS_OBJECT_MENU
				WHERE 1=1
				AND BizSection = 'Community'
				AND IsAdmin = 'Y'
				AND MenuType = 'TopSub'
			)
		) 
	</select>
	
	<insert id="sendMessaging" parameterType="cmap" >
		INSERT INTO SYS_ALARM_LIST
		(
			  UserCode
			, Category
			, MsgType
			, Title
			, URL
			, Message
			, OpenType
			, ObjectID
			, ObjectType
			, IsPush
			, PusherCode
			, ReceivedDate
			, IsRead
		)VALUES(
			  #{UserCode}
			, #{Category}
			, #{Code}
			, #{Title}
			, #{URL}
			, #{Message}
			, 'PAGEMOVE'
			, #{CU_ID}
			, #{ObjectType}
			, #{IsPush}
			, #{PusherCode}
			, SYSDATE
			, #{IsRead}
		)
	</insert>
	
	<select id="selectUserAllPwChange" parameterType="cmap"  resultType="cmap">
		SELECT UserCode AS "UserCode"
			 , MailAddress AS "MailAddress"
			 , REPLACE(Mobile, '-', '') AS "Mobile"
		FROM SYS_OBJECT_USER 
		WHERE Mobile IS NOT NULL
	</select>
	
	<update id="UserAllPwChange" parameterType="cmap" >
		UPDATE SYS_OBJECT_USER SET LogonPassword = CRYPTO.ENC_AES128(#{Mobile},#{key})
		WHERE UserCode = #{UserCode}
	</update>
	
	<select id="selectCommunityGradeList" parameterType="cmap" resultType="cmap">
		SELECT	  CodeID AS "CodeID"
				, CodeName AS "CodeName"
				, Code AS "Code"
		FROM SYS_BASE_CODE sbc
		WHERE 1=1
		AND BizSection = 'Community'
		AND CodeGroup = 'CuMemberLevel'
		AND Code != 'CuMemberLevel'
		AND DomainID = (SELECT NVL(MAX(DomainID), 0) FROM SYS_BASE_CODE WHERE BizSection = 'Community' AND Code = sbc.Code AND CodeGroup = 'CuMemberLevel' AND DomainID = #{domainID})
	</select>
	
	<select id="selectCommunityGroupSubCnt" parameterType="cmap" resultType="java.lang.Long">
		SELECT COUNT(*)
		FROM SYS_OBJECT_GROUP
		WHERE GroupCode LIKE ('CommunityGrade'||#{CU_ID}||'/_%') ESCAPE '/'
	</select>
	
	<insert id="createObjectGroupSub"  parameterType="cmap">
		INSERT INTO sys_object_group
		(
			GroupCode,
			CompanyCode,
			GroupType,
			MemberOf,
			OUName,
			DisplayName,
			MultiDisplayName,
			ShortName,
			MultiShortName,
			Approvable,
			Receivable,
			SortKey,
			IsUse,
			IsDisplay,
			IsMail,
			IsHR,
			RegistDate,
			Description,
			Reserved6
		) VALUES (
			CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}),
			#{DomainCode},
			'Community',
			#{CU_Code},
			#{GradeName},
			#{GradeName},
			#{GradeName},
			#{GradeName},
			#{GradeName},
			1,
			1,
			(SELECT (SELECT SortKey FROM (SELECT NVL(MAX(SortKey), '0') AS SortKey FROM sys_object_group WHERE GroupType = 'Community' AND MemberOf = #{CU_Code}) B) + 1 FROM dual),
			'Y',
			'Y',
			'Y',
			'Y',
			SYSDATE,
			'',
			#{GradeCode}
		)
	</insert>
	
	<select id="selectObjectGroupInfo" parameterType="cmap" resultType="cmap">
		SELECT
				Fn_ComObjectPathCreate_S(0, (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) B),'GR') AS "GroupPath"
			 , Fn_ComSortPathCreate_S(0, (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) B), 'GR') AS "SortPath"
			 , (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) B)  AS "ApprovalUnitCode"
			 , (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) B) AS "ReceiptUnitCode"
		FROM dual 
	</select>
	
	<update id="updateObjectGroupSub" parameterType="cmap">
		UPDATE sys_object_group SET
				  GroupPath = #{GroupPath}
				, SortPath =  #{SortPath}
				, ApprovalUnitCode = #{ApprovalUnitCode}
				, ReceiptUnitCode = #{ReceiptUnitCode}
		WHERE 1=1
		AND GroupCode IN (select Code FROM (select CONCAT(CONCAT(CONCAT('CommunityGrade', #{CU_ID}), '_'), #{GradeCode}) AS Code FROM dual) B)
	</update> 
	
	<select id="sendMessagingCommunityOperator" parameterType="cmap" resultType="cmap">
		SELECT cm.UR_Code AS "UserCode"
			 , sbc.Code AS "Code"
			 , NVL(FN_GETSELDICTIONARY(#{lang}, 'CU_'||c.CU_ID, c.DN_ID), c.CommunityName) AS "CommunityName"
			 , #{CU_ID} AS "CU_ID"
		FROM community c
		INNER JOIN community_member cm ON c.CU_ID = cm.CU_ID AND cm.MemberLevel = 9
		INNER JOIN sys_messaging_setting sms ON cm.UR_Code = sms.UserCode
		INNER JOIN sys_base_code sbc ON sbc.BizSection = 'Community' AND sbc.CodeGroup = 'TodoMsgType' AND sbc.Code = sms.ServiceType
		WHERE 1=1
		AND c.CU_ID = #{CU_ID}
		AND sbc.IsUse = 'Y'
		AND sbc.Code = #{Code}
	</select> 
	
	<select id="communityOperationList"  parameterType="cmap" resultType="cmap">
		SELECT DISTINCT  A.CU_ID AS "CU_ID"
			, A.DN_ID AS "DN_ID"
			, A.CommunityName AS "CommunityName"
			, A.MailAddress  AS "MailAddress"
			, A.OperatorCode AS "OperatorCode"
		FROM (
			SELECT  (SELECT DomainID FROM sys_object_domain WHERE DomainCode = SOUBG.CompanyCode) AS DN_ID
				  , C.CommunityName
				  , SOU.MailAddress
				  , C.CU_ID
				  , C.OperatorCode
			FROM community C
			INNER JOIN sys_object_user SOU ON SOU.UserCode = C.OperatorCode
			INNER JOIN sys_object_user_basegroup SOUBG ON (SOUBG.UserCode = SOU.UserCode)
			WHERE 1=1
			AND C.OperatorCode is not null
			AND C.RegStatus != 'U'
			AND SOU.MailAddress IS NOT NULL
		) A 
	</select>
	
	<insert id="todoSendMessage" parameterType="cmap">
		INSERT INTO SYS_ALARM_LIST
		(
			  UserCode
			, Category
			, MsgType
			, Title
			, URL
			, Message
			, OpenType
			, ObjectID
			, ObjectType
			, IsPush
			, PusherCode
			, ReceivedDate
			, IsRead
		)VALUES(
			  #{OpUR_Code}
			, 'Community'
			, 'CommunityAlarm'
			, #{Title}
			, ''
			, #{Message}
			, ''
			, '0'
			, ''
			, 'Y'
			, #{userID}
			, SYSDATE
			, 'N'
		)
	</insert>
	
	<select id="maxID" parameterType="cmap" resultType="String">
		SELECT CONCAT('Community', (SELECT MAXCUID FROM (SELECT NVL(MAX(CU_ID),'0') AS MAXCUID FROM COMMUNITY) B) + 1) FROM dual
	</select>
</mapper>
