<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="collab.project">
	<sql id="searchMyTask">
		<!--내용 검색 -->
		<if test="searchOption != null and  searchOption !=''">
			<if test="searchOption eq '1'.toString() and searchWord != '' and searchWord != ''">
				AND B.TASKNAME LIKE '%' || #{searchWord} || '%'
			</if>
			<if test="searchOption eq '2'.toString() and searchWord != '' and searchWord != ''">
				AND B.REMARK LIKE '%' || #{searchWord} || '%'
			</if>
			<if test="searchOption eq '3'.toString() and searchWord != '' and searchWord != ''">
				AND (B.TaskName LIKE '%' || #{searchWord} || '%' OR B.Remark LIKE '%' || #{searchWord} || '%'
				 OR B.TASKSEQ IN (SELECT TaskSeq FROM COLLAB_TASK_TAG t WHERE b.taskseq = b.taskseq AND t.tagName LIKE '%' || #{searchWord} || '%'))
			</if>
			<if test="searchOption eq '4'.toString() and searchWord != '' and searchWord != ''">
			    AND B.TASKSEQ IN (SELECT TaskSeq FROM COLLAB_TASK_TAG t WHERE b.taskseq = b.taskseq AND t.tagName LIKE '%' || #{searchWord} || '%')
			</if>
		</if>
		<if test="searchText != null and  searchText !=''">
			AND (B.TASKNAME LIKE '%' || #{searchText} || '%'
			 OR B.REMARK LIKE '%' || #{searchText} || '%'
			 OR B.TASKSEQ IN (SELECT TaskSeq FROM COLLAB_TASK_TAG t WHERE b.taskseq = b.taskseq AND t.tagName LIKE  '%' || #{searchText} || '%'))
		</if>
		<!--기간 검색 -->
		<if test="date1 != null and date1 !='' and date2 != null and date2 !=''">
			<![CDATA[
			AND ((#{date1} <=  B.EndDate AND #{date2}  >= B.StartDate) OR (#{date1}  <= B.EndDate AND #{date2} >= B.EndDate) OR (B.StartDate <= #{date2} AND B.EndDate >= #{date2}))
			]]>
		</if>
		<!-- 파일검색 -->
		<if test="searchFile != null and  searchFile !=''">
			AND f.FileName LIKE '%'|| #{searchFile}|| '%' 
		</if>
		<!-- 결재검색 -->
		<if test="searchApproval != null and  searchApproval !=''">
			AND TaskName LIKE '%'|| #{searchApproval}|| '%' 
		</if>
		<!-- 설문검색 -->
		<if test="searchSurvey != null and  searchSurvey !=''">
			AND Subject LIKE '%'|| #{searchSurvey}|| '%' 
		</if>
		<!--진행률 검색 -->
		<if test="rate1 != '' and rate1 != null or rate2 != '' and rate2 != null">
			<if test="rate1 != null and rate1 > 0 and rate2 != null and rate2 > 0 ">
				AND B.ProgRate BETWEEN #{rate1} AND #{rate2}
			</if>
			<if test="rate1 == 0 and rate2 > 0">
				AND B.ProgRate BETWEEN 0 AND #{rate2}
			</if>
		</if>
		<if test="objectType != '' and objectType != null" >
			AND b.objectType = #{objectType}
		</if>
		<!--태그 검색-->
		<if test="tagtype != '' and tagtype != 'CTAG'">
			<trim prefix="AND" prefixOverrides="AND |OR">
			${tagData}
			</trim>
		</if>
		<if test="tagtype eq 'CTAG'">
			AND a.TaskSeq in (SELECT TaskSeq FROM COLLAB_TASK_TAG d WHERE a.TaskSeq = d.taskSeq AND d.tagName = #{tagval})
		</if>
		<if test="completMonth != null and  completMonth !=''">
			AND ((TaskStatus = 'C' AND B.EndDate > TO_CHAR(ADD_MONTHS(SYSDATE, #{completMonth} * -1),  'YYYYMMDD')
					OR TaskStatus!='C')) 
		</if>
		<if test='noEndDate == "Y"'>
			AND b.EndDate is null
		</if>
		<if test="taskStatus != null and  taskStatus !=''">
			AND TaskStatus = #{taskStatus}
		</if>
		<if test="sectionSeq != null and  sectionSeq !=''">
			AND SectionSeq = #{sectionSeq}
		</if>
		<if test="memberId != null and  memberId !=''">
			<if test="memberId == 'NONE'">
				AND A.UserCode is null
			</if>
			<if test="memberId != 'NONE'">
				AND A.UserCode = #{memberId}
			</if>			
		</if>
		<!-- 끝-->
	</sql>
	

	<!--  프로젝트 조회-->
	<select id="getProject"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProject */
		SELECT PRJSEQ AS "PrjSeq"
			, PRJNAME AS "PrjName"
			, STARTDATE AS "StartDate"
			, ENDDATE AS "EndDate"
			, PRJSTATUS AS "PrjStatus"
			, PRJCOLOR AS "PrjColor"
			, PROGRATE AS "ProgRate"
			, NVL(REMARK,' ') AS "Remark"
			, REGISTERCODE AS "RegisterCode"
			, REGISTEDATE AS "RegisteDate"
			, MODIFIERCODE AS "ModifierCode"
			, MODIFYDATE AS "ModifyDate"
			,'P' AS "PrjType"
			, roomId as "RoomId"
			,(SELECT Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) FROM  SYS_OBJECT_USER sou where sou.userCode = p.RegisterCode) as "RegisterName"
			, NVL((SELECT COUNT(*) FROM COLLAB_PROJECT_FAVORITE WHERE p.PrjSeq = PrjSeq AND UserCode = #{USERID}),0) "IsFav"
		  FROM COLLAB_PROJECT p
		 WHERE prjSeq =  #{prjSeq}
	</select>

	<!--  팀 조회-->
	<select id="getTeam"   parameterType="cmap" resultType="cmap">
	/* collab.project.getTeam */
	 	SELECT GroupId as "PrjSeq"
		 	, FN_BASEGETDICTIONARY_S(#{lang}, MULTIDISPLAYNAME) as "PrjName"
		 	,'T' as "PrjType"
			, ManagerCode as "ManagerCode"
	      FROM SYS_OBJECT_GROUP sg 
	     WHERE sg.GroupId=  #{prjSeq}
	</select>

	<!--  프로젝트 상태 -->	
	<select id="getProjectStat"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectStat */
		SELECT
			T.TOTCNT AS "TotCnt", T.DELAYCNT AS "DelayCnt", T.EMGCNT AS "EmgCnt",
			T.LVLHCNT AS "LvlHCnt", T.LVLMCNT AS "LvlMCnt", T.LVlLCNT AS "LvlLCnt",
			T.WAITCNT AS "WaitCnt", T.PROCCNT AS "ProcCnt", T.HOLDCNT AS "HoldCnt",
			T.COMPCNT AS "CompCnt", T.NOWCOMPCNT AS "NowCompCnt", T.NOWTOTCNT AS "NowTotCnt",
			(CASE WHEN T.TOTCNT = 0 THEN 0 ELSE ROUND(T.COMPCNT/T.TOTCNT, 3) END) AS "ProjRate"
		FROM (
			<![CDATA[
			SELECT COUNT(*) AS TOTCNT
				, NVL(SUM(CASE WHEN b.TaskStatus != 'C' AND (b.EndDate is null or b.EndDate <  TO_CHAR(SYSDATE,'YYYYMMDD'))  then 1 ELSE 0 END),0) AS DELAYCNT
				, NVL(SUM(CASE WHEN b.Label = 'E' then 1 ELSE 0 END),0) AS EMGCNT
				, NVL(SUM(CASE WHEN b.ImpLevel = 'H' then 1 ELSE 0 END),0) AS LVLHCNT
				, NVL(SUM(CASE WHEN b.ImpLevel = 'M' then 1 ELSE 0 END),0) AS LVLMCNT
				, NVL(SUM(CASE WHEN b.ImpLevel = 'L' then 1 ELSE 0 END),0) AS LVlLCNT
				, NVL(SUM(CASE WHEN b.TaskStatus = 'W' then 1 ELSE 0 END),0) AS WAITCNT
				, NVL(SUM(CASE WHEN b.TaskStatus = 'P' then 1 ELSE 0 END),0) AS PROCCNT
				, NVL(SUM(CASE WHEN b.TaskStatus = 'H' then 1 ELSE 0 END),0) AS HOLDCNT
				, NVL(SUM(CASE WHEN b.TaskStatus = 'C' then 1 ELSE 0 END),0) AS COMPCNT
				, NVL(SUM(case when (b.EndDate is null or b.EndDate <=  TO_CHAR(SYSDATE,'YYYYMMDD'))  and b.TaskStatus = 'C' then 1 ELSE 0 END),0) AS NOWCOMPCNT
				, NVL(SUM(case when b.EndDate is null or b.EndDate <=  TO_CHAR(SYSDATE,'YYYYMMDD') then 1 ELSE 0 END),0) AS NOWTOTCNT
			 FROM COLLAB_TASK_MAP a 
			 JOIN COLLAB_TASK b ON a.TASKSEQ = b.TASKSEQ
			WHERE a.PRJTYPE = #{prjType}
			  AND  a.PRJSEQ = #{prjSeq}
			  AND b.parentkey=0
			]]>
		) T
	</select>

	<select id="getTeamMember"   parameterType="cmap" resultType="cmap">
	/* collab.project.getTeamMember */
		SELECT soub.USERCODE AS "UserCode"
				,Fn_BaseGetDictionary_S(#{lang},soub.MultiDeptName) AS "DeptName"
				,Fn_BaseGetDictionary_S(#{lang},soub.MultiJobPositionName) AS "JobPositionName"
				,Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) AS "DisplayName"
		  FROM SYS_OBJECT_GROUP sb 
	      JOIN SYS_OBJECT_USER_BASEGROUP soub ON sb.GroupCode = soub.DeptCode 
	      JOIN SYS_OBJECT_USER sou on sou.UserCode = soub.UserCode 
	     WHERE 	     
	     <if test="groupPath != null and  groupPath !=''">
	     	sb.GroupPath=      #{groupPath}
	     </if>
	     <if test="groupPath == null or groupPath ==''">
	     	sb.GroupId=      #{prjSeq}
	     </if>
	     <if test="searchText != null and  searchText !=''">
	     	AND sou.MultiDisplayName like '%'|| #{searchText}||'%'
	     </if>
		AND    sou.IsUse = 'Y'
		AND    sou.IsDisplay = 'Y'
      ORDER BY soub.JobTitleSortKey, soub.JobPositionSortKey, sou.MultiDisplayName
	</select>
	
	<insert id="addProject"   parameterType="cmap" useGeneratedKeys="true">
	/* collab.project.addProject */
		INSERT INTO COLLAB_PROJECT 
					( prjSeq, prjName , CompanyCode , StartDate, EndDate, PrjStatus, ProgRate, PrjColor, Remark, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
		VALUES		( COLLAB_PROJECT_SEQ.NEXTVAL, #{prjName},#{CompanyCode}, #{startDate}, #{endDate}, #{prjStatus}, #{progRate}, #{prjColor}, #{remark},#{USERID}, SYSDATE, #{USERID}, SYSDATE)
	   <selectKey keyProperty="PrjSeq" resultType="Integer" order="AFTER">
		    SELECT COLLAB_PROJECT_SEQ.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	
	<insert id="saveProject"   parameterType="cmap">
	/* collab.project.saveProject */
		UPDATE COLLAB_PROJECT
		   SET prjName =  #{prjName}
		       ,StartDate=  #{startDate}
               ,EndDate=  #{endDate}
               ,PrjStatus=  #{prjStatus}
               ,ProgRate=  case when #{progRate} = 'C' then '100' else #{progRate} end
               ,PrjColor=  #{prjColor}
               ,Remark=  #{remark}
               ,ModifierCode=  #{USERID}
               ,ModifyDate=  SYSDATE
		 WHERE prjSeq =  #{prjSeq}
	</insert>

	<delete id="deleteProject"   parameterType="cmap">
	/* collab.project.deleteProject */
		DELETE FROM COLLAB_PROJECT WHERE prjSeq =  #{prjSeq}
	</delete>

	<select id="getProjectMileList"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectMileList */
		SELECT m.PrjSeq as "PrjSeq"
			, m.TaskSeq as "TaskSeq"
			, m.PrjType as "PrjType"
			, t.TaskName as "TaskName"
			, t.EndDate as "EndDate"
			, t.TaskStatus as "TaskStatus"
			, s.SectionSeq as "SectionSeq"
			, s.SectionName as "SectionName"
			,(SELECT
					LISTAGG(ctm.UserCode || '^' || Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) || '^' || sou.PhotoPath || '^' || bg.DeptName, '|') WITHIN GROUP(ORDER BY ctm.UserCode) 
					FROM COLLAB_TASK_MEMBER ctm 
				   JOIN SYS_OBJECT_USER sou on ctm.userCode = sou.userCode
				   JOIN SYS_OBJECT_USER_BASEGROUP bg ON bg.UserCode = sou.UserCode AND bg.JobType = 'Origin'
					WHERE ctm.taskSeq = m.TaskSeq) as "tmUser"
		FROM COLLAB_TASK_MAP m 
		LEFT JOIN COLLAB_SECTION s ON m.SectionSeq = s.SectionSeq
		LEFT JOIN COLLAB_TASK t ON t.TaskSeq = m.TaskSeq 
		WHERE m.prjSeq = #{prjSeq}
			AND t.IsMile = 'Y'
	</select>

	<select id="getProjectUserForm"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectUserForm */
		SELECT OPTIONTITLE AS "OptionTitle"
			, OPTIONTYPE AS "OptionType"
			, OPTIONVAL AS "OptionVal"
		  FROM COLLAB_PROJECT_USERFORM 
		 WHERE prjSeq =  #{prjSeq}
	</select>
	
	<insert id="addProjectUserForm"   parameterType="cmap">
	/* collab.project.addProjectUserForm */
	BEGIN
		<foreach collection="userFormList" item="form" open="" close=";" separator=";">
		INSERT INTO COLLAB_PROJECT_USERFORM
					(PRJUSERFORMSEQ, prjSeq, optionTitle, optionType, optionVal, sortKey, RegisterCode, RegisteDate, ModifierCode, ModifyDate )
			 VALUES (COLLAB_PROJECT_USERFORM_SEQ.NEXTVAL, #{prjSeq}, #{form.optionTitle}, #{form.optionType} ,  #{form.optionVal}, #{form.sortKey},#{USERID}, SYSDATE, #{USERID}, SYSDATE)
		</foreach>	 
	END;
	</insert>


	<delete id="deleteProjectUserForm"   parameterType="cmap">
	/* collab.project.deleteProjectUserForm */
		DELETE FROM COLLAB_PROJECT_USERFORM WHERE prjSeq =  #{prjSeq}
	</delete>

	<select id="getProjectMember"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectMember */
		SELECT cpm.USERCODE AS "UserCode"
				,FN_BASEGETDICTIONARY_S(#{lang},soub.MULTIDEPTNAME) AS "DeptName"
				,FN_BASEGETDICTIONARY_S(#{lang},soub.MULTIJOBPOSITIONNAME) AS "JobPositionName"
				,FN_BASEGETDICTIONARY_S(#{lang},sou.MULTIDISPLAYNAME) AS "DisplayName"
				,sou.PHOTOPATH AS "PhotoPath"
		        ,sou.UserID as "UserID"
		  FROM COLLAB_PROJECT_MEMBER cpm 
		  JOIN SYS_OBJECT_USER sou on cpm.userCode = sou.userCode
		  JOIN SYS_OBJECT_USER_BASEGROUP soub		ON sou.UserCode = soub.UserCode  AND soub.JobType ='Origin'
		 WHERE cpm.prjSeq =  #{prjSeq}
      ORDER BY soub.JobTitleSortKey, soub.JobPositionSortKey, sou.MULTIDISPLAYNAME
	</select>
	
	<insert id="addProjectMember"   parameterType="cmap">
	/* collab.project.addProjectMember */
	BEGIN
		<foreach collection="memberList" item="user" open="" close=";" separator=";">
		 MERGE INTO  COLLAB_PROJECT_MEMBER a
			  USING  dual
			  	ON (prjSeq = #{prjSeq} AND userCode = #{user.userCode})
	   WHEN MATCHED THEN  
	        UPDATE SET
			         a.RegisterCode   = #{USERID} 
					 ,a.RegisteDate   = SYSDATE 
	   WHEN NOT MATCHED THEN
	      INSERT    (prjSeq, userCode ,RegisterCode, RegisteDate)
		  VALUES	( #{prjSeq}, #{user.userCode}, #{USERID}, SYSDATE)
		</foreach>   
	END;
	</insert>

	<delete id="deleteProjectMember"   parameterType="cmap">
	/* collab.project.deleteProjectMember */
		DELETE FROM COLLAB_PROJECT_MEMBER WHERE prjSeq =  #{prjSeq}
	</delete>

	<select id="getProjectManager"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectManager */
		SELECT cpm.USERCODE AS "UserCode"
				,FN_BASEGETDICTIONARY_S(#{lang},soub.MultiDeptName) AS "DeptName"
				,FN_BASEGETDICTIONARY_S(#{lang},soub.MultiJobPositionName) AS "JobPositionName"
				,FN_BASEGETDICTIONARY_S(#{lang},sou.MultiDisplayName) AS "DisplayName"
				,sou.PHOTOPATH AS "PhotoPath"
		        ,sou.UserID as "UserID"
		  FROM COLLAB_PROJECT_MANAGER cpm 
		  JOIN SYS_OBJECT_USER sou on cpm.userCode = sou.userCode
		  JOIN SYS_OBJECT_USER_BASEGROUP soub		ON sou.UserCode = soub.UserCode  AND soub.JobType ='Origin'
		 WHERE cpm.prjSeq =  #{prjSeq}
	</select>


	<insert id="addProjectManager"   parameterType="cmap">
	/* collab.project.addProjectManager */
	BEGIN
		<foreach collection="managerList" item="user" open="" close=";" separator=";">
		 MERGE INTO  COLLAB_PROJECT_MANAGER a
		USING DUAL
			ON (prjSeq = #{prjSeq} AND userCode = #{user.userCode})
	   WHEN MATCHED THEN  
	      UPDATE SET
			         a.RegisterCode   = #{USERID} 
					 ,a.RegisteDate   = SYSDATE 
	   WHEN NOT MATCHED THEN
	      INSERT    (prjSeq, userCode, RegisterCode, RegisteDate)
		  VALUES	( #{prjSeq},  #{user.userCode}, #{USERID}, SYSDATE)
		</foreach>    
	END; 
	</insert>

	<delete id="deleteProjectManager"   parameterType="cmap">
	/* collab.project.deleteProjectManager */
		DELETE FROM COLLAB_PROJECT_MANAGER WHERE prjSeq =  #{prjSeq}
	</delete>

	<select id="getProjectViewer"   parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectViewer */
		SELECT cpv.UserCode "UserCode"
				,Fn_BaseGetDictionary_S(#{lang},soub.MultiDeptName) "DeptName"
				,Fn_BaseGetDictionary_S(#{lang},soub.MultiJobPositionName) "JobPositionName"
				,Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) "DisplayName"
				,sou.PhotoPath "PhotoPath"
		        ,sou.UserID as "UserID"
		  FROM collab_project_viewer cpv 
		  JOIN sys_object_user sou on cpv.userCode = sou.userCode
		  JOIN sys_object_user_basegroup soub		ON sou.UserCode = soub.UserCode  AND soub.JobType ='Origin'
		 WHERE cpv.prjSeq =  #{prjSeq}
	</select>


	<insert id="addProjectViewer"   parameterType="cmap">
	/* collab.project.addProjectViewer*/
	BEGIN
		<foreach collection="viewerList" item="user" open="" close=";" separator=";">
		 MERGE INTO  COLLAB_PROJECT_VIEWER a
		USING DUAL
			ON (prjSeq = #{prjSeq} AND userCode = #{user.userCode})
	   WHEN MATCHED THEN  
	      UPDATE SET
			         a.RegisterCode   = #{USERID} 
					 ,a.RegisteDate   = SYSDATE 
	   WHEN NOT MATCHED THEN
	      INSERT    (prjSeq, userCode, RegisterCode, RegisteDate)
		  VALUES	( #{prjSeq},  #{user.userCode}, #{USERID}, SYSDATE)
		</foreach>    
	END;  
	</insert>
	
	<delete id="deleteProjectViewer"   parameterType="cmap">
	/* collab.project.deleteProjectViewer */
		DELETE FROM collab_project_viewer WHERE prjSeq =  #{prjSeq}
	</delete>


	<select id="getExistsProjectSection"   parameterType="cmap" resultType= "java.lang.Long" >
	/* collab.project.getExistsProjectSection */
		SELECT COUNT(*)
		  FROM COLLAB_SECTION
		 WHERE prjSeq  = #{prjSeq}
		   AND prjType = #{prjType}
		   
		 <if test="sectionName != '' and sectionName != null" >
		   AND SectionName = #{sectionName}
		 </if>
	</select>
	
	<select id="getProjectSection"   parameterType="cmap"  resultType="cmap">
	/* collab.project.getProjectSection */
		SELECT 
			SECTIONSEQ AS "SectionSeq"
			, SECTIONNAME AS "SectionName"
		FROM COLLAB_SECTION 
		<if test="prjSeq != null and prjSeq != '' and prjType != null and prjType != ''">
			WHERE PrJSeq = #{prjSeq}
			   AND PrjType = #{prjType}
		</if>
		ORDER BY SectionOrder ASC
	</select>
	
	<select id="getProjectSectionSeq"   parameterType="cmap"  resultType="cmap">
	/* collab.project.getProjectSectionSeq */
		SELECT * FROM (
			SELECT SECTIONSEQ as "SectionSeq"
			  FROM COLLAB_SECTION 
			 WHERE PrJSeq = #{prjSeq}
			   AND PrjType = #{prjType}
			ORDER BY SectionOrder ASC
		)
		WHERE ROWNUM = 1
	</select>
	
	<select id="getProjectTask" parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectTask */
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingHeader" />
		</if>
		
		<![CDATA[
		SELECT b.TASKSEQ AS "TaskSeq"
			,NVL((SELECT COUNT(*) FROM COLLAB_TASK pt WHERE pt.ParentKey = b.TaskSeq AND pt.ParentKey > 0),0) AS "PCnt"
			,NVL((SELECT COUNT(*) FROM SYS_COMMENT sc WHERE sc.TargetServiceType='Collab' AND 	sc.TargetId = to_char(b.TaskSeq) AND DELETEDATE IS NULL),0) AS "CommentCnt"
			, A.USERCODE AS "UserCode"
			, A.LIKEFLAG AS "LikeFlag"
			, A.TODOORDER AS "Todoorder"
			, B.TASKNAME AS "TaskName"
			, B.REMARK AS "Remark"
			, B.LABEL AS "Label"
			, B.ImpLevel as "ImpLevel"
			, B.PARENTKEY AS "ParentKey"
			, B.STARTDATE AS "StartDate"
			, B.ENDDATE AS "EndDate"
			, CASE		WHEN B.TaskStatus NOT IN ('C','H') and B.ENDDATE IS NOT NULL THEN			
					TO_DATE(B.EndDate,'YYYYMMDD') - to_date(to_char(SYSDATE,'YYYYMMDD'),'YYYYMMDD') 
				ELSE 0 END AS "RemainDay"
			, CASE WHEN (B.EndDate is null OR TO_DATE(B.EndDate,'YYYYMMDD')<SYSDATE) AND B.TaskStatus NOT IN ('C','H')  THEN 'Y' END AS "IsDelay"
			, B.TASKSTATUS AS "TaskStatus"
			, NVL(B.PROGRATE, 0) AS "ProgRate"
			, B.CLOSEDATE AS "CloseDate"
			, B.OBJECTTYPE AS "ObjectType"
			, B.OBJECTID AS "ObjectID"
			, B.MODIFIERCODE AS "ModifierCode"
			, B.MODIFYDATE AS "ModifyDate"
			, B.IMAGEPATH AS "ImagePath"
		 	, b.IsMile as "IsMile"
			, f.FileID AS "FileID"
			, F.FILENAME AS "FileName"
			, F.FILEPATH AS "FilePath"
			, F.SAVEDNAME AS "SavedName"			
		 	, F.SIZE_ AS "Size"
		 	, F.Extention	 AS "Extention"
		 	, TO_CHAR(F.REGISTDATE, 'YYYY-MM-DD HH24:MI:SS') AS "FileRegistDate"
		 	, F.SAVETYPE AS "SaveType"
		 	, F.COMPANYCODE AS "CompanyCode"
		 	,(select LinkTaskSeq from COLLAB_TASK_LINK ctl where B.TaskSeq = ctl.TaskSeq and rownum <= 1) AS "LinkTaskSeq"
			,NVL((SELECT TASKNAME FROM COLLAB_TASK cln WHERE TASKSEQ = (SELECT LINKTASKSEQ FROM COLLAB_TASK_LINK ctll WHERE B.TASKSEQ = ctll.TaskSeq AND ROWNUM <= 1)), ' ') AS "LinkTaskName"
			,(SELECT 
					LISTAGG(ctm.UserCode || '^' || Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName) || '^' || sou.PhotoPath || '^' || bg.DeptName, '|') WITHIN GROUP(ORDER BY ctm.UserCode)
				FROM COLLAB_TASK_MEMBER ctm 
			   JOIN SYS_OBJECT_USER sou on ctm.userCode = sou.userCode
	     	   JOIN SYS_OBJECT_USER_BASEGROUP bg ON bg.UserCode = sou.UserCode AND bg.JobType = 'Origin'
				WHERE ctm.taskSeq = b.TaskSeq) as "tmUser"
			, CASE	WHEN b.RegisterCode = #{USERID} or A.UserCode IS NOT NULL THEN 'Y'
					ELSE 'N'
			  END AS "authSave"
			]]>
			<choose>
				<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
	     	    ,(SELECT  LISTAGG(c.PrjType || '^' || case when c.prjType = 'P' then p.PrjName ELSE t.DisplayName END||'^'||p.PrjColor||'^'||s.SectionName) WITHIN GROUP(ORDER BY c.TaskSeq) as PrjDesc
	     	        FROM COLLAB_TASK_MAP C 
		            JOIN COLLAB_SECTION s on c.sectionseq = s.sectionseq
	     	   LEFT JOIN COLLAB_PROJECT P on c.PrjType='P' and p.PrjSeq = c.PrjSeq
	     	   LEFT JOIN SYS_OBJECT_GROUP T on c.PrjType!='P' and t.GroupId = c.PrjSeq
			   LEFT JOIN COLLAB_TEAM_EXEC e on t.groupid = e.groupid AND e.isClose='N'
	     	       WHERE c.TaskSeq =b.taskseq
	     	    ) AS "PrjDesc"	     	     	
				</when>
				<otherwise>
				, C.PRJSEQ AS "PrjSeq"
				, C.PRJTYPE AS "PrjType"
				, C.SECTIONSEQ AS "SectionSeq"
				, c.WORKORDER	
				, (SELECT SectionName FROM collab_section s where s.SectionSeq = c.SectionSeq) "SectionName"
				</otherwise>
			</choose>
		FROM COLLAB_TASK B		
   LEFT JOIN (SELECT * FROM SYS_FILE WHERE FileID IN 
				(SELECT max(FileID) FROM SYS_FILE F2 WHERE F2.ServiceType = 'Collab' AND F2.saveType='IMAGE' GROUP BY ObjectID)
					) F ON (F.ObjectID = B.TaskSeq)
		<choose>
			<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
		 	  JOIN COLLAB_TASK_MEMBER A on  A.TaskSeq = B.TaskSeq   AND A.UserCode = #{USERID} 
		 	 WHERE 1=1
			</when>
			<otherwise>
			<if test='allView != "" and allView == "Y"'>LEFT</if>
				JOIN COLLAB_TASK_MEMBER A on A.TaskSeq = B.TaskSeq  
					<if test="memberId != null and  memberId !=''">
						<if test="memberId != 'NONE'">
							AND A.UserCode = #{memberId}
						</if>	
					</if>
					<if test="memberId == null or  memberId ==''">
					AND A.UserCode = #{USERID}
					</if>
		 LEFT JOIN COLLAB_TASK_MAP C ON (C.TaskSeq = B.TaskSeq)
			 WHERE c.PrjSeq = #{prjSeq}   
			   AND c.PrjType = #{prjType}
			</otherwise>
		</choose>
		AND B.ParentKey = 0
		<include refid="searchMyTask" />
		
		<trim prefix='ORDER BY'>
			<if test='sortColumn != null and sortColumn != "" and sortDirection != null and sortDirection != ""'>
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Delay")'>"IsDelay" , "RemainDay"</when>
					<otherwise>"EndDate"</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
			<if test='sortColumn == null or sortColumn == "" or sortDirection == null or sortDirection == ""'>
				<choose>
		     		<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
						"Todoorder" ASC
					</when>
					<otherwise>
					 	C.WORKORDER ASC
			 		</otherwise>
				</choose>
				, "EndDate"
			</if>
		</trim>
		
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<!-- 
			<include refid="oracle.include.pagingFooter" />
			-->
							) A
				WHERE 1=1
				<if test="pageSize != null and pageOffset != null">
			        AND ROWNUM &lt;= #{pageSize}
			    </if>
			) T
			WHERE 1=1
			<if test="pageSize != null and pageOffset != null">
		   		AND T.RNUM &gt;= #{pageOffset}
		   	</if>
		</if>
	</select>
	
	<select id="getProjectTaskCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.getProjectTaskCnt */
		SELECT COUNT(0)
		FROM   collab_task B
		<choose>
			<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
				JOIN COLLAB_TASK_MEMBER A on  A.TaskSeq = B.TaskSeq   AND A.UserCode = #{USERID} 
				WHERE 1=1
			</when>
			<otherwise>
				<if test='allView != "" and allView == "Y"'>LEFT</if>
			  	 JOIN COLLAB_TASK_MEMBER A on A.TaskSeq = B.TaskSeq  
					<if test="memberId != null and  memberId !=''">
						<if test="memberId != 'NONE'">
							AND A.UserCode = #{memberId}
						</if>
					</if>
					<if test="memberId == null or  memberId ==''">
					AND A.UserCode = #{USERID}
					</if>
		    LEFT JOIN COLLAB_TASK_MAP C ON (C.TaskSeq = B.TaskSeq)
				WHERE c.PrjSeq = #{prjSeq}   
				AND c.PrjType = #{prjType}
			</otherwise>
		</choose>
		AND B.ParentKey = 0
		<include refid="searchMyTask" />
	</select>
	
	<select id="getProjectTaskFile" parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectFile*/
		with cte as (SELECT b.TaskSeq, b.TaskName, b.RegisterCode <if test='myTodo == "" or myTodo != "Y"'>,c.sectionSeq</if>
					  FROM COLLAB_TASK B		
							<choose>
								<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
							 	  JOIN COLLAB_TASK_MEMBER A on  A.TaskSeq = B.TaskSeq   AND A.UserCode = #{USERID} 
							 	 WHERE 1=1
								</when>
								<otherwise>
								<if test='allView != "" and allView == "Y"'>LEFT</if>
									JOIN COLLAB_TASK_MEMBER A on A.TaskSeq = B.TaskSeq  
										<if test="memberId != null and  memberId !=''">
											<if test="memberId != 'NONE'">
												AND A.UserCode = #{memberId}
											</if>	
										</if>
										<if test="memberId == null or  memberId ==''">
										AND A.UserCode = #{USERID}
										</if>
							 LEFT JOIN COLLAB_TASK_MAP C ON (C.TaskSeq = B.TaskSeq)
								 WHERE c.PrjSeq = #{prjSeq}   
								   AND c.PrjType = #{prjType}
								</otherwise>
							</choose>
							AND B.ParentKey = 0)
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingHeader" />
		</if>
		SELECT  TASKSEQ AS "TaskSeq"
				,TASKNAME AS "TaskName"
 				,ServiceType "ServiceType"
 				,FileID AS "FileID"
				,FILENAME AS "FileName"
				,FILEPATH AS "FilePath"
				,SAVEDNAME AS "SavedName"			
				,SIZE_ AS "Size"
				,Extention	 AS "Extention"
				,TO_CHAR(REGISTDATE, 'YYYY-MM-DD HH24:MI:SS') AS "FileRegistDate"
				,SAVETYPE AS "SaveType"
				,COMPANYCODE AS "CompanyCode"
				,CASE	WHEN RegisterCode = #{USERID} THEN 'Y'
						ELSE 'N'
				  END AS "authSave"
			<choose>
				<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
	     	    ,(SELECT  LISTAGG(c.PrjType || '^' || case when c.prjType = 'P' then p.PrjName ELSE t.DisplayName END||'^'||p.PrjColor||'^'||s.SectionName) WITHIN GROUP(ORDER BY c.TaskSeq) as PrjDesc
	     	        FROM COLLAB_TASK_MAP C 
		            JOIN COLLAB_SECTION s on c.sectionseq = s.sectionseq
	     	   LEFT JOIN COLLAB_PROJECT P on c.PrjType='P' and p.PrjSeq = c.PrjSeq
	     	   LEFT JOIN SYS_OBJECT_GROUP T on c.PrjType!='P' and t.GroupId = c.PrjSeq
			   LEFT JOIN COLLAB_TEAM_EXEC e on t.groupid = e.groupid AND e.isClose='N'
	     	       WHERE c.TaskSeq =b.taskseq
	     	    ) AS "PrjDesc"	     	     	
				</when>
				<otherwise>
				, (SELECT SectionName FROM collab_section s where s.SectionSeq = b.SectionSeq) "SectionName"
				</otherwise>
			</choose>
		  FROM ( 
				SELECT b.TASKSEQ 
					, B.TASKNAME 
					, f.ServiceType
					, f.FileID 
					, F.FILENAME
					, F.FILEPATH
					, F.SAVEDNAME		
				 	, F.SIZE_
				 	, F.Extention	
				 	, F.REGISTDATE
				 	, F.SAVETYPE 
				 	, F.COMPANYCODE
				 	, b.RegisterCode
				 	<if test='myTodo == "" or myTodo != "Y"'>,sectionSeq</if>
			 	FROM CTE b
		     	JOIN sys_file f ON  f.ServiceType = 'Collab' AND f.MessageID = 0 AND b.TaskSeq = f.ObjectID 
		     	WHERE 1 =1
		    	<include refid="searchMyTask" />
			union all
			   SELECT  b.TaskSeq 
					, B.TaskName ||'>'||to_char(c.Comment_)
					, f.ServiceType
					, f.FileID 
					, F.FileName
					, F.FilePath
					, F.SavedName		
				 	, F.Size_
				 	, F.Extention	
				 	, F.RegistDate
				 	, F.SaveType 
				 	, F.CompanyCode
				 	, c.RegisterCode
				 	<if test='myTodo == "" or myTodo != "Y"'>,sectionSeq</if>
				FROM CTE  b
		     	JOIN sys_comment c on c.TargetServiceType = 'Collab' AND c.TargetID = b.TaskSeq AND c.DeleteDate IS null
		     	JOIN sys_file f ON  f.ServiceType = 'Comment' AND f.MessageID = 0 AND c.CommentID = f.ObjectID
		     	WHERE 1 =1
				<include refid="searchMyTask" />
		   union all
			   SELECT b.TASKSEQ 
					, B.TASKNAME 
					, f.ServiceType
					, f.FileID 
					, F.FILENAME
					, F.FILEPATH
					, F.SAVEDNAME		
				 	, F.SIZE_
				 	, F.Extention	
				 	, F.REGISTDATE
				 	, F.SAVETYPE 
				 	, F.COMPANYCODE
				 	, b.RegisterCode
				 	<if test='myTodo == "" or myTodo != "Y"'>,sectionSeq</if>
				FROM CTE  
		     	JOIN COLLAB_TASK b ON b.TopParentKey = CTE.TASKSEQ
		     	JOIN sys_file f ON  f.ServiceType = 'Collab' AND f.MessageID = 0 AND b.TaskSeq = f.ObjectID
		     	WHERE 1 =1
				<include refid="searchMyTask" />
			union all
			   SELECT  b.TaskSeq 
					, B.TaskName ||'>'||to_char(c.Comment_)
					, f.ServiceType
					, f.FileID 
					, F.FileName
					, F.FilePath
					, F.SavedName		
				 	, F.Size_
				 	, F.Extention	
				 	, F.RegistDate
				 	, F.SaveType 
				 	, F.CompanyCode
				 	, c.RegisterCode
				 	<if test='myTodo == "" or myTodo != "Y"'>,sectionSeq</if>
				FROM CTE    
		     	JOIN COLLAB_TASK b ON b.TopParentKey = CTE.TaskSeq
		     	JOIN sys_comment c on c.TargetServiceType = 'Collab' AND c.TargetID = b.TaskSeq AND c.DeleteDate IS null
		     	JOIN sys_file f ON  f.ServiceType = 'Comment' AND f.MessageID = 0 AND c.CommentID = f.ObjectID
		     	WHERE 1 =1
				<include refid="searchMyTask" />
		)	B	
		<trim prefix='ORDER BY'>
			<if test='sortColumn != null and sortColumn != "" and sortDirection != null and sortDirection != ""'>
				<choose>
					<when test='sortColumn.equalsIgnoreCase("FileName")'>F.FileName</when>
					<when test='sortColumn.equalsIgnoreCase("Size")'>F.Size_</when>
					<otherwise>FileRegistDate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
			<if test='sortColumn == null or sortColumn == "" or sortDirection == null or sortDirection == ""'>
				"FileRegistDate"
			</if>
		</trim>
		
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
	) A
				WHERE 1=1
				<if test="pageSize != null and pageOffset != null">
			        AND ROWNUM &lt;= #{pageSize}
			    </if>
			) T
			WHERE 1=1
			<if test="pageSize != null and pageOffset != null">
		   		AND T.RNUM &gt;= #{pageOffset}
		   	</if>
		</if>
	</select>
	
	<select id="getProjectTaskFileCnt" parameterType="cmap"  resultType="java.lang.Long">
	/* collab.project.getProjectTaskFileCnt*/
		with cte as (SELECT b.TaskSeq
					  FROM COLLAB_TASK B		
							<choose>
								<when test='myTodo != "" and myTodo == "Y"'><!-- 내업무 -->
							 	  JOIN COLLAB_TASK_MEMBER A on  A.TaskSeq = B.TaskSeq   AND A.UserCode = #{USERID} 
							 	 WHERE 1=1
								</when>
								<otherwise>
								<if test='allView != "" and allView == "Y"'>LEFT</if>
									JOIN COLLAB_TASK_MEMBER A on A.TaskSeq = B.TaskSeq  
										<if test="memberId != null and  memberId !=''">
											<if test="memberId != 'NONE'">
												AND A.UserCode = #{memberId}
											</if>	
										</if>
										<if test="memberId == null or  memberId ==''">
										AND A.UserCode = #{USERID}
										</if>
							 LEFT JOIN COLLAB_TASK_MAP C ON (C.TaskSeq = B.TaskSeq)
								 WHERE c.PrjSeq = #{prjSeq}   
								   AND c.PrjType = #{prjType}
								</otherwise>
							</choose>
							AND B.ParentKey = 0)
		SELECT  count(*)
		  FROM ( 
				SELECT b.TASKSEQ 
					, f.FileID 
			 	FROM CTE b
		     	JOIN sys_file f ON  f.ServiceType = 'Collab' AND f.MessageID = 0 AND b.TaskSeq = f.ObjectID 
		     	WHERE 1 =1
		    	<include refid="searchMyTask" />
		   union all
				SELECT b.TASKSEQ 
					, f.FileID 
				FROM CTE  b
		     	JOIN sys_comment c on c.TargetServiceType = 'Collab' AND c.TargetID = b.TaskSeq AND c.DeleteDate IS null
		     	JOIN sys_file f ON  f.ServiceType = 'Comment' AND f.MessageID = 0 AND c.CommentID = f.ObjectID
		     	WHERE 1 =1
				<include refid="searchMyTask" />
		   union all
			   SELECT b.TASKSEQ 
					, f.FileID 
				FROM CTE  
		     	JOIN COLLAB_TASK b ON b.TopParentKey = CTE.TASKSEQ
		     	JOIN sys_file f ON  f.ServiceType = 'Collab' AND f.MessageID = 0 AND b.TaskSeq = f.ObjectID
		     	WHERE 1 =1
				<include refid="searchMyTask" />
		   union all
			   SELECT b.TASKSEQ 
					, f.FileID 
				FROM CTE    
		     	JOIN COLLAB_TASK b ON b.TopParentKey = CTE.TaskSeq
		     	JOIN sys_comment c on c.TargetServiceType = 'Collab' AND c.TargetID = b.TaskSeq AND c.DeleteDate IS null
		     	JOIN sys_file f ON  f.ServiceType = 'Comment' AND f.MessageID = 0 AND c.CommentID = f.ObjectID
		     	WHERE 1 =1
				<include refid="searchMyTask" />
		)	B	
	</select>
	
	
	<insert id="addProjectSection"   parameterType="cmap" useGeneratedKeys="true">
	/* collab.project.addProjectSection */
		INSERT INTO COLLAB_SECTION 
					( SectionSeq, prjSeq , prjType, SectionName, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
		VALUES		( COLLAB_SECTION_SEQ.NEXTVAL, #{prjSeq}, #{prjType},#{sectionName}, #{USERID}, SYSDATE, #{USERID}, SYSDATE)
	   <selectKey keyProperty="SectionSeq" resultType="Integer" order="AFTER">
		    SELECT COLLAB_SECTION_SEQ.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	
	<insert id="saveProjectSection"   parameterType="cmap">
	/* collab.project.saveProjectSection */
		UPDATE COLLAB_SECTION
		   SET sectionName =#{sectionName}
		   		,ModifierCode= #{USERID}
		   		,ModifyDate = SYSDATE
		 WHERE 	sectionSeq = 	#{sectionSeq}
	</insert>
	

	<delete id="deleteProjectSection"   parameterType="cmap">
	/* collab.project.deleteProjectSection */
		DELETE FROM COLLAB_SECTION 
		 WHERE 
		 <if test='prjSeq != null and prjSeq != ""'>
		    prjType = #{prjType}
		 	AND prjSeq =  #{prjSeq}
		 </if>
		 <if test='sectionSeq != null and sectionSeq != ""'>
		 	sectionSeq =  #{sectionSeq}
		 </if>
	</delete>

	<delete id="deleteProjectSectionMap"   parameterType="cmap">
	/* collab.project.deleteProjectSectionMap */
		UPDATE COLLAB_TASK_MAP
		   SET sectionSeq = null
		 WHERE sectionSeq =  #{sectionSeq}
	</delete>

	<delete id="deleteProjectMap"   parameterType="cmap">
	/* collab.project.deleteProjectMap */
		DELETE FROM COLLAB_TASK_MAP WHERE prjType ='P' AND prjSeq =  #{prjSeq}
	</delete>

	<insert id="copyProject"   parameterType="cmap" useGeneratedKeys="true">
	/* collab.project.copyProject */
		INSERT INTO COLLAB_PROJECT 
					( PrjSeq, prjName , CompanyCode , StartDate, EndDate, PrjStatus, PrjColor, ProgRate, Remark, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
			(SELECT COLLAB_PROJECT_SEQ.NEXTVAL PrjSeq, #{prjName},#{CompanyCode}, StartDate, EndDate, PrjStatus, PrjColor, #{progRate}, Remark, #{USERID}, SYSDATE, #{USERID}, SYSDATE
			   FROM COLLAB_PROJECT
			  WHERE prjSeq =  #{orgPrjSeq})
			    
	   <selectKey keyProperty="PrjSeq" resultType="Integer" order="AFTER">
		    SELECT COLLAB_PROJECT_SEQ.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	
	<insert id="copyProjectUserform"   parameterType="cmap">
	/* collab.project.copyProjectUserform */
		INSERT INTO COLLAB_PROJECT_USERFORM
				(PRJUSERFORMSEQ, prjSeq, optionTitle, optionType, optionVal, sortKey, RegisterCode, RegisteDate, ModifierCode, ModifyDate )
		(SELECT COLLAB_PROJECT_USERFORM_SEQ.NEXTVAL, #{prjSeq}, optionTitle, optionType, optionVal, sortKey, #{USERID}, SYSDATE, #{USERID}, SYSDATE
		   FROM COLLAB_PROJECT_USERFORM
		  WHERE prjSeq =  #{orgPrjSeq})
	</insert>
	
	<insert id="copyProjectMember"   parameterType="cmap">
	/* collab.project.copyProjectMember */
		INSERT INTO COLLAB_PROJECT_MEMBER
					(prjSeq	,userCode	,RegisterCode,RegisteDate)
			(SELECT #{prjSeq},userCode,#{USERID},SYSDATE
			   FROM COLLAB_PROJECT_MEMBER
			  WHERE prjSeq =  #{orgPrjSeq})
	</insert>
	
	<insert id="copyProjectManager"   parameterType="cmap">
	/* collab.project.copyProjectManager */
		INSERT INTO COLLAB_PROJECT_MANAGER
					(prjSeq	,userCode	,RegisterCode,RegisteDate)
			(SELECT #{prjSeq},userCode,#{USERID},SYSDATE
			   FROM COLLAB_PROJECT_MANAGER
			  WHERE prjSeq =  #{orgPrjSeq})
	</insert>
	
	<insert id="copyProjectViewer"   parameterType="cmap">
	/* collab.project.copyProjectViewer */
		INSERT INTO COLLAB_PROJECT_VIEWER
					(prjSeq	,userCode	,RegisterCode,RegisteDate)
			(SELECT #{prjSeq},userCode,#{USERID},SYSDATE
			   FROM COLLAB_PROJECT_VIEWER
			  WHERE prjSeq =  #{orgPrjSeq})
	</insert>

	<insert id="copyProjectSection"   parameterType="cmap">
	/* collab.project.copyProjectSection */
		INSERT INTO COLLAB_SECTION 
					( SECTIONSEQ, prjSeq, prjType , SectionName, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
			(SELECT COLLAB_SECTION_SEQ.NEXTVAL, #{prjSeq}, #{prjType}, SectionName, #{USERID}, SYSDATE, #{USERID}, SYSDATE
			   FROM COLLAB_SECTION
			  WHERE prjSeq =  #{orgPrjSeq})  
	</insert>
	
	<select id="selectProjectMemberList" parameterType="cmap" resultType="cmap">
	/* collab.project.selectProjectMemberList */
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingHeader" />
		</if>
		SELECT	  sou.USERCODE AS "UserCode"
				, Fn_BaseGetDictionary_S(#{lang}, soub.MultiDeptName) AS "DeptName"
				, Fn_BaseGetDictionary_S(#{lang}, soub.MultiJobPositionName) AS "JobPositionName"
				, Fn_BaseGetDictionary_S(#{lang}, sou.MultiDisplayName) AS "DisplayName"
				, sou.PHOTOPATH AS "PhotoPath"
				<if test="thisTaskSeq != null and thisTaskSeq != ''">
		        , (select m.UserCode from COLLAB_TASK_MEMBER m WHERE m.taskseq = #{thisTaskSeq}  and m.UserCode = sou.USERCODE) "IsAlloc"
		        </if>
		FROM SYS_OBJECT_USER sou 
		<if test="prjType != null and prjType != ''">
			JOIN (
				<if test='prjType == "P"'>
					SELECT USERCODE
					FROM COLLAB_PROJECT_MANAGER
					WHERE prjSeq = #{prjSeq}
					
					UNION
					
					SELECT USERCODE
					FROM COLLAB_PROJECT_MEMBER
					WHERE prjSeq = #{prjSeq}
				</if>
				<if test='prjType != "P"'>
					SELECT A.USERCODE
					FROM SYS_OBJECT_USER_BASEGROUP A
					INNER JOIN SYS_OBJECT_GROUP B ON A.DeptCode = B.GroupCode AND B.GroupID = #{prjSeq}
				</if>
			) userinfo	 ON userinfo.UserCode = sou.UserCode
		</if>	
		JOIN SYS_OBJECT_USER_BASEGROUP soub ON sou.UserCode = soub.UserCode
		WHERE sou.IsUse = 'Y'
      	AND sou.IsDisplay = 'Y'
		<if test="searchWord != null and searchWord != ''">
			AND sou.MultiDisplayName LIKE '%' || #{searchWord} || '%'
		</if>
		<trim prefix="ORDER BY">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection != ''">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DeptName")'>"DeptName"</when>
					<when test='sortColumn.equalsIgnoreCase("JobPositionName")'>"JobPositionName"</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>"DisplayName"</when>
					<otherwise>"DisplayName"</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingFooter" />
		</if>
	</select>
	
	<select id="selectProjectMemberListCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.selectProjectMemberListCnt */
		SELECT COUNT(*)
		FROM (
			SELECT	  sou.USERCODE AS "UserCode"
					, FN_BASEGETDICTIONARY_S(#{lang}, soub.MULTIDEPTNAME) AS "DeptName"
					, FN_BASEGETDICTIONARY_S(#{lang}, soub.MULTIJOBPOSITIONNAME) AS "JobPositionName"
					, FN_BASEGETDICTIONARY_S(#{lang}, sou.MULTIDISPLAYNAME) AS "DisplayName"
					, sou.PHOTOPATH AS "PhotoPath"
			FROM SYS_OBJECT_USER sou 
			<if test="prjType != null and prjType != ''">
				JOIN (
					<if test='prjType == "P"'>
						SELECT USERCODE
						FROM COLLAB_PROJECT_MANAGER
						WHERE prjSeq = #{prjSeq}
						
						UNION
						
						SELECT USERCODE
						FROM COLLAB_PROJECT_MEMBER
						WHERE prjSeq = #{prjSeq}
					</if>
					<if test='prjType != "P"'>
						SELECT A.USERCODE
						FROM SYS_OBJECT_USER_BASEGROUP A
						INNER JOIN SYS_OBJECT_GROUP B ON A.DeptCode = B.GroupCode AND B.GroupID = #{prjSeq}
					</if>
				) userinfo	 ON userinfo.UserCode = sou.UserCode
			</if>	
			JOIN SYS_OBJECT_USER_BASEGROUP soub ON sou.UserCode = soub.UserCode
			WHERE sou.IsUse = 'Y'
	      	AND sou.IsDisplay = 'Y'
			<if test="searchWord != null and searchWord != ''">
				AND Fn_BaseGetDictionary_S(#{lang}, sou.MultiDisplayName) LIKE '%' || #{searchWord} || '%'
			</if>
		) RESULT
	</select>
	
	<select id="selectProjectMemberTagList" parameterType="cmap" resultType="cmap">
	/* collab.project.selectProjectMemberTagList */
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingHeader" />
		</if>
		
		SELECT	  sou.UserCode as "UserCode"
				, Fn_BaseGetDictionary_S(#{lang}, soub.MultiDeptName) AS "DeptName"
				, Fn_BaseGetDictionary_S(#{lang}, soub.MultiJobPositionName) AS "JobPositionName"
				, Fn_BaseGetDictionary_S(#{lang}, sou.MultiDisplayName) AS "DisplayName"
				, sou.PhotoPath as "PhotoPath"
				<if test="thisTaskSeq != null and thisTaskSeq != ''">
		        , (select m.UserCode from COLLAB_TASK_MEMBER m WHERE m.taskseq = #{thisTaskSeq}  and m.UserCode = sou.USERCODE) as "IsAlloc"
		        </if>
		FROM SYS_OBJECT_USER sou	
		JOIN SYS_OBJECT_USER_BASEGROUP soub ON sou.UserCode = soub.UserCode AND soub.JobType ='Origin'
		WHERE sou.IsUse = 'Y'
      		AND sou.IsDisplay = 'Y'
		<if test='userCodesArray != null and userCodesArray.length != 0'>
			AND sou.UserCode IN
			<foreach collection="userCodesArray" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="searchWord != null and searchWord != ''">
			AND sou.MultiDisplayName LIKE '%' || #{searchWord} || '%'
		</if>
		<trim prefix="ORDER BY">
			<if test="sortColumn != null and sortColumn != '' and sortDirection != null and sortDirection != ''">
				<choose>
					<when test='sortColumn.equalsIgnoreCase("DeptName")'>"DeptName"</when>
					<when test='sortColumn.equalsIgnoreCase("JobPositionName")'>"JobPositionName"</when>
					<when test='sortColumn.equalsIgnoreCase("DisplayName")'>"DisplayName"</when>
					<otherwise>"DisplayName"</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
		</trim>
		
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingFooter" />
		</if>
	</select>
	
	<select id="selectProjectMemberTagListCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.selectProjectMemberTagListCnt */
		SELECT COUNT(*)
		FROM (
			SELECT	  sou.UserCode as "UserCode"
					, Fn_BaseGetDictionary_S(#{lang}, soub.MultiDeptName) AS "DeptName"
					, Fn_BaseGetDictionary_S(#{lang}, soub.MultiJobPositionName) AS "JobPositionName"
					, Fn_BaseGetDictionary_S(#{lang}, sou.MultiDisplayName) AS "DisplayName"
					, sou.PhotoPath as "PhotoPath"
			FROM SYS_OBJECT_USER sou	
			JOIN SYS_OBJECT_USER_BASEGROUP soub ON sou.UserCode = soub.UserCode AND soub.JobType ='Origin'
			WHERE sou.IsUse = 'Y'
		      	AND sou.IsDisplay = 'Y'
		    <if test='userCodesArray != null and userCodesArray.length != 0'>
				AND sou.UserCode IN
				<foreach collection="userCodesArray" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="searchWord != null and searchWord != ''">
				AND sou.MultiDisplayName LIKE '%' || #{searchWord} || '%'
			</if>
		) RESULT
	</select>
	
	<select id="selectCollabSurveyList" parameterType="cmap" resultType="cmap">
	/* collab.project.selectCollabSurveyList */
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingHeader" />
		</if>
		SELECT	  RESULT.SURVEYID AS "SurveyID"
				, RESULT.SUBJECT AS "Subject"
				, RESULT.STARTDATE AS "StartDate"
				, RESULT.ENDDATE AS "EndDate"
				, RESULT.STATE AS "State"
				, RESULT.REGISTERCODE AS "RegisterCode"
				, RESULT.REGISTERNAME AS "RegisterName"
				, RESULT.REGISTDATE AS "RegistDate"
				, RESULT.MODIFYDATE AS "ModifyDate"
				, RESULT.PRJTYPE AS "PrjType"
				, RESULT.JOINRATE AS "JoinRate"
				, RESULT.RESPONDENTCNT AS "RespondentCnt"
				, RESULT.COMMENTCNT AS "CommentCnt"
				, case when RESULT.TargetCode is not null then 'Y' else 'N' end as "IsResponse"
		FROM (
			-- 진행중인 설문(설문 대상)
			SELECT	  A.SurveyID
					, A.Subject
					, TO_CHAR(A.SurveyStartDate, 'YYYY.MM.DD') AS StartDate
					, TO_CHAR(A.SurveyEndDate, 'YYYY.MM.DD') AS EndDate
					, CASE WHEN State = 'F' THEN
						(CASE WHEN (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND RespondentCode = #{userCode}) = 0 THEN 'F'
					  	WHEN (SELECT COUNT(*) FROM SURVEY_TARGET_RESULTVIEW WHERE SurveyID = A.SurveyID AND TargetCode = #{userCode} AND TargetType = 'UR') = 0 THEN 'C'
		  			  	ELSE 'G' END )
		  			  ELSE State END AS State
		  			, A.RegisterCode
		  			, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM SYS_OBJECT_USER WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM SURVEY_TARGET_RESPONDENT WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					,  C.TargetCode
			FROM survey A
			INNER JOIN COLLAB_SURVEY B ON B.SurveyID = A.SurveyID
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			INNER JOIN SURVEY_TARGET_RESPONDENT C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.State = 'F'
			AND A.DeleteDate IS NULL
			AND SYSDATE BETWEEN A.SurveyStartDate AND A.SurveyEndDate
			
			-- 완료된 설문(결과 공개 대상)
			UNION 
			
			SELECT	  A.SurveyID
					, A.Subject
					, TO_CHAR(A.ResultViewStartDate, 'YYYY.MM.DD') AS StartDate
					, TO_CHAR(A.ResultViewEndDate, 'YYYY.MM.DD') AS EndDate
					, A.State
					, A.RegisterCode
		  			, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM SYS_OBJECT_USER WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM SURVEY_TARGET_RESPONDENT WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					,  C.TargetCode
			FROM survey A
			INNER JOIN collab_survey B ON B.SurveyID = A.SurveyID
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			INNER JOIN survey_target_resultview C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.State = 'G'
			AND A.DeleteDate IS NULL
			AND SYSDATE BETWEEN A.ResultViewStartDate AND A.ResultViewEndDate
			
			-- 임시저장된 설문(작성자)
			UNION 
			
			SELECT	  A.SurveyID
					, A.Subject
					, TO_CHAR(A.SurveyStartDate, 'YYYY.MM.DD') AS StartDate
					, TO_CHAR(A.SurveyEndDate, 'YYYY.MM.DD') AS EndDate
					, CASE WHEN State = 'F' THEN
						(CASE WHEN (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND RespondentCode = #{userCode}) = 0 THEN 'F'
					  	WHEN (SELECT COUNT(*) FROM SURVEY_TARGET_RESULTVIEW WHERE SurveyID = A.SurveyID AND TargetCode = #{userCode} AND TargetType = 'UR') = 0 THEN 'C'
		  			  	ELSE 'G' END )
		  			  ELSE State END AS State
					, A.RegisterCode
		  			, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM SYS_OBJECT_USER WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM SURVEY_TARGET_RESPONDENT WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					,  C.TargetCode
			FROM SURVEY A
			INNER JOIN COLLAB_SURVEY B ON B.SurveyID = A.SurveyID 
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			LEFT  JOIN SURVEY_TARGET_RESPONDENT C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.RegisterCode = #{userCode}
			AND A.DeleteDate IS NULL
		) RESULT
		WHERE 1=1
		<include refid="searchMyTask" />
		<trim prefix='ORDER BY'>
			<if test='sortColumn != null and sortColumn != "" and sortDirection != null and sortDirection != ""'>
				<choose>
					<when test='sortColumn.equalsIgnoreCase("Subject")'>Subject</when>
					<when test='sortColumn.equalsIgnoreCase("StartDate")'>StartDate</when>
					<when test='sortColumn.equalsIgnoreCase("RegisterName")'>RegisterName</when>
					<otherwise>JoinRate</otherwise>
				</choose>
				<choose>
					<when test='sortDirection.equalsIgnoreCase("ASC")'> ASC</when>
					<otherwise> DESC</otherwise>
				</choose>
			</if>
			<if test='sortColumn == null or sortColumn == "" or sortDirection == null or sortDirection == ""'>
				ModifyDate DESC, SurveyID DESC
			</if>
		</trim>
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingFooter" />
		</if>
	</select>
	
	<select id="selectCollabSurveyListCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.selectCollabSurveyListCnt */
		SELECT COUNT(0)
		FROM (
			-- 진행중인 설문(설문 대상)
			SELECT	  A.SurveyID
					, A.Subject
					, TO_DATE(A.SurveyStartDate, 'YYYY.MM.DD') AS StartDate
					, TO_DATE(A.SurveyEndDate,'YYYY.MM.DD') AS EndDate
					, CASE WHEN State ='F' then  
						CASE WHEN (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND RespondentCode = #{userCode}) = 0 THEN 'F'
					  	WHEN (SELECT COUNT(*) FROM SURVEY_TARGET_RESULTVIEW WHERE SurveyID = A.SurveyID AND TargetCode = #{userCode} AND TargetType = 'UR') = 0 THEN 'C'
		  			  	ELSE 'G' END
		  			  ELSE State END AS State
		  			, A.RegisterCode
		  			, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM SYS_OBJECT_USER WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM SURVEY_TARGET_RESPONDENT WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					, C.TargetCode
			FROM SURVEY A
			INNER JOIN COLLAB_SURVEY B ON B.SurveyID = A.SurveyID
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			INNER JOIN SURVEY_TARGET_RESPONDENT C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.State = 'F'
			AND A.DeleteDate IS NULL
			AND SYSDATE BETWEEN A.SurveyStartDate AND A.SurveyEndDate
			
			-- 완료된 설문(결과 공개 대상)
			UNION 
			
			SELECT	  A.SurveyID
					, A.Subject
					, TO_DATE(A.ResultViewStartDate, 'YYYY.MM.DD') AS StartDate
					, TO_DATE(A.ResultViewEndDate, 'YYYY.MM.DD') AS EndDate
					, A.State
					, A.RegisterCode
		  			, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM SYS_OBJECT_USER WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM SURVEY_TARGET_RESPONDENT WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					, C.TargetCode
			FROM SURVEY A
			INNER JOIN COLLAB_SURVEY B ON B.SurveyID = A.SurveyID
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			INNER JOIN SURVEY_TARGET_RESULTVIEW C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE 1=1
			AND A.State = 'G'
			AND A.DeleteDate IS NULL
			AND SYSDATE BETWEEN A.ResultViewStartDate AND A.ResultViewEndDate
			
			-- 임시저장된 설문(작성자)
			UNION 
			
			SELECT	  A.SurveyID
					, A.Subject
					, TO_DATE(A.SurveyStartDate, 'YYYY.MM.DD') AS StartDate
					, TO_DATE(A.SurveyEndDate, 'YYYY.MM.DD') AS EndDate
					, CASE WHEN State ='F' then  
						CASE WHEN (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND RespondentCode = #{userCode}) = 0 THEN 'F'
					  	WHEN (SELECT COUNT(*) FROM SURVEY_TARGET_RESULTVIEW WHERE SurveyID = A.SurveyID AND TargetCode = #{userCode} AND TargetType = 'UR') = 0 THEN 'C'
		  			  	ELSE 'G' END
		  			  ELSE State END AS State
					, A.RegisterCode
		  			, (SELECT Fn_BaseGetDictionary_S(#{lang}, MultiDisplayName) FROM SYS_OBJECT_USER WHERE UserCode = A.RegisterCode) AS RegisterName
					, A.RegistDate
					, A.ModifyDate
					, B.PrjType
					, Fn_SurveyRate_R(A.SurveyID) AS JoinRate
					, (SELECT COUNT(*) FROM SURVEY_TARGET_RESPONDENT WHERE SurveyID = A.SurveyID) AS RespondentCnt
					, (SELECT COUNT(*) FROM SURVEY_RESPONDENT WHERE SurveyID = A.SurveyID AND EtcOpinion IS NOT NULL AND EtcOpinion != '') AS CommentCnt
					, C.TargetCode
			FROM SURVEY A
			INNER JOIN COLLAB_SURVEY B ON B.SurveyID = A.SurveyID 
			<if test='myTodo != null and myTodo == "N"'>
				AND B.PrjSeq = #{prjSeq}
			</if>
			LEFT  JOIN SURVEY_TARGET_RESPONDENT C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
			WHERE A.RegisterCode = #{userCode}
			AND   A.DeleteDate IS NULL
		) RESULT
		WHERE 1=1
		<include refid="searchMyTask" />
	</select>
	
	<select id="selectCollabApprovalList" parameterType="cmap" resultType="cmap">
	/* collab.project.selectCollabApprovalList */
		SELECT	  A.TASKSEQ AS "TaskSeq"
				, A.TASKNAME AS "TaskName"
				, TO_DATE(A.StartDate, 'YYYY.MM.DD') AS "StartDate"
				, TO_DATE(A.EndDate, 'YYYY.MM.DD') AS "EndDate"
				, A.REGISTEDATE AS "RegisteDate"
				, A.MODIFYDATE AS "ModifyDate"
				, B.INITIATORID AS "UserCode"
				, FN_BASEGETDICTIONARY_S(#{lang},sou.MultiDisplayName) AS "DisplayName"
				, sou.PhotoPath AS "PhotoPath"
				, TO_CHAR(B.InitiatedDate, 'YYYY-MM-DD HH24:MI:SS') AS "InitiateDateStr"
				, M.PrjType, m.PrjSeq
	     	    , case when m.prjType = 'P' then p.PrjName ELSE t.DisplayName END as "PrjName"
				, s.SectionName as "SectionName"
		FROM COLLAB_TASK A
		INNER JOIN COLLAB_TASK_MAP M	ON M.TaskSeq = A.TaskSeq
		<if test='myTodo != null and myTodo == "N"'>
			AND M.PrjSeq = #{prjSeq}
		</if>
         JOIN COLLAB_SECTION s on m.sectionseq = s.sectionseq
 	   LEFT JOIN COLLAB_PROJECT P on m.PrjType='P' and p.PrjSeq = m.PrjSeq
 	   LEFT JOIN SYS_OBJECT_GROUP T on m.PrjType!='P' and t.GroupId = m.PrjSeq
 LEFT JOIN COLLAB_TEAM_EXEC e on t.groupid = e.groupid AND e.isClose='N'
		INNER JOIN JWF_FORMINSTANCE B 
			ON B.FormInstID = A.ObjectID
		INNER JOIN SYS_OBJECT_USER sou 
			ON B.InitiatorID = sou.userCode
		WHERE 1=1
		AND A.ObjectType = 'APPROVAL'
		<if test='myTodo == "Y"'>
		AND A.RegisterCode = #{userCode}
		</if>
		<include refid="searchMyTask" />
		ORDER BY A.ModifyDate DESC	
	</select>
	
	<insert id="addProjectTmpl"   parameterType="cmap">
	/* collab.project.addProjectTmpl */
		INSERT INTO COLLAB_TMPL_REQUEST 
					( REQUESTSEQ, prjSeq , tmplKind, RequestTitle, RequestRemark, RequesterCode, RequestStatus, RegisterCode, RegisteDate, ModifierCode, ModifyDate, CompanyCode)
		VALUES		( COLLAB_TMPL_REQUEST_SEQ.NEXTVAL, #{prjSeq}, #{tmplKind},#{requestTitle}, #{requestRemark}, #{USERID}, 'ApprovalRequest', #{USERID}, SYSDATE, #{USERID}, SYSDATE, #{CompanyCode})
	</insert>
	
	<insert id="addProjectByTmpl"   parameterType="cmap" useGeneratedKeys="true">
	/* collab.project.addProjectByTmpl */
		INSERT INTO COLLAB_PROJECT 
					( prjSeq, prjName , CompanyCode , StartDate, EndDate, PrjStatus, PrjColor, ProgRate, Remark, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
			(SELECT COLLAB_PROJECT_SEQ.NEXTVAL, #{prjName},#{CompanyCode}, #{startDate}, #{endDate}, #{prjStatus}, PrjColor, #{progRate}, Remark, #{USERID}, SYSDATE, #{USERID}, SYSDATE
			   FROM COLLAB_TMPL_PROJECT
			  WHERE tmplSeq =  #{tmplSeq})
			    
	   <selectKey keyProperty="PrjSeq" resultType="Integer" order="AFTER">
		    SELECT COLLAB_PROJECT_SEQ.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	
	<insert id="addProjectUserformByTmpl"   parameterType="cmap">
	/* collab.project.addProjectUserformByTmpl */
		INSERT INTO COLLAB_PROJECT_USERFORM
				(PRJUSERFORMSEQ, prjSeq, optionTitle, optionType, optionVal, sortKey, RegisterCode, RegisteDate, ModifierCode, ModifyDate )
		(SELECT COLLAB_PROJECT_USERFORM_SEQ.NEXTVAL, #{prjSeq}, optionTitle, optionType, optionVal, sortKey, #{USERID}, SYSDATE, #{USERID}, SYSDATE
		   FROM COLLAB_TMPL_PROJECT_USERFORM
		  WHERE tmplSeq =  #{tmplSeq})
	</insert>
	
	<insert id="addProjectSectionByTmpl"   parameterType="cmap">
	/* collab.project.addProjectSectionByTmpl */
		INSERT INTO COLLAB_SECTION 
					( SECTIONSEQ, prjSeq, prjType , SectionName, RegisterCode, RegisteDate, ModifierCode, ModifyDate)
			(SELECT COLLAB_SECTION_SEQ.NEXTVAL, #{prjSeq}, 'P', SectionName, #{USERID}, SYSDATE, #{USERID}, SYSDATE
			   FROM COLLAB_TMPL_SECTION
			  WHERE tmplSeq =  #{tmplSeq})  
	</insert>
	
	<select id="getTmplTaskList" parameterType="cmap" resultType="cmap">
	/* collab.project.getTmplTaskList */
		SELECT TaskName, StartDate, EndDate, Label, ParentKey, TopParentKey, TaskStatus, ProgRate, CloseDate, ObjectType, ObjectID, Remark
				, ns.SectionSeq
	      FROM COLLAB_TMPL_TASK  tt
	      JOIN COLLAB_TMPL_SECTION ts on tt.tmplSeq = ts.tmplSeq AND tt.SectionSeq = ts.SectionSeq
	      JOIN COLLAB_SECTION ns on ts.SectionName = ns.SectionName AND ns.prjSeq = #{prjSeq} AND ns.prjType = 'P'
	     WHERE tt.tmplSeq =  #{tmplSeq}
	</select>

	<insert id="closeTeamExec"   parameterType="cmap">
	/* collab.project.closeTeam */
		UPDATE collab_team_exec
		   SET isClose = 'Y'
		   		,CloserCode= #{USERID}
		   		,CloseDate = SYSDATE
		 WHERE ExecYear = 	#{execYear}
		   AND GroupId = #{groupID}
	</insert>
	
	<insert id="createTeamExec"   parameterType="cmap">
	 MERGE INTO  collab_team_exec a
			  USING  dual
			  	ON (ExecYear = to_number(#{execYear})+1 AND GroupId = #{groupID})
	   WHEN MATCHED THEN  
	        UPDATE SET
			         a.isClose   = 'N'
	   WHEN NOT MATCHED THEN
	      INSERT    (ExecYear, GroupId ,RegisterCode, RegisteDate)
		  VALUES	( to_number(#{execYear})+1, #{groupID}, #{USERID}, SYSDATE)
	</insert>
		
	<insert id="closeProject"   parameterType="cmap">
	/* collab.project.closeProject */
		UPDATE collab_project
		   SET isClose = 'Y'
		   		,CloseDate = SYSDATE
		   		,ModifyDate = SYSDATE
		   		,ModifierCode= #{USERID}
		 WHERE prjSeq = #{prjSeq}
	</insert>
	<insert id="saveProjectChannel"   parameterType="cmap">
	/* collab.project.saveProject */
		UPDATE COLLAB_PROJECT
		   SET roomId =  #{roomId}
		 WHERE prjSeq =  #{prjSeq}
	</insert>
	
	<select id="getProjectFile" parameterType="cmap" resultType="cmap">
	/* collab.project.getProjectFile*/
		SELECT  f.ServiceType "ServiceType"
				, f.FileID "FileID"
				, f.FileName "FileName"
				, f.FilePath "FilePath"
				, f.SavedName "SavedName"
				, f.CompanyCode "CompanyCode"
			 	, f.Size_ "Size"
			 	, f.Extention "Extention"
			 	, TO_CHAR(f.RegistDate, 'YYYY-MM-DD HH24:MI:SS') AS "FileRegistDate"
			 	, f.SaveType "SaveType"
			 	, f.RegisterCode "FileRegisterCode"
		 FROM  sys_file f 
		WHERE  f.ObjectID =  #{prjSeq}
		  AND  ServiceType = 'CollabPrj' 
		  AND  MessageID = 0 
		<if test="tagtype != '' and tagtype != 'CTAG'">
			<trim prefix="AND" prefixOverrides="AND |OR">
			${tagData}
			</trim>
		</if>
		<include refid="searchMyTask" />
	</select>
	
	<select id="getProjectFileCnt" parameterType="cmap" resultType="java.lang.Long">
	/* collab.project.getProjectFileCnt */
	   SELECT  COUNT(*)
		 FROM  sys_file f 
		WHERE  f.ObjectID =  #{prjSeq}
		  AND  ServiceType = 'CollabPrj' 
		  AND  MessageID = 0 
		<if test="tagtype != '' and tagtype != 'CTAG'">
			<trim prefix="AND" prefixOverrides="AND |OR">
			${tagData}
			</trim>
		</if>
		<include refid="searchMyTask" />
	</select>	
	
	<update id="updateSectionChange" parameterType="cmap">
	/* collab.project.updateSectionChange */
		UPDATE COLLAB_TASK_MAP
		   SET SectionSeq = #{sectionSeq}
		 WHERE PrJSeq =  #{prjSeq}
		   AND PrjType = #{prjType}
		   AND TaskSeq = #{taskSeq}
	</update>
	
	<update id="updateSectionOrder"   parameterType="cmap"  >
	/* collab.project.updateSectionOrder */
		UPDATE COLLAB_SECTION
		   SET SectionOrder = #{sectionOrder}
		 WHERE PrJSeq =  #{prjSeq}
		   AND PrjType = #{prjType}
		   AND SectionSeq = #{sectionSeq}
	</update>
	
	<!-- 프로젝트 즐겨찾기 추가 -->
	<insert id="addProjectFavorite"   parameterType="cmap">
	/* collab.project.addProjectFavorite */
		MERGE INTO COLLAB_PROJECT_FAVORITE
		USING DUAL
			ON (PRJSEQ = #{prjSeq} AND USERCODE = #{userCode})
		WHEN MATCHED THEN
		UPDATE SET
			RegisterCode = #{USERID}
			, RegisteDate = SYSDATE
		WHEN NOT MATCHED THEN
			INSERT (PrjSeq, UserCode, RegisterCode, RegisteDate)
			VALUES ( #{prjSeq}, #{userCode}, #{USERID}, SYSDATE )
	</insert>

	<!-- 프로젝트 즐겨찾기 삭제 -->
	<delete id="deleteProjectFavorite"   parameterType="cmap">
	/* collab.project.deleteProjectFavorite */
		DELETE FROM COLLAB_PROJECT_FAVORITE 
		WHERE PrjSeq =  #{prjSeq}
		 	AND UserCode = #{userCode}
	</delete>
	
	<!-- 프로젝트별 알림설정 -->
	<insert id="saveProjectAlarm" parameterType="cmap">
	/* collab.project.saveProjectAlarm */
		MERGE INTO COLLAB_PROJECT_MESSAGING
		USING DUAL
			ON (PRJSEQ = #{prjSeq} AND USERCODE = #{userCode})
		WHEN MATCHED THEN
		UPDATE SET
			RegisterCode = #{USERID}
			, RegisteDate = SYSDATE
		WHEN NOT MATCHED THEN
			INSERT (PrjSeq, UserCode, RegisterCode, RegisteDate)
			VALUES ( #{prjSeq},#{userCode},#{USERID},SYSDATE)
	</insert>
	
	<!-- 프로젝트별 알림해제 -->
	<delete id="cencelProjectAlarm" parameterType="cmap">
	/* collab.project.cencelProjectAlarm */
		DELETE FROM COLLAB_PROJECT_MESSAGING 
		WHERE PrjSeq =  #{prjSeq}
		 	AND UserCode = #{userCode}
	</delete>
	
	<!-- 진행중 프로젝트 카운트-->
	<select id="getGoingProjectCnt"  parameterType="cmap" resultType="java.lang.Long">
	/* collab.common.getGoingProjectCnt */
		SELECT COUNT(PrjSeq)
		FROM   (
			SELECT distinct cp.PrjSeq
				,(SELECT Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName)
							FROM COLLAB_PROJECT_MANAGER ctm 
						   JOIN SYS_OBJECT_USER sou on ctm.userCode = sou.userCode
							WHERE ctm.PrjSeq = cp.PrjSeq
								AND ROWNUM <![CDATA[<=]]> 1) PmUser
			  FROM COLLAB_PROJECT cp
			  LEFT  JOIN COLLAB_PROJECT_MEMBER cpm ON cp.PrjSeq = cpm.PrjSeq AND cpm.UserCode = #{USERID}
		LEFT  JOIN COLLAB_PROJECT_MANAGER cpn ON cp.PrjSeq = cpn.PrjSeq AND cpn.UserCode = #{USERID}
		LEFT  JOIN COLLAB_PROJECT cpr ON cp.PrjSeq = cpr.PrjSeq AND cpr.RegisterCode = #{USERID}
		LEFT  JOIN COLLAB_PROJECT_VIEWER cpv ON cp.PrjSeq = cpv.PrjSeq AND cpv.UserCode = #{USERID}
			 WHERE 1=1 
			 <if test='isSaaS == "Y"'>
			 	 AND cp.CompanyCode = #{CompanyCode}
			 </if>
			 <if test='inClose == null or inClose == ""'>
			   AND cp.IsClose='N'
			 </if>
			 <if test='isAdmin == null or isAdmin == ""'>
			   AND (cpm.PrjSeq IS NOT NULL OR  cpn.PrjSeq IS NOT NULL OR   cpr.PrjSeq IS NOT NULL 
			   	<if test='includeViewer == "Y"'>
			   	OR   cpv.PrjSeq IS NOT NULL 
			   	</if>
			   )
			 </if>
			 
			<if test="seValue != null and seValue != ''">
				<choose>
					<when test ="seColumn == 'PrjName'.toString()">
						AND cp.PrjName like ('%' || #{seValue} || '%')
					</when>
					<when test ="seColumn == 'PmUser'.toString()">
					    AND (SELECT Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName)
							FROM COLLAB_PROJECT_MANAGER ctm 
						   JOIN SYS_OBJECT_USER sou on ctm.userCode = sou.userCode
							WHERE ctm.PrjSeq = cp.PrjSeq
								AND ROWNUM <![CDATA[<=]]> 1) like ('%' || #{seValue} || '%')
					</when>
					<when test ="seColumn == 'RegisterName'.toString()">
					    AND cp.Remark like ('%' || #{seValue} || '%')
					</when>
					<otherwise>
						AND cp.PrjName like ('%' || #{seValue} || '%')
				</otherwise>
				</choose>
			</if>
			
			 <if test="prjStatus != null and prjStatus != ''">
				AND cp.PrjStatus = #{prjStatus}
		  	 </if>
		) p   
	</select>
	
	<!-- 진행중 프로젝트 리스트-->
	<select id="getGoingProject"  parameterType="cmap" resultType="cmap">
	/* collab.common.getGoingProject */
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingHeader" />
		</if>
		SELECT PrjSeq as "PrjSeq"
			, PrjName as "PrjName"
			, PmUser as "PmUser"
			, PrjStatus as "PrjStatus"
			, ProgRate as "ProgRate"
			, IsClose as "IsClose"
			, TO_CHAR(CloseDate, 'YYYY-MM-DD HH24:MI') as "CloseDate" 
			, PrjColor as "PrjColor"
			, Remark as "Remark"
			, StartDate as "StartDate"
			, EndDate as "EndDate"
			, RegisterCode as "RegisterCode"
			, TO_CHAR(RegisteDate, 'YYYY-MM-DD HH24:MI') as "RegisteDate"
			, IsAlarm as "IsAlarm"
		FROM   (
			SELECT distinct cp.PrjSeq, cp.PrjName, cp.PrjStatus, cp.ProgRate, cp.IsClose, cp.CloseDate, cp.PrjColor, cp.Remark, cp.StartDate, cp.EndDate, cp.RegisterCode, cp.RegisteDate
				 ,(SELECT Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName)
							FROM COLLAB_PROJECT_MANAGER ctm 
						   JOIN SYS_OBJECT_USER sou on ctm.userCode = sou.userCode
							WHERE ctm.PrjSeq = cp.PrjSeq
								AND ROWNUM <![CDATA[<=]]> 1) PmUser
				 , NVL((SELECT COUNT(*) FROM COLLAB_PROJECT_MESSAGING WHERE cp.PrjSeq = PrjSeq AND UserCode = #{USERID}),0) IsAlarm
				  FROM COLLAB_PROJECT cp
			LEFT  JOIN COLLAB_PROJECT_MEMBER cpm ON cp.PrjSeq = cpm.PrjSeq AND cpm.UserCode = #{USERID}
		LEFT  JOIN COLLAB_PROJECT_MANAGER cpn ON cp.PrjSeq = cpn.PrjSeq AND cpn.UserCode = #{USERID}
		LEFT  JOIN COLLAB_PROJECT cpr ON cp.PrjSeq = cpr.PrjSeq AND cpr.RegisterCode = #{USERID}
		LEFT  JOIN COLLAB_PROJECT_VIEWER cpv ON cp.PrjSeq = cpv.PrjSeq AND cpv.UserCode = #{USERID}
			 WHERE 1=1 
			 <if test='isSaaS == "Y"'>
			 	 AND cp.CompanyCode = #{CompanyCode}
			 </if>
			 <if test='inClose == null or inClose == ""'>
			   AND cp.IsClose='N'
			 </if>
			 <if test='isAdmin == null or isAdmin == ""'>
			   AND (cpm.PrjSeq IS NOT NULL OR  cpn.PrjSeq IS NOT NULL OR   cpr.PrjSeq IS NOT NULL 
			   	<if test='includeViewer == "Y"'>
			   	OR   cpv.PrjSeq IS NOT NULL 
			   	</if>
			   )
			 </if>
			 
			<if test="seValue != null and seValue != ''">
				<choose>
					<when test ="seColumn == 'PrjName'.toString()">
						AND cp.PrjName like ('%' || #{seValue} || '%')
					</when>
					<when test ="seColumn == 'PmUser'.toString()">
					    AND (SELECT Fn_BaseGetDictionary_S(#{lang},sou.MultiDisplayName)
							FROM COLLAB_PROJECT_MANAGER ctm 
						   JOIN SYS_OBJECT_USER sou on ctm.userCode = sou.userCode
							WHERE ctm.PrjSeq = cp.PrjSeq
								AND ROWNUM <![CDATA[<=]]> 1) like ('%' || #{seValue} || '%')
					</when>
					<when test ="seColumn == 'RegisterName'.toString()">
					    AND cp.Remark like ('%' || #{seValue} || '%')
					</when>
					<otherwise>
						AND cp.PrjName like ('%' || #{seValue} || '%')
				</otherwise>
				</choose>
			</if>
			
			 <if test="prjStatus != null and prjStatus != ''">
				AND cp.PrjStatus = #{prjStatus}
		  	 </if>
			 
				) p  
				 
		ORDER BY RegisteDate desc
		
		<if test="(pageSize != null and pageSize >= 0) and (pageOffset != null and pageOffset >= 0)">
			<include refid="oracle.include.pagingFooter" />
		</if>
	</select>
	
	<select id="getSurveyInfo" parameterType="cmap" resultType="cmap">
		SELECT	A.SurveyID "SurveyID"
		  		, State "State" 
				, case when C.TargetCode is not null then 'Y' else 'N' end as "IsResponse"
				, case when d.RespondentID is not null then 'Y' else 'N' end as "IsAnswer" 
		 FROM survey A
	LEFT JOIN survey_target_respondent C ON A.SurveyID = C.SurveyID AND C.TargetCode = #{userCode} AND C.TargetType = 'UR'
	LEFT JOIN survey_respondent d ON A.SurveyID = d.SurveyID AND d.RespondentCode = #{userCode}
		WHERE a.surveyID= #{surveyID}  
	</select>	
</mapper>

