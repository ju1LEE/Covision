<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="coviflow">
    <insert id="insertLegacy" parameterType="hashmap">
    <![CDATA[
        INSERT into covi_approval4j.dbo.jwf_legacy
        (
        	Parameters,
        	Mode,
        	State,
        	EventTime,
        	ErrorMessage,
        	ErrorStackTrace,
        	ErrorClass,
        	DeleteTime,
        	FormInstID,
        	ProcessID,
			FormPrefix,
			DocNumber,
			ApproverId,
			ApvMode,
			FormInfoExt,
			ApprovalContext
        )
        VALUES
        (
        	#{parameters},
        	#{mode},
        	#{state},
        	#{eventTime},
        	#{errorMessage},
        	#{errorStackTrace},
        	#{errorClass},
        	#{deleteTime},
        	#{FormInstID},
        	#{ProcessID},
			#{FormPrefix},
			#{DocNumber},
			#{ApproverId},
			#{ApvMode},
			#{FormInfoExt},
			#{ApprovalContext}
        );
    ]]>
    
    SET IDENTITY_INSERT covi_approval4j.dbo.jwf_legacy OFF;
	</insert>
    
    <insert id="insertErrorLog" parameterType="hashmap">
    <![CDATA[
        INSERT into covi_approval4j.dbo.jwf_error
        (
        	ProcessDefID,
        	ProcessInsID,
        	ExecutionID,
        	TaskID,
        	ServerIP,
        	ErrorKind,
        	ErrorTime,
        	ErrorMessage,
        	ErrorStackTrace,
        	ErrorClass
        )
        VALUES
        (
        	#{processDefID},
        	#{processInsID},
        	#{executionID},
        	#{taskID},
        	#{serverIP},
        	#{errorKind},
        	#{errorTime},
        	#{errorMessage},
        	#{errorStackTrace},
        	#{errorClass}
        );
    ]]>
	</insert>
	
 	<insert id="insertAppvLinePublic" parameterType="hashmap">
    <![CDATA[
        INSERT into covi_approval4j.dbo.jwf_domaindata
        (
            DomainDataName,
            ProcessID, 
            DomainDataContext
        )
        VALUES
        (
            'APPROVERCONTEXT', 
            #{processID}, 
            #{domainDataContext}
        );
    ]]>
	</insert>
	
 	<update id="updateAppvLinePublic" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_domaindata 
 	    SET DomainDataContext = #{domainDataContext}
 	    WHERE ProcessID = #{processID};
 	</update>
 	
 	<update id="updateAppvLinePublicForOU" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_domaindata 
 	    SET DomainDataContext = #{domainDataContext}
 	    WHERE ProcessID IN 
                <foreach collection="processIdList" item="item" index="index" separator="," open="(" close=")">
                    #{item}
                </foreach>
 	</update>
 	
 	<update id="updateAppvLinePublicForSub" parameterType="hashmap">
		UPDATE d
		SET DomainDataContext = #{domainDataContext}
		from covi_approval4j.dbo.jwf_domaindata AS d
		INNER JOIN covi_approval4j.dbo.jwf_process AS p
		ON d.ProcessID = p.ProcessID
		WHERE P.ParentProcessID = #{processID};
 	</update>

 	<select id="selectAllAppvLinePublic" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
		SELECT P.ProcessID AS ProcessID
		FROM covi_approval4j.dbo.jwf_domaindata D with(nolock)
		INNER JOIN covi_approval4j.dbo.jwf_process P with(nolock)
		ON D.ProcessID = P.ProcessID
		WHERE P.FormInstID = #{formInstID}
	]]>
    </select>
 	
 	<update id="updateAllAppvLinePublic" parameterType="hashmap">
		UPDATE d
		SET DomainDataContext = #{domainDataContext}
		from covi_approval4j.dbo.jwf_domaindata AS d
		INNER JOIN covi_approval4j.dbo.jwf_process AS p
		ON d.ProcessID = p.ProcessID
		WHERE P.FormInstID = #{formInstID}
 	</update>
 	
 	<insert id="insertAppvLinePrivate" parameterType="hashmap">
    <![CDATA[
        INSERT into covi_approval4j.dbo.jwf_privatedomaindata
        (
            CustomCategory, 
            DefaultYN,
            DisplayName,
            OwnerID,
            Abstract,
            Description,
            PrivateContext
        )
        VALUES
        (
        	'APPROVERCONTEXT',
            #{defaultYN}, 
            #{displayName}, 
            #{ownerID},
            #{abstract},
            #{description},
            #{privateContext}
        );
    ]]>
	</insert>
	
	<select id="selectProcessInitiatorInfo" parameterType="hashmap" resultType="hashmap">
		SELECT 
			InitiatorID
			, InitiatorName
			, InitiatorUnitID
			, InitiatorUnitName
		FROM covi_approval4j.dbo.jwf_process
		WHERE ProcessID = #{processID};
    </select>
	
 	<insert id="insertProcess" parameterType="hashmap">
 	SET IDENTITY_INSERT covi_approval4j.dbo.jwf_process ON;
 	
    <![CDATA[
        INSERT into covi_approval4j.dbo.jwf_process
        (
            ProcessID, 
            ProcessKind,
            ParentProcessID,
            ParentInstanceID,
            ProcessDescriptionID,
            ProcessName,
            DocSubject,
            BusinessState,
            InitiatorID,
            InitiatorName,
            InitiatorUnitID,
            InitiatorUnitName,
            FormInstID,
            ProcessState,
            InitiatorSIPAddress,
            StartDate
        )
        VALUES
        (
        	#{processID},
            #{processKind}, 
            #{parentProcessID}, 
            #{parentInstanceID},
            #{processDescriptionID},
            #{processName},
            #{docSubject},
            #{businessState},
            #{initiatorID},
            #{initiatorName},
            #{initiatorUnitID},
            #{initiatorUnitName},
            #{formInstID},
            #{processState},
            #{initiatorSIPAddress},
            #{startDate}
        );
    ]]>
    
    SET IDENTITY_INSERT covi_approval4j.dbo.jwf_process OFF;
	</insert>
	
 	<insert id="insertProcessDesc" parameterType="hashmap">
 		<selectKey keyProperty="ProcessDescriptionID" resultType="Integer" order="AFTER">
        INSERT into covi_approval4j.dbo.jwf_processdescription
        (
            FormInstID, 
            FormID,
            FormPrefix,
            FormName,
            FormSubject,
            IsSecureDoc,
            IsFile,
            FileExt,
            IsComment,
            ApproverCode,
            ApproverName,
            ApprovalStep,
            ApproverSIPAddress,
            IsReserved,
            ReservedGubun,
            ReservedTime,
            Priority,
            IsModify,
            Reserved1,
            Reserved2,
            BusinessData1,
            BusinessData2,
            BusinessData3,
            BusinessData4,
            BusinessData5,
            BusinessData6,
            BusinessData7,
            BusinessData8,
            BusinessData9,
            BusinessData10
        )
        VALUES
        (
        	#{formInstID},
            #{formID},
            #{formPrefix}, 
            #{formName}, 
            #{formSubject},
            #{isSecureDoc},
            #{isFile},
            #{fileExt},
            #{isComment},
            #{approverCode},
            #{approverName},
            #{approvalStep},
            #{approverSIPAddress},
            #{isReserved},
            #{reservedGubun},
            #{reservedTime},
            #{priority},
            #{isModify},
            #{reserved1},
            #{reserved2},
            #{BusinessData1},
            #{BusinessData2},
            #{BusinessData3},
            #{BusinessData4},
            #{BusinessData5},
            #{BusinessData6},
            #{BusinessData7},
            #{BusinessData8},
            #{BusinessData9},
            #{BusinessData10}
        );
    	
			SELECT SCOPE_IDENTITY();
		</selectKey>
	</insert>
	
 	<insert id="insertCirculationDesc" parameterType="hashmap">
 		<selectKey keyProperty="CirculationBoxDescriptionID" resultType="Integer" order="AFTER">
        INSERT into covi_approval4j.dbo.jwf_circulationboxdescription
        (
            FormInstID, 
            FormID,
            FormPrefix,
            FormName,
            FormSubject,
            IsSecureDoc,
            IsFile,
            FileExt,
            IsComment,
            ApproverCode,
            ApproverName,
            ApproverSIPAddress,
            IsReserved,
            ReservedGubun,
            ReservedTime,
            Priority,
            IsModify,
            Reserved1,
            Reserved2
        )
        VALUES
        (
        	#{formInstID},
            #{formID},
            #{formPrefix}, 
            #{formName}, 
            #{formSubject},
            #{isSecureDoc},
            #{isFile},
            #{fileExt},
            #{isComment},
            #{approverCode},
            #{approverName},
            #{approverSIPAddress},
            #{isReserved},
            #{reservedGubun},
            #{reservedTime},
            #{priority},
            #{isModify},
            #{reserved1},
            #{reserved2}
        );
    	
			SELECT SCOPE_IDENTITY();
		</selectKey>
	</insert>
 	 	
 	<insert id="insertCirculation" parameterType="hashmap">
    <![CDATA[
        INSERT into covi_approval4j.dbo.jwf_circulationbox
        (
            ProcessID, 
            CirculationBoxDescriptionID,
            FormInstID,
            ReceiptID,
            ReceiptType,
            ReceiptName,
            ReceiptDate,
            Kind,
            State,
            ReadDate,
            SenderID,
            SenderName,
            Subject,
            Comment,
            DataState,
            RegID,
            RegDate,
            ModID,
            ModDate
        )
        VALUES
        (
        	#{processID},
            #{circulationBoxDescriptionID}, 
            #{formInstID}, 
            #{receiptID},
            #{receiptType},
            #{receiptName},
            #{receiptDate},
            #{kind},
            #{state},
            #{readDate},
            #{senderID},
            #{senderName},
            #{subject},
            #{comment},
            #{dataState},
            #{regID},
            #{regDate},
            #{modID},
            #{modDate}
        );
    ]]>
	</insert>
 	
 	<update id="updateCirculation" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_circulationbox
 	    SET DataState = #{dataState}, ModID = #{modID}, DeletedDate = GETDATE(), ModDate = GETDATE()
 	    WHERE FormInstID = #{formInstID};
 	</update>
 	
 	<update id="updateCirculationForSubject" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_circulationbox
 	    SET Subject = #{subject}
 	    WHERE FormInstID = #{formInstID};
 	</update>
 	
  	<insert id="insertWorkItemDesc" parameterType="hashmap">
  		<selectKey keyProperty="WorkItemDescriptionID" resultType="Integer" order="AFTER">
        INSERT into covi_approval4j.dbo.jwf_workitemdescription
        (
            FormInstID, 
            FormID,
            FormName,
            FormSubject,
            IsSecureDoc,
            IsFile,
            FileExt,
            IsComment,
            ApproverCode,
            ApproverName,
            ApprovalStep,
            ApproverSIPAddress,
            IsReserved,
            ReservedGubun,
            ReservedTime,
            Priority,
            IsModify,
            Reserved1,
            Reserved2
        )
        VALUES
        (
        	#{formInstID},
            #{formID}, 
            #{formName}, 
            #{formSubject},
            #{isSecureDoc},
            #{isFile},
            #{fileExt},
            #{isComment},
            #{approverCode},
            #{approverName},
            #{approvalStep},
            #{approverSIPAddress},
            #{isReserved},
            #{reservedGubun},
            #{reservedTime},
            #{priority},
            #{isModify},
            #{reserved1},
            #{reserved2}
        );
    	
			SELECT SCOPE_IDENTITY();
		</selectKey>
	</insert>	
 
 	<insert id="insertWorkItem" parameterType="hashmap">
 		<selectKey keyProperty="WorkItemID" resultType="Integer" order="AFTER">
        INSERT into covi_approval4j.dbo.jwf_workitem
        (
            TaskID,
            ProcessID,
            PerformerID,
            WorkItemDescriptionID,
            Name,
            DSCR,
            Priority,
            ActualKind,
            UserCode,
            UserName,
            DeputyID,
            DeputyName,
            State,
            Created,
            FinishRequested,
            Finished,
            Limit,
            LastRepeated,
            Finalized,
            Deleted,
            InlineSubProcess,
            Charge,
            BusinessData1,
            BusinessData2,
            BusinessData3,
            BusinessData4,
            BusinessData5,
            BusinessData6,
            BusinessData7,
            BusinessData8,
            BusinessData9,
            BusinessData10
        )
        VALUES
        (
        	#{taskID},
        	#{processID},
        	#{performerID},
            #{workItemDescriptionID}, 
            #{name}, 
            #{dscr},
            #{priority},
            #{actualKind},
            #{userCode},
            #{userName},
            #{deputyID},
            #{deputyName},
            #{state},
            #{created},
            #{finishRequested},
            #{finished},
            #{limit},
            #{lastRepeated},
            #{finalized},
            #{deleted},
            #{inlineSubProcess},
            #{charge},
            #{businessData1},
            #{businessData2},
            #{businessData3},
            #{businessData4},
            #{businessData5},
            #{businessData6},
            #{businessData7},
            #{businessData8},
            #{businessData9},
            #{businessData10}
        );
        
			SELECT SCOPE_IDENTITY();
		</selectKey>
    </insert>
  	
 	<insert id="insertPerformer" parameterType="hashmap">
 		<selectKey keyProperty="PerformerID" resultType="Integer" order="AFTER">
        INSERT into covi_approval4j.dbo.jwf_performer
        (
            WorkitemID,
            AllotKey,
            UserCode,
            UserName,
            ActualKind,
            State,
            SubKind
        )
        VALUES
        (
        	#{workitemID},
        	#{allotKey},
            #{userCode}, 
            #{userName}, 
            #{actualKind},
            #{state},
            #{subKind}
        );
        
			SELECT SCOPE_IDENTITY();
		</selectKey>
    </insert>
    
 	<update id="updatePerformer" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_performer 
 	    SET SubKind = #{subkind} 
 	    WHERE WorkItemID = #{workItemID};
 	</update>
 	
 	<update id="updatePerformerForCharge" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_performer 
 	    SET State = #{state} 
 	    WHERE PerformerID = #{performerID};
 	</update>
 	
 	<update id="updateProcessDesc" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_processdescription 
 	    SET ApproverCode = #{approverCode}, ApproverName = #{approverName}, ApprovalStep = #{approvalStep}, ApproverSIPAddress = #{approverSIPAddress}
 	    WHERE ProcessDescriptionID = #{processDescriptionID};
 	</update>
 	
 	<update id="updateProcessDescForModify" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_processdescription 
 	    	<set>
 	    	    <if test="subject != null">FormSubject = #{subject},</if>
 	    	    <if test="isModify != null">IsModify = #{isModify},</if>
 	    	    <if test="isComment != null">IsComment = #{isComment},</if>
 	    	    <if test="isFile != null">IsFile = #{isFile}</if>
 	    	</set>
 	    <choose>
            <when test="processDescriptionID != null and processDescriptionID != '' ">
            	WHERE ProcessDescriptionID = #{processDescriptionID};
            </when>
            <otherwise>
                WHERE FormInstID = #{formInstID};
            </otherwise>
        </choose>
 	</update>
 	
 	<update id="updateCirculationboxDescForModify" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_circulationboxdescription 
 	    	<set>
 	    	    <if test="subject != null">FormSubject = #{subject},</if>
 	    	    <if test="isModify != null">IsModify = #{isModify},</if>
 	    	    <if test="isComment != null">IsComment = #{isComment},</if>
 	    	    <if test="isFile != null">IsFile = #{isFile}</if>
 	    	</set>
 	    WHERE FormInstID = #{formInstID};
 	</update>
 	
	<update id="updateProcessDescForHold" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_processdescription 
 	    SET IsReserved = #{isReserved}
 	    WHERE ProcessDescriptionID = #{processDescriptionID};
 	</update>
 	
 	<update id="updateProcessDescForHoldAll" parameterType="hashmap">	
		UPDATE A
		SET IsReserved = #{isReserved}
		FROM covi_approval4j.dbo.jwf_processdescription A
		INNER JOIN covi_approval4j.dbo.jwf_process B ON A.ProcessDescriptionID = B.ProcessDescriptionID
		WHERE B.FormInstID = #{formInstID};
	</update>	
 	
 	<update id="updateWorkItemDescForModify" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitemdescription 
 	    SET IsModify = #{isModify}
 	    WHERE WorkItemDescriptionID = #{workItemDescriptionID};
 	</update>
 	
 	<select id="selectCharge" parameterType="hashmap" resultType="hashmap">
		select top 1 WorkItemID, PerformerID
		from covi_approval4j.dbo.jwf_workitem
		where ProcessID = #{processID} AND Name='Charge'
		order by workitemid desc;
    </select>
 	
 	<update id="updateWorkItemForCharge" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET UserCode = #{userCode}, UserName = #{userName} 
 	    WHERE WorkItemID = #{workItemID};
 	</update>
 	
 	<update id="updateWorkItem" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET PerformerID = #{performerID}
 	    WHERE WorkItemID = #{workItemID};
 	</update>
 	
 	<update id="updateWorkitemArchive" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem
 	    SET PIBusinessState = #{piBusinessState}
 	    WHERE ProcessID IN (SELECT ProcessID
							 	    FROM covi_approval4j.dbo.jwf_process 
							 	    WHERE ProcessID = #{processID}
							 	    <if test="parentYN != null and parentYN != '' and (parentYN eq 'Y'.toString())">
							 	    	or ParentProcessID = #{processID}
							 	    </if>)
 	</update>
 	
 	<update id="updateWorkItemForReject" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET State = #{state}, Finished = GETDATE()
 	    <if test="isMobile != null and isMobile != '' and (isMobile eq 'Y'.toString())">
 	        , BusinessData2 = 'MOBILE'
 	    </if>
 	    WHERE ProcessID = #{processID}
 	    AND Finished IS NULL;
 	</update>
 	
 	<update id="updateWorkItemForResult" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem
 	    SET State = #{state}, Finished = GETDATE()
 	    <if test="isMobile != null and isMobile != '' and (isMobile eq 'Y'.toString())">
 	        , BusinessData2 = 'MOBILE'
 	    </if>
 	    <if test="isBatch != null and isBatch != '' and (isBatch eq 'Y'.toString())">
 	        , BusinessData3 = 'BATCH'
 	    </if>
 	    <choose>
            <when test="processID != null and processID != '' ">
            	WHERE processID = #{processID};
            </when>
            <otherwise>
                WHERE WorkItemID = #{workItemID};
            </otherwise>
        </choose>
 	</update>
 	
 	<update id="updateWorkItemUsingTaskId" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET State = #{state}, Finished = GETDATE(), Charge = #{charge}
 	    WHERE TaskID = #{taskID};
 	</update>
 	
 	<update id="updateWorkItemState" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET State = #{state}
 	    WHERE TaskID = #{taskID};
 	</update>
 	
 	<update id="updateWorkItemStateUsingWorkitemId" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem
 	    SET State = #{state}
 	    WHERE WorkItemID = #{workItemID};
 	</update>
 	
 	<update id="deleteWorkItemUsingTaskId" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET Deleted = GETDATE()
 	    WHERE TaskID = #{taskID};
 	</update>
 	
 	<update id="updateWorkItemForChange" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET Name = #{name}, TaskID = #{taskID}, State = #{state}, Created = #{created}
 	    <if test="deputyID != null and deputyName != null">
 	    	, DeputyID = #{deputyID}, DeputyName = #{deputyName}
 	    </if>
 	    WHERE WorkItemID = #{workItemID};
 	</update>
 	
 	<update id="updateWorkItemForReview" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET ProcessID = #{processID}, Name = #{name}, TaskID = #{taskID}, State = #{state}, Created = #{created}
 	    WHERE WorkItemID = #{workItemID};
 	</update>
 	
 	<update id="updateWorkItemForApproveCancel" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET Name = #{name}, State = #{state} 
 	    WHERE WorkItemID = #{workItemID};
 	</update>
 	
 	<update id="updateWorkItemForDeputy" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET DeputyID = '', DeputyName = '' 
 	    WHERE TaskID = #{taskID};
 	</update>
 	
 	<update id="updateWorkItemForDateChange" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET Created = #{created}, Finished = #{finished}
 	    WHERE WorkItemID = #{workItemID}
 	</update>
 	
 	<update id="updateProcess" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_process 
 	    SET BusinessState = #{businessState}, ProcessState = #{processState}, EndDate = GETDATE()
 	    WHERE ProcessID = #{processID}
 	    <if test="parentYN != null and parentYN != '' and (parentYN eq 'Y'.toString())">
 	    	or ParentProcessID = #{processID}
 	    </if>
 	    ;
 	</update>
 	
 	<update id="updateProcessBusinessState" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_process 
 	    SET BusinessState = #{businessState}, ProcessState = #{processState}
 	    WHERE ProcessID = #{processID};
 	</update>
 	
 	<update id="updateProcessState" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_process 
 	    SET ProcessState = #{processState}
 	    WHERE ProcessID = #{processID};
 	</update>
 	
	<update id="updateProcessForWithdraw" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_process 
 	    SET ProcessState = #{processState}, EndDate = GETDATE()
 	    <choose>
			<when test="processID != null and processID != '' ">
				WHERE processID = #{processID};
			</when>
			<otherwise>
				WHERE FormInstID = #{formInstID};
			</otherwise>
		</choose>
 	</update>
 	
	<update id="updateProcessForSubject" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_process 
 	    SET DocSubject = #{subject}
 	    WHERE FormInstID = #{formInstID};
 	</update>
 	
 	<insert id="insertProcessArchive" parameterType="hashmap">
 		update covi_approval4j.dbo.jwf_process
  			set formName = #{formName}, 
	  			formPrefix = #{formPrefix}, 
	  			divisionKind = #{divisionKind},
	  			docFolder = #{docFolder},
	  			docFolderName = #{docFolderName},
	  			saveTermExpired = #{saveTermExpired},
	  			ownerUnitID = #{ownerUnitID},
	  			entCode = #{entCode}
 		where ProcessID = #{processID}
    </insert>
    
    <update id="updateProcessArchive" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_process 
 	    SET BusinessState = #{businessState}, ProcessState = #{processState}, EndDate = now(3)
 	    WHERE ProcessID = #{processID}
 	    <if test="parentYN != null and parentYN != '' and (parentYN eq 'Y'.toString())">
 	    	or ParentProcessID = #{processID}
 	    </if>
 	</update>
    
    
 	<insert id="insertProcessDescriptionArchive" parameterType="hashmap">
 		UPDATE covi_approval4j.dbo.jwf_processdescription
 		SET covi_approval4j.dbo.jwf_processdescription.DocNo = covi_approval4j.dbo.jwf_processdescription.Reserved1
 		WHERE EXISTS (
 			SELECT 'x' FROM covi_approval4j.dbo.jwf_process b
 			WHERE b.processdescriptionid = covi_approval4j.dbo.jwf_processdescription.processdescriptionid
 			AND b.processid = #{processID}
 		)
    </insert>
    
 	<insert id="insertWorkitemArchive" parameterType="hashmap">
 		UPDATE A
 		SET SubKind =  CASE B.SubKind WHEN 'R' THEN 'REQCMP' ELSE B.SubKind END,
 			IsBatch = CASE BusinessData2 WHEN 'BATCH' THEN 'Y' ELSE 'N' END,
 			IsMobile = CASE BusinessData2 WHEN 'MOBILE' THEN 'Y' ELSE 'N' END,
 			PIDeleted = C.DeleteDate,
 			PIBusinessState = #{piBusinessState},
 			PIFinished = C.EndDate
    	FROM covi_approval4j.dbo.jwf_workitem A
		JOIN covi_approval4j.dbo.jwf_performer B ON A.WorkitemID = B.WorkitemID
    	JOIN covi_approval4j.dbo.jwf_process C ON A.ProcessID = C.ProcessID
    	WHERE A.ProcessID = #{processID} 
    	<choose>
            <when test='subkindList != null'>
                AND B.SubKind NOT IN 
                <foreach collection="subkindList" item="item" index="index" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </when>
        </choose>
        AND B.State != 2
        <!-- 지정반려한 이력이 화면에 표시되어 조건 추가함. -->
        <![CDATA[
        	AND	A.State < 530
		]]> 
    </insert>
    
 	<insert id="insertWorkitemDescriptionArchive" parameterType="hashmap"><!-- deprecated -->
 		SET IDENTITY_INSERT covi_approval4j_archive.dbo.jwf_workitemdescriptionarchive ON;
 	
 	    insert into covi_approval4j_archive.dbo.jwf_workitemdescriptionarchive
 	    ([WorkItemDescriptionArchiveID]
	      ,[FormInstID]
	      ,[FormID]
	      ,[FormName]
	      ,[FormSubject]
	      ,[IsSecureDoc]
	      ,[IsFile]
	      ,[FileExt]
	      ,[IsComment]
	      ,[ApproverCode]
	      ,[ApproverName]
	      ,[ApprovalStep]
	      ,[ApproverSIPAddress]
	      ,[IsReserved]
	      ,[ReservedGubun]
	      ,[ReservedTime]
	      ,[Priority]
	      ,[IsModify]
	      ,[Reserved1]
	      ,[Reserved2])
 	    select a.* 
 	    from covi_approval4j.dbo.jwf_workitemdescription a with(nolock)
 	    join covi_approval4j.dbo.jwf_workitem b with(nolock) on a.WorkItemDescriptionID = b.WorkItemDescriptionID
 	    join covi_approval4j.dbo.jwf_performer c with(nolock) on b.WorkitemID=c.WorkitemID 
    	where b.ProcessID = #{processID} 
    	<choose>
            <when test='subkindList != null'>
                AND c.SubKind NOT IN 
                <foreach collection="subkindList" item="item" index="index" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </when>
        </choose>
        AND c.State != 2
        
        SET IDENTITY_INSERT covi_approval4j_archive.dbo.jwf_workitemdescriptionarchive OFF;
    </insert>
    
 	<insert id="insertDomainArchive" parameterType="hashmap">
    </insert> 	
 	
 	<select id="selectReceiptPersonInfo" parameterType="hashmap" resultType="hashmap">
        SELECT 
			BG.DeptCode AS DeptID
			, BG.DeptName
			, BG.JobLevelCode + ';' + BG.JobLevelName AS JobLevel
			, BG.JobTitleCode + ';' + BG.JobTitleName AS JobTitle
			, BG.JobPositionCode + ';' + BG.JobPositionName AS JobPosition
		FROM covi_smart4j.dbo.sys_object_user U WITH (NOLOCK)
		JOIN covi_smart4j.dbo.sys_object_user_basegroup BG WITH (NOLOCK) ON U.UserCode = BG.UserCode
		WHERE U.UserCode = #{urCode}
    </select>
    
 	<select id="selectDeputy" parameterType="hashmap" resultType="hashmap">
 	    <!-- [2019-02-19 MOD] gbhwang 대결 설정 시 옵션 추가 -->
		<![CDATA[
		 select count(*) AS Count, DeputyCode, DeputyName, DeputyOption
		from covi_smart4j.dbo.sys_object_user_approval with(nolock)
		where UserCode = #{urCode} and UseDeputy = 'Y' and left(#{today},10) >= DeputyFromDate and left(#{today},10) <= DeputyToDate
		group by DeputyCode, DeputyName, DeputyOption
		]]> 
    </select>
    
 	<select id="selectDeputyCount" parameterType="hashmap" resultType="Integer">
 	    <![CDATA[ 
		select count(*) AS Count
		from covi_approval4j.dbo.jwf_workitem with(nolock)
		where TaskID = #{taskID} and (DeputyID is NOT NULL AND DeputyID <> '');
		]]>
    </select>
 	
 	<insert id="insertFormInstance" parameterType="hashmap">
 		<selectKey keyProperty="FormInstID" resultType="Integer" order="AFTER">	
		INSERT INTO covi_approval4j.dbo.jwf_forminstance (
			ProcessID,
			FormID,
			SchemaID,
			Subject,
			InitiatorID,
			InitiatorName,
			InitiatorUnitID,
			InitiatorUnitName,
			InitiatedDate,
			CompletedDate,
			DeletedDate,
			LastModifiedDate,
			LastModifierID,
			EntCode,
			EntName,
			DocNo,
			DocLevel,
			DocClassID,
			DocClassName,
			DocSummary,
			IsPublic,
			SaveTerm,
			AttachFileInfo,
			AppliedDate,
			AppliedTerm,
			ReceiveNo,
			ReceiveNames,
			ReceiptList,
			BodyType,
			BodyContext,
			BodyContextOrg,
			DocLinks
		)
		VALUES (
			#{processID},		
			#{formID},
			#{schemaID},
			#{subject},
			#{initiatorID},
			#{initiatorName},
			#{initiatorUnitID},
			#{initiatorUnitName},
			GETDATE(),
			null,
			null,
			null,
			null,
			#{entCode},
			#{entName},
			#{docNo},
			#{docLevel},
			#{docClassID},
			#{docClassName},
			#{docSummary},
			#{isPublic},
			#{saveTerm},
			#{attachFileInfo},
			#{appliedDate},
			#{appliedTerm},
			#{receiveNo},
			#{receiveNames},
			#{receiptList},
			#{bodyType},
			'${bodyContext}',
			'${bodyContextOrg}',
			#{docLinks}
		)
		
		    SELECT SCOPE_IDENTITY();
		</selectKey>
	</insert>
 	
 	<insert id="insertFormsTempInstBox" parameterType="hashmap">
 		<selectKey keyProperty="FormTempInstBoxID" resultType="Integer" order="AFTER">	
		INSERT INTO covi_approval4j.dbo.jwf_formstempinstbox (
			FormInstID,
			FormID,
			SchemaID,
			FormPrefix,
			FormInstTableName,
			UserCode,
			CreatedDate,
			Subject,
			Kind
		)
		VALUES
		(
			#{formInstID},
			#{formID},
			#{schemaID},
			#{formPrefix},
			#{formInstTableName},
			#{userCode},
			GETDATE(),
			#{subject},
			#{kind}
		)
		
		    SELECT SCOPE_IDENTITY();
		</selectKey>
	</insert>
	
 	<update id="deleteProcess" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_process 
 	    SET DeleteDate = GETDATE()
 	    WHERE ProcessID = #{processID};
 	</update>
 	
 	<update id="deleteWorkItem" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET Deleted = GETDATE()
 	    WHERE ProcessID = #{processID};
 	</update>
 	
 	<update id="deleteOneWorkItem" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_workitem 
 	    SET Deleted = GETDATE()
 	    WHERE WorkItemID = #{workitemID};
 	</update>
 	
 	<delete id="deleteOneWorkItemDescription" parameterType="hashmap">
 	    DELETE FROM covi_approval4j.dbo.jwf_workitemdescription 
 	    WHERE WorkItemDescriptionID = #{workitemDescriptionID};
 	</delete>
 	
 	<delete id="deleteOnePerformer" parameterType="hashmap">
 	    DELETE FROM covi_approval4j.dbo.jwf_performer 
 	    WHERE PerformerID = #{performerID};
 	</delete>
 		
 	<select id="selectSerialNumber" parameterType="hashmap" resultType="Integer">
 	    <![CDATA[
		SELECT ISNULL(MAX(SerialNumber),0) + 1 as RESULT 
		FROM covi_approval4j.dbo.jwf_documentnumber WITH(UPDLOCK)
		WHERE DeptCode = #{deptCode}
		AND FiscalYear = #{fiscalYear};
		]]>
    </select>
    
 	<insert id="insertDocumentNumber" parameterType="hashmap">	
 		<selectKey keyProperty="SerialNumber" resultType="Integer" order="BEFORE">
			<![CDATA[
			SELECT ISNULL(MAX(SerialNumber),0) + 1 as SerialNumber
			FROM covi_approval4j.dbo.jwf_documentnumber WITH (UPDLOCK) -- 추가
			WHERE DeptCode=#{deptCode}
			AND DocListType=#{docListType}
			AND FiscalYear=#{fiscalYear};
			]]>
 		</selectKey>
 		
			INSERT INTO covi_approval4j.dbo.jwf_documentnumber (
				FiscalYear,
				SerialNumber,
				DocListType,
				DeptCode,
				DeptName,
				CategoryNumber,
				DisplayedNumber
			)
			VALUES
			(
				#{fiscalYear},
				#{SerialNumber},
				#{docListType},
				#{deptCode},
				#{deptName},
				#{categoryNumber},
				#{displayedNumber}
			);
	</insert>
	
	<update id="updateDocumentNumber" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_documentnumber 
 	    SET DisplayedNumber = #{displayedNumber}
 	    WHERE DeptCode = #{deptCode}
		AND DocListType = #{docListType}
		AND FiscalYear = #{fiscalYear}
		AND SerialNumber = #{SerialNumber};
 	</update>
 	
 	<update id="updateFormInstanceForReceiveNo" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_processdescription 
 	    SET Reserved2 = #{receiveNo}
 	    WHERE FormInstID = #{formInstID};
 	</update>
 	
 	<update id="updateFormInstanceForDocNo" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_processdescription 
 	    SET Reserved1 = #{docNo}
 	    WHERE FormInstID = #{formInstID};
 	</update>
 	
 	<update id="updateFormInstanceArchiveForDocNo" parameterType="hashmap">
 	    UPDATE covi_approval4j.dbo.jwf_processdescription
 	    SET Reserved1 = #{docNo}, DocNo = #{docNo}
 	    WHERE FormInstID = #{formInstID};
 	</update>
 	
 	<select id="selectFormInstance" parameterType="hashmap" resultType="hashmap">
 	    <![CDATA[ 
		SELECT BodyContext, DocNo
		FROM covi_approval4j.dbo.jwf_forminstance with(nolock)
		WHERE FormInstID = #{formInstID};
		]]>
    </select>
 	
 	<select id="selectManager" parameterType="hashmap" resultType="String">
 	    <![CDATA[
		SELECT ManagerCode
		FROM covi_smart4j.dbo.sys_object_group with(nolock)
		WHERE GroupCode = #{grCode} AND IsUse = 'Y' AND (GroupType IN ('Dept', 'Manage','Division','Company'))
		]]>
    </select>
    
 	<select id="selectUserInfo" parameterType="hashmap" resultType="hashmap">
 	    <![CDATA[ 
		SELECT ur.UserCode AS Code,
 			ur.DisplayName AS Name,
 			bs.JobTitleCode+';'+bs.JobTitleName AS JobTitle,
 			bs.JobLevelCode+';'+bs.JobLevelName AS JobLevel,
 			bs.JobPositionCode+';'+bs.JobPositionName AS JobPosition,
 			MailAddress
		FROM covi_smart4j.dbo.sys_object_user_basegroup AS bs with(nolock)
		INNER JOIN covi_smart4j.dbo.sys_object_user AS ur with(nolock) ON bs.UserCode = ur.UserCode
		WHERE ur.UserCode = #{urCode}
		AND bs.JobType = 'Origin'
		]]>
    </select>
    
 	<select id="selectPerformer" parameterType="hashmap" resultType="hashmap">
 	    <![CDATA[ 
 		SELECT W.WorkItemID AS WorkItemID, 
 			W.UserCode AS UserCode,
			W.TaskID AS TaskID,
			W.ProcessID AS ProcessID,
			W.PerformerID AS PerformerID,
			P.SubKind AS SubKind 
		FROM covi_approval4j.dbo.jwf_workitem AS W with(nolock)
		INNER JOIN covi_approval4j.dbo.jwf_performer AS P with(nolock) ON W.WorkItemID = P.WorkitemID
		WHERE P.SubKind = #{subkind} AND W.ProcessID = #{processID}
		]]>
    </select>
    
 	<select id="selectPerformerByWorkItemID" parameterType="hashmap" resultType="hashmap">
 	    <![CDATA[ 
 		SELECT W.WorkItemID AS WorkItemID, 
 			W.UserCode AS UserCode,
			W.TaskID AS TaskID,
			W.ProcessID AS ProcessID,
			W.PerformerID AS PerformerID,
			P.SubKind AS SubKind 
		FROM covi_approval4j.dbo.jwf_workitem AS W with(nolock)
		INNER JOIN covi_approval4j.dbo.jwf_performer AS P with(nolock) ON W.WorkItemID = P.WorkitemID
		WHERE W.WorkItemID = #{workItemID}
		]]>
    </select>
    
 	<select id="selectSubDept" parameterType="hashmap" resultType="hashmap">
 		SELECT GroupCode AS code, DisplayName AS name
 		FROM covi_smart4j.dbo.sys_object_group with(nolock)
		WHERE GroupPath LIKE '%' + #{deptCode} + '%'
		AND GroupType = 'Dept'
		AND IsUse = 'Y'
		AND IsDisplay = 'Y'
		AND GroupCode != #{deptCode}
 	</select>
 	
 	<select id="selectSharePerson" parameterType="hashmap" resultType="hashmap">
		SELECT P.UserCode as 'USERCODE', P.DisplayName as 'DISPLAYNAME'
		FROM covi_approval4j.dbo.jwf_groupmember M with(nolock)
		INNER JOIN covi_approval4j.dbo.jwf_group G with(nolock)
			ON M.GroupID = G.GroupID
		INNER JOIN COVI_SMART4j.dbo.sys_object_user P with(nolock) 
			ON M.UserCode=P.UserCode
		WHERE G.GROUPCode=#{groupCode}
		AND G.EntCode = #{entCode}
		AND P.IsUse='Y'
 	</select>
 	
 	<select id="selectShareOU" parameterType="hashmap" resultType="hashmap">
		SELECT P.GroupCode as 'GROUPCODE', P.DisplayName as 'DISPLAYNAME'
		FROM covi_approval4j.dbo.jwf_groupmember M with(nolock)
		INNER JOIN covi_approval4j.dbo.jwf_group G with(nolock)
			ON M.GroupID = G.GroupID
		INNER JOIN COVI_SMART4j.dbo.sys_object_group P with(nolock)
			ON M.UserCode=P.GroupCode
		WHERE G.GROUPCode=#{groupCode}
		AND G.EntCode = #{entCode}
		AND P.IsUse='Y'
		AND Receivable='1'
 	</select>
 	
 	<select id="selectSignImage" parameterType="hashmap" resultType="hashmap">
	    SELECT FilePath FROM covi_approval4j.dbo.jwf_signimage with(nolock)
	    WHERE UserCode = #{UserCode} AND IsUse = 'Y'
	    ORDER BY InsertDate DESC
	</select>
	
	<select id="selectGroupName" parameterType="hashmap" resultType="hashmap">
	    SELECT A.DisplayName AS GR_DisplayName,
				A.ShortName AS GR_ShortName,
				B.DisplayName AS EntName
		FROM covi_smart4j.dbo.sys_object_group a with(nolock)
		INNER JOIN covi_smart4j.dbo.sys_object_domain b with(nolock)
			ON a.CompanyCode = b.DomainCode
		WHERE a.GROUPCode = #{groupCode}
	</select>
	
	<insert id="insertEdmsTransferData" parameterType="hashmap">
		INSERT INTO covi_approval4j.dbo.jwf_edmsmeta 
		(
			ProcessId,
			DraftId,
			RegDate,
			EndFlag
		) 
		VALUES
		(
			#{ProcessId}, 
			#{DraftId}, 
			getDate(), 
			#{EndFlag}
		)
	</insert>
	
	<insert id="insertGovApprovalDataE" parameterType="hashmap">
    	INSERT INTO COVI_APPROVAL4J.dbo.JWF_PROCESSGOV
	           (DOCID
	           ,ProcessID
	           ,FormInstID
	           ,ProcessSubject
	           ,InitiatorID
	           ,InitiatorName
	           ,InitiatorUnitID
	           ,InitiatorUnitName
	           ,DocNumber
	           ,INSERTED
	           ,BodyContext
	           ,ApprovalContext
	           ,AttachInfo
	           ,LinkURL
	           ,SignImage
	           ,SendStatus
	           ,SendAPIMsg
	           ,DisplaySendName
	           ,ReceiverName
	           ,RECEIVER
	           ,SendDate
	           ,SenderID
	           ,SenderName
	           ,SenderEnt
	           ,StampID)
	     SELECT 
				null
				, #{processID}
				, #{formInstID}
				, FI.SUBJECT
				, FI.InitiatorID
				, FI.InitiatorName
				, FI.InitiatorUnitID
				, FI.InitiatorUnitName
				, #{docNumber}
				, now(3) AS INSERTED
				, #{bodyContext}
				, #{domainDataContext}
				, FI.AttachFileInfo
				, #{approvalURL}
				, NULL
				, 'SENDWAIT'
				, ''
				, ''
				, FM.RECEIVER_NAME
				, FM.RECEIVER
				, NULL
				, ''
				, ''
				, FI.EntCode
				, '106'
		  FROM COVI_APPROVAL4J.dbo.JWF_FORMINSTANCE FI with(nolock)
		  	INNER JOIN COVI_APPROVAL4J.dbo.WF_FORM_GOVDOCS_001 FM with(nolock)
		  		ON FI.FORMINSTID = FM.FORMINSTID
		  WHERE FI.FormInstID = #{formInstID}
	</insert>
	
	<!-- FIXME -->
	<update id="updateGovApprovalDataE" parameterType="hashmap">
 	    UPDATE JWF_PROCESSGOV
 	    SET BodyContext = #{bodyContext:CLOB}
 	    	,ApprovalContext = #{domainDataContext:CLOB}
 	    WHERE UniqueID = #{uniqueID}
 	</update>
 	
 	<!-- FIXME -->
 	<insert id="insertFormInstanceMulti" parameterType="hashmap">	
		INSERT INTO jwf_forminstance (
			ProcessID,
			FormID,
			SchemaID,
			Subject,
			InitiatorID,
			InitiatorName,
			InitiatorUnitID,
			InitiatorUnitName,
			InitiatedDate,
			CompletedDate,
			DeletedDate,
			LastModifiedDate,
			LastModifierID,
			EntCode,
			EntName,
			DocNo,
			DocLevel,
			DocClassID,
			DocClassName,
			DocSummary,
			IsPublic,
			SaveTerm,
			AttachFileInfo,
			AppliedDate,
			AppliedTerm,
			ReceiveNo,
			ReceiveNames,
			ReceiptList,
			BodyType,
			BodyContext,
			BodyContextOrg,
			DocLinks 
		) SELECT 
			FI.ProcessID,		
			FI.FormID,
			FI.SchemaID,
			SUB.MULTI_TITLE,
			FI.InitiatorID,
			FI.InitiatorName,
			FI.InitiatorUnitID,
			FI.InitiatorUnitName,
			FI.InitiatedDate,
			FI.CompletedDate,
			FI.DeletedDate,
			FI.LastModifiedDate,
			FI.LastModifierID,
			FI.EntCode,
			FI.EntName,
			FI.DocNo,
			FI.DocLevel,
			FI.DocClassID,
			FI.DocClassName,
			FI.DocSummary,
			FI.isPublic,
			SUB.MULTI_KEEP_PERIOD,
			SUB.MULTI_ATTACH_FILE,
			FI.AppliedDate,
			FI.AppliedTerm,
			null,
			SUB.MULTI_RECEIVENAMES,
			SUB.MULTI_RECEIPTLIST,
			FI.BodyType,
			FI.bodyContext,
			FI.bodyContextOrg,
			SUB.MULTI_LINK_DOC
		FROM JWF_FORMINSTANCE FI
		INNER JOIN HWP_MULTI_GOV_SUB SUB
		ON FI.FORMINSTID = SUB.FORMINSTID
		WHERE FI.FormInstID = #{formInstID}
		AND SUB.ROWSEQ = #{rowseq}
		<selectKey keyProperty="subFormInstID" resultType="Integer" order="AFTER">
		    SELECT JWF_FORMINSTANCE_SEQ.CURRVAL FROM dual
		</selectKey>
	</insert>
	
	<!-- FIXME -->
	<update id="updateSubTableForMultiGov" parameterType="hashmap">
		UPDATE HWP_MULTI_GOV_SUB
		SET MULTI_FORM_INST_ID = #{subFormInstID}
		WHERE FormInstID = #{formInstID}
		AND ROWSEQ = #{rowseq}
	</update>
	
	<update id="updateFormInstanceCompletedDate" parameterType="hashmap">
		UPDATE COVI_APPROVAL4J.dbo.JWF_FormInstance
		SET CompletedDate = B.EndDate
		FROM COVI_APPROVAL4J.dbo.JWF_FormInstance AS A with(nolock)
		INNER JOIN COVI_APPROVAL4J.dbo.JWF_Process AS B with(nolock) ON A.ProcessID = B.ProcessID
		WHERE (B.ProcessID = #{processID}
			<if test="parentYN != null and parentYN != '' and (parentYN eq 'Y'.toString())">
	 	    	or B.ParentProcessID = #{processID}
	 	    </if>
		)
		AND B.EndDate IS NOT NULL
		AND B.BusinessState LIKE '02_01%'
	</update>
</mapper>
